<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › char › pcmcia › synclink_cs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>synclink_cs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/char/pcmcia/synclink_cs.c</span>
<span class="cm"> *</span>
<span class="cm"> * $Id: synclink_cs.c,v 4.34 2005/09/08 13:20:54 paulkf Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * Device driver for Microgate SyncLink PC Card</span>
<span class="cm"> * multiprotocol serial adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * written by Paul Fulghum for Microgate Corporation</span>
<span class="cm"> * paulkf@microgate.com</span>
<span class="cm"> *</span>
<span class="cm"> * Microgate and SyncLink are trademarks of Microgate Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This code is released under the GNU General Public License (GPL)</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED ``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED</span>
<span class="cm"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES</span>
<span class="cm"> * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="cm"> * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,</span>
<span class="cm"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<span class="cm"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<span class="cm"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<span class="cm"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,</span>
<span class="cm"> * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="cm"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED</span>
<span class="cm"> * OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cp">#define VERSION(ver,rel,seq) (((ver)&lt;&lt;16) | ((rel)&lt;&lt;8) | (seq))</span>
<span class="cp">#if defined(__i386__)</span>
<span class="cp">#  define BREAKPOINT() asm(&quot;   int $3&quot;);</span>
<span class="cp">#else</span>
<span class="cp">#  define BREAKPOINT() { }</span>
<span class="cp">#endif</span>

<span class="cp">#define MAX_DEVICE_COUNT 4</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/synclink.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;asm/types.h&gt;</span>
<span class="cp">#include &lt;linux/termios.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/hdlc.h&gt;</span>

<span class="cp">#include &lt;pcmcia/cistpl.h&gt;</span>
<span class="cp">#include &lt;pcmcia/cisreg.h&gt;</span>
<span class="cp">#include &lt;pcmcia/ds.h&gt;</span>

<span class="cp">#if defined(CONFIG_HDLC) || (defined(CONFIG_HDLC_MODULE) &amp;&amp; defined(CONFIG_SYNCLINK_CS_MODULE))</span>
<span class="cp">#define SYNCLINK_GENERIC_HDLC 1</span>
<span class="cp">#else</span>
<span class="cp">#define SYNCLINK_GENERIC_HDLC 0</span>
<span class="cp">#endif</span>

<span class="cp">#define GET_USER(error,value,addr) error = get_user(value,addr)</span>
<span class="cp">#define COPY_FROM_USER(error,dest,src,size) error = copy_from_user(dest,src,size) ? -EFAULT : 0</span>
<span class="cp">#define PUT_USER(error,value,addr) error = put_user(value,addr)</span>
<span class="cp">#define COPY_TO_USER(error,dest,src,size) error = copy_to_user(dest,src,size) ? -EFAULT : 0</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="k">static</span> <span class="n">MGSL_PARAMS</span> <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MGSL_MODE_HDLC</span><span class="p">,</span>			<span class="cm">/* unsigned long mode */</span>
	<span class="mi">0</span><span class="p">,</span>				<span class="cm">/* unsigned char loopback; */</span>
	<span class="n">HDLC_FLAG_UNDERRUN_ABORT15</span><span class="p">,</span>	<span class="cm">/* unsigned short flags; */</span>
	<span class="n">HDLC_ENCODING_NRZI_SPACE</span><span class="p">,</span>	<span class="cm">/* unsigned char encoding; */</span>
	<span class="mi">0</span><span class="p">,</span>				<span class="cm">/* unsigned long clock_speed; */</span>
	<span class="mh">0xff</span><span class="p">,</span>				<span class="cm">/* unsigned char addr_filter; */</span>
	<span class="n">HDLC_CRC_16_CCITT</span><span class="p">,</span>		<span class="cm">/* unsigned short crc_type; */</span>
	<span class="n">HDLC_PREAMBLE_LENGTH_8BITS</span><span class="p">,</span>	<span class="cm">/* unsigned char preamble_length; */</span>
	<span class="n">HDLC_PREAMBLE_PATTERN_NONE</span><span class="p">,</span>	<span class="cm">/* unsigned char preamble; */</span>
	<span class="mi">9600</span><span class="p">,</span>				<span class="cm">/* unsigned long data_rate; */</span>
	<span class="mi">8</span><span class="p">,</span>				<span class="cm">/* unsigned char data_bits; */</span>
	<span class="mi">1</span><span class="p">,</span>				<span class="cm">/* unsigned char stop_bits; */</span>
	<span class="n">ASYNC_PARITY_NONE</span>		<span class="cm">/* unsigned char parity; */</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span> <span class="n">RXBUF</span><span class="p">;</span>

<span class="cm">/* The queue of BH actions to be performed */</span>

<span class="cp">#define BH_RECEIVE  1</span>
<span class="cp">#define BH_TRANSMIT 2</span>
<span class="cp">#define BH_STATUS   4</span>

<span class="cp">#define IO_PIN_SHUTDOWN_LIMIT 100</span>

<span class="cp">#define RELEVANT_IFLAG(iflag) (iflag &amp; (IGNBRK|BRKINT|IGNPAR|PARMRK|INPCK))</span>

<span class="k">struct</span> <span class="n">_input_signal_events</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">ri_up</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">ri_down</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">dsr_up</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">dsr_down</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">dcd_up</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">dcd_down</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">cts_up</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">cts_down</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Device instance data structure</span>
<span class="cm"> */</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_mgslpc_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_port</span>		<span class="n">port</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">if_ptr</span><span class="p">;</span>	<span class="cm">/* General purpose pointer (used by SPPP) */</span>
	<span class="kt">int</span>			<span class="n">magic</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">line</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mgsl_icount</span>	<span class="n">icount</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">x_char</span><span class="p">;</span>		<span class="cm">/* xon/xoff character */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">read_status_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">ignore_status_mask</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tx_buf</span><span class="p">;</span>
	<span class="kt">int</span>            <span class="n">tx_put</span><span class="p">;</span>
	<span class="kt">int</span>            <span class="n">tx_get</span><span class="p">;</span>
	<span class="kt">int</span>            <span class="n">tx_count</span><span class="p">;</span>

	<span class="cm">/* circular list of fixed length rx buffers */</span>

	<span class="kt">unsigned</span> <span class="kt">char</span>  <span class="o">*</span><span class="n">rx_buf</span><span class="p">;</span>        <span class="cm">/* memory allocated for all rx buffers */</span>
	<span class="kt">int</span>            <span class="n">rx_buf_total_size</span><span class="p">;</span> <span class="cm">/* size of memory allocated for rx buffers */</span>
	<span class="kt">int</span>            <span class="n">rx_put</span><span class="p">;</span>         <span class="cm">/* index of next empty rx buffer */</span>
	<span class="kt">int</span>            <span class="n">rx_get</span><span class="p">;</span>         <span class="cm">/* index of next full rx buffer */</span>
	<span class="kt">int</span>            <span class="n">rx_buf_size</span><span class="p">;</span>    <span class="cm">/* size in bytes of single rx buffer */</span>
	<span class="kt">int</span>            <span class="n">rx_buf_count</span><span class="p">;</span>   <span class="cm">/* total number of rx buffers */</span>
	<span class="kt">int</span>            <span class="n">rx_frame_count</span><span class="p">;</span> <span class="cm">/* number of full rx buffers */</span>

	<span class="n">wait_queue_head_t</span>	<span class="n">status_event_wait_q</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">event_wait_q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">tx_timer</span><span class="p">;</span>	<span class="cm">/* HDLC transmit timeout timer */</span>
	<span class="k">struct</span> <span class="n">_mgslpc_info</span>	<span class="o">*</span><span class="n">next_device</span><span class="p">;</span>	<span class="cm">/* device list link */</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">imra_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">imrb_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">pim_value</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">task</span><span class="p">;</span>		<span class="cm">/* task structure for scheduling bh */</span>

	<span class="n">u32</span> <span class="n">max_frame_size</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">pending_bh</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">bh_running</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bh_requested</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">dcd_chkcount</span><span class="p">;</span> <span class="cm">/* check counts to prevent */</span>
	<span class="kt">int</span> <span class="n">cts_chkcount</span><span class="p">;</span> <span class="cm">/* too many IRQs if a signal */</span>
	<span class="kt">int</span> <span class="n">dsr_chkcount</span><span class="p">;</span> <span class="cm">/* is floating */</span>
	<span class="kt">int</span> <span class="n">ri_chkcount</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">rx_enabled</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rx_overflow</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">tx_enabled</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">tx_active</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">tx_aborting</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idle_mode</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">if_mode</span><span class="p">;</span> <span class="cm">/* serial interface selection (RS-232, v.35 etc) */</span>

	<span class="kt">char</span> <span class="n">device_name</span><span class="p">[</span><span class="mi">25</span><span class="p">];</span>		<span class="cm">/* device instance name */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">io_base</span><span class="p">;</span>	<span class="cm">/* base I/O address of adapter */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq_level</span><span class="p">;</span>

	<span class="n">MGSL_PARAMS</span> <span class="n">params</span><span class="p">;</span>		<span class="cm">/* communications parameters */</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">serial_signals</span><span class="p">;</span>	<span class="cm">/* current serial signal states */</span>

	<span class="n">bool</span> <span class="n">irq_occurred</span><span class="p">;</span>		<span class="cm">/* for diagnostics use */</span>
	<span class="kt">char</span> <span class="n">testing_irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">init_error</span><span class="p">;</span>	<span class="cm">/* startup error (DIAGS)	*/</span>

	<span class="kt">char</span> <span class="n">flag_buf</span><span class="p">[</span><span class="n">MAX_ASYNC_BUFFER_SIZE</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">drop_rts_on_tx_done</span><span class="p">;</span>

	<span class="k">struct</span>	<span class="n">_input_signal_events</span>	<span class="n">input_signal_events</span><span class="p">;</span>

	<span class="cm">/* PCMCIA support */</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span>	<span class="o">*</span><span class="n">p_dev</span><span class="p">;</span>
	<span class="kt">int</span>		      <span class="n">stop</span><span class="p">;</span>

	<span class="cm">/* SPPP/Cisco HDLC device parts */</span>
	<span class="kt">int</span> <span class="n">netcount</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">netlock</span><span class="p">;</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="p">}</span> <span class="n">MGSLPC_INFO</span><span class="p">;</span>

<span class="cp">#define MGSLPC_MAGIC 0x5402</span>

<span class="cm">/*</span>
<span class="cm"> * The size of the serial xmit buffer is 1 page, or 4096 bytes</span>
<span class="cm"> */</span>
<span class="cp">#define TXBUFSIZE 4096</span>


<span class="cp">#define CHA     0x00   </span><span class="cm">/* channel A offset */</span><span class="cp"></span>
<span class="cp">#define CHB     0x40   </span><span class="cm">/* channel B offset */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> *  FIXME: PPC has PVR defined in asm/reg.h.  For now we just undef it.</span>
<span class="cm"> */</span>
<span class="cp">#undef PVR</span>

<span class="cp">#define RXFIFO  0</span>
<span class="cp">#define TXFIFO  0</span>
<span class="cp">#define STAR    0x20</span>
<span class="cp">#define CMDR    0x20</span>
<span class="cp">#define RSTA    0x21</span>
<span class="cp">#define PRE     0x21</span>
<span class="cp">#define MODE    0x22</span>
<span class="cp">#define TIMR    0x23</span>
<span class="cp">#define XAD1    0x24</span>
<span class="cp">#define XAD2    0x25</span>
<span class="cp">#define RAH1    0x26</span>
<span class="cp">#define RAH2    0x27</span>
<span class="cp">#define DAFO    0x27</span>
<span class="cp">#define RAL1    0x28</span>
<span class="cp">#define RFC     0x28</span>
<span class="cp">#define RHCR    0x29</span>
<span class="cp">#define RAL2    0x29</span>
<span class="cp">#define RBCL    0x2a</span>
<span class="cp">#define XBCL    0x2a</span>
<span class="cp">#define RBCH    0x2b</span>
<span class="cp">#define XBCH    0x2b</span>
<span class="cp">#define CCR0    0x2c</span>
<span class="cp">#define CCR1    0x2d</span>
<span class="cp">#define CCR2    0x2e</span>
<span class="cp">#define CCR3    0x2f</span>
<span class="cp">#define VSTR    0x34</span>
<span class="cp">#define BGR     0x34</span>
<span class="cp">#define RLCR    0x35</span>
<span class="cp">#define AML     0x36</span>
<span class="cp">#define AMH     0x37</span>
<span class="cp">#define GIS     0x38</span>
<span class="cp">#define IVA     0x38</span>
<span class="cp">#define IPC     0x39</span>
<span class="cp">#define ISR     0x3a</span>
<span class="cp">#define IMR     0x3a</span>
<span class="cp">#define PVR     0x3c</span>
<span class="cp">#define PIS     0x3d</span>
<span class="cp">#define PIM     0x3d</span>
<span class="cp">#define PCR     0x3e</span>
<span class="cp">#define CCR4    0x3f</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>IMR/ISR</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define IRQ_BREAK_ON    BIT15   </span><span class="c1">// rx break detected</span>
<span class="cp">#define IRQ_DATAOVERRUN BIT14	</span><span class="c1">// receive data overflow</span>
<span class="cp">#define IRQ_ALLSENT     BIT13	</span><span class="c1">// all sent</span>
<span class="cp">#define IRQ_UNDERRUN    BIT12	</span><span class="c1">// transmit data underrun</span>
<span class="cp">#define IRQ_TIMER       BIT11	</span><span class="c1">// timer interrupt</span>
<span class="cp">#define IRQ_CTS         BIT10	</span><span class="c1">// CTS status change</span>
<span class="cp">#define IRQ_TXREPEAT    BIT9	</span><span class="c1">// tx message repeat</span>
<span class="cp">#define IRQ_TXFIFO      BIT8	</span><span class="c1">// transmit pool ready</span>
<span class="cp">#define IRQ_RXEOM       BIT7	</span><span class="c1">// receive message end</span>
<span class="cp">#define IRQ_EXITHUNT    BIT6	</span><span class="c1">// receive frame start</span>
<span class="cp">#define IRQ_RXTIME      BIT6    </span><span class="c1">// rx char timeout</span>
<span class="cp">#define IRQ_DCD         BIT2	</span><span class="c1">// carrier detect status change</span>
<span class="cp">#define IRQ_OVERRUN     BIT1	</span><span class="c1">// receive frame overflow</span>
<span class="cp">#define IRQ_RXFIFO      BIT0	</span><span class="c1">// receive pool full</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>STAR</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define XFW   BIT6		</span><span class="c1">// transmit FIFO write enable</span>
<span class="cp">#define CEC   BIT2		</span><span class="c1">// command executing</span>
<span class="cp">#define CTS   BIT1		</span><span class="c1">// CTS state</span>

<span class="cp">#define PVR_DTR      BIT0</span>
<span class="cp">#define PVR_DSR      BIT1</span>
<span class="cp">#define PVR_RI       BIT2</span>
<span class="cp">#define PVR_AUTOCTS  BIT3</span>
<span class="cp">#define PVR_RS232    0x20   </span><span class="cm">/* 0010b */</span><span class="cp"></span>
<span class="cp">#define PVR_V35      0xe0   </span><span class="cm">/* 1110b */</span><span class="cp"></span>
<span class="cp">#define PVR_RS422    0x40   </span><span class="cm">/* 0100b */</span><span class="cp"></span>

<span class="cm">/* Register access functions */</span>

<span class="cp">#define write_reg(info, reg, val) outb((val),(info)-&gt;io_base + (reg))</span>
<span class="cp">#define read_reg(info, reg) inb((info)-&gt;io_base + (reg))</span>

<span class="cp">#define read_reg16(info, reg) inw((info)-&gt;io_base + (reg))</span>
<span class="cp">#define write_reg16(info, reg, val) outw((val), (info)-&gt;io_base + (reg))</span>

<span class="cp">#define set_reg_bits(info, reg, mask) \</span>
<span class="cp">    write_reg(info, (reg), \</span>
<span class="cp">		 (unsigned char) (read_reg(info, (reg)) | (mask)))</span>
<span class="cp">#define clear_reg_bits(info, reg, mask) \</span>
<span class="cp">    write_reg(info, (reg), \</span>
<span class="cp">		 (unsigned char) (read_reg(info, (reg)) &amp; ~(mask)))</span>
<span class="cm">/*</span>
<span class="cm"> * interrupt enable/disable routines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">irq_disable</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">CHA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">imra_value</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">write_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">IMR</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">imra_value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">imrb_value</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">write_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span> <span class="o">+</span> <span class="n">IMR</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">imrb_value</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">irq_enable</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">CHA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">imra_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">write_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">IMR</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">imra_value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">imrb_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">write_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span> <span class="o">+</span> <span class="n">IMR</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">imrb_value</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define port_irq_disable(info, mask) \</span>
<span class="cp">  { info-&gt;pim_value |= (mask); write_reg(info, PIM, info-&gt;pim_value); }</span>

<span class="cp">#define port_irq_enable(info, mask) \</span>
<span class="cp">  { info-&gt;pim_value &amp;= ~(mask); write_reg(info, PIM, info-&gt;pim_value); }</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rx_start</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rx_stop</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_start</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_stop</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_set_idle</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">get_signals</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_signals</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_device</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">hdlc_mode</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">async_mode</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">tx_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">context</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">carrier_raised</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dtr_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">);</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
<span class="cp">#define dev_to_port(D) (dev_to_hdlc(D)-&gt;priv)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hdlcdev_tx_done</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hdlcdev_rx</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">hdlcdev_init</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hdlcdev_exit</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">trace_block</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xmit</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">register_test</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">irq_test</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">adapter_test</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">claim_resources</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">release_resources</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mgslpc_add_device</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mgslpc_remove_device</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">rx_get_frame</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rx_reset_buffers</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">rx_alloc_buffers</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rx_free_buffers</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">mgslpc_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Bottom half interrupt handlers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bh_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bh_transmit</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bh_status</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * ioctl handlers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">get_stats</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mgsl_icount</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_icount</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">get_params</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">MGSL_PARAMS</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_params</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_params</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">MGSL_PARAMS</span> <span class="n">__user</span> <span class="o">*</span><span class="n">new_params</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">get_txidle</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">idle_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_txidle</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idle_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_txenable</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tx_abort</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_rxenable</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">wait_events</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">mask</span><span class="p">);</span>

<span class="k">static</span> <span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">mgslpc_device_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mgslpc_device_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Set this param to non-zero to load eax with the</span>
<span class="cm"> * .text section address and breakpoint on module load.</span>
<span class="cm"> * This is useful for use with gdb and add-symbol-file command.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">break_on_load</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Driver major number, defaults to zero to get auto</span>
<span class="cm"> * assigned major number. May be forced as module parameter.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ttymajor</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">maxframe</span><span class="p">[</span><span class="n">MAX_DEVICE_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,};</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">break_on_load</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ttymajor</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug_level</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">maxframe</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;SyncLink PC Card driver&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">driver_version</span> <span class="o">=</span> <span class="s">&quot;$Revision: 4.34 $&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">serial_driver</span><span class="p">;</span>

<span class="cm">/* number of characters left in xmit buffer before we ask for more */</span>
<span class="cp">#define WAKEUP_CHARS 256</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">mgslpc_change_params</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mgslpc_wait_until_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">);</span>

<span class="cm">/* PCMCIA prototypes */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mgslpc_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mgslpc_release</span><span class="p">(</span><span class="n">u_long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mgslpc_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * 1st function defined in .text section. Calling this function in</span>
<span class="cm"> * init_module() followed by a breakpoint allows a remote debugger</span>
<span class="cm"> * (gdb) to get the .text address for the add-symbol-file command.</span>
<span class="cm"> * This allows remote debugging of dynamically loadable modules.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="nf">mgslpc_get_text_ptr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mgslpc_get_text_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * line discipline callback wrappers</span>
<span class="cm"> *</span>
<span class="cm"> * The wrappers maintain line discipline references</span>
<span class="cm"> * while calling into the line discipline.</span>
<span class="cm"> *</span>
<span class="cm"> * ldisc_receive_buf  - pass receive data to line discipline</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ldisc_receive_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			      <span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_ldisc</span> <span class="o">*</span><span class="n">ld</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ld</span> <span class="o">=</span> <span class="n">tty_ldisc_ref</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ld</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">receive_buf</span><span class="p">)</span>
			<span class="n">ld</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">receive_buf</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">tty_ldisc_deref</span><span class="p">(</span><span class="n">ld</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_port_operations</span> <span class="n">mgslpc_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">carrier_raised</span> <span class="o">=</span> <span class="n">carrier_raised</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dtr_rts</span> <span class="o">=</span> <span class="n">dtr_rts</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mgslpc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;mgslpc_attach</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="n">info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">MGSLPC_INFO</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Error can&#39;t allocate device instance data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">info</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">MGSLPC_MAGIC</span><span class="p">;</span>
    <span class="n">tty_port_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mgslpc_port_ops</span><span class="p">;</span>
    <span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">,</span> <span class="n">bh_handler</span><span class="p">);</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="mi">30</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
    <span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">);</span>
    <span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">);</span>
    <span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    <span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">,</span><span class="o">&amp;</span><span class="n">default_params</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">MGSL_PARAMS</span><span class="p">));</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_mode</span> <span class="o">=</span> <span class="n">HDLC_TXIDLE_FLAGS</span><span class="p">;</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">imra_value</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">imrb_value</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">pim_value</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

    <span class="n">info</span><span class="o">-&gt;</span><span class="n">p_dev</span> <span class="o">=</span> <span class="n">link</span><span class="p">;</span>
    <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>

    <span class="cm">/* Initialize the struct pcmcia_device structure */</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">mgslpc_config</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

    <span class="n">mgslpc_add_device</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Card has been inserted.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mgslpc_ioprobe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pcmcia_request_io</span><span class="p">(</span><span class="n">p_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mgslpc_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;mgslpc_config(0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>

    <span class="n">link</span><span class="o">-&gt;</span><span class="n">config_flags</span> <span class="o">|=</span> <span class="n">CONF_ENABLE_IRQ</span> <span class="o">|</span> <span class="n">CONF_AUTO_SET_IO</span><span class="p">;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_loop_config</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">mgslpc_ioprobe</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

    <span class="n">link</span><span class="o">-&gt;</span><span class="n">config_index</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">link</span><span class="o">-&gt;</span><span class="n">config_regs</span> <span class="o">=</span> <span class="n">PRESENT_OPTION</span><span class="p">;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_request_irq</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">mgslpc_isr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	    <span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_enable_device</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	    <span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

    <span class="n">info</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
    <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failed:</span>
    <span class="n">mgslpc_release</span><span class="p">((</span><span class="n">u_long</span><span class="p">)</span><span class="n">link</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Card has been removed.</span>
<span class="cm"> * Unregister device and release PCMCIA configuration.</span>
<span class="cm"> * If device is open, postpone until it is closed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgslpc_release</span><span class="p">(</span><span class="n">u_long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;mgslpc_release(0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>

	<span class="n">pcmcia_disable_device</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgslpc_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;mgslpc_detach(0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>

	<span class="p">((</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mgslpc_release</span><span class="p">((</span><span class="n">u_long</span><span class="p">)</span><span class="n">link</span><span class="p">);</span>

	<span class="n">mgslpc_remove_device</span><span class="p">((</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mgslpc_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mgslpc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">mgslpc_paranoia_check</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">routine</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef MGSLPC_PARANOIA_CHECK</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">badmagic</span> <span class="o">=</span>
		<span class="s">&quot;Warning: bad magic number for mgsl struct (%s) in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">badinfo</span> <span class="o">=</span>
		<span class="s">&quot;Warning: null mgslpc_info for (%s) in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">badinfo</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">routine</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">MGSLPC_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">badmagic</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">routine</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define CMD_RXFIFO      BIT7	</span><span class="c1">// release current rx FIFO</span>
<span class="cp">#define CMD_RXRESET     BIT6	</span><span class="c1">// receiver reset</span>
<span class="cp">#define CMD_RXFIFO_READ BIT5</span>
<span class="cp">#define CMD_START_TIMER BIT4</span>
<span class="cp">#define CMD_TXFIFO      BIT3	</span><span class="c1">// release current tx FIFO</span>
<span class="cp">#define CMD_TXEOM       BIT1	</span><span class="c1">// transmit end message</span>
<span class="cp">#define CMD_TXRESET     BIT0	</span><span class="c1">// transmit reset</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">wait_command_complete</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* wait for command completion */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">channel</span><span class="o">+</span><span class="n">STAR</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">BIT2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">issue_command</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wait_command_complete</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">channel</span> <span class="o">+</span> <span class="n">CMDR</span><span class="p">),</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_pause</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgslpc_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;tx_pause&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tx_pause(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span><span class="p">)</span>
	 	<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgslpc_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;tx_release&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tx_release(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span><span class="p">)</span>
	 	<span class="n">tx_start</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Return next bottom half action to perform.</span>
<span class="cm"> * or 0 if nothing to do.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bh_action</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;</span> <span class="n">BH_RECEIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BH_RECEIVE</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">BH_RECEIVE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;</span> <span class="n">BH_TRANSMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BH_TRANSMIT</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">BH_TRANSMIT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;</span> <span class="n">BH_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BH_STATUS</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">BH_STATUS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Mark BH routine as complete */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">bh_running</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">bh_requested</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bh_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">MGSLPC_INFO</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">action</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_BH</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):bh_handler(%s) entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">bh_running</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="k">while</span><span class="p">((</span><span class="n">action</span> <span class="o">=</span> <span class="n">bh_action</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Process work item */</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_BH</span> <span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):bh_handler() work item action=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">action</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">BH_RECEIVE</span>:
			<span class="k">while</span><span class="p">(</span><span class="n">rx_get_frame</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BH_TRANSMIT</span>:
			<span class="n">bh_transmit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BH_STATUS</span>:
			<span class="n">bh_status</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* unknown work item ID */</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unknown work item ID=%08X!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_BH</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):bh_handler(%s) exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bh_transmit</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_BH</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;bh_transmit() entry on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bh_status</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ri_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dsr_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dcd_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">cts_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* eom: non-zero = end of frame */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_ready_hdlc</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">eom</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fifo_count</span><span class="p">,</span> <span class="n">read_count</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">RXBUF</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">RXBUF</span><span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_put</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_size</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):rx_ready_hdlc(eom=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">eom</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_frame_count</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no more free buffers */</span>
		<span class="n">issue_command</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">CMD_RXRESET</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_RECEIVE</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_overflow</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">buf_overrun</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eom</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* end of frame, get FIFO count from RBCL register */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fifo_count</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="o">+</span><span class="n">RBCL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)))</span>
			<span class="n">fifo_count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">fifo_count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fifo_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">read_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">RXFIFO</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">read_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">)</span> <span class="o">=</span> <span class="n">read_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">RXFIFO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">fifo_count</span> <span class="o">-=</span> <span class="n">read_count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fifo_count</span> <span class="o">&amp;&amp;</span> <span class="n">eom</span><span class="p">)</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">--</span><span class="n">read_count</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">read_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* frame too large, reset receiver and reset current buffer */</span>
				<span class="n">issue_command</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">CMD_RXRESET</span><span class="p">);</span>
				<span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">fifo_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eom</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_RECEIVE</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_frame_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_put</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_put</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_put</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">issue_command</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">CMD_RXFIFO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_ready_async</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">flag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fifo_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 	<span class="k">struct</span> <span class="n">mgsl_icount</span> <span class="o">*</span><span class="n">icount</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcd</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* early termination, get FIFO count from RBCL register */</span>
		<span class="n">fifo_count</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="o">+</span><span class="n">RBCL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>

		<span class="cm">/* Zero fifo count could mean 0 or 32 bytes available.</span>
<span class="cm">		 * If BIT5 of STAR is set then at least 1 byte is available.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fifo_count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="n">CHA</span><span class="o">+</span><span class="n">STAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT5</span><span class="p">))</span>
			<span class="n">fifo_count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">fifo_count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">tty_buffer_request_room</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">fifo_count</span><span class="p">);</span>
	<span class="cm">/* Flush received async data to receive data buffer. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">fifo_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span>   <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">RXFIFO</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">RXFIFO</span><span class="p">);</span>
		<span class="n">fifo_count</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_NORMAL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>if no frameing/crc error then save data
BIT7:parity error
BIT6:framing error</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT7</span> <span class="o">+</span> <span class="n">BIT6</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT7</span><span class="p">)</span>
				<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* discard char if tty control flags say so */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">status</span> <span class="o">&amp;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT7</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT6</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_FRAME</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">work</span> <span class="o">+=</span> <span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">issue_command</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">CMD_RXFIFO</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):rx_ready_async&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):rx=%d brk=%d parity=%d frame=%d overrun=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">,</span><span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span><span class="p">,</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span><span class="p">,</span><span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">,</span><span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">work</span><span class="p">)</span>
		<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_done</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_aborting</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">drop_rts_on_tx_done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SerialSignal_RTS</span><span class="p">;</span>
			<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">drop_rts_on_tx_done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span>
		<span class="n">hdlcdev_tx_done</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_TRANSMIT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_ready</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fifo_count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):tx_ready(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&amp;&amp;</span> <span class="n">fifo_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">fifo_count</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">,</span> <span class="n">TXBUFSIZE</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">TXFIFO</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">write_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">TXFIFO</span><span class="p">,</span>
					  <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span><span class="p">)));</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TXBUFSIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">fifo_count</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_TRANSMIT</span><span class="p">;</span>
		<span class="n">issue_command</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">CMD_TXFIFO</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">)</span>
			<span class="n">issue_command</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">CMD_TXFIFO</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">issue_command</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">CMD_TXFIFO</span> <span class="o">+</span> <span class="n">CMD_TXEOM</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cts_change</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cts_chkcount</span><span class="p">)</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="n">IO_PIN_SHUTDOWN_LIMIT</span><span class="p">)</span>
		<span class="n">irq_disable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span><span class="p">,</span> <span class="n">IRQ_CTS</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">cts</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_CTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">cts_up</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">cts_down</span><span class="o">++</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CTS_FLOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_CTS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CTS tx start...&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
					<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">tx_start</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_TRANSMIT</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_CTS</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CTS tx stop...&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
					<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_STATUS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dcd_change</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dcd_chkcount</span><span class="p">)</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="n">IO_PIN_SHUTDOWN_LIMIT</span><span class="p">)</span>
		<span class="n">irq_disable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span><span class="p">,</span> <span class="n">IRQ_DCD</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dcd</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">dcd_up</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">dcd_down</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CHECK_CD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s CD now %s...&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">open_wait</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;doing serial hangup...&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
				<span class="n">tty_hangup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_STATUS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsr_change</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dsr_chkcount</span><span class="p">)</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="n">IO_PIN_SHUTDOWN_LIMIT</span><span class="p">)</span>
		<span class="n">port_irq_disable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">PVR_DSR</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dsr</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DSR</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">dsr_up</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">dsr_down</span><span class="o">++</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_STATUS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ri_change</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ri_chkcount</span><span class="p">)</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="n">IO_PIN_SHUTDOWN_LIMIT</span><span class="p">)</span>
		<span class="n">port_irq_disable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">PVR_RI</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rng</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RI</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">ri_up</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">.</span><span class="n">ri_down</span><span class="o">++</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">|=</span> <span class="n">BH_STATUS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Interrupt service routine entry point.</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments:</span>
<span class="cm"> *</span>
<span class="cm"> * irq     interrupt number that caused interrupt</span>
<span class="cm"> * dev_id  device ID supplied during interrupt registration</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">mgslpc_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">dummy</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">isr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">gis</span><span class="p">,</span> <span class="n">pis</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;mgslpc_isr(%d) entry.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">_locked</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">gis</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">GIS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;mgslpc_isr %s gis=%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">gis</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">gis</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;synclink_cs:hardware failed or ejected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gis</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT1</span> <span class="o">+</span> <span class="n">BIT0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">isr</span> <span class="o">=</span> <span class="n">read_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span> <span class="o">+</span> <span class="n">ISR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">IRQ_DCD</span><span class="p">)</span>
				<span class="n">dcd_change</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">IRQ_CTS</span><span class="p">)</span>
				<span class="n">cts_change</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gis</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT3</span> <span class="o">+</span> <span class="n">BIT2</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">isr</span> <span class="o">=</span> <span class="n">read_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">ISR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">IRQ_TIMER</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_occurred</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">irq_disable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">IRQ_TIMER</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* receive IRQs */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">IRQ_EXITHUNT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">exithunt</span><span class="o">++</span><span class="p">;</span>
				<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">IRQ_BREAK_ON</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SAK</span><span class="p">)</span>
					<span class="n">do_SAK</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">IRQ_RXTIME</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">issue_command</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">CMD_RXFIFO_READ</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IRQ_RXEOM</span> <span class="o">+</span> <span class="n">IRQ_RXFIFO</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span>
					<span class="n">rx_ready_hdlc</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">isr</span> <span class="o">&amp;</span> <span class="n">IRQ_RXEOM</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">rx_ready_async</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">isr</span> <span class="o">&amp;</span> <span class="n">IRQ_RXEOM</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* transmit IRQs */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">IRQ_UNDERRUN</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_aborting</span><span class="p">)</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txabort</span><span class="o">++</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txunder</span><span class="o">++</span><span class="p">;</span>
				<span class="n">tx_done</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">IRQ_ALLSENT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txok</span><span class="o">++</span><span class="p">;</span>
				<span class="n">tx_done</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">IRQ_TXFIFO</span><span class="p">)</span>
				<span class="n">tx_ready</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gis</span> <span class="o">&amp;</span> <span class="n">BIT7</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pis</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">PIS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pis</span> <span class="o">&amp;</span> <span class="n">BIT1</span><span class="p">)</span>
				<span class="n">dsr_change</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pis</span> <span class="o">&amp;</span> <span class="n">BIT2</span><span class="p">)</span>
				<span class="n">ri_change</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Request bottom half processing if there&#39;s something</span>
<span class="cm">	 * for it to do and the bh is not already running</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bh_running</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bh_requested</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span> <span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s queueing bh task.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">bh_requested</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_isr(%d)exit.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize and start device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">startup</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):startup(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* allocate a page of memory for a transmit buffer */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="s">&quot;%s(%d):%s can&#39;t allocate transmit buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">));</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">,</span> <span class="n">tx_timeout</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* Allocate and claim adapter resources */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">claim_resources</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* perform existence check and diagnostics */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">retval</span> <span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">adapter_test</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">retval</span> <span class="p">)</span> <span class="p">{</span>
  		<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tty</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">release_resources</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
  		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
  	<span class="p">}</span>

	<span class="cm">/* program hardware for current parameters */</span>
	<span class="n">mgslpc_change_params</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called by mgslpc_close() and mgslpc_hangup() to shutdown hardware</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_shutdown(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="cm">/* clear status wait queue because status changes */</span>
	<span class="cm">/* can&#39;t happen after shutting down the hardware */</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">rx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* TODO:disable interrupts instead of reset to preserve signal states */</span>
	<span class="n">reset_device</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

 	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">HUPCL</span><span class="p">)</span> <span class="p">{</span>
 		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SerialSignal_DTR</span> <span class="o">+</span> <span class="n">SerialSignal_RTS</span><span class="p">);</span>
		<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">release_resources</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_INITIALIZED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgslpc_program_hw</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">rx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span>
		<span class="n">hdlc_mode</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">async_mode</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dcd_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">cts_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ri_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dsr_chkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">irq_enable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span><span class="p">,</span> <span class="n">IRQ_DCD</span> <span class="o">|</span> <span class="n">IRQ_CTS</span><span class="p">);</span>
	<span class="n">port_irq_enable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">PVR_DSR</span> <span class="o">|</span> <span class="n">PVR_RI</span><span class="p">);</span>
	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span> <span class="o">||</span> <span class="p">(</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CREAD</span><span class="p">)))</span>
		<span class="n">rx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Reconfigure adapter based on new parameters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgslpc_change_params</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits_per_char</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span> <span class="o">||</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_change_params(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>

	<span class="cm">/* if B0 rate (hangup) specified then negate DTR and RTS */</span>
	<span class="cm">/* otherwise assert DTR and RTS */</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span> <span class="o">+</span> <span class="n">SerialSignal_DTR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SerialSignal_RTS</span> <span class="o">+</span> <span class="n">SerialSignal_DTR</span><span class="p">);</span>

	<span class="cm">/* byte size and parity */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS5</span>: <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS6</span>: <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS7</span>: <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS8</span>: <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>  <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">stop_bits</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">stop_bits</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span> <span class="o">=</span> <span class="n">ASYNC_PARITY_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span> <span class="o">=</span> <span class="n">ASYNC_PARITY_ODD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span> <span class="o">=</span> <span class="n">ASYNC_PARITY_EVEN</span><span class="p">;</span>
<span class="cp">#ifdef CMSPAR</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CMSPAR</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span> <span class="o">=</span> <span class="n">ASYNC_PARITY_SPACE</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* calculate number of jiffies to transmit a full</span>
<span class="cm">	 * FIFO (32 bytes) at specified data rate</span>
<span class="cm">	 */</span>
	<span class="n">bits_per_char</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span> <span class="o">+</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">stop_bits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* if port data rate is set to 460800 or less then</span>
<span class="cm">	 * allow tty settings to override, otherwise keep the</span>
<span class="cm">	 * current data rate.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span> <span class="o">&lt;=</span> <span class="mi">460800</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span> <span class="o">=</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="o">*</span><span class="n">HZ</span><span class="o">*</span><span class="n">bits_per_char</span><span class="p">)</span> <span class="o">/</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">+=</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">50</span><span class="p">;</span>		<span class="cm">/* Add .02 seconds of slop */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CTS_FLOW</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_CTS_FLOW</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_CHECK_CD</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CHECK_CD</span><span class="p">;</span>

	<span class="cm">/* process tty input control flags */</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_INPCK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">BIT7</span> <span class="o">|</span> <span class="n">BIT6</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IGNPAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">BIT7</span> <span class="o">|</span> <span class="n">BIT6</span><span class="p">;</span>

	<span class="n">mgslpc_program_hw</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Add a character to the transmit buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mgslpc_put_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):mgslpc_put_char(%d) on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">ch</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgslpc_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;mgslpc_put_char&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_ASYNC</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&lt;</span> <span class="n">TXBUFSIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span> <span class="o">&amp;=</span> <span class="n">TXBUFSIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Enable transmitter so remaining characters in the</span>
<span class="cm"> * transmit buffer are sent.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgslpc_flush_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):mgslpc_flush_chars() entry on %s tx_count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgslpc_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;mgslpc_flush_chars&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">||</span>
	    <span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):mgslpc_flush_chars() entry on %s starting transmitter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span>
	 	<span class="n">tx_start</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Send a block of data</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments:</span>
<span class="cm"> *</span>
<span class="cm"> * tty        pointer to tty information structure</span>
<span class="cm"> * buf	      pointer to buffer containing send data</span>
<span class="cm"> * count      size of send data in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: number of characters written</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mgslpc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):mgslpc_write(%s) count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgslpc_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;mgslpc_write&quot;</span><span class="p">)</span> <span class="o">||</span>
		<span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">TXBUFSIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span>
			<span class="n">min</span><span class="p">(</span><span class="n">TXBUFSIZE</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			    <span class="n">TXBUFSIZE</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TXBUFSIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">buf</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">start:</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span>
		 	<span class="n">tx_start</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
 	<span class="p">}</span>
<span class="nl">cleanup:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):mgslpc_write(%s) returning=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return the count of free bytes in transmit buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mgslpc_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgslpc_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;mgslpc_write_room&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* HDLC (frame oriented) mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">HDLC_MAX_FRAME_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">TXBUFSIZE</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_write_room(%s)=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return the count of bytes in transmit buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mgslpc_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_chars_in_buffer(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgslpc_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;mgslpc_chars_in_buffer&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">?</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_chars_in_buffer(%s)=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Discard all data in the send buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgslpc_flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_flush_buffer(%s) entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgslpc_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;mgslpc_flush_buffer&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">write_wait</span><span class="p">);</span>
	<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Send a high-priority XON/XOFF character</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgslpc_send_xchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_send_xchar(%s,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">ch</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgslpc_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;mgslpc_send_xchar&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span><span class="p">)</span>
		 	<span class="n">tx_start</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Signal remote device to throttle send data (our receive data)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgslpc_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_throttle(%s) entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgslpc_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;mgslpc_throttle&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">mgslpc_send_xchar</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>

 	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SerialSignal_RTS</span><span class="p">;</span>
	 	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Signal remote device to stop throttling send data (our receive data)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgslpc_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_unthrottle(%s) entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgslpc_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;mgslpc_unthrottle&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mgslpc_send_xchar</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
	<span class="p">}</span>

 	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span><span class="p">;</span>
	 	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* get the current serial statistics</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_stats</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mgsl_icount</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_icount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;get_params(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_icount</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">COPY_TO_USER</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">user_icount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mgsl_icount</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* get the current serial parameters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_params</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="n">MGSL_PARAMS</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;get_params(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
	<span class="n">COPY_TO_USER</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="n">user_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MGSL_PARAMS</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set the serial parameters</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments:</span>
<span class="cm"> *</span>
<span class="cm"> * 	info		pointer to device instance data</span>
<span class="cm"> * 	new_params	user buffer containing new serial params</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:	0 if success, otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_params</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="n">MGSL_PARAMS</span> <span class="n">__user</span> <span class="o">*</span><span class="n">new_params</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">MGSL_PARAMS</span> <span class="n">tmp_params</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):set_params %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>
	<span class="n">COPY_FROM_USER</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tmp_params</span><span class="p">,</span> <span class="n">new_params</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MGSL_PARAMS</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span> <span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):set_params(%s) user buffer copy failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tmp_params</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">MGSL_PARAMS</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

 	<span class="n">mgslpc_change_params</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_txidle</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">idle_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;get_txidle(%s)=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_mode</span><span class="p">);</span>
	<span class="n">COPY_TO_USER</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="n">idle_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_mode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_txidle</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idle_mode</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;set_txidle(%s,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">idle_mode</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_mode</span> <span class="o">=</span> <span class="n">idle_mode</span><span class="p">;</span>
	<span class="n">tx_set_idle</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_interface</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">if_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;get_interface(%s)=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">if_mode</span><span class="p">);</span>
	<span class="n">COPY_TO_USER</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="n">if_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">if_mode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_interface</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">if_mode</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;set_interface(%s,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">if_mode</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">if_mode</span> <span class="o">=</span> <span class="n">if_mode</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">PVR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">if_mode</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">MGSL_INTERFACE_RS232</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">PVR_RS232</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGSL_INTERFACE_V35</span>:   <span class="n">val</span> <span class="o">|=</span> <span class="n">PVR_V35</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGSL_INTERFACE_RS422</span>: <span class="n">val</span> <span class="o">|=</span> <span class="n">PVR_RS422</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">PVR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_txenable</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;set_txenable(%s,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span><span class="p">)</span>
			<span class="n">tx_start</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span><span class="p">)</span>
			<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tx_abort</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tx_abort(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&amp;&amp;</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* clear data count so FIFO is not filled on next IRQ.</span>
<span class="cm">		 * This results in underrun and abort transmission.</span>
<span class="cm">		 */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_aborting</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_rxenable</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;set_rxenable(%s,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_enabled</span><span class="p">)</span>
			<span class="n">rx_start</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_enabled</span><span class="p">)</span>
			<span class="n">rx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* wait for specified event to occur</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments:	 	info	pointer to device instance data</span>
<span class="cm"> * 			mask	pointer to bitmask of events to wait for</span>
<span class="cm"> * Return Value:	0 	if successful and bit mask updated with</span>
<span class="cm"> *				of events triggerred,</span>
<span class="cm"> * 			otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_events</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">mask_ptr</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgsl_icount</span> <span class="n">cprev</span><span class="p">,</span> <span class="n">cnow</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">events</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">_input_signal_events</span> <span class="n">oldsigs</span><span class="p">,</span> <span class="n">newsigs</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

	<span class="n">COPY_FROM_USER</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask_ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;wait_events(%s,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* return immediately if state matches requested events */</span>
	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span><span class="p">;</span>
	<span class="n">events</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span>
		<span class="p">(</span> <span class="p">((</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DSR</span><span class="p">)</span> <span class="o">?</span> <span class="n">MgslEvent_DsrActive</span><span class="o">:</span><span class="n">MgslEvent_DsrInactive</span><span class="p">)</span> <span class="o">+</span>
 		  <span class="p">((</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span> <span class="o">?</span> <span class="n">MgslEvent_DcdActive</span><span class="o">:</span><span class="n">MgslEvent_DcdInactive</span><span class="p">)</span> <span class="o">+</span>
		  <span class="p">((</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SerialSignal_CTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">MgslEvent_CtsActive</span><span class="o">:</span><span class="n">MgslEvent_CtsInactive</span><span class="p">)</span> <span class="o">+</span>
		  <span class="p">((</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RI</span><span class="p">)</span>  <span class="o">?</span> <span class="n">MgslEvent_RiActive</span> <span class="o">:</span><span class="n">MgslEvent_RiInactive</span><span class="p">)</span> <span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* save current irq counts */</span>
	<span class="n">cprev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="n">oldsigs</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">MgslEvent_ExitHuntMode</span><span class="p">))</span>
		<span class="n">irq_enable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">IRQ_EXITHUNT</span><span class="p">);</span>

	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>


	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* get current irq counts */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">cnow</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
		<span class="n">newsigs</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">input_signal_events</span><span class="p">;</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* if no change, wait aborted for some reason */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">dsr_up</span>   <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dsr_up</span>   <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">dsr_down</span> <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dsr_down</span> <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">dcd_up</span>   <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dcd_up</span>   <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">dcd_down</span> <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dcd_down</span> <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">cts_up</span>   <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">cts_up</span>   <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">cts_down</span> <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">cts_down</span> <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">ri_up</span>    <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">ri_up</span>    <span class="o">&amp;&amp;</span>
		    <span class="n">newsigs</span><span class="p">.</span><span class="n">ri_down</span>  <span class="o">==</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">ri_down</span>  <span class="o">&amp;&amp;</span>
		    <span class="n">cnow</span><span class="p">.</span><span class="n">exithunt</span>    <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">exithunt</span>   <span class="o">&amp;&amp;</span>
		    <span class="n">cnow</span><span class="p">.</span><span class="n">rxidle</span>      <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rxidle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">events</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span>
			<span class="p">(</span> <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">dsr_up</span>   <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dsr_up</span>   <span class="o">?</span> <span class="n">MgslEvent_DsrActive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span>   <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">dsr_down</span> <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dsr_down</span> <span class="o">?</span> <span class="n">MgslEvent_DsrInactive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">dcd_up</span>   <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dcd_up</span>   <span class="o">?</span> <span class="n">MgslEvent_DcdActive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span>   <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">dcd_down</span> <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">dcd_down</span> <span class="o">?</span> <span class="n">MgslEvent_DcdInactive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">cts_up</span>   <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">cts_up</span>   <span class="o">?</span> <span class="n">MgslEvent_CtsActive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span>   <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">cts_down</span> <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">cts_down</span> <span class="o">?</span> <span class="n">MgslEvent_CtsInactive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">ri_up</span>    <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">ri_up</span>    <span class="o">?</span> <span class="n">MgslEvent_RiActive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span>    <span class="o">+</span>
			  <span class="p">(</span><span class="n">newsigs</span><span class="p">.</span><span class="n">ri_down</span>  <span class="o">!=</span> <span class="n">oldsigs</span><span class="p">.</span><span class="n">ri_down</span>  <span class="o">?</span> <span class="n">MgslEvent_RiInactive</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span>  <span class="o">+</span>
			  <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">exithunt</span>    <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">exithunt</span>   <span class="o">?</span> <span class="n">MgslEvent_ExitHuntMode</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
			  <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rxidle</span>      <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rxidle</span>     <span class="o">?</span> <span class="n">MgslEvent_IdleReceived</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">cprev</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">;</span>
		<span class="n">oldsigs</span> <span class="o">=</span> <span class="n">newsigs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">MgslEvent_ExitHuntMode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">event_wait_q</span><span class="p">))</span>
			<span class="n">irq_disable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">IRQ_EXITHUNT</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">PUT_USER</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">mask_ptr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">modem_input_wait</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span><span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgsl_icount</span> <span class="n">cprev</span><span class="p">,</span> <span class="n">cnow</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

	<span class="cm">/* save current irq counts */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cprev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* get new irq counts */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">cnow</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* if no change, wait aborted for some reason */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rng</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dsr</span> <span class="o">&amp;&amp;</span>
		    <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dcd</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">==</span> <span class="n">cprev</span><span class="p">.</span><span class="n">cts</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check for change in caller specified modem input */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_RNG</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">rng</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_DSR</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dsr</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CD</span>  <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">dcd</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CTS</span> <span class="o">&amp;&amp;</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">!=</span> <span class="n">cprev</span><span class="p">.</span><span class="n">cts</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cprev</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status_event_wait_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* return the state of the serial control and status signals</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
 	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RTS</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DTR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DTR</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CAR</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RI</span><span class="p">)</span>  <span class="o">?</span> <span class="n">TIOCM_RNG</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DSR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DSR</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_CTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CTS</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s tiocmget() value=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">result</span> <span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set modem control signals (DTR/RTS)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):%s tiocmset(%x,%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span> <span class="n">clear</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SerialSignal_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SerialSignal_DTR</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
 	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set or clear transmit break condition</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments:		tty		pointer to tty instance data</span>
<span class="cm"> *			break_state	-1=set break condition, 0=clear</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mgslpc_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span> <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_break(%s,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">break_state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgslpc_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;mgslpc_break&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">set_reg_bits</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="o">+</span><span class="n">DAFO</span><span class="p">,</span> <span class="n">BIT6</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_reg_bits</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="o">+</span><span class="n">DAFO</span><span class="p">,</span> <span class="n">BIT6</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mgslpc_get_icount</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">serial_icounter_struct</span> <span class="o">*</span><span class="n">icount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span> <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgsl_icount</span> <span class="n">cnow</span><span class="p">;</span>	<span class="cm">/* kernel counter temps */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cnow</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">cts</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dsr</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rng</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rng</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">frame</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">overrun</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">parity</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">brk</span><span class="p">;</span>
	<span class="n">icount</span><span class="o">-&gt;</span><span class="n">buf_overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">buf_overrun</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Service an IOCTL request</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments:</span>
<span class="cm"> *</span>
<span class="cm"> * 	tty	pointer to tty instance data</span>
<span class="cm"> * 	cmd	IOCTL command code</span>
<span class="cm"> * 	arg	command argument/context</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:	0 if success, otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mgslpc_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span> <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_ioctl %s cmd=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">cmd</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgslpc_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;mgslpc_ioctl&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCGSERIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCSSERIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">TIOCMIWAIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_IO_ERROR</span><span class="p">))</span>
		    <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MGSL_IOCGPARAMS</span>:
		<span class="k">return</span> <span class="n">get_params</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCSPARAMS</span>:
		<span class="k">return</span> <span class="n">set_params</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCGTXIDLE</span>:
		<span class="k">return</span> <span class="n">get_txidle</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCSTXIDLE</span>:
		<span class="k">return</span> <span class="n">set_txidle</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCGIF</span>:
		<span class="k">return</span> <span class="n">get_interface</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCSIF</span>:
		<span class="k">return</span> <span class="n">set_interface</span><span class="p">(</span><span class="n">info</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCTXENABLE</span>:
		<span class="k">return</span> <span class="n">set_txenable</span><span class="p">(</span><span class="n">info</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCRXENABLE</span>:
		<span class="k">return</span> <span class="n">set_rxenable</span><span class="p">(</span><span class="n">info</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCTXABORT</span>:
		<span class="k">return</span> <span class="n">tx_abort</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCGSTATS</span>:
		<span class="k">return</span> <span class="n">get_stats</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MGSL_IOCWAITEVENT</span>:
		<span class="k">return</span> <span class="n">wait_events</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TIOCMIWAIT</span>:
		<span class="k">return</span> <span class="n">modem_input_wait</span><span class="p">(</span><span class="n">info</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set new termios settings</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments:</span>
<span class="cm"> *</span>
<span class="cm"> * 	tty		pointer to tty structure</span>
<span class="cm"> * 	termios		pointer to buffer to hold returned old termios</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgslpc_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_set_termios %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="p">);</span>

	<span class="cm">/* just return if nothing has changed */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">==</span> <span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">RELEVANT_IFLAG</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">)</span>
		<span class="o">==</span> <span class="n">RELEVANT_IFLAG</span><span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">)))</span>
	  <span class="k">return</span><span class="p">;</span>

	<span class="n">mgslpc_change_params</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

	<span class="cm">/* Handle transition to B0 status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SerialSignal_RTS</span> <span class="o">+</span> <span class="n">SerialSignal_DTR</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	 	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Handle transition away from B0 status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_DTR</span><span class="p">;</span>
 		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">||</span>
 		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_THROTTLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span><span class="p">;</span>
 		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	 	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Handle turning off CRTSCTS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_release</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgslpc_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span> <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgslpc_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;mgslpc_close&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_close(%s) entry, count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty_port_close_start</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

 	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span>
 		<span class="n">mgslpc_wait_until_sent</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>

	<span class="n">mgslpc_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="n">tty_ldisc_flush</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">shutdown</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	
	<span class="n">tty_port_close_end</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_port_tty_set</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="nl">cleanup:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_close(%s) exit, count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Wait until the transmitter is empty.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgslpc_wait_until_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span> <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">orig_jiffies</span><span class="p">,</span> <span class="n">char_time</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span> <span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_wait_until_sent(%s) entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgslpc_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;mgslpc_wait_until_sent&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">orig_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* Set check interval to 1/5 of estimated time to</span>
<span class="cm">	 * send a character, and make it at least 1. The check</span>
<span class="cm">	 * interval should also be less than the timeout.</span>
<span class="cm">	 * Note: use tight timings here to satisfy the NIST-PCTS.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span> <span class="p">)</span> <span class="p">{</span>
	       	<span class="n">char_time</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="o">/</span><span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">char_time</span><span class="p">)</span>
			<span class="n">char_time</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">char_time</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">char_time</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">char_time</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">char_time</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">orig_jiffies</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">char_time</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">orig_jiffies</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_wait_until_sent(%s) exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called by tty_hangup() when a hangup is signaled.</span>
<span class="cm"> * This is the same as closing all open files for the port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgslpc_hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span> <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_hangup(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgslpc_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;mgslpc_hangup&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mgslpc_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">shutdown</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_port_hangup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carrier_raised</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">MGSLPC_INFO</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
 	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dtr_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">MGSLPC_INFO</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span> <span class="o">+</span> <span class="n">SerialSignal_DTR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SerialSignal_RTS</span> <span class="o">+</span> <span class="n">SerialSignal_DTR</span><span class="p">;</span>
	<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">mgslpc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span>	<span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> 			<span class="n">retval</span><span class="p">,</span> <span class="n">line</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* verify range of specified line number */</span>
	<span class="n">line</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&gt;=</span> <span class="n">mgslpc_device_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_open with invalid line #%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">line</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* find the info structure for the specified line */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">mgslpc_device_list</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">info</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">!=</span> <span class="n">line</span><span class="p">)</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">next_device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgslpc_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;mgslpc_open&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">tty_port_tty_set</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_open(%s), old ref count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

	<span class="cm">/* If port is closing, signal caller to try again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty_hung_up_p</span><span class="p">(</span><span class="n">filp</span><span class="p">)</span> <span class="o">||</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">)</span>
			<span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">close_wait</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_HUP_NOTIFY</span><span class="p">)</span> <span class="o">?</span>
			<span class="o">-</span><span class="n">EAGAIN</span> <span class="o">:</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">low_latency</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_LOW_LATENCY</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 1st open on this device, init hardware */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">startup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_port_block_til_ready</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):block_til_ready(%s) returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):mgslpc_open(%s) success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">cleanup:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * /proc fs routines....</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">line_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>	<span class="n">stat_buf</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s:io:%04X irq:%d&quot;</span><span class="p">,</span>
		      <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">);</span>

	<span class="cm">/* output current serial signal states */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
 	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">stat_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stat_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RTS</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|RTS&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_CTS</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|CTS&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DTR</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|DTR&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DSR</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|DSR&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|CD&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RI</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">,</span> <span class="s">&quot;|RI&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; HDLC txok:%d rxok:%d&quot;</span><span class="p">,</span>
			      <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txok</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxok</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txunder</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; txunder:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txunder</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txabort</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; txabort:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txabort</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxshort</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; rxshort:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxshort</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxlong</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; rxlong:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxlong</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxover</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; rxover:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxover</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxcrc</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; rxcrc:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxcrc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; ASYNC tx:%d rx:%d&quot;</span><span class="p">,</span>
			      <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; fe:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; pe:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; brk:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; oe:%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Append serial signal status to end */</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat_buf</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;txactive=%d bh_req=%d bh_run=%d pending_bh=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bh_requested</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bh_running</span><span class="p">,</span>
		       <span class="n">info</span><span class="o">-&gt;</span><span class="n">pending_bh</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called to print information about devices</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mgslpc_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;synclink driver:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_version</span><span class="p">);</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">mgslpc_device_list</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span> <span class="n">info</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">line_info</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">next_device</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mgslpc_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mgslpc_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">mgslpc_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">mgslpc_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx_alloc_buffers</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* each buffer has header and data */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RXBUF</span><span class="p">)</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">;</span>

	<span class="cm">/* calculate total allocation size for 8 buffers */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_total_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_size</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* limit total allocated memory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_total_size</span> <span class="o">&gt;</span> <span class="mh">0x10000</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_total_size</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>

	<span class="cm">/* calculate number of buffers */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_total_size</span> <span class="o">/</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_size</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_total_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rx_reset_buffers</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_free_buffers</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">claim_resources</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_alloc_buffers</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;Can&#39;t allocate rx buffer %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
		<span class="n">release_resources</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_resources</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;release_resources(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
	<span class="n">rx_free_buffers</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Add the specified device instance data structure to the</span>
<span class="cm"> * global linked list of devices and increment the device count.</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments:		info	pointer to device instance data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgslpc_add_device</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">next_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">=</span> <span class="n">mgslpc_device_count</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="s">&quot;ttySLP%d&quot;</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">&lt;</span> <span class="n">MAX_DEVICE_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">maxframe</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">])</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="n">maxframe</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">mgslpc_device_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mgslpc_device_list</span><span class="p">)</span>
		<span class="n">mgslpc_device_list</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">current_dev</span> <span class="o">=</span> <span class="n">mgslpc_device_list</span><span class="p">;</span>
		<span class="k">while</span><span class="p">(</span> <span class="n">current_dev</span><span class="o">-&gt;</span><span class="n">next_device</span> <span class="p">)</span>
			<span class="n">current_dev</span> <span class="o">=</span> <span class="n">current_dev</span><span class="o">-&gt;</span><span class="n">next_device</span><span class="p">;</span>
		<span class="n">current_dev</span><span class="o">-&gt;</span><span class="n">next_device</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;SyncLink PC Card %s:IO=%04X IRQ=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">);</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
	<span class="n">hdlcdev_init</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgslpc_remove_device</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">remove_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">mgslpc_device_list</span><span class="p">;</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">last</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="n">remove_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
				<span class="n">last</span><span class="o">-&gt;</span><span class="n">next_device</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">next_device</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mgslpc_device_list</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">next_device</span><span class="p">;</span>
<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
			<span class="n">hdlcdev_exit</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">release_resources</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">mgslpc_device_count</span><span class="o">--</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">last</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">next_device</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pcmcia_device_id</span> <span class="n">mgslpc_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PCMCIA_DEVICE_MANF_CARD</span><span class="p">(</span><span class="mh">0x02c5</span><span class="p">,</span> <span class="mh">0x0050</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_NULL</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pcmcia</span><span class="p">,</span> <span class="n">mgslpc_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="n">mgslpc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;synclink_cs&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">mgslpc_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">mgslpc_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">mgslpc_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">mgslpc_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">mgslpc_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">mgslpc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">mgslpc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">mgslpc_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">mgslpc_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_char</span> <span class="o">=</span> <span class="n">mgslpc_put_char</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_chars</span> <span class="o">=</span> <span class="n">mgslpc_flush_chars</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span> <span class="n">mgslpc_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">mgslpc_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_buffer</span> <span class="o">=</span> <span class="n">mgslpc_flush_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">mgslpc_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span> <span class="o">=</span> <span class="n">mgslpc_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span> <span class="n">mgslpc_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_xchar</span> <span class="o">=</span> <span class="n">mgslpc_send_xchar</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span> <span class="o">=</span> <span class="n">mgslpc_break</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_until_sent</span> <span class="o">=</span> <span class="n">mgslpc_wait_until_sent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span> <span class="n">mgslpc_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">tx_pause</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">tx_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hangup</span> <span class="o">=</span> <span class="n">mgslpc_hangup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span> <span class="o">=</span> <span class="n">tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span> <span class="o">=</span> <span class="n">tiocmset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_icount</span> <span class="o">=</span> <span class="n">mgslpc_get_icount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mgslpc_proc_fops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">synclink_cs_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">mgslpc_device_list</span><span class="p">)</span>
		<span class="n">mgslpc_remove_device</span><span class="p">(</span><span class="n">mgslpc_device_list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">tty_unregister_driver</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">)))</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d) failed to unregister tty driver err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">rc</span><span class="p">);</span>
		<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pcmcia_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgslpc_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">synclink_cs_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">break_on_load</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">mgslpc_get_text_ptr</span><span class="p">();</span>
	    <span class="n">BREAKPOINT</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">pcmcia_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgslpc_driver</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

    <span class="n">serial_driver</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="n">MAX_DEVICE_COUNT</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial_driver</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	    <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Initialize the tty_driver structure */</span>

    <span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;synclink_cs&quot;</span><span class="p">;</span>
    <span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ttySLP&quot;</span><span class="p">;</span>
    <span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">ttymajor</span><span class="p">;</span>
    <span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
    <span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_SERIAL</span><span class="p">;</span>
    <span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">SERIAL_TYPE_NORMAL</span><span class="p">;</span>
    <span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
    <span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">=</span>
	    <span class="n">B9600</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">HUPCL</span> <span class="o">|</span> <span class="n">CLOCAL</span><span class="p">;</span>
    <span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_REAL_RAW</span><span class="p">;</span>
    <span class="n">tty_set_operations</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mgslpc_ops</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">tty_register_driver</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):Couldn&#39;t register serial driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
	    <span class="n">put_tty_driver</span><span class="p">(</span><span class="n">serial_driver</span><span class="p">);</span>
	    <span class="n">serial_driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	    <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s %s, tty major#%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">driver_name</span><span class="p">,</span> <span class="n">driver_version</span><span class="p">,</span>
	   <span class="n">serial_driver</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
    <span class="n">synclink_cs_cleanup</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">synclink_cs_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">synclink_cs_cleanup</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">synclink_cs_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">synclink_cs_exit</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mgslpc_set_rate</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* note:standard BRG mode is broken in V3.2 chip</span>
<span class="cm">	 * so enhanced mode is always used</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">N</span> <span class="o">=</span> <span class="mi">3686400</span> <span class="o">/</span> <span class="n">rate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">N</span><span class="p">)</span>
			<span class="n">N</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">N</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">M</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="o">&amp;&amp;</span> <span class="n">M</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">M</span><span class="o">++</span><span class="p">)</span>
			<span class="n">N</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">N</span><span class="o">--</span><span class="p">;</span>

		<span class="cm">/* BGR[5..0] = N</span>
<span class="cm">		 * BGR[9..6] = M</span>
<span class="cm">		 * BGR[7..0] contained in BGR register</span>
<span class="cm">		 * BGR[9..8] contained in CCR2[7..6]</span>
<span class="cm">		 * divisor = (N+1)*2^M</span>
<span class="cm">		 *</span>
<span class="cm">		 * Note: M *must* not be zero (causes asymetric duty cycle)</span>
<span class="cm">		 */</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">channel</span> <span class="o">+</span> <span class="n">BGR</span><span class="p">),</span>
				  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">M</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="n">N</span><span class="p">));</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">channel</span> <span class="o">+</span> <span class="n">CCR2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">M</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">channel</span> <span class="o">+</span> <span class="n">CCR2</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Enabled the AUX clock output at the specified frequency.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_auxclk</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* MODE</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..06  MDS[1..0] 10 = transparent HDLC mode</span>
<span class="cm">	 * 05      ADM Address Mode, 0 = no addr recognition</span>
<span class="cm">	 * 04      TMD Timer Mode, 0 = external</span>
<span class="cm">	 * 03      RAC Receiver Active, 0 = inactive</span>
<span class="cm">	 * 02      RTS 0=RTS active during xmit, 1=RTS always active</span>
<span class="cm">	 * 01      TRS Timer Resolution, 1=512</span>
<span class="cm">	 * 00      TLP Test Loop, 0 = no loop</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1000 0010</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x82</span><span class="p">;</span>

	<span class="cm">/* channel B RTS is used to enable AUXCLK driver on SP505 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT2</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span> <span class="o">+</span> <span class="n">MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* CCR0</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      PU Power Up, 1=active, 0=power down</span>
<span class="cm">	 * 06      MCE Master Clock Enable, 1=enabled</span>
<span class="cm">	 * 05      Reserved, 0</span>
<span class="cm">	 * 04..02  SC[2..0] Encoding</span>
<span class="cm">	 * 01..00  SM[1..0] Serial Mode, 00=HDLC</span>
<span class="cm">	 *</span>
<span class="cm">	 * 11000000</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span> <span class="o">+</span> <span class="n">CCR0</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>

	<span class="cm">/* CCR1</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      SFLG Shared Flag, 0 = disable shared flags</span>
<span class="cm">	 * 06      GALP Go Active On Loop, 0 = not used</span>
<span class="cm">	 * 05      GLP Go On Loop, 0 = not used</span>
<span class="cm">	 * 04      ODS Output Driver Select, 1=TxD is push-pull output</span>
<span class="cm">	 * 03      ITF Interframe Time Fill, 0=mark, 1=flag</span>
<span class="cm">	 * 02..00  CM[2..0] Clock Mode</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0001 0111</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span> <span class="o">+</span> <span class="n">CCR1</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">);</span>

	<span class="cm">/* CCR2 (Channel B)</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..06  BGR[9..8] Baud rate bits 9..8</span>
<span class="cm">	 * 05      BDF Baud rate divisor factor, 0=1, 1=BGR value</span>
<span class="cm">	 * 04      SSEL Clock source select, 1=submode b</span>
<span class="cm">	 * 03      TOE 0=TxCLK is input, 1=TxCLK is output</span>
<span class="cm">	 * 02      RWX Read/Write Exchange 0=disabled</span>
<span class="cm">	 * 01      C32, CRC select, 0=CRC-16, 1=CRC-32</span>
<span class="cm">	 * 00      DIV, data inversion 0=disabled, 1=enabled</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0011 1000</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">)</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span> <span class="o">+</span> <span class="n">CCR2</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span> <span class="o">+</span> <span class="n">CCR2</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>

	<span class="cm">/* CCR4</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      MCK4 Master Clock Divide by 4, 1=enabled</span>
<span class="cm">	 * 06      EBRG Enhanced Baud Rate Generator Mode, 1=enabled</span>
<span class="cm">	 * 05      TST1 Test Pin, 0=normal operation</span>
<span class="cm">	 * 04      ICD Ivert Carrier Detect, 1=enabled (active low)</span>
<span class="cm">	 * 03..02  Reserved, must be 0</span>
<span class="cm">	 * 01..00  RFT[1..0] RxFIFO Threshold 00=32 bytes</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0101 0000</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span> <span class="o">+</span> <span class="n">CCR4</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>

	<span class="cm">/* if auxclk not enabled, set internal BRG so</span>
<span class="cm">	 * CTS transitions can be detected (requires TxC)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">)</span>
		<span class="n">mgslpc_set_rate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mgslpc_set_rate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span><span class="p">,</span> <span class="mi">921600</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">loopback_enable</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* CCR1:02..00  CM[2..0] Clock Mode = 111 (clock mode 7) */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">CCR1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">BIT2</span> <span class="o">+</span> <span class="n">BIT1</span> <span class="o">+</span> <span class="n">BIT0</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">CCR1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* CCR2:04 SSEL Clock source select, 1=submode b */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">CCR2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">BIT4</span> <span class="o">+</span> <span class="n">BIT5</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">CCR2</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* set LinkSpeed if available, otherwise default to 2Mbps */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">)</span>
		<span class="n">mgslpc_set_rate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mgslpc_set_rate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="mi">1843200</span><span class="p">);</span>

	<span class="cm">/* MODE:00 TLP Test Loop, 1=loopback enabled */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">MODE</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT0</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdlc_mode</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">clkmode</span><span class="p">,</span> <span class="n">clksubmode</span><span class="p">;</span>

	<span class="cm">/* disable all interrupts */</span>
	<span class="n">irq_disable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">irq_disable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">port_irq_disable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="cm">/* assume clock mode 0a, rcv=RxC xmt=TxC */</span>
	<span class="n">clkmode</span> <span class="o">=</span> <span class="n">clksubmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_RXC_DPLL</span>
	    <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_TXC_DPLL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* clock mode 7a, rcv = DPLL, xmt = DPLL */</span>
		<span class="n">clkmode</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_RXC_BRG</span>
		 <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* clock mode 7b, rcv = BRG, xmt = BRG */</span>
		<span class="n">clkmode</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">clksubmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_RXC_DPLL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* clock mode 6b, rcv = DPLL, xmt = BRG/16 */</span>
			<span class="n">clkmode</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">clksubmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* clock mode 6a, rcv = DPLL, xmt = TxC */</span>
			<span class="n">clkmode</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* clock mode 0b, rcv = RxC, xmt = BRG */</span>
		<span class="n">clksubmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* MODE</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..06  MDS[1..0] 10 = transparent HDLC mode</span>
<span class="cm">	 * 05      ADM Address Mode, 0 = no addr recognition</span>
<span class="cm">	 * 04      TMD Timer Mode, 0 = external</span>
<span class="cm">	 * 03      RAC Receiver Active, 0 = inactive</span>
<span class="cm">	 * 02      RTS 0=RTS active during xmit, 1=RTS always active</span>
<span class="cm">	 * 01      TRS Timer Resolution, 1=512</span>
<span class="cm">	 * 00      TLP Test Loop, 0 = no loop</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1000 0010</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x82</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">loopback</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT0</span><span class="p">;</span>

	<span class="cm">/* preserve RTS state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RTS</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT2</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* CCR0</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      PU Power Up, 1=active, 0=power down</span>
<span class="cm">	 * 06      MCE Master Clock Enable, 1=enabled</span>
<span class="cm">	 * 05      Reserved, 0</span>
<span class="cm">	 * 04..02  SC[2..0] Encoding</span>
<span class="cm">	 * 01..00  SM[1..0] Serial Mode, 00=HDLC</span>
<span class="cm">	 *</span>
<span class="cm">	 * 11000000</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">encoding</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_NRZI</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_BIPHASE_SPACE</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>		<span class="c1">// FM0</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_BIPHASE_MARK</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT4</span> <span class="o">+</span> <span class="n">BIT2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>		<span class="c1">// FM1</span>
	<span class="k">case</span> <span class="n">HDLC_ENCODING_BIPHASE_LEVEL</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT4</span> <span class="o">+</span> <span class="n">BIT3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>		<span class="c1">// Manchester</span>
	<span class="p">}</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">CCR0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* CCR1</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      SFLG Shared Flag, 0 = disable shared flags</span>
<span class="cm">	 * 06      GALP Go Active On Loop, 0 = not used</span>
<span class="cm">	 * 05      GLP Go On Loop, 0 = not used</span>
<span class="cm">	 * 04      ODS Output Driver Select, 1=TxD is push-pull output</span>
<span class="cm">	 * 03      ITF Interframe Time Fill, 0=mark, 1=flag</span>
<span class="cm">	 * 02..00  CM[2..0] Clock Mode</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0001 0000</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x10</span> <span class="o">+</span> <span class="n">clkmode</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">CCR1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* CCR2</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..06  BGR[9..8] Baud rate bits 9..8</span>
<span class="cm">	 * 05      BDF Baud rate divisor factor, 0=1, 1=BGR value</span>
<span class="cm">	 * 04      SSEL Clock source select, 1=submode b</span>
<span class="cm">	 * 03      TOE 0=TxCLK is input, 0=TxCLK is input</span>
<span class="cm">	 * 02      RWX Read/Write Exchange 0=disabled</span>
<span class="cm">	 * 01      C32, CRC select, 0=CRC-16, 1=CRC-32</span>
<span class="cm">	 * 00      DIV, data inversion 0=disabled, 1=enabled</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0000 0000</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clkmode</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">clkmode</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">clkmode</span> <span class="o">==</span> <span class="mi">6</span>
	    <span class="o">||</span> <span class="n">clkmode</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">||</span> <span class="p">(</span><span class="n">clkmode</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">clksubmode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clksubmode</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">crc_type</span> <span class="o">==</span> <span class="n">HDLC_CRC_32_CCITT</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">encoding</span> <span class="o">==</span> <span class="n">HDLC_ENCODING_NRZB</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT0</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">CCR2</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* CCR3</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..06  PRE[1..0] Preamble count 00=1, 01=2, 10=4, 11=8</span>
<span class="cm">	 * 05      EPT Enable preamble transmission, 1=enabled</span>
<span class="cm">	 * 04      RADD Receive address pushed to FIFO, 0=disabled</span>
<span class="cm">	 * 03      CRL CRC Reset Level, 0=FFFF</span>
<span class="cm">	 * 02      RCRC Rx CRC 0=On 1=Off</span>
<span class="cm">	 * 01      TCRC Tx CRC 0=On 1=Off</span>
<span class="cm">	 * 00      PSD DPLL Phase Shift Disable</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0000 0000</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">crc_type</span> <span class="o">==</span> <span class="n">HDLC_CRC_NONE</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT2</span> <span class="o">+</span> <span class="n">BIT1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">preamble</span> <span class="o">!=</span> <span class="n">HDLC_PREAMBLE_PATTERN_NONE</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT5</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">preamble_length</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">HDLC_PREAMBLE_LENGTH_16BITS</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_PREAMBLE_LENGTH_32BITS</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_PREAMBLE_LENGTH_64BITS</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT7</span> <span class="o">+</span> <span class="n">BIT6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">CCR3</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* PRE - Preamble pattern */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">preamble</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">HDLC_PREAMBLE_PATTERN_FLAGS</span>: <span class="n">val</span> <span class="o">=</span> <span class="mh">0x7e</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_PREAMBLE_PATTERN_10</span>:    <span class="n">val</span> <span class="o">=</span> <span class="mh">0xaa</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_PREAMBLE_PATTERN_01</span>:    <span class="n">val</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDLC_PREAMBLE_PATTERN_ONES</span>:  <span class="n">val</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">PRE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* CCR4</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      MCK4 Master Clock Divide by 4, 1=enabled</span>
<span class="cm">	 * 06      EBRG Enhanced Baud Rate Generator Mode, 1=enabled</span>
<span class="cm">	 * 05      TST1 Test Pin, 0=normal operation</span>
<span class="cm">	 * 04      ICD Ivert Carrier Detect, 1=enabled (active low)</span>
<span class="cm">	 * 03..02  Reserved, must be 0</span>
<span class="cm">	 * 01..00  RFT[1..0] RxFIFO Threshold 00=32 bytes</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0101 0000</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">CCR4</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_RXC_DPLL</span><span class="p">)</span>
		<span class="n">mgslpc_set_rate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mgslpc_set_rate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">);</span>

	<span class="cm">/* RLCR Receive length check register</span>
<span class="cm">	 *</span>
<span class="cm">	 * 7     1=enable receive length check</span>
<span class="cm">	 * 6..0  Max frame length = (RL + 1) * 32</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">RLCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* XBCH Transmit Byte Count High</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      DMA mode, 0 = interrupt driven</span>
<span class="cm">	 * 06      NRM, 0=ABM (ignored)</span>
<span class="cm">	 * 05      CAS Carrier Auto Start</span>
<span class="cm">	 * 04      XC Transmit Continuously (ignored)</span>
<span class="cm">	 * 03..00  XBC[10..8] Transmit byte count bits 10..8</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0000 0000</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_AUTO_DCD</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT5</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">XBCH</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">enable_auxclk</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">loopback</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">testing_irq</span><span class="p">)</span>
		<span class="n">loopback_enable</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_AUTO_CTS</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">irq_enable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span><span class="p">,</span> <span class="n">IRQ_CTS</span><span class="p">);</span>
		<span class="cm">/* PVR[3] 1=AUTO CTS active */</span>
		<span class="n">set_reg_bits</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">PVR</span><span class="p">,</span> <span class="n">BIT3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">clear_reg_bits</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">PVR</span><span class="p">,</span> <span class="n">BIT3</span><span class="p">);</span>

	<span class="n">irq_enable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span>
			 <span class="n">IRQ_RXEOM</span> <span class="o">+</span> <span class="n">IRQ_RXFIFO</span> <span class="o">+</span> <span class="n">IRQ_ALLSENT</span> <span class="o">+</span>
			 <span class="n">IRQ_UNDERRUN</span> <span class="o">+</span> <span class="n">IRQ_TXFIFO</span><span class="p">);</span>
	<span class="n">issue_command</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">CMD_TXRESET</span> <span class="o">+</span> <span class="n">CMD_RXRESET</span><span class="p">);</span>
	<span class="n">wait_command_complete</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">);</span>
	<span class="n">read_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">ISR</span><span class="p">);</span>	<span class="cm">/* clear pending IRQs */</span>

	<span class="cm">/* Master clock mode enabled above to allow reset commands</span>
<span class="cm">	 * to complete even if no data clocks are present.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Disable master clock mode for normal communications because</span>
<span class="cm">	 * V3.2 of the ESCC2 has a bug that prevents the transmit all sent</span>
<span class="cm">	 * IRQ when in master clock mode.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Leave master clock mode enabled for IRQ test because the</span>
<span class="cm">	 * timer IRQ used by the test can only happen in master clock mode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">testing_irq</span><span class="p">)</span>
		<span class="n">clear_reg_bits</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">CCR0</span><span class="p">,</span> <span class="n">BIT6</span><span class="p">);</span>

	<span class="n">tx_set_idle</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">rx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_stop</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):rx_stop(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="cm">/* MODE:03 RAC Receiver Active, 0=inactive */</span>
	<span class="n">clear_reg_bits</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">MODE</span><span class="p">,</span> <span class="n">BIT3</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_overflow</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_start</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):rx_start(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="n">rx_reset_buffers</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_overflow</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* MODE:03 RAC Receiver Active, 1=active */</span>
	<span class="n">set_reg_bits</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">MODE</span><span class="p">,</span> <span class="n">BIT3</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_start</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):tx_start(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If auto RTS enabled and RTS is inactive, then assert */</span>
		<span class="cm">/* RTS and set a flag indicating that the driver should */</span>
		<span class="cm">/* negate RTS when the transmission completes. */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">drop_rts_on_tx_done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_AUTO_RTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RTS</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span><span class="p">;</span>
				<span class="n">set_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">drop_rts_on_tx_done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">tx_ready</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">tx_ready</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">5000</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_stop</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_ISR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):tx_stop(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Reset the adapter to a known state and prepare it for further use.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_device</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* power up both channels (set BIT7) */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">CCR0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span> <span class="o">+</span> <span class="n">CCR0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span> <span class="o">+</span> <span class="n">MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* disable all interrupts */</span>
	<span class="n">irq_disable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">irq_disable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">port_irq_disable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="cm">/* PCR Port Configuration Register</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..04  DEC[3..0] Serial I/F select outputs</span>
<span class="cm">	 * 03      output, 1=AUTO CTS control enabled</span>
<span class="cm">	 * 02      RI Ring Indicator input 0=active</span>
<span class="cm">	 * 01      DSR input 0=active</span>
<span class="cm">	 * 00      DTR output 0=active</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0000 0110</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">PCR</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>

	<span class="cm">/* PVR Port Value Register</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..04  DEC[3..0] Serial I/F select (0000=disabled)</span>
<span class="cm">	 * 03      AUTO CTS output 1=enabled</span>
<span class="cm">	 * 02      RI Ring Indicator input</span>
<span class="cm">	 * 01      DSR input</span>
<span class="cm">	 * 00      DTR output (1=inactive)</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0000 0001</span>
<span class="cm">	 */</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>write<em>reg(info, PVR, PVR</em>DTR);</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* IPC Interrupt Port Configuration</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      VIS 1=Masked interrupts visible</span>
<span class="cm">	 * 06..05  Reserved, 0</span>
<span class="cm">	 * 04..03  SLA Slave address, 00 ignored</span>
<span class="cm">	 * 02      CASM Cascading Mode, 1=daisy chain</span>
<span class="cm">	 * 01..00  IC[1..0] Interrupt Config, 01=push-pull output, active low</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0000 0101</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IPC</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">async_mode</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* disable all interrupts */</span>
	<span class="n">irq_disable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">irq_disable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">port_irq_disable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="cm">/* MODE</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      Reserved, 0</span>
<span class="cm">	 * 06      FRTS RTS State, 0=active</span>
<span class="cm">	 * 05      FCTS Flow Control on CTS</span>
<span class="cm">	 * 04      FLON Flow Control Enable</span>
<span class="cm">	 * 03      RAC Receiver Active, 0 = inactive</span>
<span class="cm">	 * 02      RTS 0=Auto RTS, 1=manual RTS</span>
<span class="cm">	 * 01      TRS Timer Resolution, 1=512</span>
<span class="cm">	 * 00      TLP Test Loop, 0 = no loop</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0000 0110</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">loopback</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT0</span><span class="p">;</span>

	<span class="cm">/* preserve RTS state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RTS</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT6</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* CCR0</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      PU Power Up, 1=active, 0=power down</span>
<span class="cm">	 * 06      MCE Master Clock Enable, 1=enabled</span>
<span class="cm">	 * 05      Reserved, 0</span>
<span class="cm">	 * 04..02  SC[2..0] Encoding, 000=NRZ</span>
<span class="cm">	 * 01..00  SM[1..0] Serial Mode, 11=Async</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1000 0011</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">CCR0</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">);</span>

	<span class="cm">/* CCR1</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..05  Reserved, 0</span>
<span class="cm">	 * 04      ODS Output Driver Select, 1=TxD is push-pull output</span>
<span class="cm">	 * 03      BCR Bit Clock Rate, 1=16x</span>
<span class="cm">	 * 02..00  CM[2..0] Clock Mode, 111=BRG</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0001 1111</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">CCR1</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>

	<span class="cm">/* CCR2 (channel A)</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..06  BGR[9..8] Baud rate bits 9..8</span>
<span class="cm">	 * 05      BDF Baud rate divisor factor, 0=1, 1=BGR value</span>
<span class="cm">	 * 04      SSEL Clock source select, 1=submode b</span>
<span class="cm">	 * 03      TOE 0=TxCLK is input, 0=TxCLK is input</span>
<span class="cm">	 * 02      RWX Read/Write Exchange 0=disabled</span>
<span class="cm">	 * 01      Reserved, 0</span>
<span class="cm">	 * 00      DIV, data inversion 0=disabled, 1=enabled</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0001 0000</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">CCR2</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>

	<span class="cm">/* CCR3</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07..01  Reserved, 0</span>
<span class="cm">	 * 00      PSD DPLL Phase Shift Disable</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0000 0000</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">CCR3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* CCR4</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      MCK4 Master Clock Divide by 4, 1=enabled</span>
<span class="cm">	 * 06      EBRG Enhanced Baud Rate Generator Mode, 1=enabled</span>
<span class="cm">	 * 05      TST1 Test Pin, 0=normal operation</span>
<span class="cm">	 * 04      ICD Ivert Carrier Detect, 1=enabled (active low)</span>
<span class="cm">	 * 03..00  Reserved, must be 0</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0101 0000</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">CCR4</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
	<span class="n">mgslpc_set_rate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_rate</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>

	<span class="cm">/* DAFO Data Format</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      Reserved, 0</span>
<span class="cm">	 * 06      XBRK transmit break, 0=normal operation</span>
<span class="cm">	 * 05      Stop bits (0=1, 1=2)</span>
<span class="cm">	 * 04..03  PAR[1..0] Parity (01=odd, 10=even)</span>
<span class="cm">	 * 02      PAREN Parity Enable</span>
<span class="cm">	 * 01..00  CHL[1..0] Character Length (00=8, 01=7)</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">data_bits</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT0</span><span class="p">;</span>	<span class="cm">/* 7 bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">stop_bits</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span> <span class="o">!=</span> <span class="n">ASYNC_PARITY_NONE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT2</span><span class="p">;</span>	<span class="cm">/* Parity enable */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">parity</span> <span class="o">==</span> <span class="n">ASYNC_PARITY_ODD</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT3</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">DAFO</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* RFC Rx FIFO Control</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      Reserved, 0</span>
<span class="cm">	 * 06      DPS, 1=parity bit not stored in data byte</span>
<span class="cm">	 * 05      DXS, 0=all data stored in FIFO (including XON/XOFF)</span>
<span class="cm">	 * 04      RFDF Rx FIFO Data Format, 1=status byte stored in FIFO</span>
<span class="cm">	 * 03..02  RFTH[1..0], rx threshold, 11=16 status + 16 data byte</span>
<span class="cm">	 * 01      Reserved, 0</span>
<span class="cm">	 * 00      TCDE Terminate Char Detect Enable, 0=disabled</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0101 1100</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">RFC</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">);</span>

	<span class="cm">/* RLCR Receive length check register</span>
<span class="cm">	 *</span>
<span class="cm">	 * Max frame length = (RL + 1) * 32</span>
<span class="cm">	 */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">RLCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* XBCH Transmit Byte Count High</span>
<span class="cm">	 *</span>
<span class="cm">	 * 07      DMA mode, 0 = interrupt driven</span>
<span class="cm">	 * 06      NRM, 0=ABM (ignored)</span>
<span class="cm">	 * 05      CAS Carrier Auto Start</span>
<span class="cm">	 * 04      XC Transmit Continuously (ignored)</span>
<span class="cm">	 * 03..00  XBC[10..8] Transmit byte count bits 10..8</span>
<span class="cm">	 *</span>
<span class="cm">	 * 0000 0000</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_AUTO_DCD</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT5</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">XBCH</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_AUTO_CTS</span><span class="p">)</span>
		<span class="n">irq_enable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">IRQ_CTS</span><span class="p">);</span>

	<span class="cm">/* MODE:03 RAC Receiver Active, 1=active */</span>
	<span class="n">set_reg_bits</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">MODE</span><span class="p">,</span> <span class="n">BIT3</span><span class="p">);</span>
	<span class="n">enable_auxclk</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HDLC_FLAG_AUTO_CTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_enable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span><span class="p">,</span> <span class="n">IRQ_CTS</span><span class="p">);</span>
		<span class="cm">/* PVR[3] 1=AUTO CTS active */</span>
		<span class="n">set_reg_bits</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">PVR</span><span class="p">,</span> <span class="n">BIT3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">clear_reg_bits</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">PVR</span><span class="p">,</span> <span class="n">BIT3</span><span class="p">);</span>
	<span class="n">irq_enable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span>
			  <span class="n">IRQ_RXEOM</span> <span class="o">+</span> <span class="n">IRQ_RXFIFO</span> <span class="o">+</span> <span class="n">IRQ_BREAK_ON</span> <span class="o">+</span> <span class="n">IRQ_RXTIME</span> <span class="o">+</span>
			  <span class="n">IRQ_ALLSENT</span> <span class="o">+</span> <span class="n">IRQ_TXFIFO</span><span class="p">);</span>
	<span class="n">issue_command</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">CMD_TXRESET</span> <span class="o">+</span> <span class="n">CMD_RXRESET</span><span class="p">);</span>
	<span class="n">wait_command_complete</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">);</span>
	<span class="n">read_reg16</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">ISR</span><span class="p">);</span>	<span class="cm">/* clear pending IRQs */</span>
<span class="p">}</span>

<span class="cm">/* Set the HDLC idle mode for the transmitter.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_set_idle</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Note: ESCC2 only supports flags and one idle modes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_mode</span> <span class="o">==</span> <span class="n">HDLC_TXIDLE_FLAGS</span><span class="p">)</span>
		<span class="n">set_reg_bits</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">CCR1</span><span class="p">,</span> <span class="n">BIT3</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_reg_bits</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">CCR1</span><span class="p">,</span> <span class="n">BIT3</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* get state of the V24 status (input) signals.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_signals</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* preserve DTR and RTS */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;=</span> <span class="n">SerialSignal_DTR</span> <span class="o">+</span> <span class="n">SerialSignal_RTS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span> <span class="o">+</span> <span class="n">VSTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT7</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_DCD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHB</span> <span class="o">+</span> <span class="n">STAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT1</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_CTS</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">PVR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PVR_RI</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PVR_DSR</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_DSR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set the state of DTR and RTS based on contents of</span>
<span class="cm"> * serial_signals member of device extension.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_signals</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">MODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_ASYNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RTS</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT6</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT6</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_RTS</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DTR</span><span class="p">)</span>
		<span class="n">clear_reg_bits</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">PVR</span><span class="p">,</span> <span class="n">PVR_DTR</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_reg_bits</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">PVR</span><span class="p">,</span> <span class="n">PVR_DTR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_reset_buffers</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RXBUF</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_put</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_get</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_frame_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">RXBUF</span><span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_size</span><span class="p">));</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Attempt to return a received HDLC frame</span>
<span class="cm"> * Only frames received without errors are returned.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if frame returned, otherwise false</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">rx_get_frame</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">RXBUF</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">framesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">return_frame</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_frame_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">RXBUF</span><span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_get</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_size</span><span class="p">));</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="cm">/* 07  VFR  1=valid frame</span>
<span class="cm">	 * 06  RDO  1=data overrun</span>
<span class="cm">	 * 05  CRC  1=OK, 0=error</span>
<span class="cm">	 * 04  RAB  1=frame aborted</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xA0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT7</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT4</span><span class="p">))</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxabort</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT6</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxover</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT5</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxcrc</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">crc_type</span> <span class="o">&amp;</span> <span class="n">HDLC_CRC_RETURN_EX</span><span class="p">)</span>
				<span class="n">return_frame</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">framesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
		<span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">return_frame</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">return_frame</span><span class="p">)</span>
		<span class="n">framesize</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_BH</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):rx_get_frame(%s) status=%04X size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span><span class="n">status</span><span class="p">,</span><span class="n">framesize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_DATA</span><span class="p">)</span>
		<span class="n">trace_block</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">framesize</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">framesize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">crc_type</span> <span class="o">&amp;</span> <span class="n">HDLC_CRC_RETURN_EX</span> <span class="o">&amp;&amp;</span>
		      <span class="n">framesize</span><span class="o">+</span><span class="mi">1</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">framesize</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxlong</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT5</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rxok</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">crc_type</span> <span class="o">&amp;</span> <span class="n">HDLC_CRC_RETURN_EX</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">framesize</span><span class="p">)</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">BIT5</span> <span class="o">?</span> <span class="n">RX_OK</span><span class="o">:</span><span class="n">RX_CRC_ERROR</span><span class="p">;</span>
				<span class="o">++</span><span class="n">framesize</span><span class="p">;</span>
			<span class="p">}</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span>
				<span class="n">hdlcdev_rx</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">framesize</span><span class="p">);</span>
			<span class="k">else</span>
<span class="cp">#endif</span>
				<span class="n">ldisc_receive_buf</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">flag_buf</span><span class="p">,</span> <span class="n">framesize</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_frame_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_get</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_get</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_buf_count</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_get</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">register_test</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">patterns</span><span class="p">[]</span> <span class="o">=</span>
	    <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x0f</span> <span class="p">};</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">patterns</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">reset_device</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">XAD1</span><span class="p">,</span> <span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">XAD2</span><span class="p">,</span> <span class="n">patterns</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">count</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">XAD1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">XAD2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">patterns</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">count</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">irq_test</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">reset_device</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">testing_irq</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">hdlc_mode</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_occurred</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* init hdlc mode */</span>

	<span class="n">irq_enable</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">IRQ_TIMER</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span> <span class="o">+</span> <span class="n">TIMR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* 512 cycles */</span>
	<span class="n">issue_command</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span> <span class="n">CMD_START_TIMER</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">end_time</span><span class="o">=</span><span class="mi">100</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">end_time</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_occurred</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">testing_irq</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">reset_device</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_occurred</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adapter_test</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">register_test</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">DiagStatus_AddressFailure</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):Register test failure for device %s Addr=%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">)</span> <span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_test</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">init_error</span> <span class="o">=</span> <span class="n">DiagStatus_IrqFailure</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):Interrupt test failure for device %s IRQ=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">)</span> <span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d):device %s passed diagnostics</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">trace_block</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xmit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">linecount</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xmit</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s tx data:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s rx data:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>

	<span class="k">while</span><span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">linecount</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">linecount</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">linecount</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02X &quot;</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">for</span><span class="p">(;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">17</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;   &quot;</span><span class="p">);</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">linecount</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;=</span><span class="mo">040</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;=</span><span class="mo">0176</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">data</span>  <span class="o">+=</span> <span class="n">linecount</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">linecount</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* HDLC frame time out</span>
<span class="cm"> * update stats and do tx completion processing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">MGSLPC_INFO</span><span class="o">*</span><span class="p">)</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s(%d):tx_timeout(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">&amp;&amp;</span>
	   <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MGSL_MODE_HDLC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">txtimeout</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span>
		<span class="n">hdlcdev_tx_done</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">bh_transmit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#if SYNCLINK_GENERIC_HDLC</span>

<span class="cm">/**</span>
<span class="cm"> * called by generic HDLC layer when protocol selected (PPP, frame relay, etc.)</span>
<span class="cm"> * set encoding and frame check sequence (FCS) options</span>
<span class="cm"> *</span>
<span class="cm"> * dev       pointer to network device structure</span>
<span class="cm"> * encoding  serial encoding setting</span>
<span class="cm"> * parity    FCS setting</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success, otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdlcdev_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">encoding</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">parity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">new_encoding</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">new_crctype</span><span class="p">;</span>

	<span class="cm">/* return error if TTY interface open */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">ENCODING_NRZ</span>:        <span class="n">new_encoding</span> <span class="o">=</span> <span class="n">HDLC_ENCODING_NRZ</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODING_NRZI</span>:       <span class="n">new_encoding</span> <span class="o">=</span> <span class="n">HDLC_ENCODING_NRZI_SPACE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODING_FM_MARK</span>:    <span class="n">new_encoding</span> <span class="o">=</span> <span class="n">HDLC_ENCODING_BIPHASE_MARK</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODING_FM_SPACE</span>:   <span class="n">new_encoding</span> <span class="o">=</span> <span class="n">HDLC_ENCODING_BIPHASE_SPACE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENCODING_MANCHESTER</span>: <span class="n">new_encoding</span> <span class="o">=</span> <span class="n">HDLC_ENCODING_BIPHASE_LEVEL</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">parity</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">PARITY_NONE</span>:            <span class="n">new_crctype</span> <span class="o">=</span> <span class="n">HDLC_CRC_NONE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PARITY_CRC16_PR1_CCITT</span>: <span class="n">new_crctype</span> <span class="o">=</span> <span class="n">HDLC_CRC_16_CCITT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PARITY_CRC32_PR1_CCITT</span>: <span class="n">new_crctype</span> <span class="o">=</span> <span class="n">HDLC_CRC_32_CCITT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">new_encoding</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">crc_type</span> <span class="o">=</span> <span class="n">new_crctype</span><span class="p">;</span>

	<span class="cm">/* if network interface up, reprogram hardware */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">mgslpc_program_hw</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by generic HDLC layer to send frame</span>
<span class="cm"> *</span>
<span class="cm"> * skb  socket buffer containing HDLC frame</span>
<span class="cm"> * dev  pointer to network device structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">hdlcdev_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:hdlc_xmit(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* stop sending until this frame completes */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* copy data to device buffers */</span>
	<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_get</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_put</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* update network statistics */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* done with socket buffer, so free it */</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* save start time for transmit timeout detection */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* start hardware transmitter if necessary */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	 	<span class="n">tx_start</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	 	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by network layer when interface enabled</span>
<span class="cm"> * claim resources and initialize hardware</span>
<span class="cm"> *</span>
<span class="cm"> * dev  pointer to network device structure</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success, otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdlcdev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:hdlcdev_open(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* generic HDLC layer open processing */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">hdlc_open</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* arbitrate between network and tty opens */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: hdlc_open returning busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="cm">/* claim resources and init adapter */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">startup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* assert DTR and RTS, apply hardware settings */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">|=</span> <span class="n">SerialSignal_RTS</span> <span class="o">+</span> <span class="n">SerialSignal_DTR</span><span class="p">;</span>
	<span class="n">mgslpc_program_hw</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="cm">/* enable network layer transmit */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* inform generic HDLC layer of current DCD status */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">get_signals</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">serial_signals</span> <span class="o">&amp;</span> <span class="n">SerialSignal_DCD</span><span class="p">)</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by network layer when interface is disabled</span>
<span class="cm"> * shutdown hardware and release resources</span>
<span class="cm"> *</span>
<span class="cm"> * dev  pointer to network device structure</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success, otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdlcdev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:hdlcdev_close(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* shutdown adapter and release resources */</span>
	<span class="n">shutdown</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">hdlc_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by network layer to process IOCTL call to network device</span>
<span class="cm"> *</span>
<span class="cm"> * dev  pointer to network device structure</span>
<span class="cm"> * ifr  pointer to network interface request structure</span>
<span class="cm"> * cmd  IOCTL command code</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success, otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdlcdev_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sync_serial_settings</span><span class="p">);</span>
	<span class="n">sync_serial_settings</span> <span class="n">new_line</span><span class="p">;</span>
	<span class="n">sync_serial_settings</span> <span class="n">__user</span> <span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">ifs_ifsu</span><span class="p">.</span><span class="n">sync</span><span class="p">;</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:hdlcdev_ioctl(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* return error if TTY interface open */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">SIOCWANDEV</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hdlc_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_line</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IF_GET_IFACE</span>: <span class="cm">/* return current sync_serial_settings */</span>

		<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">IF_IFACE_SYNC_SERIAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span> <span class="cm">/* data size wanted */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_RXC_DPLL</span> <span class="o">|</span>
					      <span class="n">HDLC_FLAG_RXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_RXC_TXCPIN</span> <span class="o">|</span>
					      <span class="n">HDLC_FLAG_TXC_TXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_DPLL</span> <span class="o">|</span>
					      <span class="n">HDLC_FLAG_TXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_RXCPIN</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">flags</span><span class="p">){</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_TXCPIN</span><span class="p">)</span>: <span class="n">new_line</span><span class="p">.</span><span class="n">clock_type</span> <span class="o">=</span> <span class="n">CLOCK_EXT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">HDLC_FLAG_RXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">)</span>:    <span class="n">new_line</span><span class="p">.</span><span class="n">clock_type</span> <span class="o">=</span> <span class="n">CLOCK_INT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">)</span>:    <span class="n">new_line</span><span class="p">.</span><span class="n">clock_type</span> <span class="o">=</span> <span class="n">CLOCK_TXINT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_RXCPIN</span><span class="p">)</span>: <span class="n">new_line</span><span class="p">.</span><span class="n">clock_type</span> <span class="o">=</span> <span class="n">CLOCK_TXFROMRX</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="n">new_line</span><span class="p">.</span><span class="n">clock_type</span> <span class="o">=</span> <span class="n">CLOCK_DEFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">new_line</span><span class="p">.</span><span class="n">clock_rate</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span><span class="p">;</span>
		<span class="n">new_line</span><span class="p">.</span><span class="n">loopback</span>   <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">loopback</span> <span class="o">?</span> <span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_line</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IF_IFACE_SYNC_SERIAL</span>: <span class="cm">/* set sync_serial_settings */</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_line</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">new_line</span><span class="p">.</span><span class="n">clock_type</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">CLOCK_EXT</span>:      <span class="n">flags</span> <span class="o">=</span> <span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_TXCPIN</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CLOCK_TXFROMRX</span>: <span class="n">flags</span> <span class="o">=</span> <span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_RXCPIN</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CLOCK_INT</span>:      <span class="n">flags</span> <span class="o">=</span> <span class="n">HDLC_FLAG_RXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CLOCK_TXINT</span>:    <span class="n">flags</span> <span class="o">=</span> <span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CLOCK_DEFAULT</span>:  <span class="n">flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span>
					     <span class="p">(</span><span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_RXC_DPLL</span> <span class="o">|</span>
					      <span class="n">HDLC_FLAG_RXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_RXC_TXCPIN</span> <span class="o">|</span>
					      <span class="n">HDLC_FLAG_TXC_TXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_DPLL</span> <span class="o">|</span>
					      <span class="n">HDLC_FLAG_TXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_RXCPIN</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_line</span><span class="p">.</span><span class="n">loopback</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">new_line</span><span class="p">.</span><span class="n">loopback</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HDLC_FLAG_RXC_RXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_RXC_DPLL</span> <span class="o">|</span>
					<span class="n">HDLC_FLAG_RXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_RXC_TXCPIN</span> <span class="o">|</span>
					<span class="n">HDLC_FLAG_TXC_TXCPIN</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_DPLL</span> <span class="o">|</span>
					<span class="n">HDLC_FLAG_TXC_BRG</span>    <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_RXCPIN</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">loopback</span> <span class="o">=</span> <span class="n">new_line</span><span class="p">.</span><span class="n">loopback</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HDLC_FLAG_RXC_BRG</span> <span class="o">|</span> <span class="n">HDLC_FLAG_TXC_BRG</span><span class="p">))</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span> <span class="o">=</span> <span class="n">new_line</span><span class="p">.</span><span class="n">clock_rate</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">clock_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* if network interface up, reprogram hardware */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netcount</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
			<span class="n">mgslpc_program_hw</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">hdlc_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by network layer when transmit timeout is detected</span>
<span class="cm"> *</span>
<span class="cm"> * dev  pointer to network device structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdlcdev_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hdlcdev_tx_timeout(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">tx_stop</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by device driver when transmit completes</span>
<span class="cm"> * reenable network layer transmit if stopped</span>
<span class="cm"> *</span>
<span class="cm"> * info  pointer to device instance information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdlcdev_tx_done</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by device driver when frame received</span>
<span class="cm"> * pass frame to network layer</span>
<span class="cm"> *</span>
<span class="cm"> * info  pointer to device instance information</span>
<span class="cm"> * buf   pointer to buffer contianing frame data</span>
<span class="cm"> * size  count of data bytes in buf</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdlcdev_rx</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_LEVEL_INFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hdlcdev_rx(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: can&#39;t alloc skb, dropping packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">hdlc_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">hdlcdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>       <span class="o">=</span> <span class="n">hdlcdev_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>       <span class="o">=</span> <span class="n">hdlcdev_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span> <span class="o">=</span> <span class="n">hdlc_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">hdlc_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>   <span class="o">=</span> <span class="n">hdlcdev_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span> <span class="o">=</span> <span class="n">hdlcdev_tx_timeout</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * called by device driver when adding device instance</span>
<span class="cm"> * do generic HDLC initialization</span>
<span class="cm"> *</span>
<span class="cm"> * info  pointer to device instance information</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success, otherwise error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdlcdev_init</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">hdlc_device</span> <span class="o">*</span><span class="n">hdlc</span><span class="p">;</span>

	<span class="cm">/* allocate and initialize network and HDLC layer objects */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_hdlcdev</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:hdlc device allocation failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for network layer reporting purposes only */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span>       <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">;</span>

	<span class="cm">/* network layer callbacks and settings */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>	    <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdlcdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span>   <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>

	<span class="cm">/* generic HDLC layer callbacks and settings */</span>
	<span class="n">hdlc</span>         <span class="o">=</span> <span class="n">dev_to_hdlc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">attach</span> <span class="o">=</span> <span class="n">hdlcdev_attach</span><span class="p">;</span>
	<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">xmit</span>   <span class="o">=</span> <span class="n">hdlcdev_xmit</span><span class="p">;</span>

	<span class="cm">/* register objects with HDLC layer */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">register_hdlc_device</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:unable to register hdlc device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * called by device driver when removing device instance</span>
<span class="cm"> * do generic HDLC cleanup</span>
<span class="cm"> *</span>
<span class="cm"> * info  pointer to device instance information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdlcdev_exit</span><span class="p">(</span><span class="n">MGSLPC_INFO</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_hdlc_device</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_HDLC */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
