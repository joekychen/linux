<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › char › pcmcia › cm4000_cs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cm4000_cs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre> <span class="cm">/*</span>
<span class="cm">  * A driver for the PCMCIA Smartcard Reader &quot;Omnikey CardMan Mobile 4000&quot;</span>
<span class="cm">  *</span>
<span class="cm">  * cm4000_cs.c support.linux@omnikey.com</span>
<span class="cm">  *</span>
<span class="cm">  * Tue Oct 23 11:32:43 GMT 2001 herp - cleaned up header files</span>
<span class="cm">  * Sun Jan 20 10:11:15 MET 2002 herp - added modversion header files</span>
<span class="cm">  * Thu Nov 14 16:34:11 GMT 2002 mh   - added PPS functionality</span>
<span class="cm">  * Tue Nov 19 16:36:27 GMT 2002 mh   - added SUSPEND/RESUME functionailty</span>
<span class="cm">  * Wed Jul 28 12:55:01 CEST 2004 mh  - kernel 2.6 adjustments</span>
<span class="cm">  *</span>
<span class="cm">  * current version: 2.4.0gm4</span>
<span class="cm">  *</span>
<span class="cm">  * (C) 2000,2001,2002,2003,2004 Omnikey AG</span>
<span class="cm">  *</span>
<span class="cm">  * (C) 2005-2006 Harald Welte &lt;laforge@gnumonks.org&gt;</span>
<span class="cm">  * 	- Adhere to Kernel CodingStyle</span>
<span class="cm">  * 	- Port to 2.6.13 &quot;new&quot; style PCMCIA</span>
<span class="cm">  * 	- Check for copy_{from,to}_user return values</span>
<span class="cm">  * 	- Use nonseekable_open()</span>
<span class="cm">  * 	- add class interface for udev device creation</span>
<span class="cm">  *</span>
<span class="cm">  * All rights reserved. Licensed under dual BSD/GPL license.</span>
<span class="cm">  */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/bitrev.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;pcmcia/cistpl.h&gt;</span>
<span class="cp">#include &lt;pcmcia/cisreg.h&gt;</span>
<span class="cp">#include &lt;pcmcia/ciscode.h&gt;</span>
<span class="cp">#include &lt;pcmcia/ds.h&gt;</span>

<span class="cp">#include &lt;linux/cm4000_cs.h&gt;</span>

<span class="cm">/* #define ATR_CSUM */</span>

<span class="cp">#define reader_to_dev(x)	(&amp;x-&gt;p_dev-&gt;dev)</span>

<span class="cm">/* n (debug level) is ignored */</span>
<span class="cm">/* additional debug output may be enabled by re-compiling with</span>
<span class="cm"> * CM4000_DEBUG set */</span>
<span class="cm">/* #define CM4000_DEBUG */</span>
<span class="cp">#define DEBUGP(n, rdr, x, args...) do { 		\</span>
<span class="cp">		dev_dbg(reader_to_dev(rdr), &quot;%s:&quot; x, 	\</span>
<span class="cp">			   __func__ , ## args);		\</span>
<span class="cp">	} while (0)</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">cmm_mutex</span><span class="p">);</span>

<span class="cp">#define	T_1SEC		(HZ)</span>
<span class="cp">#define	T_10MSEC	msecs_to_jiffies(10)</span>
<span class="cp">#define	T_20MSEC	msecs_to_jiffies(20)</span>
<span class="cp">#define	T_40MSEC	msecs_to_jiffies(40)</span>
<span class="cp">#define	T_50MSEC	msecs_to_jiffies(50)</span>
<span class="cp">#define	T_100MSEC	msecs_to_jiffies(100)</span>
<span class="cp">#define	T_500MSEC	msecs_to_jiffies(500)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cm4000_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">major</span><span class="p">;</span>		<span class="cm">/* major number we get from the kernel */</span>

<span class="cm">/* note: the first state has to have number 0 always */</span>

<span class="cp">#define	M_FETCH_ATR	0</span>
<span class="cp">#define	M_TIMEOUT_WAIT	1</span>
<span class="cp">#define	M_READ_ATR_LEN	2</span>
<span class="cp">#define	M_READ_ATR	3</span>
<span class="cp">#define	M_ATR_PRESENT	4</span>
<span class="cp">#define	M_BAD_CARD	5</span>
<span class="cp">#define M_CARDOFF	6</span>

<span class="cp">#define	LOCK_IO			0</span>
<span class="cp">#define	LOCK_MONITOR		1</span>

<span class="cp">#define IS_AUTOPPS_ACT		 6</span>
<span class="cp">#define	IS_PROCBYTE_PRESENT	 7</span>
<span class="cp">#define	IS_INVREV		 8</span>
<span class="cp">#define IS_ANY_T0		 9</span>
<span class="cp">#define	IS_ANY_T1		10</span>
<span class="cp">#define	IS_ATR_PRESENT		11</span>
<span class="cp">#define	IS_ATR_VALID		12</span>
<span class="cp">#define	IS_CMM_ABSENT		13</span>
<span class="cp">#define	IS_BAD_LENGTH		14</span>
<span class="cp">#define	IS_BAD_CSUM		15</span>
<span class="cp">#define	IS_BAD_CARD		16</span>

<span class="cp">#define REG_FLAGS0(x)		(x + 0)</span>
<span class="cp">#define REG_FLAGS1(x)		(x + 1)</span>
<span class="cp">#define REG_NUM_BYTES(x)	(x + 2)</span>
<span class="cp">#define REG_BUF_ADDR(x)		(x + 3)</span>
<span class="cp">#define REG_BUF_DATA(x)		(x + 4)</span>
<span class="cp">#define REG_NUM_SEND(x)		(x + 5)</span>
<span class="cp">#define REG_BAUDRATE(x)		(x + 6)</span>
<span class="cp">#define REG_STOPBITS(x)		(x + 7)</span>

<span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">atr</span><span class="p">[</span><span class="n">MAX_ATR</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sbuf</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>

	<span class="n">wait_queue_head_t</span> <span class="n">devq</span><span class="p">;</span>		<span class="cm">/* when removing cardman must not be</span>
<span class="cm">					   zeroed! */</span>

	<span class="n">wait_queue_head_t</span> <span class="n">ioq</span><span class="p">;</span>		<span class="cm">/* if IO is locked, wait on this Q */</span>
	<span class="n">wait_queue_head_t</span> <span class="n">atrq</span><span class="p">;</span>		<span class="cm">/* wait for ATR valid */</span>
	<span class="n">wait_queue_head_t</span> <span class="n">readq</span><span class="p">;</span>	<span class="cm">/* used by write to wake blk.read */</span>

	<span class="cm">/* warning: do not move this fields.</span>
<span class="cm">	 * initialising to zero depends on it - see ZERO_DEV below.  */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">atr_csum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">atr_len_retry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">atr_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rlen</span><span class="p">;</span>	<span class="cm">/* bytes avail. after write */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rpos</span><span class="p">;</span>	<span class="cm">/* latest read pos. write zeroes */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">procbyte</span><span class="p">;</span>	<span class="cm">/* T=0 procedure byte */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mstate</span><span class="p">;</span>	<span class="cm">/* state of card monitor */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cwarn</span><span class="p">;</span>	<span class="cm">/* slow down warning */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flags0</span><span class="p">;</span>	<span class="cm">/* cardman IO-flags 0 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flags1</span><span class="p">;</span>	<span class="cm">/* cardman IO-flags 1 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mdelay</span><span class="p">;</span>	<span class="cm">/* variable monitor speeds, in jiffies */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">baudv</span><span class="p">;</span>	<span class="cm">/* baud value for speed */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ta1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">proto</span><span class="p">;</span>	<span class="cm">/* T=0, T=1, ... */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>	<span class="cm">/* lock+flags (MONITOR,IO,ATR) * for concurrent</span>
<span class="cm">				   access */</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pts</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>	<span class="cm">/* used to keep monitor running */</span>
	<span class="kt">int</span> <span class="n">monitor_running</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define	ZERO_DEV(dev)  						\</span>
<span class="cp">	memset(&amp;dev-&gt;atr_csum,0,				\</span>
<span class="cp">		sizeof(struct cm4000_dev) - 			\</span>
<span class="cp">		offsetof(struct cm4000_dev, atr_csum))</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">dev_table</span><span class="p">[</span><span class="n">CM4000_MAX_DEV</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">cmm_class</span><span class="p">;</span>

<span class="cm">/* This table doesn&#39;t use spaces after the comma between fields and thus</span>
<span class="cm"> * violates CodingStyle.  However, I don&#39;t really think wrapping it around will</span>
<span class="cm"> * make it any clearer to read -HW */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fi_di_table</span><span class="p">[</span><span class="mi">10</span><span class="p">][</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/*FI     00   01   02   03   04   05   06   07   08   09   10   11   12   13 */</span>
<span class="cm">/*DI */</span>
<span class="cm">/* 0 */</span> <span class="p">{</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">},</span>
<span class="cm">/* 1 */</span> <span class="p">{</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x91</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">},</span>
<span class="cm">/* 2 */</span> <span class="p">{</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x12</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0x32</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x92</span><span class="p">,</span><span class="mh">0xA2</span><span class="p">,</span><span class="mh">0xB2</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">},</span>
<span class="cm">/* 3 */</span> <span class="p">{</span><span class="mh">0x03</span><span class="p">,</span><span class="mh">0x13</span><span class="p">,</span><span class="mh">0x23</span><span class="p">,</span><span class="mh">0x33</span><span class="p">,</span><span class="mh">0x43</span><span class="p">,</span><span class="mh">0x53</span><span class="p">,</span><span class="mh">0x63</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x93</span><span class="p">,</span><span class="mh">0xA3</span><span class="p">,</span><span class="mh">0xB3</span><span class="p">,</span><span class="mh">0xC3</span><span class="p">,</span><span class="mh">0xD3</span><span class="p">},</span>
<span class="cm">/* 4 */</span> <span class="p">{</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0x14</span><span class="p">,</span><span class="mh">0x24</span><span class="p">,</span><span class="mh">0x34</span><span class="p">,</span><span class="mh">0x44</span><span class="p">,</span><span class="mh">0x54</span><span class="p">,</span><span class="mh">0x64</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x94</span><span class="p">,</span><span class="mh">0xA4</span><span class="p">,</span><span class="mh">0xB4</span><span class="p">,</span><span class="mh">0xC4</span><span class="p">,</span><span class="mh">0xD4</span><span class="p">},</span>
<span class="cm">/* 5 */</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x15</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0x35</span><span class="p">,</span><span class="mh">0x45</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0x65</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x95</span><span class="p">,</span><span class="mh">0xA5</span><span class="p">,</span><span class="mh">0xB5</span><span class="p">,</span><span class="mh">0xC5</span><span class="p">,</span><span class="mh">0xD5</span><span class="p">},</span>
<span class="cm">/* 6 */</span> <span class="p">{</span><span class="mh">0x06</span><span class="p">,</span><span class="mh">0x16</span><span class="p">,</span><span class="mh">0x26</span><span class="p">,</span><span class="mh">0x36</span><span class="p">,</span><span class="mh">0x46</span><span class="p">,</span><span class="mh">0x56</span><span class="p">,</span><span class="mh">0x66</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x96</span><span class="p">,</span><span class="mh">0xA6</span><span class="p">,</span><span class="mh">0xB6</span><span class="p">,</span><span class="mh">0xC6</span><span class="p">,</span><span class="mh">0xD6</span><span class="p">},</span>
<span class="cm">/* 7 */</span> <span class="p">{</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">},</span>
<span class="cm">/* 8 */</span> <span class="p">{</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x28</span><span class="p">,</span><span class="mh">0x38</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x98</span><span class="p">,</span><span class="mh">0xA8</span><span class="p">,</span><span class="mh">0xB8</span><span class="p">,</span><span class="mh">0xC8</span><span class="p">,</span><span class="mh">0xD8</span><span class="p">},</span>
<span class="cm">/* 9 */</span> <span class="p">{</span><span class="mh">0x09</span><span class="p">,</span><span class="mh">0x19</span><span class="p">,</span><span class="mh">0x29</span><span class="p">,</span><span class="mh">0x39</span><span class="p">,</span><span class="mh">0x49</span><span class="p">,</span><span class="mh">0x59</span><span class="p">,</span><span class="mh">0x69</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x99</span><span class="p">,</span><span class="mh">0xA9</span><span class="p">,</span><span class="mh">0xB9</span><span class="p">,</span><span class="mh">0xC9</span><span class="p">,</span><span class="mh">0xD9</span><span class="p">}</span>
<span class="p">};</span>

<span class="cp">#ifndef CM4000_DEBUG</span>
<span class="cp">#define	xoutb	outb</span>
<span class="cp">#define	xinb	inb</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">xoutb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;outb(val=%.2x,port=%.4x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">xinb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%.2x=inb(%.4x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">invert_revert</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bitrev8</span><span class="p">(</span><span class="o">~</span><span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">str_invert_revert</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">invert_revert</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cp">#define	ATRLENCK(dev,pos) \</span>
<span class="cp">	if (pos&gt;=dev-&gt;atr_len || pos&gt;=MAX_ATR) \</span>
<span class="cp">		goto return_0;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">calc_baudv</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fidi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wcrcf</span><span class="p">,</span> <span class="n">wbrcf</span><span class="p">,</span> <span class="n">fi_rfu</span><span class="p">,</span> <span class="n">di_rfu</span><span class="p">;</span>

	<span class="n">fi_rfu</span> <span class="o">=</span> <span class="mi">372</span><span class="p">;</span>
	<span class="n">di_rfu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* FI */</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">fidi</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>:
		<span class="n">wcrcf</span> <span class="o">=</span> <span class="mi">372</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x01</span>:
		<span class="n">wcrcf</span> <span class="o">=</span> <span class="mi">372</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x02</span>:
		<span class="n">wcrcf</span> <span class="o">=</span> <span class="mi">558</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x03</span>:
		<span class="n">wcrcf</span> <span class="o">=</span> <span class="mi">744</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x04</span>:
		<span class="n">wcrcf</span> <span class="o">=</span> <span class="mi">1116</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x05</span>:
		<span class="n">wcrcf</span> <span class="o">=</span> <span class="mi">1488</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x06</span>:
		<span class="n">wcrcf</span> <span class="o">=</span> <span class="mi">1860</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x07</span>:
		<span class="n">wcrcf</span> <span class="o">=</span> <span class="n">fi_rfu</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x08</span>:
		<span class="n">wcrcf</span> <span class="o">=</span> <span class="n">fi_rfu</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x09</span>:
		<span class="n">wcrcf</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0A</span>:
		<span class="n">wcrcf</span> <span class="o">=</span> <span class="mi">768</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0B</span>:
		<span class="n">wcrcf</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0C</span>:
		<span class="n">wcrcf</span> <span class="o">=</span> <span class="mi">1536</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0D</span>:
		<span class="n">wcrcf</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">wcrcf</span> <span class="o">=</span> <span class="n">fi_rfu</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* DI */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fidi</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>:
		<span class="n">wbrcf</span> <span class="o">=</span> <span class="n">di_rfu</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x01</span>:
		<span class="n">wbrcf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x02</span>:
		<span class="n">wbrcf</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x03</span>:
		<span class="n">wbrcf</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x04</span>:
		<span class="n">wbrcf</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x05</span>:
		<span class="n">wbrcf</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x06</span>:
		<span class="n">wbrcf</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x07</span>:
		<span class="n">wbrcf</span> <span class="o">=</span> <span class="n">di_rfu</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x08</span>:
		<span class="n">wbrcf</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x09</span>:
		<span class="n">wbrcf</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">wbrcf</span> <span class="o">=</span> <span class="n">di_rfu</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">wcrcf</span> <span class="o">/</span> <span class="n">wbrcf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">io_read_num_rec_bytes</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iobase</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">REG_NUM_BYTES</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">4</span> <span class="o">?</span> <span class="mh">0x100</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_atr</span><span class="p">(</span><span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">any_t1</span><span class="p">,</span> <span class="n">any_t0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ifno</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ix</span><span class="p">,</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;-&gt; parse_atr: dev-&gt;atr_len = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_len</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;parse_atr: atr_len &lt; 3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x3f</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IS_INVREV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">IS_INVREV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ifno</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* XXX PROTO */</span>
	<span class="n">any_t1</span> <span class="o">=</span> <span class="n">any_t0</span> <span class="o">=</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ta1</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>	<span class="cm">/* defaults to 9600 baud */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ifno</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* read first interface byte and TA1 is present */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ta1</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Card says FiDi is 0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ta1</span><span class="p">);</span>
			<span class="n">ifno</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ifno</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* TA(2) */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ta1</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
			<span class="n">ifno</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Yi=%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">);</span>
		<span class="n">ix</span> <span class="o">+=</span> <span class="p">((</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span>	<span class="cm">/* no of int.face chars */</span>
		    <span class="o">+</span><span class="p">((</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span>
		    <span class="o">+</span> <span class="p">((</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span>
		    <span class="o">+</span> <span class="p">((</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="cm">/* ATRLENCK(dev,ix); */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* TDi */</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr</span><span class="p">[</span><span class="n">ix</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">any_t1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;card is capable of T=1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">any_t0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;card is capable of T=0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">);</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ix=%d noHist=%d any_t1=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">ix</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">,</span> <span class="n">any_t1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">+</span> <span class="n">any_t1</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;length error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">any_t0</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IS_ANY_T0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">any_t1</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* compute csum */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef ATR_CSUM</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_csum</span> <span class="o">^=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_csum</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">IS_BAD_CSUM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad checksum</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">return_0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">any_t0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* XXX PROTO */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IS_ANY_T1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">card_fixup</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">atr</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="n">u_int8_t</span> <span class="n">atr_len</span><span class="p">;</span>
	<span class="n">u_int8_t</span> <span class="n">stopbits</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">card_fixup</span> <span class="n">card_fixups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>	<span class="cm">/* ACOS */</span>
		<span class="p">.</span><span class="n">atr</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">atr_len</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">stopbits</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* Motorola */</span>
		<span class="p">.</span><span class="n">atr</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span>
			<span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x81</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">atr_len</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
		<span class="p">.</span><span class="n">stopbits</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_cardparameter</span><span class="p">(</span><span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">u_int8_t</span> <span class="n">stopbits</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* ISO default */</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;-&gt; set_cardparameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">|</span> <span class="p">(((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">baudv</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">xoutb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span><span class="p">,</span> <span class="n">REG_FLAGS1</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;flags1 = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span><span class="p">);</span>

	<span class="cm">/* set baudrate */</span>
	<span class="n">xoutb</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">baudv</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">),</span> <span class="n">REG_BAUDRATE</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;baudv = %i -&gt; write 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">baudv</span><span class="p">,</span>
	      <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">baudv</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>

	<span class="cm">/* set stopbits */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">card_fixups</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr</span><span class="p">,</span> <span class="n">card_fixups</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">atr</span><span class="p">,</span>
			    <span class="n">card_fixups</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">atr_len</span><span class="p">))</span>
			<span class="n">stopbits</span> <span class="o">=</span> <span class="n">card_fixups</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stopbits</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xoutb</span><span class="p">(</span><span class="n">stopbits</span><span class="p">,</span> <span class="n">REG_STOPBITS</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;- set_cardparameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ptsreq</span> <span class="o">*</span><span class="n">ptsreq</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">num_bytes_read</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pts_reply</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">ssize_t</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;-&gt; set_protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ptsreq-&gt;Protocol = 0x%.8x, ptsreq-&gt;Flags=0x%.8x, &quot;</span>
		 <span class="s">&quot;ptsreq-&gt;pts1=0x%.2x, ptsreq-&gt;pts2=0x%.2x, &quot;</span>
		 <span class="s">&quot;ptsreq-&gt;pts3=0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">ptsreq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">ptsreq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">ptsreq</span><span class="o">-&gt;</span><span class="n">pts1</span><span class="p">,</span> <span class="n">ptsreq</span><span class="o">-&gt;</span><span class="n">pts2</span><span class="p">,</span>
		 <span class="n">ptsreq</span><span class="o">-&gt;</span><span class="n">pts3</span><span class="p">);</span>

	<span class="cm">/* Fill PTS structure */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ptsreq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>	<span class="cm">/* Set new protocol */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="cm">/* Correct Fi/Di according to CM4000 Fi/Di table */</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Ta(1) from ATR is 0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ta1</span><span class="p">);</span>
	<span class="cm">/* set Fi/Di according to ATR TA(1) */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">fi_di_table</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ta1</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">][(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ta1</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">];</span>

	<span class="cm">/* Calculate PCK character */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pts0=%.2x, pts1=%.2x, pts2=%.2x, pts3=%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="cm">/* check card convention */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_INVREV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">str_invert_revert</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* reset SM */</span>
	<span class="n">xoutb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>

	<span class="cm">/* Enable access to the message buffer */</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Enable access to the messages buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">=</span> <span class="mh">0x20</span>	<span class="cm">/* T_Active */</span>
	    <span class="o">|</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_INVREV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x02</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">)</span> <span class="cm">/* inv parity */</span>
	    <span class="o">|</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">baudv</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>	<span class="cm">/* MSB-baud */</span>
	<span class="n">xoutb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span><span class="p">,</span> <span class="n">REG_FLAGS1</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Enable message buffer -&gt; flags1 = 0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span><span class="p">);</span>

	<span class="cm">/* write challenge to the buffer */</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Write challenge to buffer: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xoutb</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">REG_BUF_ADDR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="n">xoutb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">REG_BUF_DATA</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>	<span class="cm">/* buf data */</span>
<span class="cp">#ifdef CM4000_DEBUG</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;0x%.2x &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* set number of bytes to write */</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Set number of bytes to write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">xoutb</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">REG_NUM_SEND</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>

	<span class="cm">/* Trigger CARDMAN CONTROLLER */</span>
	<span class="n">xoutb</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>

	<span class="cm">/* Monitor progress */</span>
	<span class="cm">/* wait for xmit done */</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Waiting for NumRecBytes getting valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NumRecBytes is valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Timeout waiting for NumRecBytes getting &quot;</span>
		       <span class="s">&quot;valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_setprotocol</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Reading NumRecBytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">io_read_num_rec_bytes</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_bytes_read</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_bytes_read</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NumRecBytes = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num_bytes_read</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* check whether it is a short PTS reply? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_bytes_read</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Timeout reading num_bytes_read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_setprotocol</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Reset the CARDMAN CONTROLLER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">xoutb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>

	<span class="cm">/* Read PPS reply */</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Read PPS reply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_bytes_read</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xoutb</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">REG_BUF_ADDR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="n">pts_reply</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">REG_BUF_DATA</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="p">}</span>

<span class="cp">#ifdef CM4000_DEBUG</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PTSreply: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_bytes_read</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;0x%.2x &quot;</span><span class="p">,</span> <span class="n">pts_reply</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif	</span><span class="cm">/* CM4000_DEBUG */</span><span class="cp"></span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Clear Tactive in Flags1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">xoutb</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">REG_FLAGS1</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>

	<span class="cm">/* Compare ptsreq and ptsreply */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">pts_reply</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">pts_reply</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">pts_reply</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">pts_reply</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="p">{</span>
		<span class="cm">/* setcardparameter according to PPS */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">baudv</span> <span class="o">=</span> <span class="n">calc_baudv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">set_cardparameter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">pts_reply</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
		   <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xef</span><span class="p">)</span> <span class="o">==</span> <span class="n">pts_reply</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
		   <span class="p">((</span><span class="n">pts_reply</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">pts_reply</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">pts_reply</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="p">{</span>
		<span class="cm">/* short PTS reply, set card parameter to default values */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">baudv</span> <span class="o">=</span> <span class="n">calc_baudv</span><span class="p">(</span><span class="mh">0x11</span><span class="p">);</span>
		<span class="n">set_cardparameter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="nl">exit_setprotocol:</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;- set_protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">io_detect_cm4000</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iobase</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* note: statemachine is assumed to be reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">IS_ATR_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IS_CMM_ABSENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* detect CMM = 1 -&gt; failure */</span>
	<span class="p">}</span>
	<span class="cm">/* xoutb(0x40, REG_FLAGS1(iobase)); detectCMM */</span>
	<span class="n">xoutb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">REG_FLAGS1</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">IS_ATR_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IS_CMM_ABSENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* detect CMM=0 -&gt; failure */</span>
	<span class="p">}</span>
	<span class="cm">/* clear detectCMM again by restoring original flags1 */</span>
	<span class="n">xoutb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span><span class="p">,</span> <span class="n">REG_FLAGS1</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">terminate_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* tell the monitor to stop and wait until</span>
<span class="cm">	 * it terminates.</span>
<span class="cm">	 */</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;-&gt; terminate_monitor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devq</span><span class="p">,</span>
				 <span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">LOCK_MONITOR</span><span class="p">,</span>
						  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>

	<span class="cm">/* now, LOCK_MONITOR has been set.</span>
<span class="cm">	 * allow a last cycle in the monitor.</span>
<span class="cm">	 * the monitor will indicate that it has</span>
<span class="cm">	 * finished by clearing this bit.</span>
<span class="cm">	 */</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Now allow last cycle of monitor!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LOCK_MONITOR</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Delete timer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="cp">#ifdef CM4000_DEBUG</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">monitor_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;- terminate_monitor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * monitor the card every 50msec. as a side-effect, retrieve the</span>
<span class="cm"> * atr once a card is inserted. another side-effect of retrieving the</span>
<span class="cm"> * atr is that the card will be powered on, so there is no need to</span>
<span class="cm"> * power on the card explictely from the application: the driver</span>
<span class="cm"> * is already doing that for you.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">monitor_card</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ptsreq</span> <span class="n">ptsreq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">atrc</span><span class="p">;</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;-&gt;  monitor_card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* if someone has set the lock for us: we&#39;re done! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">LOCK_MONITOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;About to stop monitor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* no */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rlen</span> <span class="o">=</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rpos</span> <span class="o">=</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_csum</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_len_retry</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cwarn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">M_FETCH_ATR</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">LOCK_MONITOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* close et al. are sleeping on devq, so wake it */</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devq</span><span class="p">);</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;- monitor_card (we are done now)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* try to lock io: if it is already locked, just add another timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">LOCK_IO</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t get IO lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">return_with_timer</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* is a card/a reader inserted at all ? */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">=</span> <span class="n">xinb</span><span class="p">(</span><span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dev-&gt;flags0 = 0x%2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span><span class="p">);</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;smartcard present: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cardman present: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">?</span> <span class="s">&quot;no&quot;</span> <span class="o">:</span> <span class="s">&quot;yes&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>	<span class="cm">/* no smartcard inserted */</span>
	    <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* no cardman inserted */</span>
		<span class="cm">/* no */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rlen</span> <span class="o">=</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rpos</span> <span class="o">=</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_csum</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_len_retry</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cwarn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">M_FETCH_ATR</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="mh">0x000000ff</span><span class="p">;</span> <span class="cm">/* only keep IO and MONITOR locks */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set IS_CMM_ABSENT bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">IS_CMM_ABSENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_CMM_ABSENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;clear IS_CMM_ABSENT bit &quot;</span>
			       <span class="s">&quot;(card is removed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">IS_CMM_ABSENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">release_io</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">IS_CMM_ABSENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* cardman and card present but cardman was absent before</span>
<span class="cm">		 * (after suspend with inserted card) */</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;clear IS_CMM_ABSENT bit (card is inserted)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">IS_CMM_ABSENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_ATR_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;believe ATR is already valid (do nothing)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">release_io</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mstate</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flags0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">M_CARDOFF</span>:
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;M_CARDOFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">flags0</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags0</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* wait until Flags0 indicate power is off */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdelay</span> <span class="o">=</span> <span class="n">T_10MSEC</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Flags0 indicate power off and no card inserted now;</span>
<span class="cm">			 * Reset CARDMAN CONTROLLER */</span>
			<span class="n">xoutb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>

			<span class="cm">/* prepare for fetching ATR again: after card off ATR</span>
<span class="cm">			 * is read again automatically */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rlen</span> <span class="o">=</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rpos</span> <span class="o">=</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_csum</span> <span class="o">=</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_len_retry</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cwarn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">M_FETCH_ATR</span><span class="p">;</span>

			<span class="cm">/* minimal gap between CARDOFF and read ATR is 50msec */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdelay</span> <span class="o">=</span> <span class="n">T_50MSEC</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">M_FETCH_ATR</span>:
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;M_FETCH_ATR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">xoutb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Reset BAUDV to 9600</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">baudv</span> <span class="o">=</span> <span class="mh">0x173</span><span class="p">;</span>	<span class="cm">/* 9600 */</span>
		<span class="n">xoutb</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">REG_STOPBITS</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>	<span class="cm">/* stopbits=2 */</span>
		<span class="n">xoutb</span><span class="p">(</span><span class="mh">0x73</span><span class="p">,</span> <span class="n">REG_BAUDRATE</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>	<span class="cm">/* baud value */</span>
		<span class="n">xoutb</span><span class="p">(</span><span class="mh">0x21</span><span class="p">,</span> <span class="n">REG_FLAGS1</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>	<span class="cm">/* T_Active=1, baud</span>
<span class="cm">							   value */</span>
		<span class="cm">/* warm start vs. power on: */</span>
		<span class="n">xoutb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">&amp;</span> <span class="mi">2</span> <span class="o">?</span> <span class="mh">0x46</span> <span class="o">:</span> <span class="mh">0x44</span><span class="p">,</span> <span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdelay</span> <span class="o">=</span> <span class="n">T_40MSEC</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">M_TIMEOUT_WAIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">M_TIMEOUT_WAIT</span>:
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;M_TIMEOUT_WAIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* numRecBytes */</span>
		<span class="n">io_read_num_rec_bytes</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_len</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdelay</span> <span class="o">=</span> <span class="n">T_10MSEC</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">M_READ_ATR_LEN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">M_READ_ATR_LEN</span>:
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;M_READ_ATR_LEN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* infinite loop possible, since there is no timeout */</span>

<span class="cp">#define	MAX_ATR_LEN_RETRY	100</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_len</span> <span class="o">==</span> <span class="n">io_read_num_rec_bytes</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_len_retry</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="n">MAX_ATR_LEN_RETRY</span><span class="p">)</span> <span class="p">{</span>					<span class="cm">/* + XX msec */</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdelay</span> <span class="o">=</span> <span class="n">T_10MSEC</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">M_READ_ATR</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_len</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_len_retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* set new timeout */</span>
		<span class="p">}</span>

		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Current ATR_LEN = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">M_READ_ATR</span>:
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;M_READ_ATR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">xoutb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>	<span class="cm">/* reset SM */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xoutb</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">REG_BUF_ADDR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">REG_BUF_DATA</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="cm">/* Deactivate T_Active flags */</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Deactivate T_Active flags</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">xoutb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span><span class="p">,</span> <span class="n">REG_FLAGS1</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>

		<span class="cm">/* atr is present (which doesn&#39;t mean it&#39;s valid) */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IS_ATR_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span>
			<span class="n">str_invert_revert</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_len</span><span class="p">);</span>
		<span class="n">atrc</span> <span class="o">=</span> <span class="n">parse_atr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atrc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* atr invalid */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdelay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">M_BAD_CARD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdelay</span> <span class="o">=</span> <span class="n">T_50MSEC</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">M_ATR_PRESENT</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">IS_ATR_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_ATR_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;monitor_card: ATR valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
 			<span class="cm">/* if ta1 == 0x11, no PPS necessary (default values) */</span>
			<span class="cm">/* do not do PPS with multi protocol cards */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_AUTOPPS_ACT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ta1</span> <span class="o">!=</span> <span class="mh">0x11</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_ANY_T0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">IS_ANY_T1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Perform AUTOPPS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">IS_AUTOPPS_ACT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">ptsreq</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">);</span>
				<span class="n">ptsreq</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
				<span class="n">ptsreq</span><span class="p">.</span><span class="n">pts1</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">ptsreq</span><span class="p">.</span><span class="n">pts2</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">ptsreq</span><span class="p">.</span><span class="n">pts3</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">set_protocol</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptsreq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;AUTOPPS ret SUCC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">clear_bit</span><span class="p">(</span><span class="n">IS_AUTOPPS_ACT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
					<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atrq</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;AUTOPPS failed: &quot;</span>
					       <span class="s">&quot;repower using defaults</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="cm">/* prepare for repowering  */</span>
					<span class="n">clear_bit</span><span class="p">(</span><span class="n">IS_ATR_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
					<span class="n">clear_bit</span><span class="p">(</span><span class="n">IS_ATR_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rlen</span> <span class="o">=</span>
					    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rpos</span> <span class="o">=</span>
					    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_csum</span> <span class="o">=</span>
					    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_len_retry</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cwarn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">M_FETCH_ATR</span><span class="p">;</span>

					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdelay</span> <span class="o">=</span> <span class="n">T_50MSEC</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* for cards which use slightly different</span>
<span class="cm">				 * params (extra guard time) */</span>
				<span class="n">set_cardparameter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_AUTOPPS_ACT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;AUTOPPS already active &quot;</span>
					       <span class="s">&quot;2nd try:use default values</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ta1</span> <span class="o">==</span> <span class="mh">0x11</span><span class="p">)</span>
					<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No AUTOPPS necessary &quot;</span>
					       <span class="s">&quot;TA(1)==0x11</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_ANY_T0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">IS_ANY_T1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
					<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Do NOT perform AUTOPPS &quot;</span>
					       <span class="s">&quot;with multiprotocol cards</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">IS_AUTOPPS_ACT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atrq</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ATR invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atrq</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">M_BAD_CARD</span>:
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;M_BAD_CARD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* slow down warning, but prompt immediately after insertion */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cwarn</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cwarn</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">IS_BAD_CARD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MODULE_NAME</span> <span class="s">&quot;: &quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_BAD_CSUM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ATR checksum (0x%.2x, should &quot;</span>
				       <span class="s">&quot;be zero) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_csum</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#ifdef CM4000_DEBUG</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_BAD_LENGTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ATR length error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;card damaged or wrong way &quot;</span>
					<span class="s">&quot;inserted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cwarn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atrq</span><span class="p">);</span>	<span class="cm">/* wake open */</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cwarn</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdelay</span> <span class="o">=</span> <span class="n">T_100MSEC</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">M_FETCH_ATR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown action</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>		<span class="cm">/* nothing */</span>
	<span class="p">}</span>

<span class="nl">release_io:</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;release_io</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">LOCK_IO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ioq</span><span class="p">);</span>	<span class="cm">/* whoever needs IO */</span>

<span class="nl">return_with_timer:</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;- monitor_card (returns with timer)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdelay</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">LOCK_MONITOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Interface to userland (file_operations) */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">cmm_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="n">__user</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
			<span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;-&gt; cmm_read(%s,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>		<span class="cm">/* according to manpage */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">p_dev</span><span class="p">)</span> <span class="o">||</span> <span class="cm">/* device removed */</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">IS_CMM_ABSENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_BAD_CSUM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* also see the note about this in cmm_write */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atrq</span><span class="p">,</span>
	     <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
	      <span class="o">||</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_ATR_PRESENT</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_ATR_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* this one implements blocking IO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">readq</span><span class="p">,</span>
	     <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rpos</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rlen</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* lock io */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ioq</span><span class="p">,</span>
	     <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
	      <span class="o">||</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">LOCK_IO</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>	<span class="cm">/* no smartcard inserted */</span>
	    <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* no cardman inserted */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">IS_ATR_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">IS_CMM_ABSENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">release_io</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;begin read answer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">j</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rlen</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rpos</span><span class="p">));</span>
	<span class="n">k</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rpos</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">-</span> <span class="n">k</span><span class="p">;</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;read1 j=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xoutb</span><span class="p">(</span><span class="n">k</span><span class="o">++</span><span class="p">,</span> <span class="n">REG_BUF_ADDR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xinb</span><span class="p">(</span><span class="n">REG_BUF_DATA</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">j</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rlen</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rpos</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;read2 j=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* MSB buf addr set */</span>
		<span class="n">xoutb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span><span class="p">,</span> <span class="n">REG_FLAGS1</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xoutb</span><span class="p">(</span><span class="n">k</span><span class="o">++</span><span class="p">,</span> <span class="n">REG_BUF_ADDR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xinb</span><span class="p">(</span><span class="n">REG_BUF_DATA</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rlen</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rpos</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;T=0 and count &gt; buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">procbyte</span><span class="p">;</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rpos</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rlen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Clear T1Active */</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Clear T1Active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;=</span> <span class="mh">0xdf</span><span class="p">;</span>
	<span class="n">xoutb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span><span class="p">,</span> <span class="n">REG_FLAGS1</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>

	<span class="n">xoutb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">REG_FLAGS1</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>	<span class="cm">/* clear detectCMM */</span>
	<span class="cm">/* last check before exit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_detect_cm4000</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release_io</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_INVREV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">str_invert_revert</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="nl">release_io:</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">LOCK_IO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ioq</span><span class="p">);</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;- cmm_read returns: rc = %Zi</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">rc</span> <span class="o">:</span> <span class="n">count</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">rc</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">cmm_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">infolen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sendT0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">nsend</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">nr</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;-&gt; cmm_write(%s,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>		<span class="cm">/* according to manpage */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* T0 must have at least 4 bytes */</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;T0 short write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nr</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">;</span>	<span class="cm">/* max bytes to write */</span>

	<span class="n">sendT0</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">nr</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">?</span> <span class="mh">0x08</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">p_dev</span><span class="p">)</span> <span class="o">||</span> <span class="cm">/* device removed */</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">IS_CMM_ABSENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_BAD_CSUM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad csum</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * wait for atr to become valid.</span>
<span class="cm">	 * note: it is important to lock this code. if we dont, the monitor</span>
<span class="cm">	 * could be run between test_bit and the call to sleep on the</span>
<span class="cm">	 * atr-queue.  if *then* the monitor detects atr valid, it will wake up</span>
<span class="cm">	 * any process on the atr-queue, *but* since we have been interrupted,</span>
<span class="cm">	 * we do not yet sleep on this queue. this would result in a missed</span>
<span class="cm">	 * wake_up and the calling process would sleep forever (until</span>
<span class="cm">	 * interrupted).  also, do *not* restore_flags before sleep_on, because</span>
<span class="cm">	 * this could result in the same situation!</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atrq</span><span class="p">,</span>
	     <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
	      <span class="o">||</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_ATR_PRESENT</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_ATR_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* invalid atr */</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid ATR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* lock io */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ioq</span><span class="p">,</span>
	     <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
	      <span class="o">||</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">LOCK_IO</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">512</span><span class="p">)</span> <span class="o">?</span> <span class="mi">512</span> <span class="o">:</span> <span class="n">count</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>	<span class="cm">/* no smartcard inserted */</span>
	    <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* no cardman inserted */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">IS_ATR_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">IS_CMM_ABSENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IO error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">release_io</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xoutb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>	<span class="cm">/* reset SM  */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_detect_cm4000</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release_io</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reflect T=0 send/read mode in flags1 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">sendT0</span><span class="p">);</span>

	<span class="n">set_cardparameter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* dummy read, reset flag procedure received */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">REG_FLAGS1</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">=</span> <span class="mh">0x20</span>	<span class="cm">/* T_Active */</span>
	    <span class="o">|</span> <span class="p">(</span><span class="n">sendT0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_INVREV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span><span class="cm">/* inverse parity  */</span>
	    <span class="o">|</span> <span class="p">(((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">baudv</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>	<span class="cm">/* MSB-Baud */</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set dev-&gt;flags1 = 0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span><span class="p">);</span>
	<span class="n">xoutb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span><span class="p">,</span> <span class="n">REG_FLAGS1</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>

	<span class="cm">/* xmit data */</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Xmit data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">=</span> <span class="mh">0x20</span>	<span class="cm">/* T_Active */</span>
			    <span class="o">|</span> <span class="p">(</span><span class="n">sendT0</span><span class="p">)</span>	<span class="cm">/* SendT0 */</span>
				<span class="cm">/* inverse parity: */</span>
			    <span class="o">|</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_INVREV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
			    <span class="o">|</span> <span class="p">(((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">baudv</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="cm">/* MSB-Baud */</span>
			    <span class="o">|</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* set address high */</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dev-&gt;flags = 0x%.2x - set address &quot;</span>
			       <span class="s">&quot;high</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span><span class="p">);</span>
			<span class="n">xoutb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span><span class="p">,</span> <span class="n">REG_FLAGS1</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_INVREV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Apply inverse convention for 0x%.2x &quot;</span>
				<span class="s">&quot;-&gt; 0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			      <span class="n">invert_revert</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
			<span class="n">xoutb</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">REG_BUF_ADDR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
			<span class="n">xoutb</span><span class="p">(</span><span class="n">invert_revert</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
			      <span class="n">REG_BUF_DATA</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">xoutb</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">REG_BUF_ADDR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
			<span class="n">xoutb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">REG_BUF_DATA</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Xmit done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* T=0 proto: 0 byte reply  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;T=0 assumes 0 byte reply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">xoutb</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">REG_BUF_ADDR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_INVREV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">xoutb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">REG_BUF_DATA</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="n">xoutb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">REG_BUF_DATA</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* numSendBytes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sendT0</span><span class="p">)</span>
			<span class="n">nsend</span> <span class="o">=</span> <span class="n">nr</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">nsend</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">nsend</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">nsend</span> <span class="o">+=</span> <span class="mh">0x100</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">nsend</span> <span class="o">=</span> <span class="n">nr</span><span class="p">;</span>

	<span class="cm">/* T0: output procedure byte */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_INVREV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;T=0 set Procedure byte (inverse-reverse) &quot;</span>
		       <span class="s">&quot;0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">invert_revert</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
		<span class="n">xoutb</span><span class="p">(</span><span class="n">invert_revert</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">REG_NUM_BYTES</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;T=0 set Procedure byte 0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">xoutb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">REG_NUM_BYTES</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set NumSendBytes = 0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">nsend</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">xoutb</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">nsend</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">REG_NUM_SEND</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Trigger CARDMAN CONTROLLER (0x%.2x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="mh">0x40</span>	<span class="cm">/* SM_Active */</span>
	      <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">&amp;</span> <span class="mi">2</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">4</span><span class="p">)</span>	<span class="cm">/* power on if needed */</span>
	      <span class="o">|</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mh">0x08</span><span class="p">)</span>	<span class="cm">/* T=1/T=0 */</span>
	      <span class="o">|</span><span class="p">(</span><span class="n">nsend</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="cm">/* MSB numSendBytes */</span> <span class="p">);</span>
	<span class="n">xoutb</span><span class="p">(</span><span class="mh">0x40</span>		<span class="cm">/* SM_Active */</span>
	      <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">&amp;</span> <span class="mi">2</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">4</span><span class="p">)</span>	<span class="cm">/* power on if needed */</span>
	      <span class="o">|</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mh">0x08</span><span class="p">)</span>	<span class="cm">/* T=1/T=0 */</span>
	      <span class="o">|</span><span class="p">(</span><span class="n">nsend</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>	<span class="cm">/* MSB numSendBytes */</span>
	      <span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>

	<span class="cm">/* wait for xmit done */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Wait for xmit done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout waiting for xmit done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">release_io</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* T=1: wait for infoLen */</span>

	<span class="n">infolen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wait until infoLen is valid */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* max waiting time of 1 min */</span>
			<span class="n">io_read_num_rec_bytes</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">infolen</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">REG_FLAGS1</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
				<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;infolen=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">infolen</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">6000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout waiting for infoLen</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">release_io</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">IS_PROCBYTE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* numRecBytes | bit9 of numRecytes */</span>
	<span class="n">io_read_num_rec_bytes</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rlen</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">600</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* max waiting time of 2 sec */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rlen</span> <span class="o">&gt;=</span> <span class="n">infolen</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="cm">/* numRecBytes | bit9 of numRecytes */</span>
		<span class="n">io_read_num_rec_bytes</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NumRecBytes inc (reset timeout)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* reset timeout */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rlen</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* T=0: we are done when numRecBytes doesn&#39;t</span>
<span class="cm">		 *      increment any more and NoProcedureByte</span>
<span class="cm">		 *      is set and numRecBytes == bytes sent + 6</span>
<span class="cm">		 *      (header bytes + data + 1 for sw2)</span>
<span class="cm">		 *      except when the card replies an error</span>
<span class="cm">		 *      which means, no data will be sent back.</span>
<span class="cm">		 */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">REG_BUF_ADDR</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* no procedure byte received since last read */</span>
				<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NoProcedure byte set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="cm">/* i=0; */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* procedure byte received since last read */</span>
				<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NoProcedure byte unset &quot;</span>
					<span class="s">&quot;(reset timeout)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">procbyte</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">REG_FLAGS1</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
				<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Read procedure byte 0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">procbyte</span><span class="p">);</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* resettimeout */</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;T0Done flag (read reply)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">)</span>
			<span class="n">infolen</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">REG_FLAGS1</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">600</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout waiting for numRecBytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release_io</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Wait for T0Done bit to be  set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout waiting for T0Done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">release_io</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">procbyte</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">REG_FLAGS1</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Read procedure byte 0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">procbyte</span><span class="p">);</span>

			<span class="n">io_read_num_rec_bytes</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rlen</span><span class="p">);</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Read NumRecBytes = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rlen</span><span class="p">);</span>

		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* T=1: read offset=zero, T=0: read offset=after challenge */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rpos</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="n">nr</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rlen</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="n">nr</span><span class="p">;</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dev-&gt;rlen = %i,  dev-&gt;rpos = %i, nr = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rlen</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rpos</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>

<span class="nl">release_io:</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Reset SM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">xoutb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>	<span class="cm">/* reset SM */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Write failed but clear T_Active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;=</span> <span class="mh">0xdf</span><span class="p">;</span>
		<span class="n">xoutb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags1</span><span class="p">,</span> <span class="n">REG_FLAGS1</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">LOCK_IO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ioq</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">readq</span><span class="p">);</span>	<span class="cm">/* tell read we have data */</span>

	<span class="cm">/* ITSEC E2: clear write buffer */</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>

	<span class="cm">/* return error or actually written bytes */</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;- cmm_write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">rc</span> <span class="o">:</span> <span class="n">nr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">start_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;-&gt; start_monitor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">monitor_running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;create, init and add timer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">monitor_card</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">monitor_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;monitor already running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;- start_monitor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">stop_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;-&gt; stop_monitor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">monitor_running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;stopping monitor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">terminate_monitor</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* reset monitor SM */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">IS_ATR_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">IS_ATR_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;monitor already stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;- stop_monitor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="n">cmm_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
<span class="cp">#ifdef CM4000_DEBUG</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ioctl_names</span><span class="p">[</span><span class="n">CM_IOC_MAXNR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">CM_IOCGSTATUS</span><span class="p">)]</span> <span class="s">&quot;CM_IOCGSTATUS&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">CM_IOCGATR</span><span class="p">)]</span> <span class="s">&quot;CM_IOCGATR&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">CM_IOCARDOFF</span><span class="p">)]</span> <span class="s">&quot;CM_IOCARDOFF&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">CM_IOCSPTS</span><span class="p">)]</span> <span class="s">&quot;CM_IOCSPTS&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">CM_IOSDBGLVL</span><span class="p">)]</span> <span class="s">&quot;CM4000_DBGLVL&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmm_ioctl(device=%d.%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">imajor</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span>
	       <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">ioctl_names</span><span class="p">[</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)]);</span>
<span class="cp">#endif</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_mutex</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">link</span> <span class="o">=</span> <span class="n">dev_table</span><span class="p">[</span><span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">)];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DEV_OK false</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_CMM_ABSENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CMM_ABSENT flag set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CM_IOC_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ioctype mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">CM_IOC_MAXNR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;iocnr mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;iocdir=%.4x iocr=%.4x iocw=%.4x iocsize=%d cmd=%.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">_IOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">_IOC_READ</span><span class="p">,</span> <span class="n">_IOC_WRITE</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_IOC_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_IOC_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CM_IOCGSTATUS</span>:
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot; ... in CM_IOCGSTATUS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

			<span class="cm">/* clear other bits, but leave inserted &amp; powered as</span>
<span class="cm">			 * they are */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_ATR_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">CM_ATR_PRESENT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_ATR_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">CM_ATR_VALID</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_CMM_ABSENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">CM_NO_READER</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_BAD_CARD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">CM_BAD_CARD</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CM_IOCGATR</span>:
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;... in CM_IOCGATR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">atreq</span> <span class="n">__user</span> <span class="o">*</span><span class="n">atreq</span> <span class="o">=</span> <span class="n">argp</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="cm">/* allow nonblocking io and being interrupted */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span>
			    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atrq</span><span class="p">,</span>
			     <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
			      <span class="o">||</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_ATR_PRESENT</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
				  <span class="o">!=</span> <span class="mi">0</span><span class="p">))))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_ATR_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">atreq</span><span class="o">-&gt;</span><span class="n">atr_len</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span>
						 <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">atreq</span><span class="o">-&gt;</span><span class="n">atr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr</span><span class="p">,</span>
						 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_len</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="n">tmp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atr_len</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">atreq</span><span class="o">-&gt;</span><span class="n">atr_len</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">CM_IOCARDOFF</span>:

<span class="cp">#ifdef CM4000_DEBUG</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;... in CM_IOCARDOFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;    Card inserted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;    No card inserted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;    Card powered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;    Card not powered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="cm">/* is a card inserted and powered? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags0</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>

			<span class="cm">/* get IO lock */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span>
			    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ioq</span><span class="p">,</span>
			     <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
			      <span class="o">||</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">LOCK_IO</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
				  <span class="o">==</span> <span class="mi">0</span><span class="p">))))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Set Flags0 = 0x42 */</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Set Flags0=0x42 </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">xoutb</span><span class="p">(</span><span class="mh">0x42</span><span class="p">,</span> <span class="n">REG_FLAGS0</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">IS_ATR_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">IS_ATR_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">M_CARDOFF</span><span class="p">;</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">LOCK_IO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span>
			    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atrq</span><span class="p">,</span>
			     <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
			      <span class="o">||</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_ATR_VALID</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span>
				  <span class="mi">0</span><span class="p">))))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* release lock */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">LOCK_IO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ioq</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CM_IOCSPTS</span>:
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">ptsreq</span> <span class="n">krnptsreq</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">krnptsreq</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ptsreq</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;... in CM_IOCSPTS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* wait for ATR to get valid */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span>
			    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atrq</span><span class="p">,</span>
			     <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
			      <span class="o">||</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IS_ATR_PRESENT</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
				  <span class="o">!=</span> <span class="mi">0</span><span class="p">))))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* get IO lock */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible</span>
			    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ioq</span><span class="p">,</span>
			     <span class="p">((</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
			      <span class="o">||</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">LOCK_IO</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
				  <span class="o">==</span> <span class="mi">0</span><span class="p">))))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">set_protocol</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">krnptsreq</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* auto power_on again */</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">M_FETCH_ATR</span><span class="p">;</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">IS_ATR_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* release lock */</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">LOCK_IO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ioq</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CM4000_DEBUG</span>
	<span class="k">case</span> <span class="n">CM_IOSDBGLVL</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;... in default (unknown IOCTL code)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cmm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minor</span> <span class="o">&gt;=</span> <span class="n">CM4000_MAX_DEV</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_mutex</span><span class="p">);</span>
	<span class="n">link</span> <span class="o">=</span> <span class="n">dev_table</span><span class="p">[</span><span class="n">minor</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;-&gt; cmm_open(device=%d.%d process=%s,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">imajor</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">minor</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="cm">/* init device variables, they may be &quot;polluted&quot; after close</span>
<span class="cm">	 * or, the device may never have been closed (i.e. open failed)</span>
<span class="cm">	 */</span>

	<span class="n">ZERO_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* opening will always block since the</span>
<span class="cm">	 * monitor will be started by open, which</span>
<span class="cm">	 * means we have to wait for ATR becoming</span>
<span class="cm">	 * valid = block until valid (or card</span>
<span class="cm">	 * inserted)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdelay</span> <span class="o">=</span> <span class="n">T_50MSEC</span><span class="p">;</span>

	<span class="cm">/* start monitoring the cardstatus */</span>
	<span class="n">start_monitor</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* only one open per device */</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;- cmm_open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cmm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minor</span> <span class="o">&gt;=</span> <span class="n">CM4000_MAX_DEV</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">link</span> <span class="o">=</span> <span class="n">dev_table</span><span class="p">[</span><span class="n">minor</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;-&gt; cmm_close(maj/min=%d.%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">imajor</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">minor</span><span class="p">);</span>

	<span class="n">stop_monitor</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ZERO_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* only one open per device */</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devq</span><span class="p">);</span>	<span class="cm">/* socket removed? */</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmm_close</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cmm_cm4000_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span> <span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* dont terminate the monitor, rather rely on</span>
<span class="cm">	 * close doing that for us.</span>
<span class="cm">	 */</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;-&gt; cmm_cm4000_release</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">MODULE_NAME</span> <span class="s">&quot;: delaying release until &quot;</span>
		       <span class="s">&quot;process has terminated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* note: don&#39;t interrupt us:</span>
<span class="cm">		 * close the applications which own</span>
<span class="cm">		 * the devices _first_ !</span>
<span class="cm">		 */</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devq</span><span class="p">,</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/* dev-&gt;devq=NULL;	this cannot be zeroed earlier */</span>
	<span class="n">DEBUGP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&lt;- cmm_cm4000_release</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*==== Interface to PCMCIA Layer =======================================*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cm4000_config_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pcmcia_request_io</span><span class="p">(</span><span class="n">p_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cm4000_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span> <span class="n">link</span><span class="p">,</span> <span class="kt">int</span> <span class="n">devno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">link</span><span class="o">-&gt;</span><span class="n">config_flags</span> <span class="o">|=</span> <span class="n">CONF_AUTO_SET_IO</span><span class="p">;</span>

	<span class="cm">/* read the config-tuples */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcmcia_loop_config</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">cm4000_config_check</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">cs_release</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcmcia_enable_device</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">cs_release</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">cs_release:</span>
	<span class="n">cm4000_release</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cm4000_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">stop_monitor</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cm4000_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span>
		<span class="n">start_monitor</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cm4000_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmm_cm4000_release</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>	<span class="cm">/* delay release until device closed */</span>
	<span class="n">pcmcia_disable_device</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cm4000_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CM4000_MAX_DEV</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">CM4000_MAX_DEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="n">MODULE_NAME</span> <span class="s">&quot;: all devices in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* create a new cm4000_cs device */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cm4000_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">p_dev</span> <span class="o">=</span> <span class="n">link</span><span class="p">;</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">link</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devq</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ioq</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atrq</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">readq</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cm4000_config</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device_create</span><span class="p">(</span><span class="n">cmm_class</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;cmm%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cm4000_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cm4000_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">devno</span><span class="p">;</span>

	<span class="cm">/* find device */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">devno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">devno</span> <span class="o">&lt;</span> <span class="n">CM4000_MAX_DEV</span><span class="p">;</span> <span class="n">devno</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_table</span><span class="p">[</span><span class="n">devno</span><span class="p">]</span> <span class="o">==</span> <span class="n">link</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devno</span> <span class="o">==</span> <span class="n">CM4000_MAX_DEV</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">stop_monitor</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cm4000_release</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>

	<span class="n">dev_table</span><span class="p">[</span><span class="n">devno</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">device_destroy</span><span class="p">(</span><span class="n">cmm_class</span><span class="p">,</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">devno</span><span class="p">));</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">cm4000_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>	<span class="o">=</span> <span class="n">cmm_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>	<span class="o">=</span> <span class="n">cmm_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">cmm_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>	<span class="o">=</span> <span class="n">cmm_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span><span class="o">=</span> <span class="n">cmm_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pcmcia_device_id</span> <span class="n">cm4000_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PCMCIA_DEVICE_MANF_CARD</span><span class="p">(</span><span class="mh">0x0223</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;CardMan&quot;</span><span class="p">,</span> <span class="s">&quot;4000&quot;</span><span class="p">,</span> <span class="mh">0x2FB368CA</span><span class="p">,</span> <span class="mh">0xA2BD8C39</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_NULL</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pcmcia</span><span class="p">,</span> <span class="n">cm4000_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="n">cm4000_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>	  <span class="o">=</span> <span class="s">&quot;cm4000_cs&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">cm4000_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">cm4000_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>  <span class="o">=</span> <span class="n">cm4000_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>   <span class="o">=</span> <span class="n">cm4000_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">cm4000_ids</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cmm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmm_class</span> <span class="o">=</span> <span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="s">&quot;cardman_4000&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cmm_class</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">cmm_class</span><span class="p">);</span>

	<span class="n">major</span> <span class="o">=</span> <span class="n">register_chrdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DEVICE_NAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm4000_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">major</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">MODULE_NAME</span>
			<span class="s">&quot;: could not get major number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">class_destroy</span><span class="p">(</span><span class="n">cmm_class</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">major</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pcmcia_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm4000_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">DEVICE_NAME</span><span class="p">);</span>
		<span class="n">class_destroy</span><span class="p">(</span><span class="n">cmm_class</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cmm_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pcmcia_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm4000_driver</span><span class="p">);</span>
	<span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">DEVICE_NAME</span><span class="p">);</span>
	<span class="n">class_destroy</span><span class="p">(</span><span class="n">cmm_class</span><span class="p">);</span>
<span class="p">};</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">cmm_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cmm_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
