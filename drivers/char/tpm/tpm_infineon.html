<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › char › tpm › tpm_infineon.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tpm_infineon.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Device Driver for the Infineon Technologies</span>
<span class="cm"> * SLD 9630 TT 1.1 and SLB 9635 TT 1.2 Trusted Platform Module</span>
<span class="cm"> * Specifications at www.trustedcomputinggroup.org</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005, Marcel Selhorst &lt;m.selhorst@sirrix.com&gt;</span>
<span class="cm"> * Sirrix AG - security technologies, http://www.sirrix.com and</span>
<span class="cm"> * Applied Data Security Group, Ruhr-University Bochum, Germany</span>
<span class="cm"> * Project-Homepage: http://www.trust.rub.de/projects/linux-device-driver-infineon-tpm/ </span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation, version 2 of the</span>
<span class="cm"> * License.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pnp.h&gt;</span>
<span class="cp">#include &quot;tpm.h&quot;</span>

<span class="cm">/* Infineon specific definitions */</span>
<span class="cm">/* maximum number of WTX-packages */</span>
<span class="cp">#define	TPM_MAX_WTX_PACKAGES 	50</span>
<span class="cm">/* msleep-Time for WTX-packages */</span>
<span class="cp">#define	TPM_WTX_MSLEEP_TIME 	20</span>
<span class="cm">/* msleep-Time --&gt; Interval to check status register */</span>
<span class="cp">#define	TPM_MSLEEP_TIME 	3</span>
<span class="cm">/* gives number of max. msleep()-calls before throwing timeout */</span>
<span class="cp">#define	TPM_MAX_TRIES		5000</span>
<span class="cp">#define	TPM_INFINEON_DEV_VEN_VALUE	0x15D1</span>

<span class="cp">#define TPM_INF_IO_PORT		0x0</span>
<span class="cp">#define TPM_INF_IO_MEM		0x1</span>

<span class="cp">#define TPM_INF_ADDR		0x0</span>
<span class="cp">#define TPM_INF_DATA		0x1</span>

<span class="k">struct</span> <span class="n">tpm_inf_dev</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">iotype</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem_base</span><span class="p">;</span>	<span class="cm">/* MMIO ioremap&#39;d addr */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">map_base</span><span class="p">;</span>	<span class="cm">/* phys MMIO base */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">map_size</span><span class="p">;</span>	<span class="cm">/* MMIO region size */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index_off</span><span class="p">;</span>	<span class="cm">/* index register offset */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_regs</span><span class="p">;</span>	<span class="cm">/* Data registers */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">config_port</span><span class="p">;</span>	<span class="cm">/* IO Port config index reg */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">config_size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tpm_inf_dev</span> <span class="n">tpm_dev</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tpm_data_out</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">iotype</span> <span class="o">==</span> <span class="n">TPM_INF_IO_PORT</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_regs</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_regs</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">tpm_data_in</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">iotype</span> <span class="o">==</span> <span class="n">TPM_INF_IO_PORT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_regs</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_regs</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tpm_config_out</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">iotype</span> <span class="o">==</span> <span class="n">TPM_INF_IO_PORT</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">config_port</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">index_off</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">tpm_config_in</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">iotype</span> <span class="o">==</span> <span class="n">TPM_INF_IO_PORT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">config_port</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">index_off</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* TPM header definitions */</span>
<span class="k">enum</span> <span class="n">infineon_tpm_header</span> <span class="p">{</span>
	<span class="n">TPM_VL_VER</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">TPM_VL_CHANNEL_CONTROL</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">,</span>
	<span class="n">TPM_VL_CHANNEL_PERSONALISATION</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">,</span>
	<span class="n">TPM_VL_CHANNEL_TPM</span> <span class="o">=</span> <span class="mh">0x0B</span><span class="p">,</span>
	<span class="n">TPM_VL_CONTROL</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">TPM_INF_NAK</span> <span class="o">=</span> <span class="mh">0x15</span><span class="p">,</span>
	<span class="n">TPM_CTRL_WTX</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">TPM_CTRL_WTX_ABORT</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>
	<span class="n">TPM_CTRL_WTX_ABORT_ACK</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>
	<span class="n">TPM_CTRL_ERROR</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">TPM_CTRL_CHAININGACK</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">TPM_CTRL_CHAINING</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">TPM_CTRL_DATA</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">TPM_CTRL_DATA_CHA</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">,</span>
	<span class="n">TPM_CTRL_DATA_CHA_ACK</span> <span class="o">=</span> <span class="mh">0xC4</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">infineon_tpm_register</span> <span class="p">{</span>
	<span class="n">WRFIFO</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">RDFIFO</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">STAT</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">CMD</span> <span class="o">=</span> <span class="mh">0x03</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">infineon_tpm_command_bits</span> <span class="p">{</span>
	<span class="n">CMD_DIS</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">CMD_LP</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">CMD_RES</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">CMD_IRQC</span> <span class="o">=</span> <span class="mh">0x06</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">infineon_tpm_status_bits</span> <span class="p">{</span>
	<span class="n">STAT_XFE</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">STAT_LPA</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">STAT_FOK</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">STAT_TOK</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="n">STAT_IRQA</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
	<span class="n">STAT_RDA</span> <span class="o">=</span> <span class="mh">0x07</span>
<span class="p">};</span>

<span class="cm">/* some outgoing values */</span>
<span class="k">enum</span> <span class="n">infineon_tpm_values</span> <span class="p">{</span>
	<span class="n">CHIP_ID1</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">CHIP_ID2</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">,</span>
	<span class="n">TPM_DAR</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="n">RESET_LP_IRQC_DISABLE</span> <span class="o">=</span> <span class="mh">0x41</span><span class="p">,</span>
	<span class="n">ENABLE_REGISTER_PAIR</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">,</span>
	<span class="n">IOLIMH</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span>
	<span class="n">IOLIML</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">,</span>
	<span class="n">DISABLE_REGISTER_PAIR</span> <span class="o">=</span> <span class="mh">0xAA</span><span class="p">,</span>
	<span class="n">IDVENL</span> <span class="o">=</span> <span class="mh">0xF1</span><span class="p">,</span>
	<span class="n">IDVENH</span> <span class="o">=</span> <span class="mh">0xF2</span><span class="p">,</span>
	<span class="n">IDPDL</span> <span class="o">=</span> <span class="mh">0xF3</span><span class="p">,</span>
	<span class="n">IDPDH</span> <span class="o">=</span> <span class="mh">0xF4</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">number_of_wtx</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">empty_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpm_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clear_wrfifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clear_wrfifo</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">tpm_data_in</span><span class="p">(</span><span class="n">WRFIFO</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">check</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">check</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Note: The values which are currently in the FIFO of the TPM</span>
<span class="cm">	   are thrown away since there is no usage for them. Usually,</span>
<span class="cm">	   this has nothing to say, since the TPM will give its answer</span>
<span class="cm">	   immediately or will be aborted anyway, so the data here is</span>
<span class="cm">	   usually garbage and useless.</span>
<span class="cm">	   We have to clean this, because the next communication with</span>
<span class="cm">	   the TPM would be rubbish, if there is still some old data</span>
<span class="cm">	   in the Read FIFO.</span>
<span class="cm">	 */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">tpm_data_in</span><span class="p">(</span><span class="n">RDFIFO</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">tpm_data_in</span><span class="p">(</span><span class="n">STAT</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">TPM_MAX_TRIES</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">STAT_RDA</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpm_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait_for_bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TPM_MAX_TRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">tpm_data_in</span><span class="p">(</span><span class="n">STAT</span><span class="p">);</span>
		<span class="cm">/* check the status-register if wait_for_bit is set */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">wait_for_bit</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">TPM_MSLEEP_TIME</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">TPM_MAX_TRIES</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* timeout occurs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_bit</span> <span class="o">==</span> <span class="n">STAT_XFE</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Timeout in wait(STAT_XFE)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_bit</span> <span class="o">==</span> <span class="n">STAT_RDA</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Timeout in wait(STAT_RDA)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_and_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpm_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sendbyte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wait</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STAT_XFE</span><span class="p">);</span>
	<span class="n">tpm_data_out</span><span class="p">(</span><span class="n">sendbyte</span><span class="p">,</span> <span class="n">WRFIFO</span><span class="p">);</span>
<span class="p">}</span>

    <span class="cm">/* Note: WTX means Waiting-Time-Extension. Whenever the TPM needs more</span>
<span class="cm">       calculation time, it sends a WTX-package, which has to be acknowledged</span>
<span class="cm">       or aborted. This usually occurs if you are hammering the TPM with key</span>
<span class="cm">       creation. Set the maximum number of WTX-packages in the definitions</span>
<span class="cm">       above, if the number is reached, the waiting-time will be denied</span>
<span class="cm">       and the TPM command has to be resend.</span>
<span class="cm">     */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpm_wtx</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpm_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">number_of_wtx</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Granting WTX (%02d / %02d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">number_of_wtx</span><span class="p">,</span> <span class="n">TPM_MAX_WTX_PACKAGES</span><span class="p">);</span>
	<span class="n">wait_and_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TPM_VL_VER</span><span class="p">);</span>
	<span class="n">wait_and_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TPM_CTRL_WTX</span><span class="p">);</span>
	<span class="n">wait_and_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">wait_and_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">TPM_WTX_MSLEEP_TIME</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpm_wtx_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpm_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Aborting WTX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">wait_and_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TPM_VL_VER</span><span class="p">);</span>
	<span class="n">wait_and_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TPM_CTRL_WTX_ABORT</span><span class="p">);</span>
	<span class="n">wait_and_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">wait_and_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">number_of_wtx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">TPM_WTX_MSLEEP_TIME</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpm_inf_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpm_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">number_of_wtx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">recv_begin:</span>
	<span class="cm">/* start receiving header */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STAT_RDA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpm_data_in</span><span class="p">(</span><span class="n">RDFIFO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TPM_VL_VER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Wrong transport protocol implementation!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">TPM_CTRL_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* size of the data received */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wait</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STAT_RDA</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpm_data_in</span><span class="p">(</span><span class="n">RDFIFO</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">==</span> <span class="mh">0x6D00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error handling on vendor layer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">6</span><span class="p">];</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">TPM_CTRL_WTX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;WTX-package received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">number_of_wtx</span> <span class="o">&lt;</span> <span class="n">TPM_MAX_WTX_PACKAGES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tpm_wtx</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">recv_begin</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tpm_wtx_abort</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">recv_begin</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">TPM_CTRL_WTX_ABORT_ACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;WTX-abort acknowledged</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">TPM_CTRL_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ERROR-package received:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">TPM_INF_NAK</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;-&gt; Negative acknowledgement&quot;</span>
				<span class="s">&quot; - retransmit command!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpm_inf_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpm_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">count_high</span><span class="p">,</span> <span class="n">count_low</span><span class="p">,</span> <span class="n">count_4</span><span class="p">,</span> <span class="n">count_3</span><span class="p">,</span> <span class="n">count_2</span><span class="p">,</span> <span class="n">count_1</span><span class="p">;</span>

	<span class="cm">/* Disabling Reset, LP and IRQC */</span>
	<span class="n">tpm_data_out</span><span class="p">(</span><span class="n">RESET_LP_IRQC_DISABLE</span><span class="p">,</span> <span class="n">CMD</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">empty_fifo</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Timeout while clearing FIFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STAT_XFE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">count_4</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">count_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">count_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">count_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">);</span>
	<span class="n">count_high</span> <span class="o">=</span> <span class="p">((</span><span class="n">count</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">count_low</span> <span class="o">=</span> <span class="p">((</span><span class="n">count</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">);</span>

	<span class="cm">/* Sending Header */</span>
	<span class="n">wait_and_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TPM_VL_VER</span><span class="p">);</span>
	<span class="n">wait_and_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TPM_CTRL_DATA</span><span class="p">);</span>
	<span class="n">wait_and_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">count_high</span><span class="p">);</span>
	<span class="n">wait_and_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">count_low</span><span class="p">);</span>

	<span class="cm">/* Sending Data Header */</span>
	<span class="n">wait_and_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TPM_VL_VER</span><span class="p">);</span>
	<span class="n">wait_and_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TPM_VL_CHANNEL_TPM</span><span class="p">);</span>
	<span class="n">wait_and_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">count_4</span><span class="p">);</span>
	<span class="n">wait_and_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">count_3</span><span class="p">);</span>
	<span class="n">wait_and_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">count_2</span><span class="p">);</span>
	<span class="n">wait_and_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">count_1</span><span class="p">);</span>

	<span class="cm">/* Sending Data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wait_and_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpm_inf_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpm_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	   Since we are using the legacy mode to communicate</span>
<span class="cm">	   with the TPM, we have no cancel functions, but have</span>
<span class="cm">	   a workaround for interrupting the TPM through WTX.</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">tpm_inf_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpm_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tpm_data_in</span><span class="p">(</span><span class="n">STAT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">pubek</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">tpm_show_pubek</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">pcrs</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">tpm_show_pcrs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">caps</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">tpm_show_caps</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">cancel</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IWGRP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">tpm_store_cancel</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">inf_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_pubek</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_pcrs</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_caps</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_cancel</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">inf_attr_grp</span> <span class="o">=</span> <span class="p">{.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">inf_attrs</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">inf_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">tpm_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">tpm_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">tpm_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">tpm_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tpm_vendor_specific</span> <span class="n">tpm_inf</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">recv</span> <span class="o">=</span> <span class="n">tpm_inf_recv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send</span> <span class="o">=</span> <span class="n">tpm_inf_send</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cancel</span> <span class="o">=</span> <span class="n">tpm_inf_cancel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">tpm_inf_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_complete_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_complete_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attr_group</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">inf_attr_grp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">miscdev</span> <span class="o">=</span> <span class="p">{.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">inf_ops</span><span class="p">,},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_device_id</span> <span class="n">tpm_inf_pnp_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Infineon TPMs */</span>
	<span class="p">{</span><span class="s">&quot;IFX0101&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;IFX0102&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pnp</span><span class="p">,</span> <span class="n">tpm_inf_pnp_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tpm_inf_pnp_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_device_id</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">iol</span><span class="p">,</span> <span class="n">ioh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vendorid</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">version</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">productid</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">chipname</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">tpm_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>

	<span class="cm">/* read IO-ports through PnP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnp_port_valid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pnp_port_valid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">pnp_port_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_DISABLED</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">tpm_dev</span><span class="p">.</span><span class="n">iotype</span> <span class="o">=</span> <span class="n">TPM_INF_IO_PORT</span><span class="p">;</span>

		<span class="n">tpm_dev</span><span class="p">.</span><span class="n">config_port</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tpm_dev</span><span class="p">.</span><span class="n">config_size</span> <span class="o">=</span> <span class="n">pnp_port_len</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_regs</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">pnp_port_len</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">config_size</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_last</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Found %s with ID %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev_id</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_regs</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_last</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* publish my base address and request region */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_region</span><span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_regs</span><span class="p">,</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_size</span><span class="p">,</span>
				   <span class="s">&quot;tpm_infineon0&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_last</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_region</span><span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">config_port</span><span class="p">,</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">config_size</span><span class="p">,</span>
				   <span class="s">&quot;tpm_infineon0&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_regs</span><span class="p">,</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_size</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_last</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pnp_mem_valid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="p">(</span><span class="n">pnp_mem_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_DISABLED</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">tpm_dev</span><span class="p">.</span><span class="n">iotype</span> <span class="o">=</span> <span class="n">TPM_INF_IO_MEM</span><span class="p">;</span>

		<span class="n">tpm_dev</span><span class="p">.</span><span class="n">map_base</span> <span class="o">=</span> <span class="n">pnp_mem_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tpm_dev</span><span class="p">.</span><span class="n">map_size</span> <span class="o">=</span> <span class="n">pnp_mem_len</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Found %s with ID %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev_id</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

		<span class="cm">/* publish my base address and request region */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">map_base</span><span class="p">,</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">map_size</span><span class="p">,</span>
				       <span class="s">&quot;tpm_infineon0&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_last</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tpm_dev</span><span class="p">.</span><span class="n">mem_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">map_base</span><span class="p">,</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">map_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">mem_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">release_mem_region</span><span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">map_base</span><span class="p">,</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">map_size</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_last</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * The only known MMIO based Infineon TPM system provides</span>
<span class="cm">		 * a single large mem region with the device config</span>
<span class="cm">		 * registers at the default TPM_ADDR.  The data registers</span>
<span class="cm">		 * seem like they could be placed anywhere within the MMIO</span>
<span class="cm">		 * region, but lets just put them at zero offset.</span>
<span class="cm">		 */</span>
		<span class="n">tpm_dev</span><span class="p">.</span><span class="n">index_off</span> <span class="o">=</span> <span class="n">TPM_ADDR</span><span class="p">;</span>
		<span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_regs</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_last</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* query chip for its vendor, its version number a.s.o. */</span>
	<span class="n">tpm_config_out</span><span class="p">(</span><span class="n">ENABLE_REGISTER_PAIR</span><span class="p">,</span> <span class="n">TPM_INF_ADDR</span><span class="p">);</span>
	<span class="n">tpm_config_out</span><span class="p">(</span><span class="n">IDVENL</span><span class="p">,</span> <span class="n">TPM_INF_ADDR</span><span class="p">);</span>
	<span class="n">vendorid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpm_config_in</span><span class="p">(</span><span class="n">TPM_INF_DATA</span><span class="p">);</span>
	<span class="n">tpm_config_out</span><span class="p">(</span><span class="n">IDVENH</span><span class="p">,</span> <span class="n">TPM_INF_ADDR</span><span class="p">);</span>
	<span class="n">vendorid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpm_config_in</span><span class="p">(</span><span class="n">TPM_INF_DATA</span><span class="p">);</span>
	<span class="n">tpm_config_out</span><span class="p">(</span><span class="n">IDPDL</span><span class="p">,</span> <span class="n">TPM_INF_ADDR</span><span class="p">);</span>
	<span class="n">productid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpm_config_in</span><span class="p">(</span><span class="n">TPM_INF_DATA</span><span class="p">);</span>
	<span class="n">tpm_config_out</span><span class="p">(</span><span class="n">IDPDH</span><span class="p">,</span> <span class="n">TPM_INF_ADDR</span><span class="p">);</span>
	<span class="n">productid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpm_config_in</span><span class="p">(</span><span class="n">TPM_INF_DATA</span><span class="p">);</span>
	<span class="n">tpm_config_out</span><span class="p">(</span><span class="n">CHIP_ID1</span><span class="p">,</span> <span class="n">TPM_INF_ADDR</span><span class="p">);</span>
	<span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpm_config_in</span><span class="p">(</span><span class="n">TPM_INF_DATA</span><span class="p">);</span>
	<span class="n">tpm_config_out</span><span class="p">(</span><span class="n">CHIP_ID2</span><span class="p">,</span> <span class="n">TPM_INF_ADDR</span><span class="p">);</span>
	<span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpm_config_in</span><span class="p">(</span><span class="n">TPM_INF_DATA</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">productid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">productid</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">chipname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chipname</span><span class="p">),</span> <span class="s">&quot; (SLD 9630 TT 1.1)&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">chipname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chipname</span><span class="p">),</span> <span class="s">&quot; (SLB 9635 TT 1.2)&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">chipname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chipname</span><span class="p">),</span> <span class="s">&quot; (unknown chip)&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vendorid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">vendorid</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="p">(</span><span class="n">TPM_INFINEON_DEV_VEN_VALUE</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* configure TPM with IO-ports */</span>
		<span class="n">tpm_config_out</span><span class="p">(</span><span class="n">IOLIMH</span><span class="p">,</span> <span class="n">TPM_INF_ADDR</span><span class="p">);</span>
		<span class="n">tpm_config_out</span><span class="p">((</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_regs</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TPM_INF_DATA</span><span class="p">);</span>
		<span class="n">tpm_config_out</span><span class="p">(</span><span class="n">IOLIML</span><span class="p">,</span> <span class="n">TPM_INF_ADDR</span><span class="p">);</span>
		<span class="n">tpm_config_out</span><span class="p">((</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_regs</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">TPM_INF_DATA</span><span class="p">);</span>

		<span class="cm">/* control if IO-ports are set correctly */</span>
		<span class="n">tpm_config_out</span><span class="p">(</span><span class="n">IOLIMH</span><span class="p">,</span> <span class="n">TPM_INF_ADDR</span><span class="p">);</span>
		<span class="n">ioh</span> <span class="o">=</span> <span class="n">tpm_config_in</span><span class="p">(</span><span class="n">TPM_INF_DATA</span><span class="p">);</span>
		<span class="n">tpm_config_out</span><span class="p">(</span><span class="n">IOLIML</span><span class="p">,</span> <span class="n">TPM_INF_ADDR</span><span class="p">);</span>
		<span class="n">iol</span> <span class="o">=</span> <span class="n">tpm_config_in</span><span class="p">(</span><span class="n">TPM_INF_DATA</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ioh</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">iol</span><span class="p">)</span> <span class="o">!=</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_regs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Could not set IO-data registers to 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_regs</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_release_region</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* activate register */</span>
		<span class="n">tpm_config_out</span><span class="p">(</span><span class="n">TPM_DAR</span><span class="p">,</span> <span class="n">TPM_INF_ADDR</span><span class="p">);</span>
		<span class="n">tpm_config_out</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">TPM_INF_DATA</span><span class="p">);</span>
		<span class="n">tpm_config_out</span><span class="p">(</span><span class="n">DISABLE_REGISTER_PAIR</span><span class="p">,</span> <span class="n">TPM_INF_ADDR</span><span class="p">);</span>

		<span class="cm">/* disable RESET, LP and IRQC */</span>
		<span class="n">tpm_data_out</span><span class="p">(</span><span class="n">RESET_LP_IRQC_DISABLE</span><span class="p">,</span> <span class="n">CMD</span><span class="p">);</span>

		<span class="cm">/* Finally, we&#39;re done, print some infos */</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TPM found: &quot;</span>
			 <span class="s">&quot;config base 0x%lx, &quot;</span>
			 <span class="s">&quot;data base 0x%lx, &quot;</span>
			 <span class="s">&quot;chip version 0x%02x%02x, &quot;</span>
			 <span class="s">&quot;vendor id 0x%x%x (Infineon), &quot;</span>
			 <span class="s">&quot;product id 0x%02x%02x&quot;</span>
			 <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">tpm_dev</span><span class="p">.</span><span class="n">iotype</span> <span class="o">==</span> <span class="n">TPM_INF_IO_PORT</span> <span class="o">?</span>
			 <span class="n">tpm_dev</span><span class="p">.</span><span class="n">config_port</span> <span class="o">:</span>
			 <span class="n">tpm_dev</span><span class="p">.</span><span class="n">map_base</span> <span class="o">+</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">index_off</span><span class="p">,</span>
			 <span class="n">tpm_dev</span><span class="p">.</span><span class="n">iotype</span> <span class="o">==</span> <span class="n">TPM_INF_IO_PORT</span> <span class="o">?</span>
			 <span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_regs</span> <span class="o">:</span>
			 <span class="n">tpm_dev</span><span class="p">.</span><span class="n">map_base</span> <span class="o">+</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_regs</span><span class="p">,</span>
			 <span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			 <span class="n">vendorid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vendorid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			 <span class="n">productid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">productid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">chipname</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span> <span class="o">=</span> <span class="n">tpm_register_hardware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tpm_inf</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">err_release_region</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_release_region</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err_release_region:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">iotype</span> <span class="o">==</span> <span class="n">TPM_INF_IO_PORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_regs</span><span class="p">,</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_size</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">config_port</span><span class="p">,</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">config_size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">mem_base</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">map_base</span><span class="p">,</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">map_size</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">err_last:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__devexit</span> <span class="kt">void</span> <span class="nf">tpm_inf_pnp_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpm_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">pnp_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">iotype</span> <span class="o">==</span> <span class="n">TPM_INF_IO_PORT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_regs</span><span class="p">,</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_size</span><span class="p">);</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">config_port</span><span class="p">,</span>
				       <span class="n">tpm_dev</span><span class="p">.</span><span class="n">config_size</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">mem_base</span><span class="p">);</span>
			<span class="n">release_mem_region</span><span class="p">(</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">map_base</span><span class="p">,</span> <span class="n">tpm_dev</span><span class="p">.</span><span class="n">map_size</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tpm_dev_vendor_release</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">tpm_remove_hardware</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpm_inf_pnp_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">pm_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpm_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">pnp_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">savestate</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span>	<span class="cm">/* TPM_TAG_RQU_COMMAND */</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>	<span class="cm">/* blob length (in bytes) */</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">152</span>	<span class="cm">/* TPM_ORD_SaveState */</span>
		<span class="p">};</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;saving TPM state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">tpm_inf_send</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">savestate</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">savestate</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error while saving TPM state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpm_inf_pnp_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Re-configure TPM after suspending */</span>
	<span class="n">tpm_config_out</span><span class="p">(</span><span class="n">ENABLE_REGISTER_PAIR</span><span class="p">,</span> <span class="n">TPM_INF_ADDR</span><span class="p">);</span>
	<span class="n">tpm_config_out</span><span class="p">(</span><span class="n">IOLIMH</span><span class="p">,</span> <span class="n">TPM_INF_ADDR</span><span class="p">);</span>
	<span class="n">tpm_config_out</span><span class="p">((</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_regs</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">TPM_INF_DATA</span><span class="p">);</span>
	<span class="n">tpm_config_out</span><span class="p">(</span><span class="n">IOLIML</span><span class="p">,</span> <span class="n">TPM_INF_ADDR</span><span class="p">);</span>
	<span class="n">tpm_config_out</span><span class="p">((</span><span class="n">tpm_dev</span><span class="p">.</span><span class="n">data_regs</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">TPM_INF_DATA</span><span class="p">);</span>
	<span class="cm">/* activate register */</span>
	<span class="n">tpm_config_out</span><span class="p">(</span><span class="n">TPM_DAR</span><span class="p">,</span> <span class="n">TPM_INF_ADDR</span><span class="p">);</span>
	<span class="n">tpm_config_out</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">TPM_INF_DATA</span><span class="p">);</span>
	<span class="n">tpm_config_out</span><span class="p">(</span><span class="n">DISABLE_REGISTER_PAIR</span><span class="p">,</span> <span class="n">TPM_INF_ADDR</span><span class="p">);</span>
	<span class="cm">/* disable RESET, LP and IRQC */</span>
	<span class="n">tpm_data_out</span><span class="p">(</span><span class="n">RESET_LP_IRQC_DISABLE</span><span class="p">,</span> <span class="n">CMD</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tpm_pm_resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_driver</span> <span class="n">tpm_inf_pnp_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;tpm_inf_pnp&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">tpm_inf_pnp_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">tpm_inf_pnp_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">tpm_inf_pnp_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">tpm_inf_pnp_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">tpm_inf_pnp_remove</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_inf</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pnp_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpm_inf_pnp_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup_inf</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pnp_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpm_inf_pnp_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_inf</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cleanup_inf</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Marcel Selhorst &lt;m.selhorst@sirrix.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for Infineon TPM SLD 9630 TT 1.1 / SLB 9635 TT 1.2&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;1.9.2&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
