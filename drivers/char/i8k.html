<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › char › i8k.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>i8k.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * i8k.c -- Linux driver for accessing the SMM BIOS on Dell laptops.</span>
<span class="cm"> *	    See http://www.debian.org/~dz/i8k/ for more information</span>
<span class="cm"> *	    and for latest version of this driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2001  Massimo Dal Zotto &lt;dz@debian.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Hwmon integration:</span>
<span class="cm"> * Copyright (C) 2011  Jean Delvare &lt;khali@linux-fr.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2, or (at your option) any</span>
<span class="cm"> * later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon-sysfs.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &lt;linux/i8k.h&gt;</span>

<span class="cp">#define I8K_VERSION		&quot;1.14 21/02/2005&quot;</span>

<span class="cp">#define I8K_SMM_FN_STATUS	0x0025</span>
<span class="cp">#define I8K_SMM_POWER_STATUS	0x0069</span>
<span class="cp">#define I8K_SMM_SET_FAN		0x01a3</span>
<span class="cp">#define I8K_SMM_GET_FAN		0x00a3</span>
<span class="cp">#define I8K_SMM_GET_SPEED	0x02a3</span>
<span class="cp">#define I8K_SMM_GET_TEMP	0x10a3</span>
<span class="cp">#define I8K_SMM_GET_DELL_SIG1	0xfea3</span>
<span class="cp">#define I8K_SMM_GET_DELL_SIG2	0xffa3</span>
<span class="cp">#define I8K_SMM_BIOS_VERSION	0x00a6</span>

<span class="cp">#define I8K_FAN_MULT		30</span>
<span class="cp">#define I8K_MAX_TEMP		127</span>

<span class="cp">#define I8K_FN_NONE		0x00</span>
<span class="cp">#define I8K_FN_UP		0x01</span>
<span class="cp">#define I8K_FN_DOWN		0x02</span>
<span class="cp">#define I8K_FN_MUTE		0x04</span>
<span class="cp">#define I8K_FN_MASK		0x07</span>
<span class="cp">#define I8K_FN_SHIFT		8</span>

<span class="cp">#define I8K_POWER_AC		0x05</span>
<span class="cp">#define I8K_POWER_BATTERY	0x01</span>

<span class="cp">#define I8K_TEMPERATURE_BUG	1</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">i8k_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">bios_version</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">i8k_hwmon_dev</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Massimo Dal Zotto (dz@debian.org)&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for accessing SMM BIOS on Dell laptops&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">force</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s">&quot;Force loading without checking for supported models&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">ignore_dmi</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ignore_dmi</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ignore_dmi</span><span class="p">,</span> <span class="s">&quot;Continue probing hardware even if DMI data does not match&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="k">restricted</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="k">restricted</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="k">restricted</span><span class="p">,</span> <span class="s">&quot;Allow fan control if SYS_ADMIN capability set&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">power_status</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">power_status</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">power_status</span><span class="p">,</span> <span class="s">&quot;Report power status in /proc/i8k&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fan_mult</span> <span class="o">=</span> <span class="n">I8K_FAN_MULT</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fan_mult</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fan_mult</span><span class="p">,</span> <span class="s">&quot;Factor to multiply fan speed with&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">i8k_open_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">i8k_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">i8k_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">i8k_open_fs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">i8k_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">smm_regs</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eax</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ebx</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ecx</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">edx</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">esi</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">edi</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">i8k_get_dmi_data</span><span class="p">(</span><span class="kt">int</span> <span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dmi_data</span> <span class="o">=</span> <span class="n">dmi_get_system_info</span><span class="p">(</span><span class="n">field</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dmi_data</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">dmi_data</span> <span class="o">?</span> <span class="n">dmi_data</span> <span class="o">:</span> <span class="s">&quot;?&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Call the System Management Mode BIOS. Code provided by Jonathan Buzzard.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i8k_smm</span><span class="p">(</span><span class="k">struct</span> <span class="n">smm_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eax</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">eax</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_X86_64)</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;pushq %%rax</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;movl 0(%%rax),%%edx</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;pushq %%rdx</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;movl 4(%%rax),%%ebx</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;movl 8(%%rax),%%ecx</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;movl 12(%%rax),%%edx</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;movl 16(%%rax),%%esi</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;movl 20(%%rax),%%edi</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;popq %%rax</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;out %%al,$0xb2</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;out %%al,$0x84</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;xchgq %%rax,(%%rsp)</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;movl %%ebx,4(%%rax)</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;movl %%ecx,8(%%rax)</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;movl %%edx,12(%%rax)</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;movl %%esi,16(%%rax)</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;movl %%edi,20(%%rax)</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;popq %%rdx</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;movl %%edx,0(%%rax)</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;pushfq</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;popq %%rax</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;andl $1,%%eax</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="o">:</span><span class="s">&quot;=a&quot;</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="o">:</span>    <span class="s">&quot;a&quot;</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span>
		<span class="o">:</span>    <span class="s">&quot;%ebx&quot;</span><span class="p">,</span> <span class="s">&quot;%ecx&quot;</span><span class="p">,</span> <span class="s">&quot;%edx&quot;</span><span class="p">,</span> <span class="s">&quot;%esi&quot;</span><span class="p">,</span> <span class="s">&quot;%edi&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;pushl %%eax</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;movl 0(%%eax),%%edx</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;push %%edx</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;movl 4(%%eax),%%ebx</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;movl 8(%%eax),%%ecx</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;movl 12(%%eax),%%edx</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;movl 16(%%eax),%%esi</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;movl 20(%%eax),%%edi</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;popl %%eax</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;out %%al,$0xb2</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;out %%al,$0x84</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;xchgl %%eax,(%%esp)</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;movl %%ebx,4(%%eax)</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;movl %%ecx,8(%%eax)</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;movl %%edx,12(%%eax)</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;movl %%esi,16(%%eax)</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;movl %%edi,20(%%eax)</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;popl %%edx</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;movl %%edx,0(%%eax)</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;lahf</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;shrl $8,%%eax</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;andl $1,%%eax</span><span class="se">\n</span><span class="s">&quot;</span>
	    <span class="o">:</span><span class="s">&quot;=a&quot;</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span>
	    <span class="o">:</span>    <span class="s">&quot;a&quot;</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span>
	    <span class="o">:</span>    <span class="s">&quot;%ebx&quot;</span><span class="p">,</span> <span class="s">&quot;%ecx&quot;</span><span class="p">,</span> <span class="s">&quot;%edx&quot;</span><span class="p">,</span> <span class="s">&quot;%esi&quot;</span><span class="p">,</span> <span class="s">&quot;%edi&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xffff</span> <span class="o">||</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">eax</span> <span class="o">==</span> <span class="n">eax</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read the bios version. Return the version as an integer corresponding</span>
<span class="cm"> * to the ascii value, for example &quot;A17&quot; is returned as 0x00413137.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i8k_get_bios_version</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smm_regs</span> <span class="n">regs</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="n">I8K_SMM_BIOS_VERSION</span><span class="p">,</span> <span class="p">};</span>

	<span class="k">return</span> <span class="n">i8k_smm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">)</span> <span class="o">?</span> <span class="o">:</span> <span class="n">regs</span><span class="p">.</span><span class="n">eax</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read the Fn key status.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i8k_get_fn_status</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smm_regs</span> <span class="n">regs</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="n">I8K_SMM_FN_STATUS</span><span class="p">,</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">i8k_smm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">&gt;&gt;</span> <span class="n">I8K_FN_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">I8K_FN_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I8K_FN_UP</span>:
		<span class="k">return</span> <span class="n">I8K_VOL_UP</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I8K_FN_DOWN</span>:
		<span class="k">return</span> <span class="n">I8K_VOL_DOWN</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I8K_FN_MUTE</span>:
		<span class="k">return</span> <span class="n">I8K_VOL_MUTE</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read the power status.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i8k_get_power_status</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smm_regs</span> <span class="n">regs</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="n">I8K_SMM_POWER_STATUS</span><span class="p">,</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">i8k_smm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="n">I8K_POWER_AC</span> <span class="o">?</span> <span class="n">I8K_AC</span> <span class="o">:</span> <span class="n">I8K_BATTERY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read the fan status.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i8k_get_fan_status</span><span class="p">(</span><span class="kt">int</span> <span class="n">fan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smm_regs</span> <span class="n">regs</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="n">I8K_SMM_GET_FAN</span><span class="p">,</span> <span class="p">};</span>

	<span class="n">regs</span><span class="p">.</span><span class="n">ebx</span> <span class="o">=</span> <span class="n">fan</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i8k_smm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">)</span> <span class="o">?</span> <span class="o">:</span> <span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read the fan speed in RPM.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i8k_get_fan_speed</span><span class="p">(</span><span class="kt">int</span> <span class="n">fan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smm_regs</span> <span class="n">regs</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="n">I8K_SMM_GET_SPEED</span><span class="p">,</span> <span class="p">};</span>

	<span class="n">regs</span><span class="p">.</span><span class="n">ebx</span> <span class="o">=</span> <span class="n">fan</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i8k_smm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">)</span> <span class="o">?</span> <span class="o">:</span> <span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">*</span> <span class="n">fan_mult</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the fan speed (off, low, high). Returns the new fan status.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i8k_set_fan</span><span class="p">(</span><span class="kt">int</span> <span class="n">fan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smm_regs</span> <span class="n">regs</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="n">I8K_SMM_SET_FAN</span><span class="p">,</span> <span class="p">};</span>

	<span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">((</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">I8K_FAN_MAX</span><span class="p">)</span> <span class="o">?</span> <span class="n">I8K_FAN_MAX</span> <span class="o">:</span> <span class="n">speed</span><span class="p">);</span>
	<span class="n">regs</span><span class="p">.</span><span class="n">ebx</span> <span class="o">=</span> <span class="p">(</span><span class="n">fan</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i8k_smm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">)</span> <span class="o">?</span> <span class="o">:</span> <span class="n">i8k_get_fan_status</span><span class="p">(</span><span class="n">fan</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read the cpu temperature.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i8k_get_temp</span><span class="p">(</span><span class="kt">int</span> <span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smm_regs</span> <span class="n">regs</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="n">I8K_SMM_GET_TEMP</span><span class="p">,</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>

<span class="cp">#ifdef I8K_TEMPERATURE_BUG</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">prev</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">regs</span><span class="p">.</span><span class="n">ebx</span> <span class="o">=</span> <span class="n">sensor</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">i8k_smm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

<span class="cp">#ifdef I8K_TEMPERATURE_BUG</span>
	<span class="cm">/*</span>
<span class="cm">	 * Sometimes the temperature sensor returns 0x99, which is out of range.</span>
<span class="cm">	 * In this case we return (once) the previous cached value. For example:</span>
<span class="cm">	 # 1003655137 00000058 00005a4b</span>
<span class="cm">	 # 1003655138 00000099 00003a80 &lt;--- 0x99 = 153 degrees</span>
<span class="cm">	 # 1003655139 00000054 00005c52</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="n">I8K_MAX_TEMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">I8K_MAX_TEMP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i8k_get_dell_signature</span><span class="p">(</span><span class="kt">int</span> <span class="n">req_fn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smm_regs</span> <span class="n">regs</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="n">req_fn</span><span class="p">,</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">i8k_smm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">regs</span><span class="p">.</span><span class="n">eax</span> <span class="o">==</span> <span class="mi">1145651527</span> <span class="o">&amp;&amp;</span> <span class="n">regs</span><span class="p">.</span><span class="n">edx</span> <span class="o">==</span> <span class="mi">1145392204</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i8k_ioctl_unlocked</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">speed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I8K_BIOS_VERSION</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">i8k_get_bios_version</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">I8K_MACHINE_ID</span>:
		<span class="n">memset</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">i8k_get_dmi_data</span><span class="p">(</span><span class="n">DMI_PRODUCT_SERIAL</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buff</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">I8K_FN_STATUS</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">i8k_get_fn_status</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">I8K_POWER_STATUS</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">i8k_get_power_status</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">I8K_GET_TEMP</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">i8k_get_temp</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">I8K_GET_SPEED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">i8k_get_fan_speed</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">I8K_GET_FAN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">i8k_get_fan_status</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">I8K_SET_FAN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="k">restricted</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">speed</span><span class="p">,</span> <span class="n">argp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">i8k_set_fan</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I8K_BIOS_VERSION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I8K_MACHINE_ID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">i8k_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i8k_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i8k_ioctl_unlocked</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i8k_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Print the information for /proc/i8k.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i8k_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fn_key</span><span class="p">,</span> <span class="n">cpu_temp</span><span class="p">,</span> <span class="n">ac_power</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left_fan</span><span class="p">,</span> <span class="n">right_fan</span><span class="p">,</span> <span class="n">left_speed</span><span class="p">,</span> <span class="n">right_speed</span><span class="p">;</span>

	<span class="n">cpu_temp</span>	<span class="o">=</span> <span class="n">i8k_get_temp</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>			<span class="cm">/* 11100 µs */</span>
	<span class="n">left_fan</span>	<span class="o">=</span> <span class="n">i8k_get_fan_status</span><span class="p">(</span><span class="n">I8K_FAN_LEFT</span><span class="p">);</span>	<span class="cm">/*   580 µs */</span>
	<span class="n">right_fan</span>	<span class="o">=</span> <span class="n">i8k_get_fan_status</span><span class="p">(</span><span class="n">I8K_FAN_RIGHT</span><span class="p">);</span>	<span class="cm">/*   580 µs */</span>
	<span class="n">left_speed</span>	<span class="o">=</span> <span class="n">i8k_get_fan_speed</span><span class="p">(</span><span class="n">I8K_FAN_LEFT</span><span class="p">);</span>	<span class="cm">/*   580 µs */</span>
	<span class="n">right_speed</span>	<span class="o">=</span> <span class="n">i8k_get_fan_speed</span><span class="p">(</span><span class="n">I8K_FAN_RIGHT</span><span class="p">);</span>	<span class="cm">/*   580 µs */</span>
	<span class="n">fn_key</span>		<span class="o">=</span> <span class="n">i8k_get_fn_status</span><span class="p">();</span>			<span class="cm">/*   750 µs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">power_status</span><span class="p">)</span>
		<span class="n">ac_power</span> <span class="o">=</span> <span class="n">i8k_get_power_status</span><span class="p">();</span>		<span class="cm">/* 14700 µs */</span>
	<span class="k">else</span>
		<span class="n">ac_power</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Info:</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1)  Format version (this will change if format changes)</span>
<span class="cm">	 * 2)  BIOS version</span>
<span class="cm">	 * 3)  BIOS machine ID</span>
<span class="cm">	 * 4)  Cpu temperature</span>
<span class="cm">	 * 5)  Left fan status</span>
<span class="cm">	 * 6)  Right fan status</span>
<span class="cm">	 * 7)  Left fan speed</span>
<span class="cm">	 * 8)  Right fan speed</span>
<span class="cm">	 * 9)  AC power</span>
<span class="cm">	 * 10) Fn Key status</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%s %s %s %d %d %d %d %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">I8K_PROC_FMT</span><span class="p">,</span>
			  <span class="n">bios_version</span><span class="p">,</span>
			  <span class="n">i8k_get_dmi_data</span><span class="p">(</span><span class="n">DMI_PRODUCT_SERIAL</span><span class="p">),</span>
			  <span class="n">cpu_temp</span><span class="p">,</span>
			  <span class="n">left_fan</span><span class="p">,</span> <span class="n">right_fan</span><span class="p">,</span> <span class="n">left_speed</span><span class="p">,</span> <span class="n">right_speed</span><span class="p">,</span>
			  <span class="n">ac_power</span><span class="p">,</span> <span class="n">fn_key</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i8k_open_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">i8k_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Hwmon interface</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">i8k_hwmon_show_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu_temp</span><span class="p">;</span>

	<span class="n">cpu_temp</span> <span class="o">=</span> <span class="n">i8k_get_temp</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_temp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cpu_temp</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu_temp</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">i8k_hwmon_show_fan</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fan_speed</span><span class="p">;</span>

	<span class="n">fan_speed</span> <span class="o">=</span> <span class="n">i8k_get_fan_speed</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fan_speed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fan_speed</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fan_speed</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">i8k_hwmon_show_label</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span>
				    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">labels</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;i8k&quot;</span><span class="p">,</span>
		<span class="s">&quot;CPU&quot;</span><span class="p">,</span>
		<span class="s">&quot;Left Fan&quot;</span><span class="p">,</span>
		<span class="s">&quot;Right Fan&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">i8k_hwmon_show_temp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan1_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">i8k_hwmon_show_fan</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			  <span class="n">I8K_FAN_LEFT</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan2_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">i8k_hwmon_show_fan</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			  <span class="n">I8K_FAN_RIGHT</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">i8k_hwmon_show_label</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_label</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">i8k_hwmon_show_label</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan1_label</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">i8k_hwmon_show_label</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan2_label</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">i8k_hwmon_show_label</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i8k_hwmon_remove_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_temp1_input</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sensor_dev_attr_fan1_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sensor_dev_attr_fan2_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_label</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sensor_dev_attr_fan1_label</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sensor_dev_attr_fan2_label</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sensor_dev_attr_name</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">i8k_init_hwmon</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">i8k_hwmon_dev</span> <span class="o">=</span> <span class="n">hwmon_device_register</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">i8k_hwmon_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">i8k_hwmon_dev</span><span class="p">);</span>
		<span class="n">i8k_hwmon_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;i8k: hwmon registration failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Required name attribute */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">i8k_hwmon_dev</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">sensor_dev_attr_name</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_unregister</span><span class="p">;</span>

	<span class="cm">/* CPU temperature attributes, if temperature reading is OK */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">i8k_get_temp</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">i8k_hwmon_dev</span><span class="p">,</span>
			<span class="s">&quot;Not creating temperature attributes (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">i8k_hwmon_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_temp1_input</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove_files</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">i8k_hwmon_dev</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_label</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove_files</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Left fan attributes, if left fan is present */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">i8k_get_fan_status</span><span class="p">(</span><span class="n">I8K_FAN_LEFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">i8k_hwmon_dev</span><span class="p">,</span>
			<span class="s">&quot;Not creating %s fan attributes (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;left&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">i8k_hwmon_dev</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">sensor_dev_attr_fan1_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove_files</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">i8k_hwmon_dev</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">sensor_dev_attr_fan1_label</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove_files</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Right fan attributes, if right fan is present */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">i8k_get_fan_status</span><span class="p">(</span><span class="n">I8K_FAN_RIGHT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">i8k_hwmon_dev</span><span class="p">,</span>
			<span class="s">&quot;Not creating %s fan attributes (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;right&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">i8k_hwmon_dev</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">sensor_dev_attr_fan2_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove_files</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">i8k_hwmon_dev</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">sensor_dev_attr_fan2_label</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove_files</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">exit_remove_files:</span>
	<span class="n">i8k_hwmon_remove_files</span><span class="p">(</span><span class="n">i8k_hwmon_dev</span><span class="p">);</span>
 <span class="nl">exit_unregister:</span>
	<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">i8k_hwmon_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">i8k_exit_hwmon</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i8k_hwmon_remove_files</span><span class="p">(</span><span class="n">i8k_hwmon_dev</span><span class="p">);</span>
	<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">i8k_hwmon_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">__initdata</span> <span class="n">i8k_dmi_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell Inspiron&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Computer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Inspiron&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell Latitude&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Computer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Latitude&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell Inspiron 2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Inspiron&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell Latitude 2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Latitude&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* UK Inspiron 6400  */</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell Inspiron 3&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;MM061&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell Inspiron 3&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;MP061&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell Precision&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Precision&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell Vostro&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Vostro&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
        <span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Probe for the presence of a supported laptop.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">i8k_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">version</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get DMI information</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmi_check_system</span><span class="p">(</span><span class="n">i8k_dmi_table</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ignore_dmi</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">force</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;i8k: not running on a supported Dell system.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;i8k: vendor=%s, model=%s, version=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i8k_get_dmi_data</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">),</span>
			<span class="n">i8k_get_dmi_data</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">),</span>
			<span class="n">i8k_get_dmi_data</span><span class="p">(</span><span class="n">DMI_BIOS_VERSION</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">bios_version</span><span class="p">,</span> <span class="n">i8k_get_dmi_data</span><span class="p">(</span><span class="n">DMI_BIOS_VERSION</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bios_version</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get SMM Dell signature</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i8k_get_dell_signature</span><span class="p">(</span><span class="n">I8K_SMM_GET_DELL_SIG1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">i8k_get_dell_signature</span><span class="p">(</span><span class="n">I8K_SMM_GET_DELL_SIG2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;i8k: unable to get SMM Dell signature</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get SMM BIOS version.</span>
<span class="cm">	 */</span>
	<span class="n">version</span> <span class="o">=</span> <span class="n">i8k_get_bios_version</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;i8k: unable to get SMM BIOS version</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">buff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">buff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">version</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">buff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If DMI BIOS version is unknown use SMM BIOS version.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmi_get_system_info</span><span class="p">(</span><span class="n">DMI_BIOS_VERSION</span><span class="p">))</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">bios_version</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bios_version</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check if the two versions match.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">bios_version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bios_version</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;i8k: BIOS version mismatch: %s != %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">buff</span><span class="p">,</span> <span class="n">bios_version</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">i8k_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">proc_i8k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Are we running on an supported laptop? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i8k_probe</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Register the proc entry */</span>
	<span class="n">proc_i8k</span> <span class="o">=</span> <span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;i8k&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i8k_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">proc_i8k</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">i8k_init_hwmon</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_remove_proc</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;Dell laptop SMM driver v%s Massimo Dal Zotto (dz@debian.org)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">I8K_VERSION</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">exit_remove_proc:</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;i8k&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">i8k_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i8k_exit_hwmon</span><span class="p">();</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;i8k&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">i8k_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">i8k_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
