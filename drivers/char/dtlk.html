<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › char › dtlk.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>dtlk.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*                                              -*- linux-c -*-</span>
<span class="cm"> * dtlk.c - DoubleTalk PC driver for Linux</span>
<span class="cm"> *</span>
<span class="cm"> * Original author: Chris Pallotta &lt;chris@allmedia.com&gt;</span>
<span class="cm"> * Current maintainer: Jim Van Zandt &lt;jrv@vanzandt.mv.com&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * 2000-03-18 Jim Van Zandt: Fix polling.</span>
<span class="cm"> *  Eliminate dtlk_timer_active flag and separate dtlk_stop_timer</span>
<span class="cm"> *  function.  Don&#39;t restart timer in dtlk_timer_tick.  Restart timer</span>
<span class="cm"> *  in dtlk_poll after every poll.  dtlk_poll returns mask (duh).</span>
<span class="cm"> *  Eliminate unused function dtlk_write_byte.  Misc. code cleanups.</span>
<span class="cm"> */</span>

<span class="cm">/* This driver is for the DoubleTalk PC, a speech synthesizer</span>
<span class="cm">   manufactured by RC Systems (http://www.rcsys.com/).  It was written</span>
<span class="cm">   based on documentation in their User&#39;s Manual file and Developer&#39;s</span>
<span class="cm">   Tools disk.</span>

<span class="cm">   The DoubleTalk PC contains four voice synthesizers: text-to-speech</span>
<span class="cm">   (TTS), linear predictive coding (LPC), PCM/ADPCM, and CVSD.  It</span>
<span class="cm">   also has a tone generator.  Output data for LPC are written to the</span>
<span class="cm">   LPC port, and output data for the other modes are written to the</span>
<span class="cm">   TTS port.</span>

<span class="cm">   Two kinds of data can be read from the DoubleTalk: status</span>
<span class="cm">   information (in response to the &quot;\001?&quot; interrogation command) is</span>
<span class="cm">   read from the TTS port, and index markers (which mark the progress</span>
<span class="cm">   of the speech) are read from the LPC port.  Not all models of the</span>
<span class="cm">   DoubleTalk PC implement index markers.  Both the TTS and LPC ports</span>
<span class="cm">   can also display status flags.</span>

<span class="cm">   The DoubleTalk PC generates no interrupts.</span>

<span class="cm">   These characteristics are mapped into the Unix stream I/O model as</span>
<span class="cm">   follows:</span>

<span class="cm">   &quot;write&quot; sends bytes to the TTS port.  It is the responsibility of</span>
<span class="cm">   the user program to switch modes among TTS, PCM/ADPCM, and CVSD.</span>
<span class="cm">   This driver was written for use with the text-to-speech</span>
<span class="cm">   synthesizer.  If LPC output is needed some day, other minor device</span>
<span class="cm">   numbers can be used to select among output modes.</span>

<span class="cm">   &quot;read&quot; gets index markers from the LPC port.  If the device does</span>
<span class="cm">   not implement index markers, the read will fail with error EINVAL.</span>

<span class="cm">   Status information is available using the DTLK_INTERROGATE ioctl.</span>

<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#define KERNEL</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;	</span><span class="cm">/* for -EBUSY */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/ioport.h&gt;	</span><span class="cm">/* for request_region */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/delay.h&gt;	</span><span class="cm">/* for loops_per_jiffy */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;		</span><span class="cm">/* for inb_p, outb_p, inb, outb, etc. */</span><span class="cp"></span>
<span class="cp">#include &lt;asm/uaccess.h&gt;	</span><span class="cm">/* for get_user, etc. */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/wait.h&gt;		</span><span class="cm">/* for wait_queue */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/init.h&gt;		</span><span class="cm">/* for __init, module_{init,exit} */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/poll.h&gt;		</span><span class="cm">/* for POLLIN, etc. */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/dtlk.h&gt;		</span><span class="cm">/* local header file for DoubleTalk values */</span><span class="cp"></span>

<span class="cp">#ifdef TRACING</span>
<span class="cp">#define TRACE_TEXT(str) printk(str);</span>
<span class="cp">#define TRACE_RET printk(&quot;)&quot;)</span>
<span class="cp">#else				</span><span class="cm">/* !TRACING */</span><span class="cp"></span>
<span class="cp">#define TRACE_TEXT(str) ((void) 0)</span>
<span class="cp">#define TRACE_RET ((void) 0)</span>
<span class="cp">#endif				</span><span class="cm">/* TRACING */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">dtlk_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dtlk_timer_tick</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dtlk_major</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dtlk_port_lpc</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dtlk_port_tts</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dtlk_busy</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dtlk_has_indexing</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dtlk_portlist</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span><span class="mh">0x25e</span><span class="p">,</span> <span class="mh">0x29e</span><span class="p">,</span> <span class="mh">0x2de</span><span class="p">,</span> <span class="mh">0x31e</span><span class="p">,</span> <span class="mh">0x35e</span><span class="p">,</span> <span class="mh">0x39e</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
<span class="k">static</span> <span class="n">wait_queue_head_t</span> <span class="n">dtlk_process_list</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_TIMER</span><span class="p">(</span><span class="n">dtlk_timer</span><span class="p">,</span> <span class="n">dtlk_timer_tick</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* prototypes for file_operations struct */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">dtlk_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">ppos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">dtlk_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span>
			  <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">ppos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dtlk_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dtlk_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dtlk_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">dtlk_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dtlk_fops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">dtlk_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">dtlk_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">dtlk_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">dtlk_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">dtlk_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">dtlk_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* local prototypes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dtlk_dev_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dtlk_settings</span> <span class="o">*</span><span class="n">dtlk_interrogate</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dtlk_readable</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">dtlk_read_lpc</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">dtlk_read_tts</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dtlk_writeable</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">dtlk_write_bytes</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">dtlk_write_tts</span><span class="p">(</span><span class="kt">char</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">   static void dtlk_handle_error(char, char, unsigned int);</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dtlk_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retries</span><span class="p">;</span>

	<span class="n">TRACE_TEXT</span><span class="p">(</span><span class="s">&quot;(dtlk_read&quot;</span><span class="p">);</span>
	<span class="cm">/*  printk(&quot;DoubleTalk PC - dtlk_read()\n&quot;); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minor</span> <span class="o">!=</span> <span class="n">DTLK_MINOR</span> <span class="o">||</span> <span class="o">!</span><span class="n">dtlk_has_indexing</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="n">loops_per_jiffy</span><span class="p">;</span> <span class="n">retries</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">dtlk_readable</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="n">dtlk_read_lpc</span><span class="p">();</span>
			<span class="cm">/*        printk(&quot;dtlk_read() reads 0x%02x\n&quot;, ch); */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">buf</span><span class="o">++</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retries</span> <span class="o">==</span> <span class="n">loops_per_jiffy</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dtlk_read times out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">TRACE_RET</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dtlk_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			  <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ch</span><span class="p">;</span>

	<span class="n">TRACE_TEXT</span><span class="p">(</span><span class="s">&quot;(dtlk_write&quot;</span><span class="p">);</span>
<span class="cp">#ifdef TRACING</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; </span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="sc">&#39; &#39;</span> <span class="o">&lt;=</span> <span class="n">ch</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="sc">&#39;~&#39;</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">%03o&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iminor</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DTLK_MINOR</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">get_user</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">DTLK_CLEAR</span> <span class="o">||</span> <span class="n">dtlk_writeable</span><span class="p">()))</span> <span class="p">{</span>
			<span class="n">dtlk_write_tts</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
			<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/* We yield our time until scheduled</span>
<span class="cm">				   again.  This reduces the transfer</span>
<span class="cm">				   rate to 500 bytes/sec, but that&#39;s</span>
<span class="cm">				   still enough to keep up with the</span>
<span class="cm">				   speech synthesizer. */</span>
				<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* the RDY bit goes zero 2-3 usec</span>
<span class="cm">				   after writing, and goes 1 again</span>
<span class="cm">				   180-190 usec later.  Here, we wait</span>
<span class="cm">				   up to 250 usec for the RDY bit to</span>
<span class="cm">				   go nonzero. */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				     <span class="n">retries</span> <span class="o">&lt;</span> <span class="n">loops_per_jiffy</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4000</span><span class="o">/</span><span class="n">HZ</span><span class="p">);</span>
				     <span class="n">retries</span><span class="o">++</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">inb_p</span><span class="p">(</span><span class="n">dtlk_port_tts</span><span class="p">)</span> <span class="o">&amp;</span>
					    <span class="n">TTS_WRITABLE</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">count</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* wait no more than 10 sec</span>
<span class="cm">					      from last write */</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dtlk: write timeout.  &quot;</span>
			       <span class="s">&quot;inb_p(dtlk_port_tts) = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">inb_p</span><span class="p">(</span><span class="n">dtlk_port_tts</span><span class="p">));</span>
			<span class="n">TRACE_RET</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">TRACE_RET</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dtlk_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expires</span><span class="p">;</span>

	<span class="n">TRACE_TEXT</span><span class="p">(</span><span class="s">&quot; dtlk_poll&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   static long int j;</span>
<span class="cm">	   printk(&quot;.&quot;);</span>
<span class="cm">	   printk(&quot;&lt;%ld&gt;&quot;, jiffies-j);</span>
<span class="cm">	   j=jiffies;</span>
<span class="cm">	 */</span>
	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dtlk_process_list</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dtlk_has_indexing</span> <span class="o">&amp;&amp;</span> <span class="n">dtlk_readable</span><span class="p">())</span> <span class="p">{</span>
	        <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtlk_timer</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dtlk_writeable</span><span class="p">())</span> <span class="p">{</span>
	        <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtlk_timer</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* there are no exception conditions */</span>

	<span class="cm">/* There won&#39;t be any interrupts, so we set a timer instead. */</span>
	<span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtlk_timer</span><span class="p">,</span> <span class="n">expires</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dtlk_timer_tick</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TRACE_TEXT</span><span class="p">(</span><span class="s">&quot; dtlk_timer_tick&quot;</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtlk_process_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">dtlk_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtlk_settings</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">portval</span><span class="p">;</span>
	<span class="n">TRACE_TEXT</span><span class="p">(</span><span class="s">&quot; dtlk_ioctl&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">DTLK_INTERROGATE</span>:
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtlk_mutex</span><span class="p">);</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">dtlk_interrogate</span><span class="p">();</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtlk_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dtlk_settings</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DTLK_STATUS</span>:
		<span class="n">portval</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">dtlk_port_tts</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">portval</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Note that nobody ever sets dtlk_busy... */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dtlk_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TRACE_TEXT</span><span class="p">(</span><span class="s">&quot;(dtlk_open&quot;</span><span class="p">);</span>

	<span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DTLK_MINOR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dtlk_busy</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dtlk_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TRACE_TEXT</span><span class="p">(</span><span class="s">&quot;(dtlk_release&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DTLK_MINOR</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">TRACE_RET</span><span class="p">;</span>
	
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtlk_timer</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dtlk_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dtlk_port_lpc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dtlk_port_tts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dtlk_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dtlk_major</span> <span class="o">=</span> <span class="n">register_chrdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dtlk&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dtlk_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dtlk_major</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DoubleTalk PC - cannot register device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">dtlk_major</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">dtlk_dev_probe</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">dtlk_major</span><span class="p">,</span> <span class="s">&quot;dtlk&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, MAJOR %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dtlk_major</span><span class="p">);</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtlk_process_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">dtlk_cleanup</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dtlk_write_bytes</span><span class="p">(</span><span class="s">&quot;goodbye&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>		<span class="cm">/* nap 0.50 sec but</span>
<span class="cm">						   could be awakened</span>
<span class="cm">						   earlier by</span>
<span class="cm">						   signals... */</span>

	<span class="n">dtlk_write_tts</span><span class="p">(</span><span class="n">DTLK_CLEAR</span><span class="p">);</span>
	<span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">dtlk_major</span><span class="p">,</span> <span class="s">&quot;dtlk&quot;</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dtlk_port_lpc</span><span class="p">,</span> <span class="n">DTLK_IO_EXTENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">dtlk_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">dtlk_cleanup</span><span class="p">);</span>

<span class="cm">/* ------------------------------------------------------------------------ */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dtlk_readable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef TRACING</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; dtlk_readable=%u@%u&quot;</span><span class="p">,</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">dtlk_port_lpc</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">dtlk_port_lpc</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x7f</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dtlk_writeable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* TRACE_TEXT(&quot; dtlk_writeable&quot;); */</span>
<span class="cp">#ifdef TRACINGMORE</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; dtlk_writeable=%u&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">inb_p</span><span class="p">(</span><span class="n">dtlk_port_tts</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TTS_WRITABLE</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">dtlk_port_tts</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TTS_WRITABLE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dtlk_dev_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">testval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtlk_settings</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dtlk_port_lpc</span> <span class="o">|</span> <span class="n">dtlk_port_tts</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dtlk_portlist</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		printk(&quot;DoubleTalk PC - Port %03x = %04x\n&quot;,</span>
<span class="c">		       dtlk_portlist[i], (testval = inw_p(dtlk_portlist[i])));</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">dtlk_portlist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">DTLK_IO_EXTENT</span><span class="p">,</span> 
			       <span class="s">&quot;dtlk&quot;</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">testval</span> <span class="o">=</span> <span class="n">inw_p</span><span class="p">(</span><span class="n">dtlk_portlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">testval</span> <span class="o">&amp;=</span> <span class="mh">0xfbff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x107f</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dtlk_port_lpc</span> <span class="o">=</span> <span class="n">dtlk_portlist</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">dtlk_port_tts</span> <span class="o">=</span> <span class="n">dtlk_port_lpc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">sp</span> <span class="o">=</span> <span class="n">dtlk_interrogate</span><span class="p">();</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DoubleTalk PC at %03x-%03x, &quot;</span>
			       <span class="s">&quot;ROM version %s, serial number %u&quot;</span><span class="p">,</span>
			       <span class="n">dtlk_portlist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dtlk_portlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
			       <span class="n">DTLK_IO_EXTENT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="n">sp</span><span class="o">-&gt;</span><span class="n">rom_version</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">serial_number</span><span class="p">);</span>

                        <span class="cm">/* put LPC port into known state, so</span>
<span class="cm">			   dtlk_readable() gives valid result */</span>
			<span class="n">outb_p</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">dtlk_port_lpc</span><span class="p">);</span> 

                        <span class="cm">/* INIT string and index marker */</span>
			<span class="n">dtlk_write_bytes</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\036\1</span><span class="s">@</span><span class="se">\0\001</span><span class="s">2I</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="cm">/* posting an index takes 18 msec.  Here, we</span>
<span class="cm">			   wait up to 100 msec to see whether it</span>
<span class="cm">			   appears. */</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="n">dtlk_has_indexing</span> <span class="o">=</span> <span class="n">dtlk_readable</span><span class="p">();</span>
<span class="cp">#ifdef TRACING</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, indexing %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dtlk_has_indexing</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef INSCOPE</span>
			<span class="p">{</span>
<span class="cm">/* This macro records ten samples read from the LPC port, for later display */</span>
<span class="cp">#define LOOK					\</span>
<span class="cp">for (i = 0; i &lt; 10; i++)			\</span>
<span class="cp">  {						\</span>
<span class="cp">    buffer[b++] = inb_p(dtlk_port_lpc);		\</span>
<span class="cp">    __delay(loops_per_jiffy/(1000000/HZ));             \</span>
<span class="cp">  }</span>
				<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1000</span><span class="p">];</span>
				<span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

				<span class="n">LOOK</span>
				<span class="n">outb_p</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">dtlk_port_lpc</span><span class="p">);</span>
				<span class="n">buffer</span><span class="p">[</span><span class="n">b</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">LOOK</span>
				<span class="n">dtlk_write_bytes</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\001</span><span class="s">2I</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
				<span class="n">buffer</span><span class="p">[</span><span class="n">b</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">__delay</span><span class="p">(</span><span class="mi">50</span> <span class="o">*</span> <span class="n">loops_per_jiffy</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000</span><span class="o">/</span><span class="n">HZ</span><span class="p">));</span>
				<span class="n">outb_p</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">dtlk_port_lpc</span><span class="p">);</span>
				<span class="n">buffer</span><span class="p">[</span><span class="n">b</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">LOOK</span>

				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* INSCOPE */</span><span class="cp"></span>

<span class="cp">#ifdef OUTSCOPE</span>
			<span class="p">{</span>
<span class="cm">/* This macro records ten samples read from the TTS port, for later display */</span>
<span class="cp">#define LOOK					\</span>
<span class="cp">for (i = 0; i &lt; 10; i++)			\</span>
<span class="cp">  {						\</span>
<span class="cp">    buffer[b++] = inb_p(dtlk_port_tts);		\</span>
<span class="cp">    __delay(loops_per_jiffy/(1000000/HZ));  </span><span class="cm">/* 1 us */</span><span class="cp"> \</span>
<span class="cp">  }</span>
				<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1000</span><span class="p">];</span>
				<span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

				<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>	<span class="cm">/* 10 ms */</span>
				<span class="n">LOOK</span>
				<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="n">dtlk_port_tts</span><span class="p">);</span>
				<span class="n">buffer</span><span class="p">[</span><span class="n">b</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">LOOK</span>
				<span class="n">LOOK</span>

				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* OUTSCOPE */</span><span class="cp"></span>

			<span class="n">dtlk_write_bytes</span><span class="p">(</span><span class="s">&quot;Double Talk found&quot;</span><span class="p">,</span> <span class="mi">18</span><span class="p">);</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">dtlk_portlist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">DTLK_IO_EXTENT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DoubleTalk PC - not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   static void dtlk_handle_error(char op, char rc, unsigned int minor)</span>
<span class="cm">   {</span>
<span class="cm">   printk(KERN_INFO&quot;\nDoubleTalk PC - MINOR: %d, OPCODE: %d, ERROR: %d\n&quot;, </span>
<span class="cm">   minor, op, rc);</span>
<span class="cm">   return;</span>
<span class="cm">   }</span>
<span class="cm"> */</span>

<span class="cm">/* interrogate the DoubleTalk PC and return its settings */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dtlk_settings</span> <span class="o">*</span><span class="nf">dtlk_interrogate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dtlk_settings</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">total</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">dtlk_settings</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">TRACE_TEXT</span><span class="p">(</span><span class="s">&quot;(dtlk_interrogate&quot;</span><span class="p">);</span>
	<span class="n">dtlk_write_bytes</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\030\001</span><span class="s">?&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">total</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtlk_read_tts</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="n">total</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7f</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dtlk_settings</span><span class="p">))</span>
			<span class="n">total</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   if (i==50) printk(&quot;interrogate() read overrun\n&quot;);</span>
<span class="cm">	   for (i=0; i&lt;sizeof(buf); i++)</span>
<span class="cm">	   printk(&quot; %02x&quot;, buf[i]);</span>
<span class="cm">	   printk(&quot;\n&quot;);</span>
<span class="cm">	 */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">serial_number</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span><span class="p">;</span> <span class="cm">/* serial number is</span>
<span class="cm">						     little endian */</span>
	<span class="n">t</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">t</span> <span class="o">!=</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span><span class="p">.</span><span class="n">rom_version</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">rom_version</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">t</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span><span class="p">.</span><span class="n">rom_version</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">t</span><span class="o">++</span><span class="p">;</span>

	<span class="n">status</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="o">*</span><span class="n">t</span><span class="o">++</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">punc_level</span> <span class="o">=</span> <span class="o">*</span><span class="n">t</span><span class="o">++</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">formant_freq</span> <span class="o">=</span> <span class="o">*</span><span class="n">t</span><span class="o">++</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">pitch</span> <span class="o">=</span> <span class="o">*</span><span class="n">t</span><span class="o">++</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="o">*</span><span class="n">t</span><span class="o">++</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">volume</span> <span class="o">=</span> <span class="o">*</span><span class="n">t</span><span class="o">++</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">tone</span> <span class="o">=</span> <span class="o">*</span><span class="n">t</span><span class="o">++</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">expression</span> <span class="o">=</span> <span class="o">*</span><span class="n">t</span><span class="o">++</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">ext_dict_loaded</span> <span class="o">=</span> <span class="o">*</span><span class="n">t</span><span class="o">++</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">ext_dict_status</span> <span class="o">=</span> <span class="o">*</span><span class="n">t</span><span class="o">++</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">free_ram</span> <span class="o">=</span> <span class="o">*</span><span class="n">t</span><span class="o">++</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">articulation</span> <span class="o">=</span> <span class="o">*</span><span class="n">t</span><span class="o">++</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">reverb</span> <span class="o">=</span> <span class="o">*</span><span class="n">t</span><span class="o">++</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">eob</span> <span class="o">=</span> <span class="o">*</span><span class="n">t</span><span class="o">++</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">has_indexing</span> <span class="o">=</span> <span class="n">dtlk_has_indexing</span><span class="p">;</span>
	<span class="n">TRACE_RET</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="nf">dtlk_read_tts</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">portval</span><span class="p">,</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">TRACE_TEXT</span><span class="p">(</span><span class="s">&quot;(dtlk_read_tts&quot;</span><span class="p">);</span>

	<span class="cm">/* verify DT is ready, read char, wait for ACK */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">portval</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">dtlk_port_tts</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">portval</span> <span class="o">&amp;</span> <span class="n">TTS_READABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		 <span class="n">retries</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">DTLK_MAX_RETRIES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="n">DTLK_MAX_RETRIES</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dtlk_read_tts() timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">dtlk_port_tts</span><span class="p">);</span>	<span class="cm">/* input from TTS port */</span>
	<span class="n">ch</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">dtlk_port_tts</span><span class="p">);</span>

	<span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">portval</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">dtlk_port_tts</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">portval</span> <span class="o">&amp;</span> <span class="n">TTS_READABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		 <span class="n">retries</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">DTLK_MAX_RETRIES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="n">DTLK_MAX_RETRIES</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dtlk_read_tts() timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">TRACE_RET</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ch</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="nf">dtlk_read_lpc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">TRACE_TEXT</span><span class="p">(</span><span class="s">&quot;(dtlk_read_lpc&quot;</span><span class="p">);</span>

	<span class="cm">/* no need to test -- this is only called when the port is readable */</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">dtlk_port_lpc</span><span class="p">);</span>	<span class="cm">/* input from LPC port */</span>

	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">dtlk_port_lpc</span><span class="p">);</span>

	<span class="cm">/* acknowledging a read takes 3-4</span>
<span class="cm">	   usec.  Here, we wait up to 20 usec</span>
<span class="cm">	   for the acknowledgement */</span>
	<span class="n">retries</span> <span class="o">=</span> <span class="p">(</span><span class="n">loops_per_jiffy</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000000</span><span class="o">/</span><span class="n">HZ</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">inb_p</span><span class="p">(</span><span class="n">dtlk_port_lpc</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x7f</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dtlk_read_lpc() timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">TRACE_RET</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ch</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* write n bytes to tts port */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="nf">dtlk_write_bytes</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*  printk(&quot;dtlk_write_bytes(\&quot;%-*s\&quot;, %d)\n&quot;, n, buf, n); */</span>
	<span class="n">TRACE_TEXT</span><span class="p">(</span><span class="s">&quot;(dtlk_write_bytes&quot;</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">dtlk_write_tts</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
	<span class="n">TRACE_RET</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="nf">dtlk_write_tts</span><span class="p">(</span><span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef TRACINGMORE</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  dtlk_write_tts(&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="sc">&#39; &#39;</span> <span class="o">&lt;=</span> <span class="n">ch</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="sc">&#39;~&#39;</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;&#39;%c&#39;&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;0x%02x&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="n">DTLK_CLEAR</span><span class="p">)</span>	<span class="cm">/* no flow control for CLEAR command */</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">inb_p</span><span class="p">(</span><span class="n">dtlk_port_tts</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TTS_WRITABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		       <span class="n">retries</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">DTLK_MAX_RETRIES</span><span class="p">)</span>	<span class="cm">/* DT ready? */</span>
			<span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="n">DTLK_MAX_RETRIES</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dtlk_write_tts() timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">outb_p</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">dtlk_port_tts</span><span class="p">);</span>	<span class="cm">/* output to TTS port */</span>
	<span class="cm">/* the RDY bit goes zero 2-3 usec after writing, and goes</span>
<span class="cm">	   1 again 180-190 usec later.  Here, we wait up to 10</span>
<span class="cm">	   usec for the RDY bit to go zero. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="n">loops_per_jiffy</span> <span class="o">/</span> <span class="p">(</span><span class="mi">100000</span><span class="o">/</span><span class="n">HZ</span><span class="p">);</span> <span class="n">retries</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inb_p</span><span class="p">(</span><span class="n">dtlk_port_tts</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TTS_WRITABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef TRACINGMORE</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
