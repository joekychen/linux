<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › char › agp › intel-gtt.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>intel-gtt.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Intel GTT (Graphics Translation Table) routines</span>
<span class="cm"> *</span>
<span class="cm"> * Caveat: This driver implements the linux agp interface, but this is far from</span>
<span class="cm"> * a agp driver! GTT support ended up here for purely historical reasons: The</span>
<span class="cm"> * old userspace intel graphics drivers needed an interface to map memory into</span>
<span class="cm"> * the GTT. And the drm provides a default interface for graphic devices sitting</span>
<span class="cm"> * on an agp port. So it made sense to fake the GTT support as an agp port to</span>
<span class="cm"> * avoid having to create a new api.</span>
<span class="cm"> *</span>
<span class="cm"> * With gem this does not make much sense anymore, just needlessly complicates</span>
<span class="cm"> * the code. But as long as the old graphics stack is still support, it&#39;s stuck</span>
<span class="cm"> * here.</span>
<span class="cm"> *</span>
<span class="cm"> * /fairy-tale-mode off</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/agp_backend.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;asm/smp.h&gt;</span>
<span class="cp">#include &quot;agp.h&quot;</span>
<span class="cp">#include &quot;intel-agp.h&quot;</span>
<span class="cp">#include &lt;drm/intel-gtt.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * If we have Intel graphics, we&#39;re not going to have anything other than</span>
<span class="cm"> * an Intel IOMMU. So make the correct use of the PCI DMA API contingent</span>
<span class="cm"> * on the Intel IOMMU support (CONFIG_INTEL_IOMMU).</span>
<span class="cm"> * Only newer chipsets need to bother with this, of course.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_INTEL_IOMMU</span>
<span class="cp">#define USE_PCI_DMA_API 1</span>
<span class="cp">#else</span>
<span class="cp">#define USE_PCI_DMA_API 0</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">intel_gtt_driver</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gen</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_g33</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_pineview</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_ironlake</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">has_pgtbl_enable</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_mask_size</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>
	<span class="cm">/* Chipset specific GTT setup */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">setup</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
	<span class="cm">/* This should undo anything done in -&gt;setup() save the unmapping</span>
<span class="cm">	 * of the mmio register file, that&#39;s done in the generic code. */</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cleanup</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">write_entry</span><span class="p">)(</span><span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entry</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Flags is a more or less chipset specific opaque value.</span>
<span class="cm">	 * For chipsets that need to support old ums (non-gem) code, this</span>
<span class="cm">	 * needs to be identical to the various supported agp memory types! */</span>
	<span class="n">bool</span> <span class="p">(</span><span class="o">*</span><span class="n">check_flags</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">chipset_flush</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">_intel_private</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_gtt</span> <span class="n">base</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">intel_gtt_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">;</span>	<span class="cm">/* device one */</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge_dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">registers</span><span class="p">;</span>
	<span class="n">phys_addr_t</span> <span class="n">gtt_bus_addr</span><span class="p">;</span>
	<span class="n">phys_addr_t</span> <span class="n">gma_bus_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">PGETBL_save</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">gtt</span><span class="p">;</span>		<span class="cm">/* I915G */</span>
	<span class="n">bool</span> <span class="n">clear_fake_agp</span><span class="p">;</span> <span class="cm">/* on first access via agp, fill with scratch */</span>
	<span class="kt">int</span> <span class="n">num_dcache_entries</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">i9xx_flush_page</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">i81x_gtt_table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">ifp_resource</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resource_valid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">scratch_page</span><span class="p">;</span>
<span class="p">}</span> <span class="n">intel_private</span><span class="p">;</span>

<span class="cp">#define INTEL_GTT_GEN	intel_private.driver-&gt;gen</span>
<span class="cp">#define IS_G33		intel_private.driver-&gt;is_g33</span>
<span class="cp">#define IS_PINEVIEW	intel_private.driver-&gt;is_pineview</span>
<span class="cp">#define IS_IRONLAKE	intel_private.driver-&gt;is_ironlake</span>
<span class="cp">#define HAS_PGTBL_EN	intel_private.driver-&gt;has_pgtbl_enable</span>

<span class="kt">int</span> <span class="nf">intel_gtt_map_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_entries</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">**</span><span class="n">sg_list</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">num_sg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sg_table</span> <span class="n">st</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">sg_list</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* already mapped (for e.g. resume */</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;try mapping %lu pages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">num_entries</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sg_alloc_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="p">,</span> <span class="n">num_entries</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="o">*</span><span class="n">sg_list</span> <span class="o">=</span> <span class="n">sg</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">sgl</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span>
		<span class="n">sg_set_page</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="o">*</span><span class="n">num_sg</span> <span class="o">=</span> <span class="n">pci_map_sg</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="p">,</span> <span class="o">*</span><span class="n">sg_list</span><span class="p">,</span>
				 <span class="n">num_entries</span><span class="p">,</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!*</span><span class="n">num_sg</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">sg_free_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">intel_gtt_map_memory</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">intel_gtt_unmap_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg_list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_sg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sg_table</span> <span class="n">st</span><span class="p">;</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;try unmapping %lu pages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">page_count</span><span class="p">);</span>

	<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">sg_list</span><span class="p">,</span>
		     <span class="n">num_sg</span><span class="p">,</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="n">st</span><span class="p">.</span><span class="n">sgl</span> <span class="o">=</span> <span class="n">sg_list</span><span class="p">;</span>
	<span class="n">st</span><span class="p">.</span><span class="n">orig_nents</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">nents</span> <span class="o">=</span> <span class="n">num_sg</span><span class="p">;</span>

	<span class="n">sg_free_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">intel_gtt_unmap_memory</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_fake_agp_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">agp_bridge_data</span> <span class="o">*</span><span class="n">bridge</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Exists to support ARGB cursors */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">i8xx_alloc_pages</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA32</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_pages_uc</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_pages_wb</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">__free_pages</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">get_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">current_memory_agp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i8xx_destroy_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">set_pages_wb</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">put_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">__free_pages</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">current_memory_agp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define I810_GTT_ORDER 4</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i810_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg_addr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">gtt_table</span><span class="p">;</span>

	<span class="cm">/* i81x does not preallocate the gtt. It&#39;s always 64kb in size. */</span>
	<span class="n">gtt_table</span> <span class="o">=</span> <span class="n">alloc_gatt_pages</span><span class="p">(</span><span class="n">I810_GTT_ORDER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gtt_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">intel_private</span><span class="p">.</span><span class="n">i81x_gtt_table</span> <span class="o">=</span> <span class="n">gtt_table</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">I810_MMADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_addr</span><span class="p">);</span>
	<span class="n">reg_addr</span> <span class="o">&amp;=</span> <span class="mh">0xfff80000</span><span class="p">;</span>

	<span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">reg_addr</span><span class="p">,</span> <span class="n">KB</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">gtt_table</span><span class="p">)</span> <span class="o">|</span> <span class="n">I810_PGETBL_ENABLED</span><span class="p">,</span>
	       <span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="o">+</span><span class="n">I810_PGETBL_CTL</span><span class="p">);</span>

	<span class="n">intel_private</span><span class="p">.</span><span class="n">gtt_bus_addr</span> <span class="o">=</span> <span class="n">reg_addr</span> <span class="o">+</span> <span class="n">I810_PTE_BASE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="o">+</span><span class="n">I810_DRAM_CTL</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="n">I810_DRAM_ROW_0</span><span class="p">)</span> <span class="o">==</span> <span class="n">I810_DRAM_ROW_0_SDRAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;detected 4MB dedicated video ram</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">intel_private</span><span class="p">.</span><span class="n">num_dcache_entries</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i810_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="o">+</span><span class="n">I810_PGETBL_CTL</span><span class="p">);</span>
	<span class="n">free_gatt_pages</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">i81x_gtt_table</span><span class="p">,</span> <span class="n">I810_GTT_ORDER</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i810_insert_dcache_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">agp_memory</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">pg_start</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pg_start</span> <span class="o">+</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">page_count</span><span class="p">)</span>
			<span class="o">&gt;</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">num_dcache_entries</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">is_flushed</span><span class="p">)</span>
		<span class="n">global_cache_flush</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">pg_start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">pg_start</span> <span class="o">+</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">page_count</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="n">intel_private</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">write_entry</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span>
						  <span class="n">i</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">gtt</span><span class="o">+</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The i810/i830 requires a physical address to program its mouse</span>
<span class="cm"> * pointer into hardware.</span>
<span class="cm"> * However the Xserver still writes to it through the agp aperture.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">agp_memory</span> <span class="o">*</span><span class="nf">alloc_agpphysmem_i8xx</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">pg_count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">agp_memory</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pg_count</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">page</span> <span class="o">=</span> <span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">agp_alloc_page</span><span class="p">(</span><span class="n">agp_bridge</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="cm">/* kludge to get 4 physical pages for ARGB cursor */</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">i8xx_alloc_pages</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">new</span> <span class="o">=</span> <span class="n">agp_create_memory</span><span class="p">(</span><span class="n">pg_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">new</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pg_count</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* kludge to get 4 physical pages for ARGB cursor */</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">page_count</span> <span class="o">=</span> <span class="n">pg_count</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">num_scratch_pages</span> <span class="o">=</span> <span class="n">pg_count</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">AGP_PHYS_MEMORY</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">physical</span> <span class="o">=</span> <span class="n">page_to_phys</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">new</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_i810_free_by_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">agp_memory</span> <span class="o">*</span><span class="n">curr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">agp_free_key</span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">AGP_PHYS_MEMORY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">page_count</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">i8xx_destroy_pages</span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">agp_destroy_page</span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
							     <span class="n">AGP_PAGE_DESTROY_UNMAP</span><span class="p">);</span>
			<span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">agp_destroy_page</span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
							     <span class="n">AGP_PAGE_DESTROY_FREE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">agp_free_page_array</span><span class="p">(</span><span class="n">curr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">curr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_gtt_setup_scratch_page</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA32</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">get_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">set_pages_uc</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">needs_dmar</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">pci_map_page</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">scratch_page_dma</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">scratch_page_dma</span> <span class="o">=</span> <span class="n">page_to_phys</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="n">intel_private</span><span class="p">.</span><span class="n">scratch_page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i810_write_entry</span><span class="p">(</span><span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entry</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pte_flags</span> <span class="o">=</span> <span class="n">I810_PTE_VALID</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AGP_DCACHE_MEMORY</span>:
		<span class="n">pte_flags</span> <span class="o">|=</span> <span class="n">I810_PTE_LOCAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AGP_USER_CACHED_MEMORY</span>:
		<span class="n">pte_flags</span> <span class="o">|=</span> <span class="n">I830_PTE_SYSTEM_CACHED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">addr</span> <span class="o">|</span> <span class="n">pte_flags</span><span class="p">,</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">gtt</span> <span class="o">+</span> <span class="n">entry</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">aper_size_info_fixed</span> <span class="n">intel_fake_agp_sizes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">32</span><span class="p">,</span> <span class="mi">8192</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">64</span><span class="p">,</span> <span class="mi">16384</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">128</span><span class="p">,</span> <span class="mi">32768</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">256</span><span class="p">,</span> <span class="mi">65536</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">512</span><span class="p">,</span> <span class="mi">131072</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">intel_gtt_stolen_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">gmch_ctrl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rdct</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">local</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ddt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stolen_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_GTT_GEN</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* no stolen mem on i81x */</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="p">,</span>
			     <span class="n">I830_GMCH_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gmch_ctrl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_INTEL_82830_HB</span> <span class="o">||</span>
	    <span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_INTEL_82845G_HB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">gmch_ctrl</span> <span class="o">&amp;</span> <span class="n">I830_GMCH_GMS_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">I830_GMCH_GMS_STOLEN_512</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">KB</span><span class="p">(</span><span class="mi">512</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I830_GMCH_GMS_STOLEN_1024</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I830_GMCH_GMS_STOLEN_8192</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I830_GMCH_GMS_LOCAL</span>:
			<span class="n">rdct</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="o">+</span><span class="n">I830_RDRAM_CHANNEL_TYPE</span><span class="p">);</span>
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">I830_RDRAM_ND</span><span class="p">(</span><span class="n">rdct</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
					<span class="n">MB</span><span class="p">(</span><span class="n">ddt</span><span class="p">[</span><span class="n">I830_RDRAM_DDT</span><span class="p">(</span><span class="n">rdct</span><span class="p">)]);</span>
			<span class="n">local</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">INTEL_GTT_GEN</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * SandyBridge has new memory control reg at 0x50.w</span>
<span class="cm">		 */</span>
		<span class="n">u16</span> <span class="n">snb_gmch_ctl</span><span class="p">;</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">SNB_GMCH_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snb_gmch_ctl</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">snb_gmch_ctl</span> <span class="o">&amp;</span> <span class="n">SNB_GMCH_GMS_STOLEN_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SNB_GMCH_GMS_STOLEN_32M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNB_GMCH_GMS_STOLEN_64M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNB_GMCH_GMS_STOLEN_96M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">96</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNB_GMCH_GMS_STOLEN_128M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNB_GMCH_GMS_STOLEN_160M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">160</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNB_GMCH_GMS_STOLEN_192M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">192</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNB_GMCH_GMS_STOLEN_224M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">224</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNB_GMCH_GMS_STOLEN_256M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNB_GMCH_GMS_STOLEN_288M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">288</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNB_GMCH_GMS_STOLEN_320M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">320</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNB_GMCH_GMS_STOLEN_352M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">352</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNB_GMCH_GMS_STOLEN_384M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">384</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNB_GMCH_GMS_STOLEN_416M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">416</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNB_GMCH_GMS_STOLEN_448M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">448</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNB_GMCH_GMS_STOLEN_480M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">480</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNB_GMCH_GMS_STOLEN_512M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">512</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">gmch_ctrl</span> <span class="o">&amp;</span> <span class="n">I855_GMCH_GMS_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">I855_GMCH_GMS_STOLEN_1M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I855_GMCH_GMS_STOLEN_4M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I855_GMCH_GMS_STOLEN_8M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I855_GMCH_GMS_STOLEN_16M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I855_GMCH_GMS_STOLEN_32M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I915_GMCH_GMS_STOLEN_48M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">48</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I915_GMCH_GMS_STOLEN_64M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">G33_GMCH_GMS_STOLEN_128M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">G33_GMCH_GMS_STOLEN_256M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_GMCH_GMS_STOLEN_96M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">96</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_GMCH_GMS_STOLEN_160M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">160</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_GMCH_GMS_STOLEN_224M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">224</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_GMCH_GMS_STOLEN_352M</span>:
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">352</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">stolen_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stolen_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;detected %dK %s memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">stolen_size</span> <span class="o">/</span> <span class="n">KB</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">local</span> <span class="o">?</span> <span class="s">&quot;local&quot;</span> <span class="o">:</span> <span class="s">&quot;stolen&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		       <span class="s">&quot;no pre-allocated video memory detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">stolen_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">stolen_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i965_adjust_pgetbl_size</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pgetbl_ctl</span><span class="p">,</span> <span class="n">pgetbl_ctl2</span><span class="p">;</span>

	<span class="cm">/* ensure that ppgtt is disabled */</span>
	<span class="n">pgetbl_ctl2</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="o">+</span><span class="n">I965_PGETBL_CTL2</span><span class="p">);</span>
	<span class="n">pgetbl_ctl2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I810_PGETBL_ENABLED</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pgetbl_ctl2</span><span class="p">,</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="o">+</span><span class="n">I965_PGETBL_CTL2</span><span class="p">);</span>

	<span class="cm">/* write the new ggtt size */</span>
	<span class="n">pgetbl_ctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="o">+</span><span class="n">I810_PGETBL_CTL</span><span class="p">);</span>
	<span class="n">pgetbl_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I965_PGETBL_SIZE_MASK</span><span class="p">;</span>
	<span class="n">pgetbl_ctl</span> <span class="o">|=</span> <span class="n">size_flag</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pgetbl_ctl</span><span class="p">,</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="o">+</span><span class="n">I810_PGETBL_CTL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">i965_gtt_total_entries</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pgetbl_ctl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gmch_ctl</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="p">,</span>
			     <span class="n">I830_GMCH_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gmch_ctl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_GTT_GEN</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">gmch_ctl</span> <span class="o">&amp;</span> <span class="n">G4x_GMCH_SIZE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">G4x_GMCH_SIZE_1M</span>:
		<span class="k">case</span> <span class="n">G4x_GMCH_SIZE_VT_1M</span>:
			<span class="n">i965_adjust_pgetbl_size</span><span class="p">(</span><span class="n">I965_PGETBL_SIZE_1MB</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">G4x_GMCH_SIZE_VT_1_5M</span>:
			<span class="n">i965_adjust_pgetbl_size</span><span class="p">(</span><span class="n">I965_PGETBL_SIZE_1_5MB</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">G4x_GMCH_SIZE_2M</span>:
		<span class="k">case</span> <span class="n">G4x_GMCH_SIZE_VT_2M</span>:
			<span class="n">i965_adjust_pgetbl_size</span><span class="p">(</span><span class="n">I965_PGETBL_SIZE_2MB</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pgetbl_ctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="o">+</span><span class="n">I810_PGETBL_CTL</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pgetbl_ctl</span> <span class="o">&amp;</span> <span class="n">I965_PGETBL_SIZE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I965_PGETBL_SIZE_128KB</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="n">KB</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I965_PGETBL_SIZE_256KB</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="n">KB</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I965_PGETBL_SIZE_512KB</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="n">KB</span><span class="p">(</span><span class="mi">512</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* GTT pagetable sizes bigger than 512KB are not possible on G33! */</span>
	<span class="k">case</span> <span class="n">I965_PGETBL_SIZE_1MB</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="n">KB</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I965_PGETBL_SIZE_2MB</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="n">KB</span><span class="p">(</span><span class="mi">2048</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I965_PGETBL_SIZE_1_5MB</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="n">KB</span><span class="p">(</span><span class="mi">1024</span> <span class="o">+</span> <span class="mi">512</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;unknown page table size, assuming 512KB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">KB</span><span class="p">(</span><span class="mi">512</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">size</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">intel_gtt_total_entries</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_G33</span> <span class="o">||</span> <span class="n">INTEL_GTT_GEN</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">INTEL_GTT_GEN</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">i965_gtt_total_entries</span><span class="p">();</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">INTEL_GTT_GEN</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">snb_gmch_ctl</span><span class="p">;</span>

		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">SNB_GMCH_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snb_gmch_ctl</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">snb_gmch_ctl</span> <span class="o">&amp;</span> <span class="n">SNB_GTT_SIZE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">SNB_GTT_SIZE_0M</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Bad GTT size mask: 0x%04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">snb_gmch_ctl</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNB_GTT_SIZE_1M</span>:
			<span class="n">size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SNB_GTT_SIZE_2M</span>:
			<span class="n">size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">size</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* On previous hardware, the GTT size was just what was</span>
<span class="cm">		 * required to map the aperture.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">gtt_mappable_entries</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">intel_gtt_mappable_entries</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">aperture_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_GTT_GEN</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">smram_miscc</span><span class="p">;</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="p">,</span>
				      <span class="n">I810_SMRAM_MISCC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smram_miscc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">smram_miscc</span> <span class="o">&amp;</span> <span class="n">I810_GFX_MEM_WIN_SIZE</span><span class="p">)</span>
				<span class="o">==</span> <span class="n">I810_GFX_MEM_WIN_32M</span><span class="p">)</span>
			<span class="n">aperture_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">aperture_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">INTEL_GTT_GEN</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">gmch_ctrl</span><span class="p">;</span>

		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="p">,</span>
				     <span class="n">I830_GMCH_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gmch_ctrl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">gmch_ctrl</span> <span class="o">&amp;</span> <span class="n">I830_GMCH_MEM_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">I830_GMCH_MEM_64M</span><span class="p">)</span>
			<span class="n">aperture_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">aperture_size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* 9xx supports large sizes, just look at the length */</span>
		<span class="n">aperture_size</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">aperture_size</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_gtt_teardown_scratch_page</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_pages_wb</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">scratch_page</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">scratch_page_dma</span><span class="p">,</span>
		       <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="n">put_page</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">scratch_page</span><span class="p">);</span>
	<span class="n">__free_page</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">scratch_page</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_gtt_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">intel_private</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">();</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">gtt</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="p">);</span>

	<span class="n">intel_gtt_teardown_scratch_page</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_gtt_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gtt_map_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">gtt_mappable_entries</span> <span class="o">=</span> <span class="n">intel_gtt_mappable_entries</span><span class="p">();</span>
	<span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">gtt_total_entries</span> <span class="o">=</span> <span class="n">intel_gtt_total_entries</span><span class="p">();</span>

	<span class="cm">/* save the PGETBL reg for resume */</span>
	<span class="n">intel_private</span><span class="p">.</span><span class="n">PGETBL_save</span> <span class="o">=</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="o">+</span><span class="n">I810_PGETBL_CTL</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="o">~</span><span class="n">I810_PGETBL_ENABLED</span><span class="p">;</span>
	<span class="cm">/* we only ever restore the register when enabling the PGTBL... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PGTBL_EN</span><span class="p">)</span>
		<span class="n">intel_private</span><span class="p">.</span><span class="n">PGETBL_save</span> <span class="o">|=</span> <span class="n">I810_PGETBL_ENABLED</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;detected gtt size: %dK total, %dK mappable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">gtt_total_entries</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
			<span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">gtt_mappable_entries</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">gtt_map_size</span> <span class="o">=</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">gtt_total_entries</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">intel_private</span><span class="p">.</span><span class="n">gtt</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">gtt_bus_addr</span><span class="p">,</span>
				    <span class="n">gtt_map_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_private</span><span class="p">.</span><span class="n">gtt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_private</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">();</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">gtt</span> <span class="o">=</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">gtt</span><span class="p">;</span>

	<span class="n">global_cache_flush</span><span class="p">();</span>   <span class="cm">/* FIXME: ? */</span>

	<span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">stolen_size</span> <span class="o">=</span> <span class="n">intel_gtt_stolen_size</span><span class="p">();</span>

	<span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">needs_dmar</span> <span class="o">=</span> <span class="n">USE_PCI_DMA_API</span> <span class="o">&amp;&amp;</span> <span class="n">INTEL_GTT_GEN</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_gtt_setup_scratch_page</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_gtt_cleanup</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_fake_agp_fetch_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_sizes</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">intel_fake_agp_sizes</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">aper_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">aper_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">gtt_mappable_entries</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span>
		    <span class="o">/</span> <span class="n">MB</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_sizes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aper_size</span> <span class="o">==</span> <span class="n">intel_fake_agp_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">current_size</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">intel_fake_agp_sizes</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">aper_size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i830_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/* The chipset_flush interface needs to get data that has already been</span>
<span class="cm"> * flushed out of the CPU all the way out to main memory, because the GPU</span>
<span class="cm"> * doesn&#39;t snoop those buffers.</span>
<span class="cm"> *</span>
<span class="cm"> * The 8xx series doesn&#39;t have the same lovely interface for flushing the</span>
<span class="cm"> * chipset write buffers that the later chips do. According to the 865</span>
<span class="cm"> * specs, it&#39;s 64 octwords, or 1KB.  So, to get those previous things in</span>
<span class="cm"> * that buffer out, we just fill 1KB and clflush it out, on the assumption</span>
<span class="cm"> * that it&#39;ll push whatever was in there out.  It appears to work.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i830_chipset_flush</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/* Forcibly evict everything from the CPU write buffers.</span>
<span class="cm">	 * clflush appears to be insufficient.</span>
<span class="cm">	 */</span>
	<span class="n">wbinvd_on_all_cpus</span><span class="p">();</span>

	<span class="cm">/* Now we&#39;ve only seen documents for this magic bit on 855GM,</span>
<span class="cm">	 * we hope it exists for the other gen2 chipsets...</span>
<span class="cm">	 *</span>
<span class="cm">	 * Also works as advertised on my 845G.</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="o">+</span><span class="n">I830_HIC</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">),</span>
	       <span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="o">+</span><span class="n">I830_HIC</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="o">+</span><span class="n">I830_HIC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i830_write_entry</span><span class="p">(</span><span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entry</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pte_flags</span> <span class="o">=</span> <span class="n">I810_PTE_VALID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span>  <span class="n">AGP_USER_CACHED_MEMORY</span><span class="p">)</span>
		<span class="n">pte_flags</span> <span class="o">|=</span> <span class="n">I830_PTE_SYSTEM_CACHED</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">addr</span> <span class="o">|</span> <span class="n">pte_flags</span><span class="p">,</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">gtt</span> <span class="o">+</span> <span class="n">entry</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_enable_gtt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gma_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_GTT_GEN</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">I810_GMADDR</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">gma_addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">I915_GMADDR</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">gma_addr</span><span class="p">);</span>

	<span class="n">intel_private</span><span class="p">.</span><span class="n">gma_bus_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">gma_addr</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_GTT_GEN</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span>
	    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_GTT_GEN</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">gmch_ctrl</span><span class="p">;</span>

		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="p">,</span>
				     <span class="n">I830_GMCH_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gmch_ctrl</span><span class="p">);</span>
		<span class="n">gmch_ctrl</span> <span class="o">|=</span> <span class="n">I830_GMCH_ENABLED</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="p">,</span>
				      <span class="n">I830_GMCH_CTRL</span><span class="p">,</span> <span class="n">gmch_ctrl</span><span class="p">);</span>

		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="p">,</span>
				     <span class="n">I830_GMCH_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gmch_ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">gmch_ctrl</span> <span class="o">&amp;</span> <span class="n">I830_GMCH_ENABLED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;failed to enable the GTT: GMCH_CTRL=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">gmch_ctrl</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* On the resume path we may be adjusting the PGTBL value, so</span>
<span class="cm">	 * be paranoid and flush all chipset write buffers...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_GTT_GEN</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="o">+</span><span class="n">GFX_FLSH_CNTL</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="o">+</span><span class="n">I810_PGETBL_CTL</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">PGETBL_save</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PGTBL_EN</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">I810_PGETBL_ENABLED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;failed to enable the GTT: PGETBL=%x [expected %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">),</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">PGETBL_save</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_GTT_GEN</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="o">+</span><span class="n">GFX_FLSH_CNTL</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i830_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg_addr</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">I810_MMADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_addr</span><span class="p">);</span>
	<span class="n">reg_addr</span> <span class="o">&amp;=</span> <span class="mh">0xfff80000</span><span class="p">;</span>

	<span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">reg_addr</span><span class="p">,</span> <span class="n">KB</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">intel_private</span><span class="p">.</span><span class="n">gtt_bus_addr</span> <span class="o">=</span> <span class="n">reg_addr</span> <span class="o">+</span> <span class="n">I810_PTE_BASE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_fake_agp_create_gatt_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">agp_bridge_data</span> <span class="o">*</span><span class="n">bridge</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">gatt_table_real</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">gatt_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">gatt_bus_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_fake_agp_free_gatt_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">agp_bridge_data</span> <span class="o">*</span><span class="n">bridge</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_fake_agp_configure</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_enable_gtt</span><span class="p">())</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">intel_private</span><span class="p">.</span><span class="n">clear_fake_agp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">gart_bus_addr</span> <span class="o">=</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">gma_bus_addr</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">i830_check_flags</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="n">AGP_PHYS_MEMORY</span>:
	<span class="k">case</span> <span class="n">AGP_USER_CACHED_MEMORY</span>:
	<span class="k">case</span> <span class="n">AGP_USER_MEMORY</span>:
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_gtt_insert_sg_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg_list</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pg_start</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">j</span> <span class="o">=</span> <span class="n">pg_start</span><span class="p">;</span>

	<span class="cm">/* sg may merge pages, but we have to separate</span>
<span class="cm">	 * per-page addr for GTT */</span>
	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sg_list</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_addr_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
			<span class="n">intel_private</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">write_entry</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span>
							  <span class="n">j</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">gtt</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">intel_gtt_insert_sg_entries</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">intel_gtt_insert_pages</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">first_entry</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_entries</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">first_entry</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">page_to_phys</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">intel_private</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">write_entry</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span>
						  <span class="n">j</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">gtt</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">intel_gtt_insert_pages</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_fake_agp_insert_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">agp_memory</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span>
					 <span class="kt">off_t</span> <span class="n">pg_start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">do_idle_maps</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">clear_fake_agp</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">stolen_size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">end</span> <span class="o">=</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">gtt_mappable_entries</span><span class="p">;</span>
		<span class="n">intel_gtt_clear_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
		<span class="n">intel_private</span><span class="p">.</span><span class="n">clear_fake_agp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_GTT_GEN</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">==</span> <span class="n">AGP_DCACHE_MEMORY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">i810_insert_dcache_entries</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">pg_start</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">page_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pg_start</span> <span class="o">+</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">page_count</span> <span class="o">&gt;</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">gtt_total_entries</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_private</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">check_flags</span><span class="p">(</span><span class="n">type</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">is_flushed</span><span class="p">)</span>
		<span class="n">global_cache_flush</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">needs_dmar</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_gtt_map_memory</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">page_count</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">num_sg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">intel_gtt_insert_sg_entries</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">num_sg</span><span class="p">,</span>
					    <span class="n">pg_start</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">intel_gtt_insert_pages</span><span class="p">(</span><span class="n">pg_start</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">page_count</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span>
				       <span class="n">type</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_err:</span>
	<span class="n">mem</span><span class="o">-&gt;</span><span class="n">is_flushed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_gtt_clear_range</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">first_entry</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">first_entry</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">first_entry</span> <span class="o">+</span> <span class="n">num_entries</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_private</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">write_entry</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">scratch_page_dma</span><span class="p">,</span>
						  <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">gtt</span><span class="o">+</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">intel_gtt_clear_range</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_fake_agp_remove_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">agp_memory</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span>
					 <span class="kt">off_t</span> <span class="n">pg_start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">page_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">do_idle_maps</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">intel_gtt_clear_range</span><span class="p">(</span><span class="n">pg_start</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">page_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">needs_dmar</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_gtt_unmap_memory</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">num_sg</span><span class="p">);</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">sg_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">num_sg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">agp_memory</span> <span class="o">*</span><span class="nf">intel_fake_agp_alloc_by_type</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">pg_count</span><span class="p">,</span>
						       <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">agp_memory</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">AGP_DCACHE_MEMORY</span> <span class="o">&amp;&amp;</span> <span class="n">INTEL_GTT_GEN</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pg_count</span> <span class="o">!=</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">num_dcache_entries</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">new</span> <span class="o">=</span> <span class="n">agp_create_memory</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">new</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">AGP_DCACHE_MEMORY</span><span class="p">;</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">page_count</span> <span class="o">=</span> <span class="n">pg_count</span><span class="p">;</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">num_scratch_pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">agp_free_page_array</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">new</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">AGP_PHYS_MEMORY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">alloc_agpphysmem_i8xx</span><span class="p">(</span><span class="n">pg_count</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="cm">/* always return NULL for other allocation types for now */</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_alloc_chipset_flush_resource</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_bus_alloc_resource</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_private</span><span class="p">.</span><span class="n">ifp_resource</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
				     <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PCIBIOS_MIN_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="n">pcibios_align_resource</span><span class="p">,</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_i915_setup_chipset_flush</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">I915_IFPADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">intel_alloc_chipset_flush_resource</span><span class="p">();</span>
		<span class="n">intel_private</span><span class="p">.</span><span class="n">resource_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">I915_IFPADDR</span><span class="p">,</span> <span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">ifp_resource</span><span class="p">.</span><span class="n">start</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">intel_private</span><span class="p">.</span><span class="n">resource_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">intel_private</span><span class="p">.</span><span class="n">ifp_resource</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">intel_private</span><span class="p">.</span><span class="n">ifp_resource</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_private</span><span class="p">.</span><span class="n">ifp_resource</span><span class="p">);</span>
		<span class="cm">/* some BIOSes reserve this area in a pnp some don&#39;t */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">intel_private</span><span class="p">.</span><span class="n">resource_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_i965_g33_setup_chipset_flush</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp_hi</span><span class="p">,</span> <span class="n">temp_lo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">I965_IFPADDR</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_hi</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">I965_IFPADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_lo</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp_lo</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">intel_alloc_chipset_flush_resource</span><span class="p">();</span>

		<span class="n">intel_private</span><span class="p">.</span><span class="n">resource_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">I965_IFPADDR</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
			<span class="n">upper_32_bits</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">ifp_resource</span><span class="p">.</span><span class="n">start</span><span class="p">));</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">I965_IFPADDR</span><span class="p">,</span> <span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">ifp_resource</span><span class="p">.</span><span class="n">start</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">l64</span><span class="p">;</span>

		<span class="n">temp_lo</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">;</span>
		<span class="n">l64</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">temp_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">temp_lo</span><span class="p">;</span>

		<span class="n">intel_private</span><span class="p">.</span><span class="n">resource_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">intel_private</span><span class="p">.</span><span class="n">ifp_resource</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">l64</span><span class="p">;</span>
		<span class="n">intel_private</span><span class="p">.</span><span class="n">ifp_resource</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">l64</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_private</span><span class="p">.</span><span class="n">ifp_resource</span><span class="p">);</span>
		<span class="cm">/* some BIOSes reserve this area in a pnp some don&#39;t */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">intel_private</span><span class="p">.</span><span class="n">resource_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_i9xx_setup_flush</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* return if already configured */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">ifp_resource</span><span class="p">.</span><span class="n">start</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_GTT_GEN</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* setup a resource for this object */</span>
	<span class="n">intel_private</span><span class="p">.</span><span class="n">ifp_resource</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel Flush Page&quot;</span><span class="p">;</span>
	<span class="n">intel_private</span><span class="p">.</span><span class="n">ifp_resource</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>

	<span class="cm">/* Setup chipset flush for 915 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_G33</span> <span class="o">||</span> <span class="n">INTEL_GTT_GEN</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_i965_g33_setup_chipset_flush</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">intel_i915_setup_chipset_flush</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">ifp_resource</span><span class="p">.</span><span class="n">start</span><span class="p">)</span>
		<span class="n">intel_private</span><span class="p">.</span><span class="n">i9xx_flush_page</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">ifp_resource</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_private</span><span class="p">.</span><span class="n">i9xx_flush_page</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;can&#39;t ioremap flush page - no chipset flushing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i9xx_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">i9xx_flush_page</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">i9xx_flush_page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">resource_valid</span><span class="p">)</span>
		<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_private</span><span class="p">.</span><span class="n">ifp_resource</span><span class="p">);</span>
	<span class="n">intel_private</span><span class="p">.</span><span class="n">ifp_resource</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">intel_private</span><span class="p">.</span><span class="n">resource_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i9xx_chipset_flush</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">i9xx_flush_page</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">i9xx_flush_page</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i965_write_entry</span><span class="p">(</span><span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entry</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pte_flags</span><span class="p">;</span>

	<span class="n">pte_flags</span> <span class="o">=</span> <span class="n">I810_PTE_VALID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="n">AGP_USER_CACHED_MEMORY</span><span class="p">)</span>
		<span class="n">pte_flags</span> <span class="o">|=</span> <span class="n">I830_PTE_SYSTEM_CACHED</span><span class="p">;</span>

	<span class="cm">/* Shift high bits down */</span>
	<span class="n">addr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">addr</span> <span class="o">|</span> <span class="n">pte_flags</span><span class="p">,</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">gtt</span> <span class="o">+</span> <span class="n">entry</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">gen6_check_flags</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gen6_write_entry</span><span class="p">(</span><span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entry</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type_mask</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AGP_USER_CACHED_MEMORY_GFDT</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gfdt</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AGP_USER_CACHED_MEMORY_GFDT</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pte_flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type_mask</span> <span class="o">==</span> <span class="n">AGP_USER_MEMORY</span><span class="p">)</span>
		<span class="n">pte_flags</span> <span class="o">=</span> <span class="n">GEN6_PTE_UNCACHED</span> <span class="o">|</span> <span class="n">I810_PTE_VALID</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type_mask</span> <span class="o">==</span> <span class="n">AGP_USER_CACHED_MEMORY_LLC_MLC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pte_flags</span> <span class="o">=</span> <span class="n">GEN6_PTE_LLC_MLC</span> <span class="o">|</span> <span class="n">I810_PTE_VALID</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfdt</span><span class="p">)</span>
			<span class="n">pte_flags</span> <span class="o">|=</span> <span class="n">GEN6_PTE_GFDT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* set &#39;normal&#39;/&#39;cached&#39; to LLC by default */</span>
		<span class="n">pte_flags</span> <span class="o">=</span> <span class="n">GEN6_PTE_LLC</span> <span class="o">|</span> <span class="n">I810_PTE_VALID</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gfdt</span><span class="p">)</span>
			<span class="n">pte_flags</span> <span class="o">|=</span> <span class="n">GEN6_PTE_GFDT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* gen6 has bit11-4 for physical addr bit39-32 */</span>
	<span class="n">addr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff0</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">addr</span> <span class="o">|</span> <span class="n">pte_flags</span><span class="p">,</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">gtt</span> <span class="o">+</span> <span class="n">entry</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">valleyview_write_entry</span><span class="p">(</span><span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entry</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pte_flags</span><span class="p">;</span>

	<span class="n">pte_flags</span> <span class="o">=</span> <span class="n">GEN6_PTE_UNCACHED</span> <span class="o">|</span> <span class="n">I810_PTE_VALID</span><span class="p">;</span>

	<span class="cm">/* gen6 has bit11-4 for physical addr bit39-32 */</span>
	<span class="n">addr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff0</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">addr</span> <span class="o">|</span> <span class="n">pte_flags</span><span class="p">,</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">gtt</span> <span class="o">+</span> <span class="n">entry</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span> <span class="o">+</span> <span class="n">GFX_FLSH_CNTL_VLV</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gen6_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/* Certain Gen5 chipsets require require idling the GPU before</span>
<span class="cm"> * unmapping anything from the GTT when VT-d is enabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">needs_idle_maps</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_INTEL_IOMMU</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">gpu_devid</span> <span class="o">=</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="cm">/* Query intel_iommu to see if we need the workaround. Presumably that</span>
<span class="cm">	 * was loaded first.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">gpu_devid</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_INTEL_IRONLAKE_M_HB</span> <span class="o">||</span>
	     <span class="n">gpu_devid</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_INTEL_IRONLAKE_M_IG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">intel_iommu_gfx_mapped</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i9xx_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">KB</span><span class="p">(</span><span class="mi">512</span><span class="p">);</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">I915_MMADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_addr</span><span class="p">);</span>

	<span class="n">reg_addr</span> <span class="o">&amp;=</span> <span class="mh">0xfff80000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_GTT_GEN</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">reg_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_private</span><span class="p">.</span><span class="n">registers</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_GTT_GEN</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">gtt_addr</span><span class="p">;</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="p">,</span>
				      <span class="n">I915_PTEADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gtt_addr</span><span class="p">);</span>
		<span class="n">intel_private</span><span class="p">.</span><span class="n">gtt_bus_addr</span> <span class="o">=</span> <span class="n">gtt_addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">gtt_offset</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">INTEL_GTT_GEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">5</span>:
		<span class="k">case</span> <span class="mi">6</span>:
			<span class="n">gtt_offset</span> <span class="o">=</span> <span class="n">MB</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
		<span class="nl">default:</span>
			<span class="n">gtt_offset</span> <span class="o">=</span>  <span class="n">KB</span><span class="p">(</span><span class="mi">512</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">intel_private</span><span class="p">.</span><span class="n">gtt_bus_addr</span> <span class="o">=</span> <span class="n">reg_addr</span> <span class="o">+</span> <span class="n">gtt_offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">needs_idle_maps</span><span class="p">())</span>
		<span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">do_idle_maps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">intel_i9xx_setup_flush</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">agp_bridge_driver</span> <span class="n">intel_fake_agp_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size_type</span>		<span class="o">=</span> <span class="n">FIXED_APER_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">aperture_sizes</span>		<span class="o">=</span> <span class="n">intel_fake_agp_sizes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_aperture_sizes</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">intel_fake_agp_sizes</span><span class="p">),</span>
	<span class="p">.</span><span class="n">configure</span>		<span class="o">=</span> <span class="n">intel_fake_agp_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fetch_size</span>		<span class="o">=</span> <span class="n">intel_fake_agp_fetch_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span>		<span class="o">=</span> <span class="n">intel_gtt_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agp_enable</span>		<span class="o">=</span> <span class="n">intel_fake_agp_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cache_flush</span>		<span class="o">=</span> <span class="n">global_cache_flush</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create_gatt_table</span>	<span class="o">=</span> <span class="n">intel_fake_agp_create_gatt_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_gatt_table</span>	<span class="o">=</span> <span class="n">intel_fake_agp_free_gatt_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">insert_memory</span>		<span class="o">=</span> <span class="n">intel_fake_agp_insert_entries</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_memory</span>		<span class="o">=</span> <span class="n">intel_fake_agp_remove_entries</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_by_type</span>		<span class="o">=</span> <span class="n">intel_fake_agp_alloc_by_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_by_type</span>		<span class="o">=</span> <span class="n">intel_i810_free_by_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agp_alloc_page</span>		<span class="o">=</span> <span class="n">agp_generic_alloc_page</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agp_alloc_pages</span>        <span class="o">=</span> <span class="n">agp_generic_alloc_pages</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agp_destroy_page</span>	<span class="o">=</span> <span class="n">agp_generic_destroy_page</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agp_destroy_pages</span>      <span class="o">=</span> <span class="n">agp_generic_destroy_pages</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_gtt_driver</span> <span class="n">i81x_gtt_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">has_pgtbl_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_mask_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">i810_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">i810_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_flags</span> <span class="o">=</span> <span class="n">i830_check_flags</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_entry</span> <span class="o">=</span> <span class="n">i810_write_entry</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_gtt_driver</span> <span class="n">i8xx_gtt_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gen</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">has_pgtbl_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">i830_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">i830_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_entry</span> <span class="o">=</span> <span class="n">i830_write_entry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_mask_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_flags</span> <span class="o">=</span> <span class="n">i830_check_flags</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chipset_flush</span> <span class="o">=</span> <span class="n">i830_chipset_flush</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_gtt_driver</span> <span class="n">i915_gtt_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gen</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">has_pgtbl_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">i9xx_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">i9xx_cleanup</span><span class="p">,</span>
	<span class="cm">/* i945 is the last gpu to need phys mem (for overlay and cursors). */</span>
	<span class="p">.</span><span class="n">write_entry</span> <span class="o">=</span> <span class="n">i830_write_entry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_mask_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_flags</span> <span class="o">=</span> <span class="n">i830_check_flags</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chipset_flush</span> <span class="o">=</span> <span class="n">i9xx_chipset_flush</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_gtt_driver</span> <span class="n">g33_gtt_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gen</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_g33</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">i9xx_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">i9xx_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_entry</span> <span class="o">=</span> <span class="n">i965_write_entry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_mask_size</span> <span class="o">=</span> <span class="mi">36</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_flags</span> <span class="o">=</span> <span class="n">i830_check_flags</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chipset_flush</span> <span class="o">=</span> <span class="n">i9xx_chipset_flush</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_gtt_driver</span> <span class="n">pineview_gtt_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gen</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_pineview</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">is_g33</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">i9xx_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">i9xx_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_entry</span> <span class="o">=</span> <span class="n">i965_write_entry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_mask_size</span> <span class="o">=</span> <span class="mi">36</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_flags</span> <span class="o">=</span> <span class="n">i830_check_flags</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chipset_flush</span> <span class="o">=</span> <span class="n">i9xx_chipset_flush</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_gtt_driver</span> <span class="n">i965_gtt_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gen</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">has_pgtbl_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">i9xx_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">i9xx_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_entry</span> <span class="o">=</span> <span class="n">i965_write_entry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_mask_size</span> <span class="o">=</span> <span class="mi">36</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_flags</span> <span class="o">=</span> <span class="n">i830_check_flags</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chipset_flush</span> <span class="o">=</span> <span class="n">i9xx_chipset_flush</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_gtt_driver</span> <span class="n">g4x_gtt_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gen</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">i9xx_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">i9xx_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_entry</span> <span class="o">=</span> <span class="n">i965_write_entry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_mask_size</span> <span class="o">=</span> <span class="mi">36</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_flags</span> <span class="o">=</span> <span class="n">i830_check_flags</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chipset_flush</span> <span class="o">=</span> <span class="n">i9xx_chipset_flush</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_gtt_driver</span> <span class="n">ironlake_gtt_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gen</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_ironlake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">i9xx_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">i9xx_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_entry</span> <span class="o">=</span> <span class="n">i965_write_entry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_mask_size</span> <span class="o">=</span> <span class="mi">36</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_flags</span> <span class="o">=</span> <span class="n">i830_check_flags</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chipset_flush</span> <span class="o">=</span> <span class="n">i9xx_chipset_flush</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_gtt_driver</span> <span class="n">sandybridge_gtt_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gen</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">i9xx_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">gen6_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_entry</span> <span class="o">=</span> <span class="n">gen6_write_entry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_mask_size</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_flags</span> <span class="o">=</span> <span class="n">gen6_check_flags</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chipset_flush</span> <span class="o">=</span> <span class="n">i9xx_chipset_flush</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_gtt_driver</span> <span class="n">valleyview_gtt_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gen</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">i9xx_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">gen6_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_entry</span> <span class="o">=</span> <span class="n">valleyview_write_entry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_mask_size</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_flags</span> <span class="o">=</span> <span class="n">gen6_check_flags</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chipset_flush</span> <span class="o">=</span> <span class="n">i9xx_chipset_flush</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Table to describe Intel GMCH and AGP/PCIE GART drivers.  At least one of</span>
<span class="cm"> * driver and gmch_driver must be non-null, and find_gmch will determine</span>
<span class="cm"> * which one should be used if a gmch_chip_id is present.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_gtt_driver_description</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gmch_chip_id</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">intel_gtt_driver</span> <span class="o">*</span><span class="n">gtt_driver</span><span class="p">;</span>
<span class="p">}</span> <span class="n">intel_gtt_chipsets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82810_IG1</span><span class="p">,</span> <span class="s">&quot;i810&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i81x_gtt_driver</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82810_IG3</span><span class="p">,</span> <span class="s">&quot;i810&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i81x_gtt_driver</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82810E_IG</span><span class="p">,</span> <span class="s">&quot;i810&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i81x_gtt_driver</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82815_CGC</span><span class="p">,</span> <span class="s">&quot;i815&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i81x_gtt_driver</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82830_CGC</span><span class="p">,</span> <span class="s">&quot;830M&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i8xx_gtt_driver</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82845G_IG</span><span class="p">,</span> <span class="s">&quot;845G&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i8xx_gtt_driver</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82854_IG</span><span class="p">,</span> <span class="s">&quot;854&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i8xx_gtt_driver</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82855GM_IG</span><span class="p">,</span> <span class="s">&quot;855GM&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i8xx_gtt_driver</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82865_IG</span><span class="p">,</span> <span class="s">&quot;865&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i8xx_gtt_driver</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_E7221_IG</span><span class="p">,</span> <span class="s">&quot;E7221 (i915)&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i915_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82915G_IG</span><span class="p">,</span> <span class="s">&quot;915G&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i915_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82915GM_IG</span><span class="p">,</span> <span class="s">&quot;915GM&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i915_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82945G_IG</span><span class="p">,</span> <span class="s">&quot;945G&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i915_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82945GM_IG</span><span class="p">,</span> <span class="s">&quot;945GM&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i915_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82945GME_IG</span><span class="p">,</span> <span class="s">&quot;945GME&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i915_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82946GZ_IG</span><span class="p">,</span> <span class="s">&quot;946GZ&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i965_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82G35_IG</span><span class="p">,</span> <span class="s">&quot;G35&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i965_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82965Q_IG</span><span class="p">,</span> <span class="s">&quot;965Q&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i965_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82965G_IG</span><span class="p">,</span> <span class="s">&quot;965G&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i965_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82965GM_IG</span><span class="p">,</span> <span class="s">&quot;965GM&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i965_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82965GME_IG</span><span class="p">,</span> <span class="s">&quot;965GME/GLE&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">i965_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_G33_IG</span><span class="p">,</span> <span class="s">&quot;G33&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">g33_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_Q35_IG</span><span class="p">,</span> <span class="s">&quot;Q35&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">g33_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_Q33_IG</span><span class="p">,</span> <span class="s">&quot;Q33&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">g33_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_PINEVIEW_M_IG</span><span class="p">,</span> <span class="s">&quot;GMA3150&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">pineview_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_PINEVIEW_IG</span><span class="p">,</span> <span class="s">&quot;GMA3150&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">pineview_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_GM45_IG</span><span class="p">,</span> <span class="s">&quot;GM45&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">g4x_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_EAGLELAKE_IG</span><span class="p">,</span> <span class="s">&quot;Eaglelake&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">g4x_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_Q45_IG</span><span class="p">,</span> <span class="s">&quot;Q45/Q43&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">g4x_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_G45_IG</span><span class="p">,</span> <span class="s">&quot;G45/G43&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">g4x_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_B43_IG</span><span class="p">,</span> <span class="s">&quot;B43&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">g4x_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_B43_1_IG</span><span class="p">,</span> <span class="s">&quot;B43&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">g4x_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_G41_IG</span><span class="p">,</span> <span class="s">&quot;G41&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">g4x_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_IRONLAKE_D_IG</span><span class="p">,</span>
	    <span class="s">&quot;HD Graphics&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ironlake_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_IRONLAKE_M_IG</span><span class="p">,</span>
	    <span class="s">&quot;HD Graphics&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ironlake_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_SANDYBRIDGE_GT1_IG</span><span class="p">,</span>
	    <span class="s">&quot;Sandybridge&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_SANDYBRIDGE_GT2_IG</span><span class="p">,</span>
	    <span class="s">&quot;Sandybridge&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_SANDYBRIDGE_GT2_PLUS_IG</span><span class="p">,</span>
	    <span class="s">&quot;Sandybridge&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_SANDYBRIDGE_M_GT1_IG</span><span class="p">,</span>
	    <span class="s">&quot;Sandybridge&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_SANDYBRIDGE_M_GT2_IG</span><span class="p">,</span>
	    <span class="s">&quot;Sandybridge&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_SANDYBRIDGE_M_GT2_PLUS_IG</span><span class="p">,</span>
	    <span class="s">&quot;Sandybridge&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_SANDYBRIDGE_S_IG</span><span class="p">,</span>
	    <span class="s">&quot;Sandybridge&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_IVYBRIDGE_GT1_IG</span><span class="p">,</span>
	    <span class="s">&quot;Ivybridge&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_IVYBRIDGE_GT2_IG</span><span class="p">,</span>
	    <span class="s">&quot;Ivybridge&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_IVYBRIDGE_M_GT1_IG</span><span class="p">,</span>
	    <span class="s">&quot;Ivybridge&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_IVYBRIDGE_M_GT2_IG</span><span class="p">,</span>
	    <span class="s">&quot;Ivybridge&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_IVYBRIDGE_S_GT1_IG</span><span class="p">,</span>
	    <span class="s">&quot;Ivybridge&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_IVYBRIDGE_S_GT2_IG</span><span class="p">,</span>
	    <span class="s">&quot;Ivybridge&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_VALLEYVIEW_IG</span><span class="p">,</span>
	    <span class="s">&quot;ValleyView&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">valleyview_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_HASWELL_D_GT1_IG</span><span class="p">,</span>
	    <span class="s">&quot;Haswell&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_HASWELL_D_GT2_IG</span><span class="p">,</span>
	    <span class="s">&quot;Haswell&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_HASWELL_M_GT1_IG</span><span class="p">,</span>
	    <span class="s">&quot;Haswell&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_HASWELL_M_GT2_IG</span><span class="p">,</span>
	    <span class="s">&quot;Haswell&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_HASWELL_S_GT1_IG</span><span class="p">,</span>
	    <span class="s">&quot;Haswell&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_HASWELL_S_GT2_IG</span><span class="p">,</span>
	    <span class="s">&quot;Haswell&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_HASWELL_SDV</span><span class="p">,</span>
	    <span class="s">&quot;Haswell&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sandybridge_gtt_driver</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_gmch</span><span class="p">(</span><span class="n">u16</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">gmch_device</span><span class="p">;</span>

	<span class="n">gmch_device</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gmch_device</span> <span class="o">&amp;&amp;</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">gmch_device</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gmch_device</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
					     <span class="n">device</span><span class="p">,</span> <span class="n">gmch_device</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gmch_device</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">gmch_device</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">intel_gmch_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">agp_bridge_data</span> <span class="o">*</span><span class="n">bridge</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">intel_private</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">intel_gtt_chipsets</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">find_gmch</span><span class="p">(</span><span class="n">intel_gtt_chipsets</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gmch_chip_id</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">intel_private</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span>
				<span class="n">intel_gtt_chipsets</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gtt_driver</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_private</span><span class="p">.</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_fake_agp_driver</span><span class="p">;</span>
	<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev_private_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_private</span><span class="p">;</span>
	<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span> <span class="o">=</span> <span class="n">pci_dev_get</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Intel %s Chipset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">intel_gtt_chipsets</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">intel_private</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">dma_mask_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="n">mask</span><span class="p">)))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;set gfx device dma mask %d-bit failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="p">,</span>
					    <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="n">mask</span><span class="p">));</span>

	<span class="cm">/*if (bridge-&gt;driver == &amp;intel_810_driver)</span>
<span class="cm">		return 1;*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_gtt_init</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">intel_gmch_probe</span><span class="p">);</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">intel_gtt</span> <span class="o">*</span><span class="nf">intel_gtt_get</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">intel_private</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">intel_gtt_get</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">intel_gtt_chipset_flush</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">chipset_flush</span><span class="p">)</span>
		<span class="n">intel_private</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">chipset_flush</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">intel_gtt_chipset_flush</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">intel_gmch_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="p">)</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="p">)</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">intel_private</span><span class="p">.</span><span class="n">bridge_dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">intel_gmch_remove</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Dave Jones &lt;davej@redhat.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL and additional rights&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
