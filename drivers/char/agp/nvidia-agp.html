<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › char › agp › nvidia-agp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>nvidia-agp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Nvidia AGPGART routines.</span>
<span class="cm"> * Based upon a 2.4 agpgart diff by the folks from NVIDIA, and hacked up</span>
<span class="cm"> * to work in 2.5 by Dave Jones &lt;davej@redhat.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/agp_backend.h&gt;</span>
<span class="cp">#include &lt;linux/page-flags.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &quot;agp.h&quot;</span>

<span class="cm">/* NVIDIA registers */</span>
<span class="cp">#define NVIDIA_0_APSIZE		0x80</span>
<span class="cp">#define NVIDIA_1_WBC		0xf0</span>
<span class="cp">#define NVIDIA_2_GARTCTRL	0xd0</span>
<span class="cp">#define NVIDIA_2_APBASE		0xd8</span>
<span class="cp">#define NVIDIA_2_APLIMIT	0xdc</span>
<span class="cp">#define NVIDIA_2_ATTBASE(i)	(0xe0 + (i) * 4)</span>
<span class="cp">#define NVIDIA_3_APBASE		0x50</span>
<span class="cp">#define NVIDIA_3_APLIMIT	0x54</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">_nvidia_private</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev_1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev_2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev_3</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">aperture</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_active_entries</span><span class="p">;</span>
	<span class="kt">off_t</span> <span class="n">pg_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wbc_mask</span><span class="p">;</span>
<span class="p">}</span> <span class="n">nvidia_private</span><span class="p">;</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">nvidia_fetch_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">size_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aper_size_info_8</span> <span class="o">*</span><span class="n">values</span><span class="p">;</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">NVIDIA_0_APSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size_value</span><span class="p">);</span>
	<span class="n">size_value</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">values</span> <span class="o">=</span> <span class="n">A_SIZE_8</span><span class="p">(</span><span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">aperture_sizes</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">num_aperture_sizes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size_value</span> <span class="o">==</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size_value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">previous_size</span> <span class="o">=</span>
				<span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">current_size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">values</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">aperture_size_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SYSCFG          0xC0010010</span>
<span class="cp">#define IORR_BASE0      0xC0010016</span>
<span class="cp">#define IORR_MASK0      0xC0010017</span>
<span class="cp">#define AMD_K7_NUM_IORR 2</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nvidia_init_iorr</span><span class="p">(</span><span class="n">u32</span> <span class="n">base</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">base_hi</span><span class="p">,</span> <span class="n">base_lo</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask_hi</span><span class="p">,</span> <span class="n">mask_lo</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sys_hi</span><span class="p">,</span> <span class="n">sys_lo</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iorr_addr</span><span class="p">,</span> <span class="n">free_iorr_addr</span><span class="p">;</span>

	<span class="cm">/* Find the iorr that is already used for the base */</span>
	<span class="cm">/* If not found, determine the uppermost available iorr */</span>
	<span class="n">free_iorr_addr</span> <span class="o">=</span> <span class="n">AMD_K7_NUM_IORR</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">iorr_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iorr_addr</span> <span class="o">&lt;</span> <span class="n">AMD_K7_NUM_IORR</span><span class="p">;</span> <span class="n">iorr_addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdmsr</span><span class="p">(</span><span class="n">IORR_BASE0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">iorr_addr</span><span class="p">,</span> <span class="n">base_lo</span><span class="p">,</span> <span class="n">base_hi</span><span class="p">);</span>
		<span class="n">rdmsr</span><span class="p">(</span><span class="n">IORR_MASK0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">iorr_addr</span><span class="p">,</span> <span class="n">mask_lo</span><span class="p">,</span> <span class="n">mask_hi</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">base_lo</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">mask_lo</span> <span class="o">&amp;</span> <span class="mh">0x00000800</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">free_iorr_addr</span> <span class="o">=</span> <span class="n">iorr_addr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iorr_addr</span> <span class="o">&gt;=</span> <span class="n">AMD_K7_NUM_IORR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iorr_addr</span> <span class="o">=</span> <span class="n">free_iorr_addr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iorr_addr</span> <span class="o">&gt;=</span> <span class="n">AMD_K7_NUM_IORR</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="n">base_hi</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
    <span class="n">base_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x18</span><span class="p">;</span>
    <span class="n">mask_hi</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
    <span class="n">mask_lo</span> <span class="o">=</span> <span class="p">((</span><span class="o">~</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x800</span><span class="p">;</span>
    <span class="n">wrmsr</span><span class="p">(</span><span class="n">IORR_BASE0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">iorr_addr</span><span class="p">,</span> <span class="n">base_lo</span><span class="p">,</span> <span class="n">base_hi</span><span class="p">);</span>
    <span class="n">wrmsr</span><span class="p">(</span><span class="n">IORR_MASK0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">iorr_addr</span><span class="p">,</span> <span class="n">mask_lo</span><span class="p">,</span> <span class="n">mask_hi</span><span class="p">);</span>

    <span class="n">rdmsr</span><span class="p">(</span><span class="n">SYSCFG</span><span class="p">,</span> <span class="n">sys_lo</span><span class="p">,</span> <span class="n">sys_hi</span><span class="p">);</span>
    <span class="n">sys_lo</span> <span class="o">|=</span> <span class="mh">0x00100000</span><span class="p">;</span>
    <span class="n">wrmsr</span><span class="p">(</span><span class="n">SYSCFG</span><span class="p">,</span> <span class="n">sys_lo</span><span class="p">,</span> <span class="n">sys_hi</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nvidia_configure</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">num_dirs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">apbase</span><span class="p">,</span> <span class="n">aplimit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aper_size_info_8</span> <span class="o">*</span><span class="n">current_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">current_size</span> <span class="o">=</span> <span class="n">A_SIZE_8</span><span class="p">(</span><span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">current_size</span><span class="p">);</span>

	<span class="cm">/* aperture size */</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">NVIDIA_0_APSIZE</span><span class="p">,</span>
		<span class="n">current_size</span><span class="o">-&gt;</span><span class="n">size_value</span><span class="p">);</span>

    <span class="cm">/* address to map to */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AGP_APBASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">apbase</span><span class="p">);</span>
	<span class="n">apbase</span> <span class="o">&amp;=</span> <span class="n">PCI_BASE_ADDRESS_MEM_MASK</span><span class="p">;</span>
	<span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">gart_bus_addr</span> <span class="o">=</span> <span class="n">apbase</span><span class="p">;</span>
	<span class="n">aplimit</span> <span class="o">=</span> <span class="n">apbase</span> <span class="o">+</span> <span class="p">(</span><span class="n">current_size</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_2</span><span class="p">,</span> <span class="n">NVIDIA_2_APBASE</span><span class="p">,</span> <span class="n">apbase</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_2</span><span class="p">,</span> <span class="n">NVIDIA_2_APLIMIT</span><span class="p">,</span> <span class="n">aplimit</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_3</span><span class="p">,</span> <span class="n">NVIDIA_3_APBASE</span><span class="p">,</span> <span class="n">apbase</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_3</span><span class="p">,</span> <span class="n">NVIDIA_3_APLIMIT</span><span class="p">,</span> <span class="n">aplimit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">nvidia_init_iorr</span><span class="p">(</span><span class="n">apbase</span><span class="p">,</span> <span class="n">current_size</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* directory size is 64k */</span>
	<span class="n">num_dirs</span> <span class="o">=</span> <span class="n">current_size</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">nvidia_private</span><span class="p">.</span><span class="n">num_active_entries</span> <span class="o">=</span> <span class="n">current_size</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">;</span>
	<span class="n">nvidia_private</span><span class="p">.</span><span class="n">pg_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_dirs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num_dirs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">nvidia_private</span><span class="p">.</span><span class="n">num_active_entries</span> <span class="o">/=</span> <span class="p">(</span><span class="mi">64</span> <span class="o">/</span> <span class="n">current_size</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">nvidia_private</span><span class="p">.</span><span class="n">pg_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">apbase</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="n">current_size</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* attbase */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_2</span><span class="p">,</span> <span class="n">NVIDIA_2_ATTBASE</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
			<span class="p">(</span><span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">gatt_bus_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">num_dirs</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* gtlb control */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_2</span><span class="p">,</span> <span class="n">NVIDIA_2_GARTCTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_2</span><span class="p">,</span> <span class="n">NVIDIA_2_GARTCTRL</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="mh">0x11</span><span class="p">);</span>

	<span class="cm">/* gart control */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">NVIDIA_0_APSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">NVIDIA_0_APSIZE</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">);</span>

	<span class="cm">/* map aperture */</span>
	<span class="n">nvidia_private</span><span class="p">.</span><span class="n">aperture</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">volatile</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">apbase</span><span class="p">,</span> <span class="mi">33</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">aperture</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvidia_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aper_size_info_8</span> <span class="o">*</span><span class="n">previous_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* gart control */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">NVIDIA_0_APSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">NVIDIA_0_APSIZE</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x100</span><span class="p">));</span>

	<span class="cm">/* gtlb control */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_2</span><span class="p">,</span> <span class="n">NVIDIA_2_GARTCTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_2</span><span class="p">,</span> <span class="n">NVIDIA_2_GARTCTRL</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x11</span><span class="p">));</span>

	<span class="cm">/* unmap aperture */</span>
	<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">nvidia_private</span><span class="p">.</span><span class="n">aperture</span><span class="p">);</span>

	<span class="cm">/* restore previous aperture size */</span>
	<span class="n">previous_size</span> <span class="o">=</span> <span class="n">A_SIZE_8</span><span class="p">(</span><span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">previous_size</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">NVIDIA_0_APSIZE</span><span class="p">,</span>
		<span class="n">previous_size</span><span class="o">-&gt;</span><span class="n">size_value</span><span class="p">);</span>

	<span class="cm">/* restore iorr for previous aperture size */</span>
	<span class="n">nvidia_init_iorr</span><span class="p">(</span><span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">gart_bus_addr</span><span class="p">,</span>
		<span class="n">previous_size</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Note we can&#39;t use the generic routines, even though they are 99% the same.</span>
<span class="cm"> * Aperture sizes &lt;64M still requires a full 64k GART directory, but</span>
<span class="cm"> * only use the portion of the TLB entries that correspond to the apertures</span>
<span class="cm"> * alignment inside the surrounding 64M block.</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">agp_memory_reserved</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nvidia_insert_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">agp_memory</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">pg_start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask_type</span><span class="p">;</span>

	<span class="n">mask_type</span> <span class="o">=</span> <span class="n">agp_generic_type_to_mask_type</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask_type</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">type</span> <span class="o">!=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">page_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pg_start</span> <span class="o">+</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">page_count</span><span class="p">)</span> <span class="o">&gt;</span>
		<span class="p">(</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">num_active_entries</span> <span class="o">-</span> <span class="n">agp_memory_reserved</span><span class="o">/</span><span class="n">PAGE_SIZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">pg_start</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">pg_start</span> <span class="o">+</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">page_count</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PGE_EMPTY</span><span class="p">(</span><span class="n">agp_bridge</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">gatt_table</span><span class="o">+</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">pg_offset</span><span class="o">+</span><span class="n">j</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">is_flushed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">global_cache_flush</span><span class="p">();</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">is_flushed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">pg_start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">page_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">mask_memory</span><span class="p">(</span><span class="n">agp_bridge</span><span class="p">,</span>
			       <span class="n">page_to_phys</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">mask_type</span><span class="p">),</span>
			<span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">gatt_table</span><span class="o">+</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">pg_offset</span><span class="o">+</span><span class="n">j</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* PCI Posting. */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">gatt_table</span><span class="o">+</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">pg_offset</span><span class="o">+</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">tlb_flush</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">nvidia_remove_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">agp_memory</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">pg_start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">mask_type</span><span class="p">;</span>

	<span class="n">mask_type</span> <span class="o">=</span> <span class="n">agp_generic_type_to_mask_type</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask_type</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">type</span> <span class="o">!=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">page_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">pg_start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">page_count</span> <span class="o">+</span> <span class="n">pg_start</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">scratch_page</span><span class="p">,</span> <span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">gatt_table</span><span class="o">+</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">pg_offset</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>

	<span class="n">agp_bridge</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">tlb_flush</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">nvidia_tlbflush</span><span class="p">(</span><span class="k">struct</span> <span class="n">agp_memory</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wbc_reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* flush chipset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">wbc_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_1</span><span class="p">,</span> <span class="n">NVIDIA_1_WBC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wbc_reg</span><span class="p">);</span>
		<span class="n">wbc_reg</span> <span class="o">|=</span> <span class="n">nvidia_private</span><span class="p">.</span><span class="n">wbc_mask</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_1</span><span class="p">,</span> <span class="n">NVIDIA_1_WBC</span><span class="p">,</span> <span class="n">wbc_reg</span><span class="p">);</span>

		<span class="n">end</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_1</span><span class="p">,</span>
					<span class="n">NVIDIA_1_WBC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wbc_reg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_before_eq</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span>
				    <span class="s">&quot;TLB flush took more than 3 seconds.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">wbc_reg</span> <span class="o">&amp;</span> <span class="n">nvidia_private</span><span class="p">.</span><span class="n">wbc_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* flush TLB entries */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">aperture</span><span class="o">+</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">aperture</span><span class="o">+</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">aper_size_info_8</span> <span class="n">nvidia_generic_sizes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span><span class="mi">512</span><span class="p">,</span> <span class="mi">131072</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">256</span><span class="p">,</span> <span class="mi">65536</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">128</span><span class="p">,</span> <span class="mi">32768</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">64</span><span class="p">,</span> <span class="mi">16384</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">14</span><span class="p">},</span>
	<span class="cm">/* The 32M mode still requires a 64k gatt */</span>
	<span class="p">{</span><span class="mi">32</span><span class="p">,</span> <span class="mi">16384</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">}</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gatt_mask</span> <span class="n">nvidia_generic_masks</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">agp_bridge_driver</span> <span class="n">nvidia_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">aperture_sizes</span>		<span class="o">=</span> <span class="n">nvidia_generic_sizes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size_type</span>		<span class="o">=</span> <span class="n">U8_APER_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_aperture_sizes</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">needs_scratch_page</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">configure</span>		<span class="o">=</span> <span class="n">nvidia_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fetch_size</span>		<span class="o">=</span> <span class="n">nvidia_fetch_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span>		<span class="o">=</span> <span class="n">nvidia_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tlb_flush</span>		<span class="o">=</span> <span class="n">nvidia_tlbflush</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask_memory</span>		<span class="o">=</span> <span class="n">agp_generic_mask_memory</span><span class="p">,</span>
	<span class="p">.</span><span class="n">masks</span>			<span class="o">=</span> <span class="n">nvidia_generic_masks</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agp_enable</span>		<span class="o">=</span> <span class="n">agp_generic_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cache_flush</span>		<span class="o">=</span> <span class="n">global_cache_flush</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create_gatt_table</span>	<span class="o">=</span> <span class="n">agp_generic_create_gatt_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_gatt_table</span>	<span class="o">=</span> <span class="n">agp_generic_free_gatt_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">insert_memory</span>		<span class="o">=</span> <span class="n">nvidia_insert_memory</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_memory</span>		<span class="o">=</span> <span class="n">nvidia_remove_memory</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_by_type</span>		<span class="o">=</span> <span class="n">agp_generic_alloc_by_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_by_type</span>		<span class="o">=</span> <span class="n">agp_generic_free_by_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agp_alloc_page</span>		<span class="o">=</span> <span class="n">agp_generic_alloc_page</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agp_alloc_pages</span>	<span class="o">=</span> <span class="n">agp_generic_alloc_pages</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agp_destroy_page</span>	<span class="o">=</span> <span class="n">agp_generic_destroy_page</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agp_destroy_pages</span>	<span class="o">=</span> <span class="n">agp_generic_destroy_pages</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agp_type_to_mask_type</span>  <span class="o">=</span> <span class="n">agp_generic_type_to_mask_type</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">agp_nvidia_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">agp_bridge_data</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cap_ptr</span><span class="p">;</span>

	<span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_1</span> <span class="o">=</span>
		<span class="n">pci_get_bus_and_slot</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_2</span> <span class="o">=</span>
		<span class="n">pci_get_bus_and_slot</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_3</span> <span class="o">=</span>
		<span class="n">pci_get_bus_and_slot</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_1</span> <span class="o">||</span> <span class="o">!</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_2</span> <span class="o">||</span> <span class="o">!</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Detected an NVIDIA nForce/nForce2 &quot;</span>
			<span class="s">&quot;chipset, but could not find the secondary devices.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cap_ptr</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_AGP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cap_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Detected NVIDIA nForce chipset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">nvidia_private</span><span class="p">.</span><span class="n">wbc_mask</span> <span class="o">=</span> <span class="mh">0x00010000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE2</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Detected NVIDIA nForce2 chipset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">nvidia_private</span><span class="p">.</span><span class="n">wbc_mask</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Unsupported NVIDIA chipset (device id: %04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">agp_alloc_bridge</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bridge</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nvidia_driver</span><span class="p">;</span>
	<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev_private_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nvidia_private</span><span class="p">,</span>
	<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">capndx</span> <span class="o">=</span> <span class="n">cap_ptr</span><span class="p">;</span>

	<span class="cm">/* Fill in the mode register */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
			<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">capndx</span><span class="o">+</span><span class="n">PCI_AGP_STATUS</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bridge</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">agp_add_bridge</span><span class="p">(</span><span class="n">bridge</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">agp_nvidia_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">agp_bridge_data</span> <span class="o">*</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">agp_remove_bridge</span><span class="p">(</span><span class="n">bridge</span><span class="p">);</span>
	<span class="n">agp_put_bridge</span><span class="p">(</span><span class="n">bridge</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">agp_nvidia_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_save_state</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">agp_nvidia_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* set power state 0 and restore PCI space */</span>
	<span class="n">pci_set_power_state</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* reconfigure AGP hardware again */</span>
	<span class="n">nvidia_configure</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">agp_nvidia_pci_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	<span class="p">.</span><span class="n">class</span>		<span class="o">=</span> <span class="p">(</span><span class="n">PCI_CLASS_BRIDGE_HOST</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
	<span class="p">.</span><span class="n">class_mask</span>	<span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_NVIDIA</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	<span class="p">.</span><span class="n">class</span>		<span class="o">=</span> <span class="p">(</span><span class="n">PCI_CLASS_BRIDGE_HOST</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
	<span class="p">.</span><span class="n">class_mask</span>	<span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_NVIDIA</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">agp_nvidia_pci_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">agp_nvidia_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;agpgart-nvidia&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">agp_nvidia_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">agp_nvidia_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">agp_nvidia_remove</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">agp_nvidia_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">agp_nvidia_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">agp_nvidia_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">agp_off</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agp_nvidia_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">agp_nvidia_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agp_nvidia_pci_driver</span><span class="p">);</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_1</span><span class="p">);</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_2</span><span class="p">);</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">nvidia_private</span><span class="p">.</span><span class="n">dev_3</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">agp_nvidia_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">agp_nvidia_cleanup</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL and additional rights&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;NVIDIA Corporation&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
