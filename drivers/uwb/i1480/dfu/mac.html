<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › uwb › i1480 › dfu › mac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>mac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Intel Wireless UWB Link 1480</span>
<span class="cm"> * MAC Firmware upload implementation</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2006 Intel Corporation</span>
<span class="cm"> * Inaky Perez-Gonzalez &lt;inaky.perez-gonzalez@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version</span>
<span class="cm"> * 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Implementation of the code for parsing the firmware file (extract</span>
<span class="cm"> * the headers and binary code chunks) in the fw_*() functions. The</span>
<span class="cm"> * code to upload pre and mac firmwares is the same, so it uses a</span>
<span class="cm"> * common entry point in __mac_fw_upload(), which uses the i1480</span>
<span class="cm"> * function pointers to push the firmware to the device.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/uwb.h&gt;</span>
<span class="cp">#include &quot;i1480-dfu.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Descriptor for a continuous segment of MAC fw data</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fw_hdr</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">bin</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_hdr</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/* Free a chain of firmware headers */</span>
<span class="k">static</span>
<span class="kt">void</span> <span class="nf">fw_hdrs_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_hdr</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Fill a firmware header descriptor from a memory buffer */</span>
<span class="k">static</span>
<span class="kt">int</span> <span class="nf">fw_hdr_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">i1480</span> <span class="o">*</span><span class="n">i1480</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fw_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">hdr_cnt</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_data</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data_itr</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data_top</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">hdr_offset</span> <span class="o">=</span>  <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">data_itr</span> <span class="o">-</span> <span class="n">_data</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">remaining_size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">data_top</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">data_itr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_itr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">data_top</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fw hdr #%u/%zu: EOF reached in header at &quot;</span>
		       <span class="s">&quot;offset %zu, limit %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hdr_cnt</span><span class="p">,</span> <span class="n">hdr_offset</span><span class="p">,</span>
		       <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">data_itr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">_data</span><span class="p">,</span>
		       <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">data_top</span> <span class="o">-</span> <span class="n">_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">data_itr</span><span class="o">++</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">data_itr</span><span class="o">++</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bin</span> <span class="o">=</span> <span class="n">data_itr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">remaining_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fw hdr #%u/%zu: EOF reached in data; &quot;</span>
		       <span class="s">&quot;chunk too long (%zu bytes), only %zu left</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hdr_cnt</span><span class="p">,</span> <span class="n">hdr_offset</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">remaining_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Get a buffer where the firmware is supposed to be and create a</span>
<span class="cm"> * chain of headers linking them together.</span>
<span class="cm"> *</span>
<span class="cm"> * @phdr: where to place the pointer to the first header (headers link</span>
<span class="cm"> *        to the next via the @hdr-&gt;next ptr); need to free the whole</span>
<span class="cm"> *        chain when done.</span>
<span class="cm"> *</span>
<span class="cm"> * @_data: Pointer to the data buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * @_data_size: Size of the data buffer (bytes); data size has to be a</span>
<span class="cm"> *              multiple of 4. Function will fail if not.</span>
<span class="cm"> *</span>
<span class="cm"> * Goes over the whole binary blob; reads the first chunk and creates</span>
<span class="cm"> * a fw hdr from it (which points to where the data is in @_data and</span>
<span class="cm"> * the length of the chunk); then goes on to the next chunk until</span>
<span class="cm"> * done. Each header is linked to the next.</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">int</span> <span class="nf">fw_hdrs_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">i1480</span> <span class="o">*</span><span class="n">i1480</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fw_hdr</span> <span class="o">**</span><span class="n">phdr</span><span class="p">,</span>
		 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">hdr_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">_data</span><span class="p">,</span> <span class="o">*</span><span class="n">data_itr</span><span class="p">,</span> <span class="o">*</span><span class="n">data_top</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="o">**</span><span class="n">prev_hdr</span> <span class="o">=</span> <span class="n">phdr</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* Check size is ok and pointer is aligned */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">_data</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="o">*</span><span class="n">phdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">data_itr</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">data_top</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">_data</span> <span class="o">+</span> <span class="n">data_size</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">data_itr</span> <span class="o">&lt;</span> <span class="n">data_top</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot allocate fw header &quot;</span>
			       <span class="s">&quot;for chunk #%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr_cnt</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error_alloc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">fw_hdr_load</span><span class="p">(</span><span class="n">i1480</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">hdr_cnt</span><span class="p">,</span>
				     <span class="n">_data</span><span class="p">,</span> <span class="n">data_itr</span><span class="p">,</span> <span class="n">data_top</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_load</span><span class="p">;</span>
		<span class="n">data_itr</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="o">*</span><span class="n">prev_hdr</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">;</span>
		<span class="n">prev_hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">hdr_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="o">*</span><span class="n">prev_hdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_load:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
<span class="nl">error_alloc:</span>
	<span class="n">fw_hdrs_free</span><span class="p">(</span><span class="o">*</span><span class="n">phdr</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Compares a chunk of fw with one in the devices&#39;s memory</span>
<span class="cm"> *</span>
<span class="cm"> * @i1480:     Device instance</span>
<span class="cm"> * @hdr:     Pointer to the firmware chunk</span>
<span class="cm"> * @returns: 0 if equal, &lt; 0 errno on error. If &gt; 0, it is the offset</span>
<span class="cm"> *           where the difference was found (plus one).</span>
<span class="cm"> *</span>
<span class="cm"> * Kind of dirty and simplistic, but does the trick in both the PCI</span>
<span class="cm"> * and USB version. We do a quick[er] memcmp(), and if it fails, we do</span>
<span class="cm"> * a byte-by-byte to find the offset.</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">ssize_t</span> <span class="nf">i1480_fw_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">i1480</span> <span class="o">*</span><span class="n">i1480</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fw_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">src_itr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">length</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bin</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="kt">size_t</span> <span class="n">chunk_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">bin</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bin</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chunk_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">?</span> <span class="n">size</span> <span class="o">:</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">i1480</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="n">src_itr</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error reading for verification: &quot;</span>
				<span class="s">&quot;%zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">,</span> <span class="n">bin</span> <span class="o">+</span> <span class="n">src_itr</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">result</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bin</span><span class="p">[</span><span class="n">src_itr</span> <span class="o">+</span> <span class="n">cnt</span><span class="p">]</span> <span class="o">!=</span> <span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;byte failed at &quot;</span>
						<span class="s">&quot;src_itr %u cnt %u [0x%02x &quot;</span>
						<span class="s">&quot;vs 0x%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">src_itr</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span>
						<span class="n">bin</span><span class="p">[</span><span class="n">src_itr</span> <span class="o">+</span> <span class="n">cnt</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">src_itr</span> <span class="o">+</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">cmp_failed</span><span class="p">;</span>
				<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">src_itr</span> <span class="o">+=</span> <span class="n">result</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
<span class="nl">cmp_failed:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Writes firmware headers to the device.</span>
<span class="cm"> *</span>
<span class="cm"> * @prd:     PRD instance</span>
<span class="cm"> * @hdr:     Processed firmware</span>
<span class="cm"> * @returns: 0 if ok, &lt; 0 errno on error.</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">int</span> <span class="nf">mac_fw_hdrs_push</span><span class="p">(</span><span class="k">struct</span> <span class="n">i1480</span> <span class="o">*</span><span class="n">i1480</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fw_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
		     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_hdr</span> <span class="o">*</span><span class="n">hdr_itr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">verif_retry_count</span><span class="p">;</span>

	<span class="cm">/* Now, header by header, push them to the hw */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">hdr_itr</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">;</span> <span class="n">hdr_itr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">hdr_itr</span> <span class="o">=</span> <span class="n">hdr_itr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">verif_retry_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">retry:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fw chunk (%zu @ 0x%08lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hdr_itr</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr_itr</span><span class="o">-&gt;</span><span class="n">bin</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
			<span class="n">hdr_itr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">i1480</span><span class="p">,</span> <span class="n">hdr_itr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">hdr_itr</span><span class="o">-&gt;</span><span class="n">bin</span><span class="p">,</span>
				    <span class="n">hdr_itr</span><span class="o">-&gt;</span><span class="n">length</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">hdr_itr</span><span class="o">-&gt;</span><span class="n">bin</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s fw &#39;%s&#39;: write failed (%zuB @ 0x%lx):&quot;</span>
				<span class="s">&quot; %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_tag</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span>
				<span class="n">hdr_itr</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr_itr</span><span class="o">-&gt;</span><span class="n">bin</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
				<span class="n">hdr_itr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">i1480_fw_cmp</span><span class="p">(</span><span class="n">i1480</span><span class="p">,</span> <span class="n">hdr_itr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s fw &#39;%s&#39;: verification read &quot;</span>
				<span class="s">&quot;failed (%zuB @ 0x%lx): %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fw_tag</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span>
				<span class="n">hdr_itr</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr_itr</span><span class="o">-&gt;</span><span class="n">bin</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
				<span class="n">hdr_itr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Offset where it failed + 1 */</span>
			<span class="n">result</span><span class="o">--</span><span class="p">;</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s fw &#39;%s&#39;: WARNING: verification &quot;</span>
				<span class="s">&quot;failed at 0x%lx: retrying</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fw_tag</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="n">hdr_itr</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="n">result</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">verif_retry_count</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>	<span class="cm">/* write this block again! */</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s fw &#39;%s&#39;: verification failed at 0x%lx: &quot;</span>
				<span class="s">&quot;tried %d times</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_tag</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span>
				<span class="n">hdr_itr</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="n">result</span><span class="p">,</span> <span class="n">verif_retry_count</span><span class="p">);</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/** Puts the device in firmware upload mode.*/</span>
<span class="k">static</span>
<span class="kt">int</span> <span class="nf">mac_fw_upload_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">i1480</span> <span class="o">*</span><span class="n">i1480</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mh">0x800000c0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x8000d0d4</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">i1480</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_cmd</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buffer</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">i1480_FW_UPLOAD_MODE_MASK</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">i1480</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_cmd</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error_cmd:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t enable fw upload mode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/** Gets the device out of firmware upload mode. */</span>
<span class="k">static</span>
<span class="kt">int</span> <span class="nf">mac_fw_upload_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">i1480</span> <span class="o">*</span><span class="n">i1480</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mh">0x800000c0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x8000d0d4</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">i1480</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_cmd</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buffer</span> <span class="o">|=</span> <span class="n">i1480_FW_UPLOAD_MODE_MASK</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">i1480</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_cmd</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error_cmd:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t disable fw upload mode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/**</span>
<span class="cm"> * Generic function for uploading a MAC firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * @i1480:     Device instance</span>
<span class="cm"> * @fw_name: Name of firmware file to upload.</span>
<span class="cm"> * @fw_tag:  Name of the firmware type (for messages)</span>
<span class="cm"> *           [eg: MAC, PRE]</span>
<span class="cm"> * @do_wait: Wait for device to emit initialization done message (0</span>
<span class="cm"> *           for PRE fws, 1 for MAC fws).</span>
<span class="cm"> * @returns: 0 if ok, &lt; 0 errno on error.</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">int</span> <span class="nf">__mac_fw_upload</span><span class="p">(</span><span class="k">struct</span> <span class="n">i1480</span> <span class="o">*</span><span class="n">i1480</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span><span class="p">,</span>
		    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_hdr</span> <span class="o">*</span><span class="n">fw_hdrs</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* Up to caller to complain on -ENOENT */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">fw_hdrs_load</span><span class="p">(</span><span class="n">i1480</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_hdrs</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s fw &#39;%s&#39;: failed to parse firmware &quot;</span>
			<span class="s">&quot;file: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_tag</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">mac_fw_upload_enable</span><span class="p">(</span><span class="n">i1480</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_hdrs_release</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">mac_fw_hdrs_push</span><span class="p">(</span><span class="n">i1480</span><span class="p">,</span> <span class="n">fw_hdrs</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="n">fw_tag</span><span class="p">);</span>
	<span class="n">mac_fw_upload_disable</span><span class="p">(</span><span class="n">i1480</span><span class="p">);</span>
<span class="nl">out_hdrs_release:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s fw &#39;%s&#39;: uploaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_tag</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s fw &#39;%s&#39;: failed to upload (%d), &quot;</span>
			<span class="s">&quot;power cycle device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_tag</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="n">fw_hdrs_free</span><span class="p">(</span><span class="n">fw_hdrs</span><span class="p">);</span>
<span class="nl">out_release:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Upload a pre-PHY firmware</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i1480_pre_fw_upload</span><span class="p">(</span><span class="k">struct</span> <span class="n">i1480</span> <span class="o">*</span><span class="n">i1480</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">__mac_fw_upload</span><span class="p">(</span><span class="n">i1480</span><span class="p">,</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">pre_fw_name</span><span class="p">,</span> <span class="s">&quot;PRE&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Reset a the MAC and PHY</span>
<span class="cm"> *</span>
<span class="cm"> * @i1480:     Device&#39;s instance</span>
<span class="cm"> * @returns: 0 if ok, &lt; 0 errno code on error</span>
<span class="cm"> *</span>
<span class="cm"> * We put the command on kmalloc&#39;ed memory as some arches cannot do</span>
<span class="cm"> * USB from the stack. The reply event is copied from an stage buffer,</span>
<span class="cm"> * so it can be in the stack. See WUSB1.0[8.6.2.4] for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * We issue the reset to make sure the UWB controller reinits the PHY;</span>
<span class="cm"> * this way we can now if the PHY init went ok.</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">int</span> <span class="nf">i1480_cmd_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">i1480</span> <span class="o">*</span><span class="n">i1480</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_rccb</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i1480_evt_reset</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">uwb_rceb</span> <span class="n">rceb</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">bResultCode</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">evt_buf</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bCommandType</span> <span class="o">=</span> <span class="n">UWB_RC_CET_GENERAL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">wCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">UWB_RC_CMD_RESET</span><span class="p">);</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">rceb</span><span class="p">.</span><span class="n">bEventType</span> <span class="o">=</span> <span class="n">UWB_RC_CET_GENERAL</span><span class="p">;</span>
	<span class="n">reply</span><span class="o">-&gt;</span><span class="n">rceb</span><span class="p">.</span><span class="n">wEvent</span> <span class="o">=</span> <span class="n">UWB_RC_CMD_RESET</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i1480_cmd</span><span class="p">(</span><span class="n">i1480</span><span class="p">,</span> <span class="s">&quot;RESET&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">reply</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">bResultCode</span> <span class="o">!=</span> <span class="n">UWB_RC_RES_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RESET: command execution failed: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">reply</span><span class="o">-&gt;</span><span class="n">bResultCode</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="p">}</span>


<span class="cm">/* Wait for the MAC FW to start running */</span>
<span class="k">static</span>
<span class="kt">int</span> <span class="nf">i1480_fw_is_running_q</span><span class="p">(</span><span class="k">struct</span> <span class="n">i1480</span> <span class="o">*</span><span class="n">i1480</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">i1480</span><span class="p">,</span> <span class="mh">0x80080000</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t read 0x8008000: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">val</span> <span class="o">==</span> <span class="mh">0x55555555UL</span><span class="p">)</span>	<span class="cm">/* fw running? cool */</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Timed out waiting for fw to start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Upload MAC firmware, wait for it to start</span>
<span class="cm"> *</span>
<span class="cm"> * @i1480:     Device instance</span>
<span class="cm"> * @fw_name: Name of the file that contains the firmware</span>
<span class="cm"> *</span>
<span class="cm"> * This has to be called after the pre fw has been uploaded (if</span>
<span class="cm"> * there is any).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i1480_mac_fw_upload</span><span class="p">(</span><span class="k">struct</span> <span class="n">i1480</span> <span class="o">*</span><span class="n">i1480</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">deprecated_name</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i1480_rceb</span> <span class="o">*</span><span class="n">rcebe</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">evt_buf</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">__mac_fw_upload</span><span class="p">(</span><span class="n">i1480</span><span class="p">,</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">mac_fw_name</span><span class="p">,</span> <span class="s">&quot;MAC&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">__mac_fw_upload</span><span class="p">(</span><span class="n">i1480</span><span class="p">,</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">mac_fw_name_deprecate</span><span class="p">,</span>
					 <span class="s">&quot;MAC&quot;</span><span class="p">);</span>
		<span class="n">deprecated_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">deprecated_name</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;WARNING: firmware file name %s is deprecated, &quot;</span>
			 <span class="s">&quot;please rename to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">mac_fw_name_deprecate</span><span class="p">,</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">mac_fw_name</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i1480_fw_is_running_q</span><span class="p">(</span><span class="n">i1480</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_fw_not_running</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">rc_setup</span> <span class="o">?</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">rc_setup</span><span class="p">(</span><span class="n">i1480</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot setup after MAC fw upload: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_setup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">wait_init_done</span><span class="p">(</span><span class="n">i1480</span><span class="p">);</span>	<span class="cm">/* wait init&#39;on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MAC fw &#39;%s&#39;: Initialization timed out &quot;</span>
			<span class="s">&quot;(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">mac_fw_name</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_init_timeout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* verify we got the right initialization done event */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">evt_result</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rcebe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MAC fw &#39;%s&#39;: initialization event returns &quot;</span>
			<span class="s">&quot;wrong size (%zu bytes vs %zu needed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i1480</span><span class="o">-&gt;</span><span class="n">mac_fw_name</span><span class="p">,</span> <span class="n">i1480</span><span class="o">-&gt;</span><span class="n">evt_result</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rcebe</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">error_size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i1480_rceb_check</span><span class="p">(</span><span class="n">i1480</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcebe</span><span class="o">-&gt;</span><span class="n">rceb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i1480_CET_VS1</span><span class="p">,</span>
			     <span class="n">i1480_EVT_RM_INIT_DONE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wrong initialization event 0x%02x/%04x/%02x &quot;</span>
			<span class="s">&quot;received; expected 0x%02x/%04x/00</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rcebe</span><span class="o">-&gt;</span><span class="n">rceb</span><span class="p">.</span><span class="n">bEventType</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rcebe</span><span class="o">-&gt;</span><span class="n">rceb</span><span class="p">.</span><span class="n">wEvent</span><span class="p">),</span>
			<span class="n">rcebe</span><span class="o">-&gt;</span><span class="n">rceb</span><span class="p">.</span><span class="n">bEventContext</span><span class="p">,</span> <span class="n">i1480_CET_VS1</span><span class="p">,</span>
			<span class="n">i1480_EVT_RM_INIT_DONE</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_init_timeout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i1480_cmd_reset</span><span class="p">(</span><span class="n">i1480</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">i1480</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MAC fw &#39;%s&#39;: MBOA reset failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i1480</span><span class="o">-&gt;</span><span class="n">mac_fw_name</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
<span class="nl">error_fw_not_running:</span>
<span class="nl">error_init_timeout:</span>
<span class="nl">error_size:</span>
<span class="nl">error_setup:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
