<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › uwb › uwbd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>uwbd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Ultra Wide Band</span>
<span class="cm"> * Neighborhood Management Daemon</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2006 Intel Corporation</span>
<span class="cm"> * Inaky Perez-Gonzalez &lt;inaky.perez-gonzalez@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version</span>
<span class="cm"> * 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This daemon takes care of maintaing information that describes the</span>
<span class="cm"> * UWB neighborhood that the radios in this machine can see. It also</span>
<span class="cm"> * keeps a tab of which devices are visible, makes sure each HC sits</span>
<span class="cm"> * on a different channel to avoid interfering, etc.</span>
<span class="cm"> *</span>
<span class="cm"> * Different drivers (radio controller, device, any API in general)</span>
<span class="cm"> * communicate with this daemon through an event queue. Daemon wakes</span>
<span class="cm"> * up, takes a list of events and handles them one by one; handling</span>
<span class="cm"> * function is extracted from a table based on the event&#39;s type and</span>
<span class="cm"> * subtype. Events are freed only if the handling function says so.</span>
<span class="cm"> *</span>
<span class="cm"> *   . Lock protecting the event list has to be an spinlock and locked</span>
<span class="cm"> *     with IRQSAVE because it might be called from an interrupt</span>
<span class="cm"> *     context (ie: when events arrive and the notification drops</span>
<span class="cm"> *     down from the ISR).</span>
<span class="cm"> *</span>
<span class="cm"> *   . UWB radio controller drivers queue events to the daemon using</span>
<span class="cm"> *     uwbd_event_queue(). They just get the event, chew it to make it</span>
<span class="cm"> *     look like UWBD likes it and pass it in a buffer allocated with</span>
<span class="cm"> *     uwb_event_alloc().</span>
<span class="cm"> *</span>
<span class="cm"> * EVENTS</span>
<span class="cm"> *</span>
<span class="cm"> * Events have a type, a subtype, a length, some other stuff and the</span>
<span class="cm"> * data blob, which depends on the event. The header is &#39;struct</span>
<span class="cm"> * uwb_event&#39;; for payloads, see &#39;struct uwbd_evt_*&#39;.</span>
<span class="cm"> *</span>
<span class="cm"> * EVENT HANDLER TABLES</span>
<span class="cm"> *</span>
<span class="cm"> * To find a handling function for an event, the type is used to index</span>
<span class="cm"> * a subtype-table in the type-table. The subtype-table is indexed</span>
<span class="cm"> * with the subtype to get the function that handles the event. Start</span>
<span class="cm"> * with the main type-table &#39;uwbd_evt_type_handler&#39;.</span>
<span class="cm"> *</span>
<span class="cm"> * DEVICES</span>
<span class="cm"> *</span>
<span class="cm"> * Devices are created when a bunch of beacons have been received and</span>
<span class="cm"> * it is stablished that the device has stable radio presence. CREATED</span>
<span class="cm"> * only, not configured. Devices are ONLY configured when an</span>
<span class="cm"> * Application-Specific IE Probe is receieved, in which the device</span>
<span class="cm"> * declares which Protocol ID it groks. Then the device is CONFIGURED</span>
<span class="cm"> * (and the driver-&gt;probe() stuff of the device model is invoked).</span>
<span class="cm"> *</span>
<span class="cm"> * Devices are considered disconnected when a certain number of</span>
<span class="cm"> * beacons are not received in an amount of time.</span>
<span class="cm"> *</span>
<span class="cm"> * Handler functions are called normally uwbd_evt_handle_*().</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>

<span class="cp">#include &quot;uwb-internal.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * UWBD Event handler function signature</span>
<span class="cm"> *</span>
<span class="cm"> * Return !0 if the event needs not to be freed (ie the handler</span>
<span class="cm"> * takes/took care of it). 0 means the daemon code will free the</span>
<span class="cm"> * event.</span>
<span class="cm"> *</span>
<span class="cm"> * @evt-&gt;rc is already referenced and guaranteed to exist. See</span>
<span class="cm"> * uwb_evt_handle().</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">uwbd_evt_handler_f</span><span class="p">)(</span><span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Properties of a UWBD event</span>
<span class="cm"> *</span>
<span class="cm"> * @handler:    the function that will handle this event</span>
<span class="cm"> * @name:       text name of event</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">uwbd_event</span> <span class="p">{</span>
	<span class="n">uwbd_evt_handler_f</span> <span class="n">handler</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Table of handlers for and properties of the UWBD Radio Control Events */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">uwbd_event</span> <span class="n">uwbd_urc_events</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">UWB_RC_EVT_IE_RCV</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">uwbd_evt_handle_rc_ie_rcv</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;IE_RECEIVED&quot;</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">UWB_RC_EVT_BEACON</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">uwbd_evt_handle_rc_beacon</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;BEACON_RECEIVED&quot;</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">UWB_RC_EVT_BEACON_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">uwbd_evt_handle_rc_beacon_size</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;BEACON_SIZE_CHANGE&quot;</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">UWB_RC_EVT_BPOIE_CHANGE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">uwbd_evt_handle_rc_bpoie_change</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;BPOIE_CHANGE&quot;</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">UWB_RC_EVT_BP_SLOT_CHANGE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">uwbd_evt_handle_rc_bp_slot_change</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;BP_SLOT_CHANGE&quot;</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">UWB_RC_EVT_DRP_AVAIL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">uwbd_evt_handle_rc_drp_avail</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DRP_AVAILABILITY_CHANGE&quot;</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">UWB_RC_EVT_DRP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">uwbd_evt_handle_rc_drp</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DRP&quot;</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">UWB_RC_EVT_DEV_ADDR_CONFLICT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">uwbd_evt_handle_rc_dev_addr_conflict</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DEV_ADDR_CONFLICT&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>



<span class="k">struct</span> <span class="n">uwbd_evt_type_handler</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwbd_event</span> <span class="o">*</span><span class="n">uwbd_events</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Table of handlers for each UWBD Event type. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">uwbd_evt_type_handler</span> <span class="n">uwbd_urc_evt_type_handlers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">UWB_RC_CET_GENERAL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>        <span class="o">=</span> <span class="s">&quot;URC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">uwbd_events</span> <span class="o">=</span> <span class="n">uwbd_urc_events</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>        <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">uwbd_urc_events</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">uwbd_event</span> <span class="n">uwbd_message_handlers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">UWB_EVT_MSG_RESET</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">uwbd_msg_handle_reset</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;reset&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Handle an URC event passed to the UWB Daemon</span>
<span class="cm"> *</span>
<span class="cm"> * @evt: the event to handle</span>
<span class="cm"> * @returns: 0 if the event can be kfreed, !0 on the contrary</span>
<span class="cm"> *           (somebody else took ownership) [coincidentally, returning</span>
<span class="cm"> *           a &lt;0 errno code will free it :)].</span>
<span class="cm"> *</span>
<span class="cm"> * Looks up the two indirection tables (one for the type, one for the</span>
<span class="cm"> * subtype) to decide which function handles it and then calls the</span>
<span class="cm"> * handler.</span>
<span class="cm"> *</span>
<span class="cm"> * The event structure passed to the event handler has the radio</span>
<span class="cm"> * controller in @evt-&gt;rc referenced. The reference will be dropped</span>
<span class="cm"> * once the handler returns, so if it needs it for longer (async),</span>
<span class="cm"> * it&#39;ll need to take another one.</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">int</span> <span class="nf">uwbd_event_handle_urc</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwbd_evt_type_handler</span> <span class="o">*</span><span class="n">type_table</span><span class="p">;</span>
	<span class="n">uwbd_evt_handler_f</span> <span class="n">handler</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">context</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">notif</span><span class="p">.</span><span class="n">rceb</span><span class="o">-&gt;</span><span class="n">bEventType</span><span class="p">;</span>
	<span class="n">event</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">notif</span><span class="p">.</span><span class="n">rceb</span><span class="o">-&gt;</span><span class="n">wEvent</span><span class="p">);</span>
	<span class="n">context</span> <span class="o">=</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">notif</span><span class="p">.</span><span class="n">rceb</span><span class="o">-&gt;</span><span class="n">bEventContext</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">uwbd_urc_evt_type_handlers</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">type_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uwbd_urc_evt_type_handlers</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type_table</span><span class="o">-&gt;</span><span class="n">uwbd_events</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&gt;=</span> <span class="n">type_table</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">handler</span> <span class="o">=</span> <span class="n">type_table</span><span class="o">-&gt;</span><span class="n">uwbd_events</span><span class="p">[</span><span class="n">event</span><span class="p">].</span><span class="n">handler</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handler</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="n">evt</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwb_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;UWBD: event 0x%02x/%04x/%02x, handling failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">type</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uwbd_event_handle_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">message</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">message</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">uwbd_message_handlers</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwb_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;UWBD: invalid message type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">uwbd_message_handlers</span><span class="p">[</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">].</span><span class="n">handler</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwb_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;UWBD: &#39;%s&#39; message failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">uwbd_message_handlers</span><span class="p">[</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uwbd_event_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">should_keep</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">UWB_EVT_TYPE_NOTIF</span>:
			<span class="n">should_keep</span> <span class="o">=</span> <span class="n">uwbd_event_handle_urc</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">should_keep</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">notif</span><span class="p">.</span><span class="n">rceb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UWB_EVT_TYPE_MSG</span>:
			<span class="n">uwbd_event_handle_message</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwb_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;UWBD: invalid event type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">__uwb_rc_put</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>	<span class="cm">/* for the __uwb_rc_get() in uwb_rc_notif_cb() */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * UWB Daemon</span>
<span class="cm"> *</span>
<span class="cm"> * Listens to all UWB notifications and takes care to track the state</span>
<span class="cm"> * of the UWB neighbourhood for the kernel. When we do a run, we</span>
<span class="cm"> * spinlock, move the list to a private copy and release the</span>
<span class="cm"> * lock. Hold it as little as possible. Not a conflict: it is</span>
<span class="cm"> * guaranteed we own the events in the private list.</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: should change so we don&#39;t have a 1HZ timer all the time, but</span>
<span class="cm"> *        only if there are devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">uwbd</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">should_stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wait_event_interruptible_timeout</span><span class="p">(</span>
			<span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwbd</span><span class="p">.</span><span class="n">wq</span><span class="p">,</span>
			<span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwbd</span><span class="p">.</span><span class="n">event_list</span><span class="p">)</span>
			  <span class="o">||</span> <span class="p">(</span><span class="n">should_stop</span> <span class="o">=</span> <span class="n">kthread_should_stop</span><span class="p">()),</span>
			<span class="n">HZ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">should_stop</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">try_to_freeze</span><span class="p">();</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwbd</span><span class="p">.</span><span class="n">event_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwbd</span><span class="p">.</span><span class="n">event_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">evt</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwbd</span><span class="p">.</span><span class="n">event_list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_event</span><span class="p">,</span> <span class="n">list_node</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">list_node</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">evt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwbd</span><span class="p">.</span><span class="n">event_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uwbd_event_handle</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">uwb_beca_purge</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>	<span class="cm">/* Purge devices that left */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/** Start the UWB daemon */</span>
<span class="kt">void</span> <span class="nf">uwbd_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwbd</span><span class="p">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">uwbd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="s">&quot;uwbd&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwbd</span><span class="p">.</span><span class="n">task</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;UWB: Cannot start management daemon; &quot;</span>
		       <span class="s">&quot;UWB won&#39;t work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwbd</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwbd</span><span class="p">.</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Stop the UWB daemon and free any unprocessed events */</span>
<span class="kt">void</span> <span class="nf">uwbd_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kthread_stop</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwbd</span><span class="p">.</span><span class="n">task</span><span class="p">);</span>
	<span class="n">uwbd_flush</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Queue an event for the management daemon</span>
<span class="cm"> *</span>
<span class="cm"> * When some lower layer receives an event, it uses this function to</span>
<span class="cm"> * push it forward to the UWB daemon.</span>
<span class="cm"> *</span>
<span class="cm"> * Once you pass the event, you don&#39;t own it any more, but the daemon</span>
<span class="cm"> * does. It will uwb_event_free() it when done, so make sure you</span>
<span class="cm"> * uwb_event_alloc()ed it or bad things will happen.</span>
<span class="cm"> *</span>
<span class="cm"> * If the daemon is not running, we just free the event.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">uwbd_event_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwbd</span><span class="p">.</span><span class="n">event_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwbd</span><span class="p">.</span><span class="n">pid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">list_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwbd</span><span class="p">.</span><span class="n">event_list</span><span class="p">);</span>
		<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwbd</span><span class="p">.</span><span class="n">wq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__uwb_rc_put</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">UWB_EVT_TYPE_NOTIF</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">notif</span><span class="p">.</span><span class="n">rceb</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwbd</span><span class="p">.</span><span class="n">event_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">uwbd_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">,</span> <span class="o">*</span><span class="n">nxt</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwbd</span><span class="p">.</span><span class="n">event_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">nxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwbd</span><span class="p">.</span><span class="n">event_list</span><span class="p">,</span> <span class="n">list_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">==</span> <span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__uwb_rc_put</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">list_node</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">UWB_EVT_TYPE_NOTIF</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">notif</span><span class="p">.</span><span class="n">rceb</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwbd</span><span class="p">.</span><span class="n">event_list_lock</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
