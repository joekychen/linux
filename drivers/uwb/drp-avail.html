<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › uwb › drp-avail.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>drp-avail.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Ultra Wide Band</span>
<span class="cm"> * DRP availability management</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2006 Intel Corporation</span>
<span class="cm"> * Reinette Chatre &lt;reinette.chatre@intel.com&gt;</span>
<span class="cm"> * Copyright (C) 2008 Cambridge Silicon Radio Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version</span>
<span class="cm"> * 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Manage DRP Availability (the MAS available for DRP</span>
<span class="cm"> * reservations). Thus:</span>
<span class="cm"> *</span>
<span class="cm"> * - Handle DRP Availability Change notifications</span>
<span class="cm"> *</span>
<span class="cm"> * - Allow the reservation manager to indicate MAS reserved/released</span>
<span class="cm"> *   by local (owned by/targeted at the radio controller)</span>
<span class="cm"> *   reservations.</span>
<span class="cm"> *</span>
<span class="cm"> * - Based on the two sources above, generate a DRP Availability IE to</span>
<span class="cm"> *   be included in the beacon.</span>
<span class="cm"> *</span>
<span class="cm"> * See also the documentation for struct uwb_drp_avail.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/bitmap.h&gt;</span>
<span class="cp">#include &quot;uwb-internal.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * uwb_drp_avail_init - initialize an RC&#39;s MAS availability</span>
<span class="cm"> *</span>
<span class="cm"> * All MAS are available initially.  The RC will inform use which</span>
<span class="cm"> * slots are used for the BP (it may change in size).</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">uwb_drp_avail_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bitmap_fill</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">global</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>
	<span class="n">bitmap_fill</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">local</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>
	<span class="n">bitmap_fill</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">pending</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Determine MAS available for new local reservations.</span>
<span class="cm"> *</span>
<span class="cm"> * avail = global &amp; local &amp; pending</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">uwb_drp_available</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="o">*</span><span class="n">avail</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bitmap_and</span><span class="p">(</span><span class="n">avail</span><span class="o">-&gt;</span><span class="n">bm</span><span class="p">,</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">global</span><span class="p">,</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">local</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>
	<span class="n">bitmap_and</span><span class="p">(</span><span class="n">avail</span><span class="o">-&gt;</span><span class="n">bm</span><span class="p">,</span> <span class="n">avail</span><span class="o">-&gt;</span><span class="n">bm</span><span class="p">,</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">pending</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * uwb_drp_avail_reserve_pending - reserve MAS for a new reservation</span>
<span class="cm"> * @rc: the radio controller</span>
<span class="cm"> * @mas: the MAS to reserve</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, or -EBUSY if the MAS requested aren&#39;t available.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">uwb_drp_avail_reserve_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="o">*</span><span class="n">mas</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="n">avail</span><span class="p">;</span>

	<span class="n">uwb_drp_available</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">avail</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap_subset</span><span class="p">(</span><span class="n">mas</span><span class="o">-&gt;</span><span class="n">bm</span><span class="p">,</span> <span class="n">avail</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">bitmap_andnot</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">pending</span><span class="p">,</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">pending</span><span class="p">,</span> <span class="n">mas</span><span class="o">-&gt;</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * uwb_drp_avail_reserve - reserve MAS for an established reservation</span>
<span class="cm"> * @rc: the radio controller</span>
<span class="cm"> * @mas: the MAS to reserve</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">uwb_drp_avail_reserve</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="o">*</span><span class="n">mas</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bitmap_or</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">pending</span><span class="p">,</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">pending</span><span class="p">,</span> <span class="n">mas</span><span class="o">-&gt;</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>
	<span class="n">bitmap_andnot</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">local</span><span class="p">,</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">local</span><span class="p">,</span> <span class="n">mas</span><span class="o">-&gt;</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">ie_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * uwb_drp_avail_release - release MAS from a pending or established reservation</span>
<span class="cm"> * @rc: the radio controller</span>
<span class="cm"> * @mas: the MAS to release</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">uwb_drp_avail_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="o">*</span><span class="n">mas</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bitmap_or</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">local</span><span class="p">,</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">local</span><span class="p">,</span> <span class="n">mas</span><span class="o">-&gt;</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>
	<span class="n">bitmap_or</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">pending</span><span class="p">,</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">pending</span><span class="p">,</span> <span class="n">mas</span><span class="o">-&gt;</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">ie_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">uwb_rsv_handle_drp_avail_change</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * uwb_drp_avail_ie_update - update the DRP Availability IE</span>
<span class="cm"> * @rc: the radio controller</span>
<span class="cm"> *</span>
<span class="cm"> * avail = global &amp; local</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">uwb_drp_avail_ie_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="n">avail</span><span class="p">;</span>

	<span class="n">bitmap_and</span><span class="p">(</span><span class="n">avail</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">global</span><span class="p">,</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">local</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>

	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">ie</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">=</span> <span class="n">UWB_IE_DRP_AVAILABILITY</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">ie</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">UWB_NUM_MAS</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">uwb_mas_bm_copy_le</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">ie</span><span class="p">.</span><span class="n">bmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">avail</span><span class="p">);</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">ie_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Create an unsigned long from a buffer containing a byte stream.</span>
<span class="cm"> *</span>
<span class="cm"> * @array: pointer to buffer</span>
<span class="cm"> * @itr:   index of buffer from where we start</span>
<span class="cm"> * @len:   the buffer&#39;s remaining size may not be exact multiple of</span>
<span class="cm"> *         sizeof(unsigned long), @len is the length of buffer that needs</span>
<span class="cm"> *         to be converted. This will be sizeof(unsigned long) or smaller</span>
<span class="cm"> *         (BUG if not). If it is smaller then we will pad the remaining</span>
<span class="cm"> *         space of the result with zeroes.</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">get_val</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">array</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">itr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">top</span> <span class="o">=</span> <span class="n">itr</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">itr</span> <span class="o">&lt;</span> <span class="n">top</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">array</span><span class="p">[</span><span class="n">top</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">top</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span> <span class="cm">/* padding */</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Initialize bitmap from data buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * The bitmap to be converted could come from a IE, for example a</span>
<span class="cm"> * DRP Availability IE.</span>
<span class="cm"> * From ECMA-368 1.0 [16.8.7]: &quot;</span>
<span class="cm"> * octets: 1            1               N * (0 to 32)</span>
<span class="cm"> *         Element ID   Length (=N)     DRP Availability Bitmap</span>
<span class="cm"> *</span>
<span class="cm"> * The DRP Availability Bitmap field is up to 256 bits long, one</span>
<span class="cm"> * bit for each MAS in the superframe, where the least-significant</span>
<span class="cm"> * bit of the field corresponds to the first MAS in the superframe</span>
<span class="cm"> * and successive bits correspond to successive MASs.&quot;</span>
<span class="cm"> *</span>
<span class="cm"> * The DRP Availability bitmap is in octets from 0 to 32, so octet</span>
<span class="cm"> * 32 contains bits for MAS 1-8, etc. If the bitmap is smaller than 32</span>
<span class="cm"> * octets, the bits in octets not included at the end of the bitmap are</span>
<span class="cm"> * treated as zero. In this case (when the bitmap is smaller than 32</span>
<span class="cm"> * octets) the MAS represented range from MAS 1 to MAS (size of bitmap)</span>
<span class="cm"> * with the last octet still containing bits for MAS 1-8, etc.</span>
<span class="cm"> *</span>
<span class="cm"> * For example:</span>
<span class="cm"> * F00F0102 03040506 0708090A 0B0C0D0E 0F010203</span>
<span class="cm"> * ^^^^</span>
<span class="cm"> * ||||</span>
<span class="cm"> * ||||</span>
<span class="cm"> * |||\LSB of byte is MAS 9</span>
<span class="cm"> * ||\MSB of byte is MAS 16</span>
<span class="cm"> * |\LSB of first byte is MAS 1</span>
<span class="cm"> * \ MSB of byte is MAS 8</span>
<span class="cm"> *</span>
<span class="cm"> * An example of this encoding can be found in ECMA-368 Annex-D [Table D.11]</span>
<span class="cm"> *</span>
<span class="cm"> * The resulting bitmap will have the following mapping:</span>
<span class="cm"> *	bit position 0 == MAS 1</span>
<span class="cm"> *	bit position 1 == MAS 2</span>
<span class="cm"> *	...</span>
<span class="cm"> *	bit position (UWB_NUM_MAS - 1) == MAS UWB_NUM_MAS</span>
<span class="cm"> *</span>
<span class="cm"> * @bmp_itr:	pointer to bitmap (can be declared with DECLARE_BITMAP)</span>
<span class="cm"> * @buffer:	pointer to buffer containing bitmap data in big endian</span>
<span class="cm"> *              format (MSB first)</span>
<span class="cm"> * @buffer_size:number of bytes with which bitmap should be initialized</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">void</span> <span class="nf">buffer_to_bmp</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bmp_itr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_buffer</span><span class="p">,</span>
		   <span class="kt">size_t</span> <span class="n">buffer_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">_buffer</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">itr</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">itr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">itr</span> <span class="o">&lt;</span> <span class="n">buffer_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">buffer_size</span> <span class="o">-</span> <span class="n">itr</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">?</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">:</span> <span class="n">buffer_size</span> <span class="o">-</span> <span class="n">itr</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">get_val</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">itr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">bmp_itr</span><span class="p">[</span><span class="n">itr</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">)]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">itr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Extract DRP Availability bitmap from the notification.</span>
<span class="cm"> *</span>
<span class="cm"> * The notification that comes in contains a bitmap of (UWB_NUM_MAS / 8) bytes</span>
<span class="cm"> * We convert that to our internal representation.</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">int</span> <span class="nf">uwbd_evt_get_drp_avail</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bmp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwb_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_rc_evt_drp_avail</span> <span class="o">*</span><span class="n">drp_evt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Is there enough data to decode the event? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">notif</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">drp_evt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DRP Availability Change: Not enough &quot;</span>
			<span class="s">&quot;data to decode event [%zu bytes, %zu &quot;</span>
			<span class="s">&quot;needed]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">notif</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">drp_evt</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">drp_evt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">notif</span><span class="p">.</span><span class="n">rceb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_rc_evt_drp_avail</span><span class="p">,</span> <span class="n">rceb</span><span class="p">);</span>
	<span class="n">buffer_to_bmp</span><span class="p">(</span><span class="n">bmp</span><span class="p">,</span> <span class="n">drp_evt</span><span class="o">-&gt;</span><span class="n">bmp</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Process an incoming DRP Availability notification.</span>
<span class="cm"> *</span>
<span class="cm"> * @evt:	Event information (packs the actual event data, which</span>
<span class="cm"> *              radio controller it came to, etc).</span>
<span class="cm"> *</span>
<span class="cm"> * @returns:    0 on success (so uwbd() frees the event buffer), &lt; 0</span>
<span class="cm"> *              on error.</span>
<span class="cm"> *</span>
<span class="cm"> * According to ECMA-368 1.0 [16.8.7], bits set to ONE indicate that</span>
<span class="cm"> * the MAS slot is available, bits set to ZERO indicate that the slot</span>
<span class="cm"> * is busy.</span>
<span class="cm"> *</span>
<span class="cm"> * So we clear available slots, we set used slots :)</span>
<span class="cm"> *</span>
<span class="cm"> * The notification only marks non-availability based on the BP and</span>
<span class="cm"> * received DRP IEs that are not for this radio controller.  A copy of</span>
<span class="cm"> * this bitmap is needed to generate the real availability (which</span>
<span class="cm"> * includes local and pending reservations).</span>
<span class="cm"> *</span>
<span class="cm"> * The DRP Availability IE that this radio controller emits will need</span>
<span class="cm"> * to be updated.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">uwbd_evt_handle_rc_drp_avail</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">;</span>
	<span class="n">DECLARE_BITMAP</span><span class="p">(</span><span class="n">bmp</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">uwbd_evt_get_drp_avail</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">bmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rsvs_mutex</span><span class="p">);</span>
	<span class="n">bitmap_copy</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">global</span><span class="p">,</span> <span class="n">bmp</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">ie_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">uwb_rsv_handle_drp_avail_change</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rsvs_mutex</span><span class="p">);</span>

	<span class="n">uwb_rsv_sched_update</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
