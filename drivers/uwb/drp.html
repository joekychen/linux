<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › uwb › drp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>drp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Ultra Wide Band</span>
<span class="cm"> * Dynamic Reservation Protocol handling</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2006 Intel Corporation</span>
<span class="cm"> * Inaky Perez-Gonzalez &lt;inaky.perez-gonzalez@intel.com&gt;</span>
<span class="cm"> * Copyright (C) 2008 Cambridge Silicon Radio Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version</span>
<span class="cm"> * 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &quot;uwb-internal.h&quot;</span>


<span class="cm">/* DRP Conflict Actions ([ECMA-368 2nd Edition] 17.4.6) */</span>
<span class="k">enum</span> <span class="n">uwb_drp_conflict_action</span> <span class="p">{</span>
	<span class="cm">/* Reservation is maintained, no action needed */</span>
	<span class="n">UWB_DRP_CONFLICT_MANTAIN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	
	<span class="cm">/* the device shall not transmit frames in conflicting MASs in</span>
<span class="cm">	 * the following superframe. If the device is the reservation</span>
<span class="cm">	 * target, it shall also set the Reason Code in its DRP IE to</span>
<span class="cm">	 * Conflict in its beacon in the following superframe.</span>
<span class="cm">	 */</span>
	<span class="n">UWB_DRP_CONFLICT_ACT1</span><span class="p">,</span>
	
	<span class="cm">/* the device shall not set the Reservation Status bit to ONE</span>
<span class="cm">	 * and shall not transmit frames in conflicting MASs. If the</span>
<span class="cm">	 * device is the reservation target, it shall also set the</span>
<span class="cm">	 * Reason Code in its DRP IE to Conflict.</span>
<span class="cm">	 */</span>	
	<span class="n">UWB_DRP_CONFLICT_ACT2</span><span class="p">,</span>

	<span class="cm">/* the device shall not transmit frames in conflicting MASs in</span>
<span class="cm">	 * the following superframe. It shall remove the conflicting</span>
<span class="cm">	 * MASs from the reservation or set the Reservation Status to</span>
<span class="cm">	 * ZERO in its beacon in the following superframe. If the</span>
<span class="cm">	 * device is the reservation target, it shall also set the</span>
<span class="cm">	 * Reason Code in its DRP IE to Conflict.</span>
<span class="cm">	 */</span>
	<span class="n">UWB_DRP_CONFLICT_ACT3</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">uwb_rc_set_drp_cmd_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">uwb_rceb</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">ssize_t</span> <span class="n">reply_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uwb_rc_evt_set_drp_ie</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc_evt_set_drp_ie</span> <span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">bResultCode</span> <span class="o">!=</span> <span class="n">UWB_RC_RES_SUCCESS</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwb_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SET-DRP-IE failed: %s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">uwb_rc_strerror</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">bResultCode</span><span class="p">),</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">bResultCode</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwb_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SET-DRP-IE: timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rsvs_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">set_drp_ie_pending</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">set_drp_ie_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">uwb_rsv_queue_update</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>	
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">set_drp_ie_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rsvs_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Construct and send the SET DRP IE</span>
<span class="cm"> *</span>
<span class="cm"> * @rc:         UWB Host controller</span>
<span class="cm"> * @returns:    &gt;= 0 number of bytes still available in the beacon</span>
<span class="cm"> *              &lt; 0 errno code on error.</span>
<span class="cm"> *</span>
<span class="cm"> * See WUSB[8.6.2.7]: The host must set all the DRP IEs that it wants the</span>
<span class="cm"> * device to include in its beacon at the same time. We thus have to</span>
<span class="cm"> * traverse all reservations and include the DRP IEs of all PENDING</span>
<span class="cm"> * and NEGOTIATED reservations in a SET DRP command for transmission.</span>
<span class="cm"> *</span>
<span class="cm"> * A DRP Availability IE is appended.</span>
<span class="cm"> *</span>
<span class="cm"> * rc-&gt;rsvs_mutex is held</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME We currently ignore the returned value indicating the remaining space</span>
<span class="cm"> * in beacon. This could be used to deny reservation requests earlier if</span>
<span class="cm"> * determined that they would cause the beacon space to be exceeded.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">uwb_rc_send_all_drp_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_rc_cmd_set_drp_ie</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_rsv_move</span> <span class="o">*</span><span class="n">mv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">IEDataptr</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="cm">/* First traverse all reservations to determine memory needed. */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">reservations</span><span class="p">,</span> <span class="n">rc_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">drp_ie</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">num_bytes</span> <span class="o">+=</span> <span class="n">rsv</span><span class="o">-&gt;</span><span class="n">drp_ie</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">uwb_rsv_has_two_drp_ies</span><span class="p">(</span><span class="n">rsv</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mv</span><span class="p">.</span><span class="n">companion_drp_ie</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">mv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mv</span><span class="p">;</span>
				<span class="n">num_bytes</span> <span class="o">+=</span> <span class="n">mv</span><span class="o">-&gt;</span><span class="n">companion_drp_ie</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>	
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">num_bytes</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">ie</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_bytes</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rccb</span><span class="p">.</span><span class="n">bCommandType</span> <span class="o">=</span> <span class="n">UWB_RC_CET_GENERAL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rccb</span><span class="p">.</span><span class="n">wCommand</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">UWB_RC_CMD_SET_DRP_IE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">wIELength</span> <span class="o">=</span> <span class="n">num_bytes</span><span class="p">;</span>
	<span class="n">IEDataptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">IEData</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* FIXME: DRV avail IE is not always needed */</span>
	<span class="cm">/* put DRP avail IE first */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">IEDataptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">ie</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">drp_avail</span><span class="p">.</span><span class="n">ie</span><span class="p">));</span>
	<span class="n">IEDataptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_ie_drp_avail</span><span class="p">);</span>

	<span class="cm">/* Next traverse all reservations to place IEs in allocated memory. */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">reservations</span><span class="p">,</span> <span class="n">rc_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">drp_ie</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">IEDataptr</span><span class="p">,</span> <span class="n">rsv</span><span class="o">-&gt;</span><span class="n">drp_ie</span><span class="p">,</span>
			       <span class="n">rsv</span><span class="o">-&gt;</span><span class="n">drp_ie</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">IEDataptr</span> <span class="o">+=</span> <span class="n">rsv</span><span class="o">-&gt;</span><span class="n">drp_ie</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="n">uwb_rsv_has_two_drp_ies</span><span class="p">(</span><span class="n">rsv</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mv</span><span class="p">.</span><span class="n">companion_drp_ie</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">mv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mv</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">IEDataptr</span><span class="p">,</span> <span class="n">mv</span><span class="o">-&gt;</span><span class="n">companion_drp_ie</span><span class="p">,</span>
				       <span class="n">mv</span><span class="o">-&gt;</span><span class="n">companion_drp_ie</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">IEDataptr</span> <span class="o">+=</span> <span class="n">mv</span><span class="o">-&gt;</span><span class="n">companion_drp_ie</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>	
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">uwb_rc_cmd_async</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="s">&quot;SET-DRP-IE&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rccb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_bytes</span><span class="p">,</span>
				  <span class="n">UWB_RC_CET_GENERAL</span><span class="p">,</span> <span class="n">UWB_RC_CMD_SET_DRP_IE</span><span class="p">,</span>
				  <span class="n">uwb_rc_set_drp_cmd_done</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">set_drp_ie_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Evaluate the action to perform using conflict resolution rules</span>
<span class="cm"> *</span>
<span class="cm"> * Return a uwb_drp_conflict_action.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">evaluate_conflict_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_ie_drp</span> <span class="o">*</span><span class="n">ext_drp_ie</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ext_beacon_slot</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">our_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">our_tie_breaker</span> <span class="o">=</span> <span class="n">rsv</span><span class="o">-&gt;</span><span class="n">tiebreaker</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">our_type</span>        <span class="o">=</span> <span class="n">rsv</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">our_beacon_slot</span> <span class="o">=</span> <span class="n">rsv</span><span class="o">-&gt;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwb_dev</span><span class="p">.</span><span class="n">beacon_slot</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ext_tie_breaker</span> <span class="o">=</span> <span class="n">uwb_ie_drp_tiebreaker</span><span class="p">(</span><span class="n">ext_drp_ie</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ext_status</span>      <span class="o">=</span> <span class="n">uwb_ie_drp_status</span><span class="p">(</span><span class="n">ext_drp_ie</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ext_type</span>        <span class="o">=</span> <span class="n">uwb_ie_drp_type</span><span class="p">(</span><span class="n">ext_drp_ie</span><span class="p">);</span>
	
	
	<span class="cm">/* [ECMA-368 2nd Edition] 17.4.6 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext_type</span> <span class="o">==</span> <span class="n">UWB_DRP_TYPE_PCA</span> <span class="o">&amp;&amp;</span> <span class="n">our_type</span> <span class="o">==</span> <span class="n">UWB_DRP_TYPE_PCA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">UWB_DRP_CONFLICT_MANTAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* [ECMA-368 2nd Edition] 17.4.6-1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">our_type</span> <span class="o">==</span> <span class="n">UWB_DRP_TYPE_ALIEN_BP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">UWB_DRP_CONFLICT_MANTAIN</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* [ECMA-368 2nd Edition] 17.4.6-2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext_type</span> <span class="o">==</span> <span class="n">UWB_DRP_TYPE_ALIEN_BP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* here we know our_type != UWB_DRP_TYPE_ALIEN_BP */</span>
		<span class="k">return</span> <span class="n">UWB_DRP_CONFLICT_ACT1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* [ECMA-368 2nd Edition] 17.4.6-3 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">our_status</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ext_status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">UWB_DRP_CONFLICT_ACT2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* [ECMA-368 2nd Edition] 17.4.6-4 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">our_status</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ext_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">UWB_DRP_CONFLICT_MANTAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* [ECMA-368 2nd Edition] 17.4.6-5a */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">our_tie_breaker</span> <span class="o">==</span> <span class="n">ext_tie_breaker</span> <span class="o">&amp;&amp;</span>
	    <span class="n">our_beacon_slot</span> <span class="o">&lt;</span>  <span class="n">ext_beacon_slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">UWB_DRP_CONFLICT_MANTAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* [ECMA-368 2nd Edition] 17.4.6-5b */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">our_tie_breaker</span> <span class="o">!=</span> <span class="n">ext_tie_breaker</span> <span class="o">&amp;&amp;</span>
	    <span class="n">our_beacon_slot</span> <span class="o">&gt;</span>  <span class="n">ext_beacon_slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">UWB_DRP_CONFLICT_MANTAIN</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">our_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">our_tie_breaker</span> <span class="o">==</span> <span class="n">ext_tie_breaker</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* [ECMA-368 2nd Edition] 17.4.6-6a */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">our_beacon_slot</span> <span class="o">&gt;</span> <span class="n">ext_beacon_slot</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="n">UWB_DRP_CONFLICT_ACT2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
			<span class="cm">/* [ECMA-368 2nd Edition] 17.4.6-6b */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">our_beacon_slot</span> <span class="o">&lt;</span> <span class="n">ext_beacon_slot</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="n">UWB_DRP_CONFLICT_ACT2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">our_tie_breaker</span> <span class="o">==</span> <span class="n">ext_tie_breaker</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* [ECMA-368 2nd Edition] 17.4.6-7a */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">our_beacon_slot</span> <span class="o">&gt;</span> <span class="n">ext_beacon_slot</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="n">UWB_DRP_CONFLICT_ACT3</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* [ECMA-368 2nd Edition] 17.4.6-7b */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">our_beacon_slot</span> <span class="o">&lt;</span> <span class="n">ext_beacon_slot</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="n">UWB_DRP_CONFLICT_ACT3</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">UWB_DRP_CONFLICT_MANTAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_conflict_normal</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_ie_drp</span> <span class="o">*</span><span class="n">drp_ie</span><span class="p">,</span> 
				   <span class="kt">int</span> <span class="n">ext_beacon_slot</span><span class="p">,</span> 
				   <span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">,</span> 
				   <span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="o">*</span><span class="n">conflicting_mas</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="n">rsv</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_rsv_move</span> <span class="o">*</span><span class="n">mv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_drp_backoff_win</span> <span class="o">*</span><span class="n">bow</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">bow</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">action</span><span class="p">;</span>

	<span class="n">action</span> <span class="o">=</span> <span class="n">evaluate_conflict_action</span><span class="p">(</span><span class="n">drp_ie</span><span class="p">,</span> <span class="n">ext_beacon_slot</span><span class="p">,</span> <span class="n">rsv</span><span class="p">,</span> <span class="n">uwb_rsv_status</span><span class="p">(</span><span class="n">rsv</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uwb_rsv_is_owner</span><span class="p">(</span><span class="n">rsv</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">UWB_DRP_CONFLICT_ACT2</span>:
			<span class="cm">/* try move */</span>
			<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_O_TO_BE_MOVED</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bow</span><span class="o">-&gt;</span><span class="n">can_reserve_extra_mases</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
				<span class="n">uwb_rsv_backoff_win_increment</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
			
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UWB_DRP_CONFLICT_ACT3</span>:
			<span class="n">uwb_rsv_backoff_win_increment</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
			<span class="cm">/* drop some mases with reason modified */</span>
			<span class="cm">/* put in the companion the mases to be dropped */</span>
			<span class="n">bitmap_and</span><span class="p">(</span><span class="n">mv</span><span class="o">-&gt;</span><span class="n">companion_mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">conflicting_mas</span><span class="o">-&gt;</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>
			<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_O_MODIFIED</span><span class="p">);</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">UWB_DRP_CONFLICT_ACT2</span>:
		<span class="k">case</span> <span class="n">UWB_DRP_CONFLICT_ACT3</span>:
			<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_T_CONFLICT</span><span class="p">);</span>	
		<span class="k">default</span><span class="o">:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_conflict_expanding</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_ie_drp</span> <span class="o">*</span><span class="n">drp_ie</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ext_beacon_slot</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">,</span> <span class="n">bool</span> <span class="n">companion_only</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="o">*</span><span class="n">conflicting_mas</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="n">rsv</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_drp_backoff_win</span> <span class="o">*</span><span class="n">bow</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">bow</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_rsv_move</span> <span class="o">*</span><span class="n">mv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">action</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">companion_only</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* status of companion is 0 at this point */</span>
		<span class="n">action</span> <span class="o">=</span> <span class="n">evaluate_conflict_action</span><span class="p">(</span><span class="n">drp_ie</span><span class="p">,</span> <span class="n">ext_beacon_slot</span><span class="p">,</span> <span class="n">rsv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uwb_rsv_is_owner</span><span class="p">(</span><span class="n">rsv</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">UWB_DRP_CONFLICT_ACT2</span>:
			<span class="k">case</span> <span class="n">UWB_DRP_CONFLICT_ACT3</span>:
				<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_O_ESTABLISHED</span><span class="p">);</span>
				<span class="n">rsv</span><span class="o">-&gt;</span><span class="n">needs_release_companion_mas</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bow</span><span class="o">-&gt;</span><span class="n">can_reserve_extra_mases</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
					<span class="n">uwb_rsv_backoff_win_increment</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
				<span class="n">uwb_drp_avail_release</span><span class="p">(</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mv</span><span class="p">.</span><span class="n">companion_mas</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* rsv is target */</span>			
			<span class="k">switch</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">UWB_DRP_CONFLICT_ACT2</span>:
			<span class="k">case</span> <span class="n">UWB_DRP_CONFLICT_ACT3</span>:
				<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_T_EXPANDING_CONFLICT</span><span class="p">);</span>
                                <span class="cm">/* send_drp_avail_ie = true; */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* also base part of the reservation is conflicting */</span>		
		<span class="k">if</span> <span class="p">(</span><span class="n">uwb_rsv_is_owner</span><span class="p">(</span><span class="n">rsv</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">uwb_rsv_backoff_win_increment</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
			<span class="cm">/* remove companion part */</span>
			<span class="n">uwb_drp_avail_release</span><span class="p">(</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mv</span><span class="p">.</span><span class="n">companion_mas</span><span class="p">);</span>

			<span class="cm">/* drop some mases with reason modified */</span>

			<span class="cm">/* put in the companion the mases to be dropped */</span>
			<span class="n">bitmap_andnot</span><span class="p">(</span><span class="n">mv</span><span class="o">-&gt;</span><span class="n">companion_mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">conflicting_mas</span><span class="o">-&gt;</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>
			<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_O_MODIFIED</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* it is a target rsv */</span>
			<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_T_CONFLICT</span><span class="p">);</span>
                        <span class="cm">/* send_drp_avail_ie = true; */</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uwb_drp_handle_conflict_rsv</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">uwb_rc_evt_drp</span> <span class="o">*</span><span class="n">drp_evt</span><span class="p">,</span> 
					<span class="k">struct</span> <span class="n">uwb_ie_drp</span> <span class="o">*</span><span class="n">drp_ie</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="o">*</span><span class="n">conflicting_mas</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uwb_rsv_move</span> <span class="o">*</span><span class="n">mv</span><span class="p">;</span>

	<span class="cm">/* check if the conflicting reservation has two drp_ies */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uwb_rsv_has_two_drp_ies</span><span class="p">(</span><span class="n">rsv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mv</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bitmap_intersects</span><span class="p">(</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">conflicting_mas</span><span class="o">-&gt;</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">handle_conflict_expanding</span><span class="p">(</span><span class="n">drp_ie</span><span class="p">,</span> <span class="n">drp_evt</span><span class="o">-&gt;</span><span class="n">beacon_slot_number</span><span class="p">,</span>
						  <span class="n">rsv</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">conflicting_mas</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bitmap_intersects</span><span class="p">(</span><span class="n">mv</span><span class="o">-&gt;</span><span class="n">companion_mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">conflicting_mas</span><span class="o">-&gt;</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">handle_conflict_expanding</span><span class="p">(</span><span class="n">drp_ie</span><span class="p">,</span> <span class="n">drp_evt</span><span class="o">-&gt;</span><span class="n">beacon_slot_number</span><span class="p">,</span>
							  <span class="n">rsv</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">conflicting_mas</span><span class="p">);</span>	
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bitmap_intersects</span><span class="p">(</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">conflicting_mas</span><span class="o">-&gt;</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">handle_conflict_normal</span><span class="p">(</span><span class="n">drp_ie</span><span class="p">,</span> <span class="n">drp_evt</span><span class="o">-&gt;</span><span class="n">beacon_slot_number</span><span class="p">,</span> <span class="n">rsv</span><span class="p">,</span> <span class="n">conflicting_mas</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uwb_drp_handle_all_conflict_rsv</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">uwb_rc_evt_drp</span> <span class="o">*</span><span class="n">drp_evt</span><span class="p">,</span> 
					    <span class="k">struct</span> <span class="n">uwb_ie_drp</span> <span class="o">*</span><span class="n">drp_ie</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="o">*</span><span class="n">conflicting_mas</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">;</span>
	
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">reservations</span><span class="p">,</span> <span class="n">rc_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uwb_drp_handle_conflict_rsv</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">rsv</span><span class="p">,</span> <span class="n">drp_evt</span><span class="p">,</span> <span class="n">drp_ie</span><span class="p">,</span> <span class="n">conflicting_mas</span><span class="p">);</span>	
	<span class="p">}</span>
<span class="p">}</span>
	
<span class="cm">/*</span>
<span class="cm"> * Based on the DRP IE, transition a target reservation to a new</span>
<span class="cm"> * state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uwb_drp_process_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">uwb_ie_drp</span> <span class="o">*</span><span class="n">drp_ie</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_rc_evt_drp</span> <span class="o">*</span><span class="n">drp_evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwb_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_rsv_move</span> <span class="o">*</span><span class="n">mv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">uwb_drp_reason</span> <span class="n">reason_code</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="n">mas</span><span class="p">;</span>
	
	<span class="n">status</span> <span class="o">=</span> <span class="n">uwb_ie_drp_status</span><span class="p">(</span><span class="n">drp_ie</span><span class="p">);</span>
	<span class="n">reason_code</span> <span class="o">=</span> <span class="n">uwb_ie_drp_reason_code</span><span class="p">(</span><span class="n">drp_ie</span><span class="p">);</span>
	<span class="n">uwb_drp_ie_to_bm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mas</span><span class="p">,</span> <span class="n">drp_ie</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reason_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">UWB_DRP_REASON_ACCEPTED</span>:

		<span class="k">if</span> <span class="p">(</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">UWB_RSV_STATE_T_CONFLICT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_T_CONFLICT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">UWB_RSV_STATE_T_EXPANDING_ACCEPTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* drp_ie is companion */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap_equal</span><span class="p">(</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">))</span>
				<span class="cm">/* stroke companion */</span>
				<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_T_EXPANDING_ACCEPTED</span><span class="p">);</span>	
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap_equal</span><span class="p">(</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">uwb_drp_avail_reserve_pending</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mas</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* FIXME: there is a conflict, find</span>
<span class="cm">					 * the conflicting reservations and</span>
<span class="cm">					 * take a sensible action. Consider</span>
<span class="cm">					 * that in drp_ie there is the</span>
<span class="cm">					 * &quot;neighbour&quot; */</span>
					<span class="n">uwb_drp_handle_all_conflict_rsv</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">drp_evt</span><span class="p">,</span> <span class="n">drp_ie</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mas</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* accept the extra reservation */</span>
					<span class="n">bitmap_copy</span><span class="p">(</span><span class="n">mv</span><span class="o">-&gt;</span><span class="n">companion_mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>
					<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_T_EXPANDING_ACCEPTED</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_T_ACCEPTED</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UWB_DRP_REASON_MODIFIED</span>:
		<span class="cm">/* check to see if we have already modified the reservation */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bitmap_equal</span><span class="p">(</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_T_ACCEPTED</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* find if the owner wants to expand or reduce */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bitmap_subset</span><span class="p">(</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* owner is reducing */</span>
			<span class="n">bitmap_andnot</span><span class="p">(</span><span class="n">mv</span><span class="o">-&gt;</span><span class="n">companion_mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>
			<span class="n">uwb_drp_avail_release</span><span class="p">(</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mv</span><span class="o">-&gt;</span><span class="n">companion_mas</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">bitmap_copy</span><span class="p">(</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>
		<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_T_RESIZED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ignoring invalid DRP IE state (%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">reason_code</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Based on the DRP IE, transition an owner reservation to a new</span>
<span class="cm"> * state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uwb_drp_process_owner</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">uwb_dev</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_ie_drp</span> <span class="o">*</span><span class="n">drp_ie</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">uwb_rc_evt_drp</span> <span class="o">*</span><span class="n">drp_evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwb_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_rsv_move</span> <span class="o">*</span><span class="n">mv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">uwb_drp_reason</span> <span class="n">reason_code</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="n">mas</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">uwb_ie_drp_status</span><span class="p">(</span><span class="n">drp_ie</span><span class="p">);</span>
	<span class="n">reason_code</span> <span class="o">=</span> <span class="n">uwb_ie_drp_reason_code</span><span class="p">(</span><span class="n">drp_ie</span><span class="p">);</span>
	<span class="n">uwb_drp_ie_to_bm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mas</span><span class="p">,</span> <span class="n">drp_ie</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">reason_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">UWB_DRP_REASON_ACCEPTED</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">UWB_RSV_STATE_O_PENDING</span>:
			<span class="k">case</span> <span class="n">UWB_RSV_STATE_O_INITIATED</span>:
			<span class="k">case</span> <span class="n">UWB_RSV_STATE_O_ESTABLISHED</span>:
				<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_O_ESTABLISHED</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">UWB_RSV_STATE_O_MODIFIED</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">bitmap_equal</span><span class="p">(</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_O_ESTABLISHED</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_O_MODIFIED</span><span class="p">);</span>	
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
				
			<span class="k">case</span> <span class="n">UWB_RSV_STATE_O_MOVE_REDUCING</span>: <span class="cm">/* shouldn&#39; t be a problem */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bitmap_equal</span><span class="p">(</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_O_ESTABLISHED</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_O_MOVE_REDUCING</span><span class="p">);</span>	
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">UWB_RSV_STATE_O_MOVE_EXPANDING</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">bitmap_equal</span><span class="p">(</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">mv</span><span class="o">-&gt;</span><span class="n">companion_mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* Companion reservation accepted */</span>
					<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_O_MOVE_COMBINING</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_O_MOVE_EXPANDING</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">UWB_RSV_STATE_O_MOVE_COMBINING</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">bitmap_equal</span><span class="p">(</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">rsv</span><span class="o">-&gt;</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">))</span>
					<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_O_MOVE_REDUCING</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_O_MOVE_COMBINING</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>	
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ignoring invalid DRP IE state (%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">reason_code</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">reason_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">UWB_DRP_REASON_PENDING</span>:
			<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_O_PENDING</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UWB_DRP_REASON_DENIED</span>:
			<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_NONE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UWB_DRP_REASON_CONFLICT</span>:
			<span class="cm">/* resolve the conflict */</span>
			<span class="n">bitmap_complement</span><span class="p">(</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">last_availability_bm</span><span class="p">,</span>
					  <span class="n">UWB_NUM_MAS</span><span class="p">);</span>
			<span class="n">uwb_drp_handle_conflict_rsv</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">rsv</span><span class="p">,</span> <span class="n">drp_evt</span><span class="p">,</span> <span class="n">drp_ie</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mas</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ignoring invalid DRP IE state (%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">reason_code</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uwb_cnflt_alien_stroke_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_cnflt_alien</span> <span class="o">*</span><span class="n">cnflt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">timeout_us</span> <span class="o">=</span> <span class="n">UWB_MAX_LOST_BEACONS</span> <span class="o">*</span> <span class="n">UWB_SUPERFRAME_LENGTH_US</span><span class="p">;</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cnflt</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">usecs_to_jiffies</span><span class="p">(</span><span class="n">timeout_us</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uwb_cnflt_update_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uwb_cnflt_alien</span> <span class="o">*</span><span class="n">cnflt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
						     <span class="k">struct</span> <span class="n">uwb_cnflt_alien</span><span class="p">,</span>
						     <span class="n">cnflt_update_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">uwb_cnflt_alien</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="n">cnflt</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">;</span>
	
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay_us</span> <span class="o">=</span> <span class="n">UWB_MAS_LENGTH_US</span> <span class="o">*</span> <span class="n">UWB_MAS_PER_ZONE</span><span class="p">;</span>
	
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rsvs_mutex</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cnflt</span><span class="o">-&gt;</span><span class="n">rc_node</span><span class="p">);</span>

	<span class="cm">/* update rc global conflicting alien bitmap */</span>
	<span class="n">bitmap_zero</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">cnflt_alien_bitmap</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">cnflt_alien_list</span><span class="p">,</span> <span class="n">rc_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bitmap_or</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">cnflt_alien_bitmap</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">cnflt_alien_bitmap</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>			
	<span class="p">}</span>
	
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rsv_workq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rsv_alien_bp_work</span><span class="p">,</span> <span class="n">usecs_to_jiffies</span><span class="p">(</span><span class="n">delay_us</span><span class="p">));</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">cnflt</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rsvs_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uwb_cnflt_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uwb_cnflt_alien</span> <span class="o">*</span><span class="n">cnflt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uwb_cnflt_alien</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">cnflt</span><span class="o">-&gt;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rsv_workq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cnflt</span><span class="o">-&gt;</span><span class="n">cnflt_update_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We have received an DRP_IE of type Alien BP and we need to make</span>
<span class="cm"> * sure we do not transmit in conflicting MASs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uwb_drp_handle_alien_drp</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_ie_drp</span> <span class="o">*</span><span class="n">drp_ie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwb_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="n">mas</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_cnflt_alien</span> <span class="o">*</span><span class="n">cnflt</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">72</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay_us</span> <span class="o">=</span> <span class="n">UWB_MAS_LENGTH_US</span> <span class="o">*</span> <span class="n">UWB_MAS_PER_ZONE</span><span class="p">;</span>
	
	<span class="n">uwb_drp_ie_to_bm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mas</span><span class="p">,</span> <span class="n">drp_ie</span><span class="p">);</span>
	<span class="n">bitmap_scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>
	
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cnflt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">cnflt_alien_list</span><span class="p">,</span> <span class="n">rc_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bitmap_equal</span><span class="p">(</span><span class="n">cnflt</span><span class="o">-&gt;</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Existing alien BP reservation conflicting</span>
<span class="cm">			 * bitmap, just reset the timer */</span>
			<span class="n">uwb_cnflt_alien_stroke_timer</span><span class="p">(</span><span class="n">cnflt</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* New alien BP reservation conflicting bitmap */</span>

	<span class="cm">/* alloc and initialize new uwb_cnflt_alien */</span>
	<span class="n">cnflt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_cnflt_alien</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnflt</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to alloc uwb_cnflt_alien struct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cnflt</span><span class="o">-&gt;</span><span class="n">rc_node</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cnflt</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">cnflt</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">uwb_cnflt_timer</span><span class="p">;</span>
	<span class="n">cnflt</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span>     <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cnflt</span><span class="p">;</span>

	<span class="n">cnflt</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cnflt</span><span class="o">-&gt;</span><span class="n">cnflt_update_work</span><span class="p">,</span> <span class="n">uwb_cnflt_update_work</span><span class="p">);</span>
	
	<span class="n">bitmap_copy</span><span class="p">(</span><span class="n">cnflt</span><span class="o">-&gt;</span><span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cnflt</span><span class="o">-&gt;</span><span class="n">rc_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">cnflt_alien_list</span><span class="p">);</span>

	<span class="cm">/* update rc global conflicting alien bitmap */</span>
	<span class="n">bitmap_or</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">cnflt_alien_bitmap</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">cnflt_alien_bitmap</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">mas</span><span class="p">.</span><span class="n">bm</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>

	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rsv_workq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rsv_alien_bp_work</span><span class="p">,</span> <span class="n">usecs_to_jiffies</span><span class="p">(</span><span class="n">delay_us</span><span class="p">));</span>
	
	<span class="cm">/* start the timer */</span>
	<span class="n">uwb_cnflt_alien_stroke_timer</span><span class="p">(</span><span class="n">cnflt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uwb_drp_process_not_involved</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">uwb_rc_evt_drp</span> <span class="o">*</span><span class="n">drp_evt</span><span class="p">,</span> 
					 <span class="k">struct</span> <span class="n">uwb_ie_drp</span> <span class="o">*</span><span class="n">drp_ie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="n">mas</span><span class="p">;</span>
	
	<span class="n">uwb_drp_ie_to_bm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mas</span><span class="p">,</span> <span class="n">drp_ie</span><span class="p">);</span>
	<span class="n">uwb_drp_handle_all_conflict_rsv</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">drp_evt</span><span class="p">,</span> <span class="n">drp_ie</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mas</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uwb_drp_process_involved</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_dev</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">uwb_rc_evt_drp</span> <span class="o">*</span><span class="n">drp_evt</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">uwb_ie_drp</span> <span class="o">*</span><span class="n">drp_ie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">;</span>

	<span class="n">rsv</span> <span class="o">=</span> <span class="n">uwb_rsv_find</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">drp_ie</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsv</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * No reservation? It&#39;s either for a recently</span>
<span class="cm">		 * terminated reservation; or the DRP IE couldn&#39;t be</span>
<span class="cm">		 * processed (e.g., an invalid IE or out of memory).</span>
<span class="cm">		 */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * Do nothing with DRP IEs for reservations that have been</span>
<span class="cm">	 * terminated.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">UWB_RSV_STATE_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="n">rsv</span><span class="p">,</span> <span class="n">UWB_RSV_STATE_NONE</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
			
	<span class="k">if</span> <span class="p">(</span><span class="n">uwb_ie_drp_owner</span><span class="p">(</span><span class="n">drp_ie</span><span class="p">))</span>
		<span class="n">uwb_drp_process_target</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">rsv</span><span class="p">,</span> <span class="n">drp_ie</span><span class="p">,</span> <span class="n">drp_evt</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">uwb_drp_process_owner</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">rsv</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">drp_ie</span><span class="p">,</span> <span class="n">drp_evt</span><span class="p">);</span>
	
<span class="p">}</span>


<span class="k">static</span> <span class="n">bool</span> <span class="nf">uwb_drp_involves_us</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_ie_drp</span> <span class="o">*</span><span class="n">drp_ie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">uwb_dev_addr_cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwb_dev</span><span class="p">.</span><span class="n">dev_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drp_ie</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process a received DRP IE.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uwb_drp_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_rc_evt_drp</span> <span class="o">*</span><span class="n">drp_evt</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">uwb_dev</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_ie_drp</span> <span class="o">*</span><span class="n">drp_ie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uwb_ie_drp_type</span><span class="p">(</span><span class="n">drp_ie</span><span class="p">)</span> <span class="o">==</span> <span class="n">UWB_DRP_TYPE_ALIEN_BP</span><span class="p">)</span>
		<span class="n">uwb_drp_handle_alien_drp</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">drp_ie</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">uwb_drp_involves_us</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">drp_ie</span><span class="p">))</span>
		<span class="n">uwb_drp_process_involved</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">drp_evt</span><span class="p">,</span> <span class="n">drp_ie</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">uwb_drp_process_not_involved</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">drp_evt</span><span class="p">,</span> <span class="n">drp_ie</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process a received DRP Availability IE</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uwb_drp_availability_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_dev</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">uwb_ie_drp_avail</span> <span class="o">*</span><span class="n">drp_availability_ie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bitmap_copy</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">last_availability_bm</span><span class="p">,</span>
		    <span class="n">drp_availability_ie</span><span class="o">-&gt;</span><span class="n">bmp</span><span class="p">,</span> <span class="n">UWB_NUM_MAS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process all the DRP IEs (both DRP IEs and the DRP Availability IE)</span>
<span class="cm"> * from a device.</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">void</span> <span class="nf">uwb_drp_process_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_rc_evt_drp</span> <span class="o">*</span><span class="n">drp_evt</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="n">ielen</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_dev</span> <span class="o">*</span><span class="n">src_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwb_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_ie_hdr</span> <span class="o">*</span><span class="n">ie_hdr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">drp_evt</span><span class="o">-&gt;</span><span class="n">ie_data</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">ie_hdr</span> <span class="o">=</span> <span class="n">uwb_ie_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ielen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ie_hdr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ie_hdr</span><span class="o">-&gt;</span><span class="n">element_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">UWB_IE_DRP_AVAILABILITY</span>:
			<span class="n">uwb_drp_availability_process</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">src_dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uwb_ie_drp_avail</span> <span class="o">*</span><span class="p">)</span><span class="n">ie_hdr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UWB_IE_DRP</span>:
			<span class="n">uwb_drp_process</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">drp_evt</span><span class="p">,</span> <span class="n">src_dev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uwb_ie_drp</span> <span class="o">*</span><span class="p">)</span><span class="n">ie_hdr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unexpected IE in DRP notification</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ielen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d octets remaining in DRP notification</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ielen</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * uwbd_evt_handle_rc_drp - handle a DRP_IE event</span>
<span class="cm"> * @evt: the DRP_IE event from the radio controller</span>
<span class="cm"> *</span>
<span class="cm"> * This processes DRP notifications from the radio controller, either</span>
<span class="cm"> * initiating a new reservation or transitioning an existing</span>
<span class="cm"> * reservation into a different state.</span>
<span class="cm"> *</span>
<span class="cm"> * DRP notifications can occur for three different reasons:</span>
<span class="cm"> *</span>
<span class="cm"> * - UWB_DRP_NOTIF_DRP_IE_RECVD: one or more DRP IEs with the RC as</span>
<span class="cm"> *   the target or source have been received.</span>
<span class="cm"> *</span>
<span class="cm"> *   These DRP IEs could be new or for an existing reservation.</span>
<span class="cm"> *</span>
<span class="cm"> *   If the DRP IE for an existing reservation ceases to be to</span>
<span class="cm"> *   received for at least mMaxLostBeacons, the reservation should be</span>
<span class="cm"> *   considered to be terminated.  Note that the TERMINATE reason (see</span>
<span class="cm"> *   below) may not always be signalled (e.g., the remote device has</span>
<span class="cm"> *   two or more reservations established with the RC).</span>
<span class="cm"> *</span>
<span class="cm"> * - UWB_DRP_NOTIF_CONFLICT: DRP IEs from any device in the beacon</span>
<span class="cm"> *   group conflict with the RC&#39;s reservations.</span>
<span class="cm"> *</span>
<span class="cm"> * - UWB_DRP_NOTIF_TERMINATE: DRP IEs are no longer being received</span>
<span class="cm"> *   from a device (i.e., it&#39;s terminated all reservations).</span>
<span class="cm"> *</span>
<span class="cm"> * Only the software state of the reservations is changed; the setting</span>
<span class="cm"> * of the radio controller&#39;s DRP IEs is done after all the events in</span>
<span class="cm"> * an event buffer are processed.  This saves waiting multiple times</span>
<span class="cm"> * for the SET_DRP_IE command to complete.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">uwbd_evt_handle_rc_drp</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwb_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_rc_evt_drp</span> <span class="o">*</span><span class="n">drp_evt</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ielength</span><span class="p">,</span> <span class="n">bytes_left</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_dev_addr</span> <span class="n">src_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_dev</span> <span class="o">*</span><span class="n">src_dev</span><span class="p">;</span>

	<span class="cm">/* Is there enough data to decode the event (and any IEs in</span>
<span class="cm">	   its payload)? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">notif</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">drp_evt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DRP event: Not enough data to decode event &quot;</span>
			<span class="s">&quot;[%zu bytes left, %zu needed]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">evt</span><span class="o">-&gt;</span><span class="n">notif</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">drp_evt</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bytes_left</span> <span class="o">=</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">notif</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">drp_evt</span><span class="p">);</span>
	<span class="n">drp_evt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">notif</span><span class="p">.</span><span class="n">rceb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_rc_evt_drp</span><span class="p">,</span> <span class="n">rceb</span><span class="p">);</span>
	<span class="n">ielength</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">drp_evt</span><span class="o">-&gt;</span><span class="n">ie_length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bytes_left</span> <span class="o">!=</span> <span class="n">ielength</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DRP event: Not enough data in payload [%zu&quot;</span>
			<span class="s">&quot;bytes left, %zu declared in the event]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bytes_left</span><span class="p">,</span> <span class="n">ielength</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">src_addr</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drp_evt</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">src_addr</span><span class="p">));</span>
	<span class="n">src_dev</span> <span class="o">=</span> <span class="n">uwb_dev_get_by_devaddr</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * A DRP notification from an unrecognized device.</span>
<span class="cm">		 *</span>
<span class="cm">		 * This is probably from a WUSB device that doesn&#39;t</span>
<span class="cm">		 * have an EUI-48 and therefore doesn&#39;t show up in the</span>
<span class="cm">		 * UWB device database.  It&#39;s safe to simply ignore</span>
<span class="cm">		 * these.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rsvs_mutex</span><span class="p">);</span>

	<span class="cm">/* We do not distinguish from the reason */</span>
	<span class="n">uwb_drp_process_all</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">drp_evt</span><span class="p">,</span> <span class="n">ielength</span><span class="p">,</span> <span class="n">src_dev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rsvs_mutex</span><span class="p">);</span>

	<span class="n">uwb_dev_put</span><span class="p">(</span><span class="n">src_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
