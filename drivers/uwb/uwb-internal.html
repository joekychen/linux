<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › uwb › uwb-internal.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>uwb-internal.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Ultra Wide Band</span>
<span class="cm"> * UWB internal API</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2006 Intel Corporation</span>
<span class="cm"> * Inaky Perez-Gonzalez &lt;inaky.perez-gonzalez@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version</span>
<span class="cm"> * 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * This contains most of the internal API for UWB. This is stuff used</span>
<span class="cm"> * across the stack that of course, is of no interest to the rest.</span>
<span class="cm"> *</span>
<span class="cm"> * Some parts might end up going public (like uwb_rc_*())...</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __UWB_INTERNAL_H__</span>
<span class="cp">#define __UWB_INTERNAL_H__</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/uwb.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="k">struct</span> <span class="n">uwb_beca_e</span><span class="p">;</span>

<span class="cm">/* General device API */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">uwb_dev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_dev</span> <span class="o">*</span><span class="n">uwb_dev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">__uwb_dev_offair</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_dev</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">uwb_dev_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_dev</span> <span class="o">*</span><span class="n">uwb_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent_dev</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">parent_rc</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">uwb_dev_rm</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_dev</span> <span class="o">*</span><span class="n">uwb_dev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">uwbd_dev_onair</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_beca_e</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">uwbd_dev_offair</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_beca_e</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_dev</span> <span class="o">*</span><span class="n">uwb_dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">uwb_notifs</span> <span class="n">event</span><span class="p">);</span>

<span class="cm">/* General UWB Radio Controller Internal API */</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">__uwb_rc_try_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="nf">__uwb_rc_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uwb_dev_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwb_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__uwb_rc_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uwb_dev_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">uwb_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">uwb_rc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">uwb_rc_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">bpst_offset</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">uwb_rc_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="n">channel</span><span class="p">,</span> <span class="k">enum</span> <span class="n">uwb_scan_type</span> <span class="n">type</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="n">bpst_offset</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">uwb_rc_send_all_drp_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">uwb_rc_ie_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">uwb_rc_ie_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_rc_ie_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">uwb_ie_dump_hex</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">uwb_ie_hdr</span> <span class="o">*</span><span class="n">ies</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
		    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">uwb_rc_set_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_rc_cmd_set_ie</span> <span class="o">*</span><span class="p">);</span>


<span class="k">extern</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uwb_rc_strerror</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">code</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Time to wait for a response to an RC command.</span>
<span class="cm"> *</span>
<span class="cm"> * Some commands can take a long time to response. e.g., START_BEACON</span>
<span class="cm"> * may scan for several superframes before joining an existing beacon</span>
<span class="cm"> * group and this can take around 600 ms.</span>
<span class="cm"> */</span>
<span class="cp">#define UWB_RC_CMD_TIMEOUT_MS 1000 </span><span class="cm">/* ms */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Notification/Event Handlers</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">uwb_rc_neh</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">uwb_rc_cmd_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd_name</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">uwb_rccb</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">cmd_size</span><span class="p">,</span>
			    <span class="n">u8</span> <span class="n">expected_type</span><span class="p">,</span> <span class="n">u16</span> <span class="n">expected_event</span><span class="p">,</span>
			    <span class="n">uwb_rc_cmd_cb_f</span> <span class="n">cb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>


<span class="kt">void</span> <span class="n">uwb_rc_neh_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_rc_neh_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">uwb_rc_neh</span> <span class="o">*</span><span class="n">uwb_rc_neh_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_rccb</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">expected_type</span><span class="p">,</span> <span class="n">u16</span> <span class="n">expected_event</span><span class="p">,</span>
				  <span class="n">uwb_rc_cmd_cb_f</span> <span class="n">cb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_rc_neh_rm</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_rc_neh</span> <span class="o">*</span><span class="n">neh</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_rc_neh_arm</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_rc_neh</span> <span class="o">*</span><span class="n">neh</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_rc_neh_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc_neh</span> <span class="o">*</span><span class="n">neh</span><span class="p">);</span>

<span class="cm">/* Event size tables */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">uwb_est_create</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">uwb_est_destroy</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * UWB conflicting alien reservations</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">uwb_cnflt_alien</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">rc_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="n">mas</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">cnflt_update_work</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">uwb_uwb_rsv_alloc_result</span> <span class="p">{</span>
	<span class="n">UWB_RSV_ALLOC_FOUND</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">UWB_RSV_ALLOC_NOT_FOUND</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">uwb_rsv_mas_status</span> <span class="p">{</span>
	<span class="n">UWB_RSV_MAS_NOT_AVAIL</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">UWB_RSV_MAS_SAFE</span><span class="p">,</span>
	<span class="n">UWB_RSV_MAS_UNSAFE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">uwb_rsv_col_set_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">start_col</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">interval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">safe_mas_per_col</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">unsafe_mas_per_col</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">uwb_rsv_col_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">max_avail_safe</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">max_avail_unsafe</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">highest_mas</span><span class="p">[</span><span class="n">UWB_MAS_PER_ZONE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">uwb_rsv_col_set_info</span> <span class="n">csi</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">uwb_rsv_row_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">avail</span><span class="p">[</span><span class="n">UWB_MAS_PER_ZONE</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">free_rows</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">used_rows</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * UWB find allocation</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">uwb_rsv_alloc_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bm</span><span class="p">[</span><span class="n">UWB_MAS_PER_ZONE</span> <span class="o">*</span> <span class="n">UWB_NUM_ZONES</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">uwb_rsv_col_info</span> <span class="n">ci</span><span class="p">[</span><span class="n">UWB_NUM_ZONES</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">uwb_rsv_row_info</span> <span class="n">ri</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="o">*</span><span class="n">not_available</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min_mas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_mas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_interval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total_allocated_mases</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">safe_allocated_mases</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unsafe_allocated_mases</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">interval</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">uwb_rsv_find_best_allocation</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="o">*</span><span class="n">available</span><span class="p">,</span> 
				 <span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="o">*</span><span class="n">result</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_rsv_handle_drp_avail_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> * UWB Events &amp; management daemon</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * enum uwb_event_type - types of UWB management daemon events</span>
<span class="cm"> *</span>
<span class="cm"> * The UWB management daemon (uwbd) can receive two types of events:</span>
<span class="cm"> *   UWB_EVT_TYPE_NOTIF - notification from the radio controller.</span>
<span class="cm"> *   UWB_EVT_TYPE_MSG   - a simple message.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">uwb_event_type</span> <span class="p">{</span>
	<span class="n">UWB_EVT_TYPE_NOTIF</span><span class="p">,</span>
	<span class="n">UWB_EVT_TYPE_MSG</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct uwb_event_notif - an event for a radio controller notification</span>
<span class="cm"> * @size: Size of the buffer (ie: Guaranteed to contain at least</span>
<span class="cm"> *        a full &#39;struct uwb_rceb&#39;)</span>
<span class="cm"> * @rceb: Pointer to a kmalloced() event payload</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">uwb_event_notif</span> <span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_rceb</span> <span class="o">*</span><span class="n">rceb</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * enum uwb_event_message - an event for a message for asynchronous processing</span>
<span class="cm"> *</span>
<span class="cm"> * UWB_EVT_MSG_RESET - reset the radio controller and all PAL hardware.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">uwb_event_message</span> <span class="p">{</span>
	<span class="n">UWB_EVT_MSG_RESET</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * UWB Event</span>
<span class="cm"> * @rc:         Radio controller that emitted the event (referenced)</span>
<span class="cm"> * @ts_jiffies: Timestamp, when was it received</span>
<span class="cm"> * @type:       This event&#39;s type.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">uwb_event</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ts_jiffies</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">uwb_event_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">uwb_event_notif</span> <span class="n">notif</span><span class="p">;</span>
		<span class="k">enum</span> <span class="n">uwb_event_message</span> <span class="n">message</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">uwbd_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">uwbd_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="n">uwb_event_alloc</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_mask</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">uwbd_event_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwbd_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>

<span class="cm">/* UWB event handlers */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">uwbd_evt_handle_rc_ie_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">uwbd_evt_handle_rc_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">uwbd_evt_handle_rc_beacon_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">uwbd_evt_handle_rc_bpoie_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">uwbd_evt_handle_rc_bp_slot_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">uwbd_evt_handle_rc_drp</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">uwbd_evt_handle_rc_drp_avail</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">uwbd_msg_handle_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * Address management</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">uwb_rc_dev_addr_assign</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">uwbd_evt_handle_rc_dev_addr_conflict</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * UWB Beacon Cache</span>
<span class="cm"> *</span>
<span class="cm"> * Each beacon we received is kept in a cache--when we receive that</span>
<span class="cm"> * beacon consistently, that means there is a new device that we have</span>
<span class="cm"> * to add to the system.</span>
<span class="cm"> */</span>

<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">beacon_timeout_ms</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Beacon cache entry</span>
<span class="cm"> *</span>
<span class="cm"> * @jiffies_refresh: last time a beacon was  received that refreshed</span>
<span class="cm"> *                   this cache entry.</span>
<span class="cm"> * @uwb_dev: device connected to this beacon. This pointer is not</span>
<span class="cm"> *           safe, you need to get it with uwb_dev_try_get()</span>
<span class="cm"> *</span>
<span class="cm"> * @hits: how many time we have seen this beacon since last time we</span>
<span class="cm"> *        cleared it</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">uwb_beca_e</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kref</span> <span class="n">refcnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_mac_addr</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_dev_addr</span> <span class="n">dev_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ts_jiffies</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_dev</span> <span class="o">*</span><span class="n">uwb_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uwb_rc_evt_beacon</span> <span class="o">*</span><span class="n">be</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stats</span> <span class="n">lqe_stats</span><span class="p">,</span> <span class="n">rssi_stats</span><span class="p">;</span>	<span class="cm">/* radio statistics */</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">uwb_beacon_frame</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">ssize_t</span> <span class="n">uwb_bce_print_IEs</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_dev</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_beca_e</span> <span class="o">*</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">uwb_bce_kfree</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">_bce</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">uwb_bce_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_beca_e</span> <span class="o">*</span><span class="n">bce</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bce</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">uwb_bce_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_beca_e</span> <span class="o">*</span><span class="n">bce</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bce</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="n">uwb_bce_kfree</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">uwb_beca_purge</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">uwb_beca_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">uwb_dev</span> <span class="o">*</span><span class="n">uwb_dev_get_by_devaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">uwb_dev_addr</span> <span class="o">*</span><span class="n">devaddr</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">uwb_dev</span> <span class="o">*</span><span class="n">uwb_dev_get_by_macaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">uwb_mac_addr</span> <span class="o">*</span><span class="n">macaddr</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">uwb_radio_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_radio_reset_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_radio_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">uwb_radio_force_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">);</span>

<span class="cm">/* -- UWB Sysfs representation */</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">class</span> <span class="n">uwb_rc_class</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_mac_address</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_beacon</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_scan</span><span class="p">;</span>

<span class="cm">/* -- DRP Bandwidth allocator: bandwidth allocations, reservations, DRP */</span>
<span class="kt">void</span> <span class="n">uwb_rsv_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">uwb_rsv_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_rsv_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_rsv_remove_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_rsv_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_rsv_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">);</span>
<span class="n">bool</span> <span class="n">uwb_rsv_has_two_drp_ies</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_rsv_dump</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">text</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">uwb_rsv_try_move</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="o">*</span><span class="n">available</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_rsv_backoff_win_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_rsv_backoff_win_increment</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">uwb_rsv_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">uwb_rsv_companion_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">uwb_rsv_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">uwb_rsv_state</span> <span class="n">new_state</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_rsv_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">uwb_rsv_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_dev</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">uwb_ie_drp</span> <span class="o">*</span><span class="n">drp_ie</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_rsv_sched_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_rsv_queue_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">uwb_drp_ie_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rsv</span> <span class="o">*</span><span class="n">rsv</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_drp_ie_to_bm</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="o">*</span><span class="n">bm</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">uwb_ie_drp</span> <span class="o">*</span><span class="n">drp_ie</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">uwb_drp_avail_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_drp_available</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="o">*</span><span class="n">avail</span><span class="p">);</span>
<span class="kt">int</span>  <span class="n">uwb_drp_avail_reserve_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="o">*</span><span class="n">mas</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_drp_avail_reserve</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="o">*</span><span class="n">mas</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_drp_avail_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="o">*</span><span class="n">mas</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_drp_avail_ie_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>

<span class="cm">/* -- PAL support */</span>
<span class="kt">void</span> <span class="n">uwb_rc_pal_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>

<span class="cm">/* -- Misc */</span>

<span class="k">extern</span> <span class="kt">ssize_t</span> <span class="n">uwb_mac_frame_hdr_print</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">uwb_mac_frame_hdr</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/* -- Debug interface */</span>
<span class="kt">void</span> <span class="n">uwb_dbg_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_dbg_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_dbg_add_rc</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">uwb_dbg_del_rc</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_rc</span> <span class="o">*</span><span class="n">rc</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">uwb_dbg_create_pal_dir</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_pal</span> <span class="o">*</span><span class="n">pal</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">uwb_dev_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_dev</span> <span class="o">*</span><span class="n">uwb_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">device_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uwb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">uwb_dev_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">uwb_dev</span> <span class="o">*</span><span class="n">uwb_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">device_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uwb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* #ifndef __UWB_INTERNAL_H__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
