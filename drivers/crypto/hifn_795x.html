<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › crypto › hifn_795x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>hifn_795x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * 2007+ Copyright (c) Evgeniy Polyakov &lt;johnpol@2ka.mipt.ru&gt;</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/mod_devicetable.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/crypto.h&gt;</span>
<span class="cp">#include &lt;linux/hw_random.h&gt;</span>
<span class="cp">#include &lt;linux/ktime.h&gt;</span>

<span class="cp">#include &lt;crypto/algapi.h&gt;</span>
<span class="cp">#include &lt;crypto/des.h&gt;</span>

<span class="cp">#include &lt;asm/kmap_types.h&gt;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define HIFN_DEBUG</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef HIFN_DEBUG</span>
<span class="cp">#define dprintk(f, a...) 	printk(f, ##a)</span>
<span class="cp">#else</span>
<span class="cp">#define dprintk(f, a...)	do {} while (0)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">hifn_pll_ref</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;extNNN&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="s">&quot;ext&quot;</span><span class="p">;</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">hifn_pll_ref</span><span class="p">,</span> <span class="n">hifn_pll_ref</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hifn_pll_ref</span><span class="p">),</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">hifn_pll_ref</span><span class="p">,</span>
		 <span class="s">&quot;PLL reference clock (pci[freq] or ext[freq], default ext)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">hifn_dev_number</span><span class="p">;</span>

<span class="cp">#define ACRYPTO_OP_DECRYPT	0</span>
<span class="cp">#define ACRYPTO_OP_ENCRYPT	1</span>
<span class="cp">#define ACRYPTO_OP_HMAC		2</span>
<span class="cp">#define ACRYPTO_OP_RNG		3</span>

<span class="cp">#define ACRYPTO_MODE_ECB		0</span>
<span class="cp">#define ACRYPTO_MODE_CBC		1</span>
<span class="cp">#define ACRYPTO_MODE_CFB		2</span>
<span class="cp">#define ACRYPTO_MODE_OFB		3</span>

<span class="cp">#define ACRYPTO_TYPE_AES_128	0</span>
<span class="cp">#define ACRYPTO_TYPE_AES_192	1</span>
<span class="cp">#define ACRYPTO_TYPE_AES_256	2</span>
<span class="cp">#define ACRYPTO_TYPE_3DES	3</span>
<span class="cp">#define ACRYPTO_TYPE_DES	4</span>

<span class="cp">#define PCI_VENDOR_ID_HIFN		0x13A3</span>
<span class="cp">#define PCI_DEVICE_ID_HIFN_7955		0x0020</span>
<span class="cp">#define	PCI_DEVICE_ID_HIFN_7956		0x001d</span>

<span class="cm">/* I/O region sizes */</span>

<span class="cp">#define HIFN_BAR0_SIZE			0x1000</span>
<span class="cp">#define HIFN_BAR1_SIZE			0x2000</span>
<span class="cp">#define HIFN_BAR2_SIZE			0x8000</span>

<span class="cm">/* DMA registres */</span>

<span class="cp">#define HIFN_DMA_CRA 			0x0C	</span><span class="cm">/* DMA Command Ring Address */</span><span class="cp"></span>
<span class="cp">#define HIFN_DMA_SDRA 			0x1C	</span><span class="cm">/* DMA Source Data Ring Address */</span><span class="cp"></span>
<span class="cp">#define HIFN_DMA_RRA			0x2C	</span><span class="cm">/* DMA Result Ring Address */</span><span class="cp"></span>
<span class="cp">#define HIFN_DMA_DDRA			0x3C	</span><span class="cm">/* DMA Destination Data Ring Address */</span><span class="cp"></span>
<span class="cp">#define HIFN_DMA_STCTL			0x40	</span><span class="cm">/* DMA Status and Control */</span><span class="cp"></span>
<span class="cp">#define HIFN_DMA_INTREN 		0x44	</span><span class="cm">/* DMA Interrupt Enable */</span><span class="cp"></span>
<span class="cp">#define HIFN_DMA_CFG1			0x48	</span><span class="cm">/* DMA Configuration #1 */</span><span class="cp"></span>
<span class="cp">#define HIFN_DMA_CFG2			0x6C	</span><span class="cm">/* DMA Configuration #2 */</span><span class="cp"></span>
<span class="cp">#define HIFN_CHIP_ID			0x98	</span><span class="cm">/* Chip ID */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Processing Unit Registers (offset from BASEREG0)</span>
<span class="cm"> */</span>
<span class="cp">#define	HIFN_0_PUDATA		0x00	</span><span class="cm">/* Processing Unit Data */</span><span class="cp"></span>
<span class="cp">#define	HIFN_0_PUCTRL		0x04	</span><span class="cm">/* Processing Unit Control */</span><span class="cp"></span>
<span class="cp">#define	HIFN_0_PUISR		0x08	</span><span class="cm">/* Processing Unit Interrupt Status */</span><span class="cp"></span>
<span class="cp">#define	HIFN_0_PUCNFG		0x0c	</span><span class="cm">/* Processing Unit Configuration */</span><span class="cp"></span>
<span class="cp">#define	HIFN_0_PUIER		0x10	</span><span class="cm">/* Processing Unit Interrupt Enable */</span><span class="cp"></span>
<span class="cp">#define	HIFN_0_PUSTAT		0x14	</span><span class="cm">/* Processing Unit Status/Chip ID */</span><span class="cp"></span>
<span class="cp">#define	HIFN_0_FIFOSTAT		0x18	</span><span class="cm">/* FIFO Status */</span><span class="cp"></span>
<span class="cp">#define	HIFN_0_FIFOCNFG		0x1c	</span><span class="cm">/* FIFO Configuration */</span><span class="cp"></span>
<span class="cp">#define	HIFN_0_SPACESIZE	0x20	</span><span class="cm">/* Register space size */</span><span class="cp"></span>

<span class="cm">/* Processing Unit Control Register (HIFN_0_PUCTRL) */</span>
<span class="cp">#define	HIFN_PUCTRL_CLRSRCFIFO	0x0010	</span><span class="cm">/* clear source fifo */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCTRL_STOP	0x0008	</span><span class="cm">/* stop pu */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCTRL_LOCKRAM	0x0004	</span><span class="cm">/* lock ram */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCTRL_DMAENA	0x0002	</span><span class="cm">/* enable dma */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCTRL_RESET	0x0001	</span><span class="cm">/* Reset processing unit */</span><span class="cp"></span>

<span class="cm">/* Processing Unit Interrupt Status Register (HIFN_0_PUISR) */</span>
<span class="cp">#define	HIFN_PUISR_CMDINVAL	0x8000	</span><span class="cm">/* Invalid command interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUISR_DATAERR	0x4000	</span><span class="cm">/* Data error interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUISR_SRCFIFO	0x2000	</span><span class="cm">/* Source FIFO ready interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUISR_DSTFIFO	0x1000	</span><span class="cm">/* Destination FIFO ready interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUISR_DSTOVER	0x0200	</span><span class="cm">/* Destination overrun interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUISR_SRCCMD	0x0080	</span><span class="cm">/* Source command interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUISR_SRCCTX	0x0040	</span><span class="cm">/* Source context interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUISR_SRCDATA	0x0020	</span><span class="cm">/* Source data interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUISR_DSTDATA	0x0010	</span><span class="cm">/* Destination data interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUISR_DSTRESULT	0x0004	</span><span class="cm">/* Destination result interrupt */</span><span class="cp"></span>

<span class="cm">/* Processing Unit Configuration Register (HIFN_0_PUCNFG) */</span>
<span class="cp">#define	HIFN_PUCNFG_DRAMMASK	0xe000	</span><span class="cm">/* DRAM size mask */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_DSZ_256K	0x0000	</span><span class="cm">/* 256k dram */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_DSZ_512K	0x2000	</span><span class="cm">/* 512k dram */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_DSZ_1M	0x4000	</span><span class="cm">/* 1m dram */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_DSZ_2M	0x6000	</span><span class="cm">/* 2m dram */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_DSZ_4M	0x8000	</span><span class="cm">/* 4m dram */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_DSZ_8M	0xa000	</span><span class="cm">/* 8m dram */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUNCFG_DSZ_16M	0xc000	</span><span class="cm">/* 16m dram */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_DSZ_32M	0xe000	</span><span class="cm">/* 32m dram */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_DRAMREFRESH	0x1800	</span><span class="cm">/* DRAM refresh rate mask */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_DRFR_512	0x0000	</span><span class="cm">/* 512 divisor of ECLK */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_DRFR_256	0x0800	</span><span class="cm">/* 256 divisor of ECLK */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_DRFR_128	0x1000	</span><span class="cm">/* 128 divisor of ECLK */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_TCALLPHASES	0x0200	</span><span class="cm">/* your guess is as good as mine... */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_TCDRVTOTEM	0x0100	</span><span class="cm">/* your guess is as good as mine... */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_BIGENDIAN	0x0080	</span><span class="cm">/* DMA big endian mode */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_BUS32	0x0040	</span><span class="cm">/* Bus width 32bits */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_BUS16	0x0000	</span><span class="cm">/* Bus width 16 bits */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_CHIPID	0x0020	</span><span class="cm">/* Allow chipid from PUSTAT */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_DRAM	0x0010	</span><span class="cm">/* Context RAM is DRAM */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_SRAM	0x0000	</span><span class="cm">/* Context RAM is SRAM */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_COMPSING	0x0004	</span><span class="cm">/* Enable single compression context */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUCNFG_ENCCNFG	0x0002	</span><span class="cm">/* Encryption configuration */</span><span class="cp"></span>

<span class="cm">/* Processing Unit Interrupt Enable Register (HIFN_0_PUIER) */</span>
<span class="cp">#define	HIFN_PUIER_CMDINVAL	0x8000	</span><span class="cm">/* Invalid command interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUIER_DATAERR	0x4000	</span><span class="cm">/* Data error interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUIER_SRCFIFO	0x2000	</span><span class="cm">/* Source FIFO ready interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUIER_DSTFIFO	0x1000	</span><span class="cm">/* Destination FIFO ready interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUIER_DSTOVER	0x0200	</span><span class="cm">/* Destination overrun interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUIER_SRCCMD	0x0080	</span><span class="cm">/* Source command interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUIER_SRCCTX	0x0040	</span><span class="cm">/* Source context interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUIER_SRCDATA	0x0020	</span><span class="cm">/* Source data interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUIER_DSTDATA	0x0010	</span><span class="cm">/* Destination data interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUIER_DSTRESULT	0x0004	</span><span class="cm">/* Destination result interrupt */</span><span class="cp"></span>

<span class="cm">/* Processing Unit Status Register/Chip ID (HIFN_0_PUSTAT) */</span>
<span class="cp">#define	HIFN_PUSTAT_CMDINVAL	0x8000	</span><span class="cm">/* Invalid command interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUSTAT_DATAERR	0x4000	</span><span class="cm">/* Data error interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUSTAT_SRCFIFO	0x2000	</span><span class="cm">/* Source FIFO ready interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUSTAT_DSTFIFO	0x1000	</span><span class="cm">/* Destination FIFO ready interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUSTAT_DSTOVER	0x0200	</span><span class="cm">/* Destination overrun interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUSTAT_SRCCMD	0x0080	</span><span class="cm">/* Source command interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUSTAT_SRCCTX	0x0040	</span><span class="cm">/* Source context interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUSTAT_SRCDATA	0x0020	</span><span class="cm">/* Source data interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUSTAT_DSTDATA	0x0010	</span><span class="cm">/* Destination data interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUSTAT_DSTRESULT	0x0004	</span><span class="cm">/* Destination result interrupt */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUSTAT_CHIPREV	0x00ff	</span><span class="cm">/* Chip revision mask */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUSTAT_CHIPENA	0xff00	</span><span class="cm">/* Chip enabled mask */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUSTAT_ENA_2	0x1100	</span><span class="cm">/* Level 2 enabled */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUSTAT_ENA_1	0x1000	</span><span class="cm">/* Level 1 enabled */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUSTAT_ENA_0	0x3000	</span><span class="cm">/* Level 0 enabled */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUSTAT_REV_2	0x0020	</span><span class="cm">/* 7751 PT6/2 */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUSTAT_REV_3	0x0030	</span><span class="cm">/* 7751 PT6/3 */</span><span class="cp"></span>

<span class="cm">/* FIFO Status Register (HIFN_0_FIFOSTAT) */</span>
<span class="cp">#define	HIFN_FIFOSTAT_SRC	0x7f00	</span><span class="cm">/* Source FIFO available */</span><span class="cp"></span>
<span class="cp">#define	HIFN_FIFOSTAT_DST	0x007f	</span><span class="cm">/* Destination FIFO available */</span><span class="cp"></span>

<span class="cm">/* FIFO Configuration Register (HIFN_0_FIFOCNFG) */</span>
<span class="cp">#define	HIFN_FIFOCNFG_THRESHOLD	0x0400	</span><span class="cm">/* must be written as 1 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * DMA Interface Registers (offset from BASEREG1)</span>
<span class="cm"> */</span>
<span class="cp">#define	HIFN_1_DMA_CRAR		0x0c	</span><span class="cm">/* DMA Command Ring Address */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_DMA_SRAR		0x1c	</span><span class="cm">/* DMA Source Ring Address */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_DMA_RRAR		0x2c	</span><span class="cm">/* DMA Result Ring Address */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_DMA_DRAR		0x3c	</span><span class="cm">/* DMA Destination Ring Address */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_DMA_CSR		0x40	</span><span class="cm">/* DMA Status and Control */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_DMA_IER		0x44	</span><span class="cm">/* DMA Interrupt Enable */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_DMA_CNFG		0x48	</span><span class="cm">/* DMA Configuration */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_PLL		0x4c	</span><span class="cm">/* 795x: PLL config */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_7811_RNGENA	0x60	</span><span class="cm">/* 7811: rng enable */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_7811_RNGCFG	0x64	</span><span class="cm">/* 7811: rng config */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_7811_RNGDAT	0x68	</span><span class="cm">/* 7811: rng data */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_7811_RNGSTS	0x6c	</span><span class="cm">/* 7811: rng status */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_7811_MIPSRST	0x94	</span><span class="cm">/* 7811: MIPS reset */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_REVID		0x98	</span><span class="cm">/* Revision ID */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_UNLOCK_SECRET1	0xf4</span>
<span class="cp">#define	HIFN_1_UNLOCK_SECRET2	0xfc</span>
<span class="cp">#define	HIFN_1_PUB_RESET	0x204	</span><span class="cm">/* Public/RNG Reset */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_PUB_BASE		0x300	</span><span class="cm">/* Public Base Address */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_PUB_OPLEN	0x304	</span><span class="cm">/* Public Operand Length */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_PUB_OP		0x308	</span><span class="cm">/* Public Operand */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_PUB_STATUS	0x30c	</span><span class="cm">/* Public Status */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_PUB_IEN		0x310	</span><span class="cm">/* Public Interrupt enable */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_RNG_CONFIG	0x314	</span><span class="cm">/* RNG config */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_RNG_DATA		0x318	</span><span class="cm">/* RNG data */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_PUB_MEM		0x400	</span><span class="cm">/* start of Public key memory */</span><span class="cp"></span>
<span class="cp">#define	HIFN_1_PUB_MEMEND	0xbff	</span><span class="cm">/* end of Public key memory */</span><span class="cp"></span>

<span class="cm">/* DMA Status and Control Register (HIFN_1_DMA_CSR) */</span>
<span class="cp">#define	HIFN_DMACSR_D_CTRLMASK	0xc0000000	</span><span class="cm">/* Destinition Ring Control */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_D_CTRL_NOP	0x00000000	</span><span class="cm">/* Dest. Control: no-op */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_D_CTRL_DIS	0x40000000	</span><span class="cm">/* Dest. Control: disable */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_D_CTRL_ENA	0x80000000	</span><span class="cm">/* Dest. Control: enable */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_D_ABORT	0x20000000	</span><span class="cm">/* Destinition Ring PCIAbort */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_D_DONE	0x10000000	</span><span class="cm">/* Destinition Ring Done */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_D_LAST	0x08000000	</span><span class="cm">/* Destinition Ring Last */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_D_WAIT	0x04000000	</span><span class="cm">/* Destinition Ring Waiting */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_D_OVER	0x02000000	</span><span class="cm">/* Destinition Ring Overflow */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_R_CTRL	0x00c00000	</span><span class="cm">/* Result Ring Control */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_R_CTRL_NOP	0x00000000	</span><span class="cm">/* Result Control: no-op */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_R_CTRL_DIS	0x00400000	</span><span class="cm">/* Result Control: disable */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_R_CTRL_ENA	0x00800000	</span><span class="cm">/* Result Control: enable */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_R_ABORT	0x00200000	</span><span class="cm">/* Result Ring PCI Abort */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_R_DONE	0x00100000	</span><span class="cm">/* Result Ring Done */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_R_LAST	0x00080000	</span><span class="cm">/* Result Ring Last */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_R_WAIT	0x00040000	</span><span class="cm">/* Result Ring Waiting */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_R_OVER	0x00020000	</span><span class="cm">/* Result Ring Overflow */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_S_CTRL	0x0000c000	</span><span class="cm">/* Source Ring Control */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_S_CTRL_NOP	0x00000000	</span><span class="cm">/* Source Control: no-op */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_S_CTRL_DIS	0x00004000	</span><span class="cm">/* Source Control: disable */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_S_CTRL_ENA	0x00008000	</span><span class="cm">/* Source Control: enable */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_S_ABORT	0x00002000	</span><span class="cm">/* Source Ring PCI Abort */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_S_DONE	0x00001000	</span><span class="cm">/* Source Ring Done */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_S_LAST	0x00000800	</span><span class="cm">/* Source Ring Last */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_S_WAIT	0x00000400	</span><span class="cm">/* Source Ring Waiting */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_ILLW	0x00000200	</span><span class="cm">/* Illegal write (7811 only) */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_ILLR	0x00000100	</span><span class="cm">/* Illegal read (7811 only) */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_C_CTRL	0x000000c0	</span><span class="cm">/* Command Ring Control */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_C_CTRL_NOP	0x00000000	</span><span class="cm">/* Command Control: no-op */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_C_CTRL_DIS	0x00000040	</span><span class="cm">/* Command Control: disable */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_C_CTRL_ENA	0x00000080	</span><span class="cm">/* Command Control: enable */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_C_ABORT	0x00000020	</span><span class="cm">/* Command Ring PCI Abort */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_C_DONE	0x00000010	</span><span class="cm">/* Command Ring Done */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_C_LAST	0x00000008	</span><span class="cm">/* Command Ring Last */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_C_WAIT	0x00000004	</span><span class="cm">/* Command Ring Waiting */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_PUBDONE	0x00000002	</span><span class="cm">/* Public op done (7951 only) */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACSR_ENGINE	0x00000001	</span><span class="cm">/* Command Ring Engine IRQ */</span><span class="cp"></span>

<span class="cm">/* DMA Interrupt Enable Register (HIFN_1_DMA_IER) */</span>
<span class="cp">#define	HIFN_DMAIER_D_ABORT	0x20000000	</span><span class="cm">/* Destination Ring PCIAbort */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_D_DONE	0x10000000	</span><span class="cm">/* Destination Ring Done */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_D_LAST	0x08000000	</span><span class="cm">/* Destination Ring Last */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_D_WAIT	0x04000000	</span><span class="cm">/* Destination Ring Waiting */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_D_OVER	0x02000000	</span><span class="cm">/* Destination Ring Overflow */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_R_ABORT	0x00200000	</span><span class="cm">/* Result Ring PCI Abort */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_R_DONE	0x00100000	</span><span class="cm">/* Result Ring Done */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_R_LAST	0x00080000	</span><span class="cm">/* Result Ring Last */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_R_WAIT	0x00040000	</span><span class="cm">/* Result Ring Waiting */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_R_OVER	0x00020000	</span><span class="cm">/* Result Ring Overflow */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_S_ABORT	0x00002000	</span><span class="cm">/* Source Ring PCI Abort */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_S_DONE	0x00001000	</span><span class="cm">/* Source Ring Done */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_S_LAST	0x00000800	</span><span class="cm">/* Source Ring Last */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_S_WAIT	0x00000400	</span><span class="cm">/* Source Ring Waiting */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_ILLW	0x00000200	</span><span class="cm">/* Illegal write (7811 only) */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_ILLR	0x00000100	</span><span class="cm">/* Illegal read (7811 only) */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_C_ABORT	0x00000020	</span><span class="cm">/* Command Ring PCI Abort */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_C_DONE	0x00000010	</span><span class="cm">/* Command Ring Done */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_C_LAST	0x00000008	</span><span class="cm">/* Command Ring Last */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_C_WAIT	0x00000004	</span><span class="cm">/* Command Ring Waiting */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_PUBDONE	0x00000002	</span><span class="cm">/* public op done (7951 only) */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMAIER_ENGINE	0x00000001	</span><span class="cm">/* Engine IRQ */</span><span class="cp"></span>

<span class="cm">/* DMA Configuration Register (HIFN_1_DMA_CNFG) */</span>
<span class="cp">#define	HIFN_DMACNFG_BIGENDIAN	0x10000000	</span><span class="cm">/* big endian mode */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACNFG_POLLFREQ	0x00ff0000	</span><span class="cm">/* Poll frequency mask */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACNFG_UNLOCK	0x00000800</span>
<span class="cp">#define	HIFN_DMACNFG_POLLINVAL	0x00000700	</span><span class="cm">/* Invalid Poll Scalar */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACNFG_LAST	0x00000010	</span><span class="cm">/* Host control LAST bit */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACNFG_MODE	0x00000004	</span><span class="cm">/* DMA mode */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACNFG_DMARESET	0x00000002	</span><span class="cm">/* DMA Reset # */</span><span class="cp"></span>
<span class="cp">#define	HIFN_DMACNFG_MSTRESET	0x00000001	</span><span class="cm">/* Master Reset # */</span><span class="cp"></span>

<span class="cm">/* PLL configuration register */</span>
<span class="cp">#define HIFN_PLL_REF_CLK_HBI	0x00000000	</span><span class="cm">/* HBI reference clock */</span><span class="cp"></span>
<span class="cp">#define HIFN_PLL_REF_CLK_PLL	0x00000001	</span><span class="cm">/* PLL reference clock */</span><span class="cp"></span>
<span class="cp">#define HIFN_PLL_BP		0x00000002	</span><span class="cm">/* Reference clock bypass */</span><span class="cp"></span>
<span class="cp">#define HIFN_PLL_PK_CLK_HBI	0x00000000	</span><span class="cm">/* PK engine HBI clock */</span><span class="cp"></span>
<span class="cp">#define HIFN_PLL_PK_CLK_PLL	0x00000008	</span><span class="cm">/* PK engine PLL clock */</span><span class="cp"></span>
<span class="cp">#define HIFN_PLL_PE_CLK_HBI	0x00000000	</span><span class="cm">/* PE engine HBI clock */</span><span class="cp"></span>
<span class="cp">#define HIFN_PLL_PE_CLK_PLL	0x00000010	</span><span class="cm">/* PE engine PLL clock */</span><span class="cp"></span>
<span class="cp">#define HIFN_PLL_RESERVED_1	0x00000400	</span><span class="cm">/* Reserved bit, must be 1 */</span><span class="cp"></span>
<span class="cp">#define HIFN_PLL_ND_SHIFT	11		</span><span class="cm">/* Clock multiplier shift */</span><span class="cp"></span>
<span class="cp">#define HIFN_PLL_ND_MULT_2	0x00000000	</span><span class="cm">/* PLL clock multiplier 2 */</span><span class="cp"></span>
<span class="cp">#define HIFN_PLL_ND_MULT_4	0x00000800	</span><span class="cm">/* PLL clock multiplier 4 */</span><span class="cp"></span>
<span class="cp">#define HIFN_PLL_ND_MULT_6	0x00001000	</span><span class="cm">/* PLL clock multiplier 6 */</span><span class="cp"></span>
<span class="cp">#define HIFN_PLL_ND_MULT_8	0x00001800	</span><span class="cm">/* PLL clock multiplier 8 */</span><span class="cp"></span>
<span class="cp">#define HIFN_PLL_ND_MULT_10	0x00002000	</span><span class="cm">/* PLL clock multiplier 10 */</span><span class="cp"></span>
<span class="cp">#define HIFN_PLL_ND_MULT_12	0x00002800	</span><span class="cm">/* PLL clock multiplier 12 */</span><span class="cp"></span>
<span class="cp">#define HIFN_PLL_IS_1_8		0x00000000	</span><span class="cm">/* charge pump (mult. 1-8) */</span><span class="cp"></span>
<span class="cp">#define HIFN_PLL_IS_9_12	0x00010000	</span><span class="cm">/* charge pump (mult. 9-12) */</span><span class="cp"></span>

<span class="cp">#define HIFN_PLL_FCK_MAX	266		</span><span class="cm">/* Maximum PLL frequency */</span><span class="cp"></span>

<span class="cm">/* Public key reset register (HIFN_1_PUB_RESET) */</span>
<span class="cp">#define	HIFN_PUBRST_RESET	0x00000001	</span><span class="cm">/* reset public/rng unit */</span><span class="cp"></span>

<span class="cm">/* Public base address register (HIFN_1_PUB_BASE) */</span>
<span class="cp">#define	HIFN_PUBBASE_ADDR	0x00003fff	</span><span class="cm">/* base address */</span><span class="cp"></span>

<span class="cm">/* Public operand length register (HIFN_1_PUB_OPLEN) */</span>
<span class="cp">#define	HIFN_PUBOPLEN_MOD_M	0x0000007f	</span><span class="cm">/* modulus length mask */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOPLEN_MOD_S	0		</span><span class="cm">/* modulus length shift */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOPLEN_EXP_M	0x0003ff80	</span><span class="cm">/* exponent length mask */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOPLEN_EXP_S	7		</span><span class="cm">/* exponent length shift */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOPLEN_RED_M	0x003c0000	</span><span class="cm">/* reducend length mask */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOPLEN_RED_S	18		</span><span class="cm">/* reducend length shift */</span><span class="cp"></span>

<span class="cm">/* Public operation register (HIFN_1_PUB_OP) */</span>
<span class="cp">#define	HIFN_PUBOP_AOFFSET_M	0x0000007f	</span><span class="cm">/* A offset mask */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOP_AOFFSET_S	0		</span><span class="cm">/* A offset shift */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOP_BOFFSET_M	0x00000f80	</span><span class="cm">/* B offset mask */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOP_BOFFSET_S	7		</span><span class="cm">/* B offset shift */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOP_MOFFSET_M	0x0003f000	</span><span class="cm">/* M offset mask */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOP_MOFFSET_S	12		</span><span class="cm">/* M offset shift */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOP_OP_MASK	0x003c0000	</span><span class="cm">/* Opcode: */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOP_OP_NOP	0x00000000	</span><span class="cm">/*  NOP */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOP_OP_ADD	0x00040000	</span><span class="cm">/*  ADD */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOP_OP_ADDC	0x00080000	</span><span class="cm">/*  ADD w/carry */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOP_OP_SUB	0x000c0000	</span><span class="cm">/*  SUB */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOP_OP_SUBC	0x00100000	</span><span class="cm">/*  SUB w/carry */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOP_OP_MODADD	0x00140000	</span><span class="cm">/*  Modular ADD */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOP_OP_MODSUB	0x00180000	</span><span class="cm">/*  Modular SUB */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOP_OP_INCA	0x001c0000	</span><span class="cm">/*  INC A */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOP_OP_DECA	0x00200000	</span><span class="cm">/*  DEC A */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOP_OP_MULT	0x00240000	</span><span class="cm">/*  MULT */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOP_OP_MODMULT	0x00280000	</span><span class="cm">/*  Modular MULT */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOP_OP_MODRED	0x002c0000	</span><span class="cm">/*  Modular RED */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBOP_OP_MODEXP	0x00300000	</span><span class="cm">/*  Modular EXP */</span><span class="cp"></span>

<span class="cm">/* Public status register (HIFN_1_PUB_STATUS) */</span>
<span class="cp">#define	HIFN_PUBSTS_DONE	0x00000001	</span><span class="cm">/* operation done */</span><span class="cp"></span>
<span class="cp">#define	HIFN_PUBSTS_CARRY	0x00000002	</span><span class="cm">/* carry */</span><span class="cp"></span>

<span class="cm">/* Public interrupt enable register (HIFN_1_PUB_IEN) */</span>
<span class="cp">#define	HIFN_PUBIEN_DONE	0x00000001	</span><span class="cm">/* operation done interrupt */</span><span class="cp"></span>

<span class="cm">/* Random number generator config register (HIFN_1_RNG_CONFIG) */</span>
<span class="cp">#define	HIFN_RNGCFG_ENA		0x00000001	</span><span class="cm">/* enable rng */</span><span class="cp"></span>

<span class="cp">#define HIFN_NAMESIZE			32</span>
<span class="cp">#define HIFN_MAX_RESULT_ORDER		5</span>

<span class="cp">#define	HIFN_D_CMD_RSIZE		24*1</span>
<span class="cp">#define	HIFN_D_SRC_RSIZE		80*1</span>
<span class="cp">#define	HIFN_D_DST_RSIZE		80*1</span>
<span class="cp">#define	HIFN_D_RES_RSIZE		24*1</span>

<span class="cp">#define HIFN_D_DST_DALIGN		4</span>

<span class="cp">#define HIFN_QUEUE_LENGTH		(HIFN_D_CMD_RSIZE - 1)</span>

<span class="cp">#define AES_MIN_KEY_SIZE		16</span>
<span class="cp">#define AES_MAX_KEY_SIZE		32</span>

<span class="cp">#define HIFN_DES_KEY_LENGTH		8</span>
<span class="cp">#define HIFN_3DES_KEY_LENGTH		24</span>
<span class="cp">#define HIFN_MAX_CRYPT_KEY_LENGTH	AES_MAX_KEY_SIZE</span>
<span class="cp">#define HIFN_IV_LENGTH			8</span>
<span class="cp">#define HIFN_AES_IV_LENGTH		16</span>
<span class="cp">#define	HIFN_MAX_IV_LENGTH		HIFN_AES_IV_LENGTH</span>

<span class="cp">#define HIFN_MAC_KEY_LENGTH		64</span>
<span class="cp">#define HIFN_MD5_LENGTH			16</span>
<span class="cp">#define HIFN_SHA1_LENGTH		20</span>
<span class="cp">#define HIFN_MAC_TRUNC_LENGTH		12</span>

<span class="cp">#define	HIFN_MAX_COMMAND		(8 + 8 + 8 + 64 + 260)</span>
<span class="cp">#define	HIFN_MAX_RESULT			(8 + 4 + 4 + 20 + 4)</span>
<span class="cp">#define HIFN_USED_RESULT		12</span>

<span class="k">struct</span> <span class="n">hifn_desc</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">__le32</span>		<span class="n">l</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__le32</span>		<span class="n">p</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hifn_dma</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hifn_desc</span>	<span class="n">cmdr</span><span class="p">[</span><span class="n">HIFN_D_CMD_RSIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">hifn_desc</span>	<span class="n">srcr</span><span class="p">[</span><span class="n">HIFN_D_SRC_RSIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">hifn_desc</span>	<span class="n">dstr</span><span class="p">[</span><span class="n">HIFN_D_DST_RSIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">hifn_desc</span>	<span class="n">resr</span><span class="p">[</span><span class="n">HIFN_D_RES_RSIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">u8</span>			<span class="n">command_bufs</span><span class="p">[</span><span class="n">HIFN_D_CMD_RSIZE</span><span class="p">][</span><span class="n">HIFN_MAX_COMMAND</span><span class="p">];</span>
	<span class="n">u8</span>			<span class="n">result_bufs</span><span class="p">[</span><span class="n">HIFN_D_CMD_RSIZE</span><span class="p">][</span><span class="n">HIFN_MAX_RESULT</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Our current positions for insertion and removal from the descriptor</span>
<span class="cm">	 *  rings.</span>
<span class="cm">	 */</span>
	<span class="k">volatile</span> <span class="kt">int</span>		<span class="n">cmdi</span><span class="p">,</span> <span class="n">srci</span><span class="p">,</span> <span class="n">dsti</span><span class="p">,</span> <span class="n">resi</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">int</span>		<span class="n">cmdu</span><span class="p">,</span> <span class="n">srcu</span><span class="p">,</span> <span class="n">dstu</span><span class="p">,</span> <span class="n">resu</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">cmdk</span><span class="p">,</span> <span class="n">srck</span><span class="p">,</span> <span class="n">dstk</span><span class="p">,</span> <span class="n">resk</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define HIFN_FLAG_CMD_BUSY	(1&lt;&lt;0)</span>
<span class="cp">#define HIFN_FLAG_SRC_BUSY	(1&lt;&lt;1)</span>
<span class="cp">#define HIFN_FLAG_DST_BUSY	(1&lt;&lt;2)</span>
<span class="cp">#define HIFN_FLAG_RES_BUSY	(1&lt;&lt;3)</span>
<span class="cp">#define HIFN_FLAG_OLD_KEY	(1&lt;&lt;4)</span>

<span class="cp">#define HIFN_DEFAULT_ACTIVE_NUM	5</span>

<span class="k">struct</span> <span class="n">hifn_device</span>
<span class="p">{</span>
	<span class="kt">char</span>			<span class="n">name</span><span class="p">[</span><span class="n">HIFN_NAMESIZE</span><span class="p">];</span>

	<span class="kt">int</span>			<span class="n">irq</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pci_dev</span>		<span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">bar</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="kt">void</span>			<span class="o">*</span><span class="n">desc_virt</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">desc_dma</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">dmareg</span><span class="p">;</span>

	<span class="kt">void</span> 			<span class="o">*</span><span class="n">sa</span><span class="p">[</span><span class="n">HIFN_D_RES_RSIZE</span><span class="p">];</span>

	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">active</span><span class="p">,</span> <span class="n">started</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="n">work</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">reset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">success</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">prev_success</span><span class="p">;</span>

	<span class="n">u8</span>			<span class="n">snum</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">tasklet_struct</span>	<span class="n">tasklet</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">crypto_queue</span> 	<span class="n">queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">alg_list</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">pk_clk_freq</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_CRYPTO_DEV_HIFN_795X_RNG</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">rng_wait_time</span><span class="p">;</span>
	<span class="n">ktime_t</span>			<span class="n">rngtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwrng</span>		<span class="n">rng</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cp">#define	HIFN_D_LENGTH			0x0000ffff</span>
<span class="cp">#define	HIFN_D_NOINVALID		0x01000000</span>
<span class="cp">#define	HIFN_D_MASKDONEIRQ		0x02000000</span>
<span class="cp">#define	HIFN_D_DESTOVER			0x04000000</span>
<span class="cp">#define	HIFN_D_OVER			0x08000000</span>
<span class="cp">#define	HIFN_D_LAST			0x20000000</span>
<span class="cp">#define	HIFN_D_JUMP			0x40000000</span>
<span class="cp">#define	HIFN_D_VALID			0x80000000</span>

<span class="k">struct</span> <span class="n">hifn_base_command</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">__le16</span>		<span class="n">masks</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__le16</span>		<span class="n">session_num</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__le16</span>		<span class="n">total_source_count</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__le16</span>		<span class="n">total_dest_count</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define	HIFN_BASE_CMD_COMP		0x0100	</span><span class="cm">/* enable compression engine */</span><span class="cp"></span>
<span class="cp">#define	HIFN_BASE_CMD_PAD		0x0200	</span><span class="cm">/* enable padding engine */</span><span class="cp"></span>
<span class="cp">#define	HIFN_BASE_CMD_MAC		0x0400	</span><span class="cm">/* enable MAC engine */</span><span class="cp"></span>
<span class="cp">#define	HIFN_BASE_CMD_CRYPT		0x0800	</span><span class="cm">/* enable crypt engine */</span><span class="cp"></span>
<span class="cp">#define	HIFN_BASE_CMD_DECODE		0x2000</span>
<span class="cp">#define	HIFN_BASE_CMD_SRCLEN_M		0xc000</span>
<span class="cp">#define	HIFN_BASE_CMD_SRCLEN_S		14</span>
<span class="cp">#define	HIFN_BASE_CMD_DSTLEN_M		0x3000</span>
<span class="cp">#define	HIFN_BASE_CMD_DSTLEN_S		12</span>
<span class="cp">#define	HIFN_BASE_CMD_LENMASK_HI	0x30000</span>
<span class="cp">#define	HIFN_BASE_CMD_LENMASK_LO	0x0ffff</span>

<span class="cm">/*</span>
<span class="cm"> * Structure to help build up the command data structure.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">hifn_crypt_command</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">__le16</span> 		<span class="n">masks</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__le16</span> 		<span class="n">header_skip</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__le16</span> 		<span class="n">source_count</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__le16</span> 		<span class="n">reserved</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define	HIFN_CRYPT_CMD_ALG_MASK		0x0003		</span><span class="cm">/* algorithm: */</span><span class="cp"></span>
<span class="cp">#define	HIFN_CRYPT_CMD_ALG_DES		0x0000		</span><span class="cm">/*   DES */</span><span class="cp"></span>
<span class="cp">#define	HIFN_CRYPT_CMD_ALG_3DES		0x0001		</span><span class="cm">/*   3DES */</span><span class="cp"></span>
<span class="cp">#define	HIFN_CRYPT_CMD_ALG_RC4		0x0002		</span><span class="cm">/*   RC4 */</span><span class="cp"></span>
<span class="cp">#define	HIFN_CRYPT_CMD_ALG_AES		0x0003		</span><span class="cm">/*   AES */</span><span class="cp"></span>
<span class="cp">#define	HIFN_CRYPT_CMD_MODE_MASK	0x0018		</span><span class="cm">/* Encrypt mode: */</span><span class="cp"></span>
<span class="cp">#define	HIFN_CRYPT_CMD_MODE_ECB		0x0000		</span><span class="cm">/*   ECB */</span><span class="cp"></span>
<span class="cp">#define	HIFN_CRYPT_CMD_MODE_CBC		0x0008		</span><span class="cm">/*   CBC */</span><span class="cp"></span>
<span class="cp">#define	HIFN_CRYPT_CMD_MODE_CFB		0x0010		</span><span class="cm">/*   CFB */</span><span class="cp"></span>
<span class="cp">#define	HIFN_CRYPT_CMD_MODE_OFB		0x0018		</span><span class="cm">/*   OFB */</span><span class="cp"></span>
<span class="cp">#define	HIFN_CRYPT_CMD_CLR_CTX		0x0040		</span><span class="cm">/* clear context */</span><span class="cp"></span>
<span class="cp">#define	HIFN_CRYPT_CMD_KSZ_MASK		0x0600		</span><span class="cm">/* AES key size: */</span><span class="cp"></span>
<span class="cp">#define	HIFN_CRYPT_CMD_KSZ_128		0x0000		</span><span class="cm">/*  128 bit */</span><span class="cp"></span>
<span class="cp">#define	HIFN_CRYPT_CMD_KSZ_192		0x0200		</span><span class="cm">/*  192 bit */</span><span class="cp"></span>
<span class="cp">#define	HIFN_CRYPT_CMD_KSZ_256		0x0400		</span><span class="cm">/*  256 bit */</span><span class="cp"></span>
<span class="cp">#define	HIFN_CRYPT_CMD_NEW_KEY		0x0800		</span><span class="cm">/* expect new key */</span><span class="cp"></span>
<span class="cp">#define	HIFN_CRYPT_CMD_NEW_IV		0x1000		</span><span class="cm">/* expect new iv */</span><span class="cp"></span>
<span class="cp">#define	HIFN_CRYPT_CMD_SRCLEN_M		0xc000</span>
<span class="cp">#define	HIFN_CRYPT_CMD_SRCLEN_S		14</span>

<span class="cm">/*</span>
<span class="cm"> * Structure to help build up the command data structure.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">hifn_mac_command</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">__le16</span> 	<span class="n">masks</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__le16</span> 	<span class="n">header_skip</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__le16</span> 	<span class="n">source_count</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__le16</span> 	<span class="n">reserved</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define	HIFN_MAC_CMD_ALG_MASK		0x0001</span>
<span class="cp">#define	HIFN_MAC_CMD_ALG_SHA1		0x0000</span>
<span class="cp">#define	HIFN_MAC_CMD_ALG_MD5		0x0001</span>
<span class="cp">#define	HIFN_MAC_CMD_MODE_MASK		0x000c</span>
<span class="cp">#define	HIFN_MAC_CMD_MODE_HMAC		0x0000</span>
<span class="cp">#define	HIFN_MAC_CMD_MODE_SSL_MAC	0x0004</span>
<span class="cp">#define	HIFN_MAC_CMD_MODE_HASH		0x0008</span>
<span class="cp">#define	HIFN_MAC_CMD_MODE_FULL		0x0004</span>
<span class="cp">#define	HIFN_MAC_CMD_TRUNC		0x0010</span>
<span class="cp">#define	HIFN_MAC_CMD_RESULT		0x0020</span>
<span class="cp">#define	HIFN_MAC_CMD_APPEND		0x0040</span>
<span class="cp">#define	HIFN_MAC_CMD_SRCLEN_M		0xc000</span>
<span class="cp">#define	HIFN_MAC_CMD_SRCLEN_S		14</span>

<span class="cm">/*</span>
<span class="cm"> * MAC POS IPsec initiates authentication after encryption on encodes</span>
<span class="cm"> * and before decryption on decodes.</span>
<span class="cm"> */</span>
<span class="cp">#define	HIFN_MAC_CMD_POS_IPSEC		0x0200</span>
<span class="cp">#define	HIFN_MAC_CMD_NEW_KEY		0x0800</span>

<span class="k">struct</span> <span class="n">hifn_comp_command</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">__le16</span> 	<span class="n">masks</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__le16</span> 	<span class="n">header_skip</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__le16</span> 	<span class="n">source_count</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__le16</span> 	<span class="n">reserved</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define	HIFN_COMP_CMD_SRCLEN_M		0xc000</span>
<span class="cp">#define	HIFN_COMP_CMD_SRCLEN_S		14</span>
<span class="cp">#define	HIFN_COMP_CMD_ONE		0x0100	</span><span class="cm">/* must be one */</span><span class="cp"></span>
<span class="cp">#define	HIFN_COMP_CMD_CLEARHIST		0x0010	</span><span class="cm">/* clear history */</span><span class="cp"></span>
<span class="cp">#define	HIFN_COMP_CMD_UPDATEHIST	0x0008	</span><span class="cm">/* update history */</span><span class="cp"></span>
<span class="cp">#define	HIFN_COMP_CMD_LZS_STRIP0	0x0004	</span><span class="cm">/* LZS: strip zero */</span><span class="cp"></span>
<span class="cp">#define	HIFN_COMP_CMD_MPPC_RESTART	0x0004	</span><span class="cm">/* MPPC: restart */</span><span class="cp"></span>
<span class="cp">#define	HIFN_COMP_CMD_ALG_MASK		0x0001	</span><span class="cm">/* compression mode: */</span><span class="cp"></span>
<span class="cp">#define	HIFN_COMP_CMD_ALG_MPPC		0x0001	</span><span class="cm">/*   MPPC */</span><span class="cp"></span>
<span class="cp">#define	HIFN_COMP_CMD_ALG_LZS		0x0000	</span><span class="cm">/*   LZS */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">hifn_base_result</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">__le16</span> 	<span class="n">flags</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__le16</span> 	<span class="n">session</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__le16</span> 	<span class="n">src_cnt</span><span class="p">;</span>		<span class="cm">/* 15:0 of source count */</span>
	<span class="k">volatile</span> <span class="n">__le16</span> 	<span class="n">dst_cnt</span><span class="p">;</span>		<span class="cm">/* 15:0 of dest count */</span>
<span class="p">};</span>

<span class="cp">#define	HIFN_BASE_RES_DSTOVERRUN	0x0200	</span><span class="cm">/* destination overrun */</span><span class="cp"></span>
<span class="cp">#define	HIFN_BASE_RES_SRCLEN_M		0xc000	</span><span class="cm">/* 17:16 of source count */</span><span class="cp"></span>
<span class="cp">#define	HIFN_BASE_RES_SRCLEN_S		14</span>
<span class="cp">#define	HIFN_BASE_RES_DSTLEN_M		0x3000	</span><span class="cm">/* 17:16 of dest count */</span><span class="cp"></span>
<span class="cp">#define	HIFN_BASE_RES_DSTLEN_S		12</span>

<span class="k">struct</span> <span class="n">hifn_comp_result</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">__le16</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__le16</span>		<span class="n">crc</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define	HIFN_COMP_RES_LCB_M		0xff00	</span><span class="cm">/* longitudinal check byte */</span><span class="cp"></span>
<span class="cp">#define	HIFN_COMP_RES_LCB_S		8</span>
<span class="cp">#define	HIFN_COMP_RES_RESTART		0x0004	</span><span class="cm">/* MPPC: restart */</span><span class="cp"></span>
<span class="cp">#define	HIFN_COMP_RES_ENDMARKER		0x0002	</span><span class="cm">/* LZS: end marker seen */</span><span class="cp"></span>
<span class="cp">#define	HIFN_COMP_RES_SRC_NOTZERO	0x0001	</span><span class="cm">/* source expired */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">hifn_mac_result</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">__le16</span> 	<span class="n">flags</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__le16</span> 	<span class="n">reserved</span><span class="p">;</span>
	<span class="cm">/* followed by 0, 6, 8, or 10 u16&#39;s of the MAC, then crypt */</span>
<span class="p">};</span>

<span class="cp">#define	HIFN_MAC_RES_MISCOMPARE		0x0002	</span><span class="cm">/* compare failed */</span><span class="cp"></span>
<span class="cp">#define	HIFN_MAC_RES_SRC_NOTZERO	0x0001	</span><span class="cm">/* source expired */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">hifn_crypt_result</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">__le16</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__le16</span>		<span class="n">reserved</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define	HIFN_CRYPT_RES_SRC_NOTZERO	0x0001	</span><span class="cm">/* source expired */</span><span class="cp"></span>

<span class="cp">#ifndef HIFN_POLL_FREQUENCY</span>
<span class="cp">#define	HIFN_POLL_FREQUENCY	0x1</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef HIFN_POLL_SCALAR</span>
<span class="cp">#define	HIFN_POLL_SCALAR	0x0</span>
<span class="cp">#endif</span>

<span class="cp">#define	HIFN_MAX_SEGLEN 	0xffff		</span><span class="cm">/* maximum dma segment len */</span><span class="cp"></span>
<span class="cp">#define	HIFN_MAX_DMALEN		0x3ffff		</span><span class="cm">/* maximum dma length */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">hifn_crypto_alg</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_alg</span>	<span class="n">alg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hifn_device</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define ASYNC_SCATTERLIST_CACHE	16</span>

<span class="cp">#define ASYNC_FLAGS_MISALIGNED	(1&lt;&lt;0)</span>

<span class="k">struct</span> <span class="n">hifn_cipher_walk</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span>	<span class="n">cache</span><span class="p">[</span><span class="n">ASYNC_SCATTERLIST_CACHE</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">num</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hifn_context</span>
<span class="p">{</span>
	<span class="n">u8</span>			<span class="n">key</span><span class="p">[</span><span class="n">HIFN_MAX_CRYPT_KEY_LENGTH</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">hifn_device</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">keysize</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hifn_request_context</span>
<span class="p">{</span>
	<span class="n">u8</span>			<span class="o">*</span><span class="n">iv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">ivsize</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">op</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">unused</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hifn_cipher_walk</span>	<span class="n">walk</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define crypto_alg_to_hifn(a)	container_of(a, struct hifn_crypto_alg, alg)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">hifn_read_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">hifn_read_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hifn_write_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hifn_write_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hifn_wait_puc</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">10000</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hifn_read_0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_0_PUCTRL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">HIFN_PUCTRL_RESET</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Failed to reset PUC unit.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hifn_reset_puc</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hifn_write_0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_0_PUCTRL</span><span class="p">,</span> <span class="n">HIFN_PUCTRL_DMAENA</span><span class="p">);</span>
	<span class="n">hifn_wait_puc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hifn_stop_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CSR</span><span class="p">,</span>
		<span class="n">HIFN_DMACSR_D_CTRL_DIS</span> <span class="o">|</span> <span class="n">HIFN_DMACSR_R_CTRL_DIS</span> <span class="o">|</span>
		<span class="n">HIFN_DMACSR_S_CTRL_DIS</span> <span class="o">|</span> <span class="n">HIFN_DMACSR_C_CTRL_DIS</span><span class="p">);</span>
	<span class="n">hifn_write_0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_0_PUIER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_IER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hifn_reset_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">full</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hifn_stop_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setting poll frequency and others to 0.</span>
<span class="cm">	 */</span>
	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CNFG</span><span class="p">,</span> <span class="n">HIFN_DMACNFG_MSTRESET</span> <span class="o">|</span>
			<span class="n">HIFN_DMACNFG_DMARESET</span> <span class="o">|</span> <span class="n">HIFN_DMACNFG_MODE</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset DMA.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">full</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CNFG</span><span class="p">,</span> <span class="n">HIFN_DMACNFG_MODE</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CNFG</span><span class="p">,</span> <span class="n">HIFN_DMACNFG_MODE</span> <span class="o">|</span>
				<span class="n">HIFN_DMACNFG_MSTRESET</span><span class="p">);</span>
		<span class="n">hifn_reset_puc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CNFG</span><span class="p">,</span> <span class="n">HIFN_DMACNFG_MSTRESET</span> <span class="o">|</span>
			<span class="n">HIFN_DMACNFG_DMARESET</span> <span class="o">|</span> <span class="n">HIFN_DMACNFG_MODE</span><span class="p">);</span>

	<span class="n">hifn_reset_puc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">hifn_next_signature</span><span class="p">(</span><span class="n">u_int32_t</span> <span class="n">a</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* get the parity */</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x80080125</span><span class="p">;</span>
		<span class="n">v</span> <span class="o">^=</span> <span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">v</span> <span class="o">^=</span> <span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">v</span> <span class="o">^=</span> <span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">v</span> <span class="o">^=</span> <span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">v</span> <span class="o">^=</span> <span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci2id</span> <span class="p">{</span>
	<span class="n">u_short</span>		<span class="n">pci_vendor</span><span class="p">;</span>
	<span class="n">u_short</span>		<span class="n">pci_prod</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="n">card_id</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
<span class="p">}</span> <span class="n">pci2id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="n">PCI_VENDOR_ID_HIFN</span><span class="p">,</span>
		<span class="n">PCI_DEVICE_ID_HIFN_7955</span><span class="p">,</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">PCI_VENDOR_ID_HIFN</span><span class="p">,</span>
		<span class="n">PCI_DEVICE_ID_HIFN_7956</span><span class="p">,</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_CRYPTO_DEV_HIFN_795X_RNG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_rng_data_present</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwrng</span> <span class="o">*</span><span class="n">rng</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="p">)</span><span class="n">rng</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">nsec</span><span class="p">;</span>

	<span class="n">nsec</span> <span class="o">=</span> <span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">ktime_sub</span><span class="p">(</span><span class="n">ktime_get</span><span class="p">(),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rngtime</span><span class="p">));</span>
	<span class="n">nsec</span> <span class="o">-=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rng_wait_time</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nsec</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">nsec</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_rng_data_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwrng</span> <span class="o">*</span><span class="n">rng</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="p">)</span><span class="n">rng</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">hifn_read_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_RNG_DATA</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rngtime</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_register_rng</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We must wait at least 256 Pk_clk cycles between two reads of the rng.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rng_wait_time</span>	<span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">NSEC_PER_SEC</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pk_clk_freq</span><span class="p">)</span> <span class="o">*</span>
				  <span class="mi">256</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">.</span><span class="n">data_present</span>	<span class="o">=</span> <span class="n">hifn_rng_data_present</span><span class="p">,</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">.</span><span class="n">data_read</span>	<span class="o">=</span> <span class="n">hifn_rng_data_read</span><span class="p">,</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">.</span><span class="n">priv</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hwrng_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hifn_unregister_rng</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hwrng_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define hifn_register_rng(dev)		0</span>
<span class="cp">#define hifn_unregister_rng(dev)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_init_pubrng</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_PUB_RESET</span><span class="p">,</span> <span class="n">hifn_read_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_PUB_RESET</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">HIFN_PUBRST_RESET</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">100</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">hifn_read_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_PUB_RESET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HIFN_PUBRST_RESET</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Chip %s: Failed to initialise public key engine.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_PUB_IEN</span><span class="p">,</span> <span class="n">HIFN_PUBIEN_DONE</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmareg</span> <span class="o">|=</span> <span class="n">HIFN_DMAIER_PUBDONE</span><span class="p">;</span>
		<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_IER</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmareg</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Chip %s: Public key engine has been successfully &quot;</span>
				<span class="s">&quot;initialised.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable RNG engine.</span>
<span class="cm">	 */</span>

	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_RNG_CONFIG</span><span class="p">,</span>
			<span class="n">hifn_read_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_RNG_CONFIG</span><span class="p">)</span> <span class="o">|</span> <span class="n">HIFN_RNGCFG_ENA</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Chip %s: RNG engine has been successfully initialised.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_CRYPTO_DEV_HIFN_795X_RNG</span>
	<span class="cm">/* First value must be discarded */</span>
	<span class="n">hifn_read_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_RNG_DATA</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rngtime</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_enable_crypto</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dmacfg</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">offtbl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pci2id</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci2id</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pci_vendor</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">&amp;&amp;</span>
				<span class="n">pci2id</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pci_prod</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">offtbl</span> <span class="o">=</span> <span class="n">pci2id</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">card_id</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offtbl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Chip %s: Unknown card!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dmacfg</span> <span class="o">=</span> <span class="n">hifn_read_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CNFG</span><span class="p">);</span>

	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CNFG</span><span class="p">,</span>
			<span class="n">HIFN_DMACNFG_UNLOCK</span> <span class="o">|</span> <span class="n">HIFN_DMACNFG_MSTRESET</span> <span class="o">|</span>
			<span class="n">HIFN_DMACNFG_DMARESET</span> <span class="o">|</span> <span class="n">HIFN_DMACNFG_MODE</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">hifn_read_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_UNLOCK_SECRET1</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_UNLOCK_SECRET2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">12</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">hifn_next_signature</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">offtbl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x101</span><span class="p">);</span>
		<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_UNLOCK_SECRET2</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CNFG</span><span class="p">,</span> <span class="n">dmacfg</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Chip %s: %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hifn_init_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_virt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">HIFN_D_CMD_RSIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">dptr</span> <span class="o">+</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span><span class="p">,</span> <span class="n">command_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">HIFN_D_RES_RSIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">resr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">dptr</span> <span class="o">+</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span><span class="p">,</span> <span class="n">result_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup LAST descriptors.</span>
<span class="cm">	 */</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdr</span><span class="p">[</span><span class="n">HIFN_D_CMD_RSIZE</span><span class="p">].</span><span class="n">p</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">dptr</span> <span class="o">+</span>
			<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span><span class="p">,</span> <span class="n">cmdr</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">srcr</span><span class="p">[</span><span class="n">HIFN_D_SRC_RSIZE</span><span class="p">].</span><span class="n">p</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">dptr</span> <span class="o">+</span>
			<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span><span class="p">,</span> <span class="n">srcr</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dstr</span><span class="p">[</span><span class="n">HIFN_D_DST_RSIZE</span><span class="p">].</span><span class="n">p</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">dptr</span> <span class="o">+</span>
			<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span><span class="p">,</span> <span class="n">dstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">resr</span><span class="p">[</span><span class="n">HIFN_D_RES_RSIZE</span><span class="p">].</span><span class="n">p</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">dptr</span> <span class="o">+</span>
			<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span><span class="p">,</span> <span class="n">resr</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>

	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdu</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">srcu</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dstu</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">resu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdi</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">srci</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dsti</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">resi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdk</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">srck</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dstk</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">resk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize the PLL. We need to know the frequency of the reference clock</span>
<span class="cm"> * to calculate the optimal multiplier. For PCI we assume 66MHz, since that</span>
<span class="cm"> * allows us to operate without the risk of overclocking the chip. If it</span>
<span class="cm"> * actually uses 33MHz, the chip will operate at half the speed, this can be</span>
<span class="cm"> * overriden by specifying the frequency as module parameter (pci33).</span>
<span class="cm"> *</span>
<span class="cm"> * Unfortunately the PCI clock is not very suitable since the HIFN needs a</span>
<span class="cm"> * stable clock and the PCI clock frequency may vary, so the default is the</span>
<span class="cm"> * external clock. There is no way to find out its frequency, we default to</span>
<span class="cm"> * 66MHz since according to Mike Ham of HiFn, almost every board in existence</span>
<span class="cm"> * has an external crystal populated at 66MHz.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hifn_init_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pllcfg</span><span class="p">;</span>

	<span class="n">pllcfg</span> <span class="o">=</span> <span class="n">HIFN_1_PLL</span> <span class="o">|</span> <span class="n">HIFN_PLL_RESERVED_1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">hifn_pll_ref</span><span class="p">,</span> <span class="s">&quot;ext&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pllcfg</span> <span class="o">|=</span> <span class="n">HIFN_PLL_REF_CLK_PLL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pllcfg</span> <span class="o">|=</span> <span class="n">HIFN_PLL_REF_CLK_HBI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hifn_pll_ref</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">hifn_pll_ref</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">66</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;hifn795x: assuming %uMHz clock speed, &quot;</span>
				 <span class="s">&quot;override with hifn_pll_ref=%.3s&lt;frequency&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">freq</span><span class="p">,</span> <span class="n">hifn_pll_ref</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">HIFN_PLL_FCK_MAX</span> <span class="o">/</span> <span class="n">freq</span><span class="p">;</span>

	<span class="n">pllcfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">m</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">HIFN_PLL_ND_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">pllcfg</span> <span class="o">|=</span> <span class="n">HIFN_PLL_IS_1_8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pllcfg</span> <span class="o">|=</span> <span class="n">HIFN_PLL_IS_9_12</span><span class="p">;</span>

	<span class="cm">/* Select clock source and enable clock bypass */</span>
	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_PLL</span><span class="p">,</span> <span class="n">pllcfg</span> <span class="o">|</span>
		     <span class="n">HIFN_PLL_PK_CLK_HBI</span> <span class="o">|</span> <span class="n">HIFN_PLL_PE_CLK_HBI</span> <span class="o">|</span> <span class="n">HIFN_PLL_BP</span><span class="p">);</span>

	<span class="cm">/* Let the chip lock to the input clock */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Disable clock bypass */</span>
	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_PLL</span><span class="p">,</span> <span class="n">pllcfg</span> <span class="o">|</span>
		     <span class="n">HIFN_PLL_PK_CLK_HBI</span> <span class="o">|</span> <span class="n">HIFN_PLL_PE_CLK_HBI</span><span class="p">);</span>

	<span class="cm">/* Switch the engines to the PLL */</span>
	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_PLL</span><span class="p">,</span> <span class="n">pllcfg</span> <span class="o">|</span>
		     <span class="n">HIFN_PLL_PK_CLK_PLL</span> <span class="o">|</span> <span class="n">HIFN_PLL_PE_CLK_PLL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The Fpk_clk runs at half the total speed. Its frequency is needed to</span>
<span class="cm">	 * calculate the minimum time between two reads of the rng. Since 33MHz</span>
<span class="cm">	 * is actually 33.333... we overestimate the frequency here, resulting</span>
<span class="cm">	 * in slightly larger intervals.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pk_clk_freq</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="p">(</span><span class="n">freq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hifn_init_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_dma</span><span class="p">;</span>

	<span class="cm">/* Initialization magic... */</span>
	<span class="n">hifn_write_0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_0_PUCTRL</span><span class="p">,</span> <span class="n">HIFN_PUCTRL_DMAENA</span><span class="p">);</span>
	<span class="n">hifn_write_0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_0_FIFOCNFG</span><span class="p">,</span> <span class="n">HIFN_FIFOCNFG_THRESHOLD</span><span class="p">);</span>
	<span class="n">hifn_write_0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_0_PUIER</span><span class="p">,</span> <span class="n">HIFN_PUIER_DSTOVER</span><span class="p">);</span>

	<span class="cm">/* write all 4 ring address registers */</span>
	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CRAR</span><span class="p">,</span> <span class="n">dptr</span> <span class="o">+</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span><span class="p">,</span> <span class="n">cmdr</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_SRAR</span><span class="p">,</span> <span class="n">dptr</span> <span class="o">+</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span><span class="p">,</span> <span class="n">srcr</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_DRAR</span><span class="p">,</span> <span class="n">dptr</span> <span class="o">+</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span><span class="p">,</span> <span class="n">dstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_RRAR</span><span class="p">,</span> <span class="n">dptr</span> <span class="o">+</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span><span class="p">,</span> <span class="n">resr</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	hifn_write_1(dev, HIFN_1_DMA_CSR,</span>
<span class="c">	    HIFN_DMACSR_D_CTRL_DIS | HIFN_DMACSR_R_CTRL_DIS |</span>
<span class="c">	    HIFN_DMACSR_S_CTRL_DIS | HIFN_DMACSR_C_CTRL_DIS |</span>
<span class="c">	    HIFN_DMACSR_D_ABORT | HIFN_DMACSR_D_DONE | HIFN_DMACSR_D_LAST |</span>
<span class="c">	    HIFN_DMACSR_D_WAIT | HIFN_DMACSR_D_OVER |</span>
<span class="c">	    HIFN_DMACSR_R_ABORT | HIFN_DMACSR_R_DONE | HIFN_DMACSR_R_LAST |</span>
<span class="c">	    HIFN_DMACSR_R_WAIT | HIFN_DMACSR_R_OVER |</span>
<span class="c">	    HIFN_DMACSR_S_ABORT | HIFN_DMACSR_S_DONE | HIFN_DMACSR_S_LAST |</span>
<span class="c">	    HIFN_DMACSR_S_WAIT |</span>
<span class="c">	    HIFN_DMACSR_C_ABORT | HIFN_DMACSR_C_DONE | HIFN_DMACSR_C_LAST |</span>
<span class="c">	    HIFN_DMACSR_C_WAIT |</span>
<span class="c">	    HIFN_DMACSR_ENGINE |</span>
<span class="c">	    HIFN_DMACSR_PUBDONE);</span>
<span class="cp">#else</span>
	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CSR</span><span class="p">,</span>
	    <span class="n">HIFN_DMACSR_C_CTRL_ENA</span> <span class="o">|</span> <span class="n">HIFN_DMACSR_S_CTRL_ENA</span> <span class="o">|</span>
	    <span class="n">HIFN_DMACSR_D_CTRL_ENA</span> <span class="o">|</span> <span class="n">HIFN_DMACSR_R_CTRL_ENA</span> <span class="o">|</span>
	    <span class="n">HIFN_DMACSR_D_ABORT</span> <span class="o">|</span> <span class="n">HIFN_DMACSR_D_DONE</span> <span class="o">|</span> <span class="n">HIFN_DMACSR_D_LAST</span> <span class="o">|</span>
	    <span class="n">HIFN_DMACSR_D_WAIT</span> <span class="o">|</span> <span class="n">HIFN_DMACSR_D_OVER</span> <span class="o">|</span>
	    <span class="n">HIFN_DMACSR_R_ABORT</span> <span class="o">|</span> <span class="n">HIFN_DMACSR_R_DONE</span> <span class="o">|</span> <span class="n">HIFN_DMACSR_R_LAST</span> <span class="o">|</span>
	    <span class="n">HIFN_DMACSR_R_WAIT</span> <span class="o">|</span> <span class="n">HIFN_DMACSR_R_OVER</span> <span class="o">|</span>
	    <span class="n">HIFN_DMACSR_S_ABORT</span> <span class="o">|</span> <span class="n">HIFN_DMACSR_S_DONE</span> <span class="o">|</span> <span class="n">HIFN_DMACSR_S_LAST</span> <span class="o">|</span>
	    <span class="n">HIFN_DMACSR_S_WAIT</span> <span class="o">|</span>
	    <span class="n">HIFN_DMACSR_C_ABORT</span> <span class="o">|</span> <span class="n">HIFN_DMACSR_C_DONE</span> <span class="o">|</span> <span class="n">HIFN_DMACSR_C_LAST</span> <span class="o">|</span>
	    <span class="n">HIFN_DMACSR_C_WAIT</span> <span class="o">|</span>
	    <span class="n">HIFN_DMACSR_ENGINE</span> <span class="o">|</span>
	    <span class="n">HIFN_DMACSR_PUBDONE</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">hifn_read_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CSR</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmareg</span> <span class="o">|=</span> <span class="n">HIFN_DMAIER_R_DONE</span> <span class="o">|</span> <span class="n">HIFN_DMAIER_C_ABORT</span> <span class="o">|</span>
	    <span class="n">HIFN_DMAIER_D_OVER</span> <span class="o">|</span> <span class="n">HIFN_DMAIER_R_OVER</span> <span class="o">|</span>
	    <span class="n">HIFN_DMAIER_S_ABORT</span> <span class="o">|</span> <span class="n">HIFN_DMAIER_D_ABORT</span> <span class="o">|</span> <span class="n">HIFN_DMAIER_R_ABORT</span> <span class="o">|</span>
	    <span class="n">HIFN_DMAIER_ENGINE</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmareg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HIFN_DMAIER_C_WAIT</span><span class="p">;</span>

	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_IER</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmareg</span><span class="p">);</span>
	<span class="n">hifn_read_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_IER</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	hifn_write_0(dev, HIFN_0_PUCNFG, HIFN_PUCNFG_ENCCNFG |</span>
<span class="c">		    HIFN_PUCNFG_DRFR_128 | HIFN_PUCNFG_TCALLPHASES |</span>
<span class="c">		    HIFN_PUCNFG_TCDRVTOTEM | HIFN_PUCNFG_BUS32 |</span>
<span class="c">		    HIFN_PUCNFG_DRAM);</span>
<span class="cp">#else</span>
	<span class="n">hifn_write_0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_0_PUCNFG</span><span class="p">,</span> <span class="mh">0x10342</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">hifn_init_pll</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">hifn_write_0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_0_PUISR</span><span class="p">,</span> <span class="n">HIFN_PUISR_DSTOVER</span><span class="p">);</span>
	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CNFG</span><span class="p">,</span> <span class="n">HIFN_DMACNFG_MSTRESET</span> <span class="o">|</span>
	    <span class="n">HIFN_DMACNFG_DMARESET</span> <span class="o">|</span> <span class="n">HIFN_DMACNFG_MODE</span> <span class="o">|</span> <span class="n">HIFN_DMACNFG_LAST</span> <span class="o">|</span>
	    <span class="p">((</span><span class="n">HIFN_POLL_FREQUENCY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="n">HIFN_DMACNFG_POLLFREQ</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">((</span><span class="n">HIFN_POLL_SCALAR</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HIFN_DMACNFG_POLLINVAL</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_setup_base_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">dlen</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">slen</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u8</span> <span class="n">snum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hifn_base_command</span> <span class="o">*</span><span class="n">base_cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf_pos</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">base_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hifn_base_command</span> <span class="o">*</span><span class="p">)</span><span class="n">buf_pos</span><span class="p">;</span>
	<span class="n">base_cmd</span><span class="o">-&gt;</span><span class="n">masks</span> <span class="o">=</span> <span class="n">__cpu_to_le16</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">base_cmd</span><span class="o">-&gt;</span><span class="n">total_source_count</span> <span class="o">=</span>
		<span class="n">__cpu_to_le16</span><span class="p">(</span><span class="n">slen</span> <span class="o">&amp;</span> <span class="n">HIFN_BASE_CMD_LENMASK_LO</span><span class="p">);</span>
	<span class="n">base_cmd</span><span class="o">-&gt;</span><span class="n">total_dest_count</span> <span class="o">=</span>
		<span class="n">__cpu_to_le16</span><span class="p">(</span><span class="n">dlen</span> <span class="o">&amp;</span> <span class="n">HIFN_BASE_CMD_LENMASK_LO</span><span class="p">);</span>

	<span class="n">dlen</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">slen</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">base_cmd</span><span class="o">-&gt;</span><span class="n">session_num</span> <span class="o">=</span> <span class="n">__cpu_to_le16</span><span class="p">(</span><span class="n">snum</span> <span class="o">|</span>
	    <span class="p">((</span><span class="n">slen</span> <span class="o">&lt;&lt;</span> <span class="n">HIFN_BASE_CMD_SRCLEN_S</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HIFN_BASE_CMD_SRCLEN_M</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">((</span><span class="n">dlen</span> <span class="o">&lt;&lt;</span> <span class="n">HIFN_BASE_CMD_DSTLEN_S</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HIFN_BASE_CMD_DSTLEN_M</span><span class="p">));</span>

	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_base_command</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_setup_crypto_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">dlen</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">slen</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">keylen</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">iv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ivsize</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_virt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hifn_crypt_command</span> <span class="o">*</span><span class="n">cry_cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf_pos</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cmd_len</span><span class="p">;</span>

	<span class="n">cry_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hifn_crypt_command</span> <span class="o">*</span><span class="p">)</span><span class="n">buf_pos</span><span class="p">;</span>

	<span class="n">cry_cmd</span><span class="o">-&gt;</span><span class="n">source_count</span> <span class="o">=</span> <span class="n">__cpu_to_le16</span><span class="p">(</span><span class="n">dlen</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">dlen</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">cry_cmd</span><span class="o">-&gt;</span><span class="n">masks</span> <span class="o">=</span> <span class="n">__cpu_to_le16</span><span class="p">(</span><span class="n">mode</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">dlen</span> <span class="o">&lt;&lt;</span> <span class="n">HIFN_CRYPT_CMD_SRCLEN_S</span><span class="p">)</span> <span class="o">&amp;</span>
			 <span class="n">HIFN_CRYPT_CMD_SRCLEN_M</span><span class="p">));</span>
	<span class="n">cry_cmd</span><span class="o">-&gt;</span><span class="n">header_skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cry_cmd</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">buf_pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_crypt_command</span><span class="p">);</span>

	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdu</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdu</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmareg</span> <span class="o">|=</span> <span class="n">HIFN_DMAIER_C_WAIT</span><span class="p">;</span>
		<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_IER</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmareg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf_pos</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">keylen</span><span class="p">);</span>
		<span class="n">buf_pos</span> <span class="o">+=</span> <span class="n">keylen</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ivsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf_pos</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">ivsize</span><span class="p">);</span>
		<span class="n">buf_pos</span> <span class="o">+=</span> <span class="n">ivsize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd_len</span> <span class="o">=</span> <span class="n">buf_pos</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cmd_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_setup_cmd_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hifn_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hifn_request_context</span> <span class="o">*</span><span class="n">rctx</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nbytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_virt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="n">sa_idx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">buf_pos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">sa_idx</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdi</span><span class="p">;</span>
	<span class="n">buf_pos</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">command_bufs</span><span class="p">[</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdi</span><span class="p">];</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ACRYPTO_OP_DECRYPT</span>:
			<span class="n">mask</span> <span class="o">=</span> <span class="n">HIFN_BASE_CMD_CRYPT</span> <span class="o">|</span> <span class="n">HIFN_BASE_CMD_DECODE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ACRYPTO_OP_ENCRYPT</span>:
			<span class="n">mask</span> <span class="o">=</span> <span class="n">HIFN_BASE_CMD_CRYPT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ACRYPTO_OP_HMAC</span>:
			<span class="n">mask</span> <span class="o">=</span> <span class="n">HIFN_BASE_CMD_MAC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf_pos</span> <span class="o">+=</span> <span class="n">hifn_setup_base_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf_pos</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span>
			<span class="n">nbytes</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">snum</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">ACRYPTO_OP_ENCRYPT</span> <span class="o">||</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">ACRYPTO_OP_DECRYPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">md</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">keysize</span><span class="p">)</span>
			<span class="n">md</span> <span class="o">|=</span> <span class="n">HIFN_CRYPT_CMD_NEW_KEY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">iv</span> <span class="o">&amp;&amp;</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">ACRYPTO_MODE_ECB</span><span class="p">)</span>
			<span class="n">md</span> <span class="o">|=</span> <span class="n">HIFN_CRYPT_CMD_NEW_IV</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ACRYPTO_MODE_ECB</span>:
				<span class="n">md</span> <span class="o">|=</span> <span class="n">HIFN_CRYPT_CMD_MODE_ECB</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ACRYPTO_MODE_CBC</span>:
				<span class="n">md</span> <span class="o">|=</span> <span class="n">HIFN_CRYPT_CMD_MODE_CBC</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ACRYPTO_MODE_CFB</span>:
				<span class="n">md</span> <span class="o">|=</span> <span class="n">HIFN_CRYPT_CMD_MODE_CFB</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ACRYPTO_MODE_OFB</span>:
				<span class="n">md</span> <span class="o">|=</span> <span class="n">HIFN_CRYPT_CMD_MODE_OFB</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ACRYPTO_TYPE_AES_128</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">keysize</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
				<span class="n">md</span> <span class="o">|=</span> <span class="n">HIFN_CRYPT_CMD_KSZ_128</span> <span class="o">|</span>
					<span class="n">HIFN_CRYPT_CMD_ALG_AES</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ACRYPTO_TYPE_AES_192</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">keysize</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
				<span class="n">md</span> <span class="o">|=</span> <span class="n">HIFN_CRYPT_CMD_KSZ_192</span> <span class="o">|</span>
					<span class="n">HIFN_CRYPT_CMD_ALG_AES</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ACRYPTO_TYPE_AES_256</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">keysize</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
				<span class="n">md</span> <span class="o">|=</span> <span class="n">HIFN_CRYPT_CMD_KSZ_256</span> <span class="o">|</span>
					<span class="n">HIFN_CRYPT_CMD_ALG_AES</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ACRYPTO_TYPE_3DES</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">keysize</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
				<span class="n">md</span> <span class="o">|=</span> <span class="n">HIFN_CRYPT_CMD_ALG_3DES</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ACRYPTO_TYPE_DES</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">keysize</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
				<span class="n">md</span> <span class="o">|=</span> <span class="n">HIFN_CRYPT_CMD_ALG_DES</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">buf_pos</span> <span class="o">+=</span> <span class="n">hifn_setup_crypto_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf_pos</span><span class="p">,</span>
				<span class="n">nbytes</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">keysize</span><span class="p">,</span>
				<span class="n">rctx</span><span class="o">-&gt;</span><span class="n">iv</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ivsize</span><span class="p">,</span> <span class="n">md</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">[</span><span class="n">sa_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">started</span><span class="o">++</span><span class="p">;</span>

	<span class="n">cmd_len</span> <span class="o">=</span> <span class="n">buf_pos</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdr</span><span class="p">[</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdi</span><span class="p">].</span><span class="n">l</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">cmd_len</span> <span class="o">|</span> <span class="n">HIFN_D_VALID</span> <span class="o">|</span>
			<span class="n">HIFN_D_LAST</span> <span class="o">|</span> <span class="n">HIFN_D_MASKDONEIRQ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdi</span> <span class="o">==</span> <span class="n">HIFN_D_CMD_RSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdr</span><span class="p">[</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdi</span><span class="p">].</span><span class="n">l</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span>
			<span class="n">HIFN_D_VALID</span> <span class="o">|</span> <span class="n">HIFN_D_LAST</span> <span class="o">|</span>
			<span class="n">HIFN_D_MASKDONEIRQ</span> <span class="o">|</span> <span class="n">HIFN_D_JUMP</span><span class="p">);</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdr</span><span class="p">[</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdi</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">l</span> <span class="o">|=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">HIFN_D_VALID</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HIFN_FLAG_CMD_BUSY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CSR</span><span class="p">,</span> <span class="n">HIFN_DMACSR_C_CTRL_ENA</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">HIFN_FLAG_CMD_BUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_setup_src_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_virt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">pci_map_page</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">srci</span><span class="p">;</span>

	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">srcr</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">p</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">srcr</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">l</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">size</span> <span class="o">|</span> <span class="n">HIFN_D_VALID</span> <span class="o">|</span>
			<span class="n">HIFN_D_MASKDONEIRQ</span> <span class="o">|</span> <span class="p">(</span><span class="n">last</span> <span class="o">?</span> <span class="n">HIFN_D_LAST</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">idx</span> <span class="o">==</span> <span class="n">HIFN_D_SRC_RSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">srcr</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">l</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">HIFN_D_VALID</span> <span class="o">|</span>
				<span class="n">HIFN_D_JUMP</span> <span class="o">|</span> <span class="n">HIFN_D_MASKDONEIRQ</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">last</span> <span class="o">?</span> <span class="n">HIFN_D_LAST</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">srci</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">srcu</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HIFN_FLAG_SRC_BUSY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CSR</span><span class="p">,</span> <span class="n">HIFN_DMACSR_S_CTRL_ENA</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">HIFN_FLAG_SRC_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hifn_setup_res_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_virt</span><span class="p">;</span>

	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">resr</span><span class="p">[</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">resi</span><span class="p">].</span><span class="n">l</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">HIFN_USED_RESULT</span> <span class="o">|</span>
			<span class="n">HIFN_D_VALID</span> <span class="o">|</span> <span class="n">HIFN_D_LAST</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * dma-&gt;resr[dma-&gt;resi].l = __cpu_to_le32(HIFN_MAX_RESULT | HIFN_D_VALID |</span>
<span class="cm">	 *					HIFN_D_LAST);</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">resi</span> <span class="o">==</span> <span class="n">HIFN_D_RES_RSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">resr</span><span class="p">[</span><span class="n">HIFN_D_RES_RSIZE</span><span class="p">].</span><span class="n">l</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">HIFN_D_VALID</span> <span class="o">|</span>
				<span class="n">HIFN_D_JUMP</span> <span class="o">|</span> <span class="n">HIFN_D_MASKDONEIRQ</span> <span class="o">|</span> <span class="n">HIFN_D_LAST</span><span class="p">);</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">resi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">resu</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HIFN_FLAG_RES_BUSY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CSR</span><span class="p">,</span> <span class="n">HIFN_DMACSR_R_CTRL_ENA</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">HIFN_FLAG_RES_BUSY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hifn_setup_dst_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_virt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">pci_map_page</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dsti</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dstr</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">p</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dstr</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">l</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">size</span> <span class="o">|</span>	<span class="n">HIFN_D_VALID</span> <span class="o">|</span>
			<span class="n">HIFN_D_MASKDONEIRQ</span> <span class="o">|</span> <span class="p">(</span><span class="n">last</span> <span class="o">?</span> <span class="n">HIFN_D_LAST</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">idx</span> <span class="o">==</span> <span class="n">HIFN_D_DST_RSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dstr</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">l</span> <span class="o">=</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">HIFN_D_VALID</span> <span class="o">|</span>
				<span class="n">HIFN_D_JUMP</span> <span class="o">|</span> <span class="n">HIFN_D_MASKDONEIRQ</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">last</span> <span class="o">?</span> <span class="n">HIFN_D_LAST</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dsti</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dstu</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HIFN_FLAG_DST_BUSY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CSR</span><span class="p">,</span> <span class="n">HIFN_DMACSR_D_CTRL_ENA</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">HIFN_FLAG_DST_BUSY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_setup_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hifn_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hifn_request_context</span> <span class="o">*</span><span class="n">rctx</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nbytes</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">spage</span><span class="p">,</span> <span class="o">*</span><span class="n">dpage</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">soff</span><span class="p">,</span> <span class="n">doff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">nbytes</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spage</span> <span class="o">=</span> <span class="n">sg_page</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
		<span class="n">soff</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

		<span class="n">hifn_setup_src_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">spage</span><span class="p">,</span> <span class="n">soff</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">src</span><span class="o">++</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">walk</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">nbytes</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">walk</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_FLAGS_MISALIGNED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sg_page</span><span class="p">(</span><span class="n">t</span><span class="p">));</span>
			<span class="n">dpage</span> <span class="o">=</span> <span class="n">sg_page</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="n">doff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sg_page</span><span class="p">(</span><span class="n">dst</span><span class="p">));</span>
			<span class="n">dpage</span> <span class="o">=</span> <span class="n">sg_page</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
			<span class="n">doff</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

		<span class="n">hifn_setup_dst_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dpage</span><span class="p">,</span> <span class="n">doff</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
		<span class="n">t</span><span class="o">++</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hifn_setup_cmd_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">rctx</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>
	<span class="n">hifn_setup_res_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_cipher_walk_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_cipher_walk</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">num</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">ASYNC_SCATTERLIST_CACHE</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
	<span class="n">sg_init_table</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>

	<span class="n">w</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">num</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">gfp_flags</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">sg_set_page</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">w</span><span class="o">-&gt;</span><span class="n">num</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hifn_cipher_walk_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_cipher_walk</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">__free_page</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>

		<span class="n">s</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">w</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ablkcipher_add</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">drestp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nbytesp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">copy</span><span class="p">,</span> <span class="n">drest</span> <span class="o">=</span> <span class="o">*</span><span class="n">drestp</span><span class="p">,</span> <span class="n">nbytes</span> <span class="o">=</span> <span class="o">*</span><span class="n">nbytesp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drest</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">nbytes</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">copy</span> <span class="o">=</span> <span class="n">min3</span><span class="p">(</span><span class="n">drest</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

		<span class="n">size</span> <span class="o">-=</span> <span class="n">copy</span><span class="p">;</span>
		<span class="n">drest</span> <span class="o">-=</span> <span class="n">copy</span><span class="p">;</span>
		<span class="n">nbytes</span> <span class="o">-=</span> <span class="n">copy</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: copy: %u, size: %u, drest: %u, nbytes: %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">copy</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">drest</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>

		<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">nbytesp</span> <span class="o">=</span> <span class="n">nbytes</span><span class="p">;</span>
	<span class="o">*</span><span class="n">drestp</span> <span class="o">=</span> <span class="n">drest</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_cipher_walk</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hifn_cipher_walk</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nbytes</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">copy</span><span class="p">,</span> <span class="n">diff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tidx</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">tidx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nbytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_FLAGS_MISALIGNED</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">dst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%s: dlen: %u, doff: %u, offset: %u, nbytes: %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">HIFN_D_DST_DALIGN</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">HIFN_D_DST_DALIGN</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="n">slen</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>
			<span class="kt">unsigned</span> <span class="n">dlen</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

			<span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">ablkcipher_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dlen</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">slen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nbytes</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

			<span class="n">idx</span> <span class="o">+=</span> <span class="n">err</span><span class="p">;</span>

			<span class="n">copy</span> <span class="o">=</span> <span class="n">slen</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">HIFN_D_DST_DALIGN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">diff</span> <span class="o">=</span> <span class="n">slen</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HIFN_D_DST_DALIGN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">&lt;</span> <span class="n">nbytes</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Destination page does not have enough space</span>
<span class="cm">				 * to put there additional blocksized chunk,</span>
<span class="cm">				 * so we mark that page as containing only</span>
<span class="cm">				 * blocksize aligned chunks:</span>
<span class="cm">				 * 	t-&gt;length = (slen &amp; ~(HIFN_D_DST_DALIGN - 1));</span>
<span class="cm">				 * and increase number of bytes to be processed</span>
<span class="cm">				 * in next chunk:</span>
<span class="cm">				 * 	nbytes += diff;</span>
<span class="cm">				 */</span>
				<span class="n">nbytes</span> <span class="o">+=</span> <span class="n">diff</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * Temporary of course...</span>
<span class="cm">				 * Kick author if you will catch this one.</span>
<span class="cm">				 */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: dlen: %u, nbytes: %u,&quot;</span>
					<span class="s">&quot;slen: %u, offset: %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">dlen</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">slen</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: please contact author to fix this &quot;</span>
					<span class="s">&quot;issue, generally you should not catch &quot;</span>
					<span class="s">&quot;this path under any condition but who &quot;</span>
					<span class="s">&quot;knows how did you use crypto code.</span><span class="se">\n</span><span class="s">&quot;</span>
					<span class="s">&quot;Thank you.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	<span class="n">__func__</span><span class="p">);</span>
				<span class="n">BUG</span><span class="p">();</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">copy</span> <span class="o">+=</span> <span class="n">diff</span> <span class="o">+</span> <span class="n">nbytes</span><span class="p">;</span>

				<span class="n">dst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

				<span class="n">err</span> <span class="o">=</span> <span class="n">ablkcipher_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dlen</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nbytes</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

				<span class="n">idx</span> <span class="o">+=</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">t</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">copy</span><span class="p">;</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nbytes</span> <span class="o">-=</span> <span class="n">min</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>
			<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tidx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">tidx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_setup_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hifn_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_tfm_ctx</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">tfm</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hifn_request_context</span> <span class="o">*</span><span class="n">rctx</span> <span class="o">=</span> <span class="n">ablkcipher_request_ctx</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dlen</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nbytes</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span> <span class="n">sg_num</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">iv</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ivsize</span> <span class="o">&amp;&amp;</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">ACRYPTO_MODE_ECB</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_exit</span><span class="p">;</span>

	<span class="n">rctx</span><span class="o">-&gt;</span><span class="n">walk</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">nbytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">dlen</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">HIFN_D_DST_DALIGN</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">dlen</span><span class="p">,</span> <span class="n">HIFN_D_DST_DALIGN</span><span class="p">))</span>
			<span class="n">rctx</span><span class="o">-&gt;</span><span class="n">walk</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_FLAGS_MISALIGNED</span><span class="p">;</span>

		<span class="n">nbytes</span> <span class="o">-=</span> <span class="n">dlen</span><span class="p">;</span>
		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">walk</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_FLAGS_MISALIGNED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hifn_cipher_walk_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">walk</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sg_num</span> <span class="o">=</span> <span class="n">hifn_cipher_walk</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">walk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sg_num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sg_num</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">+</span> <span class="n">sg_num</span> <span class="o">&gt;</span> <span class="n">HIFN_QUEUE_LENGTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hifn_setup_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">rctx</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">snum</span><span class="o">++</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="n">HIFN_DEFAULT_ACTIVE_NUM</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">err_out_exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: iv: %p [%d], key: %p [%d], mode: %u, op: %u, &quot;</span>
				<span class="s">&quot;type: %u, err: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">iv</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ivsize</span><span class="p">,</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">keysize</span><span class="p">,</span>
			<span class="n">rctx</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">encdec</span><span class="p">,</span> <span class="n">u8</span> <span class="n">snum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">src</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">hifn_context</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hifn_request_context</span> <span class="n">rctx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fips_aes_ecb_from_zero</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span>
		<span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0x8A</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span>
		<span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span>
		<span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">,</span> <span class="mh">0x2E</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">src</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">key</span><span class="p">));</span>

	<span class="n">ctx</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">ctx</span><span class="p">.</span><span class="n">keysize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">rctx</span><span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rctx</span><span class="p">.</span><span class="n">iv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rctx</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="p">(</span><span class="n">encdec</span><span class="p">)</span><span class="o">?</span><span class="n">ACRYPTO_OP_ENCRYPT</span><span class="o">:</span><span class="n">ACRYPTO_OP_DECRYPT</span><span class="p">;</span>
	<span class="n">rctx</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">ACRYPTO_MODE_ECB</span><span class="p">;</span>
	<span class="n">rctx</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACRYPTO_TYPE_AES_128</span><span class="p">;</span>
	<span class="n">rctx</span><span class="p">.</span><span class="n">walk</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">src</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hifn_setup_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: decoded: &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">n</span><span class="o">&lt;</span><span class="k">sizeof</span><span class="p">(</span><span class="n">src</span><span class="p">);</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: FIPS   : &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">n</span><span class="o">&lt;</span><span class="k">sizeof</span><span class="p">(</span><span class="n">fips_aes_ecb_from_zero</span><span class="p">);</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">fips_aes_ecb_from_zero</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">fips_aes_ecb_from_zero</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fips_aes_ecb_from_zero</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: AES 128 ECB test has been successfully &quot;</span>
				<span class="s">&quot;passed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err_out:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: AES 128 ECB test has been failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_start_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hifn_reset_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hifn_enable_crypto</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">hifn_reset_puc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">hifn_init_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">hifn_init_registers</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">hifn_init_pubrng</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ablkcipher_get</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">saddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">srestp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nbytesp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">srest</span> <span class="o">=</span> <span class="o">*</span><span class="n">srestp</span><span class="p">,</span> <span class="n">nbytes</span> <span class="o">=</span> <span class="o">*</span><span class="n">nbytesp</span><span class="p">,</span> <span class="n">copy</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">daddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srest</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">nbytes</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">copy</span> <span class="o">=</span> <span class="n">min3</span><span class="p">(</span><span class="n">srest</span><span class="p">,</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

		<span class="n">daddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">dst</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">daddr</span> <span class="o">+</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">copy</span><span class="p">);</span>
		<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">daddr</span><span class="p">);</span>

		<span class="n">nbytes</span> <span class="o">-=</span> <span class="n">copy</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">copy</span><span class="p">;</span>
		<span class="n">srest</span> <span class="o">-=</span> <span class="n">copy</span><span class="p">;</span>
		<span class="n">saddr</span> <span class="o">+=</span> <span class="n">copy</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: copy: %u, size: %u, srest: %u, nbytes: %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">copy</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">srest</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>

		<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">nbytesp</span> <span class="o">=</span> <span class="n">nbytes</span><span class="p">;</span>
	<span class="o">*</span><span class="n">srestp</span> <span class="o">=</span> <span class="n">srest</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hifn_complete_sa</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">started</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: started: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hifn_process_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hifn_request_context</span> <span class="o">*</span><span class="n">rctx</span> <span class="o">=</span> <span class="n">ablkcipher_request_ctx</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">walk</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_FLAGS_MISALIGNED</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nbytes</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">saddr</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">nbytes</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">walk</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
			<span class="n">dst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%s: sg_page(t): %p, t-&gt;length: %u, &quot;</span>
				<span class="s">&quot;sg_page(dst): %p, dst-&gt;length: %u, &quot;</span>
				<span class="s">&quot;nbytes: %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">sg_page</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
				<span class="n">sg_page</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nbytes</span> <span class="o">-=</span> <span class="n">min</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>
				<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">saddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">t</span><span class="p">));</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">ablkcipher_get</span><span class="p">(</span><span class="n">saddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
					<span class="n">dst</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nbytes</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">saddr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">idx</span> <span class="o">+=</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">saddr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">hifn_cipher_walk_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">walk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hifn_clear_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_virt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">u</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: ring cleanup 1: i: %d.%d.%d.%d, u: %d.%d.%d.%d, &quot;</span>
			<span class="s">&quot;k: %d.%d.%d.%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdi</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">srci</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dsti</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">resi</span><span class="p">,</span>
			<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdu</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">srcu</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dstu</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">resu</span><span class="p">,</span>
			<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdk</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">srck</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dstk</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">resk</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">resk</span><span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">resu</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">u</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">resr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span> <span class="o">&amp;</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">HIFN_D_VALID</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">success</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hifn_process_ready</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">error</span><span class="p">);</span>
			<span class="n">hifn_complete_sa</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">HIFN_D_RES_RSIZE</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">resk</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">resu</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">srck</span><span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">srcu</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">u</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">srcr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span> <span class="o">&amp;</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">HIFN_D_VALID</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">HIFN_D_SRC_RSIZE</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">srck</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">srcu</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdk</span><span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdu</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">u</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span> <span class="o">&amp;</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">HIFN_D_VALID</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">HIFN_D_CMD_RSIZE</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdk</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdu</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dstk</span><span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dstu</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">u</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dstr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span> <span class="o">&amp;</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">HIFN_D_VALID</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">HIFN_D_DST_RSIZE</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dstk</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dstu</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: ring cleanup 2: i: %d.%d.%d.%d, u: %d.%d.%d.%d, &quot;</span>
			<span class="s">&quot;k: %d.%d.%d.%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdi</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">srci</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dsti</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">resi</span><span class="p">,</span>
			<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdu</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">srcu</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dstu</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">resu</span><span class="p">,</span>
			<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdk</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">srck</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dstk</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">resk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hifn_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">dw</span> <span class="o">=</span> <span class="n">to_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hifn_device</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_virt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdu</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HIFN_FLAG_CMD_BUSY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HIFN_FLAG_CMD_BUSY</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">|=</span> <span class="n">HIFN_DMACSR_C_CTRL_DIS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">srcu</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HIFN_FLAG_SRC_BUSY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HIFN_FLAG_SRC_BUSY</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">|=</span> <span class="n">HIFN_DMACSR_S_CTRL_DIS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dstu</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HIFN_FLAG_DST_BUSY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HIFN_FLAG_DST_BUSY</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">|=</span> <span class="n">HIFN_DMACSR_D_CTRL_DIS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">resu</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HIFN_FLAG_RES_BUSY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HIFN_FLAG_RES_BUSY</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">|=</span> <span class="n">HIFN_DMACSR_R_CTRL_DIS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CSR</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">prev_success</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">success</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span>
		<span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">prev_success</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">success</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_virt</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: r: %08x, active: %d, started: %d, &quot;</span>
				<span class="s">&quot;success: %lu: qlen: %u/%u, reset: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">success</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">qlen</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">max_qlen</span><span class="p">,</span>
				<span class="n">reset</span><span class="p">);</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: res: &quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">HIFN_D_RES_RSIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%x.%p &quot;</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">resr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">hifn_process_ready</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
					<span class="n">hifn_complete_sa</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">hifn_reset_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">hifn_stop_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">hifn_start_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">hifn_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_virt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dmacsr</span><span class="p">,</span> <span class="n">restart</span><span class="p">;</span>

	<span class="n">dmacsr</span> <span class="o">=</span> <span class="n">hifn_read_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CSR</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: 1 dmacsr: %08x, dmareg: %08x, res: %08x [%d], &quot;</span>
			<span class="s">&quot;i: %d.%d.%d.%d, u: %d.%d.%d.%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dmacsr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmareg</span><span class="p">,</span> <span class="n">dmacsr</span> <span class="o">&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmareg</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdi</span><span class="p">,</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdi</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">srci</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dsti</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">resi</span><span class="p">,</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdu</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">srcu</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dstu</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">resu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dmacsr</span> <span class="o">&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmareg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CSR</span><span class="p">,</span> <span class="n">dmacsr</span> <span class="o">&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmareg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmacsr</span> <span class="o">&amp;</span> <span class="n">HIFN_DMACSR_ENGINE</span><span class="p">)</span>
		<span class="n">hifn_write_0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_0_PUISR</span><span class="p">,</span> <span class="n">hifn_read_0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_0_PUISR</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmacsr</span> <span class="o">&amp;</span> <span class="n">HIFN_DMACSR_PUBDONE</span><span class="p">)</span>
		<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_PUB_STATUS</span><span class="p">,</span>
			<span class="n">hifn_read_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_PUB_STATUS</span><span class="p">)</span> <span class="o">|</span> <span class="n">HIFN_PUBSTS_DONE</span><span class="p">);</span>

	<span class="n">restart</span> <span class="o">=</span> <span class="n">dmacsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HIFN_DMACSR_R_OVER</span> <span class="o">|</span> <span class="n">HIFN_DMACSR_D_OVER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">puisr</span> <span class="o">=</span> <span class="n">hifn_read_0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_0_PUISR</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: overflow: r: %d, d: %d, puisr: %08x, d: %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">!!</span><span class="p">(</span><span class="n">dmacsr</span> <span class="o">&amp;</span> <span class="n">HIFN_DMACSR_R_OVER</span><span class="p">),</span>
			<span class="o">!!</span><span class="p">(</span><span class="n">dmacsr</span> <span class="o">&amp;</span> <span class="n">HIFN_DMACSR_D_OVER</span><span class="p">),</span>
			<span class="n">puisr</span><span class="p">,</span> <span class="o">!!</span><span class="p">(</span><span class="n">puisr</span> <span class="o">&amp;</span> <span class="n">HIFN_PUISR_DSTOVER</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">puisr</span> <span class="o">&amp;</span> <span class="n">HIFN_PUISR_DSTOVER</span><span class="p">))</span>
			<span class="n">hifn_write_0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_0_PUISR</span><span class="p">,</span> <span class="n">HIFN_PUISR_DSTOVER</span><span class="p">);</span>
		<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_CSR</span><span class="p">,</span> <span class="n">dmacsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HIFN_DMACSR_R_OVER</span> <span class="o">|</span>
					<span class="n">HIFN_DMACSR_D_OVER</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">restart</span> <span class="o">=</span> <span class="n">dmacsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HIFN_DMACSR_C_ABORT</span> <span class="o">|</span> <span class="n">HIFN_DMACSR_S_ABORT</span> <span class="o">|</span>
			<span class="n">HIFN_DMACSR_D_ABORT</span> <span class="o">|</span> <span class="n">HIFN_DMACSR_R_ABORT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: abort: c: %d, s: %d, d: %d, r: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">!!</span><span class="p">(</span><span class="n">dmacsr</span> <span class="o">&amp;</span> <span class="n">HIFN_DMACSR_C_ABORT</span><span class="p">),</span>
			<span class="o">!!</span><span class="p">(</span><span class="n">dmacsr</span> <span class="o">&amp;</span> <span class="n">HIFN_DMACSR_S_ABORT</span><span class="p">),</span>
			<span class="o">!!</span><span class="p">(</span><span class="n">dmacsr</span> <span class="o">&amp;</span> <span class="n">HIFN_DMACSR_D_ABORT</span><span class="p">),</span>
			<span class="o">!!</span><span class="p">(</span><span class="n">dmacsr</span> <span class="o">&amp;</span> <span class="n">HIFN_DMACSR_R_ABORT</span><span class="p">));</span>
		<span class="n">hifn_reset_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">hifn_init_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">hifn_init_registers</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dmacsr</span> <span class="o">&amp;</span> <span class="n">HIFN_DMACSR_C_WAIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmdu</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: wait on command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmareg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HIFN_DMAIER_C_WAIT</span><span class="p">);</span>
		<span class="n">hifn_write_1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIFN_1_DMA_IER</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmareg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hifn_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_async_request</span> <span class="o">*</span><span class="n">async_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_virt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">HIFN_D_RES_RSIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hifn_desc</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">resr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">hifn_process_ready</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">&amp;</span> <span class="n">__cpu_to_le32</span><span class="p">(</span><span class="n">HIFN_D_VALID</span><span class="p">))</span><span class="o">?-</span><span class="n">ENODEV</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">hifn_complete_sa</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">async_req</span> <span class="o">=</span> <span class="n">crypto_dequeue_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">async_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ablkcipher_request</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">hifn_process_ready</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_setkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_ablkcipher</span> <span class="o">*</span><span class="n">cipher</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_tfm</span> <span class="o">*</span><span class="n">tfm</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_tfm</span><span class="p">(</span><span class="n">cipher</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hifn_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_tfm_ctx</span><span class="p">(</span><span class="n">tfm</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">HIFN_MAX_CRYPT_KEY_LENGTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crypto_ablkcipher_set_flags</span><span class="p">(</span><span class="n">cipher</span><span class="p">,</span> <span class="n">CRYPTO_TFM_RES_BAD_KEY_LEN</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="n">HIFN_DES_KEY_LENGTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tmp</span><span class="p">[</span><span class="n">DES_EXPKEY_WORDS</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">des_ekey</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tfm</span><span class="o">-&gt;</span><span class="n">crt_flags</span> <span class="o">&amp;</span> <span class="n">CRYPTO_TFM_REQ_WEAK_KEY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tfm</span><span class="o">-&gt;</span><span class="n">crt_flags</span> <span class="o">|=</span> <span class="n">CRYPTO_TFM_RES_WEAK_KEY</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HIFN_FLAG_OLD_KEY</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">keysize</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_handle_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hifn_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_tfm_ctx</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">tfm</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">+</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">HIFN_QUEUE_LENGTH</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hifn_setup_session</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ablkcipher_enqueue_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_setup_crypto_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">u8</span> <span class="n">op</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hifn_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_tfm_ctx</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">tfm</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hifn_request_context</span> <span class="o">*</span><span class="n">rctx</span> <span class="o">=</span> <span class="n">ablkcipher_request_ctx</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">ivsize</span><span class="p">;</span>

	<span class="n">ivsize</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_ivsize</span><span class="p">(</span><span class="n">crypto_ablkcipher_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">ACRYPTO_MODE_ECB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACRYPTO_TYPE_AES_128</span><span class="p">)</span>
			<span class="n">ivsize</span> <span class="o">=</span> <span class="n">HIFN_AES_IV_LENGTH</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACRYPTO_TYPE_DES</span><span class="p">)</span>
			<span class="n">ivsize</span> <span class="o">=</span> <span class="n">HIFN_DES_KEY_LENGTH</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACRYPTO_TYPE_3DES</span><span class="p">)</span>
			<span class="n">ivsize</span> <span class="o">=</span> <span class="n">HIFN_3DES_KEY_LENGTH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">keysize</span> <span class="o">!=</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">==</span> <span class="n">ACRYPTO_TYPE_AES_128</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">keysize</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">ACRYPTO_TYPE_AES_192</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">keysize</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">ACRYPTO_TYPE_AES_256</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rctx</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">rctx</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">rctx</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">rctx</span><span class="o">-&gt;</span><span class="n">iv</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">ivsize</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * HEAVY TODO: needs to kick Herbert XU to write documentation.</span>
<span class="cm">	 * HEAVY TODO: needs to kick Herbert XU to write documentation.</span>
<span class="cm">	 * HEAVY TODO: needs to kick Herbert XU to write documentation.</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="n">hifn_handle_req</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_process_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_async_request</span> <span class="o">*</span><span class="n">async_req</span><span class="p">,</span> <span class="o">*</span><span class="n">backlog</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">&lt;</span> <span class="n">HIFN_QUEUE_LENGTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">backlog</span> <span class="o">=</span> <span class="n">crypto_get_backlog</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">async_req</span> <span class="o">=</span> <span class="n">crypto_dequeue_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">async_req</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">backlog</span><span class="p">)</span>
			<span class="n">backlog</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">(</span><span class="n">backlog</span><span class="p">,</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">);</span>

		<span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">async_req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ablkcipher_request</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hifn_handle_req</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_setup_crypto</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">u8</span> <span class="n">op</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hifn_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_tfm_ctx</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">tfm</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hifn_setup_crypto_req</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">&lt;</span> <span class="n">HIFN_QUEUE_LENGTH</span> <span class="o">&amp;&amp;</span>	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">qlen</span><span class="p">)</span>
		<span class="n">hifn_process_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * AES ecryption functions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_encrypt_aes_ecb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_ENCRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_AES_128</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_ECB</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_encrypt_aes_cbc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_ENCRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_AES_128</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_CBC</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_encrypt_aes_cfb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_ENCRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_AES_128</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_CFB</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_encrypt_aes_ofb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_ENCRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_AES_128</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_OFB</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * AES decryption functions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_decrypt_aes_ecb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_DECRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_AES_128</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_ECB</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_decrypt_aes_cbc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_DECRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_AES_128</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_CBC</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_decrypt_aes_cfb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_DECRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_AES_128</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_CFB</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_decrypt_aes_ofb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_DECRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_AES_128</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_OFB</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DES ecryption functions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_encrypt_des_ecb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_ENCRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_DES</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_ECB</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_encrypt_des_cbc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_ENCRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_DES</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_CBC</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_encrypt_des_cfb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_ENCRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_DES</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_CFB</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_encrypt_des_ofb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_ENCRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_DES</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_OFB</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DES decryption functions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_decrypt_des_ecb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_DECRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_DES</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_ECB</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_decrypt_des_cbc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_DECRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_DES</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_CBC</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_decrypt_des_cfb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_DECRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_DES</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_CFB</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_decrypt_des_ofb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_DECRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_DES</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_OFB</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * 3DES ecryption functions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_encrypt_3des_ecb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_ENCRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_3DES</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_ECB</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_encrypt_3des_cbc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_ENCRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_3DES</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_CBC</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_encrypt_3des_cfb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_ENCRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_3DES</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_CFB</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_encrypt_3des_ofb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_ENCRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_3DES</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_OFB</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * 3DES decryption functions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_decrypt_3des_ecb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_DECRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_3DES</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_ECB</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_decrypt_3des_cbc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_DECRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_3DES</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_CBC</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_decrypt_3des_cfb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_DECRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_3DES</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_CFB</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hifn_decrypt_3des_ofb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hifn_setup_crypto</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ACRYPTO_OP_DECRYPT</span><span class="p">,</span>
			<span class="n">ACRYPTO_TYPE_3DES</span><span class="p">,</span> <span class="n">ACRYPTO_MODE_OFB</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">hifn_alg_template</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">CRYPTO_MAX_ALG_NAME</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">drv_name</span><span class="p">[</span><span class="n">CRYPTO_MAX_ALG_NAME</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bsize</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ablkcipher_alg</span> <span class="n">ablkcipher</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hifn_alg_template</span> <span class="n">hifn_alg_templates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * 3DES ECB, CBC, CFB and OFB modes.</span>
<span class="cm">	 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cfb(des3_ede)&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">drv_name</span> <span class="o">=</span> <span class="s">&quot;cfb-3des&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">bsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min_keysize</span>	<span class="o">=</span>	<span class="n">HIFN_3DES_KEY_LENGTH</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_keysize</span>	<span class="o">=</span>	<span class="n">HIFN_3DES_KEY_LENGTH</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setkey</span>		<span class="o">=</span>	<span class="n">hifn_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span>	<span class="o">=</span>	<span class="n">hifn_encrypt_3des_cfb</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span>	<span class="o">=</span>	<span class="n">hifn_decrypt_3des_cfb</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ofb(des3_ede)&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">drv_name</span> <span class="o">=</span> <span class="s">&quot;ofb-3des&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">bsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min_keysize</span>	<span class="o">=</span>	<span class="n">HIFN_3DES_KEY_LENGTH</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_keysize</span>	<span class="o">=</span>	<span class="n">HIFN_3DES_KEY_LENGTH</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setkey</span>		<span class="o">=</span>	<span class="n">hifn_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span>	<span class="o">=</span>	<span class="n">hifn_encrypt_3des_ofb</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span>	<span class="o">=</span>	<span class="n">hifn_decrypt_3des_ofb</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cbc(des3_ede)&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">drv_name</span> <span class="o">=</span> <span class="s">&quot;cbc-3des&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">bsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">ivsize</span>		<span class="o">=</span>	<span class="n">HIFN_IV_LENGTH</span><span class="p">,</span>
			<span class="p">.</span><span class="n">min_keysize</span>	<span class="o">=</span>	<span class="n">HIFN_3DES_KEY_LENGTH</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_keysize</span>	<span class="o">=</span>	<span class="n">HIFN_3DES_KEY_LENGTH</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setkey</span>		<span class="o">=</span>	<span class="n">hifn_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span>	<span class="o">=</span>	<span class="n">hifn_encrypt_3des_cbc</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span>	<span class="o">=</span>	<span class="n">hifn_decrypt_3des_cbc</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ecb(des3_ede)&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">drv_name</span> <span class="o">=</span> <span class="s">&quot;ecb-3des&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">bsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min_keysize</span>	<span class="o">=</span>	<span class="n">HIFN_3DES_KEY_LENGTH</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_keysize</span>	<span class="o">=</span>	<span class="n">HIFN_3DES_KEY_LENGTH</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setkey</span>		<span class="o">=</span>	<span class="n">hifn_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span>	<span class="o">=</span>	<span class="n">hifn_encrypt_3des_ecb</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span>	<span class="o">=</span>	<span class="n">hifn_decrypt_3des_ecb</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>

	<span class="cm">/*</span>
<span class="cm">	 * DES ECB, CBC, CFB and OFB modes.</span>
<span class="cm">	 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cfb(des)&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">drv_name</span> <span class="o">=</span> <span class="s">&quot;cfb-des&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">bsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min_keysize</span>	<span class="o">=</span>	<span class="n">HIFN_DES_KEY_LENGTH</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_keysize</span>	<span class="o">=</span>	<span class="n">HIFN_DES_KEY_LENGTH</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setkey</span>		<span class="o">=</span>	<span class="n">hifn_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span>	<span class="o">=</span>	<span class="n">hifn_encrypt_des_cfb</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span>	<span class="o">=</span>	<span class="n">hifn_decrypt_des_cfb</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ofb(des)&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">drv_name</span> <span class="o">=</span> <span class="s">&quot;ofb-des&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">bsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min_keysize</span>	<span class="o">=</span>	<span class="n">HIFN_DES_KEY_LENGTH</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_keysize</span>	<span class="o">=</span>	<span class="n">HIFN_DES_KEY_LENGTH</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setkey</span>		<span class="o">=</span>	<span class="n">hifn_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span>	<span class="o">=</span>	<span class="n">hifn_encrypt_des_ofb</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span>	<span class="o">=</span>	<span class="n">hifn_decrypt_des_ofb</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cbc(des)&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">drv_name</span> <span class="o">=</span> <span class="s">&quot;cbc-des&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">bsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">ivsize</span>		<span class="o">=</span>	<span class="n">HIFN_IV_LENGTH</span><span class="p">,</span>
			<span class="p">.</span><span class="n">min_keysize</span>	<span class="o">=</span>	<span class="n">HIFN_DES_KEY_LENGTH</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_keysize</span>	<span class="o">=</span>	<span class="n">HIFN_DES_KEY_LENGTH</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setkey</span>		<span class="o">=</span>	<span class="n">hifn_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span>	<span class="o">=</span>	<span class="n">hifn_encrypt_des_cbc</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span>	<span class="o">=</span>	<span class="n">hifn_decrypt_des_cbc</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ecb(des)&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">drv_name</span> <span class="o">=</span> <span class="s">&quot;ecb-des&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">bsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min_keysize</span>	<span class="o">=</span>	<span class="n">HIFN_DES_KEY_LENGTH</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_keysize</span>	<span class="o">=</span>	<span class="n">HIFN_DES_KEY_LENGTH</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setkey</span>		<span class="o">=</span>	<span class="n">hifn_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span>	<span class="o">=</span>	<span class="n">hifn_encrypt_des_ecb</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span>	<span class="o">=</span>	<span class="n">hifn_decrypt_des_ecb</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>

	<span class="cm">/*</span>
<span class="cm">	 * AES ECB, CBC, CFB and OFB modes.</span>
<span class="cm">	 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ecb(aes)&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">drv_name</span> <span class="o">=</span> <span class="s">&quot;ecb-aes&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">bsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min_keysize</span>	<span class="o">=</span>	<span class="n">AES_MIN_KEY_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_keysize</span>	<span class="o">=</span>	<span class="n">AES_MAX_KEY_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setkey</span>		<span class="o">=</span>	<span class="n">hifn_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span>	<span class="o">=</span>	<span class="n">hifn_encrypt_aes_ecb</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span>	<span class="o">=</span>	<span class="n">hifn_decrypt_aes_ecb</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cbc(aes)&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">drv_name</span> <span class="o">=</span> <span class="s">&quot;cbc-aes&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">bsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">ivsize</span>		<span class="o">=</span>	<span class="n">HIFN_AES_IV_LENGTH</span><span class="p">,</span>
			<span class="p">.</span><span class="n">min_keysize</span>	<span class="o">=</span>	<span class="n">AES_MIN_KEY_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_keysize</span>	<span class="o">=</span>	<span class="n">AES_MAX_KEY_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setkey</span>		<span class="o">=</span>	<span class="n">hifn_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span>	<span class="o">=</span>	<span class="n">hifn_encrypt_aes_cbc</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span>	<span class="o">=</span>	<span class="n">hifn_decrypt_aes_cbc</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cfb(aes)&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">drv_name</span> <span class="o">=</span> <span class="s">&quot;cfb-aes&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">bsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min_keysize</span>	<span class="o">=</span>	<span class="n">AES_MIN_KEY_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_keysize</span>	<span class="o">=</span>	<span class="n">AES_MAX_KEY_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setkey</span>		<span class="o">=</span>	<span class="n">hifn_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span>	<span class="o">=</span>	<span class="n">hifn_encrypt_aes_cfb</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span>	<span class="o">=</span>	<span class="n">hifn_decrypt_aes_cfb</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ofb(aes)&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">drv_name</span> <span class="o">=</span> <span class="s">&quot;ofb-aes&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">bsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min_keysize</span>	<span class="o">=</span>	<span class="n">AES_MIN_KEY_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_keysize</span>	<span class="o">=</span>	<span class="n">AES_MAX_KEY_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setkey</span>		<span class="o">=</span>	<span class="n">hifn_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span>	<span class="o">=</span>	<span class="n">hifn_encrypt_aes_ofb</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span>	<span class="o">=</span>	<span class="n">hifn_decrypt_aes_ofb</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_cra_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_tfm</span> <span class="o">*</span><span class="n">tfm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_alg</span> <span class="o">*</span><span class="n">alg</span> <span class="o">=</span> <span class="n">tfm</span><span class="o">-&gt;</span><span class="n">__crt_alg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hifn_crypto_alg</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">crypto_alg_to_hifn</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hifn_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_tfm_ctx</span><span class="p">(</span><span class="n">tfm</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">tfm</span><span class="o">-&gt;</span><span class="n">crt_ablkcipher</span><span class="p">.</span><span class="n">reqsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_request_context</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_alg_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hifn_alg_template</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hifn_crypto_alg</span> <span class="o">*</span><span class="n">alg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">alg</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_crypto_alg</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">alg</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_name</span><span class="p">,</span> <span class="n">CRYPTO_MAX_ALG_NAME</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">alg</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_driver_name</span><span class="p">,</span> <span class="n">CRYPTO_MAX_ALG_NAME</span><span class="p">,</span> <span class="s">&quot;%s-%s&quot;</span><span class="p">,</span>
		 <span class="n">t</span><span class="o">-&gt;</span><span class="n">drv_name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">alg</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_priority</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
	<span class="n">alg</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_flags</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_ABLKCIPHER</span> <span class="o">|</span>
				<span class="n">CRYPTO_ALG_KERN_DRIVER_ONLY</span> <span class="o">|</span> <span class="n">CRYPTO_ALG_ASYNC</span><span class="p">;</span>
	<span class="n">alg</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_blocksize</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">bsize</span><span class="p">;</span>
	<span class="n">alg</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_ctxsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_context</span><span class="p">);</span>
	<span class="n">alg</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_alignmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">alg</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crypto_ablkcipher_type</span><span class="p">;</span>
	<span class="n">alg</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">alg</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_u</span><span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">ablkcipher</span><span class="p">;</span>
	<span class="n">alg</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">.</span><span class="n">cra_init</span> <span class="o">=</span> <span class="n">hifn_cra_init</span><span class="p">;</span>

	<span class="n">alg</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alg</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alg_list</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">crypto_register_alg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alg</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alg</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hifn_unregister_alg</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hifn_crypto_alg</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alg_list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">crypto_unregister_alg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hifn_register_alg</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hifn_alg_templates</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hifn_alg_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hifn_alg_templates</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_exit:</span>
	<span class="n">hifn_unregister_alg</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hifn_tasklet_callback</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is ok to call this without lock being held,</span>
<span class="cm">	 * althogh it modifies some parameters used in parallel,</span>
<span class="cm">	 * (like dev-&gt;success), but they are used in process</span>
<span class="cm">	 * context or update is atomic (like setting dev-&gt;sa[i] to NULL).</span>
<span class="cm">	 */</span>
	<span class="n">hifn_clear_rings</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">&lt;</span> <span class="n">HIFN_QUEUE_LENGTH</span> <span class="o">&amp;&amp;</span>	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">qlen</span><span class="p">)</span>
		<span class="n">hifn_process_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">hifn_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_disable_pci_device</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;hifn%d&quot;</span><span class="p">,</span>
			<span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hifn_dev_number</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_disable_pci_device</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">HIFN_BAR0_SIZE</span> <span class="o">||</span>
	    <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">HIFN_BAR1_SIZE</span> <span class="o">||</span>
	    <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">HIFN_BAR2_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Broken hardware - I/O regions are too small.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_regions</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_device</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_alg</span><span class="p">),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_regions</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alg_list</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">err_out_unmap_bars</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_virt</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Failed to allocate descriptor rings.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_unmap_bars</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_virt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span><span class="p">));</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">HIFN_D_RES_RSIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">,</span> <span class="n">hifn_tasklet_callback</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">crypto_init_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hifn_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Failed to request IRQ%d: err: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_desc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hifn_start_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_irq</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hifn_test</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_stop_device</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hifn_register_rng</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_stop_device</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hifn_register_alg</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_unregister_rng</span><span class="p">;</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">hifn_work</span><span class="p">);</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;HIFN crypto accelerator card at %s has been &quot;</span>
			<span class="s">&quot;successfully registered as %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_unregister_rng:</span>
	<span class="n">hifn_unregister_rng</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_out_stop_device:</span>
	<span class="n">hifn_reset_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">hifn_stop_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_out_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
<span class="nl">err_out_free_desc:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span><span class="p">),</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_virt</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_dma</span><span class="p">);</span>

<span class="nl">err_out_unmap_bars:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="nl">err_out_free_regions:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="nl">err_out_disable_pci_device:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">hifn_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hifn_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

		<span class="n">hifn_unregister_rng</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">hifn_unregister_alg</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">hifn_reset_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">hifn_stop_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>

		<span class="n">hifn_flush</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hifn_dma</span><span class="p">),</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_virt</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_dma</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">hifn_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_HIFN</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_HIFN_7955</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_HIFN</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_HIFN_7956</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">hifn_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">hifn_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;hifn795x&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">hifn_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">hifn_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">hifn_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hifn_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* HIFN supports only 32-bit addresses */</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">hifn_pll_ref</span><span class="p">,</span> <span class="s">&quot;ext&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">strncmp</span><span class="p">(</span><span class="n">hifn_pll_ref</span><span class="p">,</span> <span class="s">&quot;pci&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;hifn795x: invalid hifn_pll_ref clock, &quot;</span>
				<span class="s">&quot;must be pci or ext&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For the 7955/7956 the reference clock frequency must be in the</span>
<span class="cm">	 * range of 20MHz-100MHz. For the 7954 the upper bound is 66.67MHz,</span>
<span class="cm">	 * but this chip is currently not supported.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hifn_pll_ref</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">hifn_pll_ref</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="o">||</span> <span class="n">freq</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;hifn795x: invalid hifn_pll_ref &quot;</span>
					<span class="s">&quot;frequency, must be in the range &quot;</span>
					<span class="s">&quot;of 20-100&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hifn_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Failed to register PCI driver for %s device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hifn_pci_driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Driver for HIFN 795x crypto accelerator chip &quot;</span>
			<span class="s">&quot;has been successfully registered.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">hifn_fini</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hifn_pci_driver</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Driver for HIFN 795x crypto accelerator chip &quot;</span>
			<span class="s">&quot;has been successfully unregistered.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">hifn_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">hifn_fini</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Evgeniy Polyakov &lt;johnpol@2ka.mipt.ru&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for HIFN 795x crypto accelerator chip.&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
