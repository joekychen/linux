<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › crypto › caam › caamalg.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>caamalg.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * caam - Freescale FSL CAAM support for crypto API</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2008-2011 Freescale Semiconductor, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Based on talitos crypto API driver.</span>
<span class="cm"> *</span>
<span class="cm"> * relationship of job descriptors to shared descriptors (SteveC Dec 10 2008):</span>
<span class="cm"> *</span>
<span class="cm"> * ---------------                     ---------------</span>
<span class="cm"> * | JobDesc #1  |--------------------&gt;|  ShareDesc  |</span>
<span class="cm"> * | *(packet 1) |                     |   (PDB)     |</span>
<span class="cm"> * ---------------      |-------------&gt;|  (hashKey)  |</span>
<span class="cm"> *       .              |              | (cipherKey) |</span>
<span class="cm"> *       .              |    |--------&gt;| (operation) |</span>
<span class="cm"> * ---------------      |    |         ---------------</span>
<span class="cm"> * | JobDesc #2  |------|    |</span>
<span class="cm"> * | *(packet 2) |           |</span>
<span class="cm"> * ---------------           |</span>
<span class="cm"> *       .                   |</span>
<span class="cm"> *       .                   |</span>
<span class="cm"> * ---------------           |</span>
<span class="cm"> * | JobDesc #3  |------------</span>
<span class="cm"> * | *(packet 3) |</span>
<span class="cm"> * ---------------</span>
<span class="cm"> *</span>
<span class="cm"> * The SharedDesc never changes for a connection unless rekeyed, but</span>
<span class="cm"> * each packet will likely be in a different place. So all we need</span>
<span class="cm"> * to know to process the packet is where the input is, where the</span>
<span class="cm"> * output goes, and what context we want to process with. Context is</span>
<span class="cm"> * in the SharedDesc, packet references in the JobDesc.</span>
<span class="cm"> *</span>
<span class="cm"> * So, a job desc looks like:</span>
<span class="cm"> *</span>
<span class="cm"> * ---------------------</span>
<span class="cm"> * | Header            |</span>
<span class="cm"> * | ShareDesc Pointer |</span>
<span class="cm"> * | SEQ_OUT_PTR       |</span>
<span class="cm"> * | (output buffer)   |</span>
<span class="cm"> * | SEQ_IN_PTR        |</span>
<span class="cm"> * | (input buffer)    |</span>
<span class="cm"> * | LOAD (to DECO)    |</span>
<span class="cm"> * ---------------------</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;compat.h&quot;</span>

<span class="cp">#include &quot;regs.h&quot;</span>
<span class="cp">#include &quot;intern.h&quot;</span>
<span class="cp">#include &quot;desc_constr.h&quot;</span>
<span class="cp">#include &quot;jr.h&quot;</span>
<span class="cp">#include &quot;error.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * crypto alg</span>
<span class="cm"> */</span>
<span class="cp">#define CAAM_CRA_PRIORITY		3000</span>
<span class="cm">/* max key is sum of AES_MAX_KEY_SIZE, max split key size */</span>
<span class="cp">#define CAAM_MAX_KEY_SIZE		(AES_MAX_KEY_SIZE + \</span>
<span class="cp">					 SHA512_DIGEST_SIZE * 2)</span>
<span class="cm">/* max IV is max of AES_BLOCK_SIZE, DES3_EDE_BLOCK_SIZE */</span>
<span class="cp">#define CAAM_MAX_IV_LENGTH		16</span>

<span class="cm">/* length of descriptors text */</span>
<span class="cp">#define DESC_JOB_IO_LEN			(CAAM_CMD_SZ * 3 + CAAM_PTR_SZ * 3)</span>

<span class="cp">#define DESC_AEAD_BASE			(4 * CAAM_CMD_SZ)</span>
<span class="cp">#define DESC_AEAD_ENC_LEN		(DESC_AEAD_BASE + 16 * CAAM_CMD_SZ)</span>
<span class="cp">#define DESC_AEAD_DEC_LEN		(DESC_AEAD_BASE + 21 * CAAM_CMD_SZ)</span>
<span class="cp">#define DESC_AEAD_GIVENC_LEN		(DESC_AEAD_ENC_LEN + 7 * CAAM_CMD_SZ)</span>

<span class="cp">#define DESC_ABLKCIPHER_BASE		(3 * CAAM_CMD_SZ)</span>
<span class="cp">#define DESC_ABLKCIPHER_ENC_LEN		(DESC_ABLKCIPHER_BASE + \</span>
<span class="cp">					 20 * CAAM_CMD_SZ)</span>
<span class="cp">#define DESC_ABLKCIPHER_DEC_LEN		(DESC_ABLKCIPHER_BASE + \</span>
<span class="cp">					 15 * CAAM_CMD_SZ)</span>

<span class="cp">#define DESC_MAX_USED_BYTES		(DESC_AEAD_GIVENC_LEN + \</span>
<span class="cp">					 CAAM_MAX_KEY_SIZE)</span>
<span class="cp">#define DESC_MAX_USED_LEN		(DESC_MAX_USED_BYTES / CAAM_CMD_SZ)</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cm">/* for print_hex_dumps with line references */</span>
<span class="cp">#define xstr(s) str(s)</span>
<span class="cp">#define str(s) #s</span>
<span class="cp">#define debug(format, arg...) printk(format, arg)</span>
<span class="cp">#else</span>
<span class="cp">#define debug(format, arg...)</span>
<span class="cp">#endif</span>

<span class="cm">/* Set DK bit in class 1 operation if shared */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">append_dec_op1</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">jump_cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">uncond_jump_cmd</span><span class="p">;</span>

	<span class="n">jump_cmd</span> <span class="o">=</span> <span class="n">append_jump</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">JUMP_TEST_ALL</span> <span class="o">|</span> <span class="n">JUMP_COND_SHRD</span><span class="p">);</span>
	<span class="n">append_operation</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">type</span> <span class="o">|</span> <span class="n">OP_ALG_AS_INITFINAL</span> <span class="o">|</span>
			 <span class="n">OP_ALG_DECRYPT</span><span class="p">);</span>
	<span class="n">uncond_jump_cmd</span> <span class="o">=</span> <span class="n">append_jump</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">JUMP_TEST_ALL</span><span class="p">);</span>
	<span class="n">set_jump_tgt_here</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">jump_cmd</span><span class="p">);</span>
	<span class="n">append_operation</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">type</span> <span class="o">|</span> <span class="n">OP_ALG_AS_INITFINAL</span> <span class="o">|</span>
			 <span class="n">OP_ALG_DECRYPT</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_DK</span><span class="p">);</span>
	<span class="n">set_jump_tgt_here</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">uncond_jump_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wait for completion of class 1 key loading before allowing</span>
<span class="cm"> * error propagation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">append_dec_shr_done</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">jump_cmd</span><span class="p">;</span>

	<span class="n">jump_cmd</span> <span class="o">=</span> <span class="n">append_jump</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">JUMP_CLASS_CLASS1</span> <span class="o">|</span> <span class="n">JUMP_TEST_ALL</span><span class="p">);</span>
	<span class="n">set_jump_tgt_here</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">jump_cmd</span><span class="p">);</span>
	<span class="n">append_cmd</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">SET_OK_NO_PROP_ERRORS</span> <span class="o">|</span> <span class="n">CMD_LOAD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * For aead functions, read payload and write payload,</span>
<span class="cm"> * both of which are specified in req-&gt;src and req-&gt;dst</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">aead_append_src_dst</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">msg_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">append_seq_fifo_load</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FIFOLD_CLASS_BOTH</span> <span class="o">|</span>
			     <span class="n">KEY_VLF</span> <span class="o">|</span> <span class="n">msg_type</span> <span class="o">|</span> <span class="n">FIFOLD_TYPE_LASTBOTH</span><span class="p">);</span>
	<span class="n">append_seq_fifo_store</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FIFOST_TYPE_MESSAGE_DATA</span> <span class="o">|</span> <span class="n">KEY_VLF</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * For aead encrypt and decrypt, read iv for both classes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">aead_append_ld_iv</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ivsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">append_cmd</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">CMD_SEQ_LOAD</span> <span class="o">|</span> <span class="n">LDST_SRCDST_BYTE_CONTEXT</span> <span class="o">|</span>
		   <span class="n">LDST_CLASS_1_CCB</span> <span class="o">|</span> <span class="n">ivsize</span><span class="p">);</span>
	<span class="n">append_move</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">MOVE_SRC_CLASS1CTX</span> <span class="o">|</span> <span class="n">MOVE_DEST_CLASS2INFIFO</span> <span class="o">|</span> <span class="n">ivsize</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * For ablkcipher encrypt and decrypt, read from req-&gt;src and</span>
<span class="cm"> * write to req-&gt;dst</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ablkcipher_append_src_dst</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">append_math_add</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">VARSEQOUTLEN</span><span class="p">,</span> <span class="n">SEQINLEN</span><span class="p">,</span> <span class="n">REG0</span><span class="p">,</span> <span class="n">CAAM_CMD_SZ</span><span class="p">);</span> \
	<span class="n">append_math_add</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">VARSEQINLEN</span><span class="p">,</span> <span class="n">SEQINLEN</span><span class="p">,</span> <span class="n">REG0</span><span class="p">,</span> <span class="n">CAAM_CMD_SZ</span><span class="p">);</span> \
	<span class="n">append_seq_fifo_load</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FIFOLD_CLASS_CLASS1</span> <span class="o">|</span> \
			     <span class="n">KEY_VLF</span> <span class="o">|</span> <span class="n">FIFOLD_TYPE_MSG</span> <span class="o">|</span> <span class="n">FIFOLD_TYPE_LAST1</span><span class="p">);</span> \
	<span class="n">append_seq_fifo_store</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FIFOST_TYPE_MESSAGE_DATA</span> <span class="o">|</span> <span class="n">KEY_VLF</span><span class="p">);</span> \
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If all data, including src (with assoc and iv) or dst (with iv only) are</span>
<span class="cm"> * contiguous</span>
<span class="cm"> */</span>
<span class="cp">#define GIV_SRC_CONTIG		1</span>
<span class="cp">#define GIV_DST_CONTIG		(1 &lt;&lt; 1)</span>

<span class="cm">/*</span>
<span class="cm"> * per-session context</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">caam_ctx</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">jrdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sh_desc_enc</span><span class="p">[</span><span class="n">DESC_MAX_USED_LEN</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">sh_desc_dec</span><span class="p">[</span><span class="n">DESC_MAX_USED_LEN</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">sh_desc_givenc</span><span class="p">[</span><span class="n">DESC_MAX_USED_LEN</span><span class="p">];</span>
	<span class="n">dma_addr_t</span> <span class="n">sh_desc_enc_dma</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">sh_desc_dec_dma</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">sh_desc_givenc_dma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">class1_alg_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">class2_alg_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">alg_op</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">key</span><span class="p">[</span><span class="n">CAAM_MAX_KEY_SIZE</span><span class="p">];</span>
	<span class="n">dma_addr_t</span> <span class="n">key_dma</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enckeylen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">split_key_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">split_key_pad_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">authsize</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">append_key_aead</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">keys_fit_inline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">keys_fit_inline</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">append_key_as_imm</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_pad_len</span><span class="p">,</span>
				  <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_len</span><span class="p">,</span> <span class="n">CLASS_2</span> <span class="o">|</span>
				  <span class="n">KEY_DEST_MDHA_SPLIT</span> <span class="o">|</span> <span class="n">KEY_ENC</span><span class="p">);</span>
		<span class="n">append_key_as_imm</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+</span>
				  <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_pad_len</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enckeylen</span><span class="p">,</span>
				  <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enckeylen</span><span class="p">,</span> <span class="n">CLASS_1</span> <span class="o">|</span> <span class="n">KEY_DEST_CLASS_REG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">append_key</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key_dma</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_len</span><span class="p">,</span> <span class="n">CLASS_2</span> <span class="o">|</span>
			   <span class="n">KEY_DEST_MDHA_SPLIT</span> <span class="o">|</span> <span class="n">KEY_ENC</span><span class="p">);</span>
		<span class="n">append_key</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key_dma</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_pad_len</span><span class="p">,</span>
			   <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enckeylen</span><span class="p">,</span> <span class="n">CLASS_1</span> <span class="o">|</span> <span class="n">KEY_DEST_CLASS_REG</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_sh_desc_key_aead</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">keys_fit_inline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">key_jump_cmd</span><span class="p">;</span>

	<span class="n">init_sh_desc</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">HDR_SHARE_WAIT</span><span class="p">);</span>

	<span class="cm">/* Skip if already shared */</span>
	<span class="n">key_jump_cmd</span> <span class="o">=</span> <span class="n">append_jump</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">JUMP_JSL</span> <span class="o">|</span> <span class="n">JUMP_TEST_ALL</span> <span class="o">|</span>
				   <span class="n">JUMP_COND_SHRD</span><span class="p">);</span>

	<span class="n">append_key_aead</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">keys_fit_inline</span><span class="p">);</span>

	<span class="n">set_jump_tgt_here</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">key_jump_cmd</span><span class="p">);</span>

	<span class="cm">/* Propagate errors from shared to job descriptor */</span>
	<span class="n">append_cmd</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">SET_OK_NO_PROP_ERRORS</span> <span class="o">|</span> <span class="n">CMD_LOAD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aead_set_sh_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">aead</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aead_tfm</span> <span class="o">*</span><span class="n">tfm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aead</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">crt_aead</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_aead_ctx</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">jrdev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">jrdev</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">keys_fit_inline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">key_jump_cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">jump_cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">geniv</span><span class="p">,</span> <span class="n">moveiv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enckeylen</span> <span class="o">||</span> <span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">authsize</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Job Descriptor and Shared Descriptors</span>
<span class="cm">	 * must all fit into the 64-word Descriptor h/w Buffer</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DESC_AEAD_ENC_LEN</span> <span class="o">+</span> <span class="n">DESC_JOB_IO_LEN</span> <span class="o">+</span>
	    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_pad_len</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enckeylen</span> <span class="o">&lt;=</span>
	    <span class="n">CAAM_DESC_BYTES_MAX</span><span class="p">)</span>
		<span class="n">keys_fit_inline</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* aead_encrypt shared descriptor */</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_enc</span><span class="p">;</span>

	<span class="n">init_sh_desc_key_aead</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">keys_fit_inline</span><span class="p">);</span>

	<span class="cm">/* Class 2 operation */</span>
	<span class="n">append_operation</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">class2_alg_type</span> <span class="o">|</span>
			 <span class="n">OP_ALG_AS_INITFINAL</span> <span class="o">|</span> <span class="n">OP_ALG_ENCRYPT</span><span class="p">);</span>

	<span class="cm">/* cryptlen = seqoutlen - authsize */</span>
	<span class="n">append_math_sub_imm_u32</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">REG3</span><span class="p">,</span> <span class="n">SEQOUTLEN</span><span class="p">,</span> <span class="n">IMM</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">authsize</span><span class="p">);</span>

	<span class="cm">/* assoclen + cryptlen = seqinlen - ivsize */</span>
	<span class="n">append_math_sub_imm_u32</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">REG2</span><span class="p">,</span> <span class="n">SEQINLEN</span><span class="p">,</span> <span class="n">IMM</span><span class="p">,</span> <span class="n">tfm</span><span class="o">-&gt;</span><span class="n">ivsize</span><span class="p">);</span>

	<span class="cm">/* assoclen + cryptlen = (assoclen + cryptlen) - cryptlen */</span>
	<span class="n">append_math_sub</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">VARSEQINLEN</span><span class="p">,</span> <span class="n">REG2</span><span class="p">,</span> <span class="n">REG3</span><span class="p">,</span> <span class="n">CAAM_CMD_SZ</span><span class="p">);</span>

	<span class="cm">/* read assoc before reading payload */</span>
	<span class="n">append_seq_fifo_load</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FIFOLD_CLASS_CLASS2</span> <span class="o">|</span> <span class="n">FIFOLD_TYPE_MSG</span> <span class="o">|</span>
			     <span class="n">KEY_VLF</span><span class="p">);</span>
	<span class="n">aead_append_ld_iv</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">tfm</span><span class="o">-&gt;</span><span class="n">ivsize</span><span class="p">);</span>

	<span class="cm">/* Class 1 operation */</span>
	<span class="n">append_operation</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">class1_alg_type</span> <span class="o">|</span>
			 <span class="n">OP_ALG_AS_INITFINAL</span> <span class="o">|</span> <span class="n">OP_ALG_ENCRYPT</span><span class="p">);</span>

	<span class="cm">/* Read and write cryptlen bytes */</span>
	<span class="n">append_math_add</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">VARSEQINLEN</span><span class="p">,</span> <span class="n">ZERO</span><span class="p">,</span> <span class="n">REG3</span><span class="p">,</span> <span class="n">CAAM_CMD_SZ</span><span class="p">);</span>
	<span class="n">append_math_add</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">VARSEQOUTLEN</span><span class="p">,</span> <span class="n">ZERO</span><span class="p">,</span> <span class="n">REG3</span><span class="p">,</span> <span class="n">CAAM_CMD_SZ</span><span class="p">);</span>
	<span class="n">aead_append_src_dst</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">FIFOLD_TYPE_MSG1OUT2</span><span class="p">);</span>

	<span class="cm">/* Write ICV */</span>
	<span class="n">append_seq_store</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">authsize</span><span class="p">,</span> <span class="n">LDST_CLASS_2_CCB</span> <span class="o">|</span>
			 <span class="n">LDST_SRCDST_BYTE_CONTEXT</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_enc_dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span>
					      <span class="n">desc_bytes</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span>
					      <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_enc_dma</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;unable to map shared descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;aead enc shdesc@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span>
		       <span class="n">desc_bytes</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Job Descriptor and Shared Descriptors</span>
<span class="cm">	 * must all fit into the 64-word Descriptor h/w Buffer</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DESC_AEAD_DEC_LEN</span> <span class="o">+</span> <span class="n">DESC_JOB_IO_LEN</span> <span class="o">+</span>
	    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_pad_len</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enckeylen</span> <span class="o">&lt;=</span>
	    <span class="n">CAAM_DESC_BYTES_MAX</span><span class="p">)</span>
		<span class="n">keys_fit_inline</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_dec</span><span class="p">;</span>

	<span class="cm">/* aead_decrypt shared descriptor */</span>
	<span class="n">init_sh_desc</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">HDR_SHARE_WAIT</span><span class="p">);</span>

	<span class="cm">/* Skip if already shared */</span>
	<span class="n">key_jump_cmd</span> <span class="o">=</span> <span class="n">append_jump</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">JUMP_JSL</span> <span class="o">|</span> <span class="n">JUMP_TEST_ALL</span> <span class="o">|</span>
				   <span class="n">JUMP_COND_SHRD</span><span class="p">);</span>

	<span class="n">append_key_aead</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">keys_fit_inline</span><span class="p">);</span>

	<span class="cm">/* Only propagate error immediately if shared */</span>
	<span class="n">jump_cmd</span> <span class="o">=</span> <span class="n">append_jump</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">JUMP_TEST_ALL</span><span class="p">);</span>
	<span class="n">set_jump_tgt_here</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">key_jump_cmd</span><span class="p">);</span>
	<span class="n">append_cmd</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">SET_OK_NO_PROP_ERRORS</span> <span class="o">|</span> <span class="n">CMD_LOAD</span><span class="p">);</span>
	<span class="n">set_jump_tgt_here</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">jump_cmd</span><span class="p">);</span>

	<span class="cm">/* Class 2 operation */</span>
	<span class="n">append_operation</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">class2_alg_type</span> <span class="o">|</span>
			 <span class="n">OP_ALG_AS_INITFINAL</span> <span class="o">|</span> <span class="n">OP_ALG_DECRYPT</span> <span class="o">|</span> <span class="n">OP_ALG_ICV_ON</span><span class="p">);</span>

	<span class="cm">/* assoclen + cryptlen = seqinlen - ivsize */</span>
	<span class="n">append_math_sub_imm_u32</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">REG3</span><span class="p">,</span> <span class="n">SEQINLEN</span><span class="p">,</span> <span class="n">IMM</span><span class="p">,</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">authsize</span> <span class="o">+</span> <span class="n">tfm</span><span class="o">-&gt;</span><span class="n">ivsize</span><span class="p">)</span>
	<span class="cm">/* assoclen = (assoclen + cryptlen) - cryptlen */</span>
	<span class="n">append_math_sub</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">REG2</span><span class="p">,</span> <span class="n">SEQOUTLEN</span><span class="p">,</span> <span class="n">REG0</span><span class="p">,</span> <span class="n">CAAM_CMD_SZ</span><span class="p">);</span>
	<span class="n">append_math_sub</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">VARSEQINLEN</span><span class="p">,</span> <span class="n">REG3</span><span class="p">,</span> <span class="n">REG2</span><span class="p">,</span> <span class="n">CAAM_CMD_SZ</span><span class="p">);</span>

	<span class="cm">/* read assoc before reading payload */</span>
	<span class="n">append_seq_fifo_load</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FIFOLD_CLASS_CLASS2</span> <span class="o">|</span> <span class="n">FIFOLD_TYPE_MSG</span> <span class="o">|</span>
			     <span class="n">KEY_VLF</span><span class="p">);</span>

	<span class="n">aead_append_ld_iv</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">tfm</span><span class="o">-&gt;</span><span class="n">ivsize</span><span class="p">);</span>

	<span class="n">append_dec_op1</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">class1_alg_type</span><span class="p">);</span>

	<span class="cm">/* Read and write cryptlen bytes */</span>
	<span class="n">append_math_add</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">VARSEQINLEN</span><span class="p">,</span> <span class="n">ZERO</span><span class="p">,</span> <span class="n">REG2</span><span class="p">,</span> <span class="n">CAAM_CMD_SZ</span><span class="p">);</span>
	<span class="n">append_math_add</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">VARSEQOUTLEN</span><span class="p">,</span> <span class="n">ZERO</span><span class="p">,</span> <span class="n">REG2</span><span class="p">,</span> <span class="n">CAAM_CMD_SZ</span><span class="p">);</span>
	<span class="n">aead_append_src_dst</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">FIFOLD_TYPE_MSG</span><span class="p">);</span>

	<span class="cm">/* Load ICV */</span>
	<span class="n">append_seq_fifo_load</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">authsize</span><span class="p">,</span> <span class="n">FIFOLD_CLASS_CLASS2</span> <span class="o">|</span>
			     <span class="n">FIFOLD_TYPE_LAST2</span> <span class="o">|</span> <span class="n">FIFOLD_TYPE_ICV</span><span class="p">);</span>
	<span class="n">append_dec_shr_done</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_dec_dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span>
					      <span class="n">desc_bytes</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span>
					      <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_dec_dma</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;unable to map shared descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;aead dec shdesc@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span>
		       <span class="n">desc_bytes</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Job Descriptor and Shared Descriptors</span>
<span class="cm">	 * must all fit into the 64-word Descriptor h/w Buffer</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DESC_AEAD_GIVENC_LEN</span> <span class="o">+</span> <span class="n">DESC_JOB_IO_LEN</span> <span class="o">+</span>
	    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_pad_len</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enckeylen</span> <span class="o">&lt;=</span>
	    <span class="n">CAAM_DESC_BYTES_MAX</span><span class="p">)</span>
		<span class="n">keys_fit_inline</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* aead_givencrypt shared descriptor */</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_givenc</span><span class="p">;</span>

	<span class="n">init_sh_desc_key_aead</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">keys_fit_inline</span><span class="p">);</span>

	<span class="cm">/* Generate IV */</span>
	<span class="n">geniv</span> <span class="o">=</span> <span class="n">NFIFOENTRY_STYPE_PAD</span> <span class="o">|</span> <span class="n">NFIFOENTRY_DEST_DECO</span> <span class="o">|</span>
		<span class="n">NFIFOENTRY_DTYPE_MSG</span> <span class="o">|</span> <span class="n">NFIFOENTRY_LC1</span> <span class="o">|</span>
		<span class="n">NFIFOENTRY_PTYPE_RND</span> <span class="o">|</span> <span class="p">(</span><span class="n">tfm</span><span class="o">-&gt;</span><span class="n">ivsize</span> <span class="o">&lt;&lt;</span> <span class="n">NFIFOENTRY_DLEN_SHIFT</span><span class="p">);</span>
	<span class="n">append_load_imm_u32</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">geniv</span><span class="p">,</span> <span class="n">LDST_CLASS_IND_CCB</span> <span class="o">|</span>
			    <span class="n">LDST_SRCDST_WORD_INFO_FIFO</span> <span class="o">|</span> <span class="n">LDST_IMM</span><span class="p">);</span>
	<span class="n">append_cmd</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">CMD_LOAD</span> <span class="o">|</span> <span class="n">DISABLE_AUTO_INFO_FIFO</span><span class="p">);</span>
	<span class="n">append_move</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">MOVE_SRC_INFIFO</span> <span class="o">|</span>
		    <span class="n">MOVE_DEST_CLASS1CTX</span> <span class="o">|</span> <span class="p">(</span><span class="n">tfm</span><span class="o">-&gt;</span><span class="n">ivsize</span> <span class="o">&lt;&lt;</span> <span class="n">MOVE_LEN_SHIFT</span><span class="p">));</span>
	<span class="n">append_cmd</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">CMD_LOAD</span> <span class="o">|</span> <span class="n">ENABLE_AUTO_INFO_FIFO</span><span class="p">);</span>

	<span class="cm">/* Copy IV to class 1 context */</span>
	<span class="n">append_move</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">MOVE_SRC_CLASS1CTX</span> <span class="o">|</span>
		    <span class="n">MOVE_DEST_OUTFIFO</span> <span class="o">|</span> <span class="p">(</span><span class="n">tfm</span><span class="o">-&gt;</span><span class="n">ivsize</span> <span class="o">&lt;&lt;</span> <span class="n">MOVE_LEN_SHIFT</span><span class="p">));</span>

	<span class="cm">/* Return to encryption */</span>
	<span class="n">append_operation</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">class2_alg_type</span> <span class="o">|</span>
			 <span class="n">OP_ALG_AS_INITFINAL</span> <span class="o">|</span> <span class="n">OP_ALG_ENCRYPT</span><span class="p">);</span>

	<span class="cm">/* ivsize + cryptlen = seqoutlen - authsize */</span>
	<span class="n">append_math_sub_imm_u32</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">REG3</span><span class="p">,</span> <span class="n">SEQOUTLEN</span><span class="p">,</span> <span class="n">IMM</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">authsize</span><span class="p">);</span>

	<span class="cm">/* assoclen = seqinlen - (ivsize + cryptlen) */</span>
	<span class="n">append_math_sub</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">VARSEQINLEN</span><span class="p">,</span> <span class="n">SEQINLEN</span><span class="p">,</span> <span class="n">REG3</span><span class="p">,</span> <span class="n">CAAM_CMD_SZ</span><span class="p">);</span>

	<span class="cm">/* read assoc before reading payload */</span>
	<span class="n">append_seq_fifo_load</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FIFOLD_CLASS_CLASS2</span> <span class="o">|</span> <span class="n">FIFOLD_TYPE_MSG</span> <span class="o">|</span>
			     <span class="n">KEY_VLF</span><span class="p">);</span>

	<span class="cm">/* Copy iv from class 1 ctx to class 2 fifo*/</span>
	<span class="n">moveiv</span> <span class="o">=</span> <span class="n">NFIFOENTRY_STYPE_OFIFO</span> <span class="o">|</span> <span class="n">NFIFOENTRY_DEST_CLASS2</span> <span class="o">|</span>
		 <span class="n">NFIFOENTRY_DTYPE_MSG</span> <span class="o">|</span> <span class="p">(</span><span class="n">tfm</span><span class="o">-&gt;</span><span class="n">ivsize</span> <span class="o">&lt;&lt;</span> <span class="n">NFIFOENTRY_DLEN_SHIFT</span><span class="p">);</span>
	<span class="n">append_load_imm_u32</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">moveiv</span><span class="p">,</span> <span class="n">LDST_CLASS_IND_CCB</span> <span class="o">|</span>
			    <span class="n">LDST_SRCDST_WORD_INFO_FIFO</span> <span class="o">|</span> <span class="n">LDST_IMM</span><span class="p">);</span>
	<span class="n">append_load_imm_u32</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">tfm</span><span class="o">-&gt;</span><span class="n">ivsize</span><span class="p">,</span> <span class="n">LDST_CLASS_2_CCB</span> <span class="o">|</span>
			    <span class="n">LDST_SRCDST_WORD_DATASZ_REG</span> <span class="o">|</span> <span class="n">LDST_IMM</span><span class="p">);</span>

	<span class="cm">/* Class 1 operation */</span>
	<span class="n">append_operation</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">class1_alg_type</span> <span class="o">|</span>
			 <span class="n">OP_ALG_AS_INITFINAL</span> <span class="o">|</span> <span class="n">OP_ALG_ENCRYPT</span><span class="p">);</span>

	<span class="cm">/* Will write ivsize + cryptlen */</span>
	<span class="n">append_math_add</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">VARSEQOUTLEN</span><span class="p">,</span> <span class="n">SEQINLEN</span><span class="p">,</span> <span class="n">REG0</span><span class="p">,</span> <span class="n">CAAM_CMD_SZ</span><span class="p">);</span>

	<span class="cm">/* Not need to reload iv */</span>
	<span class="n">append_seq_fifo_load</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">tfm</span><span class="o">-&gt;</span><span class="n">ivsize</span><span class="p">,</span>
			     <span class="n">FIFOLD_CLASS_SKIP</span><span class="p">);</span>

	<span class="cm">/* Will read cryptlen */</span>
	<span class="n">append_math_add</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">VARSEQINLEN</span><span class="p">,</span> <span class="n">SEQINLEN</span><span class="p">,</span> <span class="n">REG0</span><span class="p">,</span> <span class="n">CAAM_CMD_SZ</span><span class="p">);</span>
	<span class="n">aead_append_src_dst</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">FIFOLD_TYPE_MSG1OUT2</span><span class="p">);</span>

	<span class="cm">/* Write ICV */</span>
	<span class="n">append_seq_store</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">authsize</span><span class="p">,</span> <span class="n">LDST_CLASS_2_CCB</span> <span class="o">|</span>
			 <span class="n">LDST_SRCDST_BYTE_CONTEXT</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_givenc_dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span>
						 <span class="n">desc_bytes</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span>
						 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_givenc_dma</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;unable to map shared descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;aead givenc shdesc@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span>
		       <span class="n">desc_bytes</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aead_setauthsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">authenc</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">authsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_aead_ctx</span><span class="p">(</span><span class="n">authenc</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">authsize</span> <span class="o">=</span> <span class="n">authsize</span><span class="p">;</span>
	<span class="n">aead_set_sh_desc</span><span class="p">(</span><span class="n">authenc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">split_key_result</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">completion</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">split_key_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">err</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">split_key_result</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s %d: err 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="n">CAAM_ERROR_STR_MAX</span><span class="p">];</span>

		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%08x: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">caam_jr_strstatus</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">err</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">res</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">get a split ipad/opad key</span>

<span class="cm">Split key generation-----------------------------------------------</span>

<span class="cm">[00] 0xb0810008    jobdesc: stidx=1 share=never len=8</span>
<span class="cm">[01] 0x04000014        key: class2-&gt;keyreg len=20</span>
<span class="cm">			@0xffe01000</span>
<span class="cm">[03] 0x84410014  operation: cls2-op sha1 hmac init dec</span>
<span class="cm">[04] 0x24940000     fifold: class2 msgdata-last2 len=0 imm</span>
<span class="cm">[05] 0xa4000001       jump: class2 local all -&gt;1 [06]</span>
<span class="cm">[06] 0x64260028    fifostr: class2 mdsplit-jdk len=40</span>
<span class="cm">			@0xffe04000</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">gen_split_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key_in</span><span class="p">,</span> <span class="n">u32</span> <span class="n">authkeylen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">jrdev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">jrdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">split_key_result</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr_in</span><span class="p">,</span> <span class="n">dma_addr_out</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">CAAM_CMD_SZ</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">CAAM_PTR_SZ</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>

	<span class="n">init_job_desc</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dma_addr_in</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">key_in</span><span class="p">,</span> <span class="n">authkeylen</span><span class="p">,</span>
				     <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">dma_addr_in</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;unable to map key input memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">append_key</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">dma_addr_in</span><span class="p">,</span> <span class="n">authkeylen</span><span class="p">,</span> <span class="n">CLASS_2</span> <span class="o">|</span>
		       <span class="n">KEY_DEST_CLASS_REG</span><span class="p">);</span>

	<span class="cm">/* Sets MDHA up into an HMAC-INIT */</span>
	<span class="n">append_operation</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">alg_op</span> <span class="o">|</span> <span class="n">OP_ALG_DECRYPT</span> <span class="o">|</span>
			     <span class="n">OP_ALG_AS_INIT</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * do a FIFO_LOAD of zero, this will trigger the internal key expansion</span>
<span class="cm">	   into both pads inside MDHA</span>
<span class="cm">	 */</span>
	<span class="n">append_fifo_load_as_imm</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LDST_CLASS_2_CCB</span> <span class="o">|</span>
				<span class="n">FIFOLD_TYPE_MSG</span> <span class="o">|</span> <span class="n">FIFOLD_TYPE_LAST2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIFO_STORE with the explicit split-key content store</span>
<span class="cm">	 * (0x26 output type)</span>
<span class="cm">	 */</span>
	<span class="n">dma_addr_out</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_pad_len</span><span class="p">,</span>
				      <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">dma_addr_out</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;unable to map key output memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">append_fifo_store</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">dma_addr_out</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_len</span><span class="p">,</span>
			  <span class="n">LDST_CLASS_2_CCB</span> <span class="o">|</span> <span class="n">FIFOST_TYPE_SPLIT_KEK</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;ctx.key@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">key_in</span><span class="p">,</span> <span class="n">authkeylen</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;jobdesc@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">desc_bytes</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">result</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">.</span><span class="n">completion</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">caam_jr_enqueue</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">split_key_done</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* in progress */</span>
		<span class="n">wait_for_completion_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">.</span><span class="n">completion</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">err</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;ctx.key@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
			       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
			       <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_pad_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">dma_addr_out</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_pad_len</span><span class="p">,</span>
			 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">dma_addr_in</span><span class="p">,</span> <span class="n">authkeylen</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aead_setkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">aead</span><span class="p">,</span>
			       <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keylen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Sizes for MDHA pads (*not* keys): MD5, SHA1, 224, 256, 384, 512 */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">mdpadlen</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_aead_ctx</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">jrdev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">jrdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtattr</span> <span class="o">*</span><span class="n">rta</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_authenc_key_param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">authkeylen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enckeylen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">param</span> <span class="o">=</span> <span class="n">RTA_DATA</span><span class="p">(</span><span class="n">rta</span><span class="p">);</span>
	<span class="n">enckeylen</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">enckeylen</span><span class="p">);</span>

	<span class="n">key</span> <span class="o">+=</span> <span class="n">RTA_ALIGN</span><span class="p">(</span><span class="n">rta</span><span class="o">-&gt;</span><span class="n">rta_len</span><span class="p">);</span>
	<span class="n">keylen</span> <span class="o">-=</span> <span class="n">RTA_ALIGN</span><span class="p">(</span><span class="n">rta</span><span class="o">-&gt;</span><span class="n">rta_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">keylen</span> <span class="o">&lt;</span> <span class="n">enckeylen</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">badkey</span><span class="p">;</span>

	<span class="n">authkeylen</span> <span class="o">=</span> <span class="n">keylen</span> <span class="o">-</span> <span class="n">enckeylen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">keylen</span> <span class="o">&gt;</span> <span class="n">CAAM_MAX_KEY_SIZE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">badkey</span><span class="p">;</span>

	<span class="cm">/* Pick class 2 key length from algorithm submask */</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_len</span> <span class="o">=</span> <span class="n">mdpadlen</span><span class="p">[(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">alg_op</span> <span class="o">&amp;</span> <span class="n">OP_ALG_ALGSEL_SUBMASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				      <span class="n">OP_ALG_ALGSEL_SHIFT</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_pad_len</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_len</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;keylen %d enckeylen %d authkeylen %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">keylen</span><span class="p">,</span> <span class="n">enckeylen</span><span class="p">,</span> <span class="n">authkeylen</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;split_key_len %d split_key_pad_len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_len</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_pad_len</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;key in @&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">keylen</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gen_split_key</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">authkeylen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">badkey</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* postpend encryption key to auth split key */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_pad_len</span><span class="p">,</span> <span class="n">key</span> <span class="o">+</span> <span class="n">authkeylen</span><span class="p">,</span> <span class="n">enckeylen</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key_dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_pad_len</span> <span class="o">+</span>
				       <span class="n">enckeylen</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key_dma</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;unable to map key i/o memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;ctx.key@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
		       <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_pad_len</span> <span class="o">+</span> <span class="n">enckeylen</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enckeylen</span> <span class="o">=</span> <span class="n">enckeylen</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">aead_set_sh_desc</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key_dma</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">split_key_pad_len</span> <span class="o">+</span>
				 <span class="n">enckeylen</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="nl">badkey:</span>
	<span class="n">crypto_aead_set_flags</span><span class="p">(</span><span class="n">aead</span><span class="p">,</span> <span class="n">CRYPTO_TFM_RES_BAD_KEY_LEN</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ablkcipher_setkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_ablkcipher</span> <span class="o">*</span><span class="n">ablkcipher</span><span class="p">,</span>
			     <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keylen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_ctx</span><span class="p">(</span><span class="n">ablkcipher</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ablkcipher_tfm</span> <span class="o">*</span><span class="n">tfm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ablkcipher</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">crt_ablkcipher</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">jrdev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">jrdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">key_jump_cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">jump_cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;key in @&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">keylen</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">keylen</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key_dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">keylen</span><span class="p">,</span>
				      <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key_dma</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;unable to map key i/o memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enckeylen</span> <span class="o">=</span> <span class="n">keylen</span><span class="p">;</span>

	<span class="cm">/* ablkcipher_encrypt shared descriptor */</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_enc</span><span class="p">;</span>
	<span class="n">init_sh_desc</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">HDR_SHARE_WAIT</span><span class="p">);</span>
	<span class="cm">/* Skip if already shared */</span>
	<span class="n">key_jump_cmd</span> <span class="o">=</span> <span class="n">append_jump</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">JUMP_JSL</span> <span class="o">|</span> <span class="n">JUMP_TEST_ALL</span> <span class="o">|</span>
				   <span class="n">JUMP_COND_SHRD</span><span class="p">);</span>

	<span class="cm">/* Load class1 key only */</span>
	<span class="n">append_key_as_imm</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enckeylen</span><span class="p">,</span>
			  <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enckeylen</span><span class="p">,</span> <span class="n">CLASS_1</span> <span class="o">|</span>
			  <span class="n">KEY_DEST_CLASS_REG</span><span class="p">);</span>

	<span class="n">set_jump_tgt_here</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">key_jump_cmd</span><span class="p">);</span>

	<span class="cm">/* Propagate errors from shared to job descriptor */</span>
	<span class="n">append_cmd</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">SET_OK_NO_PROP_ERRORS</span> <span class="o">|</span> <span class="n">CMD_LOAD</span><span class="p">);</span>

	<span class="cm">/* Load iv */</span>
	<span class="n">append_cmd</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">CMD_SEQ_LOAD</span> <span class="o">|</span> <span class="n">LDST_SRCDST_BYTE_CONTEXT</span> <span class="o">|</span>
		   <span class="n">LDST_CLASS_1_CCB</span> <span class="o">|</span> <span class="n">tfm</span><span class="o">-&gt;</span><span class="n">ivsize</span><span class="p">);</span>

	<span class="cm">/* Load operation */</span>
	<span class="n">append_operation</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">class1_alg_type</span> <span class="o">|</span>
			 <span class="n">OP_ALG_AS_INITFINAL</span> <span class="o">|</span> <span class="n">OP_ALG_ENCRYPT</span><span class="p">);</span>

	<span class="cm">/* Perform operation */</span>
	<span class="n">ablkcipher_append_src_dst</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_enc_dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span>
					      <span class="n">desc_bytes</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span>
					      <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_enc_dma</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;unable to map shared descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;ablkcipher enc shdesc@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span>
		       <span class="n">desc_bytes</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* ablkcipher_decrypt shared descriptor */</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_dec</span><span class="p">;</span>

	<span class="n">init_sh_desc</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">HDR_SHARE_WAIT</span><span class="p">);</span>
	<span class="cm">/* Skip if already shared */</span>
	<span class="n">key_jump_cmd</span> <span class="o">=</span> <span class="n">append_jump</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">JUMP_JSL</span> <span class="o">|</span> <span class="n">JUMP_TEST_ALL</span> <span class="o">|</span>
				   <span class="n">JUMP_COND_SHRD</span><span class="p">);</span>

	<span class="cm">/* Load class1 key only */</span>
	<span class="n">append_key_as_imm</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enckeylen</span><span class="p">,</span>
			  <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enckeylen</span><span class="p">,</span> <span class="n">CLASS_1</span> <span class="o">|</span>
			  <span class="n">KEY_DEST_CLASS_REG</span><span class="p">);</span>

	<span class="cm">/* For aead, only propagate error immediately if shared */</span>
	<span class="n">jump_cmd</span> <span class="o">=</span> <span class="n">append_jump</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">JUMP_TEST_ALL</span><span class="p">);</span>
	<span class="n">set_jump_tgt_here</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">key_jump_cmd</span><span class="p">);</span>
	<span class="n">append_cmd</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">SET_OK_NO_PROP_ERRORS</span> <span class="o">|</span> <span class="n">CMD_LOAD</span><span class="p">);</span>
	<span class="n">set_jump_tgt_here</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">jump_cmd</span><span class="p">);</span>

	<span class="cm">/* load IV */</span>
	<span class="n">append_cmd</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">CMD_SEQ_LOAD</span> <span class="o">|</span> <span class="n">LDST_SRCDST_BYTE_CONTEXT</span> <span class="o">|</span>
		   <span class="n">LDST_CLASS_1_CCB</span> <span class="o">|</span> <span class="n">tfm</span><span class="o">-&gt;</span><span class="n">ivsize</span><span class="p">);</span>

	<span class="cm">/* Choose operation */</span>
	<span class="n">append_dec_op1</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">class1_alg_type</span><span class="p">);</span>

	<span class="cm">/* Perform operation */</span>
	<span class="n">ablkcipher_append_src_dst</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="cm">/* Wait for key to load before allowing propagating error */</span>
	<span class="n">append_dec_shr_done</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_dec_dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span>
					      <span class="n">desc_bytes</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span>
					      <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_enc_dma</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;unable to map shared descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;ablkcipher dec shdesc@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span>
		       <span class="n">desc_bytes</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">link_tbl_entry</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf_pool_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * aead_edesc - s/w-extended aead descriptor</span>
<span class="cm"> * @assoc_nents: number of segments in associated data (SPI+Seq) scatterlist</span>
<span class="cm"> * @src_nents: number of segments in input scatterlist</span>
<span class="cm"> * @dst_nents: number of segments in output scatterlist</span>
<span class="cm"> * @iv_dma: dma address of iv for checking continuity and link table</span>
<span class="cm"> * @desc: h/w descriptor (variable length; must not exceed MAX_CAAM_DESCSIZE)</span>
<span class="cm"> * @link_tbl_bytes: length of dma mapped link_tbl space</span>
<span class="cm"> * @link_tbl_dma: bus physical mapped address of h/w link table</span>
<span class="cm"> * @hw_desc: the h/w job descriptor followed by any referenced link tables</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">aead_edesc</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">assoc_nents</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">src_nents</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dst_nents</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">iv_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">link_tbl_bytes</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">link_tbl_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">link_tbl_entry</span> <span class="o">*</span><span class="n">link_tbl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hw_desc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ablkcipher_edesc - s/w-extended ablkcipher descriptor</span>
<span class="cm"> * @src_nents: number of segments in input scatterlist</span>
<span class="cm"> * @dst_nents: number of segments in output scatterlist</span>
<span class="cm"> * @iv_dma: dma address of iv for checking continuity and link table</span>
<span class="cm"> * @desc: h/w descriptor (variable length; must not exceed MAX_CAAM_DESCSIZE)</span>
<span class="cm"> * @link_tbl_bytes: length of dma mapped link_tbl space</span>
<span class="cm"> * @link_tbl_dma: bus physical mapped address of h/w link table</span>
<span class="cm"> * @hw_desc: the h/w job descriptor followed by any referenced link tables</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ablkcipher_edesc</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">src_nents</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dst_nents</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">iv_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">link_tbl_bytes</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">link_tbl_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">link_tbl_entry</span> <span class="o">*</span><span class="n">link_tbl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hw_desc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">caam_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_nents</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_nents</span><span class="p">,</span>
		       <span class="n">dma_addr_t</span> <span class="n">iv_dma</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ivsize</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">link_tbl_dma</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">link_tbl_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dst</span> <span class="o">!=</span> <span class="n">src</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">src_nents</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">dst_nents</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">src_nents</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iv_dma</span><span class="p">)</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iv_dma</span><span class="p">,</span> <span class="n">ivsize</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link_tbl_bytes</span><span class="p">)</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link_tbl_dma</span><span class="p">,</span> <span class="n">link_tbl_bytes</span><span class="p">,</span>
				 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aead_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">aead_edesc</span> <span class="o">*</span><span class="n">edesc</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">aead_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">aead</span> <span class="o">=</span> <span class="n">crypto_aead_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ivsize</span> <span class="o">=</span> <span class="n">crypto_aead_ivsize</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>

	<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">,</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">assoc_nents</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">caam_unmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span>
		   <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">src_nents</span><span class="p">,</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">dst_nents</span><span class="p">,</span>
		   <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">iv_dma</span><span class="p">,</span> <span class="n">ivsize</span><span class="p">,</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl_dma</span><span class="p">,</span>
		   <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl_bytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ablkcipher_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ablkcipher_edesc</span> <span class="o">*</span><span class="n">edesc</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_ablkcipher</span> <span class="o">*</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ivsize</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_ivsize</span><span class="p">(</span><span class="n">ablkcipher</span><span class="p">);</span>

	<span class="n">caam_unmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span>
		   <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">src_nents</span><span class="p">,</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">dst_nents</span><span class="p">,</span>
		   <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">iv_dma</span><span class="p">,</span> <span class="n">ivsize</span><span class="p">,</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl_dma</span><span class="p">,</span>
		   <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl_bytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aead_encrypt_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">err</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aead_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aead_edesc</span> <span class="o">*</span><span class="n">edesc</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">aead</span> <span class="o">=</span> <span class="n">crypto_aead_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_aead_ctx</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ivsize</span> <span class="o">=</span> <span class="n">crypto_aead_ivsize</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;%s %d: err 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">edesc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aead_edesc</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span> <span class="o">-</span>
		 <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aead_edesc</span><span class="p">,</span> <span class="n">hw_desc</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="n">CAAM_ERROR_STR_MAX</span><span class="p">];</span>

		<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;%08x: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">caam_jr_strstatus</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">err</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">aead_unmap</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">edesc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;assoc  @&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">),</span>
		       <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoclen</span> <span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;dstiv  @&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">)</span> <span class="o">-</span> <span class="n">ivsize</span><span class="p">,</span>
		       <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">src_nents</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="n">ivsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;dst    @&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">),</span>
		       <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">src_nents</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span> <span class="o">+</span>
		       <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">authsize</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">edesc</span><span class="p">);</span>

	<span class="n">aead_request_complete</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aead_decrypt_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">err</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aead_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aead_edesc</span> <span class="o">*</span><span class="n">edesc</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">aead</span> <span class="o">=</span> <span class="n">crypto_aead_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_aead_ctx</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ivsize</span> <span class="o">=</span> <span class="n">crypto_aead_ivsize</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;%s %d: err 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">edesc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aead_edesc</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span> <span class="o">-</span>
		 <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aead_edesc</span><span class="p">,</span> <span class="n">hw_desc</span><span class="p">));</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;dstiv  @&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">iv</span><span class="p">,</span>
		       <span class="n">ivsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;dst    @&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">),</span>
		       <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="n">CAAM_ERROR_STR_MAX</span><span class="p">];</span>

		<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;%08x: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">caam_jr_strstatus</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">err</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">aead_unmap</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">edesc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * verify hw auth check passed else return -EBADMSG</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">JRSTA_CCBERR_ERRID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">JRSTA_CCBERR_ERRID_ICVCHK</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;iphdrout@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
		       <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sg_virt</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">)),</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoclen</span> <span class="o">+</span>
		       <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span> <span class="o">&gt;</span> <span class="mi">1500</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1500</span> <span class="o">:</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span><span class="p">)</span> <span class="o">+</span>
		       <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">authsize</span> <span class="o">+</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl_bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sg_last</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">src_nents</span><span class="p">);</span>
		<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;sglastout@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
			       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span>
			<span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">authsize</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">edesc</span><span class="p">);</span>

	<span class="n">aead_request_complete</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ablkcipher_encrypt_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">err</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ablkcipher_edesc</span> <span class="o">*</span><span class="n">edesc</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">struct</span> <span class="n">crypto_ablkcipher</span> <span class="o">*</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ivsize</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_ivsize</span><span class="p">(</span><span class="n">ablkcipher</span><span class="p">);</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;%s %d: err 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">edesc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_edesc</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span> <span class="o">-</span>
		 <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_edesc</span><span class="p">,</span> <span class="n">hw_desc</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="n">CAAM_ERROR_STR_MAX</span><span class="p">];</span>

		<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;%08x: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">caam_jr_strstatus</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">err</span><span class="p">));</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;dstiv  @&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span>
		       <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">src_nents</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="n">ivsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;dst    @&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">),</span>
		       <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">dst_nents</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">ablkcipher_unmap</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">edesc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">edesc</span><span class="p">);</span>

	<span class="n">ablkcipher_request_complete</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ablkcipher_decrypt_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">err</span><span class="p">,</span>
				    <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ablkcipher_edesc</span> <span class="o">*</span><span class="n">edesc</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">struct</span> <span class="n">crypto_ablkcipher</span> <span class="o">*</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ivsize</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_ivsize</span><span class="p">(</span><span class="n">ablkcipher</span><span class="p">);</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;%s %d: err 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">edesc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_edesc</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span> <span class="o">-</span>
		 <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_edesc</span><span class="p">,</span> <span class="n">hw_desc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="n">CAAM_ERROR_STR_MAX</span><span class="p">];</span>

		<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;%08x: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">caam_jr_strstatus</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">err</span><span class="p">));</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;dstiv  @&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span>
		       <span class="n">ivsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;dst    @&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">),</span>
		       <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">dst_nents</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">ablkcipher_unmap</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">edesc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">edesc</span><span class="p">);</span>

	<span class="n">ablkcipher_request_complete</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sg_to_link_tbl_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_tbl_entry</span> <span class="o">*</span><span class="n">link_tbl_ptr</span><span class="p">,</span>
			       <span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">link_tbl_ptr</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
	<span class="n">link_tbl_ptr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">link_tbl_ptr</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">link_tbl_ptr</span><span class="o">-&gt;</span><span class="n">buf_pool_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">link_tbl_ptr</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;link_tbl_ptr@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">link_tbl_ptr</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_tbl_entry</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * convert scatterlist to h/w link table format</span>
<span class="cm"> * but does not have final bit; instead, returns last entry</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">link_tbl_entry</span> <span class="o">*</span><span class="nf">sg_to_link_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span>
					     <span class="kt">int</span> <span class="n">sg_count</span><span class="p">,</span> <span class="k">struct</span> <span class="n">link_tbl_entry</span>
					     <span class="o">*</span><span class="n">link_tbl_ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sg_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg_to_link_tbl_one</span><span class="p">(</span><span class="n">link_tbl_ptr</span><span class="p">,</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span>
				   <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">link_tbl_ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">sg_count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">link_tbl_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * convert scatterlist to h/w link table format</span>
<span class="cm"> * scatterlist must have been previously dma mapped</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sg_to_link_tbl_last</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sg_count</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">link_tbl_entry</span> <span class="o">*</span><span class="n">link_tbl_ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">link_tbl_ptr</span> <span class="o">=</span> <span class="n">sg_to_link_tbl</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg_count</span><span class="p">,</span> <span class="n">link_tbl_ptr</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">link_tbl_ptr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">|=</span> <span class="mh">0x40000000</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fill in aead job descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_aead_job</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">sh_desc</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">ptr</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">aead_edesc</span> <span class="o">*</span><span class="n">edesc</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">aead_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			  <span class="n">bool</span> <span class="n">all_contig</span><span class="p">,</span> <span class="n">bool</span> <span class="n">encrypt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">aead</span> <span class="o">=</span> <span class="n">crypto_aead_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_aead_ctx</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ivsize</span> <span class="o">=</span> <span class="n">crypto_aead_ivsize</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">authsize</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">authsize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">out_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">in_options</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dst_dma</span><span class="p">,</span> <span class="n">src_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">link_tbl_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;assoclen %d cryptlen %d authsize %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoclen</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span><span class="p">,</span> <span class="n">authsize</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;assoc  @&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">),</span>
		       <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoclen</span> <span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;presciv@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">iv</span><span class="p">,</span>
		       <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">src_nents</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="n">ivsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;src    @&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">),</span>
			<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">src_nents</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;shrdesc@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sh_desc</span><span class="p">,</span>
		       <span class="n">desc_bytes</span><span class="p">(</span><span class="n">sh_desc</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">desc_len</span><span class="p">(</span><span class="n">sh_desc</span><span class="p">);</span>
	<span class="n">init_job_desc_shared</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">HDR_SHARE_DEFER</span> <span class="o">|</span> <span class="n">HDR_REVERSE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">all_contig</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src_dma</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">);</span>
		<span class="n">in_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">src_dma</span> <span class="o">=</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl_dma</span><span class="p">;</span>
		<span class="n">link_tbl_index</span> <span class="o">+=</span> <span class="p">(</span><span class="n">edesc</span><span class="o">-&gt;</span><span class="n">assoc_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span>
				  <span class="p">(</span><span class="n">edesc</span><span class="o">-&gt;</span><span class="n">src_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">in_options</span> <span class="o">=</span> <span class="n">LDST_SGF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">encrypt</span><span class="p">)</span>
		<span class="n">append_seq_in_ptr</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">src_dma</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoclen</span> <span class="o">+</span> <span class="n">ivsize</span> <span class="o">+</span>
				  <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span> <span class="o">-</span> <span class="n">authsize</span><span class="p">,</span> <span class="n">in_options</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">append_seq_in_ptr</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">src_dma</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoclen</span> <span class="o">+</span> <span class="n">ivsize</span> <span class="o">+</span>
				  <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span><span class="p">,</span> <span class="n">in_options</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">all_contig</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst_dma</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dst_dma</span> <span class="o">=</span> <span class="n">src_dma</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_tbl_entry</span><span class="p">)</span> <span class="o">*</span>
				  <span class="p">((</span><span class="n">edesc</span><span class="o">-&gt;</span><span class="n">assoc_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">out_options</span> <span class="o">=</span> <span class="n">LDST_SGF</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edesc</span><span class="o">-&gt;</span><span class="n">dst_nents</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst_dma</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dst_dma</span> <span class="o">=</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl_dma</span> <span class="o">+</span>
				  <span class="n">link_tbl_index</span> <span class="o">*</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_tbl_entry</span><span class="p">);</span>
			<span class="n">out_options</span> <span class="o">=</span> <span class="n">LDST_SGF</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">encrypt</span><span class="p">)</span>
		<span class="n">append_seq_out_ptr</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">dst_dma</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span><span class="p">,</span> <span class="n">out_options</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">append_seq_out_ptr</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">dst_dma</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span> <span class="o">-</span> <span class="n">authsize</span><span class="p">,</span>
				   <span class="n">out_options</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fill in aead givencrypt job descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_aead_giv_job</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">sh_desc</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">ptr</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">aead_edesc</span> <span class="o">*</span><span class="n">edesc</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">aead_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">contig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">aead</span> <span class="o">=</span> <span class="n">crypto_aead_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_aead_ctx</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ivsize</span> <span class="o">=</span> <span class="n">crypto_aead_ivsize</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">authsize</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">authsize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">out_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">in_options</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dst_dma</span><span class="p">,</span> <span class="n">src_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">link_tbl_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;assoclen %d cryptlen %d authsize %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoclen</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span><span class="p">,</span> <span class="n">authsize</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;assoc  @&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">),</span>
		       <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoclen</span> <span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;presciv@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">iv</span><span class="p">,</span> <span class="n">ivsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;src    @&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">),</span>
			<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">src_nents</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;shrdesc@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sh_desc</span><span class="p">,</span>
		       <span class="n">desc_bytes</span><span class="p">(</span><span class="n">sh_desc</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">desc_len</span><span class="p">(</span><span class="n">sh_desc</span><span class="p">);</span>
	<span class="n">init_job_desc_shared</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">HDR_SHARE_DEFER</span> <span class="o">|</span> <span class="n">HDR_REVERSE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">contig</span> <span class="o">&amp;</span> <span class="n">GIV_SRC_CONTIG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src_dma</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">);</span>
		<span class="n">in_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">src_dma</span> <span class="o">=</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl_dma</span><span class="p">;</span>
		<span class="n">link_tbl_index</span> <span class="o">+=</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">assoc_nents</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">src_nents</span><span class="p">;</span>
		<span class="n">in_options</span> <span class="o">=</span> <span class="n">LDST_SGF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">append_seq_in_ptr</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">src_dma</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoclen</span> <span class="o">+</span> <span class="n">ivsize</span> <span class="o">+</span>
			  <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span> <span class="o">-</span> <span class="n">authsize</span><span class="p">,</span> <span class="n">in_options</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">contig</span> <span class="o">&amp;</span> <span class="n">GIV_DST_CONTIG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst_dma</span> <span class="o">=</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">iv_dma</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dst_dma</span> <span class="o">=</span> <span class="n">src_dma</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_tbl_entry</span><span class="p">)</span> <span class="o">*</span>
				  <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">assoc_nents</span><span class="p">;</span>
			<span class="n">out_options</span> <span class="o">=</span> <span class="n">LDST_SGF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dst_dma</span> <span class="o">=</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl_dma</span> <span class="o">+</span>
				  <span class="n">link_tbl_index</span> <span class="o">*</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_tbl_entry</span><span class="p">);</span>
			<span class="n">out_options</span> <span class="o">=</span> <span class="n">LDST_SGF</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">append_seq_out_ptr</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">dst_dma</span><span class="p">,</span> <span class="n">ivsize</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span><span class="p">,</span> <span class="n">out_options</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fill in ablkcipher job descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_ablkcipher_job</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">sh_desc</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">ptr</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ablkcipher_edesc</span> <span class="o">*</span><span class="n">edesc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">iv_contig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_ablkcipher</span> <span class="o">*</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ivsize</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_ivsize</span><span class="p">(</span><span class="n">ablkcipher</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">out_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">in_options</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dst_dma</span><span class="p">,</span> <span class="n">src_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">link_tbl_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;presciv@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span>
		       <span class="n">ivsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;src    @&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">),</span>
		       <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">src_nents</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">desc_len</span><span class="p">(</span><span class="n">sh_desc</span><span class="p">);</span>
	<span class="n">init_job_desc_shared</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">HDR_SHARE_DEFER</span> <span class="o">|</span> <span class="n">HDR_REVERSE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iv_contig</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src_dma</span> <span class="o">=</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">iv_dma</span><span class="p">;</span>
		<span class="n">in_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">src_dma</span> <span class="o">=</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl_dma</span><span class="p">;</span>
		<span class="n">link_tbl_index</span> <span class="o">+=</span> <span class="p">(</span><span class="n">iv_contig</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">src_nents</span><span class="p">;</span>
		<span class="n">in_options</span> <span class="o">=</span> <span class="n">LDST_SGF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">append_seq_in_ptr</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">src_dma</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">ivsize</span><span class="p">,</span> <span class="n">in_options</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edesc</span><span class="o">-&gt;</span><span class="n">src_nents</span> <span class="o">&amp;&amp;</span> <span class="n">iv_contig</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst_dma</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dst_dma</span> <span class="o">=</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl_dma</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_tbl_entry</span><span class="p">);</span>
			<span class="n">out_options</span> <span class="o">=</span> <span class="n">LDST_SGF</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edesc</span><span class="o">-&gt;</span><span class="n">dst_nents</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst_dma</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dst_dma</span> <span class="o">=</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl_dma</span> <span class="o">+</span>
				<span class="n">link_tbl_index</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_tbl_entry</span><span class="p">);</span>
			<span class="n">out_options</span> <span class="o">=</span> <span class="n">LDST_SGF</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">append_seq_out_ptr</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">dst_dma</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">,</span> <span class="n">out_options</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * derive number of elements in scatterlist</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sg_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg_list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sg_list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sg_nents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg_nents</span><span class="o">++</span><span class="p">;</span>
		<span class="n">nbytes</span> <span class="o">-=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sg_is_last</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">BUG</span><span class="p">();</span> <span class="cm">/* Not support chaining */</span>
		<span class="n">sg</span> <span class="o">=</span> <span class="n">scatterwalk_sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">sg_nents</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sg_nents</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * allocate and map the aead extended descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">aead_edesc</span> <span class="o">*</span><span class="nf">aead_edesc_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">aead_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">desc_bytes</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">all_contig_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">aead</span> <span class="o">=</span> <span class="n">crypto_aead_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_aead_ctx</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">jrdev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">jrdev</span><span class="p">;</span>
	<span class="n">gfp_t</span> <span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CRYPTO_TFM_REQ_MAY_BACKLOG</span> <span class="o">|</span>
		       <span class="n">CRYPTO_TFM_REQ_MAY_SLEEP</span><span class="p">))</span> <span class="o">?</span> <span class="n">GFP_KERNEL</span> <span class="o">:</span> <span class="n">GFP_ATOMIC</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">assoc_nents</span><span class="p">,</span> <span class="n">src_nents</span><span class="p">,</span> <span class="n">dst_nents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aead_edesc</span> <span class="o">*</span><span class="n">edesc</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">iv_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sgc</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">all_contig</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ivsize</span> <span class="o">=</span> <span class="n">crypto_aead_ivsize</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">link_tbl_index</span><span class="p">,</span> <span class="n">link_tbl_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">link_tbl_bytes</span><span class="p">;</span>

	<span class="n">assoc_nents</span> <span class="o">=</span> <span class="n">sg_count</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoclen</span><span class="p">);</span>
	<span class="n">src_nents</span> <span class="o">=</span> <span class="n">sg_count</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">))</span>
		<span class="n">dst_nents</span> <span class="o">=</span> <span class="n">sg_count</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span><span class="p">);</span>

	<span class="n">sgc</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">,</span> <span class="n">assoc_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
			 <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sgc</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">src_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
				 <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sgc</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">src_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
				 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">sgc</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
				 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Check if data are contiguous */</span>
	<span class="n">iv_dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">iv</span><span class="p">,</span> <span class="n">ivsize</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">assoc_nents</span> <span class="o">||</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoclen</span> <span class="o">!=</span>
	    <span class="n">iv_dma</span> <span class="o">||</span> <span class="n">src_nents</span> <span class="o">||</span> <span class="n">iv_dma</span> <span class="o">+</span> <span class="n">ivsize</span> <span class="o">!=</span>
	    <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">all_contig</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">assoc_nents</span> <span class="o">=</span> <span class="n">assoc_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">src_nents</span> <span class="o">=</span> <span class="n">src_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">link_tbl_len</span> <span class="o">=</span> <span class="n">assoc_nents</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">src_nents</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">link_tbl_len</span> <span class="o">+=</span> <span class="n">dst_nents</span><span class="p">;</span>

	<span class="n">link_tbl_bytes</span> <span class="o">=</span> <span class="n">link_tbl_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_tbl_entry</span><span class="p">);</span>

	<span class="cm">/* allocate space for base edesc and hw desc commands, link tables */</span>
	<span class="n">edesc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aead_edesc</span><span class="p">)</span> <span class="o">+</span> <span class="n">desc_bytes</span> <span class="o">+</span>
			<span class="n">link_tbl_bytes</span><span class="p">,</span> <span class="n">GFP_DMA</span> <span class="o">|</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edesc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;could not allocate extended descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">assoc_nents</span> <span class="o">=</span> <span class="n">assoc_nents</span><span class="p">;</span>
	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">src_nents</span> <span class="o">=</span> <span class="n">src_nents</span><span class="p">;</span>
	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">dst_nents</span> <span class="o">=</span> <span class="n">dst_nents</span><span class="p">;</span>
	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">iv_dma</span> <span class="o">=</span> <span class="n">iv_dma</span><span class="p">;</span>
	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl_bytes</span> <span class="o">=</span> <span class="n">link_tbl_bytes</span><span class="p">;</span>
	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">edesc</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aead_edesc</span><span class="p">)</span> <span class="o">+</span>
			  <span class="n">desc_bytes</span><span class="p">;</span>
	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl_dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl</span><span class="p">,</span>
					     <span class="n">link_tbl_bytes</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="o">*</span><span class="n">all_contig_ptr</span> <span class="o">=</span> <span class="n">all_contig</span><span class="p">;</span>

	<span class="n">link_tbl_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">all_contig</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg_to_link_tbl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">assoc_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">),</span>
			       <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl</span> <span class="o">+</span>
			       <span class="n">link_tbl_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">link_tbl_index</span> <span class="o">+=</span> <span class="n">assoc_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sg_to_link_tbl_one</span><span class="p">(</span><span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl</span> <span class="o">+</span> <span class="n">link_tbl_index</span><span class="p">,</span>
				   <span class="n">iv_dma</span><span class="p">,</span> <span class="n">ivsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">link_tbl_index</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sg_to_link_tbl_last</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">src_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">),</span>
				    <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl</span> <span class="o">+</span>
				    <span class="n">link_tbl_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">link_tbl_index</span> <span class="o">+=</span> <span class="n">src_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst_nents</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg_to_link_tbl_last</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst_nents</span><span class="p">,</span>
				    <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl</span> <span class="o">+</span> <span class="n">link_tbl_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">edesc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aead_encrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">aead_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aead_edesc</span> <span class="o">*</span><span class="n">edesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">aead</span> <span class="o">=</span> <span class="n">crypto_aead_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_aead_ctx</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">jrdev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">jrdev</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">all_contig</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span> <span class="o">+=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">authsize</span><span class="p">;</span>

	<span class="cm">/* allocate extended descriptor */</span>
	<span class="n">edesc</span> <span class="o">=</span> <span class="n">aead_edesc_alloc</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">DESC_JOB_IO_LEN</span> <span class="o">*</span>
				 <span class="n">CAAM_CMD_SZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_contig</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">edesc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">edesc</span><span class="p">);</span>

	<span class="cm">/* Create and submit job descriptor */</span>
	<span class="n">init_aead_job</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_enc</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_enc_dma</span><span class="p">,</span> <span class="n">edesc</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
		      <span class="n">all_contig</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;aead jobdesc@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span>
		       <span class="n">desc_bytes</span><span class="p">(</span><span class="n">edesc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">caam_jr_enqueue</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">aead_encrypt_done</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">aead_unmap</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">edesc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">edesc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aead_decrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">aead_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aead_edesc</span> <span class="o">*</span><span class="n">edesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">aead</span> <span class="o">=</span> <span class="n">crypto_aead_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_aead_ctx</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">jrdev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">jrdev</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">all_contig</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* allocate extended descriptor */</span>
	<span class="n">edesc</span> <span class="o">=</span> <span class="n">aead_edesc_alloc</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">DESC_JOB_IO_LEN</span> <span class="o">*</span>
				 <span class="n">CAAM_CMD_SZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_contig</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">edesc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">edesc</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;dec src@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">),</span>
		       <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Create and submit job descriptor*/</span>
	<span class="n">init_aead_job</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_dec</span><span class="p">,</span>
		      <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_dec_dma</span><span class="p">,</span> <span class="n">edesc</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">all_contig</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;aead jobdesc@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span>
		       <span class="n">desc_bytes</span><span class="p">(</span><span class="n">edesc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">caam_jr_enqueue</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">aead_decrypt_done</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">aead_unmap</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">edesc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">edesc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * allocate and map the aead extended descriptor for aead givencrypt</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">aead_edesc</span> <span class="o">*</span><span class="nf">aead_giv_edesc_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">aead_givcrypt_request</span>
					       <span class="o">*</span><span class="n">greq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">desc_bytes</span><span class="p">,</span>
					       <span class="n">u32</span> <span class="o">*</span><span class="n">contig_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aead_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">greq</span><span class="o">-&gt;</span><span class="n">areq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">aead</span> <span class="o">=</span> <span class="n">crypto_aead_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_aead_ctx</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">jrdev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">jrdev</span><span class="p">;</span>
	<span class="n">gfp_t</span> <span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CRYPTO_TFM_REQ_MAY_BACKLOG</span> <span class="o">|</span>
		       <span class="n">CRYPTO_TFM_REQ_MAY_SLEEP</span><span class="p">))</span> <span class="o">?</span> <span class="n">GFP_KERNEL</span> <span class="o">:</span> <span class="n">GFP_ATOMIC</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">assoc_nents</span><span class="p">,</span> <span class="n">src_nents</span><span class="p">,</span> <span class="n">dst_nents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aead_edesc</span> <span class="o">*</span><span class="n">edesc</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">iv_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sgc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">contig</span> <span class="o">=</span> <span class="n">GIV_SRC_CONTIG</span> <span class="o">|</span> <span class="n">GIV_DST_CONTIG</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ivsize</span> <span class="o">=</span> <span class="n">crypto_aead_ivsize</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">link_tbl_index</span><span class="p">,</span> <span class="n">link_tbl_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">link_tbl_bytes</span><span class="p">;</span>

	<span class="n">assoc_nents</span> <span class="o">=</span> <span class="n">sg_count</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoclen</span><span class="p">);</span>
	<span class="n">src_nents</span> <span class="o">=</span> <span class="n">sg_count</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">))</span>
		<span class="n">dst_nents</span> <span class="o">=</span> <span class="n">sg_count</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span><span class="p">);</span>

	<span class="n">sgc</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">,</span> <span class="n">assoc_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
			 <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sgc</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">src_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
				 <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sgc</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">src_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
				 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">sgc</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
				 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Check if data are contiguous */</span>
	<span class="n">iv_dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">greq</span><span class="o">-&gt;</span><span class="n">giv</span><span class="p">,</span> <span class="n">ivsize</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">assoc_nents</span> <span class="o">||</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span> <span class="o">+</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">assoclen</span> <span class="o">!=</span>
	    <span class="n">iv_dma</span> <span class="o">||</span> <span class="n">src_nents</span> <span class="o">||</span> <span class="n">iv_dma</span> <span class="o">+</span> <span class="n">ivsize</span> <span class="o">!=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">))</span>
		<span class="n">contig</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GIV_SRC_CONTIG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst_nents</span> <span class="o">||</span> <span class="n">iv_dma</span> <span class="o">+</span> <span class="n">ivsize</span> <span class="o">!=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">))</span>
		<span class="n">contig</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GIV_DST_CONTIG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dst_nents</span> <span class="o">=</span> <span class="n">dst_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">link_tbl_len</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">contig</span> <span class="o">&amp;</span> <span class="n">GIV_SRC_CONTIG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">assoc_nents</span> <span class="o">=</span> <span class="n">assoc_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">src_nents</span> <span class="o">=</span> <span class="n">src_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">link_tbl_len</span> <span class="o">+=</span> <span class="n">assoc_nents</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">src_nents</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">))</span>
			<span class="n">contig</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GIV_DST_CONTIG</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">link_tbl_len</span> <span class="o">+=</span> <span class="n">dst_nents</span><span class="p">;</span>

	<span class="n">link_tbl_bytes</span> <span class="o">=</span> <span class="n">link_tbl_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_tbl_entry</span><span class="p">);</span>

	<span class="cm">/* allocate space for base edesc and hw desc commands, link tables */</span>
	<span class="n">edesc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aead_edesc</span><span class="p">)</span> <span class="o">+</span> <span class="n">desc_bytes</span> <span class="o">+</span>
			<span class="n">link_tbl_bytes</span><span class="p">,</span> <span class="n">GFP_DMA</span> <span class="o">|</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edesc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;could not allocate extended descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">assoc_nents</span> <span class="o">=</span> <span class="n">assoc_nents</span><span class="p">;</span>
	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">src_nents</span> <span class="o">=</span> <span class="n">src_nents</span><span class="p">;</span>
	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">dst_nents</span> <span class="o">=</span> <span class="n">dst_nents</span><span class="p">;</span>
	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">iv_dma</span> <span class="o">=</span> <span class="n">iv_dma</span><span class="p">;</span>
	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl_bytes</span> <span class="o">=</span> <span class="n">link_tbl_bytes</span><span class="p">;</span>
	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">edesc</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aead_edesc</span><span class="p">)</span> <span class="o">+</span>
			  <span class="n">desc_bytes</span><span class="p">;</span>
	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl_dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl</span><span class="p">,</span>
					     <span class="n">link_tbl_bytes</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="o">*</span><span class="n">contig_ptr</span> <span class="o">=</span> <span class="n">contig</span><span class="p">;</span>

	<span class="n">link_tbl_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">contig</span> <span class="o">&amp;</span> <span class="n">GIV_SRC_CONTIG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sg_to_link_tbl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">,</span> <span class="n">assoc_nents</span><span class="p">,</span>
			       <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl</span> <span class="o">+</span>
			       <span class="n">link_tbl_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">link_tbl_index</span> <span class="o">+=</span> <span class="n">assoc_nents</span><span class="p">;</span>
		<span class="n">sg_to_link_tbl_one</span><span class="p">(</span><span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl</span> <span class="o">+</span> <span class="n">link_tbl_index</span><span class="p">,</span>
				   <span class="n">iv_dma</span><span class="p">,</span> <span class="n">ivsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">link_tbl_index</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sg_to_link_tbl_last</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">src_nents</span><span class="p">,</span>
				    <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl</span> <span class="o">+</span>
				    <span class="n">link_tbl_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">link_tbl_index</span> <span class="o">+=</span> <span class="n">src_nents</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">contig</span> <span class="o">&amp;</span> <span class="n">GIV_DST_CONTIG</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">sg_to_link_tbl_one</span><span class="p">(</span><span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl</span> <span class="o">+</span> <span class="n">link_tbl_index</span><span class="p">,</span>
				   <span class="n">iv_dma</span><span class="p">,</span> <span class="n">ivsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">link_tbl_index</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sg_to_link_tbl_last</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst_nents</span><span class="p">,</span>
				    <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl</span> <span class="o">+</span> <span class="n">link_tbl_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">edesc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aead_givencrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">aead_givcrypt_request</span> <span class="o">*</span><span class="n">areq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aead_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">areq</span><span class="o">-&gt;</span><span class="n">areq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aead_edesc</span> <span class="o">*</span><span class="n">edesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_aead</span> <span class="o">*</span><span class="n">aead</span> <span class="o">=</span> <span class="n">crypto_aead_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_aead_ctx</span><span class="p">(</span><span class="n">aead</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">jrdev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">jrdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">contig</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span> <span class="o">+=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">authsize</span><span class="p">;</span>

	<span class="cm">/* allocate extended descriptor */</span>
	<span class="n">edesc</span> <span class="o">=</span> <span class="n">aead_giv_edesc_alloc</span><span class="p">(</span><span class="n">areq</span><span class="p">,</span> <span class="n">DESC_JOB_IO_LEN</span> <span class="o">*</span>
				     <span class="n">CAAM_CMD_SZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">contig</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">edesc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">edesc</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;giv src@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">),</span>
		       <span class="n">req</span><span class="o">-&gt;</span><span class="n">cryptlen</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Create and submit job descriptor*/</span>
	<span class="n">init_aead_giv_job</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_givenc</span><span class="p">,</span>
			  <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_givenc_dma</span><span class="p">,</span> <span class="n">edesc</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">contig</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;aead jobdesc@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span>
		       <span class="n">desc_bytes</span><span class="p">(</span><span class="n">edesc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">caam_jr_enqueue</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">aead_encrypt_done</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">aead_unmap</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">edesc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">edesc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * allocate and map the ablkcipher extended descriptor for ablkcipher</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ablkcipher_edesc</span> <span class="o">*</span><span class="nf">ablkcipher_edesc_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span>
						       <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">desc_bytes</span><span class="p">,</span>
						       <span class="n">bool</span> <span class="o">*</span><span class="n">iv_contig_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_ablkcipher</span> <span class="o">*</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_ctx</span><span class="p">(</span><span class="n">ablkcipher</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">jrdev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">jrdev</span><span class="p">;</span>
	<span class="n">gfp_t</span> <span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CRYPTO_TFM_REQ_MAY_BACKLOG</span> <span class="o">|</span>
					  <span class="n">CRYPTO_TFM_REQ_MAY_SLEEP</span><span class="p">))</span> <span class="o">?</span>
		       <span class="n">GFP_KERNEL</span> <span class="o">:</span> <span class="n">GFP_ATOMIC</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">src_nents</span><span class="p">,</span> <span class="n">dst_nents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">link_tbl_bytes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ablkcipher_edesc</span> <span class="o">*</span><span class="n">edesc</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">iv_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">iv_contig</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sgc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ivsize</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_ivsize</span><span class="p">(</span><span class="n">ablkcipher</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">link_tbl_index</span><span class="p">;</span>

	<span class="n">src_nents</span> <span class="o">=</span> <span class="n">sg_count</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">))</span>
		<span class="n">dst_nents</span> <span class="o">=</span> <span class="n">sg_count</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sgc</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">src_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
				 <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sgc</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">src_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
				 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">sgc</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
				 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if iv can be contiguous with source and destination.</span>
<span class="cm">	 * If so, include it. If not, create scatterlist.</span>
<span class="cm">	 */</span>
	<span class="n">iv_dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span> <span class="n">ivsize</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src_nents</span> <span class="o">&amp;&amp;</span> <span class="n">iv_dma</span> <span class="o">+</span> <span class="n">ivsize</span> <span class="o">==</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">))</span>
		<span class="n">iv_contig</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">src_nents</span> <span class="o">=</span> <span class="n">src_nents</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">link_tbl_bytes</span> <span class="o">=</span> <span class="p">((</span><span class="n">iv_contig</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">src_nents</span> <span class="o">+</span> <span class="n">dst_nents</span><span class="p">)</span> <span class="o">*</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_tbl_entry</span><span class="p">);</span>

	<span class="cm">/* allocate space for base edesc and hw desc commands, link tables */</span>
	<span class="n">edesc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_edesc</span><span class="p">)</span> <span class="o">+</span> <span class="n">desc_bytes</span> <span class="o">+</span>
			<span class="n">link_tbl_bytes</span><span class="p">,</span> <span class="n">GFP_DMA</span> <span class="o">|</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edesc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="s">&quot;could not allocate extended descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">src_nents</span> <span class="o">=</span> <span class="n">src_nents</span><span class="p">;</span>
	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">dst_nents</span> <span class="o">=</span> <span class="n">dst_nents</span><span class="p">;</span>
	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl_bytes</span> <span class="o">=</span> <span class="n">link_tbl_bytes</span><span class="p">;</span>
	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">edesc</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_edesc</span><span class="p">)</span> <span class="o">+</span>
			  <span class="n">desc_bytes</span><span class="p">;</span>

	<span class="n">link_tbl_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iv_contig</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg_to_link_tbl_one</span><span class="p">(</span><span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl</span><span class="p">,</span> <span class="n">iv_dma</span><span class="p">,</span> <span class="n">ivsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sg_to_link_tbl_last</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">src_nents</span><span class="p">,</span>
				    <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">link_tbl_index</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">src_nents</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dst_nents</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sg_to_link_tbl_last</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst_nents</span><span class="p">,</span>
			<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl</span> <span class="o">+</span> <span class="n">link_tbl_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl_dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl</span><span class="p">,</span>
					     <span class="n">link_tbl_bytes</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">edesc</span><span class="o">-&gt;</span><span class="n">iv_dma</span> <span class="o">=</span> <span class="n">iv_dma</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;ablkcipher link_tbl@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">link_tbl</span><span class="p">,</span>
		       <span class="n">link_tbl_bytes</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="o">*</span><span class="n">iv_contig_out</span> <span class="o">=</span> <span class="n">iv_contig</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">edesc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ablkcipher_encrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ablkcipher_edesc</span> <span class="o">*</span><span class="n">edesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_ablkcipher</span> <span class="o">*</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_ctx</span><span class="p">(</span><span class="n">ablkcipher</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">jrdev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">jrdev</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">iv_contig</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* allocate extended descriptor */</span>
	<span class="n">edesc</span> <span class="o">=</span> <span class="n">ablkcipher_edesc_alloc</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">DESC_JOB_IO_LEN</span> <span class="o">*</span>
				       <span class="n">CAAM_CMD_SZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iv_contig</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">edesc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">edesc</span><span class="p">);</span>

	<span class="cm">/* Create and submit job descriptor*/</span>
	<span class="n">init_ablkcipher_job</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_enc</span><span class="p">,</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_enc_dma</span><span class="p">,</span> <span class="n">edesc</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">iv_contig</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;ablkcipher jobdesc@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span>
		       <span class="n">desc_bytes</span><span class="p">(</span><span class="n">edesc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">caam_jr_enqueue</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">ablkcipher_encrypt_done</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ablkcipher_unmap</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">edesc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">edesc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ablkcipher_decrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ablkcipher_edesc</span> <span class="o">*</span><span class="n">edesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_ablkcipher</span> <span class="o">*</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_ctx</span><span class="p">(</span><span class="n">ablkcipher</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">jrdev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">jrdev</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">iv_contig</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* allocate extended descriptor */</span>
	<span class="n">edesc</span> <span class="o">=</span> <span class="n">ablkcipher_edesc_alloc</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">DESC_JOB_IO_LEN</span> <span class="o">*</span>
				       <span class="n">CAAM_CMD_SZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iv_contig</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">edesc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">edesc</span><span class="p">);</span>

	<span class="cm">/* Create and submit job descriptor*/</span>
	<span class="n">init_ablkcipher_job</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_dec</span><span class="p">,</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_dec_dma</span><span class="p">,</span> <span class="n">edesc</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">iv_contig</span><span class="p">);</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;ablkcipher jobdesc@&quot;</span><span class="n">xstr</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span><span class="s">&quot;: &quot;</span><span class="p">,</span>
		       <span class="n">DUMP_PREFIX_ADDRESS</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">edesc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span>
		       <span class="n">desc_bytes</span><span class="p">(</span><span class="n">edesc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">caam_jr_enqueue</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">ablkcipher_decrypt_done</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ablkcipher_unmap</span><span class="p">(</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">edesc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">edesc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define template_aead		template_u.aead</span>
<span class="cp">#define template_ablkcipher	template_u.ablkcipher</span>
<span class="k">struct</span> <span class="n">caam_alg_template</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">CRYPTO_MAX_ALG_NAME</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">driver_name</span><span class="p">[</span><span class="n">CRYPTO_MAX_ALG_NAME</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ablkcipher_alg</span> <span class="n">ablkcipher</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">aead_alg</span> <span class="n">aead</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">blkcipher_alg</span> <span class="n">blkcipher</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">cipher_alg</span> <span class="n">cipher</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">compress_alg</span> <span class="n">compress</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rng_alg</span> <span class="n">rng</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">template_u</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">class1_alg_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">class2_alg_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">alg_op</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">caam_alg_template</span> <span class="n">driver_algs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* single-pass ipsec_esp descriptor */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;authenc(hmac(md5),cbc(aes))&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;authenc-hmac-md5-cbc-aes-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_AEAD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_aead</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aead_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setauthsize</span> <span class="o">=</span> <span class="n">aead_setauthsize</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">aead_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">aead_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">givencrypt</span> <span class="o">=</span> <span class="n">aead_givencrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;&lt;built-in&gt;&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxauthsize</span> <span class="o">=</span> <span class="n">MD5_DIGEST_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_AES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_MD5</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC_PRECOMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_MD5</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;authenc(hmac(sha1),cbc(aes))&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;authenc-hmac-sha1-cbc-aes-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_AEAD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_aead</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aead_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setauthsize</span> <span class="o">=</span> <span class="n">aead_setauthsize</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">aead_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">aead_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">givencrypt</span> <span class="o">=</span> <span class="n">aead_givencrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;&lt;built-in&gt;&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxauthsize</span> <span class="o">=</span> <span class="n">SHA1_DIGEST_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_AES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA1</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC_PRECOMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA1</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;authenc(hmac(sha224),cbc(aes))&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;authenc-hmac-sha224-cbc-aes-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_aead</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aead_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setauthsize</span> <span class="o">=</span> <span class="n">aead_setauthsize</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">aead_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">aead_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">givencrypt</span> <span class="o">=</span> <span class="n">aead_givencrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;&lt;built-in&gt;&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxauthsize</span> <span class="o">=</span> <span class="n">SHA224_DIGEST_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_AES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA224</span> <span class="o">|</span>
				   <span class="n">OP_ALG_AAI_HMAC_PRECOMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA224</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;authenc(hmac(sha256),cbc(aes))&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;authenc-hmac-sha256-cbc-aes-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_AEAD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_aead</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aead_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setauthsize</span> <span class="o">=</span> <span class="n">aead_setauthsize</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">aead_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">aead_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">givencrypt</span> <span class="o">=</span> <span class="n">aead_givencrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;&lt;built-in&gt;&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxauthsize</span> <span class="o">=</span> <span class="n">SHA256_DIGEST_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_AES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA256</span> <span class="o">|</span>
				   <span class="n">OP_ALG_AAI_HMAC_PRECOMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA256</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;authenc(hmac(sha384),cbc(aes))&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;authenc-hmac-sha384-cbc-aes-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_aead</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aead_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setauthsize</span> <span class="o">=</span> <span class="n">aead_setauthsize</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">aead_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">aead_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">givencrypt</span> <span class="o">=</span> <span class="n">aead_givencrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;&lt;built-in&gt;&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxauthsize</span> <span class="o">=</span> <span class="n">SHA384_DIGEST_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_AES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA384</span> <span class="o">|</span>
				   <span class="n">OP_ALG_AAI_HMAC_PRECOMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA384</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;authenc(hmac(sha512),cbc(aes))&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;authenc-hmac-sha512-cbc-aes-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_AEAD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_aead</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aead_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setauthsize</span> <span class="o">=</span> <span class="n">aead_setauthsize</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">aead_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">aead_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">givencrypt</span> <span class="o">=</span> <span class="n">aead_givencrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;&lt;built-in&gt;&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxauthsize</span> <span class="o">=</span> <span class="n">SHA512_DIGEST_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_AES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA512</span> <span class="o">|</span>
				   <span class="n">OP_ALG_AAI_HMAC_PRECOMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA512</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;authenc(hmac(md5),cbc(des3_ede))&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;authenc-hmac-md5-cbc-des3_ede-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">DES3_EDE_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_AEAD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_aead</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aead_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setauthsize</span> <span class="o">=</span> <span class="n">aead_setauthsize</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">aead_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">aead_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">givencrypt</span> <span class="o">=</span> <span class="n">aead_givencrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;&lt;built-in&gt;&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">DES3_EDE_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxauthsize</span> <span class="o">=</span> <span class="n">MD5_DIGEST_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_3DES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_MD5</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC_PRECOMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_MD5</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;authenc(hmac(sha1),cbc(des3_ede))&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;authenc-hmac-sha1-cbc-des3_ede-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">DES3_EDE_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_AEAD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_aead</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aead_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setauthsize</span> <span class="o">=</span> <span class="n">aead_setauthsize</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">aead_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">aead_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">givencrypt</span> <span class="o">=</span> <span class="n">aead_givencrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;&lt;built-in&gt;&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">DES3_EDE_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxauthsize</span> <span class="o">=</span> <span class="n">SHA1_DIGEST_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_3DES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA1</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC_PRECOMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA1</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;authenc(hmac(sha224),cbc(des3_ede))&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;authenc-hmac-sha224-cbc-des3_ede-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">DES3_EDE_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_aead</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aead_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setauthsize</span> <span class="o">=</span> <span class="n">aead_setauthsize</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">aead_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">aead_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">givencrypt</span> <span class="o">=</span> <span class="n">aead_givencrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;&lt;built-in&gt;&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">DES3_EDE_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxauthsize</span> <span class="o">=</span> <span class="n">SHA224_DIGEST_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_3DES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA224</span> <span class="o">|</span>
				   <span class="n">OP_ALG_AAI_HMAC_PRECOMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA224</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;authenc(hmac(sha256),cbc(des3_ede))&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;authenc-hmac-sha256-cbc-des3_ede-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">DES3_EDE_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_AEAD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_aead</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aead_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setauthsize</span> <span class="o">=</span> <span class="n">aead_setauthsize</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">aead_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">aead_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">givencrypt</span> <span class="o">=</span> <span class="n">aead_givencrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;&lt;built-in&gt;&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">DES3_EDE_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxauthsize</span> <span class="o">=</span> <span class="n">SHA256_DIGEST_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_3DES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA256</span> <span class="o">|</span>
				   <span class="n">OP_ALG_AAI_HMAC_PRECOMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA256</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;authenc(hmac(sha384),cbc(des3_ede))&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;authenc-hmac-sha384-cbc-des3_ede-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">DES3_EDE_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_aead</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aead_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setauthsize</span> <span class="o">=</span> <span class="n">aead_setauthsize</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">aead_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">aead_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">givencrypt</span> <span class="o">=</span> <span class="n">aead_givencrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;&lt;built-in&gt;&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">DES3_EDE_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxauthsize</span> <span class="o">=</span> <span class="n">SHA384_DIGEST_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_3DES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA384</span> <span class="o">|</span>
				   <span class="n">OP_ALG_AAI_HMAC_PRECOMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA384</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;authenc(hmac(sha512),cbc(des3_ede))&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;authenc-hmac-sha512-cbc-des3_ede-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">DES3_EDE_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_AEAD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_aead</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aead_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setauthsize</span> <span class="o">=</span> <span class="n">aead_setauthsize</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">aead_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">aead_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">givencrypt</span> <span class="o">=</span> <span class="n">aead_givencrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;&lt;built-in&gt;&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">DES3_EDE_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxauthsize</span> <span class="o">=</span> <span class="n">SHA512_DIGEST_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_3DES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA512</span> <span class="o">|</span>
				   <span class="n">OP_ALG_AAI_HMAC_PRECOMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA512</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;authenc(hmac(md5),cbc(des))&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;authenc-hmac-md5-cbc-des-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">DES_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_AEAD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_aead</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aead_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setauthsize</span> <span class="o">=</span> <span class="n">aead_setauthsize</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">aead_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">aead_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">givencrypt</span> <span class="o">=</span> <span class="n">aead_givencrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;&lt;built-in&gt;&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">DES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxauthsize</span> <span class="o">=</span> <span class="n">MD5_DIGEST_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_DES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_MD5</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC_PRECOMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_MD5</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;authenc(hmac(sha1),cbc(des))&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;authenc-hmac-sha1-cbc-des-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">DES_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_AEAD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_aead</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aead_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setauthsize</span> <span class="o">=</span> <span class="n">aead_setauthsize</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">aead_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">aead_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">givencrypt</span> <span class="o">=</span> <span class="n">aead_givencrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;&lt;built-in&gt;&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">DES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxauthsize</span> <span class="o">=</span> <span class="n">SHA1_DIGEST_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_DES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA1</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC_PRECOMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA1</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;authenc(hmac(sha224),cbc(des))&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;authenc-hmac-sha224-cbc-des-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">DES_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_aead</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aead_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setauthsize</span> <span class="o">=</span> <span class="n">aead_setauthsize</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">aead_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">aead_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">givencrypt</span> <span class="o">=</span> <span class="n">aead_givencrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;&lt;built-in&gt;&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">DES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxauthsize</span> <span class="o">=</span> <span class="n">SHA224_DIGEST_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_DES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA224</span> <span class="o">|</span>
				   <span class="n">OP_ALG_AAI_HMAC_PRECOMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA224</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;authenc(hmac(sha256),cbc(des))&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;authenc-hmac-sha256-cbc-des-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">DES_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_AEAD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_aead</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aead_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setauthsize</span> <span class="o">=</span> <span class="n">aead_setauthsize</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">aead_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">aead_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">givencrypt</span> <span class="o">=</span> <span class="n">aead_givencrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;&lt;built-in&gt;&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">DES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxauthsize</span> <span class="o">=</span> <span class="n">SHA256_DIGEST_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_DES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA256</span> <span class="o">|</span>
				   <span class="n">OP_ALG_AAI_HMAC_PRECOMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA256</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;authenc(hmac(sha384),cbc(des))&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;authenc-hmac-sha384-cbc-des-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">DES_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_aead</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aead_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setauthsize</span> <span class="o">=</span> <span class="n">aead_setauthsize</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">aead_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">aead_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">givencrypt</span> <span class="o">=</span> <span class="n">aead_givencrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;&lt;built-in&gt;&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">DES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxauthsize</span> <span class="o">=</span> <span class="n">SHA384_DIGEST_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_DES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA384</span> <span class="o">|</span>
				   <span class="n">OP_ALG_AAI_HMAC_PRECOMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA384</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;authenc(hmac(sha512),cbc(des))&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;authenc-hmac-sha512-cbc-des-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">DES_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_AEAD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_aead</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aead_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">setauthsize</span> <span class="o">=</span> <span class="n">aead_setauthsize</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">aead_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">aead_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">givencrypt</span> <span class="o">=</span> <span class="n">aead_givencrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;&lt;built-in&gt;&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">DES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">maxauthsize</span> <span class="o">=</span> <span class="n">SHA512_DIGEST_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_DES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA512</span> <span class="o">|</span>
				   <span class="n">OP_ALG_AAI_HMAC_PRECOMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_SHA512</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_HMAC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* ablkcipher descriptor */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cbc(aes)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;cbc-aes-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_ABLKCIPHER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">ablkcipher_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">ablkcipher_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">ablkcipher_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;eseqiv&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">min_keysize</span> <span class="o">=</span> <span class="n">AES_MIN_KEY_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_keysize</span> <span class="o">=</span> <span class="n">AES_MAX_KEY_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_AES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cbc(des3_ede)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;cbc-3des-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">DES3_EDE_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_ABLKCIPHER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">ablkcipher_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">ablkcipher_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">ablkcipher_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;eseqiv&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">min_keysize</span> <span class="o">=</span> <span class="n">DES3_EDE_KEY_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_keysize</span> <span class="o">=</span> <span class="n">DES3_EDE_KEY_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">DES3_EDE_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_3DES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cbc(des)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;cbc-des-caam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">DES_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_ABLKCIPHER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">template_ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">ablkcipher_setkey</span><span class="p">,</span>
			<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">ablkcipher_encrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">ablkcipher_decrypt</span><span class="p">,</span>
			<span class="p">.</span><span class="n">geniv</span> <span class="o">=</span> <span class="s">&quot;eseqiv&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">min_keysize</span> <span class="o">=</span> <span class="n">DES_KEY_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_keysize</span> <span class="o">=</span> <span class="n">DES_KEY_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">DES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">.</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_ALG_ALGSEL_DES</span> <span class="o">|</span> <span class="n">OP_ALG_AAI_CBC</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">caam_crypto_alg</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">ctrldev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">class1_alg_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">class2_alg_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">alg_op</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_alg</span> <span class="n">crypto_alg</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">caam_cra_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_tfm</span> <span class="o">*</span><span class="n">tfm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_alg</span> <span class="o">*</span><span class="n">alg</span> <span class="o">=</span> <span class="n">tfm</span><span class="o">-&gt;</span><span class="n">__crt_alg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">caam_crypto_alg</span> <span class="o">*</span><span class="n">caam_alg</span> <span class="o">=</span>
		 <span class="n">container_of</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">caam_crypto_alg</span><span class="p">,</span> <span class="n">crypto_alg</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_tfm_ctx</span><span class="p">(</span><span class="n">tfm</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">caam_drv_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">caam_alg</span><span class="o">-&gt;</span><span class="n">ctrldev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tgt_jr</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tfm_count</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * distribute tfms across job rings to ensure in-order</span>
<span class="cm">	 * crypto request processing per tfm</span>
<span class="cm">	 */</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">jrdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">algapi_jr</span><span class="p">[(</span><span class="n">tgt_jr</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_jrs_for_algapi</span><span class="p">];</span>

	<span class="cm">/* copy descriptor header template value */</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">OP_TYPE_CLASS1_ALG</span> <span class="o">|</span> <span class="n">caam_alg</span><span class="o">-&gt;</span><span class="n">class1_alg_type</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">OP_TYPE_CLASS2_ALG</span> <span class="o">|</span> <span class="n">caam_alg</span><span class="o">-&gt;</span><span class="n">class2_alg_type</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">OP_TYPE_CLASS2_ALG</span> <span class="o">|</span> <span class="n">caam_alg</span><span class="o">-&gt;</span><span class="n">alg_op</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">caam_cra_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_tfm</span> <span class="o">*</span><span class="n">tfm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">caam_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_tfm_ctx</span><span class="p">(</span><span class="n">tfm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_enc_dma</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_enc_dma</span><span class="p">))</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_enc_dma</span><span class="p">,</span>
				 <span class="n">desc_bytes</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_enc</span><span class="p">),</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_dec_dma</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_dec_dma</span><span class="p">))</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_dec_dma</span><span class="p">,</span>
				 <span class="n">desc_bytes</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_dec</span><span class="p">),</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_givenc_dma</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_givenc_dma</span><span class="p">))</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">jrdev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_givenc_dma</span><span class="p">,</span>
				 <span class="n">desc_bytes</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh_desc_givenc</span><span class="p">),</span>
				 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">caam_algapi_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dev_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">ctrldev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">caam_drv_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">caam_crypto_alg</span> <span class="o">*</span><span class="n">t_alg</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev_node</span> <span class="o">=</span> <span class="n">of_find_compatible_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;fsl,sec-v4.0&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_node</span> <span class="o">=</span> <span class="n">of_find_compatible_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;fsl,sec4.0&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_node</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">of_find_device_by_node</span><span class="p">(</span><span class="n">dev_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ctrldev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">dev_node</span><span class="p">);</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">ctrldev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">alg_list</span><span class="p">.</span><span class="n">next</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">t_alg</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">alg_list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crypto_unregister_alg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t_alg</span><span class="o">-&gt;</span><span class="n">crypto_alg</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t_alg</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">t_alg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">total_jobrs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">caam_jr_deregister</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">algapi_jr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">algapi_jr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">caam_crypto_alg</span> <span class="o">*</span><span class="nf">caam_alg_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">ctrldev</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">caam_alg_template</span>
					      <span class="o">*</span><span class="n">template</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">caam_crypto_alg</span> <span class="o">*</span><span class="n">t_alg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_alg</span> <span class="o">*</span><span class="n">alg</span><span class="p">;</span>

	<span class="n">t_alg</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">caam_crypto_alg</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t_alg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ctrldev</span><span class="p">,</span> <span class="s">&quot;failed to allocate t_alg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">alg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t_alg</span><span class="o">-&gt;</span><span class="n">crypto_alg</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_name</span><span class="p">,</span> <span class="n">CRYPTO_MAX_ALG_NAME</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">template</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_driver_name</span><span class="p">,</span> <span class="n">CRYPTO_MAX_ALG_NAME</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
		 <span class="n">template</span><span class="o">-&gt;</span><span class="n">driver_name</span><span class="p">);</span>
	<span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_init</span> <span class="o">=</span> <span class="n">caam_cra_init</span><span class="p">;</span>
	<span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_exit</span> <span class="o">=</span> <span class="n">caam_cra_exit</span><span class="p">;</span>
	<span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_priority</span> <span class="o">=</span> <span class="n">CAAM_CRA_PRIORITY</span><span class="p">;</span>
	<span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_blocksize</span> <span class="o">=</span> <span class="n">template</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">;</span>
	<span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_alignmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_ctxsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">caam_ctx</span><span class="p">);</span>
	<span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_flags</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_ASYNC</span> <span class="o">|</span> <span class="n">CRYPTO_ALG_KERN_DRIVER_ONLY</span> <span class="o">|</span>
			 <span class="n">template</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">template</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CRYPTO_ALG_TYPE_ABLKCIPHER</span>:
		<span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crypto_ablkcipher_type</span><span class="p">;</span>
		<span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_ablkcipher</span> <span class="o">=</span> <span class="n">template</span><span class="o">-&gt;</span><span class="n">template_ablkcipher</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CRYPTO_ALG_TYPE_AEAD</span>:
		<span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crypto_aead_type</span><span class="p">;</span>
		<span class="n">alg</span><span class="o">-&gt;</span><span class="n">cra_aead</span> <span class="o">=</span> <span class="n">template</span><span class="o">-&gt;</span><span class="n">template_aead</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">t_alg</span><span class="o">-&gt;</span><span class="n">class1_alg_type</span> <span class="o">=</span> <span class="n">template</span><span class="o">-&gt;</span><span class="n">class1_alg_type</span><span class="p">;</span>
	<span class="n">t_alg</span><span class="o">-&gt;</span><span class="n">class2_alg_type</span> <span class="o">=</span> <span class="n">template</span><span class="o">-&gt;</span><span class="n">class2_alg_type</span><span class="p">;</span>
	<span class="n">t_alg</span><span class="o">-&gt;</span><span class="n">alg_op</span> <span class="o">=</span> <span class="n">template</span><span class="o">-&gt;</span><span class="n">alg_op</span><span class="p">;</span>
	<span class="n">t_alg</span><span class="o">-&gt;</span><span class="n">ctrldev</span> <span class="o">=</span> <span class="n">ctrldev</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">t_alg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">caam_algapi_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dev_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">ctrldev</span><span class="p">,</span> <span class="o">**</span><span class="n">jrdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">caam_drv_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_node</span> <span class="o">=</span> <span class="n">of_find_compatible_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;fsl,sec-v4.0&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_node</span> <span class="o">=</span> <span class="n">of_find_compatible_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;fsl,sec4.0&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_node</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">of_find_device_by_node</span><span class="p">(</span><span class="n">dev_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ctrldev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">ctrldev</span><span class="p">);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">dev_node</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">alg_list</span><span class="p">);</span>

	<span class="n">jrdev</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">jrdev</span><span class="p">)</span> <span class="o">*</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">total_jobrs</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jrdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">total_jobrs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">caam_jr_register</span><span class="p">(</span><span class="n">ctrldev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jrdev</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ctrldev</span><span class="p">,</span> <span class="s">&quot;algapi error in job ring registration: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">jrdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_jrs_for_algapi</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">algapi_jr</span> <span class="o">=</span> <span class="n">jrdev</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tfm_count</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* register crypto algorithms the device supports */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">driver_algs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TODO: check if h/w supports alg */</span>
		<span class="k">struct</span> <span class="n">caam_crypto_alg</span> <span class="o">*</span><span class="n">t_alg</span><span class="p">;</span>

		<span class="n">t_alg</span> <span class="o">=</span> <span class="n">caam_alg_alloc</span><span class="p">(</span><span class="n">ctrldev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_algs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">t_alg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">t_alg</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">ctrldev</span><span class="p">,</span> <span class="s">&quot;%s alg allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">driver_algs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">driver_name</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">crypto_register_alg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t_alg</span><span class="o">-&gt;</span><span class="n">crypto_alg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">ctrldev</span><span class="p">,</span> <span class="s">&quot;%s alg registration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">t_alg</span><span class="o">-&gt;</span><span class="n">crypto_alg</span><span class="p">.</span><span class="n">cra_driver_name</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">t_alg</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t_alg</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">alg_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">alg_list</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">ctrldev</span><span class="p">,</span> <span class="s">&quot;%s algorithms registered in /proc/crypto</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">dev_node</span><span class="p">,</span> <span class="s">&quot;compatible&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">caam_algapi_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">caam_algapi_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;FSL CAAM support for crypto API&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Freescale Semiconductor - NMG/STC&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
