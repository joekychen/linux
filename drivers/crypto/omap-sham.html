<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › crypto › omap-sham.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>omap-sham.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Cryptographic API.</span>
<span class="cm"> *</span>
<span class="cm"> * Support for OMAP SHA1/MD5 HW acceleration.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2010 Nokia Corporation</span>
<span class="cm"> * Author: Dmitry Kasatkin &lt;dmitry.kasatkin@nokia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as published</span>
<span class="cm"> * by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * Some ideas are from old omap-sha1-md5.c driver.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) &quot;%s: &quot; fmt, __func__</span>

<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/crypto.h&gt;</span>
<span class="cp">#include &lt;linux/cryptohash.h&gt;</span>
<span class="cp">#include &lt;crypto/scatterwalk.h&gt;</span>
<span class="cp">#include &lt;crypto/algapi.h&gt;</span>
<span class="cp">#include &lt;crypto/sha.h&gt;</span>
<span class="cp">#include &lt;crypto/hash.h&gt;</span>
<span class="cp">#include &lt;crypto/internal/hash.h&gt;</span>

<span class="cp">#include &lt;plat/cpu.h&gt;</span>
<span class="cp">#include &lt;plat/dma.h&gt;</span>
<span class="cp">#include &lt;mach/irqs.h&gt;</span>

<span class="cp">#define SHA_REG_DIGEST(x)		(0x00 + ((x) * 0x04))</span>
<span class="cp">#define SHA_REG_DIN(x)			(0x1C + ((x) * 0x04))</span>

<span class="cp">#define SHA1_MD5_BLOCK_SIZE		SHA1_BLOCK_SIZE</span>
<span class="cp">#define MD5_DIGEST_SIZE			16</span>

<span class="cp">#define SHA_REG_DIGCNT			0x14</span>

<span class="cp">#define SHA_REG_CTRL			0x18</span>
<span class="cp">#define SHA_REG_CTRL_LENGTH		(0xFFFFFFFF &lt;&lt; 5)</span>
<span class="cp">#define SHA_REG_CTRL_CLOSE_HASH		(1 &lt;&lt; 4)</span>
<span class="cp">#define SHA_REG_CTRL_ALGO_CONST		(1 &lt;&lt; 3)</span>
<span class="cp">#define SHA_REG_CTRL_ALGO		(1 &lt;&lt; 2)</span>
<span class="cp">#define SHA_REG_CTRL_INPUT_READY	(1 &lt;&lt; 1)</span>
<span class="cp">#define SHA_REG_CTRL_OUTPUT_READY	(1 &lt;&lt; 0)</span>

<span class="cp">#define SHA_REG_REV			0x5C</span>
<span class="cp">#define SHA_REG_REV_MAJOR		0xF0</span>
<span class="cp">#define SHA_REG_REV_MINOR		0x0F</span>

<span class="cp">#define SHA_REG_MASK			0x60</span>
<span class="cp">#define SHA_REG_MASK_DMA_EN		(1 &lt;&lt; 3)</span>
<span class="cp">#define SHA_REG_MASK_IT_EN		(1 &lt;&lt; 2)</span>
<span class="cp">#define SHA_REG_MASK_SOFTRESET		(1 &lt;&lt; 1)</span>
<span class="cp">#define SHA_REG_AUTOIDLE		(1 &lt;&lt; 0)</span>

<span class="cp">#define SHA_REG_SYSSTATUS		0x64</span>
<span class="cp">#define SHA_REG_SYSSTATUS_RESETDONE	(1 &lt;&lt; 0)</span>

<span class="cp">#define DEFAULT_TIMEOUT_INTERVAL	HZ</span>

<span class="cm">/* mostly device flags */</span>
<span class="cp">#define FLAGS_BUSY		0</span>
<span class="cp">#define FLAGS_FINAL		1</span>
<span class="cp">#define FLAGS_DMA_ACTIVE	2</span>
<span class="cp">#define FLAGS_OUTPUT_READY	3</span>
<span class="cp">#define FLAGS_INIT		4</span>
<span class="cp">#define FLAGS_CPU		5</span>
<span class="cp">#define FLAGS_DMA_READY		6</span>
<span class="cm">/* context flags */</span>
<span class="cp">#define FLAGS_FINUP		16</span>
<span class="cp">#define FLAGS_SG		17</span>
<span class="cp">#define FLAGS_SHA1		18</span>
<span class="cp">#define FLAGS_HMAC		19</span>
<span class="cp">#define FLAGS_ERROR		20</span>

<span class="cp">#define OP_UPDATE	1</span>
<span class="cp">#define OP_FINAL	2</span>

<span class="cp">#define OMAP_ALIGN_MASK		(sizeof(u32)-1)</span>
<span class="cp">#define OMAP_ALIGNED		__attribute__((aligned(sizeof(u32))))</span>

<span class="cp">#define BUFLEN		PAGE_SIZE</span>

<span class="k">struct</span> <span class="n">omap_sham_dev</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_dev</span>	<span class="o">*</span><span class="n">dd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">op</span><span class="p">;</span>

	<span class="n">u8</span>			<span class="n">digest</span><span class="p">[</span><span class="n">SHA1_DIGEST_SIZE</span><span class="p">]</span> <span class="n">OMAP_ALIGNED</span><span class="p">;</span>
	<span class="kt">size_t</span>			<span class="n">digcnt</span><span class="p">;</span>
	<span class="kt">size_t</span>			<span class="n">bufcnt</span><span class="p">;</span>
	<span class="kt">size_t</span>			<span class="n">buflen</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">dma_addr</span><span class="p">;</span>

	<span class="cm">/* walk state */</span>
	<span class="k">struct</span> <span class="n">scatterlist</span>	<span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">offset</span><span class="p">;</span>	<span class="cm">/* offset in current sg */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">total</span><span class="p">;</span>	<span class="cm">/* total request */</span>

	<span class="n">u8</span>			<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="n">OMAP_ALIGNED</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">omap_sham_hmac_ctx</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_shash</span>	<span class="o">*</span><span class="n">shash</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">ipad</span><span class="p">[</span><span class="n">SHA1_MD5_BLOCK_SIZE</span><span class="p">];</span>
	<span class="n">u8</span>			<span class="n">opad</span><span class="p">[</span><span class="n">SHA1_MD5_BLOCK_SIZE</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">omap_sham_ctx</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_dev</span>	<span class="o">*</span><span class="n">dd</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* fallback stuff */</span>
	<span class="k">struct</span> <span class="n">crypto_shash</span>	<span class="o">*</span><span class="n">fallback</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">omap_sham_hmac_ctx</span> <span class="n">base</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define OMAP_SHAM_QUEUE_LENGTH	1</span>

<span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">phys_base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">io_base</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>		<span class="o">*</span><span class="n">iclk</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">dma</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">dma_lch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span>	<span class="n">done_task</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_queue</span>	<span class="n">queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahash_request</span>	<span class="o">*</span><span class="n">req</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">omap_sham_drv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">dev_list</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">omap_sham_drv</span> <span class="n">sham</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dev_list</span> <span class="o">=</span> <span class="n">LIST_HEAD_INIT</span><span class="p">(</span><span class="n">sham</span><span class="p">.</span><span class="n">dev_list</span><span class="p">),</span>
	<span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">__SPIN_LOCK_UNLOCKED</span><span class="p">(</span><span class="n">sham</span><span class="p">.</span><span class="n">lock</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">omap_sham_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">omap_sham_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">omap_sham_write_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">omap_sham_read</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">omap_sham_write</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">omap_sham_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">DEFAULT_TIMEOUT_INTERVAL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">omap_sham_read</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_is_before_jiffies</span><span class="p">(</span><span class="n">timeout</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_sham_copy_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahash_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">hash</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">digest</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* MD5 is almost unused. So copy sha1 size to reduce code */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SHA1_DIGEST_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span>
			<span class="n">hash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">omap_sham_read</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span>
						<span class="n">SHA_REG_DIGEST</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">omap_sham_write</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">,</span>
					<span class="n">SHA_REG_DIGEST</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">hash</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_sham_copy_ready_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahash_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">in</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">digest</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">hash</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hash</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_SHA1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* SHA1 results are in big endian */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SHA1_DIGEST_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">hash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">in</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* MD5 results are in little endian */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MD5_DIGEST_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">hash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">in</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAGS_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">omap_sham_write_mask</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">SHA_REG_MASK</span><span class="p">,</span>
			<span class="n">SHA_REG_MASK_SOFTRESET</span><span class="p">,</span> <span class="n">SHA_REG_MASK_SOFTRESET</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">omap_sham_wait</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">SHA_REG_SYSSTATUS</span><span class="p">,</span>
					<span class="n">SHA_REG_SYSSTATUS_RESETDONE</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAGS_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_sham_write_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">final</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">length</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">digcnt</span><span class="p">))</span>
		<span class="n">omap_sham_write</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">SHA_REG_DIGCNT</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">digcnt</span><span class="p">);</span>

	<span class="n">omap_sham_write_mask</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">SHA_REG_MASK</span><span class="p">,</span>
		<span class="n">SHA_REG_MASK_IT_EN</span> <span class="o">|</span> <span class="p">(</span><span class="n">dma</span> <span class="o">?</span> <span class="n">SHA_REG_MASK_DMA_EN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">SHA_REG_MASK_IT_EN</span> <span class="o">|</span> <span class="n">SHA_REG_MASK_DMA_EN</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Setting ALGO_CONST only for the first iteration</span>
<span class="cm">	 * and CLOSE_HASH only for the last one.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_SHA1</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">SHA_REG_CTRL_ALGO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">digcnt</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">SHA_REG_CTRL_ALGO_CONST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">final</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">SHA_REG_CTRL_CLOSE_HASH</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">SHA_REG_CTRL_ALGO_CONST</span> <span class="o">|</span> <span class="n">SHA_REG_CTRL_CLOSE_HASH</span> <span class="o">|</span>
			<span class="n">SHA_REG_CTRL_ALGO</span> <span class="o">|</span> <span class="n">SHA_REG_CTRL_LENGTH</span><span class="p">;</span>

	<span class="n">omap_sham_write_mask</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">SHA_REG_CTRL</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_xmit_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">final</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">len32</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;xmit_cpu: digcnt: %d, length: %d, final: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">digcnt</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">final</span><span class="p">);</span>

	<span class="n">omap_sham_write_ctrl</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">final</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* should be non-zero before next lines to disable clocks later */</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">digcnt</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">omap_sham_wait</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">SHA_REG_CTRL</span><span class="p">,</span> <span class="n">SHA_REG_CTRL_INPUT_READY</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">final</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAGS_FINAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span> <span class="cm">/* catch last interrupt */</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAGS_CPU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">len32</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">len32</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span>
		<span class="n">omap_sham_write</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">SHA_REG_DIN</span><span class="p">(</span><span class="n">count</span><span class="p">),</span> <span class="n">buffer</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_xmit_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">final</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len32</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;xmit_dma: digcnt: %d, length: %d, final: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">digcnt</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">final</span><span class="p">);</span>

	<span class="n">len32</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="n">omap_set_dma_transfer_params</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dma_lch</span><span class="p">,</span> <span class="n">OMAP_DMA_DATA_TYPE_S32</span><span class="p">,</span> <span class="n">len32</span><span class="p">,</span>
			<span class="mi">1</span><span class="p">,</span> <span class="n">OMAP_DMA_SYNC_PACKET</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
				<span class="n">OMAP_DMA_DST_SYNC_PREFETCH</span><span class="p">);</span>

	<span class="n">omap_set_dma_src_params</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dma_lch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OMAP_DMA_AMODE_POST_INC</span><span class="p">,</span>
				<span class="n">dma_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">omap_sham_write_ctrl</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">final</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">digcnt</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">final</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAGS_FINAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span> <span class="cm">/* catch last interrupt */</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAGS_DMA_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">omap_start_dma</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dma_lch</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">omap_sham_append_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">-</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">omap_sham_append_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">omap_sham_append_buffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span>
				<span class="n">sg_virt</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">==</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_xmit_dma_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
					<span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">final</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="p">,</span>
				       <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dma %u bytes error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_SG</span><span class="p">);</span>

	<span class="cm">/* next call does not fail... so no unmap in the case of error */</span>
	<span class="k">return</span> <span class="n">omap_sham_xmit_dma</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">final</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_update_dma_slow</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">final</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">omap_sham_append_sg</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>

	<span class="n">final</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_FINUP</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;slow: bufcnt: %u, digcnt: %d, final: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">digcnt</span><span class="p">,</span> <span class="n">final</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">final</span> <span class="o">||</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span> <span class="o">==</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">omap_sham_xmit_dma_map</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">final</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Start address alignment */</span>
<span class="cp">#define SG_AA(sg)	(IS_ALIGNED(sg-&gt;offset, sizeof(u32)))</span>
<span class="cm">/* SHA1 block size alignment */</span>
<span class="cp">#define SG_SA(sg)	(IS_ALIGNED(sg-&gt;length, SHA1_MD5_BLOCK_SIZE))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_update_dma_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">final</span><span class="p">,</span> <span class="n">tail</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span> <span class="o">||</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">omap_sham_update_dma_slow</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fast: digcnt: %d, bufcnt: %u, total: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">digcnt</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">);</span>

	<span class="n">sg</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SG_AA</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">omap_sham_update_dma_slow</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sg_is_last</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">SG_SA</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span>
		<span class="cm">/* size is not SHA1_BLOCK_SIZE aligned */</span>
		<span class="k">return</span> <span class="n">omap_sham_update_dma_slow</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">,</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sg_is_last</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_FINUP</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* not last sg must be SHA1_MD5_BLOCK_SIZE aligned */</span>
			<span class="n">tail</span> <span class="o">=</span> <span class="n">length</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SHA1_MD5_BLOCK_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* without finup() we need one block to close hash */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tail</span><span class="p">)</span>
				<span class="n">tail</span> <span class="o">=</span> <span class="n">SHA1_MD5_BLOCK_SIZE</span><span class="p">;</span>
			<span class="n">length</span> <span class="o">-=</span> <span class="n">tail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_map_sg</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dma_map_sg  error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_SG</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total</span> <span class="o">-=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span> <span class="cm">/* offset where to start slow */</span>

	<span class="n">final</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_FINUP</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">;</span>

	<span class="cm">/* next call does not fail... so no unmap in the case of error */</span>
	<span class="k">return</span> <span class="n">omap_sham_xmit_dma</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">),</span> <span class="n">length</span><span class="p">,</span> <span class="n">final</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_update_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">bufcnt</span><span class="p">;</span>

	<span class="n">omap_sham_append_sg</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">bufcnt</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">omap_sham_xmit_cpu</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">bufcnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_update_dma_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>

	<span class="n">omap_stop_dma</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dma_lch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_SG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="p">,</span>
				 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahash_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_ahash</span> <span class="o">*</span><span class="n">tfm</span> <span class="o">=</span> <span class="n">crypto_ahash_reqtfm</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_sham_ctx</span> <span class="o">*</span><span class="n">tctx</span> <span class="o">=</span> <span class="n">crypto_ahash_ctx</span><span class="p">(</span><span class="n">tfm</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sham</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sham</span><span class="p">.</span><span class="n">dev_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dd</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tctx</span><span class="o">-&gt;</span><span class="n">dd</span> <span class="o">=</span> <span class="n">dd</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dd</span> <span class="o">=</span> <span class="n">tctx</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sham</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dd</span> <span class="o">=</span> <span class="n">dd</span><span class="p">;</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;init: digest size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">crypto_ahash_digestsize</span><span class="p">(</span><span class="n">tfm</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crypto_ahash_digestsize</span><span class="p">(</span><span class="n">tfm</span><span class="p">)</span> <span class="o">==</span> <span class="n">SHA1_DIGEST_SIZE</span><span class="p">)</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_SHA1</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">digcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">BUFLEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_HMAC</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_sham_hmac_ctx</span> <span class="o">*</span><span class="n">bctx</span> <span class="o">=</span> <span class="n">tctx</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">bctx</span><span class="o">-&gt;</span><span class="n">ipad</span><span class="p">,</span> <span class="n">SHA1_MD5_BLOCK_SIZE</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span> <span class="o">=</span> <span class="n">SHA1_MD5_BLOCK_SIZE</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_HMAC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_update_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahash_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;update_req: total: %u, digcnt: %d, finup: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">digcnt</span><span class="p">,</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_FINUP</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_CPU</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">omap_sham_update_cpu</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">omap_sham_update_dma_start</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>

	<span class="cm">/* wait for dma completion before can take more data */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;update: err: %d, digcnt: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">digcnt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_final_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahash_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">use_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">)</span>
		<span class="cm">/* faster to handle last block with cpu */</span>
		<span class="n">use_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">omap_sham_xmit_dma_map</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">omap_sham_xmit_cpu</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;final_req: err: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_finish_hmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahash_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_ctx</span> <span class="o">*</span><span class="n">tctx</span> <span class="o">=</span> <span class="n">crypto_tfm_ctx</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">tfm</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_sham_hmac_ctx</span> <span class="o">*</span><span class="n">bctx</span> <span class="o">=</span> <span class="n">tctx</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bs</span> <span class="o">=</span> <span class="n">crypto_shash_blocksize</span><span class="p">(</span><span class="n">bctx</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ds</span> <span class="o">=</span> <span class="n">crypto_shash_digestsize</span><span class="p">(</span><span class="n">bctx</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">);</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">shash_desc</span> <span class="n">shash</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">ctx</span><span class="p">[</span><span class="n">crypto_shash_descsize</span><span class="p">(</span><span class="n">bctx</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">)];</span>
	<span class="p">}</span> <span class="n">desc</span><span class="p">;</span>

	<span class="n">desc</span><span class="p">.</span><span class="n">shash</span><span class="p">.</span><span class="n">tfm</span> <span class="o">=</span> <span class="n">bctx</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">;</span>
	<span class="n">desc</span><span class="p">.</span><span class="n">shash</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not CRYPTO_TFM_REQ_MAY_SLEEP */</span>

	<span class="k">return</span> <span class="n">crypto_shash_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">.</span><span class="n">shash</span><span class="p">)</span> <span class="o">?:</span>
	       <span class="n">crypto_shash_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">.</span><span class="n">shash</span><span class="p">,</span> <span class="n">bctx</span><span class="o">-&gt;</span><span class="n">opad</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span> <span class="o">?:</span>
	       <span class="n">crypto_shash_finup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">.</span><span class="n">shash</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahash_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">digcnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_sham_copy_ready_hash</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_HMAC</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">omap_sham_finish_hmac</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;digcnt: %d, bufcnt: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">digcnt</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_sham_finish_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahash_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_sham_copy_hash</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAGS_FINAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">omap_sham_finish</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* atomic operation is not needed here */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_BUSY</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_FINAL</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_CPU</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_DMA_READY</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_OUTPUT_READY</span><span class="p">));</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">complete</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="cm">/* handle new request */</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">done_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_handle_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ahash_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_async_request</span> <span class="o">*</span><span class="n">async_req</span><span class="p">,</span> <span class="o">*</span><span class="n">backlog</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ahash_enqueue_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAGS_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">backlog</span> <span class="o">=</span> <span class="n">crypto_get_backlog</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">async_req</span> <span class="o">=</span> <span class="n">crypto_dequeue_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">async_req</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAGS_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">async_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">backlog</span><span class="p">)</span>
		<span class="n">backlog</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">(</span><span class="n">backlog</span><span class="p">,</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">ahash_request_cast</span><span class="p">(</span><span class="n">async_req</span><span class="p">);</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;handling new req, op: %lu, nbytes: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">omap_sham_hw_init</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

	<span class="n">omap_set_dma_dest_params</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dma_lch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">OMAP_DMA_AMODE_CONSTANT</span><span class="p">,</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">phys_base</span> <span class="o">+</span> <span class="n">SHA_REG_DIN</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">omap_set_dma_dest_burst_mode</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dma_lch</span><span class="p">,</span>
			<span class="n">OMAP_DMA_DATA_BURST_16</span><span class="p">);</span>

	<span class="n">omap_set_dma_src_burst_mode</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dma_lch</span><span class="p">,</span>
			<span class="n">OMAP_DMA_DATA_BURST_4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">digcnt</span><span class="p">)</span>
		<span class="cm">/* request has changed - restore hash */</span>
		<span class="n">omap_sham_copy_hash</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">OP_UPDATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">omap_sham_update_req</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINPROGRESS</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_FINUP</span><span class="p">)))</span>
			<span class="cm">/* no final() after finup() */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">omap_sham_final_req</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">OP_FINAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">omap_sham_final_req</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">err1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
		<span class="cm">/* done_task will not finish it, so do it here */</span>
		<span class="n">omap_sham_finish_req</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;exit, err: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_enqueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahash_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_sham_ctx</span> <span class="o">*</span><span class="n">tctx</span> <span class="o">=</span> <span class="n">crypto_tfm_ctx</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">tfm</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">tctx</span><span class="o">-&gt;</span><span class="n">dd</span><span class="p">;</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">omap_sham_handle_queue</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahash_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_FINUP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">digcnt</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			* OMAP HW accel works only with buffers &gt;= 9</span>
<span class="cm">			* will switch to bypass in final()</span>
<span class="cm">			* final has the same request and data</span>
<span class="cm">			*/</span>
			<span class="n">omap_sham_append_sg</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total</span> <span class="o">&lt;=</span> <span class="n">SHA1_MD5_BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			* faster to use CPU for short transfers</span>
<span class="cm">			*/</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_CPU</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">total</span> <span class="o">&lt;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_sham_append_sg</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">omap_sham_enqueue</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">OP_UPDATE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_shash_digest</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_shash</span> <span class="o">*</span><span class="n">shash</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span>
				  <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">shash_desc</span> <span class="n">shash</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">ctx</span><span class="p">[</span><span class="n">crypto_shash_descsize</span><span class="p">(</span><span class="n">shash</span><span class="p">)];</span>
	<span class="p">}</span> <span class="n">desc</span><span class="p">;</span>

	<span class="n">desc</span><span class="p">.</span><span class="n">shash</span><span class="p">.</span><span class="n">tfm</span> <span class="o">=</span> <span class="n">shash</span><span class="p">;</span>
	<span class="n">desc</span><span class="p">.</span><span class="n">shash</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CRYPTO_TFM_REQ_MAY_SLEEP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">crypto_shash_digest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">.</span><span class="n">shash</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_final_shash</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahash_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_ctx</span> <span class="o">*</span><span class="n">tctx</span> <span class="o">=</span> <span class="n">crypto_tfm_ctx</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">tfm</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">omap_sham_shash_digest</span><span class="p">(</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">fallback</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span>
				      <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_final</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahash_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_FINUP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_ERROR</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* uncompleted hash is not needed */</span>

	<span class="cm">/* OMAP HW accel works only with buffers &gt;= 9 */</span>
	<span class="cm">/* HMAC is always &gt;= 9 because ipad == block size */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">digcnt</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">omap_sham_final_shash</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bufcnt</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">omap_sham_enqueue</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">OP_FINAL</span><span class="p">);</span>

	<span class="cm">/* copy ready hash (+ finalize hmac) */</span>
	<span class="k">return</span> <span class="n">omap_sham_finish</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_finup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahash_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_reqctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ahash_request_ctx</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err1</span><span class="p">,</span> <span class="n">err2</span><span class="p">;</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_FINUP</span><span class="p">);</span>

	<span class="n">err1</span> <span class="o">=</span> <span class="n">omap_sham_update</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err1</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span> <span class="o">||</span> <span class="n">err1</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err1</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * final() has to be always called to cleanup resources</span>
<span class="cm">	 * even if udpate() failed, except EINPROGRESS</span>
<span class="cm">	 */</span>
	<span class="n">err2</span> <span class="o">=</span> <span class="n">omap_sham_final</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err1</span> <span class="o">?:</span> <span class="n">err2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_digest</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahash_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">omap_sham_init</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">?:</span> <span class="n">omap_sham_finup</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_setkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_ahash</span> <span class="o">*</span><span class="n">tfm</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keylen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_ctx</span> <span class="o">*</span><span class="n">tctx</span> <span class="o">=</span> <span class="n">crypto_ahash_ctx</span><span class="p">(</span><span class="n">tfm</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_sham_hmac_ctx</span> <span class="o">*</span><span class="n">bctx</span> <span class="o">=</span> <span class="n">tctx</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bs</span> <span class="o">=</span> <span class="n">crypto_shash_blocksize</span><span class="p">(</span><span class="n">bctx</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ds</span> <span class="o">=</span> <span class="n">crypto_shash_digestsize</span><span class="p">(</span><span class="n">bctx</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">crypto_shash_setkey</span><span class="p">(</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">fallback</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">keylen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">keylen</span> <span class="o">&gt;</span> <span class="n">bs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">omap_sham_shash_digest</span><span class="p">(</span><span class="n">bctx</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">,</span>
				<span class="n">crypto_shash_get_flags</span><span class="p">(</span><span class="n">bctx</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">),</span>
				<span class="n">key</span><span class="p">,</span> <span class="n">keylen</span><span class="p">,</span> <span class="n">bctx</span><span class="o">-&gt;</span><span class="n">ipad</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">keylen</span> <span class="o">=</span> <span class="n">ds</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bctx</span><span class="o">-&gt;</span><span class="n">ipad</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">keylen</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">bctx</span><span class="o">-&gt;</span><span class="n">ipad</span> <span class="o">+</span> <span class="n">keylen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bs</span> <span class="o">-</span> <span class="n">keylen</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bctx</span><span class="o">-&gt;</span><span class="n">opad</span><span class="p">,</span> <span class="n">bctx</span><span class="o">-&gt;</span><span class="n">ipad</span><span class="p">,</span> <span class="n">bs</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bctx</span><span class="o">-&gt;</span><span class="n">ipad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0x36</span><span class="p">;</span>
		<span class="n">bctx</span><span class="o">-&gt;</span><span class="n">opad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0x5c</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_cra_init_alg</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_tfm</span> <span class="o">*</span><span class="n">tfm</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alg_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_ctx</span> <span class="o">*</span><span class="n">tctx</span> <span class="o">=</span> <span class="n">crypto_tfm_ctx</span><span class="p">(</span><span class="n">tfm</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alg_name</span> <span class="o">=</span> <span class="n">crypto_tfm_alg_name</span><span class="p">(</span><span class="n">tfm</span><span class="p">);</span>

	<span class="cm">/* Allocate a fallback and abort if it failed. */</span>
	<span class="n">tctx</span><span class="o">-&gt;</span><span class="n">fallback</span> <span class="o">=</span> <span class="n">crypto_alloc_shash</span><span class="p">(</span><span class="n">alg_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">CRYPTO_ALG_NEED_FALLBACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">fallback</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;omap-sham: fallback driver &#39;%s&#39; &quot;</span>
				<span class="s">&quot;could not be loaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">alg_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">fallback</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">crypto_ahash_set_reqsize</span><span class="p">(</span><span class="n">__crypto_ahash_cast</span><span class="p">(</span><span class="n">tfm</span><span class="p">),</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_reqctx</span><span class="p">)</span> <span class="o">+</span> <span class="n">BUFLEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alg_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_sham_hmac_ctx</span> <span class="o">*</span><span class="n">bctx</span> <span class="o">=</span> <span class="n">tctx</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
		<span class="n">tctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_HMAC</span><span class="p">);</span>
		<span class="n">bctx</span><span class="o">-&gt;</span><span class="n">shash</span> <span class="o">=</span> <span class="n">crypto_alloc_shash</span><span class="p">(</span><span class="n">alg_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">CRYPTO_ALG_NEED_FALLBACK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bctx</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;omap-sham: base driver &#39;%s&#39; &quot;</span>
					<span class="s">&quot;could not be loaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">alg_base</span><span class="p">);</span>
			<span class="n">crypto_free_shash</span><span class="p">(</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">fallback</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bctx</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_cra_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_tfm</span> <span class="o">*</span><span class="n">tfm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">omap_sham_cra_init_alg</span><span class="p">(</span><span class="n">tfm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_cra_sha1_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_tfm</span> <span class="o">*</span><span class="n">tfm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">omap_sham_cra_init_alg</span><span class="p">(</span><span class="n">tfm</span><span class="p">,</span> <span class="s">&quot;sha1&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_cra_md5_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_tfm</span> <span class="o">*</span><span class="n">tfm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">omap_sham_cra_init_alg</span><span class="p">(</span><span class="n">tfm</span><span class="p">,</span> <span class="s">&quot;md5&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_sham_cra_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_tfm</span> <span class="o">*</span><span class="n">tfm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_ctx</span> <span class="o">*</span><span class="n">tctx</span> <span class="o">=</span> <span class="n">crypto_tfm_ctx</span><span class="p">(</span><span class="n">tfm</span><span class="p">);</span>

	<span class="n">crypto_free_shash</span><span class="p">(</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">fallback</span><span class="p">);</span>
	<span class="n">tctx</span><span class="o">-&gt;</span><span class="n">fallback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FLAGS_HMAC</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_sham_hmac_ctx</span> <span class="o">*</span><span class="n">bctx</span> <span class="o">=</span> <span class="n">tctx</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
		<span class="n">crypto_free_shash</span><span class="p">(</span><span class="n">bctx</span><span class="o">-&gt;</span><span class="n">shash</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ahash_alg</span> <span class="n">algs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">omap_sham_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update</span>		<span class="o">=</span> <span class="n">omap_sham_update</span><span class="p">,</span>
	<span class="p">.</span><span class="n">final</span>		<span class="o">=</span> <span class="n">omap_sham_final</span><span class="p">,</span>
	<span class="p">.</span><span class="n">finup</span>		<span class="o">=</span> <span class="n">omap_sham_finup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">digest</span>		<span class="o">=</span> <span class="n">omap_sham_digest</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halg</span><span class="p">.</span><span class="n">digestsize</span>	<span class="o">=</span> <span class="n">SHA1_DIGEST_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halg</span><span class="p">.</span><span class="n">base</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cra_name</span>		<span class="o">=</span> <span class="s">&quot;sha1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_driver_name</span>	<span class="o">=</span> <span class="s">&quot;omap-sha1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_priority</span>		<span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_flags</span>		<span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_AHASH</span> <span class="o">|</span>
						<span class="n">CRYPTO_ALG_KERN_DRIVER_ONLY</span> <span class="o">|</span>
						<span class="n">CRYPTO_ALG_ASYNC</span> <span class="o">|</span>
						<span class="n">CRYPTO_ALG_NEED_FALLBACK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_blocksize</span>		<span class="o">=</span> <span class="n">SHA1_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_ctxsize</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_ctx</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cra_alignmask</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_init</span>		<span class="o">=</span> <span class="n">omap_sham_cra_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_exit</span>		<span class="o">=</span> <span class="n">omap_sham_cra_exit</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">},</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">omap_sham_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update</span>		<span class="o">=</span> <span class="n">omap_sham_update</span><span class="p">,</span>
	<span class="p">.</span><span class="n">final</span>		<span class="o">=</span> <span class="n">omap_sham_final</span><span class="p">,</span>
	<span class="p">.</span><span class="n">finup</span>		<span class="o">=</span> <span class="n">omap_sham_finup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">digest</span>		<span class="o">=</span> <span class="n">omap_sham_digest</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halg</span><span class="p">.</span><span class="n">digestsize</span>	<span class="o">=</span> <span class="n">MD5_DIGEST_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halg</span><span class="p">.</span><span class="n">base</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cra_name</span>		<span class="o">=</span> <span class="s">&quot;md5&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_driver_name</span>	<span class="o">=</span> <span class="s">&quot;omap-md5&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_priority</span>		<span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_flags</span>		<span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_AHASH</span> <span class="o">|</span>
						<span class="n">CRYPTO_ALG_KERN_DRIVER_ONLY</span> <span class="o">|</span>
						<span class="n">CRYPTO_ALG_ASYNC</span> <span class="o">|</span>
						<span class="n">CRYPTO_ALG_NEED_FALLBACK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_blocksize</span>		<span class="o">=</span> <span class="n">SHA1_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_ctxsize</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_ctx</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cra_alignmask</span>		<span class="o">=</span> <span class="n">OMAP_ALIGN_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_init</span>		<span class="o">=</span> <span class="n">omap_sham_cra_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_exit</span>		<span class="o">=</span> <span class="n">omap_sham_cra_exit</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">},</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">omap_sham_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update</span>		<span class="o">=</span> <span class="n">omap_sham_update</span><span class="p">,</span>
	<span class="p">.</span><span class="n">final</span>		<span class="o">=</span> <span class="n">omap_sham_final</span><span class="p">,</span>
	<span class="p">.</span><span class="n">finup</span>		<span class="o">=</span> <span class="n">omap_sham_finup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">digest</span>		<span class="o">=</span> <span class="n">omap_sham_digest</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setkey</span>		<span class="o">=</span> <span class="n">omap_sham_setkey</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halg</span><span class="p">.</span><span class="n">digestsize</span>	<span class="o">=</span> <span class="n">SHA1_DIGEST_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halg</span><span class="p">.</span><span class="n">base</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cra_name</span>		<span class="o">=</span> <span class="s">&quot;hmac(sha1)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_driver_name</span>	<span class="o">=</span> <span class="s">&quot;omap-hmac-sha1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_priority</span>		<span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_flags</span>		<span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_AHASH</span> <span class="o">|</span>
						<span class="n">CRYPTO_ALG_KERN_DRIVER_ONLY</span> <span class="o">|</span>
						<span class="n">CRYPTO_ALG_ASYNC</span> <span class="o">|</span>
						<span class="n">CRYPTO_ALG_NEED_FALLBACK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_blocksize</span>		<span class="o">=</span> <span class="n">SHA1_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_ctxsize</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_ctx</span><span class="p">)</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_hmac_ctx</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cra_alignmask</span>		<span class="o">=</span> <span class="n">OMAP_ALIGN_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_init</span>		<span class="o">=</span> <span class="n">omap_sham_cra_sha1_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_exit</span>		<span class="o">=</span> <span class="n">omap_sham_cra_exit</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">},</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">omap_sham_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update</span>		<span class="o">=</span> <span class="n">omap_sham_update</span><span class="p">,</span>
	<span class="p">.</span><span class="n">final</span>		<span class="o">=</span> <span class="n">omap_sham_final</span><span class="p">,</span>
	<span class="p">.</span><span class="n">finup</span>		<span class="o">=</span> <span class="n">omap_sham_finup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">digest</span>		<span class="o">=</span> <span class="n">omap_sham_digest</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setkey</span>		<span class="o">=</span> <span class="n">omap_sham_setkey</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halg</span><span class="p">.</span><span class="n">digestsize</span>	<span class="o">=</span> <span class="n">MD5_DIGEST_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halg</span><span class="p">.</span><span class="n">base</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cra_name</span>		<span class="o">=</span> <span class="s">&quot;hmac(md5)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_driver_name</span>	<span class="o">=</span> <span class="s">&quot;omap-hmac-md5&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_priority</span>		<span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_flags</span>		<span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_AHASH</span> <span class="o">|</span>
						<span class="n">CRYPTO_ALG_KERN_DRIVER_ONLY</span> <span class="o">|</span>
						<span class="n">CRYPTO_ALG_ASYNC</span> <span class="o">|</span>
						<span class="n">CRYPTO_ALG_NEED_FALLBACK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_blocksize</span>		<span class="o">=</span> <span class="n">SHA1_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_ctxsize</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_ctx</span><span class="p">)</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_hmac_ctx</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cra_alignmask</span>		<span class="o">=</span> <span class="n">OMAP_ALIGN_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_init</span>		<span class="o">=</span> <span class="n">omap_sham_cra_md5_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cra_exit</span>		<span class="o">=</span> <span class="n">omap_sham_cra_exit</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_sham_done_task</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAGS_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">omap_sham_handle_queue</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAGS_CPU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLAGS_OUTPUT_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAGS_DMA_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLAGS_DMA_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">omap_sham_update_dma_stop</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">err</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLAGS_OUTPUT_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* hash or semi-hash ready */</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">FLAGS_DMA_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">omap_sham_update_dma_start</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">finish:</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;update done: err: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="cm">/* finish curent request */</span>
	<span class="n">omap_sham_finish_req</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">omap_sham_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAGS_FINAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span>
		<span class="cm">/* final -&gt; allow device to go to power-saving mode */</span>
		<span class="n">omap_sham_write_mask</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">SHA_REG_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SHA_REG_CTRL_LENGTH</span><span class="p">);</span>

	<span class="n">omap_sham_write_mask</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">SHA_REG_CTRL</span><span class="p">,</span> <span class="n">SHA_REG_CTRL_OUTPUT_READY</span><span class="p">,</span>
				 <span class="n">SHA_REG_CTRL_OUTPUT_READY</span><span class="p">);</span>
	<span class="n">omap_sham_read</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">SHA_REG_CTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAGS_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Interrupt when no active requests.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAGS_OUTPUT_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">done_task</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_sham_dma_callback</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ch_status</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch_status</span> <span class="o">!=</span> <span class="n">OMAP_DMA_BLOCK_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;omap-sham DMA error status: 0x%hx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch_status</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FLAGS_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span><span class="cm">/* request to re-initialize */</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAGS_DMA_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">done_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_sham_dma_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">dma_lch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">omap_request_dma</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			<span class="n">omap_sham_dma_callback</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dma_lch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to request DMA channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_sham_dma_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dma_lch</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_free_dma</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dma_lch</span><span class="p">);</span>
		<span class="n">dd</span><span class="o">-&gt;</span><span class="n">dma_lch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">omap_sham_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">dd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_sham_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to alloc data struct.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">data_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dd</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">done_task</span><span class="p">,</span> <span class="n">omap_sham_done_task</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">crypto_init_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">OMAP_SHAM_QUEUE_LENGTH</span><span class="p">);</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Get the base address */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no MEM resource info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">res_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">phys_base</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="cm">/* Get the DMA */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no DMA resource info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">res_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="cm">/* Get the IRQ */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no IRQ resource info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">res_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">omap_sham_irq</span><span class="p">,</span>
			<span class="n">IRQF_TRIGGER_LOW</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">dd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to request irq.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">res_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">omap_sham_dma_init</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">dma_err</span><span class="p">;</span>

	<span class="cm">/* Initializing the clock */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">iclk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ick&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;clock intialization failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clk_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">phys_base</span><span class="p">,</span> <span class="n">SZ_4K</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t ioremap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">io_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;hw accel on OMAP rev %u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">omap_sham_read</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">SHA_REG_REV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SHA_REG_REV_MAJOR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span>
		<span class="n">omap_sham_read</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">SHA_REG_REV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SHA_REG_REV_MINOR</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sham</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sham</span><span class="p">.</span><span class="n">dev_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sham</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">algs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">crypto_register_ahash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">algs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_algs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_algs:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">crypto_unregister_ahash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">algs</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">);</span>
<span class="nl">io_err:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">);</span>
<span class="nl">clk_err:</span>
	<span class="n">omap_sham_dma_cleanup</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
<span class="nl">dma_err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dd</span><span class="p">);</span>
<span class="nl">res_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">dd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">data_err:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;initialization failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">omap_sham_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">omap_sham_dev</span> <span class="o">*</span><span class="n">dd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dd</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sham</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sham</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">algs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">crypto_unregister_ahash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">algs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">done_task</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">);</span>
	<span class="n">omap_sham_dma_cleanup</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dd</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd</span><span class="p">);</span>
	<span class="n">dd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">omap_sham_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">omap_sham_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">omap_sham_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;omap-sham&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">omap_sham_mod_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;loading %s driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;omap-sham&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_class_is_omap2</span><span class="p">()</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">omap_type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">OMAP2_DEVICE_TYPE_SEC</span> <span class="o">&amp;&amp;</span>
			<span class="n">omap_type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">OMAP2_DEVICE_TYPE_EMU</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unsupported cpu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_sham_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">omap_sham_mod_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_sham_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">omap_sham_mod_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">omap_sham_mod_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;OMAP SHA1/MD5 hw acceleration support.&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Dmitry Kasatkin&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
