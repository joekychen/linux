<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › crypto › ux500 › cryp › cryp_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cryp_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Copyright (C) ST-Ericsson SA 2010</span>
<span class="cm"> * Author: Shujuan Chen &lt;shujuan.chen@stericsson.com&gt; for ST-Ericsson.</span>
<span class="cm"> * Author: Joakim Bech &lt;joakim.xx.bech@stericsson.com&gt; for ST-Ericsson.</span>
<span class="cm"> * Author: Berne Hebark &lt;berne.herbark@stericsson.com&gt; for ST-Ericsson.</span>
<span class="cm"> * Author: Niklas Hernaeus &lt;niklas.hernaeus@stericsson.com&gt; for ST-Ericsson.</span>
<span class="cm"> * Author: Jonas Linde &lt;jonas.linde@stericsson.com&gt; for ST-Ericsson.</span>
<span class="cm"> * Author: Andreas Westin &lt;andreas.westin@stericsson.com&gt; for ST-Ericsson.</span>
<span class="cm"> * License terms: GNU General Public License (GPL) version 2</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/crypto.h&gt;</span>
<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/irqreturn.h&gt;</span>
<span class="cp">#include &lt;linux/klist.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/semaphore.h&gt;</span>

<span class="cp">#include &lt;crypto/aes.h&gt;</span>
<span class="cp">#include &lt;crypto/algapi.h&gt;</span>
<span class="cp">#include &lt;crypto/ctr.h&gt;</span>
<span class="cp">#include &lt;crypto/des.h&gt;</span>
<span class="cp">#include &lt;crypto/scatterwalk.h&gt;</span>

<span class="cp">#include &lt;plat/ste_dma40.h&gt;</span>

<span class="cp">#include &lt;mach/crypto-ux500.h&gt;</span>
<span class="cp">#include &lt;mach/hardware.h&gt;</span>

<span class="cp">#include &quot;cryp_p.h&quot;</span>
<span class="cp">#include &quot;cryp.h&quot;</span>

<span class="cp">#define CRYP_MAX_KEY_SIZE	32</span>
<span class="cp">#define BYTES_PER_WORD		4</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cryp_mode</span><span class="p">;</span>
<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">session_id</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="o">*</span><span class="n">mem_to_engine</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="o">*</span><span class="n">engine_to_mem</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * struct cryp_driver_data - data specific to the driver.</span>
<span class="cm"> *</span>
<span class="cm"> * @device_list: A list of registered devices to choose from.</span>
<span class="cm"> * @device_allocation: A semaphore initialized with number of devices.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">cryp_driver_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">klist</span> <span class="n">device_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">semaphore</span> <span class="n">device_allocation</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct cryp_ctx - Crypto context</span>
<span class="cm"> * @config: Crypto mode.</span>
<span class="cm"> * @key[CRYP_MAX_KEY_SIZE]: Key.</span>
<span class="cm"> * @keylen: Length of key.</span>
<span class="cm"> * @iv: Pointer to initialization vector.</span>
<span class="cm"> * @indata: Pointer to indata.</span>
<span class="cm"> * @outdata: Pointer to outdata.</span>
<span class="cm"> * @datalen: Length of indata.</span>
<span class="cm"> * @outlen: Length of outdata.</span>
<span class="cm"> * @blocksize: Size of blocks.</span>
<span class="cm"> * @updated: Updated flag.</span>
<span class="cm"> * @dev_ctx: Device dependent context.</span>
<span class="cm"> * @device: Pointer to the device.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryp_config</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">key</span><span class="p">[</span><span class="n">CRYP_MAX_KEY_SIZE</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">keylen</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">iv</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">indata</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">outdata</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">datalen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">outlen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">updated</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryp_device_context</span> <span class="n">dev_ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">session_id</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cryp_driver_data</span> <span class="n">driver_data</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * uint8p_to_uint32_be - 4*uint8 to uint32 big endian</span>
<span class="cm"> * @in: Data to convert.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">uint8p_to_uint32_be</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">in</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cpu_to_be32p</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * swap_bits_in_byte - mirror the bits in a byte</span>
<span class="cm"> * @b: the byte to be mirrored</span>
<span class="cm"> *</span>
<span class="cm"> * The bits are swapped the following way:</span>
<span class="cm"> *  Byte b include bits 0-7, nibble 1 (n1) include bits 0-3 and</span>
<span class="cm"> *  nibble 2 (n2) bits 4-7.</span>
<span class="cm"> *</span>
<span class="cm"> *  Nibble 1 (n1):</span>
<span class="cm"> *  (The &quot;old&quot; (moved) bit is replaced with a zero)</span>
<span class="cm"> *  1. Move bit 6 and 7, 4 positions to the left.</span>
<span class="cm"> *  2. Move bit 3 and 5, 2 positions to the left.</span>
<span class="cm"> *  3. Move bit 1-4, 1 position to the left.</span>
<span class="cm"> *</span>
<span class="cm"> *  Nibble 2 (n2):</span>
<span class="cm"> *  1. Move bit 0 and 1, 4 positions to the right.</span>
<span class="cm"> *  2. Move bit 2 and 4, 2 positions to the right.</span>
<span class="cm"> *  3. Move bit 3-6, 1 position to the right.</span>
<span class="cm"> *</span>
<span class="cm"> *  Combine the two nibbles to a complete and swapped byte.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">swap_bits_in_byte</span><span class="p">(</span><span class="n">u8</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define R_SHIFT_4_MASK  0xc0 </span><span class="cm">/* Bits 6 and 7, right shift 4 */</span><span class="cp"></span>
<span class="cp">#define R_SHIFT_2_MASK  0x28 </span><span class="cm">/* (After right shift 4) Bits 3 and 5,</span>
<span class="cm">				  right shift 2 */</span><span class="cp"></span>
<span class="cp">#define R_SHIFT_1_MASK  0x1e </span><span class="cm">/* (After right shift 2) Bits 1-4,</span>
<span class="cm">				  right shift 1 */</span><span class="cp"></span>
<span class="cp">#define L_SHIFT_4_MASK  0x03 </span><span class="cm">/* Bits 0 and 1, left shift 4 */</span><span class="cp"></span>
<span class="cp">#define L_SHIFT_2_MASK  0x14 </span><span class="cm">/* (After left shift 4) Bits 2 and 4,</span>
<span class="cm">				  left shift 2 */</span><span class="cp"></span>
<span class="cp">#define L_SHIFT_1_MASK  0x78 </span><span class="cm">/* (After left shift 1) Bits 3-6,</span>
<span class="cm">				  left shift 1 */</span><span class="cp"></span>

	<span class="n">u8</span> <span class="n">n1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">n2</span><span class="p">;</span>

	<span class="cm">/* Swap most significant nibble */</span>
	<span class="cm">/* Right shift 4, bits 6 and 7 */</span>
	<span class="n">n1</span> <span class="o">=</span> <span class="p">((</span><span class="n">b</span>  <span class="o">&amp;</span> <span class="n">R_SHIFT_4_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">b</span>  <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">R_SHIFT_4_MASK</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
	<span class="cm">/* Right shift 2, bits 3 and 5 */</span>
	<span class="n">n1</span> <span class="o">=</span> <span class="p">((</span><span class="n">n1</span> <span class="o">&amp;</span> <span class="n">R_SHIFT_2_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">n1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">R_SHIFT_2_MASK</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="cm">/* Right shift 1, bits 1-4 */</span>
	<span class="n">n1</span> <span class="o">=</span> <span class="p">(</span><span class="n">n1</span>  <span class="o">&amp;</span> <span class="n">R_SHIFT_1_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Swap least significant nibble */</span>
	<span class="cm">/* Left shift 4, bits 0 and 1 */</span>
	<span class="n">n2</span> <span class="o">=</span> <span class="p">((</span><span class="n">b</span>  <span class="o">&amp;</span> <span class="n">L_SHIFT_4_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">b</span>  <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">L_SHIFT_4_MASK</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>
	<span class="cm">/* Left shift 2, bits 2 and 4 */</span>
	<span class="n">n2</span> <span class="o">=</span> <span class="p">((</span><span class="n">n2</span> <span class="o">&amp;</span> <span class="n">L_SHIFT_2_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">n2</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">L_SHIFT_2_MASK</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="cm">/* Left shift 1, bits 3-6 */</span>
	<span class="n">n2</span> <span class="o">=</span> <span class="p">(</span><span class="n">n2</span>  <span class="o">&amp;</span> <span class="n">L_SHIFT_1_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">n1</span> <span class="o">|</span> <span class="n">n2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">swap_words_in_key_and_bits_in_byte</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span>
						      <span class="n">u8</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">j</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">BYTES_PER_WORD</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BYTES_PER_WORD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">j</span> <span class="o">-</span> <span class="n">BYTES_PER_WORD</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">swap_bits_in_byte</span><span class="p">(</span><span class="n">in</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">j</span> <span class="o">-=</span> <span class="n">BYTES_PER_WORD</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_session_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We never want 0 to be a valid value, since this is the default value</span>
<span class="cm">	 * for the software context.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atomic_inc_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session_id</span><span class="p">)))</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session_id</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">cryp_interrupt_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="n">device_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">param</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The device is coming from the one found in hw_crypt_noxts. */</span>
	<span class="n">device_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">;</span>

	<span class="n">ctx</span> <span class="o">=</span> <span class="n">device_data</span><span class="o">-&gt;</span><span class="n">current_ctx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s] (len: %d) %s, &quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">outlen</span><span class="p">,</span>
		<span class="n">cryp_pending_irq_src</span><span class="p">(</span><span class="n">device_data</span><span class="p">,</span> <span class="n">CRYP_IRQ_SRC_OUTPUT_FIFO</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;out&quot;</span> <span class="o">:</span> <span class="s">&quot;in&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cryp_pending_irq_src</span><span class="p">(</span><span class="n">device_data</span><span class="p">,</span>
				 <span class="n">CRYP_IRQ_SRC_OUTPUT_FIFO</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">outlen</span> <span class="o">/</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">outdata</span><span class="p">)</span> <span class="o">=</span> <span class="n">readl_relaxed</span><span class="p">(</span>
						<span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dout</span><span class="p">);</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">outdata</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">outlen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">outlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cryp_disable_irq_src</span><span class="p">(</span><span class="n">device_data</span><span class="p">,</span>
						     <span class="n">CRYP_IRQ_SRC_OUTPUT_FIFO</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cryp_pending_irq_src</span><span class="p">(</span><span class="n">device_data</span><span class="p">,</span>
					<span class="n">CRYP_IRQ_SRC_INPUT_FIFO</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">datalen</span> <span class="o">/</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">indata</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">din</span><span class="p">);</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">indata</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">datalen</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">datalen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">cryp_disable_irq_src</span><span class="p">(</span><span class="n">device_data</span><span class="p">,</span>
						   <span class="n">CRYP_IRQ_SRC_INPUT_FIFO</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">algomode</span> <span class="o">==</span> <span class="n">CRYP_ALGO_AES_XTS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">CRYP_PUT_BITS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">,</span>
					      <span class="n">CRYP_START_ENABLE</span><span class="p">,</span>
					      <span class="n">CRYP_CR_START_POS</span><span class="p">,</span>
					      <span class="n">CRYP_CR_START_MASK</span><span class="p">);</span>

				<span class="n">cryp_wait_until_done</span><span class="p">(</span><span class="n">device_data</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mode_is_aes</span><span class="p">(</span><span class="k">enum</span> <span class="n">cryp_algo_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>	<span class="n">CRYP_ALGO_AES_ECB</span> <span class="o">==</span> <span class="n">mode</span> <span class="o">||</span>
		<span class="n">CRYP_ALGO_AES_CBC</span> <span class="o">==</span> <span class="n">mode</span> <span class="o">||</span>
		<span class="n">CRYP_ALGO_AES_CTR</span> <span class="o">==</span> <span class="n">mode</span> <span class="o">||</span>
		<span class="n">CRYP_ALGO_AES_XTS</span> <span class="o">==</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cfg_iv</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="n">device_data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">left</span><span class="p">,</span> <span class="n">u32</span> <span class="n">right</span><span class="p">,</span>
		  <span class="k">enum</span> <span class="n">cryp_init_vector_index</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryp_init_vector_value</span> <span class="n">vector_value</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">vector_value</span><span class="p">.</span><span class="n">init_value_left</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
	<span class="n">vector_value</span><span class="p">.</span><span class="n">init_value_right</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cryp_configure_init_vector</span><span class="p">(</span><span class="n">device_data</span><span class="p">,</span>
					  <span class="n">index</span><span class="p">,</span>
					  <span class="n">vector_value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cfg_ivs</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="n">device_data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_of_regs</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iv</span><span class="p">[</span><span class="n">AES_BLOCK_SIZE</span> <span class="o">/</span> <span class="mi">4</span><span class="p">];</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since we loop on num_of_regs we need to have a check in case</span>
<span class="cm">	 * someone provides an incorrect blocksize which would force calling</span>
<span class="cm">	 * cfg_iv with i greater than 2 which is an error.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_of_regs</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s] Incorrect blocksize %d&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">uint8p_to_uint32_be</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">iv</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_of_regs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cfg_iv</span><span class="p">(</span><span class="n">device_data</span><span class="p">,</span> <span class="n">iv</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">],</span> <span class="n">iv</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
				<span class="p">(</span><span class="k">enum</span> <span class="n">cryp_init_vector_index</span><span class="p">)</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="n">device_data</span><span class="p">,</span>
		   <span class="n">u32</span> <span class="n">left_key</span><span class="p">,</span>
		   <span class="n">u32</span> <span class="n">right_key</span><span class="p">,</span>
		   <span class="k">enum</span> <span class="n">cryp_key_reg_index</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryp_key_value</span> <span class="n">key_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cryp_error</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">key_value</span><span class="p">.</span><span class="n">key_value_left</span> <span class="o">=</span> <span class="n">left_key</span><span class="p">;</span>
	<span class="n">key_value</span><span class="p">.</span><span class="n">key_value_right</span> <span class="o">=</span> <span class="n">right_key</span><span class="p">;</span>

	<span class="n">cryp_error</span> <span class="o">=</span> <span class="n">cryp_configure_key_values</span><span class="p">(</span><span class="n">device_data</span><span class="p">,</span>
					       <span class="n">index</span><span class="p">,</span>
					       <span class="n">key_value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cryp_error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: &quot;</span>
			<span class="s">&quot;cryp_configure_key_values() failed!&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cryp_error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cfg_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_of_regs</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">keylen</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">swapped_key</span><span class="p">[</span><span class="n">CRYP_MAX_KEY_SIZE</span> <span class="o">/</span> <span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">cryp_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode_is_aes</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">algomode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">swap_words_in_key_and_bits_in_byte</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
						   <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">swapped_key</span><span class="p">,</span>
						   <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">keylen</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">swapped_key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">uint8p_to_uint32_be</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_of_regs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cryp_error</span> <span class="o">=</span> <span class="n">set_key</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				     <span class="o">*</span><span class="p">(((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">swapped_key</span><span class="p">)</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span>
				     <span class="o">*</span><span class="p">(((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">swapped_key</span><span class="p">)</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
				     <span class="p">(</span><span class="k">enum</span> <span class="n">cryp_key_reg_index</span><span class="p">)</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cryp_error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: set_key() failed!&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">cryp_error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">cryp_error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryp_setup_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="n">device_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control_register</span> <span class="o">=</span> <span class="n">CRYP_CR_DEFAULT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cryp_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CRYP_MODE_INTERRUPT</span>:
		<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">CRYP_IMSC_DEFAULT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">imsc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CRYP_MODE_DMA</span>:
		<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">CRYP_DMACR_DEFAULT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dmacr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">updated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cryp_flush_inoutfifo</span><span class="p">(</span><span class="n">device_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg_keys</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: cfg_keys failed!&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">iv</span> <span class="o">&amp;&amp;</span>
		    <span class="n">CRYP_ALGO_AES_ECB</span> <span class="o">!=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">algomode</span> <span class="o">&amp;&amp;</span>
		    <span class="n">CRYP_ALGO_DES_ECB</span> <span class="o">!=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">algomode</span> <span class="o">&amp;&amp;</span>
		    <span class="n">CRYP_ALGO_TDES_ECB</span> <span class="o">!=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">algomode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cfg_ivs</span><span class="p">(</span><span class="n">device_data</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cryp_set_configuration</span><span class="p">(</span><span class="n">device_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">control_register</span><span class="p">);</span>
		<span class="n">add_session_id</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">updated</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		   <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">session_id</span> <span class="o">!=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cryp_flush_inoutfifo</span><span class="p">(</span><span class="n">device_data</span><span class="p">);</span>
		<span class="n">cryp_restore_device_context</span><span class="p">(</span><span class="n">device_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev_ctx</span><span class="p">);</span>

		<span class="n">add_session_id</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="n">control_register</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev_ctx</span><span class="p">.</span><span class="n">cr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">control_register</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev_ctx</span><span class="p">.</span><span class="n">cr</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">control_register</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">CRYP_CRYPEN_ENABLE</span> <span class="o">&lt;&lt;</span> <span class="n">CRYP_CR_CRYPEN_POS</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryp_get_device_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">**</span><span class="n">device_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">klist_iter</span> <span class="n">device_iterator</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">klist_node</span> <span class="o">*</span><span class="n">device_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="n">local_device_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DEV_DBG_NAME</span> <span class="s">&quot; [%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Wait until a device is available */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_data</span><span class="p">.</span><span class="n">device_allocation</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>  <span class="cm">/* Interrupted */</span>

	<span class="cm">/* Select a device */</span>
	<span class="n">klist_iter_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_data</span><span class="p">.</span><span class="n">device_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_iterator</span><span class="p">);</span>

	<span class="n">device_node</span> <span class="o">=</span> <span class="n">klist_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_iterator</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">device_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local_device_data</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">device_node</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">cryp_device_data</span><span class="p">,</span> <span class="n">list_node</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>
		<span class="cm">/* current_ctx allocates a device, NULL = unallocated */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local_device_data</span><span class="o">-&gt;</span><span class="n">current_ctx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">device_node</span> <span class="o">=</span> <span class="n">klist_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_iterator</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">local_device_data</span><span class="o">-&gt;</span><span class="n">current_ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">local_device_data</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">klist_iter_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_iterator</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/**</span>
<span class="cm">		 * No free device found.</span>
<span class="cm">		 * Since we allocated a device with down_interruptible, this</span>
<span class="cm">		 * should not be able to happen.</span>
<span class="cm">		 * Number of available devices, which are contained in</span>
<span class="cm">		 * device_allocation, is therefore decremented by not doing</span>
<span class="cm">		 * an up(device_allocation).</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">device_data</span> <span class="o">=</span> <span class="n">local_device_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cryp_dma_setup_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="n">device_data</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_cap_zero</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">device_data</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">mask</span><span class="p">);</span>

	<span class="n">device_data</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">cfg_mem2cryp</span> <span class="o">=</span> <span class="n">mem_to_engine</span><span class="p">;</span>
	<span class="n">device_data</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">chan_mem2cryp</span> <span class="o">=</span>
		<span class="n">dma_request_channel</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">mask</span><span class="p">,</span>
				    <span class="n">stedma40_filter</span><span class="p">,</span>
				    <span class="n">device_data</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">cfg_mem2cryp</span><span class="p">);</span>

	<span class="n">device_data</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">cfg_cryp2mem</span> <span class="o">=</span> <span class="n">engine_to_mem</span><span class="p">;</span>
	<span class="n">device_data</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">chan_cryp2mem</span> <span class="o">=</span>
		<span class="n">dma_request_channel</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">mask</span><span class="p">,</span>
				    <span class="n">stedma40_filter</span><span class="p">,</span>
				    <span class="n">device_data</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">cfg_cryp2mem</span><span class="p">);</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">cryp_dma_complete</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cryp_dma_out_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: &quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">cryp_dma_complete</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryp_set_dma_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: &quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">sg</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: Data in sg list isn&#39;t &quot;</span>
			<span class="s">&quot;aligned! Addr: 0x%08x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">sg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMA_TO_DEVICE</span>:
		<span class="n">channel</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">chan_mem2cryp</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">sg_src</span> <span class="o">=</span> <span class="n">sg</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">sg_src_len</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						 <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">sg_src</span><span class="p">,</span>
						 <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">nents_src</span><span class="p">,</span>
						 <span class="n">direction</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">sg_src_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;[%s]: Could not map the sg list (TO_DEVICE)&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: Setting up DMA for buffer &quot;</span>
			<span class="s">&quot;(TO_DEVICE)&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="n">desc</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_prep_slave_sg</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span>
					     <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">sg_src</span><span class="p">,</span>
					     <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">sg_src_len</span><span class="p">,</span>
					     <span class="n">direction</span><span class="p">,</span> <span class="n">DMA_CTRL_ACK</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DMA_FROM_DEVICE</span>:
		<span class="n">channel</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">chan_cryp2mem</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">sg_dst</span> <span class="o">=</span> <span class="n">sg</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">sg_dst_len</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						 <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">sg_dst</span><span class="p">,</span>
						 <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">nents_dst</span><span class="p">,</span>
						 <span class="n">direction</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">sg_dst_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;[%s]: Could not map the sg list (FROM_DEVICE)&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: Setting up DMA for buffer &quot;</span>
			<span class="s">&quot;(FROM_DEVICE)&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="n">desc</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_prep_slave_sg</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span>
					     <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">sg_dst</span><span class="p">,</span>
					     <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">sg_dst_len</span><span class="p">,</span>
					     <span class="n">direction</span><span class="p">,</span>
					     <span class="n">DMA_CTRL_ACK</span> <span class="o">|</span>
					     <span class="n">DMA_PREP_INTERRUPT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">cryp_dma_out_callback</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback_param</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: Invalid DMA direction&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cookie</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_submit</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="n">dma_async_issue_pending</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cryp_dma_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: &quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">chan_mem2cryp</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_control</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">DMA_TERMINATE_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">sg_src</span><span class="p">,</span>
		     <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">sg_src_len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">chan_cryp2mem</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_control</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">DMA_TERMINATE_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">sg_dst</span><span class="p">,</span>
		     <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">sg_dst_len</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryp_dma_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">cryp_set_dma_transfer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: &quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: cryp_set_dma_transfer() &quot;</span>
			<span class="s">&quot;failed&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryp_dma_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">cryp_set_dma_transfer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: cryp_set_dma_transfer() &quot;</span>
			<span class="s">&quot;failed&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cryp_polling_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="n">device_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">/</span> <span class="n">BYTES_PER_WORD</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">remaining_length</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">datalen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">indata</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">indata</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">outdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">outdata</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">remaining_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writesl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">din</span><span class="p">,</span> <span class="n">indata</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">indata</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">remaining_length</span> <span class="o">-=</span> <span class="p">(</span><span class="n">len</span> <span class="o">*</span> <span class="n">BYTES_PER_WORD</span><span class="p">);</span>
		<span class="n">cryp_wait_until_done</span><span class="p">(</span><span class="n">device_data</span><span class="p">);</span>

		<span class="n">readsl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dout</span><span class="p">,</span> <span class="n">outdata</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">outdata</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">cryp_wait_until_done</span><span class="p">(</span><span class="n">device_data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryp_disable_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="n">device_data</span><span class="p">,</span>
			      <span class="n">bool</span> <span class="n">save_device_context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">power_state_spinlock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">power_state</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">save_device_context</span> <span class="o">&amp;&amp;</span> <span class="n">device_data</span><span class="o">-&gt;</span><span class="n">current_ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cryp_save_device_context</span><span class="p">(</span><span class="n">device_data</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">current_ctx</span><span class="o">-&gt;</span><span class="n">dev_ctx</span><span class="p">,</span>
				<span class="n">cryp_mode</span><span class="p">);</span>
		<span class="n">device_data</span><span class="o">-&gt;</span><span class="n">restore_dev_ctx</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>

	<span class="n">clk_disable</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_disable</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">pwr_regulator</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: &quot;</span>
				<span class="s">&quot;regulator_disable() failed!&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>

	<span class="n">device_data</span><span class="o">-&gt;</span><span class="n">power_state</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">power_state_spinlock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryp_enable_power</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="n">device_data</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">restore_device_context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">power_state_spinlock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">power_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_enable</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">pwr_regulator</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: regulator_enable() failed!&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_enable</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: clk_enable() failed!&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
			<span class="n">regulator_disable</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">pwr_regulator</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">device_data</span><span class="o">-&gt;</span><span class="n">power_state</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">restore_dev_ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">restore_device_context</span> <span class="o">&amp;&amp;</span> <span class="n">device_data</span><span class="o">-&gt;</span><span class="n">current_ctx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">device_data</span><span class="o">-&gt;</span><span class="n">restore_dev_ctx</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">cryp_restore_device_context</span><span class="p">(</span><span class="n">device_data</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">current_ctx</span><span class="o">-&gt;</span><span class="n">dev_ctx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">power_state_spinlock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_crypt_noxts</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="n">device_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">indata</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">indata</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">outdata</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">outdata</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">datalen</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">datalen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">outlen</span> <span class="o">=</span> <span class="n">datalen</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DEV_DBG_NAME</span> <span class="s">&quot; [%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">outlen</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">datalen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">indata</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="n">DEV_DBG_NAME</span> <span class="s">&quot; [%s]: Data isn&#39;t aligned! Addr: &quot;</span>
			 <span class="s">&quot;0x%08x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">indata</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cryp_setup_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">device_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cryp_mode</span> <span class="o">==</span> <span class="n">CRYP_MODE_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cryp_enable_irq_src</span><span class="p">(</span><span class="n">device_data</span><span class="p">,</span> <span class="n">CRYP_IRQ_SRC_INPUT_FIFO</span> <span class="o">|</span>
				    <span class="n">CRYP_IRQ_SRC_OUTPUT_FIFO</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * ctx-&gt;outlen is decremented in the cryp_interrupt_handler</span>
<span class="cm">		 * function. We had to add cpu_relax() (barrier) to make sure</span>
<span class="cm">		 * that gcc didn&#39;t optimze away this variable.</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">outlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cryp_mode</span> <span class="o">==</span> <span class="n">CRYP_MODE_POLLING</span> <span class="o">||</span>
		   <span class="n">cryp_mode</span> <span class="o">==</span> <span class="n">CRYP_MODE_DMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The reason for having DMA in this if case is that if we are</span>
<span class="cm">		 * running cryp_mode = 2, then we separate DMA routines for</span>
<span class="cm">		 * handling cipher/plaintext &gt; blocksize, except when</span>
<span class="cm">		 * running the normal CRYPTO_ALG_TYPE_CIPHER, then we still use</span>
<span class="cm">		 * the polling mode. Overhead of doing DMA setup eats up the</span>
<span class="cm">		 * benefits using it.</span>
<span class="cm">		 */</span>
		<span class="n">cryp_polling_mode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">device_data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: Invalid operation mode!&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cryp_save_device_context</span><span class="p">(</span><span class="n">device_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev_ctx</span><span class="p">,</span> <span class="n">cryp_mode</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">indata</span> <span class="o">=</span> <span class="n">indata</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">outdata</span> <span class="o">=</span> <span class="n">outdata</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">datalen</span> <span class="o">=</span> <span class="n">datalen</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">outlen</span> <span class="o">=</span> <span class="n">outlen</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_nents</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nbytes</span> <span class="o">-=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="n">sg</span> <span class="o">=</span> <span class="n">scatterwalk_sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">nents</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">nents</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ablk_dma_crypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">areq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_ablkcipher</span> <span class="o">*</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_reqtfm</span><span class="p">(</span><span class="n">areq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_ctx</span><span class="p">(</span><span class="n">cipher</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="n">device_data</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">bytes_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DEV_DBG_NAME</span> <span class="s">&quot; [%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">datalen</span> <span class="o">=</span> <span class="n">areq</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">outlen</span> <span class="o">=</span> <span class="n">areq</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cryp_get_device_data</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cryp_setup_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">device_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* We have the device now, so store the nents in the dma struct. */</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">nents_src</span> <span class="o">=</span> <span class="n">get_nents</span><span class="p">(</span><span class="n">areq</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">datalen</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">nents_dst</span> <span class="o">=</span> <span class="n">get_nents</span><span class="p">(</span><span class="n">areq</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">outlen</span><span class="p">);</span>

	<span class="cm">/* Enable DMA in- and output. */</span>
	<span class="n">cryp_configure_for_dma</span><span class="p">(</span><span class="n">device_data</span><span class="p">,</span> <span class="n">CRYP_DMA_ENABLE_BOTH_DIRECTIONS</span><span class="p">);</span>

	<span class="n">bytes_written</span> <span class="o">=</span> <span class="n">cryp_dma_write</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">areq</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">datalen</span><span class="p">);</span>
	<span class="n">bytes_read</span> <span class="o">=</span> <span class="n">cryp_dma_read</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">areq</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">bytes_written</span><span class="p">);</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">cryp_dma_complete</span><span class="p">);</span>
	<span class="n">cryp_dma_done</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>

	<span class="n">cryp_save_device_context</span><span class="p">(</span><span class="n">device_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev_ctx</span><span class="p">,</span> <span class="n">cryp_mode</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>
	<span class="n">device_data</span><span class="o">-&gt;</span><span class="n">current_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The down_interruptible part for this semaphore is called in</span>
<span class="cm">	 * cryp_get_device_data.</span>
<span class="cm">	 */</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_data</span><span class="p">.</span><span class="n">device_allocation</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bytes_written</span> <span class="o">!=</span> <span class="n">bytes_read</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ablk_crypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">areq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ablkcipher_walk</span> <span class="n">walk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_ablkcipher</span> <span class="o">*</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_reqtfm</span><span class="p">(</span><span class="n">areq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_ctx</span><span class="p">(</span><span class="n">cipher</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="n">device_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src_paddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dst_paddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nbytes</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DEV_DBG_NAME</span> <span class="s">&quot; [%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cryp_get_device_data</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ablkcipher_walk_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">walk</span><span class="p">,</span> <span class="n">areq</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">areq</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">areq</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ablkcipher_walk_phys</span><span class="p">(</span><span class="n">areq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">walk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="n">DEV_DBG_NAME</span> <span class="s">&quot;[%s]: ablkcipher_walk_phys() failed!&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">nbytes</span> <span class="o">=</span> <span class="n">walk</span><span class="p">.</span><span class="n">nbytes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">iv</span> <span class="o">=</span> <span class="n">walk</span><span class="p">.</span><span class="n">iv</span><span class="p">;</span>
		<span class="n">src_paddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">page_to_phys</span><span class="p">(</span><span class="n">walk</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="n">walk</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">indata</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">src_paddr</span><span class="p">);</span>

		<span class="n">dst_paddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">page_to_phys</span><span class="p">(</span><span class="n">walk</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="n">walk</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">outdata</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">dst_paddr</span><span class="p">);</span>

		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">datalen</span> <span class="o">=</span> <span class="n">nbytes</span> <span class="o">-</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">%</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">hw_crypt_noxts</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">device_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">nbytes</span> <span class="o">-=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">datalen</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ablkcipher_walk_done</span><span class="p">(</span><span class="n">areq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">walk</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ablkcipher_walk_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">walk</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="cm">/* Release the device */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>
	<span class="n">device_data</span><span class="o">-&gt;</span><span class="n">current_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The down_interruptible part for this semaphore is called in</span>
<span class="cm">	 * cryp_get_device_data.</span>
<span class="cm">	 */</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_data</span><span class="p">.</span><span class="n">device_allocation</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aes_ablkcipher_setkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_ablkcipher</span> <span class="o">*</span><span class="n">cipher</span><span class="p">,</span>
				 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keylen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_ctx</span><span class="p">(</span><span class="n">cipher</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">flags</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cipher</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">crt_flags</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DEV_DBG_NAME</span> <span class="s">&quot; [%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AES_KEYSIZE_128</span>:
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">keysize</span> <span class="o">=</span> <span class="n">CRYP_KEY_SIZE_128</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AES_KEYSIZE_192</span>:
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">keysize</span> <span class="o">=</span> <span class="n">CRYP_KEY_SIZE_192</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AES_KEYSIZE_256</span>:
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">keysize</span> <span class="o">=</span> <span class="n">CRYP_KEY_SIZE_256</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="n">DEV_DBG_NAME</span> <span class="s">&quot;[%s]: Unknown keylen!&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CRYPTO_TFM_RES_BAD_KEY_LEN</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">keylen</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">keylen</span> <span class="o">=</span> <span class="n">keylen</span><span class="p">;</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">des_ablkcipher_setkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_ablkcipher</span> <span class="o">*</span><span class="n">cipher</span><span class="p">,</span>
				 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keylen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_ctx</span><span class="p">(</span><span class="n">cipher</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">flags</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cipher</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">crt_flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">[</span><span class="n">DES_EXPKEY_WORDS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DEV_DBG_NAME</span> <span class="s">&quot; [%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">keylen</span> <span class="o">!=</span> <span class="n">DES_KEY_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CRYPTO_TFM_RES_BAD_KEY_LEN</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="n">DEV_DBG_NAME</span> <span class="s">&quot; [%s]: CRYPTO_TFM_RES_BAD_KEY_LEN&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">des_ekey</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CRYPTO_TFM_REQ_WEAK_KEY</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CRYPTO_TFM_RES_WEAK_KEY</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="n">DEV_DBG_NAME</span> <span class="s">&quot; [%s]: CRYPTO_TFM_REQ_WEAK_KEY&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">keylen</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">keylen</span> <span class="o">=</span> <span class="n">keylen</span><span class="p">;</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">des3_ablkcipher_setkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_ablkcipher</span> <span class="o">*</span><span class="n">cipher</span><span class="p">,</span>
				  <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keylen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_ctx</span><span class="p">(</span><span class="n">cipher</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">flags</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cipher</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">crt_flags</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">K</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">[</span><span class="n">DES3_EDE_EXPKEY_WORDS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DEV_DBG_NAME</span> <span class="s">&quot; [%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">keylen</span> <span class="o">!=</span> <span class="n">DES3_EDE_KEY_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CRYPTO_TFM_RES_BAD_KEY_LEN</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="n">DEV_DBG_NAME</span> <span class="s">&quot; [%s]: CRYPTO_TFM_RES_BAD_KEY_LEN&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Checking key interdependency for weak key detection. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">K</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">K</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">K</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="n">K</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="o">||</span>
				<span class="o">!</span><span class="p">((</span><span class="n">K</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">^</span> <span class="n">K</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">K</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">^</span> <span class="n">K</span><span class="p">[</span><span class="mi">5</span><span class="p">])))</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CRYPTO_TFM_REQ_WEAK_KEY</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CRYPTO_TFM_RES_WEAK_KEY</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="n">DEV_DBG_NAME</span> <span class="s">&quot; [%s]: CRYPTO_TFM_REQ_WEAK_KEY&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">des_ekey</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">key</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">DES_KEY_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CRYPTO_TFM_REQ_WEAK_KEY</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CRYPTO_TFM_RES_WEAK_KEY</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="n">DEV_DBG_NAME</span> <span class="s">&quot; [%s]: &quot;</span>
					<span class="s">&quot;CRYPTO_TFM_REQ_WEAK_KEY&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">keylen</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">keylen</span> <span class="o">=</span> <span class="n">keylen</span><span class="p">;</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryp_blk_encrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">areq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_ablkcipher</span> <span class="o">*</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_reqtfm</span><span class="p">(</span><span class="n">areq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_ctx</span><span class="p">(</span><span class="n">cipher</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DEV_DBG_NAME</span> <span class="s">&quot; [%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">algodir</span> <span class="o">=</span> <span class="n">CRYP_ALGORITHM_ENCRYPT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * DMA does not work for DES due to a hw bug */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cryp_mode</span> <span class="o">==</span> <span class="n">CRYP_MODE_DMA</span> <span class="o">&amp;&amp;</span> <span class="n">mode_is_aes</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">algomode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ablk_dma_crypt</span><span class="p">(</span><span class="n">areq</span><span class="p">);</span>

	<span class="cm">/* For everything except DMA, we run the non DMA version. */</span>
	<span class="k">return</span> <span class="n">ablk_crypt</span><span class="p">(</span><span class="n">areq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryp_blk_decrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ablkcipher_request</span> <span class="o">*</span><span class="n">areq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crypto_ablkcipher</span> <span class="o">*</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_reqtfm</span><span class="p">(</span><span class="n">areq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_ablkcipher_ctx</span><span class="p">(</span><span class="n">cipher</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DEV_DBG_NAME</span> <span class="s">&quot; [%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">algodir</span> <span class="o">=</span> <span class="n">CRYP_ALGORITHM_DECRYPT</span><span class="p">;</span>

	<span class="cm">/* DMA does not work for DES due to a hw bug */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cryp_mode</span> <span class="o">==</span> <span class="n">CRYP_MODE_DMA</span> <span class="o">&amp;&amp;</span> <span class="n">mode_is_aes</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">algomode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ablk_dma_crypt</span><span class="p">(</span><span class="n">areq</span><span class="p">);</span>

	<span class="cm">/* For everything except DMA, we run the non DMA version. */</span>
	<span class="k">return</span> <span class="n">ablk_crypt</span><span class="p">(</span><span class="n">areq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">cryp_algo_template</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">cryp_algo_mode</span> <span class="n">algomode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crypto_alg</span> <span class="n">crypto</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryp_cra_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_tfm</span> <span class="o">*</span><span class="n">tfm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">crypto_tfm_ctx</span><span class="p">(</span><span class="n">tfm</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">crypto_alg</span> <span class="o">*</span><span class="n">alg</span> <span class="o">=</span> <span class="n">tfm</span><span class="o">-&gt;</span><span class="n">__crt_alg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryp_algo_template</span> <span class="o">*</span><span class="n">cryp_alg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">cryp_algo_template</span><span class="p">,</span>
			<span class="n">crypto</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">algomode</span> <span class="o">=</span> <span class="n">cryp_alg</span><span class="o">-&gt;</span><span class="n">algomode</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">crypto_tfm_alg_blocksize</span><span class="p">(</span><span class="n">tfm</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cryp_algo_template</span> <span class="n">cryp_algs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">algomode</span> <span class="o">=</span> <span class="n">CRYP_ALGO_AES_ECB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">crypto</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">cra_name</span> <span class="o">=</span> <span class="s">&quot;aes&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_driver_name</span> <span class="o">=</span> <span class="s">&quot;aes-ux500&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_priority</span> <span class="o">=</span>	<span class="mi">300</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_flags</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_ABLKCIPHER</span> <span class="o">|</span>
					<span class="n">CRYPTO_ALG_ASYNC</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_blocksize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_ctxsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span><span class="p">),</span>
			<span class="p">.</span><span class="n">cra_alignmask</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crypto_ablkcipher_type</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_init</span> <span class="o">=</span> <span class="n">cryp_cra_init</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_u</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">min_keysize</span> <span class="o">=</span> <span class="n">AES_MIN_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">max_keysize</span> <span class="o">=</span> <span class="n">AES_MAX_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aes_ablkcipher_setkey</span><span class="p">,</span>
					<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">cryp_blk_encrypt</span><span class="p">,</span>
					<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">cryp_blk_decrypt</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">algomode</span> <span class="o">=</span> <span class="n">CRYP_ALGO_AES_ECB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">crypto</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">cra_name</span> <span class="o">=</span> <span class="s">&quot;ecb(aes)&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_driver_name</span> <span class="o">=</span> <span class="s">&quot;ecb-aes-ux500&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_priority</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_flags</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_ABLKCIPHER</span> <span class="o">|</span>
					<span class="n">CRYPTO_ALG_ASYNC</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_blocksize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_ctxsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span><span class="p">),</span>
			<span class="p">.</span><span class="n">cra_alignmask</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crypto_ablkcipher_type</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_init</span> <span class="o">=</span> <span class="n">cryp_cra_init</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_u</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">min_keysize</span> <span class="o">=</span> <span class="n">AES_MIN_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">max_keysize</span> <span class="o">=</span> <span class="n">AES_MAX_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aes_ablkcipher_setkey</span><span class="p">,</span>
					<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">cryp_blk_encrypt</span><span class="p">,</span>
					<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">cryp_blk_decrypt</span><span class="p">,</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">algomode</span> <span class="o">=</span> <span class="n">CRYP_ALGO_AES_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">crypto</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">cra_name</span> <span class="o">=</span> <span class="s">&quot;cbc(aes)&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_driver_name</span> <span class="o">=</span> <span class="s">&quot;cbc-aes-ux500&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_priority</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_flags</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_ABLKCIPHER</span> <span class="o">|</span>
					<span class="n">CRYPTO_ALG_ASYNC</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_blocksize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_ctxsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span><span class="p">),</span>
			<span class="p">.</span><span class="n">cra_alignmask</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crypto_ablkcipher_type</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_init</span> <span class="o">=</span> <span class="n">cryp_cra_init</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_u</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">min_keysize</span> <span class="o">=</span> <span class="n">AES_MIN_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">max_keysize</span> <span class="o">=</span> <span class="n">AES_MAX_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aes_ablkcipher_setkey</span><span class="p">,</span>
					<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">cryp_blk_encrypt</span><span class="p">,</span>
					<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">cryp_blk_decrypt</span><span class="p">,</span>
					<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">algomode</span> <span class="o">=</span> <span class="n">CRYP_ALGO_AES_CTR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">crypto</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">cra_name</span> <span class="o">=</span> <span class="s">&quot;ctr(aes)&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_driver_name</span> <span class="o">=</span> <span class="s">&quot;ctr-aes-ux500&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_priority</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_flags</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_ABLKCIPHER</span> <span class="o">|</span>
						<span class="n">CRYPTO_ALG_ASYNC</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_blocksize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_ctxsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span><span class="p">),</span>
			<span class="p">.</span><span class="n">cra_alignmask</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crypto_ablkcipher_type</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_init</span> <span class="o">=</span> <span class="n">cryp_cra_init</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_u</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">min_keysize</span> <span class="o">=</span> <span class="n">AES_MIN_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">max_keysize</span> <span class="o">=</span> <span class="n">AES_MAX_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">aes_ablkcipher_setkey</span><span class="p">,</span>
					<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">cryp_blk_encrypt</span><span class="p">,</span>
					<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">cryp_blk_decrypt</span><span class="p">,</span>
					<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">,</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">algomode</span> <span class="o">=</span> <span class="n">CRYP_ALGO_DES_ECB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">crypto</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">cra_name</span> <span class="o">=</span> <span class="s">&quot;des&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_driver_name</span> <span class="o">=</span> <span class="s">&quot;des-ux500&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_priority</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_flags</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_ABLKCIPHER</span> <span class="o">|</span>
						<span class="n">CRYPTO_ALG_ASYNC</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_blocksize</span> <span class="o">=</span> <span class="n">DES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_ctxsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span><span class="p">),</span>
			<span class="p">.</span><span class="n">cra_alignmask</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crypto_ablkcipher_type</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_init</span> <span class="o">=</span> <span class="n">cryp_cra_init</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_u</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">min_keysize</span> <span class="o">=</span> <span class="n">DES_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">max_keysize</span> <span class="o">=</span> <span class="n">DES_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">des_ablkcipher_setkey</span><span class="p">,</span>
					<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">cryp_blk_encrypt</span><span class="p">,</span>
					<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">cryp_blk_decrypt</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">algomode</span> <span class="o">=</span> <span class="n">CRYP_ALGO_TDES_ECB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">crypto</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">cra_name</span> <span class="o">=</span> <span class="s">&quot;des3_ede&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_driver_name</span> <span class="o">=</span> <span class="s">&quot;des3_ede-ux500&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_priority</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_flags</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_ABLKCIPHER</span> <span class="o">|</span>
						<span class="n">CRYPTO_ALG_ASYNC</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_blocksize</span> <span class="o">=</span> <span class="n">DES3_EDE_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_ctxsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span><span class="p">),</span>
			<span class="p">.</span><span class="n">cra_alignmask</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crypto_ablkcipher_type</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_init</span> <span class="o">=</span> <span class="n">cryp_cra_init</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_u</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">min_keysize</span> <span class="o">=</span> <span class="n">DES3_EDE_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">max_keysize</span> <span class="o">=</span> <span class="n">DES3_EDE_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">des_ablkcipher_setkey</span><span class="p">,</span>
					<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">cryp_blk_encrypt</span><span class="p">,</span>
					<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">cryp_blk_decrypt</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">algomode</span> <span class="o">=</span> <span class="n">CRYP_ALGO_DES_ECB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">crypto</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">cra_name</span> <span class="o">=</span> <span class="s">&quot;ecb(des)&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_driver_name</span> <span class="o">=</span> <span class="s">&quot;ecb-des-ux500&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_priority</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_flags</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_ABLKCIPHER</span> <span class="o">|</span>
					<span class="n">CRYPTO_ALG_ASYNC</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_blocksize</span> <span class="o">=</span> <span class="n">DES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_ctxsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span><span class="p">),</span>
			<span class="p">.</span><span class="n">cra_alignmask</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crypto_ablkcipher_type</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_init</span> <span class="o">=</span> <span class="n">cryp_cra_init</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_u</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">min_keysize</span> <span class="o">=</span> <span class="n">DES_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">max_keysize</span> <span class="o">=</span> <span class="n">DES_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">des_ablkcipher_setkey</span><span class="p">,</span>
					<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">cryp_blk_encrypt</span><span class="p">,</span>
					<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">cryp_blk_decrypt</span><span class="p">,</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">algomode</span> <span class="o">=</span> <span class="n">CRYP_ALGO_TDES_ECB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">crypto</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">cra_name</span> <span class="o">=</span> <span class="s">&quot;ecb(des3_ede)&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_driver_name</span> <span class="o">=</span> <span class="s">&quot;ecb-des3_ede-ux500&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_priority</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_flags</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_ABLKCIPHER</span> <span class="o">|</span>
					<span class="n">CRYPTO_ALG_ASYNC</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_blocksize</span> <span class="o">=</span> <span class="n">DES3_EDE_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_ctxsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span><span class="p">),</span>
			<span class="p">.</span><span class="n">cra_alignmask</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crypto_ablkcipher_type</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_init</span> <span class="o">=</span> <span class="n">cryp_cra_init</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_u</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">min_keysize</span> <span class="o">=</span> <span class="n">DES3_EDE_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">max_keysize</span> <span class="o">=</span> <span class="n">DES3_EDE_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">des3_ablkcipher_setkey</span><span class="p">,</span>
					<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">cryp_blk_encrypt</span><span class="p">,</span>
					<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">cryp_blk_decrypt</span><span class="p">,</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">algomode</span> <span class="o">=</span> <span class="n">CRYP_ALGO_DES_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">crypto</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">cra_name</span> <span class="o">=</span> <span class="s">&quot;cbc(des)&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_driver_name</span> <span class="o">=</span> <span class="s">&quot;cbc-des-ux500&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_priority</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_flags</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_ABLKCIPHER</span> <span class="o">|</span>
					<span class="n">CRYPTO_ALG_ASYNC</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_blocksize</span> <span class="o">=</span> <span class="n">DES_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_ctxsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span><span class="p">),</span>
			<span class="p">.</span><span class="n">cra_alignmask</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crypto_ablkcipher_type</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_init</span> <span class="o">=</span> <span class="n">cryp_cra_init</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_u</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">min_keysize</span> <span class="o">=</span> <span class="n">DES_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">max_keysize</span> <span class="o">=</span> <span class="n">DES_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">des_ablkcipher_setkey</span><span class="p">,</span>
					<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">cryp_blk_encrypt</span><span class="p">,</span>
					<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">cryp_blk_decrypt</span><span class="p">,</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">algomode</span> <span class="o">=</span> <span class="n">CRYP_ALGO_TDES_CBC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">crypto</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">cra_name</span> <span class="o">=</span> <span class="s">&quot;cbc(des3_ede)&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_driver_name</span> <span class="o">=</span> <span class="s">&quot;cbc-des3_ede-ux500&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_priority</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_flags</span> <span class="o">=</span> <span class="n">CRYPTO_ALG_TYPE_ABLKCIPHER</span> <span class="o">|</span>
					<span class="n">CRYPTO_ALG_ASYNC</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_blocksize</span> <span class="o">=</span> <span class="n">DES3_EDE_BLOCK_SIZE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_ctxsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_ctx</span><span class="p">),</span>
			<span class="p">.</span><span class="n">cra_alignmask</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crypto_ablkcipher_type</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_init</span> <span class="o">=</span> <span class="n">cryp_cra_init</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">cra_u</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">ablkcipher</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">min_keysize</span> <span class="o">=</span> <span class="n">DES3_EDE_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">max_keysize</span> <span class="o">=</span> <span class="n">DES3_EDE_KEY_SIZE</span><span class="p">,</span>
					<span class="p">.</span><span class="n">setkey</span> <span class="o">=</span> <span class="n">des3_ablkcipher_setkey</span><span class="p">,</span>
					<span class="p">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">cryp_blk_encrypt</span><span class="p">,</span>
					<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">cryp_blk_decrypt</span><span class="p">,</span>
					<span class="p">.</span><span class="n">ivsize</span> <span class="o">=</span> <span class="n">DES3_EDE_BLOCK_SIZE</span><span class="p">,</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * cryp_algs_register_all -</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryp_algs_register_all</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;[%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cryp_algs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">crypto_register_alg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryp_algs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crypto</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;[%s] alg registration failed&quot;</span><span class="p">,</span>
					<span class="n">cryp_algs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crypto</span><span class="p">.</span><span class="n">cra_driver_name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unreg</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">unreg:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">crypto_unregister_alg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryp_algs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crypto</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cryp_algs_unregister_all -</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cryp_algs_unregister_all</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DEV_DBG_NAME</span> <span class="s">&quot; [%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cryp_algs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">crypto_unregister_alg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryp_algs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">crypto</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ux500_cryp_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cryp_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res_irq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryp_protection_config</span> <span class="n">prot</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">privilege_access</span> <span class="o">=</span> <span class="n">CRYP_STATE_ENABLE</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">device_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryp_device_data</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: kzalloc() failed!&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device_data</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">device_data</span><span class="o">-&gt;</span><span class="n">current_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Grab the DMA configuration from platform data. */</span>
	<span class="n">mem_to_engine</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">cryp_platform_data</span> <span class="o">*</span><span class="p">)</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mem_to_engine</span><span class="p">;</span>
	<span class="n">engine_to_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">cryp_platform_data</span> <span class="o">*</span><span class="p">)</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">engine_to_mem</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: platform_get_resource() failed&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_kfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: request_mem_region() failed&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_kfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device_data</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: ioremap failed!&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">power_state_spinlock</span><span class="p">);</span>

	<span class="cm">/* Enable power for CRYP hardware block */</span>
	<span class="n">device_data</span><span class="o">-&gt;</span><span class="n">pwr_regulator</span> <span class="o">=</span> <span class="n">regulator_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;v-ape&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">pwr_regulator</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: could not get cryp regulator&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">pwr_regulator</span><span class="p">);</span>
		<span class="n">device_data</span><span class="o">-&gt;</span><span class="n">pwr_regulator</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable the clk for CRYP hardware block */</span>
	<span class="n">device_data</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: clk_get() failed!&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_regulator</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable device power (and clock) */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cryp_enable_power</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">device_data</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: cryp_enable_power() failed!&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_clk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cryp_error</span> <span class="o">=</span> <span class="n">cryp_check</span><span class="p">(</span><span class="n">device_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cryp_error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: cryp_init() failed!&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_power</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cryp_error</span> <span class="o">=</span> <span class="n">cryp_configure_protection</span><span class="p">(</span><span class="n">device_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cryp_error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: cryp_configure_protection() failed!&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_power</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res_irq</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: IORESOURCE_IRQ unavailable&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_power</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">res_irq</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			  <span class="n">cryp_interrupt_handler</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">,</span>
			  <span class="s">&quot;cryp1&quot;</span><span class="p">,</span>
			  <span class="n">device_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: Unable to request IRQ&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_power</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cryp_mode</span> <span class="o">==</span> <span class="n">CRYP_MODE_DMA</span><span class="p">)</span>
		<span class="n">cryp_dma_setup_channel</span><span class="p">(</span><span class="n">device_data</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">device_data</span><span class="p">);</span>

	<span class="cm">/* Put the new device into the device list... */</span>
	<span class="n">klist_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">list_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_data</span><span class="p">.</span><span class="n">device_list</span><span class="p">);</span>

	<span class="cm">/* ... and signal that a new device is available. */</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_data</span><span class="p">.</span><span class="n">device_allocation</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cryp_algs_register_all</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: cryp_algs_register_all() failed!&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_power</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_power:</span>
	<span class="n">cryp_disable_power</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">device_data</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

<span class="nl">out_clk:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

<span class="nl">out_regulator:</span>
	<span class="n">regulator_put</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">pwr_regulator</span><span class="p">);</span>

<span class="nl">out_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

<span class="nl">out_free_mem:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>

<span class="nl">out_kfree:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">device_data</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ux500_cryp_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res_irq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="n">device_data</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">device_data</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: platform_get_drvdata() failed!&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Try to decrease the number of available devices. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_data</span><span class="p">.</span><span class="n">device_allocation</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Check that the device is free */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>
	<span class="cm">/* current_ctx allocates a device, NULL = unallocated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">current_ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The device is busy */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>
		<span class="cm">/* Return the device to the pool. */</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_data</span><span class="p">.</span><span class="n">device_allocation</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>

	<span class="cm">/* Remove the device from the list */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">klist_node_attached</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">list_node</span><span class="p">))</span>
		<span class="n">klist_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">list_node</span><span class="p">);</span>

	<span class="cm">/* If this was the last device, remove the services */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_data</span><span class="p">.</span><span class="n">device_list</span><span class="p">.</span><span class="n">k_list</span><span class="p">))</span>
		<span class="n">cryp_algs_unregister_all</span><span class="p">();</span>

	<span class="n">res_irq</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_irq</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: IORESOURCE_IRQ, unavailable&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">res_irq</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">res_irq</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">device_data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cryp_disable_power</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">device_data</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: cryp_disable_power() failed&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>

	<span class="n">clk_put</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">regulator_put</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">pwr_regulator</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">device_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ux500_cryp_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res_irq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="n">device_data</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">device_data</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: platform_get_drvdata() failed!&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check that the device is free */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>
	<span class="cm">/* current_ctx allocates a device, NULL = unallocated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">current_ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_data</span><span class="p">.</span><span class="n">device_allocation</span><span class="p">))</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: Cryp still in use!&quot;</span>
				<span class="s">&quot;Shutting down anyway...&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="cm">/**</span>
<span class="cm">		 * (Allocate the device)</span>
<span class="cm">		 * Need to set this to non-null (dummy) value,</span>
<span class="cm">		 * to avoid usage if context switching.</span>
<span class="cm">		 */</span>
		<span class="n">device_data</span><span class="o">-&gt;</span><span class="n">current_ctx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>

	<span class="cm">/* Remove the device from the list */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">klist_node_attached</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">list_node</span><span class="p">))</span>
		<span class="n">klist_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">list_node</span><span class="p">);</span>

	<span class="cm">/* If this was the last device, remove the services */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_data</span><span class="p">.</span><span class="n">device_list</span><span class="p">.</span><span class="n">k_list</span><span class="p">))</span>
		<span class="n">cryp_algs_unregister_all</span><span class="p">();</span>

	<span class="n">res_irq</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_irq</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: IORESOURCE_IRQ, unavailable&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">res_irq</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">res_irq</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">device_data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cryp_disable_power</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">device_data</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: cryp_disable_power() failed&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ux500_cryp_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res_irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">temp_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Handle state? */</span>
	<span class="n">device_data</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: platform_get_drvdata() failed!&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res_irq</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_irq</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: IORESOURCE_IRQ, unavailable&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">res_irq</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">current_ctx</span><span class="p">)</span>
		<span class="n">device_data</span><span class="o">-&gt;</span><span class="n">current_ctx</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">current_ctx</span> <span class="o">==</span> <span class="o">++</span><span class="n">temp_ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_data</span><span class="p">.</span><span class="n">device_allocation</span><span class="p">))</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: down_interruptible() &quot;</span>
					<span class="s">&quot;failed&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cryp_disable_power</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">device_data</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cryp_disable_power</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">device_data</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: cryp_disable_power()&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ux500_cryp_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryp_device_data</span> <span class="o">*</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res_irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryp_ctx</span> <span class="o">*</span><span class="n">temp_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">device_data</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: platform_get_drvdata() failed!&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">current_ctx</span> <span class="o">==</span> <span class="o">++</span><span class="n">temp_ctx</span><span class="p">)</span>
		<span class="n">device_data</span><span class="o">-&gt;</span><span class="n">current_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">ctx_lock</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_data</span><span class="o">-&gt;</span><span class="n">current_ctx</span><span class="p">)</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_data</span><span class="p">.</span><span class="n">device_allocation</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cryp_enable_power</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">device_data</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s]: cryp_enable_power() failed!&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">res_irq</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res_irq</span><span class="p">)</span>
			<span class="n">enable_irq</span><span class="p">(</span><span class="n">res_irq</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">cryp_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>  <span class="o">=</span> <span class="n">ux500_cryp_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">ux500_cryp_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">ux500_cryp_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>  <span class="o">=</span> <span class="n">ux500_cryp_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>   <span class="o">=</span> <span class="n">ux500_cryp_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;cryp1&quot;</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ux500_cryp_mod_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;[%s] is called!&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">klist_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_data</span><span class="p">.</span><span class="n">device_list</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* Initialize the semaphore to 0 devices (locked state) */</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_data</span><span class="p">.</span><span class="n">device_allocation</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryp_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ux500_cryp_mod_fini</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;[%s] is called!&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryp_driver</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ux500_cryp_mod_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ux500_cryp_mod_fini</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">cryp_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for ST-Ericsson UX500 CRYP crypto engine.&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;aes-all&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;des-all&quot;</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
