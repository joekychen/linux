<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › devfreq › exynos4_bus.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>exynos4_bus.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* drivers/devfreq/exynos4210_memorybus.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2011 Samsung Electronics Co., Ltd.</span>
<span class="cm"> *		http://www.samsung.com/</span>
<span class="cm"> *	MyungJoo Ham &lt;myungjoo.ham@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * EXYNOS4 - Memory/Bus clock frequency scaling support in DEVFREQ framework</span>
<span class="cm"> *	This version supports EXYNOS4210 only. This changes bus frequencies</span>
<span class="cm"> *	and vddint voltages. Exynos4412/4212 should be able to be supported</span>
<span class="cm"> *	with minor modifications.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/suspend.h&gt;</span>
<span class="cp">#include &lt;linux/opp.h&gt;</span>
<span class="cp">#include &lt;linux/devfreq.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cm">/* Exynos4 ASV has been in the mailing list, but not upstreamed, yet. */</span>
<span class="cp">#ifdef CONFIG_EXYNOS_ASV</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exynos_result_of_asv</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;mach/regs-clock.h&gt;</span>

<span class="cp">#include &lt;plat/map-s5p.h&gt;</span>

<span class="cp">#define MAX_SAFEVOLT	1200000 </span><span class="cm">/* 1.2V */</span><span class="cp"></span>

<span class="k">enum</span> <span class="n">exynos4_busf_type</span> <span class="p">{</span>
	<span class="n">TYPE_BUSF_EXYNOS4210</span><span class="p">,</span>
	<span class="n">TYPE_BUSF_EXYNOS4x12</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Assume that the bus is saturated if the utilization is 40% */</span>
<span class="cp">#define BUS_SATURATION_RATIO	40</span>

<span class="k">enum</span> <span class="n">ppmu_counter</span> <span class="p">{</span>
	<span class="n">PPMU_PMNCNT0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">PPMU_PMCCNT1</span><span class="p">,</span>
	<span class="n">PPMU_PMNCNT2</span><span class="p">,</span>
	<span class="n">PPMU_PMNCNT3</span><span class="p">,</span>
	<span class="n">PPMU_PMNCNT_MAX</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">exynos4_ppmu</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">hw_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ccnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">[</span><span class="n">PPMU_PMNCNT_MAX</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">ccnt_overflow</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">count_overflow</span><span class="p">[</span><span class="n">PPMU_PMNCNT_MAX</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">busclk_level_idx</span> <span class="p">{</span>
	<span class="n">LV_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">LV_1</span><span class="p">,</span>
	<span class="n">LV_2</span><span class="p">,</span>
	<span class="n">LV_3</span><span class="p">,</span>
	<span class="n">LV_4</span><span class="p">,</span>
	<span class="n">_LV_END</span>
<span class="p">};</span>
<span class="cp">#define EX4210_LV_MAX	LV_2</span>
<span class="cp">#define EX4x12_LV_MAX	LV_4</span>
<span class="cp">#define EX4210_LV_NUM	(LV_2 + 1)</span>
<span class="cp">#define EX4x12_LV_NUM	(LV_4 + 1)</span>

<span class="k">struct</span> <span class="n">busfreq_data</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">exynos4_busf_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">devfreq</span> <span class="o">*</span><span class="n">devfreq</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">disabled</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">vdd_int</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">vdd_mif</span><span class="p">;</span> <span class="cm">/* Exynos4412/4212 only */</span>
	<span class="k">struct</span> <span class="n">opp</span> <span class="o">*</span><span class="n">curr_opp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exynos4_ppmu</span> <span class="n">dmc</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">pm_notifier</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>

	<span class="cm">/* Dividers calculated at boot/probe-time */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dmc_divtable</span><span class="p">[</span><span class="n">_LV_END</span><span class="p">];</span> <span class="cm">/* DMC0 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">top_divtable</span><span class="p">[</span><span class="n">_LV_END</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">bus_opp_table</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">clk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">volt</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* 4210 controls clock of mif and voltage of int */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_opp_table</span> <span class="n">exynos4210_busclk_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">LV_0</span><span class="p">,</span> <span class="mi">400000</span><span class="p">,</span> <span class="mi">1150000</span><span class="p">},</span>
	<span class="p">{</span><span class="n">LV_1</span><span class="p">,</span> <span class="mi">267000</span><span class="p">,</span> <span class="mi">1050000</span><span class="p">},</span>
	<span class="p">{</span><span class="n">LV_2</span><span class="p">,</span> <span class="mi">133000</span><span class="p">,</span> <span class="mi">1025000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * MIF is the main control knob clock for exynox4x12 MIF/INT</span>
<span class="cm"> * clock and voltage of both mif/int are controlled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_opp_table</span> <span class="n">exynos4x12_mifclk_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">LV_0</span><span class="p">,</span> <span class="mi">400000</span><span class="p">,</span> <span class="mi">1100000</span><span class="p">},</span>
	<span class="p">{</span><span class="n">LV_1</span><span class="p">,</span> <span class="mi">267000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">},</span>
	<span class="p">{</span><span class="n">LV_2</span><span class="p">,</span> <span class="mi">160000</span><span class="p">,</span> <span class="mi">950000</span><span class="p">},</span>
	<span class="p">{</span><span class="n">LV_3</span><span class="p">,</span> <span class="mi">133000</span><span class="p">,</span> <span class="mi">950000</span><span class="p">},</span>
	<span class="p">{</span><span class="n">LV_4</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="mi">950000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * INT is not the control knob of 4x12. LV_x is not meant to represent</span>
<span class="cm"> * the current performance. (MIF does)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_opp_table</span> <span class="n">exynos4x12_intclk_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">LV_0</span><span class="p">,</span> <span class="mi">200000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">},</span>
	<span class="p">{</span><span class="n">LV_1</span><span class="p">,</span> <span class="mi">160000</span><span class="p">,</span> <span class="mi">950000</span><span class="p">},</span>
	<span class="p">{</span><span class="n">LV_2</span><span class="p">,</span> <span class="mi">133000</span><span class="p">,</span> <span class="mi">925000</span><span class="p">},</span>
	<span class="p">{</span><span class="n">LV_3</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* TODO: asv volt definitions are &quot;__initdata&quot;? */</span>
<span class="cm">/* Some chips have different operating voltages */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exynos4210_asv_volt</span><span class="p">[][</span><span class="n">EX4210_LV_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">1150000</span><span class="p">,</span> <span class="mi">1050000</span><span class="p">,</span> <span class="mi">1050000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1125000</span><span class="p">,</span> <span class="mi">1025000</span><span class="p">,</span> <span class="mi">1025000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1100000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1075000</span><span class="p">,</span> <span class="mi">975000</span><span class="p">,</span> <span class="mi">975000</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1050000</span><span class="p">,</span> <span class="mi">950000</span><span class="p">,</span> <span class="mi">950000</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exynos4x12_mif_step_50</span><span class="p">[][</span><span class="n">EX4x12_LV_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 400      267     160     133     100 */</span>
	<span class="p">{</span><span class="mi">1050000</span><span class="p">,</span> <span class="mi">950000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">},</span> <span class="cm">/* ASV0 */</span>
	<span class="p">{</span><span class="mi">1050000</span><span class="p">,</span> <span class="mi">950000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">},</span> <span class="cm">/* ASV1 */</span>
	<span class="p">{</span><span class="mi">1050000</span><span class="p">,</span> <span class="mi">950000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">},</span> <span class="cm">/* ASV2 */</span>
	<span class="p">{</span><span class="mi">1050000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">},</span> <span class="cm">/* ASV3 */</span>
	<span class="p">{</span><span class="mi">1050000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">},</span> <span class="cm">/* ASV4 */</span>
	<span class="p">{</span><span class="mi">1050000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">},</span> <span class="cm">/* ASV5 */</span>
	<span class="p">{</span><span class="mi">1050000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">},</span> <span class="cm">/* ASV6 */</span>
	<span class="p">{</span><span class="mi">1050000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">},</span> <span class="cm">/* ASV7 */</span>
	<span class="p">{</span><span class="mi">1050000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">},</span> <span class="cm">/* ASV8 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exynos4x12_int_volt</span><span class="p">[][</span><span class="n">EX4x12_LV_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 200    160      133     100 */</span>
	<span class="p">{</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">950000</span><span class="p">,</span> <span class="mi">925000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">},</span> <span class="cm">/* ASV0 */</span>
	<span class="p">{</span><span class="mi">975000</span><span class="p">,</span>  <span class="mi">925000</span><span class="p">,</span> <span class="mi">925000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">},</span> <span class="cm">/* ASV1 */</span>
	<span class="p">{</span><span class="mi">950000</span><span class="p">,</span>  <span class="mi">925000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">,</span> <span class="mi">875000</span><span class="p">},</span> <span class="cm">/* ASV2 */</span>
	<span class="p">{</span><span class="mi">950000</span><span class="p">,</span>  <span class="mi">900000</span><span class="p">,</span> <span class="mi">900000</span><span class="p">,</span> <span class="mi">875000</span><span class="p">},</span> <span class="cm">/* ASV3 */</span>
	<span class="p">{</span><span class="mi">925000</span><span class="p">,</span>  <span class="mi">875000</span><span class="p">,</span> <span class="mi">875000</span><span class="p">,</span> <span class="mi">875000</span><span class="p">},</span> <span class="cm">/* ASV4 */</span>
	<span class="p">{</span><span class="mi">900000</span><span class="p">,</span>  <span class="mi">850000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">},</span> <span class="cm">/* ASV5 */</span>
	<span class="p">{</span><span class="mi">900000</span><span class="p">,</span>  <span class="mi">850000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">},</span> <span class="cm">/* ASV6 */</span>
	<span class="p">{</span><span class="mi">900000</span><span class="p">,</span>  <span class="mi">850000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">},</span> <span class="cm">/* ASV7 */</span>
	<span class="p">{</span><span class="mi">900000</span><span class="p">,</span>  <span class="mi">850000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">},</span> <span class="cm">/* ASV8 */</span>
<span class="p">};</span>

<span class="cm">/*** Clock Divider Data for Exynos4210 ***/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exynos4210_clkdiv_dmc0</span><span class="p">[][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clock divider value for following</span>
<span class="cm">	 * { DIVACP, DIVACP_PCLK, DIVDPHY, DIVDMC, DIVDMCD</span>
<span class="cm">	 *		DIVDMCP, DIVCOPY2, DIVCORE_TIMERS }</span>
<span class="cm">	 */</span>

	<span class="cm">/* DMC L0: 400MHz */</span>
	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="cm">/* DMC L1: 266.7MHz */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="cm">/* DMC L2: 133MHz */</span>
	<span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exynos4210_clkdiv_top</span><span class="p">[][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clock divider value for following</span>
<span class="cm">	 * { DIVACLK200, DIVACLK100, DIVACLK160, DIVACLK133, DIVONENAND }</span>
<span class="cm">	 */</span>
	<span class="cm">/* ACLK200 L0: 200MHz */</span>
	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="cm">/* ACLK200 L1: 160MHz */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="cm">/* ACLK200 L2: 133MHz */</span>
	<span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exynos4210_clkdiv_lr_bus</span><span class="p">[][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clock divider value for following</span>
<span class="cm">	 * { DIVGDL/R, DIVGPL/R }</span>
<span class="cm">	 */</span>
	<span class="cm">/* ACLK_GDL/R L1: 200MHz */</span>
	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="cm">/* ACLK_GDL/R L2: 160MHz */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="cm">/* ACLK_GDL/R L3: 133MHz */</span>
	<span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*** Clock Divider Data for Exynos4212/4412 ***/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exynos4x12_clkdiv_dmc0</span><span class="p">[][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clock divider value for following</span>
<span class="cm">	 * { DIVACP, DIVACP_PCLK, DIVDPHY, DIVDMC, DIVDMCD</span>
<span class="cm">	 *              DIVDMCP}</span>
<span class="cm">	 */</span>

	<span class="cm">/* DMC L0: 400MHz */</span>
	<span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="cm">/* DMC L1: 266.7MHz */</span>
	<span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="cm">/* DMC L2: 160MHz */</span>
	<span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="cm">/* DMC L3: 133MHz */</span>
	<span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="cm">/* DMC L4: 100MHz */</span>
	<span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exynos4x12_clkdiv_dmc1</span><span class="p">[][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clock divider value for following</span>
<span class="cm">	 * { G2DACP, DIVC2C, DIVC2C_ACLK }</span>
<span class="cm">	 */</span>

	<span class="cm">/* DMC L0: 400MHz */</span>
	<span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="cm">/* DMC L1: 266.7MHz */</span>
	<span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="cm">/* DMC L2: 160MHz */</span>
	<span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="cm">/* DMC L3: 133MHz */</span>
	<span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="cm">/* DMC L4: 100MHz */</span>
	<span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exynos4x12_clkdiv_top</span><span class="p">[][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clock divider value for following</span>
<span class="cm">	 * { DIVACLK266_GPS, DIVACLK100, DIVACLK160,</span>
<span class="cm">		DIVACLK133, DIVONENAND }</span>
<span class="cm">	 */</span>

	<span class="cm">/* ACLK_GDL/R L0: 200MHz */</span>
	<span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="cm">/* ACLK_GDL/R L1: 200MHz */</span>
	<span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="cm">/* ACLK_GDL/R L2: 160MHz */</span>
	<span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="cm">/* ACLK_GDL/R L3: 133MHz */</span>
	<span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="cm">/* ACLK_GDL/R L4: 100MHz */</span>
	<span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exynos4x12_clkdiv_lr_bus</span><span class="p">[][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clock divider value for following</span>
<span class="cm">	 * { DIVGDL/R, DIVGPL/R }</span>
<span class="cm">	 */</span>

	<span class="cm">/* ACLK_GDL/R L0: 200MHz */</span>
	<span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="cm">/* ACLK_GDL/R L1: 200MHz */</span>
	<span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="cm">/* ACLK_GDL/R L2: 160MHz */</span>
	<span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="cm">/* ACLK_GDL/R L3: 133MHz */</span>
	<span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="cm">/* ACLK_GDL/R L4: 100MHz */</span>
	<span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exynos4x12_clkdiv_sclkip</span><span class="p">[][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clock divider value for following</span>
<span class="cm">	 * { DIVMFC, DIVJPEG, DIVFIMC0~3}</span>
<span class="cm">	 */</span>

	<span class="cm">/* SCLK_MFC: 200MHz */</span>
	<span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="cm">/* SCLK_MFC: 200MHz */</span>
	<span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="cm">/* SCLK_MFC: 160MHz */</span>
	<span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span>
	<span class="cm">/* SCLK_MFC: 133MHz */</span>
	<span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span>
	<span class="cm">/* SCLK_MFC: 100MHz */</span>
	<span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">exynos4210_set_busclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">busfreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">opp</span> <span class="o">*</span><span class="n">opp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">LV_0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">EX4210_LV_NUM</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opp_get_freq</span><span class="p">(</span><span class="n">opp</span><span class="p">)</span> <span class="o">==</span> <span class="n">exynos4210_busclk_table</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">clk</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">EX4210_LV_NUM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Change Divider - DMC0 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc_divtable</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">EXYNOS4_CLKDIV_DMC0</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_STAT_DMC0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x11111111</span><span class="p">);</span>

	<span class="cm">/* Change Divider - TOP */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">top_divtable</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">EXYNOS4_CLKDIV_TOP</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_STAT_TOP</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x11111</span><span class="p">);</span>

	<span class="cm">/* Change Divider - LEFTBUS */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_LEFTBUS</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_BUS_GDLR_MASK</span> <span class="o">|</span> <span class="n">EXYNOS4_CLKDIV_BUS_GPLR_MASK</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">exynos4210_clkdiv_lr_bus</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_BUS_GDLR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">exynos4210_clkdiv_lr_bus</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_BUS_GPLR_SHIFT</span><span class="p">));</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">EXYNOS4_CLKDIV_LEFTBUS</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_STAT_LEFTBUS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x11</span><span class="p">);</span>

	<span class="cm">/* Change Divider - RIGHTBUS */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_RIGHTBUS</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_BUS_GDLR_MASK</span> <span class="o">|</span> <span class="n">EXYNOS4_CLKDIV_BUS_GPLR_MASK</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">exynos4210_clkdiv_lr_bus</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_BUS_GDLR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">exynos4210_clkdiv_lr_bus</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_BUS_GPLR_SHIFT</span><span class="p">));</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">EXYNOS4_CLKDIV_RIGHTBUS</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_STAT_RIGHTBUS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x11</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exynos4x12_set_busclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">busfreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">opp</span> <span class="o">*</span><span class="n">opp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">LV_0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">EX4x12_LV_NUM</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opp_get_freq</span><span class="p">(</span><span class="n">opp</span><span class="p">)</span> <span class="o">==</span> <span class="n">exynos4x12_mifclk_table</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">clk</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">EX4x12_LV_NUM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Change Divider - DMC0 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc_divtable</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">EXYNOS4_CLKDIV_DMC0</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_STAT_DMC0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x11111111</span><span class="p">);</span>

	<span class="cm">/* Change Divider - DMC1 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_DMC1</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_DMC1_G2D_ACP_MASK</span> <span class="o">|</span>
		<span class="n">EXYNOS4_CLKDIV_DMC1_C2C_MASK</span> <span class="o">|</span>
		<span class="n">EXYNOS4_CLKDIV_DMC1_C2CACLK_MASK</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">exynos4x12_clkdiv_dmc1</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_DMC1_G2D_ACP_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">exynos4x12_clkdiv_dmc1</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_DMC1_C2C_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">exynos4x12_clkdiv_dmc1</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_DMC1_C2CACLK_SHIFT</span><span class="p">));</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">EXYNOS4_CLKDIV_DMC1</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_STAT_DMC1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x111111</span><span class="p">);</span>

	<span class="cm">/* Change Divider - TOP */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_TOP</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_TOP_ACLK266_GPS_MASK</span> <span class="o">|</span>
		<span class="n">EXYNOS4_CLKDIV_TOP_ACLK100_MASK</span> <span class="o">|</span>
		<span class="n">EXYNOS4_CLKDIV_TOP_ACLK160_MASK</span> <span class="o">|</span>
		<span class="n">EXYNOS4_CLKDIV_TOP_ACLK133_MASK</span> <span class="o">|</span>
		<span class="n">EXYNOS4_CLKDIV_TOP_ONENAND_MASK</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">exynos4x12_clkdiv_top</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_TOP_ACLK266_GPS_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">exynos4x12_clkdiv_top</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_TOP_ACLK100_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">exynos4x12_clkdiv_top</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_TOP_ACLK160_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">exynos4x12_clkdiv_top</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_TOP_ACLK133_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">exynos4x12_clkdiv_top</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_TOP_ONENAND_SHIFT</span><span class="p">));</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">EXYNOS4_CLKDIV_TOP</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_STAT_TOP</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x11111</span><span class="p">);</span>

	<span class="cm">/* Change Divider - LEFTBUS */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_LEFTBUS</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_BUS_GDLR_MASK</span> <span class="o">|</span> <span class="n">EXYNOS4_CLKDIV_BUS_GPLR_MASK</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">exynos4x12_clkdiv_lr_bus</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_BUS_GDLR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">exynos4x12_clkdiv_lr_bus</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_BUS_GPLR_SHIFT</span><span class="p">));</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">EXYNOS4_CLKDIV_LEFTBUS</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_STAT_LEFTBUS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x11</span><span class="p">);</span>

	<span class="cm">/* Change Divider - RIGHTBUS */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_RIGHTBUS</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_BUS_GDLR_MASK</span> <span class="o">|</span> <span class="n">EXYNOS4_CLKDIV_BUS_GPLR_MASK</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">exynos4x12_clkdiv_lr_bus</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_BUS_GDLR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">exynos4x12_clkdiv_lr_bus</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_BUS_GPLR_SHIFT</span><span class="p">));</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">EXYNOS4_CLKDIV_RIGHTBUS</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_STAT_RIGHTBUS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x11</span><span class="p">);</span>

	<span class="cm">/* Change Divider - MFC */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_MFC</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_MFC_MASK</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">exynos4x12_clkdiv_sclkip</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_MFC_SHIFT</span><span class="p">));</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">EXYNOS4_CLKDIV_MFC</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_STAT_MFC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="cm">/* Change Divider - JPEG */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_CAM1</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_CAM1_JPEG_MASK</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">exynos4x12_clkdiv_sclkip</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_CAM1_JPEG_SHIFT</span><span class="p">));</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">EXYNOS4_CLKDIV_CAM1</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_STAT_CAM1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="cm">/* Change Divider - FIMC0~3 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_CAM</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_CAM_FIMC0_MASK</span> <span class="o">|</span> <span class="n">EXYNOS4_CLKDIV_CAM_FIMC1_MASK</span> <span class="o">|</span>
		<span class="n">EXYNOS4_CLKDIV_CAM_FIMC2_MASK</span> <span class="o">|</span> <span class="n">EXYNOS4_CLKDIV_CAM_FIMC3_MASK</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">exynos4x12_clkdiv_sclkip</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_CAM_FIMC0_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">exynos4x12_clkdiv_sclkip</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_CAM_FIMC1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">exynos4x12_clkdiv_sclkip</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_CAM_FIMC2_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">exynos4x12_clkdiv_sclkip</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
				<span class="n">EXYNOS4_CLKDIV_CAM_FIMC3_SHIFT</span><span class="p">));</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">EXYNOS4_CLKDIV_CAM</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_STAT_CAM1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x1111</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">busfreq_mon_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">busfreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ppmu_base</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_base</span><span class="p">;</span>

		<span class="cm">/* Reset PPMU */</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x8000000f</span><span class="p">,</span> <span class="n">ppmu_base</span> <span class="o">+</span> <span class="mh">0xf010</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x8000000f</span><span class="p">,</span> <span class="n">ppmu_base</span> <span class="o">+</span> <span class="mh">0xf050</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x6</span><span class="p">,</span> <span class="n">ppmu_base</span> <span class="o">+</span> <span class="mh">0xf000</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">ppmu_base</span> <span class="o">+</span> <span class="mh">0xf100</span><span class="p">);</span>

		<span class="cm">/* Set PPMU Event */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">event</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">;</span>
		<span class="n">__raw_writel</span><span class="p">(((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">event</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">),</span>
			     <span class="n">ppmu_base</span> <span class="o">+</span> <span class="mh">0xfc</span><span class="p">);</span>

		<span class="cm">/* Start PPMU */</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">ppmu_base</span> <span class="o">+</span> <span class="mh">0xf000</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">exynos4_read_ppmu</span><span class="p">(</span><span class="k">struct</span> <span class="n">busfreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ppmu_base</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_base</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">overflow</span><span class="p">;</span>

		<span class="cm">/* Stop PPMU */</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">ppmu_base</span> <span class="o">+</span> <span class="mh">0xf000</span><span class="p">);</span>

		<span class="cm">/* Update local data from PPMU */</span>
		<span class="n">overflow</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ppmu_base</span> <span class="o">+</span> <span class="mh">0xf050</span><span class="p">);</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ccnt</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ppmu_base</span> <span class="o">+</span> <span class="mh">0xf100</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ccnt_overflow</span> <span class="o">=</span> <span class="n">overflow</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">PPMU_PMNCNT_MAX</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span>
					<span class="n">ppmu_base</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0xf110</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">*</span> <span class="n">j</span><span class="p">)));</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count_overflow</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">overflow</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">busfreq_mon_reset</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exynos4x12_get_intspec</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mifclk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">exynos4x12_intclk_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clk</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">exynos4x12_intclk_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clk</span> <span class="o">&lt;=</span> <span class="n">mifclk</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exynos4_bus_setvolt</span><span class="p">(</span><span class="k">struct</span> <span class="n">busfreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">opp</span> <span class="o">*</span><span class="n">opp</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">opp</span> <span class="o">*</span><span class="n">oldopp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">volt</span> <span class="o">=</span> <span class="n">opp_get_voltage</span><span class="p">(</span><span class="n">opp</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TYPE_BUSF_EXYNOS4210</span>:
		<span class="cm">/* OPP represents DMC clock + INT voltage */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">regulator_set_voltage</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vdd_int</span><span class="p">,</span> <span class="n">volt</span><span class="p">,</span>
					    <span class="n">MAX_SAFEVOLT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TYPE_BUSF_EXYNOS4x12</span>:
		<span class="cm">/* OPP represents MIF clock + MIF voltage */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">regulator_set_voltage</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vdd_mif</span><span class="p">,</span> <span class="n">volt</span><span class="p">,</span>
					    <span class="n">MAX_SAFEVOLT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">exynos4x12_get_intspec</span><span class="p">(</span><span class="n">opp_get_freq</span><span class="p">(</span><span class="n">opp</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">regulator_set_voltage</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vdd_mif</span><span class="p">,</span>
					      <span class="n">opp_get_voltage</span><span class="p">(</span><span class="n">oldopp</span><span class="p">),</span>
					      <span class="n">MAX_SAFEVOLT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">regulator_set_voltage</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vdd_int</span><span class="p">,</span>
					    <span class="n">exynos4x12_intclk_table</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">volt</span><span class="p">,</span>
					    <span class="n">MAX_SAFEVOLT</span><span class="p">);</span>
		<span class="cm">/*  Try to recover */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">regulator_set_voltage</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vdd_mif</span><span class="p">,</span>
					      <span class="n">opp_get_voltage</span><span class="p">(</span><span class="n">oldopp</span><span class="p">),</span>
					      <span class="n">MAX_SAFEVOLT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exynos4_bus_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">_freq</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">platform_device</span><span class="p">,</span>
						    <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">busfreq_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">opp</span> <span class="o">*</span><span class="n">opp</span> <span class="o">=</span> <span class="n">devfreq_recommended_opp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">_freq</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">opp_get_freq</span><span class="p">(</span><span class="n">opp</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_freq</span> <span class="o">=</span> <span class="n">opp_get_freq</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">curr_opp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">opp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">opp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_freq</span> <span class="o">==</span> <span class="n">freq</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;targetting %lukHz %luuV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">opp_get_voltage</span><span class="p">(</span><span class="n">opp</span><span class="p">));</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_freq</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">exynos4_bus_setvolt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">opp</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">curr_opp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_freq</span> <span class="o">!=</span> <span class="n">freq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TYPE_BUSF_EXYNOS4210</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">exynos4210_set_busclk</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">opp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TYPE_BUSF_EXYNOS4x12</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">exynos4x12_set_busclk</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">opp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_freq</span> <span class="o">&gt;</span> <span class="n">freq</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">exynos4_bus_setvolt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">opp</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">curr_opp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">curr_opp</span> <span class="o">=</span> <span class="n">opp</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exynos4_get_busier_dmc</span><span class="p">(</span><span class="k">struct</span> <span class="n">busfreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">p0</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">p0</span> <span class="o">*=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ccnt</span><span class="p">;</span>
	<span class="n">p1</span> <span class="o">*=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ccnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ccnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p0</span> <span class="o">&gt;</span> <span class="n">p1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exynos4_bus_get_dev_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">devfreq_dev_status</span> <span class="o">*</span><span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">busfreq_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">busier_dmc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cycles_x2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* 2 x cycles */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timing</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">memctrl</span><span class="p">;</span>

	<span class="n">exynos4_read_ppmu</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">busier_dmc</span> <span class="o">=</span> <span class="n">exynos4_get_busier_dmc</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">current_frequency</span> <span class="o">=</span> <span class="n">opp_get_freq</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">curr_opp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">busier_dmc</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">S5P_VA_DMC1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">S5P_VA_DMC0</span><span class="p">;</span>

	<span class="n">memctrl</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">);</span> <span class="cm">/* one of DDR2/3/LPDDR2 */</span>
	<span class="n">timing</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">);</span> <span class="cm">/* CL or WL/RL values */</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">memctrl</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x4</span>: <span class="cm">/* DDR2 */</span>
		<span class="n">cycles_x2</span> <span class="o">=</span> <span class="p">((</span><span class="n">timing</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x5</span>: <span class="cm">/* LPDDR2 */</span>
	<span class="k">case</span> <span class="mh">0x6</span>: <span class="cm">/* DDR3 */</span>
		<span class="n">cycles_x2</span> <span class="o">=</span> <span class="p">((</span><span class="n">timing</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">timing</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Unknown Memory Type(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">memctrl</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Number of cycles spent on memory access */</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">busy_time</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc</span><span class="p">[</span><span class="n">busier_dmc</span><span class="p">].</span><span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">cycles_x2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">busy_time</span> <span class="o">*=</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">BUS_SATURATION_RATIO</span><span class="p">;</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">total_time</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc</span><span class="p">[</span><span class="n">busier_dmc</span><span class="p">].</span><span class="n">ccnt</span><span class="p">;</span>

	<span class="cm">/* If the counters have overflown, retry */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc</span><span class="p">[</span><span class="n">busier_dmc</span><span class="p">].</span><span class="n">ccnt_overflow</span> <span class="o">||</span>
	    <span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc</span><span class="p">[</span><span class="n">busier_dmc</span><span class="p">].</span><span class="n">count_overflow</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">exynos4_bus_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">busfreq_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">devfreq_unregister_opp_notifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">devfreq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">devfreq_dev_profile</span> <span class="n">exynos4_devfreq_profile</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">initial_freq</span>	<span class="o">=</span> <span class="mi">400000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">polling_ms</span>	<span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target</span>		<span class="o">=</span> <span class="n">exynos4_bus_target</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_dev_status</span>	<span class="o">=</span> <span class="n">exynos4_bus_get_dev_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span>		<span class="o">=</span> <span class="n">exynos4_bus_exit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exynos4210_init_tables</span><span class="p">(</span><span class="k">struct</span> <span class="n">busfreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mgrp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_DMC0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">LV_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EX4210_LV_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_DMC0_ACP_MASK</span> <span class="o">|</span>
			<span class="n">EXYNOS4_CLKDIV_DMC0_ACPPCLK_MASK</span> <span class="o">|</span>
			<span class="n">EXYNOS4_CLKDIV_DMC0_DPHY_MASK</span> <span class="o">|</span>
			<span class="n">EXYNOS4_CLKDIV_DMC0_DMC_MASK</span> <span class="o">|</span>
			<span class="n">EXYNOS4_CLKDIV_DMC0_DMCD_MASK</span> <span class="o">|</span>
			<span class="n">EXYNOS4_CLKDIV_DMC0_DMCP_MASK</span> <span class="o">|</span>
			<span class="n">EXYNOS4_CLKDIV_DMC0_COPY2_MASK</span> <span class="o">|</span>
			<span class="n">EXYNOS4_CLKDIV_DMC0_CORETI_MASK</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">exynos4210_clkdiv_dmc0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
					<span class="n">EXYNOS4_CLKDIV_DMC0_ACP_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">exynos4210_clkdiv_dmc0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
					<span class="n">EXYNOS4_CLKDIV_DMC0_ACPPCLK_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">exynos4210_clkdiv_dmc0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
					<span class="n">EXYNOS4_CLKDIV_DMC0_DPHY_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">exynos4210_clkdiv_dmc0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
					<span class="n">EXYNOS4_CLKDIV_DMC0_DMC_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">exynos4210_clkdiv_dmc0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
					<span class="n">EXYNOS4_CLKDIV_DMC0_DMCD_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">exynos4210_clkdiv_dmc0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
					<span class="n">EXYNOS4_CLKDIV_DMC0_DMCP_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">exynos4210_clkdiv_dmc0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
					<span class="n">EXYNOS4_CLKDIV_DMC0_COPY2_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">exynos4210_clkdiv_dmc0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
					<span class="n">EXYNOS4_CLKDIV_DMC0_CORETI_SHIFT</span><span class="p">));</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc_divtable</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_TOP</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">LV_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span>  <span class="n">EX4210_LV_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_TOP_ACLK200_MASK</span> <span class="o">|</span>
			<span class="n">EXYNOS4_CLKDIV_TOP_ACLK100_MASK</span> <span class="o">|</span>
			<span class="n">EXYNOS4_CLKDIV_TOP_ACLK160_MASK</span> <span class="o">|</span>
			<span class="n">EXYNOS4_CLKDIV_TOP_ACLK133_MASK</span> <span class="o">|</span>
			<span class="n">EXYNOS4_CLKDIV_TOP_ONENAND_MASK</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">exynos4210_clkdiv_top</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
					<span class="n">EXYNOS4_CLKDIV_TOP_ACLK200_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">exynos4210_clkdiv_top</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
					<span class="n">EXYNOS4_CLKDIV_TOP_ACLK100_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">exynos4210_clkdiv_top</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
					<span class="n">EXYNOS4_CLKDIV_TOP_ACLK160_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">exynos4210_clkdiv_top</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
					<span class="n">EXYNOS4_CLKDIV_TOP_ACLK133_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">exynos4210_clkdiv_top</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
					<span class="n">EXYNOS4_CLKDIV_TOP_ONENAND_SHIFT</span><span class="p">));</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">top_divtable</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_EXYNOS_ASV</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">exynos4_result_of_asv</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Max voltages for the reliability of the unknown */</span>
<span class="cp">#endif</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ASV Group of Exynos4 is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="cm">/* Use merged grouping for voltage */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">mgrp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">mgrp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">mgrp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">mgrp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">mgrp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Unknown ASV Group. Use max voltage.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mgrp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">LV_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EX4210_LV_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">exynos4210_busclk_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">volt</span> <span class="o">=</span> <span class="n">exynos4210_asv_volt</span><span class="p">[</span><span class="n">mgrp</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">LV_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EX4210_LV_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">opp_add</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">exynos4210_busclk_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clk</span><span class="p">,</span>
			      <span class="n">exynos4210_busclk_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">volt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot add opp entries.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exynos4x12_init_tables</span><span class="p">(</span><span class="k">struct</span> <span class="n">busfreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Enable pause function for DREX2 DVFS */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_DMC_PAUSE_CTRL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">EXYNOS4_DMC_PAUSE_ENABLE</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">EXYNOS4_DMC_PAUSE_CTRL</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_DMC0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span>  <span class="n">EX4x12_LV_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EXYNOS4_CLKDIV_DMC0_ACP_MASK</span> <span class="o">|</span>
			<span class="n">EXYNOS4_CLKDIV_DMC0_ACPPCLK_MASK</span> <span class="o">|</span>
			<span class="n">EXYNOS4_CLKDIV_DMC0_DPHY_MASK</span> <span class="o">|</span>
			<span class="n">EXYNOS4_CLKDIV_DMC0_DMC_MASK</span> <span class="o">|</span>
			<span class="n">EXYNOS4_CLKDIV_DMC0_DMCD_MASK</span> <span class="o">|</span>
			<span class="n">EXYNOS4_CLKDIV_DMC0_DMCP_MASK</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">exynos4x12_clkdiv_dmc0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
					<span class="n">EXYNOS4_CLKDIV_DMC0_ACP_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">exynos4x12_clkdiv_dmc0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
					<span class="n">EXYNOS4_CLKDIV_DMC0_ACPPCLK_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">exynos4x12_clkdiv_dmc0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
					<span class="n">EXYNOS4_CLKDIV_DMC0_DPHY_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">exynos4x12_clkdiv_dmc0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
					<span class="n">EXYNOS4_CLKDIV_DMC0_DMC_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">exynos4x12_clkdiv_dmc0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
					<span class="n">EXYNOS4_CLKDIV_DMC0_DMCD_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">exynos4x12_clkdiv_dmc0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
					<span class="n">EXYNOS4_CLKDIV_DMC0_DMCP_SHIFT</span><span class="p">));</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc_divtable</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_EXYNOS_ASV</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">exynos4_result_of_asv</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Max voltages for the reliability of the unknown */</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ASV Group of Exynos4x12 is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EX4x12_LV_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">exynos4x12_mifclk_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">volt</span> <span class="o">=</span>
			<span class="n">exynos4x12_mif_step_50</span><span class="p">[</span><span class="n">tmp</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
		<span class="n">exynos4x12_intclk_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">volt</span> <span class="o">=</span>
			<span class="n">exynos4x12_int_volt</span><span class="p">[</span><span class="n">tmp</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EX4x12_LV_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">opp_add</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">exynos4x12_mifclk_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clk</span><span class="p">,</span>
			      <span class="n">exynos4x12_mifclk_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">volt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Fail to add opp entries.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exynos4_busfreq_pm_notifier_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">busfreq_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="k">struct</span> <span class="n">busfreq_data</span><span class="p">,</span>
						 <span class="n">pm_notifier</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">opp</span> <span class="o">*</span><span class="n">opp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">maxfreq</span> <span class="o">=</span> <span class="n">ULONG_MAX</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PM_SUSPEND_PREPARE</span>:
		<span class="cm">/* Set Fastest and Deactivate DVFS */</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">opp</span> <span class="o">=</span> <span class="n">opp_find_freq_floor</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">maxfreq</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">exynos4_bus_setvolt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">opp</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">curr_opp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TYPE_BUSF_EXYNOS4210</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">exynos4210_set_busclk</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">opp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TYPE_BUSF_EXYNOS4x12</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">exynos4x12_set_busclk</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">opp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">curr_opp</span> <span class="o">=</span> <span class="n">opp</span><span class="p">;</span>
<span class="nl">unlock:</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_POST_RESTORE</span>:
	<span class="k">case</span> <span class="n">PM_POST_SUSPEND</span>:
		<span class="cm">/* Reactivate */</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="nf">exynos4_busfreq_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">busfreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">opp</span> <span class="o">*</span><span class="n">opp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">busfreq_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot allocate memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id_entry</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hw_base</span> <span class="o">=</span> <span class="n">S5P_VA_DMC0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dmc</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">hw_base</span> <span class="o">=</span> <span class="n">S5P_VA_DMC1</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pm_notifier</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">exynos4_busfreq_pm_notifier_event</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TYPE_BUSF_EXYNOS4210</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">exynos4210_init_tables</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TYPE_BUSF_EXYNOS4x12</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">exynos4x12_init_tables</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot determine the device id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_regulator</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">vdd_int</span> <span class="o">=</span> <span class="n">regulator_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vdd_int&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vdd_int</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot get the regulator </span><span class="se">\&quot;</span><span class="s">vdd_int</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vdd_int</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_regulator</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_BUSF_EXYNOS4x12</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">vdd_mif</span> <span class="o">=</span> <span class="n">regulator_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vdd_mif&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vdd_mif</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot get the regulator </span><span class="se">\&quot;</span><span class="s">vdd_mif</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vdd_mif</span><span class="p">);</span>
			<span class="n">regulator_put</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vdd_int</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_regulator</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">opp</span> <span class="o">=</span> <span class="n">opp_find_freq_floor</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exynos4_devfreq_profile</span><span class="p">.</span><span class="n">initial_freq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">opp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid initial frequency %lu kHz.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">exynos4_devfreq_profile</span><span class="p">.</span><span class="n">initial_freq</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">opp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_opp_add</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">curr_opp</span> <span class="o">=</span> <span class="n">opp</span><span class="p">;</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">busfreq_mon_reset</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">devfreq</span> <span class="o">=</span> <span class="n">devfreq_add_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exynos4_devfreq_profile</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">devfreq_simple_ondemand</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">devfreq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">devfreq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_opp_add</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devfreq_register_opp_notifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">devfreq</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_pm_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pm_notifier</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to setup pm notifier</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_devfreq_add</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_devfreq_add:</span>
	<span class="n">devfreq_remove_device</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">devfreq</span><span class="p">);</span>
<span class="nl">err_opp_add:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vdd_mif</span><span class="p">)</span>
		<span class="n">regulator_put</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vdd_mif</span><span class="p">);</span>
	<span class="n">regulator_put</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vdd_int</span><span class="p">);</span>
<span class="nl">err_regulator:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__devexit</span> <span class="kt">int</span> <span class="nf">exynos4_busfreq_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">busfreq_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">unregister_pm_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pm_notifier</span><span class="p">);</span>
	<span class="n">devfreq_remove_device</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">devfreq</span><span class="p">);</span>
	<span class="n">regulator_put</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vdd_int</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vdd_mif</span><span class="p">)</span>
		<span class="n">regulator_put</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vdd_mif</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">exynos4_busfreq_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">busfreq_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">busfreq_mon_reset</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">exynos4_busfreq_pm</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">resume</span>	<span class="o">=</span> <span class="n">exynos4_busfreq_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">platform_device_id</span> <span class="n">exynos4_busfreq_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;exynos4210-busfreq&quot;</span><span class="p">,</span> <span class="n">TYPE_BUSF_EXYNOS4210</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;exynos4412-busfreq&quot;</span><span class="p">,</span> <span class="n">TYPE_BUSF_EXYNOS4x12</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;exynos4212-busfreq&quot;</span><span class="p">,</span> <span class="n">TYPE_BUSF_EXYNOS4x12</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">exynos4_busfreq_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">exynos4_busfreq_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">exynos4_busfreq_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">exynos4_busfreq_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;exynos4-busfreq&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">exynos4_busfreq_pm</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">exynos4_busfreq_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exynos4_busfreq_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">late_initcall</span><span class="p">(</span><span class="n">exynos4_busfreq_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exynos4_busfreq_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exynos4_busfreq_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exynos4_busfreq_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;EXYNOS4 busfreq driver with devfreq framework&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;MyungJoo Ham &lt;myungjoo.ham@samsung.com&gt;&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
