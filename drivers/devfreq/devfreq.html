<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › devfreq › devfreq.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>devfreq.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * devfreq: Generic Dynamic Voltage and Frequency Scaling (DVFS) Framework</span>
<span class="cm"> *	    for Non-CPU Devices.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Samsung Electronics</span>
<span class="cm"> *	MyungJoo Ham &lt;myungjoo.ham@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/opp.h&gt;</span>
<span class="cp">#include &lt;linux/devfreq.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/printk.h&gt;</span>
<span class="cp">#include &lt;linux/hrtimer.h&gt;</span>
<span class="cp">#include &quot;governor.h&quot;</span>

<span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">devfreq_class</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * devfreq_work periodically monitors every registered device.</span>
<span class="cm"> * The minimum polling interval is one jiffy. The polling interval is</span>
<span class="cm"> * determined by the minimum polling period among all polling devfreq</span>
<span class="cm"> * devices. The resolution of polling interval is one jiffy.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">polling</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">devfreq_wq</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">devfreq_work</span><span class="p">;</span>

<span class="cm">/* wait removing if this is to be removed */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">devfreq</span> <span class="o">*</span><span class="n">wait_remove_device</span><span class="p">;</span>

<span class="cm">/* The list of all device-devfreq */</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">devfreq_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">devfreq_list_lock</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * find_device_devfreq() - find devfreq struct using device pointer</span>
<span class="cm"> * @dev:	device pointer used to lookup device devfreq.</span>
<span class="cm"> *</span>
<span class="cm"> * Search the list of device devfreqs and return the matched device&#39;s</span>
<span class="cm"> * devfreq info. devfreq_list_lock should be held by the caller.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">devfreq</span> <span class="o">*</span><span class="nf">find_device_devfreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">devfreq</span> <span class="o">*</span><span class="n">tmp_devfreq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;DEVFREQ: %s: Invalid parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">),</span>
	     <span class="s">&quot;devfreq_list_lock must be locked.&quot;</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp_devfreq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devfreq_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_devfreq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">tmp_devfreq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * update_devfreq() - Reevaluate the device and configure frequency.</span>
<span class="cm"> * @devfreq:	the devfreq instance.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: Lock devfreq-&gt;lock before calling update_devfreq</span>
<span class="cm"> *	 This function is exported for governors.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">update_devfreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">devfreq</span> <span class="o">*</span><span class="n">devfreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">freq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="s">&quot;devfreq-&gt;lock must be locked by the caller.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reevaluate the proper frequency */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">get_target_freq</span><span class="p">(</span><span class="n">devfreq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Adjust the freuqency with user freq and QoS.</span>
<span class="cm">	 *</span>
<span class="cm">	 * List from the highest proiority</span>
<span class="cm">	 * max_freq (probably called by thermal when it&#39;s too hot)</span>
<span class="cm">	 * min_freq</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">min_freq</span> <span class="o">&amp;&amp;</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">min_freq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">min_freq</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DEVFREQ_FLAG_LEAST_UPPER_BOUND</span><span class="p">;</span> <span class="cm">/* Use GLB */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">max_freq</span> <span class="o">&amp;&amp;</span> <span class="n">freq</span> <span class="o">&gt;</span> <span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">max_freq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">max_freq</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">DEVFREQ_FLAG_LEAST_UPPER_BOUND</span><span class="p">;</span> <span class="cm">/* Use LUB */</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">(</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freq</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">previous_freq</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * devfreq_notifier_call() - Notify that the device frequency requirements</span>
<span class="cm"> *			   has been changed out of devfreq framework.</span>
<span class="cm"> * @nb		the notifier_block (supposed to be devfreq-&gt;nb)</span>
<span class="cm"> * @type	not used</span>
<span class="cm"> * @devp	not used</span>
<span class="cm"> *</span>
<span class="cm"> * Called by a notifier that uses devfreq-&gt;nb.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">devfreq_notifier_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="p">,</span>
				 <span class="kt">void</span> <span class="o">*</span><span class="n">devp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">devfreq</span> <span class="o">*</span><span class="n">devfreq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">devfreq</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">update_devfreq</span><span class="p">(</span><span class="n">devfreq</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _remove_devfreq() - Remove devfreq from the device.</span>
<span class="cm"> * @devfreq:	the devfreq struct</span>
<span class="cm"> * @skip:	skip calling device_unregister().</span>
<span class="cm"> *</span>
<span class="cm"> * Note that the caller should lock devfreq-&gt;lock before calling</span>
<span class="cm"> * this. _remove_devfreq() will unlock it and free devfreq</span>
<span class="cm"> * internally. devfreq_list_lock should be locked by the caller</span>
<span class="cm"> * as well (not relased at return)</span>
<span class="cm"> *</span>
<span class="cm"> * Lock usage:</span>
<span class="cm"> * devfreq-&gt;lock: locked before call.</span>
<span class="cm"> *		  unlocked at return (and freed)</span>
<span class="cm"> * devfreq_list_lock: locked before call.</span>
<span class="cm"> *		      kept locked at return.</span>
<span class="cm"> *		      if devfreq is centrally polled.</span>
<span class="cm"> *</span>
<span class="cm"> * Freed memory:</span>
<span class="cm"> * devfreq</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_remove_devfreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">devfreq</span> <span class="o">*</span><span class="n">devfreq</span><span class="p">,</span> <span class="n">bool</span> <span class="n">skip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="s">&quot;devfreq-&gt;lock must be locked by the caller.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">no_central_polling</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="s">&quot;devfreq_list_lock must be locked by the caller.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">being_removed</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">being_removed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">)</span>
		<span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">(</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">)</span>
		<span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">(</span><span class="n">devfreq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skip</span> <span class="o">&amp;&amp;</span> <span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">no_central_polling</span><span class="p">)</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">devfreq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * devfreq_dev_release() - Callback for struct device to release the device.</span>
<span class="cm"> * @dev:	the devfreq device</span>
<span class="cm"> *</span>
<span class="cm"> * This calls _remove_devfreq() if _remove_devfreq() is not called.</span>
<span class="cm"> * Note that devfreq_dev_release() could be called by _remove_devfreq() as</span>
<span class="cm"> * well as by others unregistering the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">devfreq_dev_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">devfreq</span> <span class="o">*</span><span class="n">devfreq</span> <span class="o">=</span> <span class="n">to_devfreq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">central_polling</span> <span class="o">=</span> <span class="o">!</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">no_central_polling</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If devfreq_dev_release() was called by device_unregister() of</span>
<span class="cm">	 * _remove_devfreq(), we cannot mutex_lock(&amp;devfreq-&gt;lock) and</span>
<span class="cm">	 * being_removed is already set. This also partially checks the case</span>
<span class="cm">	 * where devfreq_dev_release() is called from a thread other than</span>
<span class="cm">	 * the one called _remove_devfreq(); however, this case is</span>
<span class="cm">	 * dealt completely with another following being_removed check.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Because being_removed is never being</span>
<span class="cm">	 * unset, we do not need to worry about race conditions on</span>
<span class="cm">	 * being_removed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">being_removed</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">central_polling</span><span class="p">)</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check being_removed flag again for the case where</span>
<span class="cm">	 * devfreq_dev_release() was called in a thread other than the one</span>
<span class="cm">	 * possibly called _remove_devfreq().</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">being_removed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* devfreq-&gt;lock is unlocked and removed in _removed_devfreq() */</span>
	<span class="n">_remove_devfreq</span><span class="p">(</span><span class="n">devfreq</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">central_polling</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * devfreq_monitor() - Periodically poll devfreq objects.</span>
<span class="cm"> * @work: the work struct used to run devfreq_monitor periodically.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">devfreq_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_polled_at</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">devfreq</span> <span class="o">*</span><span class="n">devfreq</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">jiffies_passed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_jiffies</span> <span class="o">=</span> <span class="n">ULONG_MAX</span><span class="p">,</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* Initially last_polled_at = 0, polling every device at bootup */</span>
	<span class="n">jiffies_passed</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">last_polled_at</span><span class="p">;</span>
	<span class="n">last_polled_at</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jiffies_passed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">jiffies_passed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">devfreq</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devfreq_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>

		<span class="cm">/* Do not remove tmp for a while */</span>
		<span class="n">wait_remove_device</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">no_central_polling</span> <span class="o">||</span>
		    <span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">next_polling</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Reduce more next_polling if devfreq_wq took an extra</span>
<span class="cm">		 * delay. (i.e., CPU has been idled.)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">next_polling</span> <span class="o">&lt;=</span> <span class="n">jiffies_passed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">update_devfreq</span><span class="p">(</span><span class="n">devfreq</span><span class="p">);</span>

			<span class="cm">/* Remove a devfreq with an error. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">error</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Due to update_devfreq error(%d), devfreq(%s) is removed from the device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">error</span><span class="p">,</span> <span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

				<span class="cm">/*</span>
<span class="cm">				 * Unlock devfreq before locking the list</span>
<span class="cm">				 * in order to avoid deadlock with</span>
<span class="cm">				 * find_device_devfreq or others</span>
<span class="cm">				 */</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">);</span>
				<span class="cm">/* Check if devfreq is already removed */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">find_device_devfreq</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="cm">/* This unlocks devfreq-&gt;lock and free it */</span>
				<span class="n">_remove_devfreq</span><span class="p">(</span><span class="n">devfreq</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">next_polling</span> <span class="o">=</span> <span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">polling_jiffies</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">next_polling</span> <span class="o">-=</span> <span class="n">jiffies_passed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">next_polling</span><span class="p">)</span>
			<span class="n">next_jiffies</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_jiffies</span> <span class="o">&gt;</span> <span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">next_polling</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">next_polling</span> <span class="o">:</span> <span class="n">next_jiffies</span><span class="p">;</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wait_remove_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">next_jiffies</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">next_jiffies</span> <span class="o">&lt;</span> <span class="n">ULONG_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">polling</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">devfreq_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devfreq_work</span><span class="p">,</span> <span class="n">next_jiffies</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">polling</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * devfreq_add_device() - Add devfreq feature to the device</span>
<span class="cm"> * @dev:	the device to add devfreq feature.</span>
<span class="cm"> * @profile:	device-specific profile to run devfreq.</span>
<span class="cm"> * @governor:	the policy to choose frequency.</span>
<span class="cm"> * @data:	private data for the governor. The devfreq framework does not</span>
<span class="cm"> *		touch this value.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">devfreq</span> <span class="o">*</span><span class="nf">devfreq_add_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">devfreq_dev_profile</span> <span class="o">*</span><span class="n">profile</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">devfreq_governor</span> <span class="o">*</span><span class="n">governor</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">devfreq</span> <span class="o">*</span><span class="n">devfreq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">profile</span> <span class="o">||</span> <span class="o">!</span><span class="n">governor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Invalid parameters.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">no_central_polling</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">);</span>
		<span class="n">devfreq</span> <span class="o">=</span> <span class="n">find_device_devfreq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devfreq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Unable to create devfreq for the device. It already has one.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">devfreq</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">devfreq</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devfreq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Unable to create devfreq for the device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">devfreq_class</span><span class="p">;</span>
	<span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">devfreq_dev_release</span><span class="p">;</span>
	<span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="p">;</span>
	<span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">governor</span> <span class="o">=</span> <span class="n">governor</span><span class="p">;</span>
	<span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">previous_freq</span> <span class="o">=</span> <span class="n">profile</span><span class="o">-&gt;</span><span class="n">initial_freq</span><span class="p">;</span>
	<span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">next_polling</span> <span class="o">=</span> <span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">polling_jiffies</span>
			      <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">polling_ms</span><span class="p">);</span>
	<span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">devfreq_notifier_call</span><span class="p">;</span>

	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">governor</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">devfreq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_init</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">no_central_polling</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">);</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devfreq_list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devfreq_wq</span> <span class="o">&amp;&amp;</span> <span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">next_polling</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">polling</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">polling</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">devfreq_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devfreq_work</span><span class="p">,</span>
				   <span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">next_polling</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">devfreq</span><span class="p">;</span>

<span class="nl">err_init:</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_dev:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">devfreq</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * devfreq_remove_device() - Remove devfreq feature from a device.</span>
<span class="cm"> * @devfreq	the devfreq instance to be removed</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">devfreq_remove_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">devfreq</span> <span class="o">*</span><span class="n">devfreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">central_polling</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devfreq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">central_polling</span> <span class="o">=</span> <span class="o">!</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">no_central_polling</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">central_polling</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">wait_remove_device</span> <span class="o">==</span> <span class="n">devfreq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">);</span>
			<span class="n">schedule</span><span class="p">();</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">_remove_devfreq</span><span class="p">(</span><span class="n">devfreq</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="cm">/* it unlocks devfreq-&gt;lock */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">central_polling</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_governor</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">to_devfreq</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">to_devfreq</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">previous_freq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_polling_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">to_devfreq</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">polling_ms</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_polling_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">devfreq</span> <span class="o">*</span><span class="n">df</span> <span class="o">=</span> <span class="n">to_devfreq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">df</span><span class="o">-&gt;</span><span class="n">profile</span><span class="o">-&gt;</span><span class="n">polling_ms</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">df</span><span class="o">-&gt;</span><span class="n">next_polling</span> <span class="o">=</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">polling_jiffies</span>
			 <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">no_central_polling</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">next_polling</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">polling</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">polling</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">devfreq_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devfreq_work</span><span class="p">,</span>
				   <span class="n">df</span><span class="o">-&gt;</span><span class="n">next_polling</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_central_polling</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="o">!</span><span class="n">to_devfreq</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">no_central_polling</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_min_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">devfreq</span> <span class="o">*</span><span class="n">df</span> <span class="o">=</span> <span class="n">to_devfreq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lu&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">max</span> <span class="o">=</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">max_freq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="n">max</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">df</span><span class="o">-&gt;</span><span class="n">min_freq</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">update_devfreq</span><span class="p">(</span><span class="n">df</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_min_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">to_devfreq</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">min_freq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_max_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">devfreq</span> <span class="o">*</span><span class="n">df</span> <span class="o">=</span> <span class="n">to_devfreq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">min</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lu&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">min</span> <span class="o">=</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">min_freq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="n">min</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">df</span><span class="o">-&gt;</span><span class="n">max_freq</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">update_devfreq</span><span class="p">(</span><span class="n">df</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_max_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">to_devfreq</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">max_freq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">devfreq_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">governor</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_governor</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">cur_freq</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_freq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">central_polling</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_central_polling</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">polling_interval</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_polling_interval</span><span class="p">,</span>
	       <span class="n">store_polling_interval</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">min_freq</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_min_freq</span><span class="p">,</span> <span class="n">store_min_freq</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">max_freq</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_max_freq</span><span class="p">,</span> <span class="n">store_max_freq</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * devfreq_start_polling() - Initialize data structure for devfreq framework and</span>
<span class="cm"> *			   start polling registered devfreq devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">devfreq_start_polling</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">);</span>
	<span class="n">polling</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">devfreq_wq</span> <span class="o">=</span> <span class="n">create_freezable_workqueue</span><span class="p">(</span><span class="s">&quot;devfreq_wq&quot;</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK_DEFERRABLE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_work</span><span class="p">,</span> <span class="n">devfreq_monitor</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_list_lock</span><span class="p">);</span>

	<span class="n">devfreq_monitor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devfreq_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">late_initcall</span><span class="p">(</span><span class="n">devfreq_start_polling</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">devfreq_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">devfreq_class</span> <span class="o">=</span> <span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="s">&quot;devfreq&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devfreq_class</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: couldn&#39;t create class</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">devfreq_class</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">devfreq_class</span><span class="o">-&gt;</span><span class="n">dev_attrs</span> <span class="o">=</span> <span class="n">devfreq_attrs</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">devfreq_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">devfreq_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">class_destroy</span><span class="p">(</span><span class="n">devfreq_class</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">devfreq_exit</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The followings are helper functions for devfreq user device drivers with</span>
<span class="cm"> * OPP framework.</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * devfreq_recommended_opp() - Helper function to get proper OPP for the</span>
<span class="cm"> *			     freq value given to target callback.</span>
<span class="cm"> * @dev		The devfreq user device. (parent of devfreq)</span>
<span class="cm"> * @freq	The frequency given to target function</span>
<span class="cm"> * @flags	Flags handed from devfreq framework.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">opp</span> <span class="o">*</span><span class="nf">devfreq_recommended_opp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">freq</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">opp</span> <span class="o">*</span><span class="n">opp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVFREQ_FLAG_LEAST_UPPER_BOUND</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The freq is an upper bound. opp should be lower */</span>
		<span class="n">opp</span> <span class="o">=</span> <span class="n">opp_find_freq_floor</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

		<span class="cm">/* If not available, use the closest opp */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opp</span> <span class="o">==</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">))</span>
			<span class="n">opp</span> <span class="o">=</span> <span class="n">opp_find_freq_ceil</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* The freq is an lower bound. opp should be higher */</span>
		<span class="n">opp</span> <span class="o">=</span> <span class="n">opp_find_freq_ceil</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

		<span class="cm">/* If not available, use the closest opp */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opp</span> <span class="o">==</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">))</span>
			<span class="n">opp</span> <span class="o">=</span> <span class="n">opp_find_freq_floor</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">opp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * devfreq_register_opp_notifier() - Helper function to get devfreq notified</span>
<span class="cm"> *				   for any changes in the OPP availability</span>
<span class="cm"> *				   changes</span>
<span class="cm"> * @dev		The devfreq user device. (parent of devfreq)</span>
<span class="cm"> * @devfreq	The devfreq object.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">devfreq_register_opp_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">devfreq</span> <span class="o">*</span><span class="n">devfreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srcu_notifier_head</span> <span class="o">*</span><span class="n">nh</span> <span class="o">=</span> <span class="n">opp_get_notifier</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">nh</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">nh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">srcu_notifier_chain_register</span><span class="p">(</span><span class="n">nh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * devfreq_unregister_opp_notifier() - Helper function to stop getting devfreq</span>
<span class="cm"> *				     notified for any changes in the OPP</span>
<span class="cm"> *				     availability changes anymore.</span>
<span class="cm"> * @dev		The devfreq user device. (parent of devfreq)</span>
<span class="cm"> * @devfreq	The devfreq object.</span>
<span class="cm"> *</span>
<span class="cm"> * At exit() callback of devfreq_dev_profile, this must be included if</span>
<span class="cm"> * devfreq_recommended_opp is used.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">devfreq_unregister_opp_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">devfreq</span> <span class="o">*</span><span class="n">devfreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srcu_notifier_head</span> <span class="o">*</span><span class="n">nh</span> <span class="o">=</span> <span class="n">opp_get_notifier</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">nh</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">nh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">srcu_notifier_chain_unregister</span><span class="p">(</span><span class="n">nh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devfreq</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;MyungJoo Ham &lt;myungjoo.ham@samsung.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;devfreq class support&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
