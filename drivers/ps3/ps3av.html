<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ps3 › ps3av.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ps3av.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  PS3 AV backend support.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2007 Sony Computer Entertainment Inc.</span>
<span class="cm"> *  Copyright 2007 Sony Corp.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/firmware.h&gt;</span>
<span class="cp">#include &lt;asm/ps3av.h&gt;</span>
<span class="cp">#include &lt;asm/ps3.h&gt;</span>

<span class="cp">#include &quot;vuart.h&quot;</span>

<span class="cp">#define BUFSIZE          4096	</span><span class="cm">/* vuart buf size */</span><span class="cp"></span>
<span class="cp">#define PS3AV_BUF_SIZE   512	</span><span class="cm">/* max packet size */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">safe_mode</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>	<span class="cm">/* in msec ( 5 sec ) */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ps3av</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">wq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">open_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3_system_bus_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">region</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_av_get_hw_conf</span> <span class="n">av_hw_conf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">av_port</span><span class="p">[</span><span class="n">PS3AV_AV_PORT_MAX</span> <span class="o">+</span> <span class="n">PS3AV_OPT_PORT_MAX</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">opt_port</span><span class="p">[</span><span class="n">PS3AV_OPT_PORT_MAX</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">head</span><span class="p">[</span><span class="n">PS3AV_HEAD_MAX</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">audio_port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ps3av_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ps3av_mode_old</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ps3av_reply_hdr</span> <span class="n">reply_hdr</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">raw</span><span class="p">[</span><span class="n">PS3AV_BUF_SIZE</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">recv_buf</span><span class="p">;</span>
<span class="p">}</span> <span class="o">*</span><span class="n">ps3av</span><span class="p">;</span>

<span class="cm">/* color space */</span>
<span class="cp">#define YUV444 PS3AV_CMD_VIDEO_CS_YUV444_8</span>
<span class="cp">#define RGB8   PS3AV_CMD_VIDEO_CS_RGB_8</span>
<span class="cm">/* format */</span>
<span class="cp">#define XRGB   PS3AV_CMD_VIDEO_FMT_X8R8G8B8</span>
<span class="cm">/* aspect */</span>
<span class="cp">#define A_N    PS3AV_CMD_AV_ASPECT_4_3</span>
<span class="cp">#define A_W    PS3AV_CMD_AV_ASPECT_16_9</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">avset_video_mode</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">cs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">aspect</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">y</span><span class="p">;</span>
<span class="p">}</span> <span class="n">video_mode_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>     <span class="mi">0</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* auto */</span>
	<span class="p">{</span><span class="n">YUV444</span><span class="p">,</span> <span class="n">XRGB</span><span class="p">,</span> <span class="n">PS3AV_CMD_VIDEO_VID_480I</span><span class="p">,</span>       <span class="n">A_N</span><span class="p">,</span>  <span class="mi">720</span><span class="p">,</span>  <span class="mi">480</span><span class="p">},</span>
	<span class="p">{</span><span class="n">YUV444</span><span class="p">,</span> <span class="n">XRGB</span><span class="p">,</span> <span class="n">PS3AV_CMD_VIDEO_VID_480P</span><span class="p">,</span>       <span class="n">A_N</span><span class="p">,</span>  <span class="mi">720</span><span class="p">,</span>  <span class="mi">480</span><span class="p">},</span>
	<span class="p">{</span><span class="n">YUV444</span><span class="p">,</span> <span class="n">XRGB</span><span class="p">,</span> <span class="n">PS3AV_CMD_VIDEO_VID_720P_60HZ</span><span class="p">,</span>  <span class="n">A_W</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span>  <span class="mi">720</span><span class="p">},</span>
	<span class="p">{</span><span class="n">YUV444</span><span class="p">,</span> <span class="n">XRGB</span><span class="p">,</span> <span class="n">PS3AV_CMD_VIDEO_VID_1080I_60HZ</span><span class="p">,</span> <span class="n">A_W</span><span class="p">,</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">},</span>
	<span class="p">{</span><span class="n">YUV444</span><span class="p">,</span> <span class="n">XRGB</span><span class="p">,</span> <span class="n">PS3AV_CMD_VIDEO_VID_1080P_60HZ</span><span class="p">,</span> <span class="n">A_W</span><span class="p">,</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">},</span>
	<span class="p">{</span><span class="n">YUV444</span><span class="p">,</span> <span class="n">XRGB</span><span class="p">,</span> <span class="n">PS3AV_CMD_VIDEO_VID_576I</span><span class="p">,</span>       <span class="n">A_N</span><span class="p">,</span>  <span class="mi">720</span><span class="p">,</span>  <span class="mi">576</span><span class="p">},</span>
	<span class="p">{</span><span class="n">YUV444</span><span class="p">,</span> <span class="n">XRGB</span><span class="p">,</span> <span class="n">PS3AV_CMD_VIDEO_VID_576P</span><span class="p">,</span>       <span class="n">A_N</span><span class="p">,</span>  <span class="mi">720</span><span class="p">,</span>  <span class="mi">576</span><span class="p">},</span>
	<span class="p">{</span><span class="n">YUV444</span><span class="p">,</span> <span class="n">XRGB</span><span class="p">,</span> <span class="n">PS3AV_CMD_VIDEO_VID_720P_50HZ</span><span class="p">,</span>  <span class="n">A_W</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span>  <span class="mi">720</span><span class="p">},</span>
	<span class="p">{</span><span class="n">YUV444</span><span class="p">,</span> <span class="n">XRGB</span><span class="p">,</span> <span class="n">PS3AV_CMD_VIDEO_VID_1080I_50HZ</span><span class="p">,</span> <span class="n">A_W</span><span class="p">,</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">},</span>
	<span class="p">{</span><span class="n">YUV444</span><span class="p">,</span> <span class="n">XRGB</span><span class="p">,</span> <span class="n">PS3AV_CMD_VIDEO_VID_1080P_50HZ</span><span class="p">,</span> <span class="n">A_W</span><span class="p">,</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">},</span>
	<span class="p">{</span>  <span class="n">RGB8</span><span class="p">,</span> <span class="n">XRGB</span><span class="p">,</span> <span class="n">PS3AV_CMD_VIDEO_VID_WXGA</span><span class="p">,</span>       <span class="n">A_W</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span>  <span class="mi">768</span><span class="p">},</span>
	<span class="p">{</span>  <span class="n">RGB8</span><span class="p">,</span> <span class="n">XRGB</span><span class="p">,</span> <span class="n">PS3AV_CMD_VIDEO_VID_SXGA</span><span class="p">,</span>       <span class="n">A_N</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1024</span><span class="p">},</span>
	<span class="p">{</span>  <span class="n">RGB8</span><span class="p">,</span> <span class="n">XRGB</span><span class="p">,</span> <span class="n">PS3AV_CMD_VIDEO_VID_WUXGA</span><span class="p">,</span>      <span class="n">A_W</span><span class="p">,</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1200</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* supported CIDs */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">cmd_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* init */</span>
	<span class="n">PS3AV_CID_AV_INIT</span><span class="p">,</span>
	<span class="n">PS3AV_CID_AV_FIN</span><span class="p">,</span>
	<span class="n">PS3AV_CID_VIDEO_INIT</span><span class="p">,</span>
	<span class="n">PS3AV_CID_AUDIO_INIT</span><span class="p">,</span>

	<span class="cm">/* set */</span>
	<span class="n">PS3AV_CID_AV_ENABLE_EVENT</span><span class="p">,</span>
	<span class="n">PS3AV_CID_AV_DISABLE_EVENT</span><span class="p">,</span>

	<span class="n">PS3AV_CID_AV_VIDEO_CS</span><span class="p">,</span>
	<span class="n">PS3AV_CID_AV_VIDEO_MUTE</span><span class="p">,</span>
	<span class="n">PS3AV_CID_AV_VIDEO_DISABLE_SIG</span><span class="p">,</span>
	<span class="n">PS3AV_CID_AV_AUDIO_PARAM</span><span class="p">,</span>
	<span class="n">PS3AV_CID_AV_AUDIO_MUTE</span><span class="p">,</span>
	<span class="n">PS3AV_CID_AV_HDMI_MODE</span><span class="p">,</span>
	<span class="n">PS3AV_CID_AV_TV_MUTE</span><span class="p">,</span>

	<span class="n">PS3AV_CID_VIDEO_MODE</span><span class="p">,</span>
	<span class="n">PS3AV_CID_VIDEO_FORMAT</span><span class="p">,</span>
	<span class="n">PS3AV_CID_VIDEO_PITCH</span><span class="p">,</span>

	<span class="n">PS3AV_CID_AUDIO_MODE</span><span class="p">,</span>
	<span class="n">PS3AV_CID_AUDIO_MUTE</span><span class="p">,</span>
	<span class="n">PS3AV_CID_AUDIO_ACTIVE</span><span class="p">,</span>
	<span class="n">PS3AV_CID_AUDIO_INACTIVE</span><span class="p">,</span>
	<span class="n">PS3AV_CID_AVB_PARAM</span><span class="p">,</span>

	<span class="cm">/* get */</span>
	<span class="n">PS3AV_CID_AV_GET_HW_CONF</span><span class="p">,</span>
	<span class="n">PS3AV_CID_AV_GET_MONITOR_INFO</span><span class="p">,</span>

	<span class="cm">/* event */</span>
	<span class="n">PS3AV_CID_EVENT_UNPLUGGED</span><span class="p">,</span>
	<span class="n">PS3AV_CID_EVENT_PLUGGED</span><span class="p">,</span>
	<span class="n">PS3AV_CID_EVENT_HDCP_DONE</span><span class="p">,</span>
	<span class="n">PS3AV_CID_EVENT_HDCP_FAIL</span><span class="p">,</span>
	<span class="n">PS3AV_CID_EVENT_HDCP_AUTH</span><span class="p">,</span>
	<span class="n">PS3AV_CID_EVENT_HDCP_ERROR</span><span class="p">,</span>

	<span class="mi">0</span>
<span class="p">};</span>

<span class="cp">#define PS3AV_EVENT_CMD_MASK           0x10000000</span>
<span class="cp">#define PS3AV_EVENT_ID_MASK            0x0000ffff</span>
<span class="cp">#define PS3AV_CID_MASK                 0xffffffff</span>
<span class="cp">#define PS3AV_REPLY_BIT                0x80000000</span>

<span class="cp">#define ps3av_event_get_port_id(cid)   ((cid &gt;&gt; 16) &amp; 0xff)</span>

<span class="k">static</span> <span class="n">u32</span> <span class="o">*</span><span class="nf">ps3av_search_cmd_table</span><span class="p">(</span><span class="n">u32</span> <span class="n">cid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">cmd_table</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;</span> <span class="n">table</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">table</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">cid</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">table</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">table</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3av_parse_event_packet</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ps3av_reply_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">&amp;</span> <span class="n">PS3AV_EVENT_CMD_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">table</span> <span class="o">=</span> <span class="n">ps3av_search_cmd_table</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">,</span> <span class="n">PS3AV_EVENT_CMD_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span>
				<span class="s">&quot;recv event packet cid:%08x port:0x%x size:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">,</span> <span class="n">ps3av_event_get_port_id</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">),</span>
				<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;%s: failed event packet, cid:%08x size:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* receive event packet */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define POLLING_INTERVAL  25	</span><span class="cm">/* in msec */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3av_vuart_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_system_bus_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot; -&gt; %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">ps3_vuart_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot; &lt;- %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span> <span class="o">?</span> <span class="n">error</span> <span class="o">:</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3av_vuart_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_system_bus_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loopcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot; -&gt; %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">+</span> <span class="n">POLLING_INTERVAL</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">POLLING_INTERVAL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">loopcnt</span><span class="o">++</span> <span class="o">&lt;=</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">ps3_vuart_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: ps3_vuart_read failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">POLLING_INTERVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EWOULDBLOCK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3av_send_cmd_pkt</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ps3av_send_hdr</span> <span class="o">*</span><span class="n">send_buf</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ps3av_reply_hdr</span> <span class="o">*</span><span class="n">recv_buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write_len</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">read_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">event</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ps3av</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* send pkt */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_vuart_write</span><span class="p">(</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">send_buf</span><span class="p">,</span> <span class="n">write_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span>
			<span class="s">&quot;%s: ps3av_vuart_write() failed (result=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* recv pkt */</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">send_buf</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* read header */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_vuart_read</span><span class="p">(</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">recv_buf</span><span class="p">,</span> <span class="n">PS3AV_HDR_SIZE</span><span class="p">,</span>
				       <span class="n">timeout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">PS3AV_HDR_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span>
				<span class="s">&quot;%s: ps3av_vuart_read() failed (result=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* read body */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_vuart_read</span><span class="p">(</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">recv_buf</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">,</span>
				       <span class="n">recv_buf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span>
				<span class="s">&quot;%s: ps3av_vuart_read() failed (result=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">res</span> <span class="o">+=</span> <span class="n">PS3AV_HDR_SIZE</span><span class="p">;</span>	<span class="cm">/* total len */</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">ps3av_parse_event_packet</span><span class="p">(</span><span class="n">recv_buf</span><span class="p">);</span>
		<span class="cm">/* ret &gt; 0 event packet */</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">event</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">|</span> <span class="n">PS3AV_REPLY_BIT</span><span class="p">)</span> <span class="o">!=</span> <span class="n">recv_buf</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot;%s: reply err (result=%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">recv_buf</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3av_process_reply_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3av_send_hdr</span> <span class="o">*</span><span class="n">cmd_buf</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">ps3av_reply_hdr</span> <span class="o">*</span><span class="n">recv_buf</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">user_buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">return_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">recv_buf</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="n">PS3AV_VERSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot;reply_packet invalid version:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">recv_buf</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">return_len</span> <span class="o">=</span> <span class="n">recv_buf</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="n">PS3AV_HDR_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">return_len</span> <span class="o">&gt;</span> <span class="n">user_buf_size</span><span class="p">)</span>
		<span class="n">return_len</span> <span class="o">=</span> <span class="n">user_buf_size</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd_buf</span><span class="p">,</span> <span class="n">recv_buf</span><span class="p">,</span> <span class="n">return_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* success */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ps3av_set_hdr</span><span class="p">(</span><span class="n">u32</span> <span class="n">cid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ps3av_send_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">PS3AV_VERSION</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">PS3AV_HDR_SIZE</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3av_do_pkt</span><span class="p">(</span><span class="n">u32</span> <span class="n">cid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">send_len</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">usr_buf_size</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">ps3av_send_hdr</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ps3av</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">ps3av_search_cmd_table</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">PS3AV_CID_MASK</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">table</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">send_len</span> <span class="o">&lt;</span> <span class="n">PS3AV_HDR_SIZE</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">usr_buf_size</span> <span class="o">&lt;</span> <span class="n">send_len</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">usr_buf_size</span> <span class="o">&gt;</span> <span class="n">PS3AV_BUF_SIZE</span><span class="p">);</span>

	<span class="cm">/* create header */</span>
	<span class="n">ps3av_set_hdr</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">send_len</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="cm">/* send packet via vuart */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_send_cmd_pkt</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">recv_buf</span><span class="p">.</span><span class="n">reply_hdr</span><span class="p">,</span> <span class="n">send_len</span><span class="p">,</span>
				 <span class="n">usr_buf_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;%s: ps3av_send_cmd_pkt() failed (result=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* process reply packet */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_process_reply_packet</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">recv_buf</span><span class="p">.</span><span class="n">reply_hdr</span><span class="p">,</span>
					 <span class="n">usr_buf_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: put_return_status() failed (result=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: failed cid:%x res:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3av_set_av_video_mute</span><span class="p">(</span><span class="n">u32</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_of_av_port</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">num_of_av_port</span> <span class="o">=</span> <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">.</span><span class="n">num_of_hdmi</span> <span class="o">+</span>
			 <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">.</span><span class="n">num_of_avmulti</span><span class="p">;</span>
	<span class="cm">/* video mute on */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_of_av_port</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_cmd_av_video_mute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mute</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3av_set_video_disable_sig</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_of_hdmi_port</span><span class="p">,</span> <span class="n">num_of_av_port</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">num_of_hdmi_port</span> <span class="o">=</span> <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">.</span><span class="n">num_of_hdmi</span><span class="p">;</span>
	<span class="n">num_of_av_port</span> <span class="o">=</span> <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">.</span><span class="n">num_of_hdmi</span> <span class="o">+</span>
			 <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">.</span><span class="n">num_of_avmulti</span><span class="p">;</span>

	<span class="cm">/* tv mute */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_of_hdmi_port</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_cmd_av_tv_mute</span><span class="p">(</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					   <span class="n">PS3AV_CMD_MUTE_ON</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* video mute on */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_of_av_port</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_cmd_av_video_disable_sig</span><span class="p">(</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_of_hdmi_port</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_cmd_av_tv_mute</span><span class="p">(</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						   <span class="n">PS3AV_CMD_MUTE_OFF</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3av_set_audio_mute</span><span class="p">(</span><span class="n">u32</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_of_av_port</span><span class="p">,</span> <span class="n">num_of_opt_port</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">num_of_av_port</span> <span class="o">=</span> <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">.</span><span class="n">num_of_hdmi</span> <span class="o">+</span>
			 <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">.</span><span class="n">num_of_avmulti</span><span class="p">;</span>
	<span class="n">num_of_opt_port</span> <span class="o">=</span> <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">.</span><span class="n">num_of_spdif</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_of_av_port</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_cmd_av_audio_mute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mute</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_of_opt_port</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_cmd_audio_mute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">opt_port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mute</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3av_set_audio_mode</span><span class="p">(</span><span class="n">u32</span> <span class="n">ch</span><span class="p">,</span> <span class="n">u32</span> <span class="n">fs</span><span class="p">,</span> <span class="n">u32</span> <span class="n">word_bits</span><span class="p">,</span> <span class="n">u32</span> <span class="n">format</span><span class="p">,</span> <span class="n">u32</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_avb_param</span> <span class="n">avb_param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_of_audio</span><span class="p">,</span> <span class="n">vid</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_audio_mode</span> <span class="n">audio_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">num_of_audio</span> <span class="o">=</span> <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">.</span><span class="n">num_of_hdmi</span> <span class="o">+</span>
		       <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">.</span><span class="n">num_of_avmulti</span> <span class="o">+</span>
		       <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">.</span><span class="n">num_of_spdif</span><span class="p">;</span>

	<span class="n">avb_param</span><span class="p">.</span><span class="n">num_of_video_pkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avb_param</span><span class="p">.</span><span class="n">num_of_audio_pkt</span> <span class="o">=</span> <span class="n">PS3AV_AVB_NUM_AUDIO</span><span class="p">;</span>	<span class="cm">/* always 0 */</span>
	<span class="n">avb_param</span><span class="p">.</span><span class="n">num_of_av_video_pkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avb_param</span><span class="p">.</span><span class="n">num_of_av_audio_pkt</span> <span class="o">=</span> <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">.</span><span class="n">num_of_hdmi</span><span class="p">;</span>

	<span class="n">vid</span> <span class="o">=</span> <span class="n">video_mode_table</span><span class="p">[</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">ps3av_mode</span><span class="p">].</span><span class="n">vid</span><span class="p">;</span>

	<span class="cm">/* audio mute */</span>
	<span class="n">ps3av_set_audio_mute</span><span class="p">(</span><span class="n">PS3AV_CMD_MUTE_ON</span><span class="p">);</span>

	<span class="cm">/* audio inactive */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_cmd_audio_active</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">audio_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span>
			<span class="s">&quot;ps3av_cmd_audio_active OFF failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* audio_pkt */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_of_audio</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ps3av_cmd_set_audio_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">audio_mode</span><span class="p">,</span> <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ch</span><span class="p">,</span>
					 <span class="n">fs</span><span class="p">,</span> <span class="n">word_bits</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">.</span><span class="n">num_of_hdmi</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* hdmi only */</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">ps3av_cmd_set_av_audio_param</span><span class="p">(</span><span class="o">&amp;</span><span class="n">avb_param</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">],</span>
							    <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
							    <span class="o">&amp;</span><span class="n">audio_mode</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* audio_mode pkt should be sent separately */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_cmd_audio_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">audio_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span>
				<span class="s">&quot;ps3av_cmd_audio_mode failed, port:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* send command using avb pkt */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3av_pkt_avb_param</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_cmd_avb_param</span><span class="p">(</span><span class="o">&amp;</span><span class="n">avb_param</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot;ps3av_cmd_avb_param failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* audio mute */</span>
	<span class="n">ps3av_set_audio_mute</span><span class="p">(</span><span class="n">PS3AV_CMD_MUTE_OFF</span><span class="p">);</span>

	<span class="cm">/* audio active */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_cmd_audio_active</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">audio_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span>
			<span class="s">&quot;ps3av_cmd_audio_active ON failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3av_set_audio_mode</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3av_set_videomode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* av video mute */</span>
	<span class="n">ps3av_set_av_video_mute</span><span class="p">(</span><span class="n">PS3AV_CMD_MUTE_ON</span><span class="p">);</span>

	<span class="cm">/* wake up ps3avd to do the actual video mode setting */</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ps3av_set_videomode_packet</span><span class="p">(</span><span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_avb_param</span> <span class="n">avb_param</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">av_video_cs</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">avset_video_mode</span> <span class="o">*</span><span class="n">video_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">video_mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">video_mode_table</span><span class="p">[</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">PS3AV_MODE_MASK</span><span class="p">];</span>

	<span class="n">avb_param</span><span class="p">.</span><span class="n">num_of_video_pkt</span> <span class="o">=</span> <span class="n">PS3AV_AVB_NUM_VIDEO</span><span class="p">;</span> <span class="cm">/* num of head */</span>
	<span class="n">avb_param</span><span class="p">.</span><span class="n">num_of_audio_pkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avb_param</span><span class="p">.</span><span class="n">num_of_av_video_pkt</span> <span class="o">=</span> <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">.</span><span class="n">num_of_hdmi</span> <span class="o">+</span>
					<span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">.</span><span class="n">num_of_avmulti</span><span class="p">;</span>
	<span class="n">avb_param</span><span class="p">.</span><span class="n">num_of_av_audio_pkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* video_pkt */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">avb_param</span><span class="p">.</span><span class="n">num_of_video_pkt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">ps3av_cmd_set_video_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">avb_param</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">],</span>
						<span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">,</span>
						<span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="cm">/* av_video_pkt */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">avb_param</span><span class="p">.</span><span class="n">num_of_av_video_pkt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">PS3AV_MODE_DVI</span> <span class="o">||</span> <span class="n">id</span> <span class="o">&amp;</span> <span class="n">PS3AV_MODE_RGB</span><span class="p">)</span>
			<span class="n">av_video_cs</span> <span class="o">=</span> <span class="n">RGB8</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">av_video_cs</span> <span class="o">=</span> <span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
<span class="cp">#ifndef PS3AV_HDMI_YUV</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">PS3AV_CMD_AVPORT_HDMI_0</span> <span class="o">||</span>
		    <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">PS3AV_CMD_AVPORT_HDMI_1</span><span class="p">)</span>
			<span class="n">av_video_cs</span> <span class="o">=</span> <span class="n">RGB8</span><span class="p">;</span> <span class="cm">/* use RGB for HDMI */</span>
<span class="cp">#endif</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">ps3av_cmd_set_av_video_cs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">avb_param</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">],</span>
						 <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_port</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						 <span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">,</span> <span class="n">av_video_cs</span><span class="p">,</span>
						 <span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">aspect</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* send command using avb pkt */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3av_pkt_avb_param</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_cmd_avb_param</span><span class="p">(</span><span class="o">&amp;</span><span class="n">avb_param</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">PS3AV_STATUS_NO_SYNC_HEAD</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;%s: Command failed. Please try your request again.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot;ps3av_cmd_avb_param failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ps3av_set_videomode_cont</span><span class="p">(</span><span class="n">u32</span> <span class="n">id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">old_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">vesa</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="cm">/* video signal off */</span>
	<span class="n">ps3av_set_video_disable_sig</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * AV backend needs non-VESA mode setting at least one time</span>
<span class="cm">	 * when VESA mode is used.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vesa</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">PS3AV_MODE_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PS3AV_MODE_WXGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* vesa mode */</span>
		<span class="n">ps3av_set_videomode_packet</span><span class="p">(</span><span class="n">PS3AV_MODE_480P</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">vesa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Retail PS3 product doesn&#39;t support this */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">PS3AV_MODE_HDCP_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_cmd_av_hdmi_mode</span><span class="p">(</span><span class="n">PS3AV_CMD_AV_HDMI_HDCP_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">PS3AV_STATUS_UNSUPPORTED_HDMI_MODE</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot;Not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span>
				<span class="s">&quot;ps3av_cmd_av_hdmi_mode failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">old_id</span> <span class="o">&amp;</span> <span class="n">PS3AV_MODE_HDCP_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_cmd_av_hdmi_mode</span><span class="p">(</span><span class="n">PS3AV_CMD_AV_HDMI_MODE_NORMAL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">res</span> <span class="o">!=</span> <span class="n">PS3AV_STATUS_UNSUPPORTED_HDMI_MODE</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span>
				<span class="s">&quot;ps3av_cmd_av_hdmi_mode failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ps3av_set_videomode_packet</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1500</span><span class="p">);</span>
	<span class="cm">/* av video mute */</span>
	<span class="n">ps3av_set_av_video_mute</span><span class="p">(</span><span class="n">PS3AV_CMD_MUTE_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ps3avd</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ps3av_set_videomode_cont</span><span class="p">(</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">ps3av_mode</span><span class="p">,</span> <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">ps3av_mode_old</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SHIFT_50	0</span>
<span class="cp">#define SHIFT_60	4</span>
<span class="cp">#define SHIFT_VESA	8</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">mask</span><span class="o">:</span><span class="mi">19</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">id</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ps3av_preferred_modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PS3AV_RESBIT_WUXGA</span>      <span class="o">&lt;&lt;</span> <span class="n">SHIFT_VESA</span><span class="p">,</span> <span class="n">PS3AV_MODE_WUXGA</span>   <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_RESBIT_1920x1080P</span> <span class="o">&lt;&lt;</span> <span class="n">SHIFT_60</span><span class="p">,</span>   <span class="n">PS3AV_MODE_1080P60</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_RESBIT_1920x1080P</span> <span class="o">&lt;&lt;</span> <span class="n">SHIFT_50</span><span class="p">,</span>   <span class="n">PS3AV_MODE_1080P50</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_RESBIT_1920x1080I</span> <span class="o">&lt;&lt;</span> <span class="n">SHIFT_60</span><span class="p">,</span>   <span class="n">PS3AV_MODE_1080I60</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_RESBIT_1920x1080I</span> <span class="o">&lt;&lt;</span> <span class="n">SHIFT_50</span><span class="p">,</span>   <span class="n">PS3AV_MODE_1080I50</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_RESBIT_SXGA</span>       <span class="o">&lt;&lt;</span> <span class="n">SHIFT_VESA</span><span class="p">,</span> <span class="n">PS3AV_MODE_SXGA</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_RESBIT_WXGA</span>       <span class="o">&lt;&lt;</span> <span class="n">SHIFT_VESA</span><span class="p">,</span> <span class="n">PS3AV_MODE_WXGA</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_RESBIT_1280x720P</span>  <span class="o">&lt;&lt;</span> <span class="n">SHIFT_60</span><span class="p">,</span>   <span class="n">PS3AV_MODE_720P60</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_RESBIT_1280x720P</span>  <span class="o">&lt;&lt;</span> <span class="n">SHIFT_50</span><span class="p">,</span>   <span class="n">PS3AV_MODE_720P50</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_RESBIT_720x480P</span>   <span class="o">&lt;&lt;</span> <span class="n">SHIFT_60</span><span class="p">,</span>   <span class="n">PS3AV_MODE_480P</span>    <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_RESBIT_720x576P</span>   <span class="o">&lt;&lt;</span> <span class="n">SHIFT_50</span><span class="p">,</span>   <span class="n">PS3AV_MODE_576P</span>    <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">ps3av_mode_num</span> <span class="nf">ps3av_resbit2id</span><span class="p">(</span><span class="n">u32</span> <span class="n">res_50</span><span class="p">,</span> <span class="n">u32</span> <span class="n">res_60</span><span class="p">,</span>
					   <span class="n">u32</span> <span class="n">res_vesa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">res_all</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We mask off the resolution bits we care about and combine the</span>
<span class="cm">	 * results in one bitfield, so make sure there&#39;s no overlap</span>
<span class="cm">	 */</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">PS3AV_RES_MASK_50</span> <span class="o">&lt;&lt;</span> <span class="n">SHIFT_50</span> <span class="o">&amp;</span>
		     <span class="n">PS3AV_RES_MASK_60</span> <span class="o">&lt;&lt;</span> <span class="n">SHIFT_60</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">PS3AV_RES_MASK_50</span> <span class="o">&lt;&lt;</span> <span class="n">SHIFT_50</span> <span class="o">&amp;</span>
		     <span class="n">PS3AV_RES_MASK_VESA</span> <span class="o">&lt;&lt;</span> <span class="n">SHIFT_VESA</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">PS3AV_RES_MASK_60</span> <span class="o">&lt;&lt;</span> <span class="n">SHIFT_60</span> <span class="o">&amp;</span>
		     <span class="n">PS3AV_RES_MASK_VESA</span> <span class="o">&lt;&lt;</span> <span class="n">SHIFT_VESA</span><span class="p">);</span>
	<span class="n">res_all</span> <span class="o">=</span> <span class="p">(</span><span class="n">res_50</span> <span class="o">&amp;</span> <span class="n">PS3AV_RES_MASK_50</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SHIFT_50</span> <span class="o">|</span>
		  <span class="p">(</span><span class="n">res_60</span> <span class="o">&amp;</span> <span class="n">PS3AV_RES_MASK_60</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SHIFT_60</span> <span class="o">|</span>
		  <span class="p">(</span><span class="n">res_vesa</span> <span class="o">&amp;</span> <span class="n">PS3AV_RES_MASK_VESA</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SHIFT_VESA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_all</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ps3av_preferred_modes</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res_all</span> <span class="o">&amp;</span> <span class="n">ps3av_preferred_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ps3av_preferred_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">ps3av_mode_num</span> <span class="nf">ps3av_hdmi_get_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3av_info_monitor</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">ps3av_mode_num</span> <span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">safe_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PS3AV_DEFAULT_HDMI_MODE_ID_REG_60</span><span class="p">;</span>

	<span class="cm">/* check native resolution */</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">ps3av_resbit2id</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">res_50</span><span class="p">.</span><span class="n">native</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">res_60</span><span class="p">.</span><span class="n">native</span><span class="p">,</span>
			     <span class="n">info</span><span class="o">-&gt;</span><span class="n">res_vesa</span><span class="p">.</span><span class="n">native</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Using native mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check supported resolutions */</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">ps3av_resbit2id</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">res_50</span><span class="p">.</span><span class="n">res_bits</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">res_60</span><span class="p">.</span><span class="n">res_bits</span><span class="p">,</span>
			     <span class="n">info</span><span class="o">-&gt;</span><span class="n">res_vesa</span><span class="p">.</span><span class="n">res_bits</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Using supported mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">region</span> <span class="o">&amp;</span> <span class="n">PS3AV_REGION_60</span><span class="p">)</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">PS3AV_DEFAULT_HDMI_MODE_ID_REG_60</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">PS3AV_DEFAULT_HDMI_MODE_ID_REG_50</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Using default mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ps3av_monitor_info_dump</span><span class="p">(</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ps3av_pkt_av_get_monitor_info</span> <span class="o">*</span><span class="n">monitor_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ps3av_info_monitor</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">monitor_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ps3av_info_audio</span> <span class="o">*</span><span class="n">audio</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">audio</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">id</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monitor_id</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Monitor Info: size %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">monitor_info</span><span class="o">-&gt;</span><span class="n">send_hdr</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;avport: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">avport</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monitor_id</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">],</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monitor_id</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;monitor_id: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;monitor_type: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">monitor_type</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;monitor_name: %.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monitor_name</span><span class="p">),</span>
		 <span class="n">info</span><span class="o">-&gt;</span><span class="n">monitor_name</span><span class="p">);</span>

	<span class="cm">/* resolution */</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;resolution_60: bits: %08x native: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">info</span><span class="o">-&gt;</span><span class="n">res_60</span><span class="p">.</span><span class="n">res_bits</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">res_60</span><span class="p">.</span><span class="n">native</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;resolution_50: bits: %08x native: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">info</span><span class="o">-&gt;</span><span class="n">res_50</span><span class="p">.</span><span class="n">res_bits</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">res_50</span><span class="p">.</span><span class="n">native</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;resolution_other: bits: %08x native: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">info</span><span class="o">-&gt;</span><span class="n">res_other</span><span class="p">.</span><span class="n">res_bits</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">res_other</span><span class="p">.</span><span class="n">native</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;resolution_vesa: bits: %08x native: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">info</span><span class="o">-&gt;</span><span class="n">res_vesa</span><span class="p">.</span><span class="n">res_bits</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">res_vesa</span><span class="p">.</span><span class="n">native</span><span class="p">);</span>

	<span class="cm">/* color space */</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;color space    rgb: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">.</span><span class="n">rgb</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;color space yuv444: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">.</span><span class="n">yuv444</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;color space yuv422: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">.</span><span class="n">yuv422</span><span class="p">);</span>

	<span class="cm">/* color info */</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;color info   red: X %04x Y %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">.</span><span class="n">red_x</span><span class="p">,</span>
		 <span class="n">info</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">.</span><span class="n">red_y</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;color info green: X %04x Y %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">.</span><span class="n">green_x</span><span class="p">,</span>
		 <span class="n">info</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">.</span><span class="n">green_y</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;color info  blue: X %04x Y %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">.</span><span class="n">blue_x</span><span class="p">,</span>
		 <span class="n">info</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">.</span><span class="n">blue_y</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;color info white: X %04x Y %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">.</span><span class="n">white_x</span><span class="p">,</span>
		 <span class="n">info</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">.</span><span class="n">white_y</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;color info gamma:  %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">.</span><span class="n">gamma</span><span class="p">);</span>

	<span class="cm">/* other info */</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;supported_AI: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">supported_ai</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;speaker_info: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">speaker_info</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;num of audio: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">num_of_audio_block</span><span class="p">);</span>

	<span class="cm">/* audio block */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">num_of_audio_block</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span>
			<span class="s">&quot;audio[%d] type: %02x max_ch: %02x fs: %02x sbit: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">i</span><span class="p">,</span> <span class="n">audio</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">audio</span><span class="o">-&gt;</span><span class="n">max_num_of_ch</span><span class="p">,</span> <span class="n">audio</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">,</span>
			 <span class="n">audio</span><span class="o">-&gt;</span><span class="n">sbit</span><span class="p">);</span>
		<span class="n">audio</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ps3av_monitor_quirk</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">monitor_name</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">clear_60</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ps3av_monitor_quirks</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">monitor_name</span>	<span class="o">=</span> <span class="s">&quot;DELL 2007WFP&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clear_60</span>	<span class="o">=</span> <span class="n">PS3AV_RESBIT_1920x1080I</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">monitor_name</span>	<span class="o">=</span> <span class="s">&quot;L226WTQ&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clear_60</span>	<span class="o">=</span> <span class="n">PS3AV_RESBIT_1920x1080I</span> <span class="o">|</span>
				  <span class="n">PS3AV_RESBIT_1920x1080P</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">monitor_name</span>	<span class="o">=</span> <span class="s">&quot;SyncMaster&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clear_60</span>	<span class="o">=</span> <span class="n">PS3AV_RESBIT_1920x1080I</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ps3av_fixup_monitor_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3av_info_monitor</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ps3av_monitor_quirk</span> <span class="o">*</span><span class="n">quirk</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ps3av_monitor_quirks</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">quirk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ps3av_monitor_quirks</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monitor_name</span><span class="p">,</span> <span class="n">quirk</span><span class="o">-&gt;</span><span class="n">monitor_name</span><span class="p">,</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monitor_name</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Applying quirk for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">quirk</span><span class="o">-&gt;</span><span class="n">monitor_name</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">res_60</span><span class="p">.</span><span class="n">res_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">quirk</span><span class="o">-&gt;</span><span class="n">clear_60</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">res_60</span><span class="p">.</span><span class="n">native</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">quirk</span><span class="o">-&gt;</span><span class="n">clear_60</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3av_auto_videomode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3av_pkt_av_get_hw_conf</span> <span class="o">*</span><span class="n">av_hw_conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dvi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rgb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_av_get_monitor_info</span> <span class="n">monitor_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3av_info_monitor</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="cm">/* get mode id for hdmi */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">av_hw_conf</span><span class="o">-&gt;</span><span class="n">num_of_hdmi</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">id</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_cmd_video_get_monitor_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">monitor_info</span><span class="p">,</span>
						       <span class="n">PS3AV_CMD_AVPORT_HDMI_0</span> <span class="o">+</span>
						       <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">ps3av_monitor_info_dump</span><span class="p">(</span><span class="o">&amp;</span><span class="n">monitor_info</span><span class="p">);</span>

		<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">monitor_info</span><span class="p">.</span><span class="n">info</span><span class="p">;</span>
		<span class="n">ps3av_fixup_monitor_info</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">monitor_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PS3AV_MONITOR_TYPE_DVI</span>:
			<span class="n">dvi</span> <span class="o">=</span> <span class="n">PS3AV_MODE_DVI</span><span class="p">;</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">PS3AV_MONITOR_TYPE_HDMI</span>:
			<span class="n">id</span> <span class="o">=</span> <span class="n">ps3av_hdmi_get_id</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no HDMI interface or HDMI is off */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">region</span> <span class="o">&amp;</span> <span class="n">PS3AV_REGION_60</span><span class="p">)</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">PS3AV_DEFAULT_AVMULTI_MODE_ID_REG_60</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">PS3AV_DEFAULT_AVMULTI_MODE_ID_REG_50</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">region</span> <span class="o">&amp;</span> <span class="n">PS3AV_REGION_RGB</span><span class="p">)</span>
			<span class="n">rgb</span> <span class="o">=</span> <span class="n">PS3AV_MODE_RGB</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Using avmulti mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">id</span> <span class="o">|</span> <span class="n">dvi</span> <span class="o">|</span> <span class="n">rgb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3av_get_hw_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3av</span> <span class="o">*</span><span class="n">ps3av</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ps3av_pkt_av_get_hw_conf</span> <span class="o">*</span><span class="n">hw_conf</span><span class="p">;</span>

	<span class="cm">/* get av_hw_conf */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_cmd_av_get_hw_conf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">hw_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;av_h_conf: num of hdmi: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_conf</span><span class="o">-&gt;</span><span class="n">num_of_hdmi</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;av_h_conf: num of avmulti: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_conf</span><span class="o">-&gt;</span><span class="n">num_of_avmulti</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;av_h_conf: num of spdif: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_conf</span><span class="o">-&gt;</span><span class="n">num_of_spdif</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PS3AV_HEAD_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_HEAD_A</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PS3AV_OPT_PORT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">opt_port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AVPORT_SPDIF_0</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw_conf</span><span class="o">-&gt;</span><span class="n">num_of_hdmi</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AVPORT_HDMI_0</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">hw_conf</span><span class="o">-&gt;</span><span class="n">num_of_avmulti</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_port</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AVPORT_AVMULTI_0</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">hw_conf</span><span class="o">-&gt;</span><span class="n">num_of_spdif</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_port</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AVPORT_SPDIF_0</span> <span class="o">+</span> <span class="n">k</span><span class="p">;</span>

	<span class="cm">/* set all audio port */</span>
	<span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">audio_port</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AUDIO_PORT_HDMI_0</span>
	    <span class="o">|</span> <span class="n">PS3AV_CMD_AUDIO_PORT_HDMI_1</span>
	    <span class="o">|</span> <span class="n">PS3AV_CMD_AUDIO_PORT_AVMULTI_0</span>
	    <span class="o">|</span> <span class="n">PS3AV_CMD_AUDIO_PORT_SPDIF_0</span> <span class="o">|</span> <span class="n">PS3AV_CMD_AUDIO_PORT_SPDIF_1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set mode using id */</span>
<span class="kt">int</span> <span class="nf">ps3av_set_video_mode</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">option</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">video_mode_table</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">PS3AV_MODE_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot;%s: error id :%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* auto mode */</span>
	<span class="n">option</span> <span class="o">=</span> <span class="n">id</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PS3AV_MODE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">PS3AV_MODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PS3AV_MODE_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">ps3av_auto_videomode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: invalid id :%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">id</span> <span class="o">|=</span> <span class="n">option</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set videomode */</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
	<span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">ps3av_mode_old</span> <span class="o">=</span> <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">ps3av_mode</span><span class="p">;</span>
	<span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">ps3av_mode</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps3av_set_videomode</span><span class="p">())</span>
		<span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">ps3av_mode</span> <span class="o">=</span> <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">ps3av_mode_old</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3av_set_video_mode</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ps3av_get_auto_mode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ps3av_auto_videomode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3av_get_auto_mode</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ps3av_get_mode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ps3av</span> <span class="o">?</span> <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">ps3av_mode</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3av_get_mode</span><span class="p">);</span>

<span class="cm">/* get resolution by video_mode */</span>
<span class="kt">int</span> <span class="nf">ps3av_video_mode2res</span><span class="p">(</span><span class="n">u32</span> <span class="n">id</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">xres</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">yres</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">id</span> <span class="o">&amp;</span> <span class="n">PS3AV_MODE_MASK</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">video_mode_table</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: invalid mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">xres</span> <span class="o">=</span> <span class="n">video_mode_table</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>
	<span class="o">*</span><span class="n">yres</span> <span class="o">=</span> <span class="n">video_mode_table</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">y</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3av_video_mode2res</span><span class="p">);</span>

<span class="cm">/* mute */</span>
<span class="kt">int</span> <span class="nf">ps3av_video_mute</span><span class="p">(</span><span class="kt">int</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ps3av_set_av_video_mute</span><span class="p">(</span><span class="n">mute</span> <span class="o">?</span> <span class="n">PS3AV_CMD_MUTE_ON</span>
					    <span class="o">:</span> <span class="n">PS3AV_CMD_MUTE_OFF</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3av_video_mute</span><span class="p">);</span>

<span class="cm">/* mute analog output only */</span>
<span class="kt">int</span> <span class="nf">ps3av_audio_mute_analog</span><span class="p">(</span><span class="kt">int</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">.</span><span class="n">num_of_avmulti</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_cmd_av_audio_mute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_port</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">.</span><span class="n">num_of_hdmi</span><span class="p">],</span>
			<span class="n">mute</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3av_audio_mute_analog</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ps3av_audio_mute</span><span class="p">(</span><span class="kt">int</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ps3av_set_audio_mute</span><span class="p">(</span><span class="n">mute</span> <span class="o">?</span> <span class="n">PS3AV_CMD_MUTE_ON</span>
					 <span class="o">:</span> <span class="n">PS3AV_CMD_MUTE_OFF</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3av_audio_mute</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ps3av_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_system_bus_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot; -&gt; %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot;  timeout=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps3av</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot;Only one ps3av device is supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ps3av</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ps3av</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ps3av</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">ps3av_mode</span> <span class="o">=</span> <span class="n">PS3AV_MODE_AUTO</span><span class="p">;</span>
	<span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">ps3avd</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
	<span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;ps3avd&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ps3_os_area_get_av_multi_out</span><span class="p">())</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PS3_PARAM_AV_MULTI_OUT_NTSC</span>:
		<span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">region</span> <span class="o">=</span> <span class="n">PS3AV_REGION_60</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PS3_PARAM_AV_MULTI_OUT_PAL_YCBCR</span>:
	<span class="k">case</span> <span class="n">PS3_PARAM_AV_MULTI_OUT_SECAM</span>:
		<span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">region</span> <span class="o">=</span> <span class="n">PS3AV_REGION_50</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PS3_PARAM_AV_MULTI_OUT_PAL_RGB</span>:
		<span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">region</span> <span class="o">=</span> <span class="n">PS3AV_REGION_50</span> <span class="o">|</span> <span class="n">PS3AV_REGION_RGB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">region</span> <span class="o">=</span> <span class="n">PS3AV_REGION_60</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* init avsetting modules */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_cmd_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: ps3av_cmd_init failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">res</span><span class="p">);</span>

	<span class="n">ps3av_get_hw_conf</span><span class="p">(</span><span class="n">ps3av</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_FB</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_mode_option</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">fb_mode_option</span><span class="p">,</span> <span class="s">&quot;safe&quot;</span><span class="p">))</span>
		<span class="n">safe_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FB */</span><span class="cp"></span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">ps3av_auto_videomode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">av_hw_conf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: invalid id :%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">safe_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">ps3av_mode</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot; &lt;- %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ps3av</span><span class="p">);</span>
	<span class="n">ps3av</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3av_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_system_bus_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot; -&gt; %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps3av</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ps3av_cmd_fin</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">)</span>
			<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">ps3av</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ps3av</span><span class="p">);</span>
		<span class="n">ps3av</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot; &lt;- %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ps3av_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_system_bus_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot; -&gt; %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">ps3av_remove</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot; &lt;- %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ps3_vuart_port_driver</span> <span class="n">ps3av_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">match_id</span> <span class="o">=</span> <span class="n">PS3_MATCH_ID_AV_SETTINGS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ps3_av&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ps3av_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">ps3av_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">ps3av_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ps3av_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">firmware_has_feature</span><span class="p">(</span><span class="n">FW_FEATURE_PS3_LV1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; -&gt; %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">ps3_vuart_port_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;%s: ps3_vuart_port_driver_register failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; &lt;- %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ps3av_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; -&gt; %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">ps3_vuart_port_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3av_driver</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; &lt;- %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">ps3av_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ps3av_module_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;PS3 AV Settings Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Sony Computer Entertainment Inc.&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="n">PS3_MODULE_ALIAS_AV_SETTINGS</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
