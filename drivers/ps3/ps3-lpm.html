<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ps3 › ps3-lpm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ps3-lpm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * PS3 Logical Performance Monitor.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2007 Sony Computer Entertainment Inc.</span>
<span class="cm"> *  Copyright 2007 Sony Corp.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/smp.h&gt;</span>
<span class="cp">#include &lt;asm/time.h&gt;</span>
<span class="cp">#include &lt;asm/ps3.h&gt;</span>
<span class="cp">#include &lt;asm/lv1call.h&gt;</span>
<span class="cp">#include &lt;asm/cell-pmu.h&gt;</span>


<span class="cm">/* BOOKMARK tag macros */</span>
<span class="cp">#define PS3_PM_BOOKMARK_START                    0x8000000000000000ULL</span>
<span class="cp">#define PS3_PM_BOOKMARK_STOP                     0x4000000000000000ULL</span>
<span class="cp">#define PS3_PM_BOOKMARK_TAG_KERNEL               0x1000000000000000ULL</span>
<span class="cp">#define PS3_PM_BOOKMARK_TAG_USER                 0x3000000000000000ULL</span>
<span class="cp">#define PS3_PM_BOOKMARK_TAG_MASK_HI              0xF000000000000000ULL</span>
<span class="cp">#define PS3_PM_BOOKMARK_TAG_MASK_LO              0x0F00000000000000ULL</span>

<span class="cm">/* CBE PM CONTROL register macros */</span>
<span class="cp">#define PS3_PM_CONTROL_PPU_TH0_BOOKMARK          0x00001000</span>
<span class="cp">#define PS3_PM_CONTROL_PPU_TH1_BOOKMARK          0x00000800</span>
<span class="cp">#define PS3_PM_CONTROL_PPU_COUNT_MODE_MASK       0x000C0000</span>
<span class="cp">#define PS3_PM_CONTROL_PPU_COUNT_MODE_PROBLEM    0x00080000</span>
<span class="cp">#define PS3_WRITE_PM_MASK                        0xFFFFFFFFFFFFFFFFULL</span>

<span class="cm">/* CBE PM START STOP register macros */</span>
<span class="cp">#define PS3_PM_START_STOP_PPU_TH0_BOOKMARK_START 0x02000000</span>
<span class="cp">#define PS3_PM_START_STOP_PPU_TH1_BOOKMARK_START 0x01000000</span>
<span class="cp">#define PS3_PM_START_STOP_PPU_TH0_BOOKMARK_STOP  0x00020000</span>
<span class="cp">#define PS3_PM_START_STOP_PPU_TH1_BOOKMARK_STOP  0x00010000</span>
<span class="cp">#define PS3_PM_START_STOP_START_MASK             0xFF000000</span>
<span class="cp">#define PS3_PM_START_STOP_STOP_MASK              0x00FF0000</span>

<span class="cm">/* CBE PM COUNTER register macres */</span>
<span class="cp">#define PS3_PM_COUNTER_MASK_HI                   0xFFFFFFFF00000000ULL</span>
<span class="cp">#define PS3_PM_COUNTER_MASK_LO                   0x00000000FFFFFFFFULL</span>

<span class="cm">/* BASE SIGNAL GROUP NUMBER macros */</span>
<span class="cp">#define PM_ISLAND2_BASE_SIGNAL_GROUP_NUMBER  0</span>
<span class="cp">#define PM_ISLAND2_SIGNAL_GROUP_NUMBER1      6</span>
<span class="cp">#define PM_ISLAND2_SIGNAL_GROUP_NUMBER2      7</span>
<span class="cp">#define PM_ISLAND3_BASE_SIGNAL_GROUP_NUMBER  7</span>
<span class="cp">#define PM_ISLAND4_BASE_SIGNAL_GROUP_NUMBER  15</span>
<span class="cp">#define PM_SPU_TRIGGER_SIGNAL_GROUP_NUMBER   17</span>
<span class="cp">#define PM_SPU_EVENT_SIGNAL_GROUP_NUMBER     18</span>
<span class="cp">#define PM_ISLAND5_BASE_SIGNAL_GROUP_NUMBER  18</span>
<span class="cp">#define PM_ISLAND6_BASE_SIGNAL_GROUP_NUMBER  24</span>
<span class="cp">#define PM_ISLAND7_BASE_SIGNAL_GROUP_NUMBER  49</span>
<span class="cp">#define PM_ISLAND8_BASE_SIGNAL_GROUP_NUMBER  52</span>
<span class="cp">#define PM_SIG_GROUP_SPU                     41</span>
<span class="cp">#define PM_SIG_GROUP_SPU_TRIGGER             42</span>
<span class="cp">#define PM_SIG_GROUP_SPU_EVENT               43</span>
<span class="cp">#define PM_SIG_GROUP_MFC_MAX                 60</span>

<span class="cm">/**</span>
<span class="cm"> * struct ps3_lpm_shadow_regs - Performance monitor shadow registers.</span>
<span class="cm"> *</span>
<span class="cm"> * @pm_control: Shadow of the processor&#39;s pm_control register.</span>
<span class="cm"> * @pm_start_stop: Shadow of the processor&#39;s pm_start_stop register.</span>
<span class="cm"> * @group_control: Shadow of the processor&#39;s group_control register.</span>
<span class="cm"> * @debug_bus_control: Shadow of the processor&#39;s debug_bus_control register.</span>
<span class="cm"> *</span>
<span class="cm"> * The logical performance monitor provides a write-only interface to</span>
<span class="cm"> * these processor registers.  These shadow variables cache the processor</span>
<span class="cm"> * register values for reading.</span>
<span class="cm"> *</span>
<span class="cm"> * The initial value of the shadow registers at lpm creation is</span>
<span class="cm"> * PS3_LPM_SHADOW_REG_INIT.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">ps3_lpm_shadow_regs</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">pm_control</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pm_start_stop</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">group_control</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">debug_bus_control</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define PS3_LPM_SHADOW_REG_INIT 0xFFFFFFFF00000000ULL</span>

<span class="cm">/**</span>
<span class="cm"> * struct ps3_lpm_priv - Private lpm device data.</span>
<span class="cm"> *</span>
<span class="cm"> * @open: An atomic variable indicating the lpm driver has been opened.</span>
<span class="cm"> * @rights: The lpm rigths granted by the system policy module.  A logical</span>
<span class="cm"> *  OR of enum ps3_lpm_rights.</span>
<span class="cm"> * @node_id: The node id of a BE prosessor whose performance monitor this</span>
<span class="cm"> *  lpar has the right to use.</span>
<span class="cm"> * @pu_id: The lv1 id of the logical PU.</span>
<span class="cm"> * @lpm_id: The lv1 id of this lpm instance.</span>
<span class="cm"> * @outlet_id: The outlet created by lv1 for this lpm instance.</span>
<span class="cm"> * @tb_count: The number of bytes of data held in the lv1 trace buffer.</span>
<span class="cm"> * @tb_cache: Kernel buffer to receive the data from the lv1 trace buffer.</span>
<span class="cm"> *  Must be 128 byte aligned.</span>
<span class="cm"> * @tb_cache_size: Size of the kernel @tb_cache buffer.  Must be 128 byte</span>
<span class="cm"> *  aligned.</span>
<span class="cm"> * @tb_cache_internal: An unaligned buffer allocated by this driver to be</span>
<span class="cm"> *  used for the trace buffer cache when ps3_lpm_open() is called with a</span>
<span class="cm"> *  NULL tb_cache argument.  Otherwise unused.</span>
<span class="cm"> * @shadow: Processor register shadow of type struct ps3_lpm_shadow_regs.</span>
<span class="cm"> * @sbd: The struct ps3_system_bus_device attached to this driver.</span>
<span class="cm"> *</span>
<span class="cm"> * The trace buffer is a buffer allocated and used internally to the lv1</span>
<span class="cm"> * hypervisor to collect trace data.  The trace buffer cache is a guest</span>
<span class="cm"> * buffer that accepts the trace data from the trace buffer.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">ps3_lpm_priv</span> <span class="p">{</span>
	<span class="n">atomic_t</span> <span class="n">open</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rights</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">node_id</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pu_id</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">lpm_id</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">outlet_id</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tb_count</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">tb_cache</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tb_cache_size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">tb_cache_internal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3_lpm_shadow_regs</span> <span class="n">shadow</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3_system_bus_device</span> <span class="o">*</span><span class="n">sbd</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">PS3_LPM_DEFAULT_TB_CACHE_SIZE</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * lpm_priv - Static instance of the lpm data.</span>
<span class="cm"> *</span>
<span class="cm"> * Since the exported routines don&#39;t support the notion of a device</span>
<span class="cm"> * instance we need to hold the instance in this static variable</span>
<span class="cm"> * and then only allow at most one instance at a time to be created.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ps3_lpm_priv</span> <span class="o">*</span><span class="n">lpm_priv</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="nf">sbd_core</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">lpm_priv</span> <span class="o">||</span> <span class="o">!</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">sbd</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">sbd</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * use_start_stop_bookmark - Enable the PPU bookmark trace.</span>
<span class="cm"> *</span>
<span class="cm"> * And it enables PPU bookmark triggers ONLY if the other triggers are not set.</span>
<span class="cm"> * The start/stop bookmarks are inserted at ps3_enable_pm() and ps3_disable_pm()</span>
<span class="cm"> * to start/stop LPM.</span>
<span class="cm"> *</span>
<span class="cm"> * Used to get good quality of the performance counter.</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="p">{</span><span class="n">use_start_stop_bookmark</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,};</span>

<span class="kt">void</span> <span class="nf">ps3_set_bookmark</span><span class="p">(</span><span class="n">u64</span> <span class="n">bookmark</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * As per the PPE book IV, to avoid bookmark loss there must</span>
<span class="cm">	 * not be a traced branch within 10 cycles of setting the</span>
<span class="cm">	 * SPRN_BKMK register.  The actual text is unclear if &#39;within&#39;</span>
<span class="cm">	 * includes cycles before the call.</span>
<span class="cm">	 */</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;nop;nop;nop;nop;nop;nop;nop;nop;nop;&quot;</span><span class="p">);</span>
	<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_BKMK</span><span class="p">,</span> <span class="n">bookmark</span><span class="p">);</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;nop;nop;nop;nop;nop;nop;nop;nop;nop;&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_set_bookmark</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ps3_set_pm_bookmark</span><span class="p">(</span><span class="n">u64</span> <span class="n">tag</span><span class="p">,</span> <span class="n">u64</span> <span class="n">incident</span><span class="p">,</span> <span class="n">u64</span> <span class="n">th_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">bookmark</span><span class="p">;</span>

	<span class="n">bookmark</span> <span class="o">=</span> <span class="p">(</span><span class="n">get_tb</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0x00000000FFFFFFFFULL</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">PS3_PM_BOOKMARK_TAG_KERNEL</span><span class="p">;</span>
	<span class="n">bookmark</span> <span class="o">=</span> <span class="p">((</span><span class="n">tag</span> <span class="o">&lt;&lt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PS3_PM_BOOKMARK_TAG_MASK_LO</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">incident</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">th_id</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">bookmark</span><span class="p">;</span>
	<span class="n">ps3_set_bookmark</span><span class="p">(</span><span class="n">bookmark</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_set_pm_bookmark</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_read_phys_ctr - Read physical counter registers.</span>
<span class="cm"> *</span>
<span class="cm"> * Each physical counter can act as one 32 bit counter or as two 16 bit</span>
<span class="cm"> * counters.</span>
<span class="cm"> */</span>

<span class="n">u32</span> <span class="nf">ps3_read_phys_ctr</span><span class="p">(</span><span class="n">u32</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phys_ctr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">counter0415</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">counter2637</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phys_ctr</span> <span class="o">&gt;=</span> <span class="n">NR_PHYS_CTRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: phys_ctr too big: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">__LINE__</span><span class="p">,</span> <span class="n">phys_ctr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_set_lpm_counter</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">counter0415</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">counter2637</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: lv1_set_lpm_counter failed: &quot;</span>
			<span class="s">&quot;phys_ctr %u, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">phys_ctr</span><span class="p">,</span>
			<span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phys_ctr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">counter0415</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">counter0415</span> <span class="o">&amp;</span> <span class="n">PS3_PM_COUNTER_MASK_LO</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">counter2637</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">return</span> <span class="n">counter2637</span> <span class="o">&amp;</span> <span class="n">PS3_PM_COUNTER_MASK_LO</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_read_phys_ctr</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_write_phys_ctr - Write physical counter registers.</span>
<span class="cm"> *</span>
<span class="cm"> * Each physical counter can act as one 32 bit counter or as two 16 bit</span>
<span class="cm"> * counters.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ps3_write_phys_ctr</span><span class="p">(</span><span class="n">u32</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phys_ctr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">counter0415</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">counter0415_mask</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">counter2637</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">counter2637_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phys_ctr</span> <span class="o">&gt;=</span> <span class="n">NR_PHYS_CTRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: phys_ctr too big: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">__LINE__</span><span class="p">,</span> <span class="n">phys_ctr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phys_ctr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">counter0415</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">counter0415_mask</span> <span class="o">=</span> <span class="n">PS3_PM_COUNTER_MASK_HI</span><span class="p">;</span>
		<span class="n">counter2637</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">counter2637_mask</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">counter0415</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
		<span class="n">counter0415_mask</span> <span class="o">=</span> <span class="n">PS3_PM_COUNTER_MASK_LO</span><span class="p">;</span>
		<span class="n">counter2637</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">counter2637_mask</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">counter0415</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">counter0415_mask</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">counter2637</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">counter2637_mask</span> <span class="o">=</span> <span class="n">PS3_PM_COUNTER_MASK_HI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">counter0415</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">counter0415_mask</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">counter2637</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
		<span class="n">counter2637_mask</span> <span class="o">=</span> <span class="n">PS3_PM_COUNTER_MASK_LO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_set_lpm_counter</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span><span class="p">,</span>
				     <span class="n">counter0415</span><span class="p">,</span> <span class="n">counter0415_mask</span><span class="p">,</span>
				     <span class="n">counter2637</span><span class="p">,</span> <span class="n">counter2637_mask</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">counter0415</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">counter2637</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: lv1_set_lpm_counter failed: &quot;</span>
			<span class="s">&quot;phys_ctr %u, val %u, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">phys_ctr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_write_phys_ctr</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_read_ctr - Read counter.</span>
<span class="cm"> *</span>
<span class="cm"> * Read 16 or 32 bits depending on the current size of the counter.</span>
<span class="cm"> * Counters 4, 5, 6 &amp; 7 are always 16 bit.</span>
<span class="cm"> */</span>

<span class="n">u32</span> <span class="nf">ps3_read_ctr</span><span class="p">(</span><span class="n">u32</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ctr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phys_ctr</span> <span class="o">=</span> <span class="n">ctr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NR_PHYS_CTRS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ps3_read_phys_ctr</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">phys_ctr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps3_get_ctr_size</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">phys_ctr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctr</span> <span class="o">&lt;</span> <span class="n">NR_PHYS_CTRS</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_read_ctr</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_write_ctr - Write counter.</span>
<span class="cm"> *</span>
<span class="cm"> * Write 16 or 32 bits depending on the current size of the counter.</span>
<span class="cm"> * Counters 4, 5, 6 &amp; 7 are always 16 bit.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ps3_write_ctr</span><span class="p">(</span><span class="n">u32</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ctr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phys_ctr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phys_val</span><span class="p">;</span>

	<span class="n">phys_ctr</span> <span class="o">=</span> <span class="n">ctr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NR_PHYS_CTRS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps3_get_ctr_size</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">phys_ctr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phys_val</span> <span class="o">=</span> <span class="n">ps3_read_phys_ctr</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">phys_ctr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctr</span> <span class="o">&lt;</span> <span class="n">NR_PHYS_CTRS</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">phys_val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">phys_val</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ps3_write_phys_ctr</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">phys_ctr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_write_ctr</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_read_pm07_control - Read counter control registers.</span>
<span class="cm"> *</span>
<span class="cm"> * Each logical counter has a corresponding control register.</span>
<span class="cm"> */</span>

<span class="n">u32</span> <span class="nf">ps3_read_pm07_control</span><span class="p">(</span><span class="n">u32</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ctr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_read_pm07_control</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_write_pm07_control - Write counter control registers.</span>
<span class="cm"> *</span>
<span class="cm"> * Each logical counter has a corresponding control register.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ps3_write_pm07_control</span><span class="p">(</span><span class="n">u32</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ctr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0xFFFFFFFFFFFFFFFFULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">old_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctr</span> <span class="o">&gt;=</span> <span class="n">NR_CTRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: ctr too big: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">__LINE__</span><span class="p">,</span> <span class="n">ctr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_set_lpm_counter_control</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span><span class="p">,</span> <span class="n">ctr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">old_value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: lv1_set_lpm_counter_control &quot;</span>
			<span class="s">&quot;failed: ctr %u, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ctr</span><span class="p">,</span>
			<span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_write_pm07_control</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_read_pm - Read Other LPM control registers.</span>
<span class="cm"> */</span>

<span class="n">u32</span> <span class="nf">ps3_read_pm</span><span class="p">(</span><span class="n">u32</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pm_reg_name</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">pm_control</span>:
		<span class="k">return</span> <span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">pm_control</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">trace_address</span>:
		<span class="k">return</span> <span class="n">CBE_PM_TRACE_BUF_EMPTY</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pm_start_stop</span>:
		<span class="k">return</span> <span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">pm_start_stop</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pm_interval</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_set_lpm_interval</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: lv1 set_inteval failed: &quot;</span>
				<span class="s">&quot;reg %u, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
				<span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">group_control</span>:
		<span class="k">return</span> <span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">group_control</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">debug_bus_control</span>:
		<span class="k">return</span> <span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">debug_bus_control</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pm_status</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_get_lpm_interrupt_status</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: lv1 get_lpm_status failed: &quot;</span>
				<span class="s">&quot;reg %u, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
				<span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ext_tr_timer</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: unknown reg: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">__LINE__</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_read_pm</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_write_pm - Write Other LPM control registers.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ps3_write_pm</span><span class="p">(</span><span class="n">u32</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pm_reg_name</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dummy</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">group_control</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">group_control</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_set_lpm_group_control</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span><span class="p">,</span>
							   <span class="n">val</span><span class="p">,</span>
							   <span class="n">PS3_WRITE_PM_MASK</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>
		<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">group_control</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">debug_bus_control</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">debug_bus_control</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_set_lpm_debug_bus_control</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span><span class="p">,</span>
							      <span class="n">val</span><span class="p">,</span>
							      <span class="n">PS3_WRITE_PM_MASK</span><span class="p">,</span>
							      <span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>
		<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">debug_bus_control</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pm_control</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">use_start_stop_bookmark</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PS3_PM_CONTROL_PPU_TH0_BOOKMARK</span> <span class="o">|</span>
				<span class="n">PS3_PM_CONTROL_PPU_TH1_BOOKMARK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">pm_control</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_set_lpm_general_control</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span><span class="p">,</span>
							     <span class="n">val</span><span class="p">,</span>
							     <span class="n">PS3_WRITE_PM_MASK</span><span class="p">,</span>
							     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">,</span>
							     <span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>
		<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">pm_control</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pm_interval</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_set_lpm_interval</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
					      <span class="n">PS3_WRITE_PM_MASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pm_start_stop</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">pm_start_stop</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_set_lpm_trigger_control</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span><span class="p">,</span>
							     <span class="n">val</span><span class="p">,</span>
							     <span class="n">PS3_WRITE_PM_MASK</span><span class="p">,</span>
							     <span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>
		<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">pm_start_stop</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">trace_address</span>:
	<span class="k">case</span> <span class="n">ext_tr_timer</span>:
	<span class="k">case</span> <span class="n">pm_status</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: unknown reg: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">__LINE__</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: lv1 set_control failed: &quot;</span>
			<span class="s">&quot;reg %u, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
			<span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_write_pm</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_get_ctr_size - Get the size of a physical counter.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns either 16 or 32.</span>
<span class="cm"> */</span>

<span class="n">u32</span> <span class="nf">ps3_get_ctr_size</span><span class="p">(</span><span class="n">u32</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phys_ctr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pm_ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phys_ctr</span> <span class="o">&gt;=</span> <span class="n">NR_PHYS_CTRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: phys_ctr too big: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">__LINE__</span><span class="p">,</span> <span class="n">phys_ctr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm_ctrl</span> <span class="o">=</span> <span class="n">ps3_read_pm</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">pm_control</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">pm_ctrl</span> <span class="o">&amp;</span> <span class="n">CBE_PM_16BIT_CTR</span><span class="p">(</span><span class="n">phys_ctr</span><span class="p">))</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">32</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_get_ctr_size</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_set_ctr_size - Set the size of a physical counter to 16 or 32 bits.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ps3_set_ctr_size</span><span class="p">(</span><span class="n">u32</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phys_ctr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ctr_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pm_ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phys_ctr</span> <span class="o">&gt;=</span> <span class="n">NR_PHYS_CTRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: phys_ctr too big: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">__LINE__</span><span class="p">,</span> <span class="n">phys_ctr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm_ctrl</span> <span class="o">=</span> <span class="n">ps3_read_pm</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">pm_control</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctr_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">pm_ctrl</span> <span class="o">|=</span> <span class="n">CBE_PM_16BIT_CTR</span><span class="p">(</span><span class="n">phys_ctr</span><span class="p">);</span>
		<span class="n">ps3_write_pm</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">pm_control</span><span class="p">,</span> <span class="n">pm_ctrl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">pm_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CBE_PM_16BIT_CTR</span><span class="p">(</span><span class="n">phys_ctr</span><span class="p">);</span>
		<span class="n">ps3_write_pm</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">pm_control</span><span class="p">,</span> <span class="n">pm_ctrl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_set_ctr_size</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">pm_translate_signal_group_number_on_island2</span><span class="p">(</span><span class="n">u64</span> <span class="n">subgroup</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">subgroup</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">subgroup</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">subgroup</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PM_ISLAND2_BASE_SIGNAL_GROUP_NUMBER</span> <span class="o">+</span> <span class="n">subgroup</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">subgroup</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PM_ISLAND2_SIGNAL_GROUP_NUMBER1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">PM_ISLAND2_SIGNAL_GROUP_NUMBER2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">pm_translate_signal_group_number_on_island3</span><span class="p">(</span><span class="n">u64</span> <span class="n">subgroup</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">subgroup</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">3</span>:
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">subgroup</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">subgroup</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">PM_ISLAND3_BASE_SIGNAL_GROUP_NUMBER</span> <span class="o">+</span> <span class="n">subgroup</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">pm_translate_signal_group_number_on_island4</span><span class="p">(</span><span class="n">u64</span> <span class="n">subgroup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PM_ISLAND4_BASE_SIGNAL_GROUP_NUMBER</span> <span class="o">+</span> <span class="n">subgroup</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">pm_translate_signal_group_number_on_island5</span><span class="p">(</span><span class="n">u64</span> <span class="n">subgroup</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">subgroup</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">subgroup</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">subgroup</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">PM_ISLAND5_BASE_SIGNAL_GROUP_NUMBER</span> <span class="o">+</span> <span class="n">subgroup</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">pm_translate_signal_group_number_on_island6</span><span class="p">(</span><span class="n">u64</span> <span class="n">subgroup</span><span class="p">,</span>
						       <span class="n">u64</span> <span class="n">subsubgroup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">subgroup</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>:
	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">subgroup</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">subsubgroup</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">5</span>:
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">subsubgroup</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
	<span class="k">case</span> <span class="mi">8</span>:
	<span class="k">case</span> <span class="mi">9</span>:
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="n">subsubgroup</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11</span>:
	<span class="k">case</span> <span class="mi">12</span>:
	<span class="k">case</span> <span class="mi">13</span>:
		<span class="n">subsubgroup</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">subgroup</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">PM_ISLAND6_BASE_SIGNAL_GROUP_NUMBER</span> <span class="o">+</span> <span class="n">subgroup</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">PM_ISLAND6_BASE_SIGNAL_GROUP_NUMBER</span> <span class="o">+</span> <span class="n">subgroup</span>
			<span class="o">+</span> <span class="n">subsubgroup</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">pm_translate_signal_group_number_on_island7</span><span class="p">(</span><span class="n">u64</span> <span class="n">subgroup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PM_ISLAND7_BASE_SIGNAL_GROUP_NUMBER</span> <span class="o">+</span> <span class="n">subgroup</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">pm_translate_signal_group_number_on_island8</span><span class="p">(</span><span class="n">u64</span> <span class="n">subgroup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PM_ISLAND8_BASE_SIGNAL_GROUP_NUMBER</span> <span class="o">+</span> <span class="n">subgroup</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">pm_signal_group_to_ps3_lv1_signal_group</span><span class="p">(</span><span class="n">u64</span> <span class="n">group</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">island</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">subgroup</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">subsubgroup</span><span class="p">;</span>

	<span class="n">subgroup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">subsubgroup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">island</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">group</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">group</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">20</span> <span class="o">&lt;=</span> <span class="n">group</span> <span class="o">&amp;&amp;</span> <span class="n">group</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">island</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">subgroup</span> <span class="o">=</span> <span class="n">group</span> <span class="o">-</span> <span class="mi">20</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">30</span> <span class="o">&lt;=</span> <span class="n">group</span> <span class="o">&amp;&amp;</span> <span class="n">group</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">island</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">subgroup</span> <span class="o">=</span> <span class="n">group</span> <span class="o">-</span> <span class="mi">30</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">40</span> <span class="o">&lt;=</span> <span class="n">group</span> <span class="o">&amp;&amp;</span> <span class="n">group</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">island</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">subgroup</span> <span class="o">=</span> <span class="n">group</span> <span class="o">-</span> <span class="mi">40</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">50</span> <span class="o">&lt;=</span> <span class="n">group</span> <span class="o">&amp;&amp;</span> <span class="n">group</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">island</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">subgroup</span> <span class="o">=</span> <span class="n">group</span> <span class="o">-</span> <span class="mi">50</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">60</span> <span class="o">&lt;=</span> <span class="n">group</span> <span class="o">&amp;&amp;</span> <span class="n">group</span> <span class="o">&lt;</span> <span class="mi">70</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">island</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
				<span class="n">subgroup</span> <span class="o">=</span> <span class="n">group</span> <span class="o">-</span> <span class="mi">60</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">70</span> <span class="o">&lt;=</span> <span class="n">group</span> <span class="o">&amp;&amp;</span> <span class="n">group</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">island</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
				<span class="n">subgroup</span> <span class="o">=</span> <span class="n">group</span> <span class="o">-</span> <span class="mi">70</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">80</span> <span class="o">&lt;=</span> <span class="n">group</span> <span class="o">&amp;&amp;</span> <span class="n">group</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">island</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">subgroup</span> <span class="o">=</span> <span class="n">group</span> <span class="o">-</span> <span class="mi">80</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">200</span> <span class="o">&lt;=</span> <span class="n">group</span> <span class="o">&amp;&amp;</span> <span class="n">group</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">island</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">subgroup</span> <span class="o">=</span> <span class="n">group</span> <span class="o">-</span> <span class="mi">200</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">600</span> <span class="o">&lt;=</span> <span class="n">group</span> <span class="o">&amp;&amp;</span> <span class="n">group</span> <span class="o">&lt;</span> <span class="mi">700</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">island</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">subgroup</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">subsubgroup</span> <span class="o">=</span> <span class="n">group</span> <span class="o">-</span> <span class="mi">650</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">6000</span> <span class="o">&lt;=</span> <span class="n">group</span> <span class="o">&amp;&amp;</span> <span class="n">group</span> <span class="o">&lt;</span> <span class="mi">7000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">island</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">subgroup</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">subsubgroup</span> <span class="o">=</span> <span class="n">group</span> <span class="o">-</span> <span class="mi">6500</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">island</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">pm_translate_signal_group_number_on_island2</span><span class="p">(</span><span class="n">subgroup</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">return</span> <span class="n">pm_translate_signal_group_number_on_island3</span><span class="p">(</span><span class="n">subgroup</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">return</span> <span class="n">pm_translate_signal_group_number_on_island4</span><span class="p">(</span><span class="n">subgroup</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="k">return</span> <span class="n">pm_translate_signal_group_number_on_island5</span><span class="p">(</span><span class="n">subgroup</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="k">return</span> <span class="n">pm_translate_signal_group_number_on_island6</span><span class="p">(</span><span class="n">subgroup</span><span class="p">,</span>
								   <span class="n">subsubgroup</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="k">return</span> <span class="n">pm_translate_signal_group_number_on_island7</span><span class="p">(</span><span class="n">subgroup</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">return</span> <span class="n">pm_translate_signal_group_number_on_island8</span><span class="p">(</span><span class="n">subgroup</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: island not found: %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">__LINE__</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">pm_bus_word_to_ps3_lv1_bus_word</span><span class="p">(</span><span class="n">u8</span> <span class="n">word</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="mh">0xF000</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="mh">0x0F00</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">return</span> <span class="mh">0x00F0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mh">0x000F</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ps3_set_signal</span><span class="p">(</span><span class="n">u64</span> <span class="n">lv1_signal_group</span><span class="p">,</span> <span class="n">u64</span> <span class="n">bus_select</span><span class="p">,</span>
			    <span class="n">u64</span> <span class="n">signal_select</span><span class="p">,</span> <span class="n">u64</span> <span class="n">attr1</span><span class="p">,</span> <span class="n">u64</span> <span class="n">attr2</span><span class="p">,</span> <span class="n">u64</span> <span class="n">attr3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lv1_set_lpm_signal</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span><span class="p">,</span> <span class="n">lv1_signal_group</span><span class="p">,</span> <span class="n">bus_select</span><span class="p">,</span>
				 <span class="n">signal_select</span><span class="p">,</span> <span class="n">attr1</span><span class="p">,</span> <span class="n">attr2</span><span class="p">,</span> <span class="n">attr3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span>
			<span class="s">&quot;%s:%u: error:%d 0x%llx 0x%llx 0x%llx 0x%llx 0x%llx 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">lv1_signal_group</span><span class="p">,</span> <span class="n">bus_select</span><span class="p">,</span>
			<span class="n">signal_select</span><span class="p">,</span> <span class="n">attr1</span><span class="p">,</span> <span class="n">attr2</span><span class="p">,</span> <span class="n">attr3</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_set_signal</span><span class="p">(</span><span class="n">u64</span> <span class="n">signal_group</span><span class="p">,</span> <span class="n">u8</span> <span class="n">signal_bit</span><span class="p">,</span> <span class="n">u16</span> <span class="n">sub_unit</span><span class="p">,</span>
		   <span class="n">u8</span> <span class="n">bus_word</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">lv1_signal_group</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">bus_select</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">signal_select</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">attr1</span><span class="p">,</span> <span class="n">attr2</span><span class="p">,</span> <span class="n">attr3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal_group</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">__ps3_set_signal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">lv1_signal_group</span> <span class="o">=</span>
		<span class="n">pm_signal_group_to_ps3_lv1_signal_group</span><span class="p">(</span><span class="n">signal_group</span><span class="p">);</span>
	<span class="n">bus_select</span> <span class="o">=</span> <span class="n">pm_bus_word_to_ps3_lv1_bus_word</span><span class="p">(</span><span class="n">bus_word</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">signal_group</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PM_SIG_GROUP_SPU_TRIGGER</span>:
		<span class="n">signal_select</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">signal_select</span> <span class="o">=</span> <span class="n">signal_select</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">63</span> <span class="o">-</span> <span class="n">signal_bit</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_SIG_GROUP_SPU_EVENT</span>:
		<span class="n">signal_select</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">signal_select</span> <span class="o">=</span> <span class="p">(</span><span class="n">signal_select</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">63</span> <span class="o">-</span> <span class="n">signal_bit</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">signal_select</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * 0: physical object.</span>
<span class="cm">	 * 1: logical object.</span>
<span class="cm">	 * This parameter is only used for the PPE and SPE signals.</span>
<span class="cm">	 */</span>
	<span class="n">attr1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This parameter is used to specify the target physical/logical</span>
<span class="cm">	 * PPE/SPE object.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PM_SIG_GROUP_SPU</span> <span class="o">&lt;=</span> <span class="n">signal_group</span> <span class="o">&amp;&amp;</span>
		<span class="n">signal_group</span> <span class="o">&lt;</span> <span class="n">PM_SIG_GROUP_MFC_MAX</span><span class="p">)</span>
		<span class="n">attr2</span> <span class="o">=</span> <span class="n">sub_unit</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">attr2</span> <span class="o">=</span> <span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">pu_id</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This parameter is only used for setting the SPE signal.</span>
<span class="cm">	 */</span>
	<span class="n">attr3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__ps3_set_signal</span><span class="p">(</span><span class="n">lv1_signal_group</span><span class="p">,</span> <span class="n">bus_select</span><span class="p">,</span> <span class="n">signal_select</span><span class="p">,</span>
			       <span class="n">attr1</span><span class="p">,</span> <span class="n">attr2</span><span class="p">,</span> <span class="n">attr3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: __ps3_set_signal failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_set_signal</span><span class="p">);</span>

<span class="n">u32</span> <span class="nf">ps3_get_hw_thread_id</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">get_hard_smp_processor_id</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_get_hw_thread_id</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_enable_pm - Enable the entire performance monitoring unit.</span>
<span class="cm"> *</span>
<span class="cm"> * When we enable the LPM, all pending writes to counters get committed.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ps3_enable_pm</span><span class="p">(</span><span class="n">u32</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">insert_bookmark</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_start_stop_bookmark</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">pm_start_stop</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">PS3_PM_START_STOP_START_MASK</span>
			<span class="o">|</span> <span class="n">PS3_PM_START_STOP_STOP_MASK</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_set_lpm_trigger_control</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span><span class="p">,</span>
				<span class="p">(</span><span class="n">PS3_PM_START_STOP_PPU_TH0_BOOKMARK_START</span> <span class="o">|</span>
				<span class="n">PS3_PM_START_STOP_PPU_TH1_BOOKMARK_START</span> <span class="o">|</span>
				<span class="n">PS3_PM_START_STOP_PPU_TH0_BOOKMARK_STOP</span> <span class="o">|</span>
				<span class="n">PS3_PM_START_STOP_PPU_TH1_BOOKMARK_STOP</span><span class="p">),</span>
				<span class="mh">0xFFFFFFFFFFFFFFFFULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: &quot;</span>
					<span class="s">&quot;lv1_set_lpm_trigger_control failed: &quot;</span>
					<span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
					<span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>

			<span class="n">insert_bookmark</span> <span class="o">=</span> <span class="o">!</span><span class="n">result</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_start_lpm</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: lv1_start_lpm failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_start_stop_bookmark</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">insert_bookmark</span><span class="p">)</span>
		<span class="n">ps3_set_bookmark</span><span class="p">(</span><span class="n">get_tb</span><span class="p">()</span> <span class="o">|</span> <span class="n">PS3_PM_BOOKMARK_START</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_enable_pm</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_disable_pm - Disable the entire performance monitoring unit.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ps3_disable_pm</span><span class="p">(</span><span class="n">u32</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">ps3_set_bookmark</span><span class="p">(</span><span class="n">get_tb</span><span class="p">()</span> <span class="o">|</span> <span class="n">PS3_PM_BOOKMARK_STOP</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_stop_lpm</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">LV1_WRONG_STATE</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: lv1_stop_lpm failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_count</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: tb_count %llu (%llxh)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_count</span><span class="p">,</span> <span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_count</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_disable_pm</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_lpm_copy_tb - Copy data from the trace buffer to a kernel buffer.</span>
<span class="cm"> * @offset: Offset in bytes from the start of the trace buffer.</span>
<span class="cm"> * @buf: Copy destination.</span>
<span class="cm"> * @count: Maximum count of bytes to copy.</span>
<span class="cm"> * @bytes_copied: Pointer to a variable that will receive the number of</span>
<span class="cm"> *  bytes copied to @buf.</span>
<span class="cm"> *</span>
<span class="cm"> * On error @buf will contain any successfully copied trace buffer data</span>
<span class="cm"> * and bytes_copied will be set to the number of bytes successfully copied.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_lpm_copy_tb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bytes_copied</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="o">*</span><span class="n">bytes_copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u64</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_count</span> <span class="o">-</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">bytes_copied</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">request</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="o">*</span><span class="n">bytes_copied</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_copy_lpm_trace_buffer</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
						   <span class="n">request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: 0x%lx bytes at 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

			<span class="n">dev_err</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: lv1_copy_lpm_trace_buffer &quot;</span>
				<span class="s">&quot;failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
				<span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">result</span> <span class="o">==</span> <span class="n">LV1_WRONG_STATE</span> <span class="o">?</span> <span class="o">-</span><span class="n">EBUSY</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bytes_copied</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: copied %lxh bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		<span class="o">*</span><span class="n">bytes_copied</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_lpm_copy_tb</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_lpm_copy_tb_to_user - Copy data from the trace buffer to a user buffer.</span>
<span class="cm"> * @offset: Offset in bytes from the start of the trace buffer.</span>
<span class="cm"> * @buf: A __user copy destination.</span>
<span class="cm"> * @count: Maximum count of bytes to copy.</span>
<span class="cm"> * @bytes_copied: Pointer to a variable that will receive the number of</span>
<span class="cm"> *  bytes copied to @buf.</span>
<span class="cm"> *</span>
<span class="cm"> * On error @buf will contain any successfully copied trace buffer data</span>
<span class="cm"> * and bytes_copied will be set to the number of bytes successfully copied.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_lpm_copy_tb_to_user</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bytes_copied</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="o">*</span><span class="n">bytes_copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u64</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_count</span> <span class="o">-</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">bytes_copied</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">request</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="o">*</span><span class="n">bytes_copied</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_copy_lpm_trace_buffer</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
						   <span class="n">request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: 0x%lx bytes at 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: lv1_copy_lpm_trace_buffer &quot;</span>
				<span class="s">&quot;failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
				<span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">result</span> <span class="o">==</span> <span class="n">LV1_WRONG_STATE</span> <span class="o">?</span> <span class="o">-</span><span class="n">EBUSY</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: 0x%llx bytes at 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: copy_to_user failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">buf</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bytes_copied</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: copied %lxh bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		<span class="o">*</span><span class="n">bytes_copied</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_lpm_copy_tb_to_user</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_get_and_clear_pm_interrupts -</span>
<span class="cm"> *</span>
<span class="cm"> * Clearing interrupts for the entire performance monitoring unit.</span>
<span class="cm"> * Reading pm_status clears the interrupt bits.</span>
<span class="cm"> */</span>

<span class="n">u32</span> <span class="nf">ps3_get_and_clear_pm_interrupts</span><span class="p">(</span><span class="n">u32</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ps3_read_pm</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">pm_status</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_get_and_clear_pm_interrupts</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_enable_pm_interrupts -</span>
<span class="cm"> *</span>
<span class="cm"> * Enabling interrupts for the entire performance monitoring unit.</span>
<span class="cm"> * Enables the interrupt bits in the pm_status register.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ps3_enable_pm_interrupts</span><span class="p">(</span><span class="n">u32</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">u32</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span>
		<span class="n">ps3_write_pm</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">pm_status</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_enable_pm_interrupts</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_enable_pm_interrupts -</span>
<span class="cm"> *</span>
<span class="cm"> * Disabling interrupts for the entire performance monitoring unit.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ps3_disable_pm_interrupts</span><span class="p">(</span><span class="n">u32</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ps3_get_and_clear_pm_interrupts</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="n">ps3_write_pm</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">pm_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_disable_pm_interrupts</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_lpm_open - Open the logical performance monitor device.</span>
<span class="cm"> * @tb_type: Specifies the type of trace buffer lv1 should use for this lpm</span>
<span class="cm"> *  instance, specified by one of enum ps3_lpm_tb_type.</span>
<span class="cm"> * @tb_cache: Optional user supplied buffer to use as the trace buffer cache.</span>
<span class="cm"> *  If NULL, the driver will allocate and manage an internal buffer.</span>
<span class="cm"> *  Unused when when @tb_type is PS3_LPM_TB_TYPE_NONE.</span>
<span class="cm"> * @tb_cache_size: The size in bytes of the user supplied @tb_cache buffer.</span>
<span class="cm"> *  Unused when @tb_cache is NULL or @tb_type is PS3_LPM_TB_TYPE_NONE.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_lpm_open</span><span class="p">(</span><span class="k">enum</span> <span class="n">ps3_lpm_tb_type</span> <span class="n">tb_type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">tb_cache</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">tb_cache_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tb_size</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">lpm_priv</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tb_type</span> <span class="o">!=</span> <span class="n">PS3_LPM_TB_TYPE_NONE</span>
		<span class="o">&amp;&amp;</span> <span class="n">tb_type</span> <span class="o">!=</span> <span class="n">PS3_LPM_TB_TYPE_INTERNAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb_type</span> <span class="o">==</span> <span class="n">PS3_LPM_TB_TYPE_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">tb_cache</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: bad in vals</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_add_unless</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Note tb_cache needs 128 byte alignment. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tb_type</span> <span class="o">==</span> <span class="n">PS3_LPM_TB_TYPE_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache_internal</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tb_cache</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tb_cache</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">_ALIGN_UP</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">tb_cache</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
			<span class="o">||</span> <span class="n">tb_cache_size</span> <span class="o">!=</span> <span class="n">_ALIGN_UP</span><span class="p">(</span><span class="n">tb_cache_size</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: unaligned tb_cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_align</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache_size</span> <span class="o">=</span> <span class="n">tb_cache_size</span><span class="p">;</span>
		<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache_internal</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache</span> <span class="o">=</span> <span class="n">tb_cache</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache_size</span> <span class="o">=</span> <span class="n">PS3_LPM_DEFAULT_TB_CACHE_SIZE</span><span class="p">;</span>
		<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache_internal</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span>
			<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache_size</span> <span class="o">+</span> <span class="mi">127</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache_internal</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: alloc internal tb_cache &quot;</span>
				<span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_malloc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">_ALIGN_UP</span><span class="p">(</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache_internal</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_construct_lpm</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">node_id</span><span class="p">,</span> <span class="n">tb_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">ps3_mm_phys_to_lpar</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache</span><span class="p">)),</span>
				<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">outlet_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tb_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: lv1_construct_lpm failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_construct</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">pm_control</span> <span class="o">=</span> <span class="n">PS3_LPM_SHADOW_REG_INIT</span><span class="p">;</span>
	<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">pm_start_stop</span> <span class="o">=</span> <span class="n">PS3_LPM_SHADOW_REG_INIT</span><span class="p">;</span>
	<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">group_control</span> <span class="o">=</span> <span class="n">PS3_LPM_SHADOW_REG_INIT</span><span class="p">;</span>
	<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">debug_bus_control</span> <span class="o">=</span> <span class="n">PS3_LPM_SHADOW_REG_INIT</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u: lpm_id 0x%llx, outlet_id 0x%llx, &quot;</span>
		<span class="s">&quot;tb_size 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span><span class="p">,</span>
		<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">outlet_id</span><span class="p">,</span> <span class="n">tb_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_construct:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache_internal</span><span class="p">);</span>
	<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache_internal</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">fail_malloc:</span>
<span class="nl">fail_align:</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_lpm_open</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_lpm_close - Close the lpm device.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_lpm_close</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sbd_core</span><span class="p">(),</span> <span class="s">&quot;%s:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">lv1_destruct_lpm</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span><span class="p">);</span>
	<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">lpm_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache_internal</span><span class="p">);</span>
	<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">tb_cache_internal</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_lpm_close</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ps3_lpm_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_system_bus_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot; -&gt; %s:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lpm_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot;%s:%u: called twice</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lpm_priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lpm_priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpm_priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">sbd</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">lpm</span><span class="p">.</span><span class="n">node_id</span><span class="p">;</span>
	<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">pu_id</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">lpm</span><span class="p">.</span><span class="n">pu_id</span><span class="p">;</span>
	<span class="n">lpm_priv</span><span class="o">-&gt;</span><span class="n">rights</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">lpm</span><span class="p">.</span><span class="n">rights</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot; &lt;- %s:%u:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3_lpm_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_system_bus_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot; -&gt; %s:%u:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">ps3_lpm_close</span><span class="p">();</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">lpm_priv</span><span class="p">);</span>
	<span class="n">lpm_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">,</span> <span class="s">&quot; &lt;- %s:%u:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ps3_system_bus_driver</span> <span class="n">ps3_lpm_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">match_id</span> <span class="o">=</span> <span class="n">PS3_MATCH_ID_LPM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ps3-lpm&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ps3_lpm_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">ps3_lpm_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">ps3_lpm_remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ps3_lpm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ps3_system_bus_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3_lpm_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ps3_lpm_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">ps3_system_bus_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3_lpm_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ps3_lpm_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ps3_lpm_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;PS3 Logical Performance Monitor Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Sony Corporation&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="n">PS3_MODULE_ALIAS_LPM</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
