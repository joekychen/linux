<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ps3 › ps3av_cmd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ps3av_cmd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2006 Sony Computer Entertainment Inc.</span>
<span class="cm"> * Copyright 2006, 2007 Sony Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * AV backend support for PS3</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published</span>
<span class="cm"> * by the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;asm/ps3av.h&gt;</span>
<span class="cp">#include &lt;asm/ps3.h&gt;</span>
<span class="cp">#include &lt;asm/ps3gpu.h&gt;</span>

<span class="cp">#include &quot;vuart.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">video_fmt</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">format</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">order</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ps3av_video_fmt_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_VIDEO_FORMAT_ARGB_8BIT</span><span class="p">,</span> <span class="n">PS3AV_CMD_VIDEO_ORDER_RGB</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_VIDEO_FORMAT_ARGB_8BIT</span><span class="p">,</span> <span class="n">PS3AV_CMD_VIDEO_ORDER_BGR</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">cs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">av</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bl</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ps3av_cs_video2av_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_CS_RGB_8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_RGB_8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bl</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_8</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_CS_RGB_10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_RGB_8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bl</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_8</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_CS_RGB_12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_RGB_8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bl</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_8</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_CS_YUV444_8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_YUV444_8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bl</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_8</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_CS_YUV444_10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_YUV444_8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bl</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_10</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_CS_YUV444_12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_YUV444_8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bl</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_10</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_CS_YUV422_8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_YUV422_8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bl</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_10</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_CS_YUV422_10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_YUV422_8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bl</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_10</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_CS_YUV422_12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_YUV422_8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bl</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_12</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_CS_XVYCC_8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_XVYCC_8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bl</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_12</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_CS_XVYCC_10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_XVYCC_8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bl</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_12</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_CS_XVYCC_12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_XVYCC_8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bl</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_CS_12</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ps3av_cs_video2av</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ps3av_cs_video2av_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps3av_cs_video2av_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cs</span> <span class="o">==</span> <span class="n">cs</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ps3av_cs_video2av_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">av</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">PS3AV_CMD_AV_CS_RGB_8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ps3av_cs_video2av_bitlen</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ps3av_cs_video2av_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps3av_cs_video2av_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cs</span> <span class="o">==</span> <span class="n">cs</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ps3av_cs_video2av_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bl</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">PS3AV_CMD_AV_CS_8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">vid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">av</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ps3av_vid_video2av_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_VIDEO_VID_480I</span><span class="p">,</span> <span class="n">PS3AV_CMD_AV_VID_480I</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_VIDEO_VID_480P</span><span class="p">,</span> <span class="n">PS3AV_CMD_AV_VID_480P</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_VIDEO_VID_576I</span><span class="p">,</span> <span class="n">PS3AV_CMD_AV_VID_576I</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_VIDEO_VID_576P</span><span class="p">,</span> <span class="n">PS3AV_CMD_AV_VID_576P</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_VIDEO_VID_1080I_60HZ</span><span class="p">,</span> <span class="n">PS3AV_CMD_AV_VID_1080I_60HZ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_VIDEO_VID_720P_60HZ</span><span class="p">,</span> <span class="n">PS3AV_CMD_AV_VID_720P_60HZ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_VIDEO_VID_1080P_60HZ</span><span class="p">,</span> <span class="n">PS3AV_CMD_AV_VID_1080P_60HZ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_VIDEO_VID_1080I_50HZ</span><span class="p">,</span> <span class="n">PS3AV_CMD_AV_VID_1080I_50HZ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_VIDEO_VID_720P_50HZ</span><span class="p">,</span> <span class="n">PS3AV_CMD_AV_VID_720P_50HZ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_VIDEO_VID_1080P_50HZ</span><span class="p">,</span> <span class="n">PS3AV_CMD_AV_VID_1080P_50HZ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_VIDEO_VID_WXGA</span><span class="p">,</span> <span class="n">PS3AV_CMD_AV_VID_WXGA</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_VIDEO_VID_SXGA</span><span class="p">,</span> <span class="n">PS3AV_CMD_AV_VID_SXGA</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_VIDEO_VID_WUXGA</span><span class="p">,</span> <span class="n">PS3AV_CMD_AV_VID_WUXGA</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ps3av_vid_video2av</span><span class="p">(</span><span class="kt">int</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ps3av_vid_video2av_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps3av_vid_video2av_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vid</span> <span class="o">==</span> <span class="n">vid</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ps3av_vid_video2av_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">av</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">PS3AV_CMD_AV_VID_480P</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3av_hdmi_range</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps3_compare_firmware_version</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* supported */</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3av_cmd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_av_init</span> <span class="n">av_init</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_video_init</span> <span class="n">video_init</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_audio_init</span> <span class="n">audio_init</span><span class="p">;</span>

	<span class="cm">/* video init */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">video_init</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">video_init</span><span class="p">));</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_do_pkt</span><span class="p">(</span><span class="n">PS3AV_CID_VIDEO_INIT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">video_init</span><span class="p">.</span><span class="n">send_hdr</span><span class="p">),</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">video_init</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">video_init</span><span class="p">.</span><span class="n">send_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">video_init</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PS3AV_CID_VIDEO_INIT: failed %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* audio init */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">audio_init</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">audio_init</span><span class="p">));</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_do_pkt</span><span class="p">(</span><span class="n">PS3AV_CID_AUDIO_INIT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">audio_init</span><span class="p">.</span><span class="n">send_hdr</span><span class="p">),</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">audio_init</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">audio_init</span><span class="p">.</span><span class="n">send_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">audio_init</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PS3AV_CID_AUDIO_INIT: failed %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* av init */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av_init</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">av_init</span><span class="p">));</span>
	<span class="n">av_init</span><span class="p">.</span><span class="n">event_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_do_pkt</span><span class="p">(</span><span class="n">PS3AV_CID_AV_INIT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">av_init</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">av_init</span><span class="p">),</span>
			   <span class="o">&amp;</span><span class="n">av_init</span><span class="p">.</span><span class="n">send_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av_init</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PS3AV_CID_AV_INIT: failed %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3av_cmd_fin</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_av_fin</span> <span class="n">av_fin</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av_fin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">av_fin</span><span class="p">));</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_do_pkt</span><span class="p">(</span><span class="n">PS3AV_CID_AV_FIN</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">av_fin</span><span class="p">.</span><span class="n">send_hdr</span><span class="p">),</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">av_fin</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">av_fin</span><span class="p">.</span><span class="n">send_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av_fin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PS3AV_CID_AV_FIN: failed %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3av_cmd_av_video_mute</span><span class="p">(</span><span class="kt">int</span> <span class="n">num_of_port</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">send_len</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_av_video_mute</span> <span class="n">av_video_mute</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_of_port</span> <span class="o">&gt;</span> <span class="n">PS3AV_MUTE_PORT_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av_video_mute</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">av_video_mute</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_of_port</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">av_video_mute</span><span class="p">.</span><span class="n">mute</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">avport</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">av_video_mute</span><span class="p">.</span><span class="n">mute</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mute</span> <span class="o">=</span> <span class="n">mute</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">send_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">av_video_mute</span><span class="p">.</span><span class="n">send_hdr</span><span class="p">)</span> <span class="o">+</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3av_av_mute</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_of_port</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_do_pkt</span><span class="p">(</span><span class="n">PS3AV_CID_AV_VIDEO_MUTE</span><span class="p">,</span> <span class="n">send_len</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">av_video_mute</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">av_video_mute</span><span class="p">.</span><span class="n">send_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av_video_mute</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PS3AV_CID_AV_VIDEO_MUTE: failed %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3av_cmd_av_video_disable_sig</span><span class="p">(</span><span class="n">u32</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_av_video_disable_sig</span> <span class="n">av_video_sig</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av_video_sig</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">av_video_sig</span><span class="p">));</span>
	<span class="n">av_video_sig</span><span class="p">.</span><span class="n">avport</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_do_pkt</span><span class="p">(</span><span class="n">PS3AV_CID_AV_VIDEO_DISABLE_SIG</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">av_video_sig</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">av_video_sig</span><span class="p">),</span>
			   <span class="o">&amp;</span><span class="n">av_video_sig</span><span class="p">.</span><span class="n">send_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av_video_sig</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;PS3AV_CID_AV_VIDEO_DISABLE_SIG: failed %x port:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">res</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3av_cmd_av_tv_mute</span><span class="p">(</span><span class="n">u32</span> <span class="n">avport</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_av_tv_mute</span> <span class="n">tv_mute</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv_mute</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tv_mute</span><span class="p">));</span>
	<span class="n">tv_mute</span><span class="p">.</span><span class="n">avport</span> <span class="o">=</span> <span class="n">avport</span><span class="p">;</span>
	<span class="n">tv_mute</span><span class="p">.</span><span class="n">mute</span> <span class="o">=</span> <span class="n">mute</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_do_pkt</span><span class="p">(</span><span class="n">PS3AV_CID_AV_TV_MUTE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tv_mute</span><span class="p">),</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">tv_mute</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tv_mute</span><span class="p">.</span><span class="n">send_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv_mute</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PS3AV_CID_AV_TV_MUTE: failed %x port:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">res</span><span class="p">,</span> <span class="n">avport</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3av_cmd_enable_event</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_av_event</span> <span class="n">av_event</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av_event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">av_event</span><span class="p">));</span>
	<span class="n">av_event</span><span class="p">.</span><span class="n">event_bit</span> <span class="o">=</span> <span class="n">PS3AV_CMD_EVENT_BIT_UNPLUGGED</span> <span class="o">|</span>
	    <span class="n">PS3AV_CMD_EVENT_BIT_PLUGGED</span> <span class="o">|</span> <span class="n">PS3AV_CMD_EVENT_BIT_HDCP_DONE</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_do_pkt</span><span class="p">(</span><span class="n">PS3AV_CID_AV_ENABLE_EVENT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">av_event</span><span class="p">),</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">av_event</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">av_event</span><span class="p">.</span><span class="n">send_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av_event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PS3AV_CID_AV_ENABLE_EVENT: failed %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3av_cmd_av_hdmi_mode</span><span class="p">(</span><span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_av_hdmi_mode</span> <span class="n">hdmi_mode</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdmi_mode</span><span class="p">));</span>
	<span class="n">hdmi_mode</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_do_pkt</span><span class="p">(</span><span class="n">PS3AV_CID_AV_HDMI_MODE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdmi_mode</span><span class="p">),</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">hdmi_mode</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">hdmi_mode</span><span class="p">.</span><span class="n">send_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">res</span> <span class="o">!=</span> <span class="n">PS3AV_STATUS_UNSUPPORTED_HDMI_MODE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PS3AV_CID_AV_HDMI_MODE: failed %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">ps3av_cmd_set_av_video_cs</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">avport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">video_vid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cs_out</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">aspect</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_av_video_cs</span> <span class="o">*</span><span class="n">av_video_cs</span><span class="p">;</span>

	<span class="n">av_video_cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ps3av_pkt_av_video_cs</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">video_vid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">video_vid</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_VID_720P_60HZ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs_out</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">cs_out</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_CS_YUV444_8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aspect</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">aspect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">av_video_cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">av_video_cs</span><span class="p">));</span>
	<span class="n">ps3av_set_hdr</span><span class="p">(</span><span class="n">PS3AV_CID_AV_VIDEO_CS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">av_video_cs</span><span class="p">),</span>
		      <span class="o">&amp;</span><span class="n">av_video_cs</span><span class="o">-&gt;</span><span class="n">send_hdr</span><span class="p">);</span>
	<span class="n">av_video_cs</span><span class="o">-&gt;</span><span class="n">avport</span> <span class="o">=</span> <span class="n">avport</span><span class="p">;</span>
	<span class="cm">/* should be same as video_mode.resolution */</span>
	<span class="n">av_video_cs</span><span class="o">-&gt;</span><span class="n">av_vid</span> <span class="o">=</span> <span class="n">ps3av_vid_video2av</span><span class="p">(</span><span class="n">video_vid</span><span class="p">);</span>
	<span class="n">av_video_cs</span><span class="o">-&gt;</span><span class="n">av_cs_out</span> <span class="o">=</span> <span class="n">ps3av_cs_video2av</span><span class="p">(</span><span class="n">cs_out</span><span class="p">);</span>
	<span class="cm">/* should be same as video_mode.video_cs_out */</span>
	<span class="n">av_video_cs</span><span class="o">-&gt;</span><span class="n">av_cs_in</span> <span class="o">=</span> <span class="n">ps3av_cs_video2av</span><span class="p">(</span><span class="n">PS3AV_CMD_VIDEO_CS_RGB_8</span><span class="p">);</span>
	<span class="n">av_video_cs</span><span class="o">-&gt;</span><span class="n">bitlen_out</span> <span class="o">=</span> <span class="n">ps3av_cs_video2av_bitlen</span><span class="p">(</span><span class="n">cs_out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">PS3AV_MODE_WHITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ps3av_hdmi_range</span><span class="p">())</span>
		<span class="n">av_video_cs</span><span class="o">-&gt;</span><span class="n">super_white</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_SUPER_WHITE_ON</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* default off */</span>
		<span class="n">av_video_cs</span><span class="o">-&gt;</span><span class="n">super_white</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_SUPER_WHITE_OFF</span><span class="p">;</span>
	<span class="n">av_video_cs</span><span class="o">-&gt;</span><span class="n">aspect</span> <span class="o">=</span> <span class="n">aspect</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">PS3AV_MODE_DITHER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">av_video_cs</span><span class="o">-&gt;</span><span class="n">dither</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_DITHER_ON</span>
		    <span class="o">|</span> <span class="n">PS3AV_CMD_AV_DITHER_8BIT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* default off */</span>
		<span class="n">av_video_cs</span><span class="o">-&gt;</span><span class="n">dither</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_DITHER_OFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">av_video_cs</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">ps3av_cmd_set_video_mode</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">head</span><span class="p">,</span> <span class="kt">int</span> <span class="n">video_vid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">video_fmt</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_video_mode</span> <span class="o">*</span><span class="n">video_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>

	<span class="n">video_mode</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ps3av_pkt_video_mode</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">video_vid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">video_vid</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_VID_720P_60HZ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">video_fmt</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">video_fmt</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_FMT_X8R8G8B8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps3av_video_mode2res</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* video mode */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">video_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">video_mode</span><span class="p">));</span>
	<span class="n">ps3av_set_hdr</span><span class="p">(</span><span class="n">PS3AV_CID_VIDEO_MODE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">video_mode</span><span class="p">),</span>
		      <span class="o">&amp;</span><span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">send_hdr</span><span class="p">);</span>
	<span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">video_head</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">video_vid</span> <span class="o">==</span> <span class="n">PS3AV_CMD_VIDEO_VID_480I</span>
	    <span class="o">&amp;&amp;</span> <span class="n">head</span> <span class="o">==</span> <span class="n">PS3AV_CMD_VIDEO_HEAD_B</span><span class="p">)</span>
		<span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">video_vid</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_VID_480I_A</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">video_vid</span> <span class="o">=</span> <span class="n">video_vid</span><span class="p">;</span>
	<span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">y</span><span class="p">;</span>
	<span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* line_length */</span>
	<span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">video_out_format</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_OUT_FORMAT_RGB_12BIT</span><span class="p">;</span>
	<span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">video_format</span> <span class="o">=</span> <span class="n">ps3av_video_fmt_table</span><span class="p">[</span><span class="n">video_fmt</span><span class="p">].</span><span class="n">format</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">PS3AV_MODE_COLOR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ps3av_hdmi_range</span><span class="p">())</span>
		<span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">video_cl_cnv</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_CL_CNV_DISABLE_LUT</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* default enable */</span>
		<span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">video_cl_cnv</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_CL_CNV_ENABLE_LUT</span><span class="p">;</span>
	<span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">video_order</span> <span class="o">=</span> <span class="n">ps3av_video_fmt_table</span><span class="p">[</span><span class="n">video_fmt</span><span class="p">].</span><span class="n">order</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: video_mode:vid:%x width:%d height:%d pitch:%d out_format:%d format:%x order:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">video_vid</span><span class="p">,</span> <span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
		<span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">pitch</span><span class="p">,</span> <span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">video_out_format</span><span class="p">,</span>
		<span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">video_format</span><span class="p">,</span> <span class="n">video_mode</span><span class="o">-&gt;</span><span class="n">video_order</span><span class="p">);</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">video_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3av_cmd_video_format_black</span><span class="p">(</span><span class="n">u32</span> <span class="n">head</span><span class="p">,</span> <span class="n">u32</span> <span class="n">video_fmt</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_video_format</span> <span class="n">video_format</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">video_format</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">video_format</span><span class="p">));</span>
	<span class="n">video_format</span><span class="p">.</span><span class="n">video_head</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mute</span> <span class="o">!=</span> <span class="n">PS3AV_CMD_MUTE_OFF</span><span class="p">)</span>
		<span class="n">video_format</span><span class="p">.</span><span class="n">video_format</span> <span class="o">=</span> <span class="n">PS3AV_CMD_VIDEO_FORMAT_BLACK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">video_format</span><span class="p">.</span><span class="n">video_format</span> <span class="o">=</span>
		    <span class="n">ps3av_video_fmt_table</span><span class="p">[</span><span class="n">video_fmt</span><span class="p">].</span><span class="n">format</span><span class="p">;</span>
	<span class="n">video_format</span><span class="p">.</span><span class="n">video_order</span> <span class="o">=</span> <span class="n">ps3av_video_fmt_table</span><span class="p">[</span><span class="n">video_fmt</span><span class="p">].</span><span class="n">order</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_do_pkt</span><span class="p">(</span><span class="n">PS3AV_CID_VIDEO_FORMAT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">video_format</span><span class="p">),</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">video_format</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">video_format</span><span class="p">.</span><span class="n">send_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">video_format</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PS3AV_CID_VIDEO_FORMAT: failed %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">ps3av_cmd_av_audio_mute</span><span class="p">(</span><span class="kt">int</span> <span class="n">num_of_port</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_av_audio_mute</span> <span class="n">av_audio_mute</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_of_port</span> <span class="o">&gt;</span> <span class="n">PS3AV_MUTE_PORT_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* audio mute */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av_audio_mute</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">av_audio_mute</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_of_port</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">av_audio_mute</span><span class="p">.</span><span class="n">mute</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">avport</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">av_audio_mute</span><span class="p">.</span><span class="n">mute</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mute</span> <span class="o">=</span> <span class="n">mute</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_do_pkt</span><span class="p">(</span><span class="n">PS3AV_CID_AV_AUDIO_MUTE</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">av_audio_mute</span><span class="p">.</span><span class="n">send_hdr</span><span class="p">)</span> <span class="o">+</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3av_av_mute</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_of_port</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">av_audio_mute</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">av_audio_mute</span><span class="p">.</span><span class="n">send_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av_audio_mute</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PS3AV_CID_AV_AUDIO_MUTE: failed %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">fs</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mclk</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ps3av_cnv_mclk_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_AUDIO_FS_44K</span><span class="p">,</span> <span class="n">PS3AV_CMD_AV_MCLK_512</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_AUDIO_FS_48K</span><span class="p">,</span> <span class="n">PS3AV_CMD_AV_MCLK_512</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_AUDIO_FS_88K</span><span class="p">,</span> <span class="n">PS3AV_CMD_AV_MCLK_256</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_AUDIO_FS_96K</span><span class="p">,</span> <span class="n">PS3AV_CMD_AV_MCLK_256</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_AUDIO_FS_176K</span><span class="p">,</span> <span class="n">PS3AV_CMD_AV_MCLK_128</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PS3AV_CMD_AUDIO_FS_192K</span><span class="p">,</span> <span class="n">PS3AV_CMD_AV_MCLK_128</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ps3av_cnv_mclk</span><span class="p">(</span><span class="n">u32</span> <span class="n">fs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ps3av_cnv_mclk_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps3av_cnv_mclk_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fs</span> <span class="o">==</span> <span class="n">fs</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ps3av_cnv_mclk_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mclk</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s failed, fs:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fs</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define BASE	PS3AV_CMD_AUDIO_FS_44K</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">ps3av_ns_table</span><span class="p">[][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
					<span class="cm">/*   D1,    D2,    D3,    D4,    D5 */</span>
	<span class="p">[</span><span class="n">PS3AV_CMD_AUDIO_FS_44K</span><span class="o">-</span><span class="n">BASE</span><span class="p">]</span> <span class="o">=</span>	<span class="p">{</span>  <span class="mi">6272</span><span class="p">,</span>  <span class="mi">6272</span><span class="p">,</span> <span class="mi">17836</span><span class="p">,</span> <span class="mi">17836</span><span class="p">,</span>  <span class="mi">8918</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PS3AV_CMD_AUDIO_FS_48K</span><span class="o">-</span><span class="n">BASE</span><span class="p">]</span> <span class="o">=</span>	<span class="p">{</span>  <span class="mi">6144</span><span class="p">,</span>  <span class="mi">6144</span><span class="p">,</span> <span class="mi">11648</span><span class="p">,</span> <span class="mi">11648</span><span class="p">,</span>  <span class="mi">5824</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PS3AV_CMD_AUDIO_FS_88K</span><span class="o">-</span><span class="n">BASE</span><span class="p">]</span> <span class="o">=</span>	<span class="p">{</span> <span class="mi">12544</span><span class="p">,</span> <span class="mi">12544</span><span class="p">,</span> <span class="mi">35672</span><span class="p">,</span> <span class="mi">35672</span><span class="p">,</span> <span class="mi">17836</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PS3AV_CMD_AUDIO_FS_96K</span><span class="o">-</span><span class="n">BASE</span><span class="p">]</span> <span class="o">=</span>	<span class="p">{</span> <span class="mi">12288</span><span class="p">,</span> <span class="mi">12288</span><span class="p">,</span> <span class="mi">23296</span><span class="p">,</span> <span class="mi">23296</span><span class="p">,</span> <span class="mi">11648</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PS3AV_CMD_AUDIO_FS_176K</span><span class="o">-</span><span class="n">BASE</span><span class="p">]</span> <span class="o">=</span>	<span class="p">{</span> <span class="mi">25088</span><span class="p">,</span> <span class="mi">25088</span><span class="p">,</span> <span class="mi">71344</span><span class="p">,</span> <span class="mi">71344</span><span class="p">,</span> <span class="mi">35672</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PS3AV_CMD_AUDIO_FS_192K</span><span class="o">-</span><span class="n">BASE</span><span class="p">]</span> <span class="o">=</span>	<span class="p">{</span> <span class="mi">24576</span><span class="p">,</span> <span class="mi">24576</span><span class="p">,</span> <span class="mi">46592</span><span class="p">,</span> <span class="mi">46592</span><span class="p">,</span> <span class="mi">23296</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ps3av_cnv_ns</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="n">u32</span> <span class="n">fs</span><span class="p">,</span> <span class="n">u32</span> <span class="n">video_vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">av_vid</span><span class="p">,</span> <span class="n">ns_val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">d</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">ns_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">av_vid</span> <span class="o">=</span> <span class="n">ps3av_vid_video2av</span><span class="p">(</span><span class="n">video_vid</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">av_vid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PS3AV_CMD_AV_VID_480I</span>:
	<span class="k">case</span> <span class="n">PS3AV_CMD_AV_VID_576I</span>:
		<span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PS3AV_CMD_AV_VID_480P</span>:
	<span class="k">case</span> <span class="n">PS3AV_CMD_AV_VID_576P</span>:
		<span class="n">d</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PS3AV_CMD_AV_VID_1080I_60HZ</span>:
	<span class="k">case</span> <span class="n">PS3AV_CMD_AV_VID_1080I_50HZ</span>:
		<span class="n">d</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PS3AV_CMD_AV_VID_720P_60HZ</span>:
	<span class="k">case</span> <span class="n">PS3AV_CMD_AV_VID_720P_50HZ</span>:
		<span class="n">d</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PS3AV_CMD_AV_VID_1080P_60HZ</span>:
	<span class="k">case</span> <span class="n">PS3AV_CMD_AV_VID_1080P_50HZ</span>:
	<span class="k">case</span> <span class="n">PS3AV_CMD_AV_VID_WXGA</span>:
	<span class="k">case</span> <span class="n">PS3AV_CMD_AV_VID_SXGA</span>:
	<span class="k">case</span> <span class="n">PS3AV_CMD_AV_VID_WUXGA</span>:
		<span class="n">d</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s failed, vid:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">video_vid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fs</span> <span class="o">&lt;</span> <span class="n">PS3AV_CMD_AUDIO_FS_44K</span> <span class="o">||</span> <span class="n">fs</span> <span class="o">&gt;</span> <span class="n">PS3AV_CMD_AUDIO_FS_192K</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s failed, fs:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fs</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ns_val</span> <span class="o">=</span> <span class="n">ps3av_ns_table</span><span class="p">[</span><span class="n">PS3AV_CMD_AUDIO_FS_44K</span><span class="o">-</span><span class="n">BASE</span><span class="p">][</span><span class="n">d</span><span class="p">];</span>

	<span class="o">*</span><span class="n">ns</span><span class="o">++</span> <span class="o">=</span> <span class="n">ns_val</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ns</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">ns_val</span> <span class="o">&amp;</span> <span class="mh">0x0000FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="p">(</span><span class="n">ns_val</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#undef BASE</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ps3av_cnv_enable</span><span class="p">(</span><span class="n">u32</span> <span class="n">source</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">==</span> <span class="n">PS3AV_CMD_AUDIO_SOURCE_SPDIF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">==</span> <span class="n">PS3AV_CMD_AUDIO_SOURCE_SERIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">((</span><span class="n">enable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">enable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">enable</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span>
		       <span class="p">(</span><span class="n">enable</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s failed, source:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ps3av_cnv_fifomap</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">map</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">map</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">map</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ps3av_cnv_inputlen</span><span class="p">(</span><span class="n">u32</span> <span class="n">word_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">word_bits</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PS3AV_CMD_AUDIO_WORD_BITS_16</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_INPUTLEN_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PS3AV_CMD_AUDIO_WORD_BITS_20</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_INPUTLEN_20</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PS3AV_CMD_AUDIO_WORD_BITS_24</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AV_INPUTLEN_24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s failed, word_bits:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">word_bits</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ps3av_cnv_layout</span><span class="p">(</span><span class="n">u32</span> <span class="n">num_of_ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_of_ch</span> <span class="o">&gt;</span> <span class="n">PS3AV_CMD_AUDIO_NUM_OF_CH_8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s failed, num_of_ch:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">num_of_ch</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">num_of_ch</span> <span class="o">==</span> <span class="n">PS3AV_CMD_AUDIO_NUM_OF_CH_2</span> <span class="o">?</span> <span class="mh">0x0</span> <span class="o">:</span> <span class="mh">0x1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ps3av_cnv_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3av_audio_info_frame</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">ps3av_pkt_audio_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pb1</span><span class="p">.</span><span class="n">cc</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">audio_num_of_ch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* CH2:0x01 --- CH8:0x07 */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pb1</span><span class="p">.</span><span class="n">ct</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pb2</span><span class="p">.</span><span class="n">sf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pb2</span><span class="p">.</span><span class="n">ss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pb3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* check mode-&gt;audio_format ?? */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pb4</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">audio_layout</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pb5</span><span class="p">.</span><span class="n">dm</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">audio_downmix</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pb5</span><span class="p">.</span><span class="n">lsv</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">audio_downmix_level</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ps3av_cnv_chstat</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">chstat</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cs_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">chstat</span><span class="p">,</span> <span class="n">cs_info</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">ps3av_cmd_set_av_audio_param</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">port</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">ps3av_pkt_audio_mode</span> <span class="o">*</span><span class="n">audio_mode</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">video_vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_av_audio_param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>

	<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ps3av_pkt_av_audio_param</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">));</span>
	<span class="n">ps3av_set_hdr</span><span class="p">(</span><span class="n">PS3AV_CID_AV_AUDIO_PARAM</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">),</span>
		      <span class="o">&amp;</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">send_hdr</span><span class="p">);</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">avport</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">=</span> <span class="n">ps3av_cnv_mclk</span><span class="p">(</span><span class="n">audio_mode</span><span class="o">-&gt;</span><span class="n">audio_fs</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">ps3av_cnv_ns</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">ns</span><span class="p">,</span> <span class="n">audio_mode</span><span class="o">-&gt;</span><span class="n">audio_fs</span><span class="p">,</span> <span class="n">video_vid</span><span class="p">);</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">ps3av_cnv_enable</span><span class="p">(</span><span class="n">audio_mode</span><span class="o">-&gt;</span><span class="n">audio_source</span><span class="p">,</span>
					 <span class="n">audio_mode</span><span class="o">-&gt;</span><span class="n">audio_enable</span><span class="p">);</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">swaplr</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">fifomap</span> <span class="o">=</span> <span class="n">ps3av_cnv_fifomap</span><span class="p">(</span><span class="n">audio_mode</span><span class="o">-&gt;</span><span class="n">audio_map</span><span class="p">);</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">inputctrl</span> <span class="o">=</span> <span class="mh">0x49</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">inputlen</span> <span class="o">=</span> <span class="n">ps3av_cnv_inputlen</span><span class="p">(</span><span class="n">audio_mode</span><span class="o">-&gt;</span><span class="n">audio_word_bits</span><span class="p">);</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">layout</span> <span class="o">=</span> <span class="n">ps3av_cnv_layout</span><span class="p">(</span><span class="n">audio_mode</span><span class="o">-&gt;</span><span class="n">audio_num_of_ch</span><span class="p">);</span>
	<span class="n">ps3av_cnv_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span> <span class="n">audio_mode</span><span class="p">);</span>
	<span class="n">ps3av_cnv_chstat</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">chstat</span><span class="p">,</span> <span class="n">audio_mode</span><span class="o">-&gt;</span><span class="n">audio_cs_info</span><span class="p">);</span>

	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* default cs val */</span>
<span class="n">u8</span> <span class="n">ps3av_mode_cs_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3av_mode_cs_info</span><span class="p">);</span>

<span class="cp">#define CS_44	0x00</span>
<span class="cp">#define CS_48	0x02</span>
<span class="cp">#define CS_88	0x08</span>
<span class="cp">#define CS_96	0x0a</span>
<span class="cp">#define CS_176	0x0c</span>
<span class="cp">#define CS_192	0x0e</span>
<span class="cp">#define CS_MASK	0x0f</span>
<span class="cp">#define CS_BIT	0x40</span>

<span class="kt">void</span> <span class="nf">ps3av_cmd_set_audio_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3av_pkt_audio_mode</span> <span class="o">*</span><span class="n">audio</span><span class="p">,</span> <span class="n">u32</span> <span class="n">avport</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">ch</span><span class="p">,</span> <span class="n">u32</span> <span class="n">fs</span><span class="p">,</span> <span class="n">u32</span> <span class="n">word_bits</span><span class="p">,</span> <span class="n">u32</span> <span class="n">format</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">spdif_through</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span> <span class="o">|</span> <span class="n">fs</span> <span class="o">|</span> <span class="n">format</span> <span class="o">|</span> <span class="n">word_bits</span> <span class="o">|</span> <span class="n">source</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AUDIO_NUM_OF_CH_2</span><span class="p">;</span>
		<span class="n">fs</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AUDIO_FS_48K</span><span class="p">;</span>
		<span class="n">word_bits</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AUDIO_WORD_BITS_16</span><span class="p">;</span>
		<span class="n">format</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AUDIO_FORMAT_PCM</span><span class="p">;</span>
		<span class="n">source</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AUDIO_SOURCE_SERIAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* audio mode */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">audio</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">audio</span><span class="p">));</span>
	<span class="n">ps3av_set_hdr</span><span class="p">(</span><span class="n">PS3AV_CID_AUDIO_MODE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">audio</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">audio</span><span class="o">-&gt;</span><span class="n">send_hdr</span><span class="p">);</span>

	<span class="n">audio</span><span class="o">-&gt;</span><span class="n">avport</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">avport</span><span class="p">;</span>
	<span class="n">audio</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="mh">0x0FFF</span><span class="p">;</span>	<span class="cm">/* XXX set all */</span>
	<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_num_of_ch</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_fs</span> <span class="o">=</span> <span class="n">fs</span><span class="p">;</span>
	<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_word_bits</span> <span class="o">=</span> <span class="n">word_bits</span><span class="p">;</span>
	<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
	<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_source</span> <span class="o">=</span> <span class="n">source</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PS3AV_CMD_AUDIO_NUM_OF_CH_8</span>:
		<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_enable</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">PS3AV_CMD_AUDIO_NUM_OF_CH_6</span>:
		<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_enable</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_enable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">PS3AV_CMD_AUDIO_NUM_OF_CH_2</span>:
	<span class="nl">default:</span>
		<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_enable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* audio swap L/R */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_swap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AUDIO_SWAP_0</span><span class="p">;</span>	<span class="cm">/* no swap */</span>

	<span class="cm">/* audio serial input mapping */</span>
	<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AUDIO_MAP_OUTPUT_0</span><span class="p">;</span>
	<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_map</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AUDIO_MAP_OUTPUT_1</span><span class="p">;</span>
	<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_map</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AUDIO_MAP_OUTPUT_2</span><span class="p">;</span>
	<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_map</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AUDIO_MAP_OUTPUT_3</span><span class="p">;</span>

	<span class="cm">/* audio speaker layout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">avport</span> <span class="o">==</span> <span class="n">PS3AV_CMD_AVPORT_HDMI_0</span> <span class="o">||</span>
	    <span class="n">avport</span> <span class="o">==</span> <span class="n">PS3AV_CMD_AVPORT_HDMI_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PS3AV_CMD_AUDIO_NUM_OF_CH_8</span>:
			<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_layout</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AUDIO_LAYOUT_8CH</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PS3AV_CMD_AUDIO_NUM_OF_CH_6</span>:
			<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_layout</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AUDIO_LAYOUT_6CH</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PS3AV_CMD_AUDIO_NUM_OF_CH_2</span>:
		<span class="nl">default:</span>
			<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_layout</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AUDIO_LAYOUT_2CH</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_layout</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AUDIO_LAYOUT_2CH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* audio downmix permission */</span>
	<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_downmix</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AUDIO_DOWNMIX_PERMITTED</span><span class="p">;</span>
	<span class="cm">/* audio downmix level shift (0:0dB to 15:15dB) */</span>
	<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_downmix_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* 0dB */</span>

	<span class="cm">/* set ch status */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_cs_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ps3av_mode_cs_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fs</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PS3AV_CMD_AUDIO_FS_44K</span>:
		<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_cs_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CS_MASK</span><span class="p">;</span>
		<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_cs_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CS_44</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PS3AV_CMD_AUDIO_FS_88K</span>:
		<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_cs_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CS_MASK</span><span class="p">;</span>
		<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_cs_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CS_88</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PS3AV_CMD_AUDIO_FS_96K</span>:
		<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_cs_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CS_MASK</span><span class="p">;</span>
		<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_cs_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CS_96</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PS3AV_CMD_AUDIO_FS_176K</span>:
		<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_cs_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CS_MASK</span><span class="p">;</span>
		<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_cs_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CS_176</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PS3AV_CMD_AUDIO_FS_192K</span>:
		<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_cs_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CS_MASK</span><span class="p">;</span>
		<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_cs_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CS_192</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* non-audio bit */</span>
	<span class="n">spdif_through</span> <span class="o">=</span> <span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_cs_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">;</span>

	<span class="cm">/* pass through setting */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spdif_through</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">avport</span> <span class="o">==</span> <span class="n">PS3AV_CMD_AVPORT_SPDIF_0</span> <span class="o">||</span>
	     <span class="n">avport</span> <span class="o">==</span> <span class="n">PS3AV_CMD_AVPORT_SPDIF_1</span> <span class="o">||</span>
	     <span class="n">avport</span> <span class="o">==</span> <span class="n">PS3AV_CMD_AVPORT_HDMI_0</span> <span class="o">||</span>
	     <span class="n">avport</span> <span class="o">==</span> <span class="n">PS3AV_CMD_AVPORT_HDMI_1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_word_bits</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AUDIO_WORD_BITS_16</span><span class="p">;</span>
		<span class="n">audio</span><span class="o">-&gt;</span><span class="n">audio_format</span> <span class="o">=</span> <span class="n">PS3AV_CMD_AUDIO_FORMAT_BITSTREAM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3av_cmd_audio_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3av_pkt_audio_mode</span> <span class="o">*</span><span class="n">audio_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_do_pkt</span><span class="p">(</span><span class="n">PS3AV_CID_AUDIO_MODE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">audio_mode</span><span class="p">),</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">audio_mode</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">audio_mode</span><span class="o">-&gt;</span><span class="n">send_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="n">audio_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PS3AV_CID_AUDIO_MODE: failed %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3av_cmd_audio_mute</span><span class="p">(</span><span class="kt">int</span> <span class="n">num_of_port</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_audio_mute</span> <span class="n">audio_mute</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_of_port</span> <span class="o">&gt;</span> <span class="n">PS3AV_OPT_PORT_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* audio mute */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">audio_mute</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">audio_mute</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_of_port</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">audio_mute</span><span class="p">.</span><span class="n">mute</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">avport</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">audio_mute</span><span class="p">.</span><span class="n">mute</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mute</span> <span class="o">=</span> <span class="n">mute</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_do_pkt</span><span class="p">(</span><span class="n">PS3AV_CID_AUDIO_MUTE</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">audio_mute</span><span class="p">.</span><span class="n">send_hdr</span><span class="p">)</span> <span class="o">+</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3av_audio_mute</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_of_port</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">audio_mute</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">audio_mute</span><span class="p">.</span><span class="n">send_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">audio_mute</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PS3AV_CID_AUDIO_MUTE: failed %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3av_cmd_audio_active</span><span class="p">(</span><span class="kt">int</span> <span class="n">active</span><span class="p">,</span> <span class="n">u32</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3av_pkt_audio_active</span> <span class="n">audio_active</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cid</span><span class="p">;</span>

	<span class="cm">/* audio active */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">audio_active</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">audio_active</span><span class="p">));</span>
	<span class="n">audio_active</span><span class="p">.</span><span class="n">audio_port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">cid</span> <span class="o">=</span> <span class="n">active</span> <span class="o">?</span> <span class="n">PS3AV_CID_AUDIO_ACTIVE</span> <span class="o">:</span> <span class="n">PS3AV_CID_AUDIO_INACTIVE</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_do_pkt</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">audio_active</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">audio_active</span><span class="p">),</span>
			   <span class="o">&amp;</span><span class="n">audio_active</span><span class="p">.</span><span class="n">send_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">audio_active</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PS3AV_CID_AUDIO_ACTIVE:%x failed %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span>
		       <span class="n">res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3av_cmd_avb_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3av_pkt_avb_param</span> <span class="o">*</span><span class="n">avb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">send_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3_gpu_mutex</span><span class="p">);</span>

	<span class="cm">/* avb packet */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_do_pkt</span><span class="p">(</span><span class="n">PS3AV_CID_AVB_PARAM</span><span class="p">,</span> <span class="n">send_len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">avb</span><span class="p">),</span>
			   <span class="o">&amp;</span><span class="n">avb</span><span class="o">-&gt;</span><span class="n">send_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="n">avb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: PS3AV_CID_AVB_PARAM: failed %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			 <span class="n">res</span><span class="p">);</span>

      <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps3_gpu_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3av_cmd_av_get_hw_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3av_pkt_av_get_hw_conf</span> <span class="o">*</span><span class="n">hw_conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">hw_conf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hw_conf</span><span class="p">));</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_do_pkt</span><span class="p">(</span><span class="n">PS3AV_CID_AV_GET_HW_CONF</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hw_conf</span><span class="o">-&gt;</span><span class="n">send_hdr</span><span class="p">),</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hw_conf</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">hw_conf</span><span class="o">-&gt;</span><span class="n">send_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="n">hw_conf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PS3AV_CID_AV_GET_HW_CONF: failed %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3av_cmd_video_get_monitor_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3av_pkt_av_get_monitor_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">avport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">avport</span> <span class="o">=</span> <span class="n">avport</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ps3av_do_pkt</span><span class="p">(</span><span class="n">PS3AV_CID_AV_GET_MONITOR_INFO</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">send_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">avport</span><span class="p">)</span> <span class="o">+</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">),</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">send_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PS3AV_CID_AV_GET_MONITOR_INFO: failed %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PS3AV_AV_LAYOUT_0 (PS3AV_CMD_AV_LAYOUT_32 \</span>
<span class="cp">		| PS3AV_CMD_AV_LAYOUT_44 \</span>
<span class="cp">		| PS3AV_CMD_AV_LAYOUT_48)</span>

<span class="cp">#define PS3AV_AV_LAYOUT_1 (PS3AV_AV_LAYOUT_0 \</span>
<span class="cp">		| PS3AV_CMD_AV_LAYOUT_88 \</span>
<span class="cp">		| PS3AV_CMD_AV_LAYOUT_96 \</span>
<span class="cp">		| PS3AV_CMD_AV_LAYOUT_176 \</span>
<span class="cp">		| PS3AV_CMD_AV_LAYOUT_192)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
