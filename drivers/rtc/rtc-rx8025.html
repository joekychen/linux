<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › rtc › rtc-rx8025.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>rtc-rx8025.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for Epson&#39;s RTC module RX-8025 SA/NB</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Wolfgang Grandegger &lt;wg@grandegger.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005 by Digi International Inc.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Modified by fengjh at rising.com.cn</span>
<span class="cm"> * &lt;http://lists.lm-sensors.org/mailman/listinfo/lm-sensors&gt;</span>
<span class="cm"> * 2006.11</span>
<span class="cm"> *</span>
<span class="cm"> * Code cleanup by Sergei Poselenov, &lt;sposelenov@emcraft.com&gt;</span>
<span class="cm"> * Converted to new style by Wolfgang Grandegger &lt;wg@grandegger.com&gt;</span>
<span class="cm"> * Alarm and periodic interrupt added by Dmitry Rakhchev &lt;rda@emcraft.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * version 2 as published by the Free Software Foundation.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bcd.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/rtc.h&gt;</span>

<span class="cm">/* Register definitions */</span>
<span class="cp">#define RX8025_REG_SEC		0x00</span>
<span class="cp">#define RX8025_REG_MIN		0x01</span>
<span class="cp">#define RX8025_REG_HOUR		0x02</span>
<span class="cp">#define RX8025_REG_WDAY		0x03</span>
<span class="cp">#define RX8025_REG_MDAY		0x04</span>
<span class="cp">#define RX8025_REG_MONTH	0x05</span>
<span class="cp">#define RX8025_REG_YEAR		0x06</span>
<span class="cp">#define RX8025_REG_DIGOFF	0x07</span>
<span class="cp">#define RX8025_REG_ALWMIN	0x08</span>
<span class="cp">#define RX8025_REG_ALWHOUR	0x09</span>
<span class="cp">#define RX8025_REG_ALWWDAY	0x0a</span>
<span class="cp">#define RX8025_REG_ALDMIN	0x0b</span>
<span class="cp">#define RX8025_REG_ALDHOUR	0x0c</span>
<span class="cm">/* 0x0d is reserved */</span>
<span class="cp">#define RX8025_REG_CTRL1	0x0e</span>
<span class="cp">#define RX8025_REG_CTRL2	0x0f</span>

<span class="cp">#define RX8025_BIT_CTRL1_CT	(7 &lt;&lt; 0)</span>
<span class="cm">/* 1 Hz periodic level irq */</span>
<span class="cp">#define RX8025_BIT_CTRL1_CT_1HZ	4</span>
<span class="cp">#define RX8025_BIT_CTRL1_TEST	(1 &lt;&lt; 3)</span>
<span class="cp">#define RX8025_BIT_CTRL1_1224	(1 &lt;&lt; 5)</span>
<span class="cp">#define RX8025_BIT_CTRL1_DALE	(1 &lt;&lt; 6)</span>
<span class="cp">#define RX8025_BIT_CTRL1_WALE	(1 &lt;&lt; 7)</span>

<span class="cp">#define RX8025_BIT_CTRL2_DAFG	(1 &lt;&lt; 0)</span>
<span class="cp">#define RX8025_BIT_CTRL2_WAFG	(1 &lt;&lt; 1)</span>
<span class="cp">#define RX8025_BIT_CTRL2_CTFG	(1 &lt;&lt; 2)</span>
<span class="cp">#define RX8025_BIT_CTRL2_PON	(1 &lt;&lt; 4)</span>
<span class="cp">#define RX8025_BIT_CTRL2_XST	(1 &lt;&lt; 5)</span>
<span class="cp">#define RX8025_BIT_CTRL2_VDET	(1 &lt;&lt; 6)</span>

<span class="cm">/* Clock precision adjustment */</span>
<span class="cp">#define RX8025_ADJ_RESOLUTION	3050 </span><span class="cm">/* in ppb */</span><span class="cp"></span>
<span class="cp">#define RX8025_ADJ_DATA_MAX	62</span>
<span class="cp">#define RX8025_ADJ_DATA_MIN	-62</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">rx8025_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;rx8025&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">rx8025_id</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">rx8025_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctrl1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">exiting</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx8025_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">number</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="p">(</span><span class="n">number</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to read register #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">number</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx8025_read_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">number</span><span class="p">,</span> <span class="n">u8</span> <span class="n">length</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">values</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_i2c_block_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="p">(</span><span class="n">number</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">,</span>
						<span class="n">length</span><span class="p">,</span> <span class="n">values</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to read registers #%d..#%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">number</span><span class="p">,</span> <span class="n">number</span> <span class="o">+</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx8025_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">number</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">number</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to write register #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">number</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx8025_write_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">number</span><span class="p">,</span> <span class="n">u8</span> <span class="n">length</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">values</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_i2c_block_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="p">(</span><span class="n">number</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">,</span>
						 <span class="n">length</span><span class="p">,</span> <span class="n">values</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to write registers #%d..#%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">number</span><span class="p">,</span> <span class="n">number</span> <span class="o">+</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">rx8025_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx8025_data</span> <span class="o">*</span><span class="n">rx8025</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx8025_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx8025_data</span> <span class="o">*</span><span class="n">rx8025</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx8025_data</span><span class="p">,</span>
						  <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="o">*</span><span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx8025_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RX8025_REG_CTRL2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX8025_BIT_CTRL2_XST</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Oscillation stop was detected,&quot;</span>
			 <span class="s">&quot;you may have to readjust the clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX8025_BIT_CTRL2_CTFG</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* periodic */</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RX8025_BIT_CTRL2_CTFG</span><span class="p">;</span>
		<span class="n">local_irq_disable</span><span class="p">();</span>
		<span class="n">rtc_update_irq</span><span class="p">(</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">RTC_PF</span> <span class="o">|</span> <span class="n">RTC_IRQF</span><span class="p">);</span>
		<span class="n">local_irq_enable</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX8025_BIT_CTRL2_DAFG</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* alarm */</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="n">RX8025_BIT_CTRL2_DAFG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx8025_write_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RX8025_REG_CTRL1</span><span class="p">,</span>
				     <span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RX8025_BIT_CTRL1_DALE</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">local_irq_disable</span><span class="p">();</span>
		<span class="n">rtc_update_irq</span><span class="p">(</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">RTC_AF</span> <span class="o">|</span> <span class="n">RTC_IRQF</span><span class="p">);</span>
		<span class="n">local_irq_enable</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* acknowledge IRQ */</span>
	<span class="n">rx8025_write_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RX8025_REG_CTRL2</span><span class="p">,</span>
			 <span class="n">status</span> <span class="o">|</span> <span class="n">RX8025_BIT_CTRL2_XST</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">exiting</span><span class="p">)</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx8025_get_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_time</span> <span class="o">*</span><span class="n">dt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx8025_data</span> <span class="o">*</span><span class="n">rx8025</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">date</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rx8025_read_regs</span><span class="p">(</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">RX8025_REG_SEC</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">date</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: read 0x%02x 0x%02x &quot;</span>
		<span class="s">&quot;0x%02x 0x%02x 0x%02x 0x%02x 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">date</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">date</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">date</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">date</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">date</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
		<span class="n">date</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">date</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>

	<span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_sec</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">date</span><span class="p">[</span><span class="n">RX8025_REG_SEC</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_min</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">date</span><span class="p">[</span><span class="n">RX8025_REG_MIN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">&amp;</span> <span class="n">RX8025_BIT_CTRL1_1224</span><span class="p">)</span>
		<span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_hour</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">date</span><span class="p">[</span><span class="n">RX8025_REG_HOUR</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_hour</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">date</span><span class="p">[</span><span class="n">RX8025_REG_HOUR</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span>
			<span class="o">+</span> <span class="p">(</span><span class="n">date</span><span class="p">[</span><span class="n">RX8025_REG_HOUR</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span> <span class="o">?</span> <span class="mi">12</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_mday</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">date</span><span class="p">[</span><span class="n">RX8025_REG_MDAY</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_mon</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">date</span><span class="p">[</span><span class="n">RX8025_REG_MONTH</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">date</span><span class="p">[</span><span class="n">RX8025_REG_YEAR</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">&lt;</span> <span class="mi">70</span><span class="p">)</span>
		<span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">+=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: date %ds %dm %dh %dmd %dm %dy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_sec</span><span class="p">,</span> <span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_min</span><span class="p">,</span> <span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_hour</span><span class="p">,</span>
		<span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_mday</span><span class="p">,</span> <span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_mon</span><span class="p">,</span> <span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_year</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rtc_valid_tm</span><span class="p">(</span><span class="n">dt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx8025_set_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_time</span> <span class="o">*</span><span class="n">dt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx8025_data</span> <span class="o">*</span><span class="n">rx8025</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">date</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * BUG: The HW assumes every year that is a multiple of 4 to be a leap</span>
<span class="cm">	 * year.  Next time this is wrong is 2100, which will not be a leap</span>
<span class="cm">	 * year.</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Here the read-only bits are written as &quot;0&quot;.  I&#39;m not sure if that</span>
<span class="cm">	 * is sound.</span>
<span class="cm">	 */</span>
	<span class="n">date</span><span class="p">[</span><span class="n">RX8025_REG_SEC</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_sec</span><span class="p">);</span>
	<span class="n">date</span><span class="p">[</span><span class="n">RX8025_REG_MIN</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_min</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">&amp;</span> <span class="n">RX8025_BIT_CTRL1_1224</span><span class="p">)</span>
		<span class="n">date</span><span class="p">[</span><span class="n">RX8025_REG_HOUR</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_hour</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">date</span><span class="p">[</span><span class="n">RX8025_REG_HOUR</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_hour</span> <span class="o">&gt;=</span> <span class="mi">12</span> <span class="o">?</span> <span class="mh">0x20</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">bin2bcd</span><span class="p">((</span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_hour</span> <span class="o">+</span> <span class="mi">11</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">date</span><span class="p">[</span><span class="n">RX8025_REG_WDAY</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_wday</span><span class="p">);</span>
	<span class="n">date</span><span class="p">[</span><span class="n">RX8025_REG_MDAY</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_mday</span><span class="p">);</span>
	<span class="n">date</span><span class="p">[</span><span class="n">RX8025_REG_MONTH</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_mon</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">date</span><span class="p">[</span><span class="n">RX8025_REG_YEAR</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">%</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s: write 0x%02x 0x%02x 0x%02x 0x%02x 0x%02x 0x%02x 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">date</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">date</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">date</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">date</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">date</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">date</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">date</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">rx8025_write_regs</span><span class="p">(</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">RX8025_REG_SEC</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">date</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx8025_init_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">need_reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx8025_data</span> <span class="o">*</span><span class="n">rx8025</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ctrl</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ctrl2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need_clear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rx8025_read_regs</span><span class="p">(</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">RX8025_REG_CTRL1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Keep test bit zero ! */</span>
	<span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RX8025_BIT_CTRL1_TEST</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RX8025_BIT_CTRL2_PON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;power-on reset was detected, &quot;</span>
			 <span class="s">&quot;you may have to readjust the clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">need_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RX8025_BIT_CTRL2_VDET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;a power voltage drop was detected, &quot;</span>
			 <span class="s">&quot;you may have to readjust the clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">need_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RX8025_BIT_CTRL2_XST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Oscillation stop was detected,&quot;</span>
			 <span class="s">&quot;you may have to readjust the clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">need_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RX8025_BIT_CTRL2_DAFG</span> <span class="o">|</span> <span class="n">RX8025_BIT_CTRL2_WAFG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Alarm was detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">need_clear</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RX8025_BIT_CTRL2_CTFG</span><span class="p">))</span>
		<span class="n">need_clear</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">need_reset</span> <span class="o">||</span> <span class="n">need_clear</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrl2</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">ctrl2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RX8025_BIT_CTRL2_PON</span> <span class="o">|</span> <span class="n">RX8025_BIT_CTRL2_VDET</span> <span class="o">|</span>
			   <span class="n">RX8025_BIT_CTRL2_CTFG</span> <span class="o">|</span> <span class="n">RX8025_BIT_CTRL2_WAFG</span> <span class="o">|</span>
			   <span class="n">RX8025_BIT_CTRL2_DAFG</span><span class="p">);</span>
		<span class="n">ctrl2</span> <span class="o">|=</span> <span class="n">RX8025_BIT_CTRL2_XST</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">rx8025_write_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RX8025_REG_CTRL2</span><span class="p">,</span> <span class="n">ctrl2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Alarm support */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx8025_read_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_wkalrm</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx8025_data</span> <span class="o">*</span><span class="n">rx8025</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctrl2</span><span class="p">,</span> <span class="n">ald</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rx8025_read_regs</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RX8025_REG_ALDMIN</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ald</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rx8025_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RX8025_REG_CTRL2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: read alarm 0x%02x 0x%02x ctrl2 %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">ald</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ald</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ctrl2</span><span class="p">);</span>

	<span class="cm">/* Hardware alarms precision is 1 minute! */</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_min</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">ald</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">&amp;</span> <span class="n">RX8025_BIT_CTRL1_1224</span><span class="p">)</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_hour</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">ald</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_hour</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">ald</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span>
			<span class="o">+</span> <span class="p">(</span><span class="n">ald</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span> <span class="o">?</span> <span class="mi">12</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_wday</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mday</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mon</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: date: %ds %dm %dh %dmd %dm %dy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_sec</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_min</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_hour</span><span class="p">,</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mday</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mon</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_year</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">&amp;</span> <span class="n">RX8025_BIT_CTRL1_DALE</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl2</span> <span class="o">&amp;</span> <span class="n">RX8025_BIT_CTRL2_DAFG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx8025_set_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_wkalrm</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rx8025_data</span> <span class="o">*</span><span class="n">rx8025</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ald</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Hardware alarm precision is 1 minute! */</span>
	<span class="n">ald</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_min</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">&amp;</span> <span class="n">RX8025_BIT_CTRL1_1224</span><span class="p">)</span>
		<span class="n">ald</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_hour</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ald</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_hour</span> <span class="o">&gt;=</span> <span class="mi">12</span> <span class="o">?</span> <span class="mh">0x20</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">bin2bcd</span><span class="p">((</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_hour</span> <span class="o">+</span> <span class="mi">11</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: write 0x%02x 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ald</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ald</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">&amp;</span> <span class="n">RX8025_BIT_CTRL1_DALE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RX8025_BIT_CTRL1_DALE</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rx8025_write_reg</span><span class="p">(</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">RX8025_REG_CTRL1</span><span class="p">,</span>
				       <span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">ctrl1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rx8025_write_regs</span><span class="p">(</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">RX8025_REG_ALDMIN</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ald</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">|=</span> <span class="n">RX8025_BIT_CTRL1_DALE</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rx8025_write_reg</span><span class="p">(</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">RX8025_REG_CTRL1</span><span class="p">,</span>
				       <span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">ctrl1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx8025_alarm_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx8025_data</span> <span class="o">*</span><span class="n">rx8025</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ctrl1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ctrl1</span> <span class="o">=</span> <span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">ctrl1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">ctrl1</span> <span class="o">|=</span> <span class="n">RX8025_BIT_CTRL1_DALE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ctrl1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RX8025_BIT_CTRL1_DALE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl1</span> <span class="o">!=</span> <span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">ctrl1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">=</span> <span class="n">ctrl1</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rx8025_write_reg</span><span class="p">(</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">RX8025_REG_CTRL1</span><span class="p">,</span>
				       <span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">ctrl1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtc_class_ops</span> <span class="n">rx8025_rtc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read_time</span> <span class="o">=</span> <span class="n">rx8025_get_time</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_time</span> <span class="o">=</span> <span class="n">rx8025_set_time</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_alarm</span> <span class="o">=</span> <span class="n">rx8025_read_alarm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_alarm</span> <span class="o">=</span> <span class="n">rx8025_set_alarm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alarm_irq_enable</span> <span class="o">=</span> <span class="n">rx8025_alarm_irq_enable</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Clock precision adjustment support</span>
<span class="cm"> *</span>
<span class="cm"> * According to the RX8025 SA/NB application manual the frequency and</span>
<span class="cm"> * temperature characteristics can be approximated using the following</span>
<span class="cm"> * equation:</span>
<span class="cm"> *</span>
<span class="cm"> *   df = a * (ut - t)**2</span>
<span class="cm"> *</span>
<span class="cm"> *   df: Frequency deviation in any temperature</span>
<span class="cm"> *   a : Coefficient = (-35 +-5) * 10**-9</span>
<span class="cm"> *   ut: Ultimate temperature in degree = +25 +-5 degree</span>
<span class="cm"> *   t : Any temperature in degree</span>
<span class="cm"> *</span>
<span class="cm"> * Note that the clock adjustment in ppb must be entered (which is</span>
<span class="cm"> * the negative value of the deviation).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx8025_get_clock_adjust</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">adj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">digoff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rx8025_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RX8025_REG_DIGOFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">digoff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="o">*</span><span class="n">adj</span> <span class="o">=</span> <span class="n">digoff</span> <span class="o">&gt;=</span> <span class="mi">64</span> <span class="o">?</span> <span class="n">digoff</span> <span class="o">-</span> <span class="mi">128</span> <span class="o">:</span> <span class="n">digoff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">adj</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">(</span><span class="o">*</span><span class="n">adj</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
	<span class="o">*</span><span class="n">adj</span> <span class="o">*=</span> <span class="o">-</span><span class="n">RX8025_ADJ_RESOLUTION</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx8025_set_clock_adjust</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">digoff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">adj</span> <span class="o">/=</span> <span class="o">-</span><span class="n">RX8025_ADJ_RESOLUTION</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adj</span> <span class="o">&gt;</span> <span class="n">RX8025_ADJ_DATA_MAX</span><span class="p">)</span>
		<span class="n">adj</span> <span class="o">=</span> <span class="n">RX8025_ADJ_DATA_MAX</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adj</span> <span class="o">&lt;</span> <span class="n">RX8025_ADJ_DATA_MIN</span><span class="p">)</span>
		<span class="n">adj</span> <span class="o">=</span> <span class="n">RX8025_ADJ_DATA_MIN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adj</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">adj</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adj</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">adj</span> <span class="o">+=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">digoff</span> <span class="o">=</span> <span class="n">adj</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rx8025_write_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">RX8025_REG_DIGOFF</span><span class="p">,</span> <span class="n">digoff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: write 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">digoff</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rx8025_sysfs_show_clock_adjust</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">adj</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rx8025_get_clock_adjust</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adj</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rx8025_sysfs_store_clock_adjust</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">adj</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adj</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rx8025_set_clock_adjust</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">adj</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">clock_adjust_ppb</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">rx8025_sysfs_show_clock_adjust</span><span class="p">,</span>
		   <span class="n">rx8025_sysfs_store_clock_adjust</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx8025_sysfs_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_clock_adjust_ppb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx8025_sysfs_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_clock_adjust_ppb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">rx8025_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">to_i2c_adapter</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rx8025_data</span> <span class="o">*</span><span class="n">rx8025</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">need_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_BYTE_DATA</span>
				     <span class="o">|</span> <span class="n">I2C_FUNC_SMBUS_I2C_BLOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;doesn&#39;t support required functionality</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rx8025</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rx8025</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx8025</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to alloc memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">rx8025</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">rx8025_work</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rx8025_init_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">need_reset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">need_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rtc_time</span> <span class="n">tm</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;bad conditions detected, resetting date</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtc_time_to_tm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tm</span><span class="p">);</span>	<span class="cm">/* 1970/1/1 */</span>
		<span class="n">rx8025_set_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">rtc</span> <span class="o">=</span> <span class="n">rtc_device_register</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">rx8025_rtc_ops</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to register the class device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">errout_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ %d supplied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">rx8025_irq</span><span class="p">,</span>
				  <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;rx8025&quot;</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to request IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">errout_reg</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_freq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">max_user_freq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rx8025_sysfs_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout_irq</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">errout_irq:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>

<span class="nl">errout_reg:</span>
	<span class="n">rtc_device_unregister</span><span class="p">(</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">);</span>

<span class="nl">errout_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rx8025</span><span class="p">);</span>

<span class="nl">errout:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probing for rx8025 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">rx8025_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx8025_data</span> <span class="o">*</span><span class="n">rx8025</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="o">*</span><span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">exiting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">free_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>
		<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rx8025_sysfs_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtc_device_unregister</span><span class="p">(</span><span class="n">rx8025</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rx8025</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">rx8025_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;rtc-rx8025&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">rx8025_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">rx8025_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">rx8025_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">rx8025_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Wolfgang Grandegger &lt;wg@grandegger.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;RX-8025 SA/NB RTC driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
