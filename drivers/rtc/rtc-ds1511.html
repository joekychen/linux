<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › rtc › rtc-ds1511.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>rtc-ds1511.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * An rtc driver for the Dallas DS1511</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006 Atsushi Nemoto &lt;anemo@mba.ocn.ne.jp&gt;</span>
<span class="cm"> * Copyright (C) 2007 Andrew Sharp &lt;andy.sharp@lsi.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * Real time clock driver for the Dallas 1511 chip, which also</span>
<span class="cm"> * contains a watchdog timer.  There is a tiny amount of code that</span>
<span class="cm"> * platform code could use to mess with the watchdog device a little</span>
<span class="cm"> * bit, but not a full watchdog driver.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/bcd.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/rtc.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#define DRV_VERSION &quot;0.6&quot;</span>

<span class="k">enum</span> <span class="n">ds1511reg</span> <span class="p">{</span>
	<span class="n">DS1511_SEC</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="n">DS1511_MIN</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
	<span class="n">DS1511_HOUR</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
	<span class="n">DS1511_DOW</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>
	<span class="n">DS1511_DOM</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="n">DS1511_MONTH</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">,</span>
	<span class="n">DS1511_YEAR</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">,</span>
	<span class="n">DS1511_CENTURY</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">,</span>
	<span class="n">DS1511_AM1_SEC</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
	<span class="n">DS1511_AM2_MIN</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">,</span>
	<span class="n">DS1511_AM3_HOUR</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">,</span>
	<span class="n">DS1511_AM4_DATE</span> <span class="o">=</span> <span class="mh">0xb</span><span class="p">,</span>
	<span class="n">DS1511_WD_MSEC</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">,</span>
	<span class="n">DS1511_WD_SEC</span> <span class="o">=</span> <span class="mh">0xd</span><span class="p">,</span>
	<span class="n">DS1511_CONTROL_A</span> <span class="o">=</span> <span class="mh">0xe</span><span class="p">,</span>
	<span class="n">DS1511_CONTROL_B</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">,</span>
	<span class="n">DS1511_RAMADDR_LSB</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">DS1511_RAMDATA</span> <span class="o">=</span> <span class="mh">0x13</span>
<span class="p">};</span>

<span class="cp">#define DS1511_BLF1	0x80</span>
<span class="cp">#define DS1511_BLF2	0x40</span>
<span class="cp">#define DS1511_PRS	0x20</span>
<span class="cp">#define DS1511_PAB	0x10</span>
<span class="cp">#define DS1511_TDF	0x08</span>
<span class="cp">#define DS1511_KSF	0x04</span>
<span class="cp">#define DS1511_WDF	0x02</span>
<span class="cp">#define DS1511_IRQF	0x01</span>
<span class="cp">#define DS1511_TE	0x80</span>
<span class="cp">#define DS1511_CS	0x40</span>
<span class="cp">#define DS1511_BME	0x20</span>
<span class="cp">#define DS1511_TPE	0x10</span>
<span class="cp">#define DS1511_TIE	0x08</span>
<span class="cp">#define DS1511_KIE	0x04</span>
<span class="cp">#define DS1511_WDE	0x02</span>
<span class="cp">#define DS1511_WDS	0x01</span>
<span class="cp">#define DS1511_RAM_MAX	0xff</span>

<span class="cp">#define RTC_CMD		DS1511_CONTROL_B</span>
<span class="cp">#define RTC_CMD1	DS1511_CONTROL_A</span>

<span class="cp">#define RTC_ALARM_SEC	DS1511_AM1_SEC</span>
<span class="cp">#define RTC_ALARM_MIN	DS1511_AM2_MIN</span>
<span class="cp">#define RTC_ALARM_HOUR	DS1511_AM3_HOUR</span>
<span class="cp">#define RTC_ALARM_DATE	DS1511_AM4_DATE</span>

<span class="cp">#define RTC_SEC		DS1511_SEC</span>
<span class="cp">#define RTC_MIN		DS1511_MIN</span>
<span class="cp">#define RTC_HOUR	DS1511_HOUR</span>
<span class="cp">#define RTC_DOW		DS1511_DOW</span>
<span class="cp">#define RTC_DOM		DS1511_DOM</span>
<span class="cp">#define RTC_MON		DS1511_MONTH</span>
<span class="cp">#define RTC_YEAR	DS1511_YEAR</span>
<span class="cp">#define RTC_CENTURY	DS1511_CENTURY</span>

<span class="cp">#define RTC_TIE	DS1511_TIE</span>
<span class="cp">#define RTC_TE	DS1511_TE</span>

<span class="k">struct</span> <span class="n">rtc_plat_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>		<span class="cm">/* virtual base address */</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>				<span class="cm">/* amount of memory mapped */</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irqen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">alrm_sec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">alrm_min</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">alrm_hour</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">alrm_mday</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">ds1511_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="n">__iomem</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ds1511_base</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">reg_spacing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

 <span class="k">static</span> <span class="n">noinline</span> <span class="kt">void</span>
<span class="nf">rtc_write</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">val</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ds1511_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">*</span> <span class="n">reg_spacing</span><span class="p">));</span>
<span class="p">}</span>

 <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">rtc_write_alarm</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">val</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ds1511reg</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtc_write</span><span class="p">((</span><span class="n">val</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

 <span class="k">static</span> <span class="n">noinline</span> <span class="kt">uint8_t</span>
<span class="nf">rtc_read</span><span class="p">(</span><span class="k">enum</span> <span class="n">ds1511reg</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">ds1511_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">*</span> <span class="n">reg_spacing</span><span class="p">));</span>
<span class="p">}</span>

 <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">rtc_disable_update</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtc_write</span><span class="p">((</span><span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RTC_TE</span><span class="p">),</span> <span class="n">RTC_CMD</span><span class="p">);</span>
<span class="p">}</span>

 <span class="k">static</span> <span class="kt">void</span>
<span class="nf">rtc_enable_update</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtc_write</span><span class="p">((</span><span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">RTC_TE</span><span class="p">),</span> <span class="n">RTC_CMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * #define DS1511_WDOG_RESET_SUPPORT</span>
<span class="cm"> *</span>
<span class="cm"> * Uncomment this if you want to use these routines in</span>
<span class="cm"> * some platform code.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef DS1511_WDOG_RESET_SUPPORT</span>
<span class="cm">/*</span>
<span class="cm"> * just enough code to set the watchdog timer so that it</span>
<span class="cm"> * will reboot the system</span>
<span class="cm"> */</span>
 <span class="kt">void</span>
<span class="nf">ds1511_wdog_set</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deciseconds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * the wdog timer can take 99.99 seconds</span>
<span class="cm">	 */</span>
	<span class="n">deciseconds</span> <span class="o">%=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * set the wdog values in the wdog registers</span>
<span class="cm">	 */</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="n">bin2bcd</span><span class="p">(</span><span class="n">deciseconds</span> <span class="o">%</span> <span class="mi">100</span><span class="p">),</span> <span class="n">DS1511_WD_MSEC</span><span class="p">);</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="n">bin2bcd</span><span class="p">(</span><span class="n">deciseconds</span> <span class="o">/</span> <span class="mi">100</span><span class="p">),</span> <span class="n">DS1511_WD_SEC</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * set wdog enable and wdog &#39;steering&#39; bit to issue a reset</span>
<span class="cm">	 */</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="n">DS1511_WDE</span> <span class="o">|</span> <span class="n">DS1511_WDS</span><span class="p">,</span> <span class="n">RTC_CMD</span><span class="p">);</span>
<span class="p">}</span>

 <span class="kt">void</span>
<span class="nf">ds1511_wdog_disable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * clear wdog enable and wdog &#39;steering&#39; bits</span>
<span class="cm">	 */</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">DS1511_WDE</span> <span class="o">|</span> <span class="n">DS1511_WDS</span><span class="p">),</span> <span class="n">RTC_CMD</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * clear the wdog counter</span>
<span class="cm">	 */</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DS1511_WD_MSEC</span><span class="p">);</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DS1511_WD_SEC</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * set the rtc chip&#39;s idea of the time.</span>
<span class="cm"> * stupidly, some callers call with year unmolested;</span>
<span class="cm"> * and some call with  year = year - 1900.  thanks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ds1511_rtc_set_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_time</span> <span class="o">*</span><span class="n">rtc_tm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mon</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">dow</span><span class="p">,</span> <span class="n">hrs</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">sec</span><span class="p">,</span> <span class="n">yrs</span><span class="p">,</span> <span class="n">cen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * won&#39;t have to change this for a while</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">&lt;</span> <span class="mi">1900</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">+=</span> <span class="mi">1900</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">&lt;</span> <span class="mi">1970</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">yrs</span> <span class="o">=</span> <span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">%</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">cen</span> <span class="o">=</span> <span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">mon</span> <span class="o">=</span> <span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_mon</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>   <span class="cm">/* tm_mon starts at zero */</span>
	<span class="n">day</span> <span class="o">=</span> <span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_mday</span><span class="p">;</span>
	<span class="n">dow</span> <span class="o">=</span> <span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_wday</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span> <span class="cm">/* automatic BCD */</span>
	<span class="n">hrs</span> <span class="o">=</span> <span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_hour</span><span class="p">;</span>
	<span class="n">min</span> <span class="o">=</span> <span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_min</span><span class="p">;</span>
	<span class="n">sec</span> <span class="o">=</span> <span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_sec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mon</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">day</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">day</span> <span class="o">&gt;</span> <span class="n">rtc_month_days</span><span class="p">(</span><span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_mon</span><span class="p">,</span> <span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_year</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hrs</span> <span class="o">&gt;=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">min</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">sec</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * each register is a different number of valid bits</span>
<span class="cm">	 */</span>
	<span class="n">sec</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">min</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">hrs</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">hrs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">day</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">day</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">mon</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">mon</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">yrs</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">yrs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cen</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">cen</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1511_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rtc_disable_update</span><span class="p">();</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="n">cen</span><span class="p">,</span> <span class="n">RTC_CENTURY</span><span class="p">);</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="n">yrs</span><span class="p">,</span> <span class="n">RTC_YEAR</span><span class="p">);</span>
	<span class="n">rtc_write</span><span class="p">((</span><span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_MON</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">|</span> <span class="n">mon</span><span class="p">,</span> <span class="n">RTC_MON</span><span class="p">);</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="n">RTC_DOM</span><span class="p">);</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="n">hrs</span><span class="p">,</span> <span class="n">RTC_HOUR</span><span class="p">);</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="n">min</span><span class="p">,</span> <span class="n">RTC_MIN</span><span class="p">);</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">RTC_SEC</span><span class="p">);</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="n">dow</span><span class="p">,</span> <span class="n">RTC_DOW</span><span class="p">);</span>
	<span class="n">rtc_enable_update</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1511_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ds1511_rtc_read_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_time</span> <span class="o">*</span><span class="n">rtc_tm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">century</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1511_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rtc_disable_update</span><span class="p">();</span>

	<span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_sec</span> <span class="o">=</span> <span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_SEC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_min</span> <span class="o">=</span> <span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_MIN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_hour</span> <span class="o">=</span> <span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_HOUR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_mday</span> <span class="o">=</span> <span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_DOM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_wday</span> <span class="o">=</span> <span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_DOW</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_mon</span> <span class="o">=</span> <span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_MON</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">=</span> <span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_YEAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">century</span> <span class="o">=</span> <span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_CENTURY</span><span class="p">);</span>

	<span class="n">rtc_enable_update</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1511_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_sec</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_sec</span><span class="p">);</span>
	<span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_min</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_min</span><span class="p">);</span>
	<span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_hour</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_hour</span><span class="p">);</span>
	<span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_mday</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_mday</span><span class="p">);</span>
	<span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_wday</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_wday</span><span class="p">);</span>
	<span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_mon</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_mon</span><span class="p">);</span>
	<span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_year</span><span class="p">);</span>
	<span class="n">century</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">century</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Account for differences between how the RTC uses the values</span>
<span class="cm">	 * and how they are defined in a struct rtc_time;</span>
<span class="cm">	 */</span>
	<span class="n">century</span> <span class="o">+=</span> <span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_year</span><span class="p">;</span>
	<span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">=</span> <span class="n">century</span> <span class="o">-</span> <span class="mi">1900</span><span class="p">;</span>

	<span class="n">rtc_tm</span><span class="o">-&gt;</span><span class="n">tm_mon</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtc_valid_tm</span><span class="p">(</span><span class="n">rtc_tm</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;retrieved date/time is not valid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtc_time_to_tm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rtc_tm</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * write the alarm register settings</span>
<span class="cm"> *</span>
<span class="cm"> * we only have the use to interrupt every second, otherwise</span>
<span class="cm"> * known as the update interrupt, or the interrupt if the whole</span>
<span class="cm"> * date/hours/mins/secs matches.  the ds1511 has many more</span>
<span class="cm"> * permutations, but the kernel doesn&#39;t.</span>
<span class="cm"> */</span>
 <span class="k">static</span> <span class="kt">void</span>
<span class="nf">ds1511_rtc_update_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_plat_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_mday</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irqen</span> <span class="o">&amp;</span> <span class="n">RTC_UF</span><span class="p">)</span> <span class="o">?</span>
	       <span class="mh">0x80</span> <span class="o">:</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_mday</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">,</span>
	       <span class="n">RTC_ALARM_DATE</span><span class="p">);</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_hour</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irqen</span> <span class="o">&amp;</span> <span class="n">RTC_UF</span><span class="p">)</span> <span class="o">?</span>
	       <span class="mh">0x80</span> <span class="o">:</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_hour</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">,</span>
	       <span class="n">RTC_ALARM_HOUR</span><span class="p">);</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_min</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irqen</span> <span class="o">&amp;</span> <span class="n">RTC_UF</span><span class="p">)</span> <span class="o">?</span>
	       <span class="mh">0x80</span> <span class="o">:</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
	       <span class="n">RTC_ALARM_MIN</span><span class="p">);</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_sec</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irqen</span> <span class="o">&amp;</span> <span class="n">RTC_UF</span><span class="p">)</span> <span class="o">?</span>
	       <span class="mh">0x80</span> <span class="o">:</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_sec</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
	       <span class="n">RTC_ALARM_SEC</span><span class="p">);</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irqen</span> <span class="o">?</span> <span class="n">RTC_TIE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">RTC_CMD</span><span class="p">);</span>
	<span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_CMD1</span><span class="p">);</span>	<span class="cm">/* clear interrupts */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

 <span class="k">static</span> <span class="kt">int</span>
<span class="nf">ds1511_rtc_set_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_wkalrm</span> <span class="o">*</span><span class="n">alrm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtc_plat_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_mday</span> <span class="o">=</span> <span class="n">alrm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mday</span><span class="p">;</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_hour</span> <span class="o">=</span> <span class="n">alrm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_hour</span><span class="p">;</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_min</span> <span class="o">=</span> <span class="n">alrm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_min</span><span class="p">;</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_sec</span> <span class="o">=</span> <span class="n">alrm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_sec</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alrm</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irqen</span> <span class="o">|=</span> <span class="n">RTC_AF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ds1511_rtc_update_alarm</span><span class="p">(</span><span class="n">pdata</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

 <span class="k">static</span> <span class="kt">int</span>
<span class="nf">ds1511_rtc_read_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_wkalrm</span> <span class="o">*</span><span class="n">alrm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtc_plat_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">alrm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mday</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_mday</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_mday</span><span class="p">;</span>
	<span class="n">alrm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_hour</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_hour</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_hour</span><span class="p">;</span>
	<span class="n">alrm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_min</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_min</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_min</span><span class="p">;</span>
	<span class="n">alrm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_sec</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_sec</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">alrm_sec</span><span class="p">;</span>
	<span class="n">alrm</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irqen</span> <span class="o">&amp;</span> <span class="n">RTC_AF</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

 <span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">ds1511_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtc_plat_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * read and clear interrupt</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_CMD1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DS1511_IRQF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">events</span> <span class="o">=</span> <span class="n">RTC_IRQF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_ALARM_SEC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">events</span> <span class="o">|=</span> <span class="n">RTC_UF</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">events</span> <span class="o">|=</span> <span class="n">RTC_AF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">))</span>
			<span class="n">rtc_update_irq</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">events</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">events</span> <span class="o">?</span> <span class="n">IRQ_HANDLED</span> <span class="o">:</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ds1511_rtc_alarm_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtc_plat_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irqen</span> <span class="o">|=</span> <span class="n">RTC_AF</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irqen</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RTC_AF</span><span class="p">;</span>
	<span class="n">ds1511_rtc_update_alarm</span><span class="p">(</span><span class="n">pdata</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rtc_class_ops</span> <span class="n">ds1511_rtc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read_time</span>		<span class="o">=</span> <span class="n">ds1511_rtc_read_time</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_time</span>		<span class="o">=</span> <span class="n">ds1511_rtc_set_time</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_alarm</span>		<span class="o">=</span> <span class="n">ds1511_rtc_read_alarm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_alarm</span>		<span class="o">=</span> <span class="n">ds1511_rtc_set_alarm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alarm_irq_enable</span>	<span class="o">=</span> <span class="n">ds1511_rtc_alarm_irq_enable</span><span class="p">,</span>
<span class="p">};</span>

 <span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">ds1511_nvram_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">ba</span><span class="p">,</span>
		  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if count is more than one, turn on &quot;burst&quot; mode</span>
<span class="cm">	 * turn it off when you&#39;re done</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtc_write</span><span class="p">((</span><span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">DS1511_BME</span><span class="p">),</span> <span class="n">RTC_CMD</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="n">DS1511_RAM_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">DS1511_RAM_MAX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="n">DS1511_RAM_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">DS1511_RAM_MAX</span> <span class="o">-</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">DS1511_RAMADDR_LSB</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">,</span> <span class="n">size</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">rtc_read</span><span class="p">(</span><span class="n">DS1511_RAMDATA</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtc_write</span><span class="p">((</span><span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DS1511_BME</span><span class="p">),</span> <span class="n">RTC_CMD</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

 <span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">ds1511_nvram_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
		   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if count is more than one, turn on &quot;burst&quot; mode</span>
<span class="cm">	 * turn it off when you&#39;re done</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtc_write</span><span class="p">((</span><span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">DS1511_BME</span><span class="p">),</span> <span class="n">RTC_CMD</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="n">DS1511_RAM_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">DS1511_RAM_MAX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="n">DS1511_RAM_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">DS1511_RAM_MAX</span> <span class="o">-</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">DS1511_RAMADDR_LSB</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">,</span> <span class="n">size</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtc_write</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">,</span> <span class="n">DS1511_RAMDATA</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtc_write</span><span class="p">((</span><span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DS1511_BME</span><span class="p">),</span> <span class="n">RTC_CMD</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">ds1511_nvram_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;nvram&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">DS1511_RAM_MAX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ds1511_nvram_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ds1511_nvram_write</span><span class="p">,</span>
<span class="p">};</span>

 <span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">ds1511_rtc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtc_plat_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pdata</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devm_request_mem_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">ds1511_base</span> <span class="o">=</span> <span class="n">devm_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ds1511_base</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">ds1511_base</span><span class="p">;</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * turn on the clock and the crystal, etc.</span>
<span class="cm">	 */</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">RTC_CMD</span><span class="p">);</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">RTC_CMD1</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * clear the wdog counter</span>
<span class="cm">	 */</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DS1511_WD_MSEC</span><span class="p">);</span>
	<span class="n">rtc_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DS1511_WD_SEC</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * start the clock</span>
<span class="cm">	 */</span>
	<span class="n">rtc_enable_update</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * check for a dying bat-tree</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_CMD1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DS1511_BLF1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;voltage-low detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pdata</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * if the platform has an interrupt in mind for this device,</span>
<span class="cm">	 * then by all means, set it</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_CMD1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devm_request_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ds1511_interrupt</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;interrupt not available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rtc</span> <span class="o">=</span> <span class="n">rtc_device_register</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ds1511_rtc_ops</span><span class="p">,</span>
		<span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rtc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rtc</span><span class="p">);</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">rtc</span> <span class="o">=</span> <span class="n">rtc</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ds1511_nvram_attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">rtc_device_unregister</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

 <span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span>
<span class="nf">ds1511_rtc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtc_plat_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">sysfs_remove_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ds1511_nvram_attr</span><span class="p">);</span>
	<span class="n">rtc_device_unregister</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * disable the alarm interrupt</span>
<span class="cm">		 */</span>
		<span class="n">rtc_write</span><span class="p">(</span><span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RTC_TIE</span><span class="p">,</span> <span class="n">RTC_CMD</span><span class="p">);</span>
		<span class="n">rtc_read</span><span class="p">(</span><span class="n">RTC_CMD1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* work with hotplug and coldplug */</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:ds1511&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">ds1511_rtc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ds1511_rtc_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ds1511_rtc_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ds1511&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">ds1511_rtc_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Andrew Sharp &lt;andy.sharp@lsi.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Dallas DS1511 RTC driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
