<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › rtc › rtc-ds1307.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>rtc-ds1307.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * rtc-ds1307.c - RTC driver for some mostly-compatible I2C chips.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2005 James Chapman (ds1337 core)</span>
<span class="cm"> *  Copyright (C) 2006 David Brownell</span>
<span class="cm"> *  Copyright (C) 2009 Matthias Fuchs (rx8025 support)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/rtc.h&gt;</span>
<span class="cp">#include &lt;linux/bcd.h&gt;</span>
<span class="cp">#include &lt;linux/rtc/ds1307.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * We can&#39;t determine type by probing, but if we expect pre-Linux code</span>
<span class="cm"> * to have set the chip up as a clock (turning on the oscillator and</span>
<span class="cm"> * setting the date and time), Linux can ignore the non-clock features.</span>
<span class="cm"> * That&#39;s a natural job for a factory or repair bench.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">ds_type</span> <span class="p">{</span>
	<span class="n">ds_1307</span><span class="p">,</span>
	<span class="n">ds_1337</span><span class="p">,</span>
	<span class="n">ds_1338</span><span class="p">,</span>
	<span class="n">ds_1339</span><span class="p">,</span>
	<span class="n">ds_1340</span><span class="p">,</span>
	<span class="n">ds_1388</span><span class="p">,</span>
	<span class="n">ds_3231</span><span class="p">,</span>
	<span class="n">m41t00</span><span class="p">,</span>
	<span class="n">mcp7941x</span><span class="p">,</span>
	<span class="n">rx_8025</span><span class="p">,</span>
	<span class="n">last_ds_type</span> <span class="cm">/* always last */</span>
	<span class="cm">/* rs5c372 too?  different address... */</span>
<span class="p">};</span>


<span class="cm">/* RTC registers don&#39;t differ much, except for the century flag */</span>
<span class="cp">#define DS1307_REG_SECS		0x00	</span><span class="cm">/* 00-59 */</span><span class="cp"></span>
<span class="cp">#	define DS1307_BIT_CH		0x80</span>
<span class="cp">#	define DS1340_BIT_nEOSC		0x80</span>
<span class="cp">#	define MCP7941X_BIT_ST		0x80</span>
<span class="cp">#define DS1307_REG_MIN		0x01	</span><span class="cm">/* 00-59 */</span><span class="cp"></span>
<span class="cp">#define DS1307_REG_HOUR		0x02	</span><span class="cm">/* 00-23, or 1-12{am,pm} */</span><span class="cp"></span>
<span class="cp">#	define DS1307_BIT_12HR		0x40	</span><span class="cm">/* in REG_HOUR */</span><span class="cp"></span>
<span class="cp">#	define DS1307_BIT_PM		0x20	</span><span class="cm">/* in REG_HOUR */</span><span class="cp"></span>
<span class="cp">#	define DS1340_BIT_CENTURY_EN	0x80	</span><span class="cm">/* in REG_HOUR */</span><span class="cp"></span>
<span class="cp">#	define DS1340_BIT_CENTURY	0x40	</span><span class="cm">/* in REG_HOUR */</span><span class="cp"></span>
<span class="cp">#define DS1307_REG_WDAY		0x03	</span><span class="cm">/* 01-07 */</span><span class="cp"></span>
<span class="cp">#	define MCP7941X_BIT_VBATEN	0x08</span>
<span class="cp">#define DS1307_REG_MDAY		0x04	</span><span class="cm">/* 01-31 */</span><span class="cp"></span>
<span class="cp">#define DS1307_REG_MONTH	0x05	</span><span class="cm">/* 01-12 */</span><span class="cp"></span>
<span class="cp">#	define DS1337_BIT_CENTURY	0x80	</span><span class="cm">/* in REG_MONTH */</span><span class="cp"></span>
<span class="cp">#define DS1307_REG_YEAR		0x06	</span><span class="cm">/* 00-99 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Other registers (control, status, alarms, trickle charge, NVRAM, etc)</span>
<span class="cm"> * start at 7, and they differ a LOT. Only control and status matter for</span>
<span class="cm"> * basic RTC date and time functionality; be careful using them.</span>
<span class="cm"> */</span>
<span class="cp">#define DS1307_REG_CONTROL	0x07		</span><span class="cm">/* or ds1338 */</span><span class="cp"></span>
<span class="cp">#	define DS1307_BIT_OUT		0x80</span>
<span class="cp">#	define DS1338_BIT_OSF		0x20</span>
<span class="cp">#	define DS1307_BIT_SQWE		0x10</span>
<span class="cp">#	define DS1307_BIT_RS1		0x02</span>
<span class="cp">#	define DS1307_BIT_RS0		0x01</span>
<span class="cp">#define DS1337_REG_CONTROL	0x0e</span>
<span class="cp">#	define DS1337_BIT_nEOSC		0x80</span>
<span class="cp">#	define DS1339_BIT_BBSQI		0x20</span>
<span class="cp">#	define DS3231_BIT_BBSQW		0x40 </span><span class="cm">/* same as BBSQI */</span><span class="cp"></span>
<span class="cp">#	define DS1337_BIT_RS2		0x10</span>
<span class="cp">#	define DS1337_BIT_RS1		0x08</span>
<span class="cp">#	define DS1337_BIT_INTCN		0x04</span>
<span class="cp">#	define DS1337_BIT_A2IE		0x02</span>
<span class="cp">#	define DS1337_BIT_A1IE		0x01</span>
<span class="cp">#define DS1340_REG_CONTROL	0x07</span>
<span class="cp">#	define DS1340_BIT_OUT		0x80</span>
<span class="cp">#	define DS1340_BIT_FT		0x40</span>
<span class="cp">#	define DS1340_BIT_CALIB_SIGN	0x20</span>
<span class="cp">#	define DS1340_M_CALIBRATION	0x1f</span>
<span class="cp">#define DS1340_REG_FLAG		0x09</span>
<span class="cp">#	define DS1340_BIT_OSF		0x80</span>
<span class="cp">#define DS1337_REG_STATUS	0x0f</span>
<span class="cp">#	define DS1337_BIT_OSF		0x80</span>
<span class="cp">#	define DS1337_BIT_A2I		0x02</span>
<span class="cp">#	define DS1337_BIT_A1I		0x01</span>
<span class="cp">#define DS1339_REG_ALARM1_SECS	0x07</span>

<span class="cp">#define DS13XX_TRICKLE_CHARGER_MAGIC	0xa0</span>

<span class="cp">#define RX8025_REG_CTRL1	0x0e</span>
<span class="cp">#	define RX8025_BIT_2412		0x20</span>
<span class="cp">#define RX8025_REG_CTRL2	0x0f</span>
<span class="cp">#	define RX8025_BIT_PON		0x10</span>
<span class="cp">#	define RX8025_BIT_VDET		0x40</span>
<span class="cp">#	define RX8025_BIT_XST		0x20</span>


<span class="k">struct</span> <span class="n">ds1307</span> <span class="p">{</span>
	<span class="n">u8</span>			<span class="n">offset</span><span class="p">;</span> <span class="cm">/* register&#39;s offset */</span>
	<span class="n">u8</span>			<span class="n">regs</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
	<span class="n">u16</span>			<span class="n">nvram_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bin_attribute</span>	<span class="o">*</span><span class="n">nvram</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ds_type</span>		<span class="n">type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
<span class="cp">#define HAS_NVRAM	0		</span><span class="cm">/* bit 0 == sysfs file active */</span><span class="cp"></span>
<span class="cp">#define HAS_ALARM	1		</span><span class="cm">/* bit 1 == irq claimed */</span><span class="cp"></span>
	<span class="k">struct</span> <span class="n">i2c_client</span>	<span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtc_device</span>	<span class="o">*</span><span class="n">rtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">work</span><span class="p">;</span>
	<span class="n">s32</span> <span class="p">(</span><span class="o">*</span><span class="n">read_block_data</span><span class="p">)(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">command</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="n">length</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">values</span><span class="p">);</span>
	<span class="n">s32</span> <span class="p">(</span><span class="o">*</span><span class="n">write_block_data</span><span class="p">)(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">command</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">length</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">values</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">chip_desc</span> <span class="p">{</span>
	<span class="kt">unsigned</span>		<span class="n">alarm</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">nvram_offset</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">nvram_size</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">trickle_charger_reg</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">chip_desc</span> <span class="n">chips</span><span class="p">[</span><span class="n">last_ds_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">ds_1307</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">nvram_offset</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nvram_size</span>	<span class="o">=</span> <span class="mi">56</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">ds_1337</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">alarm</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">ds_1338</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">nvram_offset</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nvram_size</span>	<span class="o">=</span> <span class="mi">56</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">ds_1339</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">alarm</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">trickle_charger_reg</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">ds_1340</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">trickle_charger_reg</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">ds_1388</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">trickle_charger_reg</span> <span class="o">=</span> <span class="mh">0x0a</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">ds_3231</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">alarm</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">mcp7941x</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* this is battery backed SRAM */</span>
		<span class="p">.</span><span class="n">nvram_offset</span>	<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nvram_size</span>	<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">ds1307_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;ds1307&quot;</span><span class="p">,</span> <span class="n">ds_1307</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ds1337&quot;</span><span class="p">,</span> <span class="n">ds_1337</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ds1338&quot;</span><span class="p">,</span> <span class="n">ds_1338</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ds1339&quot;</span><span class="p">,</span> <span class="n">ds_1339</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ds1388&quot;</span><span class="p">,</span> <span class="n">ds_1388</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ds1340&quot;</span><span class="p">,</span> <span class="n">ds_1340</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ds3231&quot;</span><span class="p">,</span> <span class="n">ds_3231</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;m41t00&quot;</span><span class="p">,</span> <span class="n">m41t00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;mcp7941x&quot;</span><span class="p">,</span> <span class="n">mcp7941x</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;pt7c4338&quot;</span><span class="p">,</span> <span class="n">ds_1307</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx8025&quot;</span><span class="p">,</span> <span class="n">rx_8025</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">ds1307_id</span><span class="p">);</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cp">#define BLOCK_DATA_MAX_TRIES 10</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">ds1307_read_block_data_once</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="n">command</span><span class="p">,</span> <span class="n">u8</span> <span class="n">length</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">values</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">command</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">ds1307_read_block_data</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">command</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">length</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">values</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">oldvalues</span><span class="p">[</span><span class="n">I2C_SMBUS_BLOCK_MAX</span><span class="p">];</span>
	<span class="n">s32</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ds1307_read_block_data (length=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ds1307_read_block_data_once</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">values</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">tries</span> <span class="o">&gt;</span> <span class="n">BLOCK_DATA_MAX_TRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;ds1307_read_block_data failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">oldvalues</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ds1307_read_block_data_once</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
						  <span class="n">values</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">oldvalues</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">length</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">ds1307_write_block_data</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">command</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">length</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">values</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">currvalues</span><span class="p">[</span><span class="n">I2C_SMBUS_BLOCK_MAX</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ds1307_write_block_data (length=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">s32</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">tries</span> <span class="o">&gt;</span> <span class="n">BLOCK_DATA_MAX_TRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;ds1307_write_block_data failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">command</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
							<span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ds1307_read_block_data_once</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
						  <span class="n">currvalues</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">currvalues</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">length</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * The IRQ logic includes a &quot;real&quot; handler running in IRQ context just</span>
<span class="cm"> * long enough to schedule this workqueue entry.   We need a task context</span>
<span class="cm"> * to talk to the RTC, since I2C I/O calls require that; and disable the</span>
<span class="cm"> * IRQ until we clear its status on the chip, so that this handler can</span>
<span class="cm"> * work with any type of triggering (not just falling edge).</span>
<span class="cm"> *</span>
<span class="cm"> * The ds1337 and ds1339 both have two alarms, but we only use the first</span>
<span class="cm"> * one (with a &quot;seconds&quot; field).  For ds1337 we expect nINTA is our alarm</span>
<span class="cm"> * signal; ds1339 chips have only one alarm signal.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ds1307_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds1307</span>		<span class="o">*</span><span class="n">ds1307</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>	<span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="o">*</span><span class="n">lock</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">stat</span><span class="p">,</span> <span class="n">control</span><span class="p">;</span>

	<span class="n">ds1307</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ds1307</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="n">client</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DS1337_REG_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">DS1337_BIT_A1I</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DS1337_BIT_A1I</span><span class="p">;</span>
		<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DS1337_REG_STATUS</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>

		<span class="n">control</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DS1337_REG_CONTROL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">control</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DS1337_BIT_A1IE</span><span class="p">;</span>
		<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DS1337_REG_CONTROL</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

		<span class="n">rtc_update_irq</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">RTC_AF</span> <span class="o">|</span> <span class="n">RTC_IRQF</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HAS_ALARM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ds1307_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>	<span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ds1307</span>		<span class="o">*</span><span class="n">ds1307</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ds1307_get_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_time</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds1307</span>	<span class="o">*</span><span class="n">ds1307</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* read the RTC date and time registers all at once */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">read_block_data</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
		<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;read&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %02x %02x %02x %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;read&quot;</span><span class="p">,</span>
			<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_sec</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">DS1307_REG_SECS</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_min</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">DS1307_REG_MIN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">DS1307_REG_HOUR</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_hour</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_wday</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">DS1307_REG_WDAY</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_mday</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">DS1307_REG_MDAY</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">DS1307_REG_MONTH</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_mon</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* assume 20YY not 19YY, and ignore DS1337_BIT_CENTURY */</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">DS1307_REG_YEAR</span><span class="p">])</span> <span class="o">+</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s secs=%d, mins=%d, &quot;</span>
		<span class="s">&quot;hours=%d, mday=%d, mon=%d, year=%d, wday=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="s">&quot;read&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_sec</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_min</span><span class="p">,</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_hour</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_mday</span><span class="p">,</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_mon</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_year</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_wday</span><span class="p">);</span>

	<span class="cm">/* initial clock setting can be undefined */</span>
	<span class="k">return</span> <span class="n">rtc_valid_tm</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ds1307_set_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_time</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds1307</span>	<span class="o">*</span><span class="n">ds1307</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s secs=%d, mins=%d, &quot;</span>
		<span class="s">&quot;hours=%d, mday=%d, mon=%d, year=%d, wday=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_sec</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_min</span><span class="p">,</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_hour</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_mday</span><span class="p">,</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_mon</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_year</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_wday</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="n">DS1307_REG_SECS</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_sec</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">DS1307_REG_MIN</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_min</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">DS1307_REG_HOUR</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_hour</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">DS1307_REG_WDAY</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_wday</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">DS1307_REG_MDAY</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_mday</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">DS1307_REG_MONTH</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_mon</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* assume 20YY not 19YY */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">-</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">DS1307_REG_YEAR</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ds_1337</span>:
	<span class="k">case</span> <span class="n">ds_1339</span>:
	<span class="k">case</span> <span class="n">ds_3231</span>:
		<span class="n">buf</span><span class="p">[</span><span class="n">DS1307_REG_MONTH</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DS1337_BIT_CENTURY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ds_1340</span>:
		<span class="n">buf</span><span class="p">[</span><span class="n">DS1307_REG_HOUR</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DS1340_BIT_CENTURY_EN</span>
				<span class="o">|</span> <span class="n">DS1340_BIT_CENTURY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">mcp7941x</span>:
		<span class="cm">/*</span>
<span class="cm">		 * these bits were cleared when preparing the date/time</span>
<span class="cm">		 * values and need to be set again before writing the</span>
<span class="cm">		 * buffer out to the device.</span>
<span class="cm">		 */</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">DS1307_REG_SECS</span><span class="p">]</span> <span class="o">|=</span> <span class="n">MCP7941X_BIT_ST</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">DS1307_REG_WDAY</span><span class="p">]</span> <span class="o">|=</span> <span class="n">MCP7941X_BIT_VBATEN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %02x %02x %02x %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">write_block_data</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
		<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ds1337_read_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_wkalrm</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>       <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ds1307</span>		<span class="o">*</span><span class="n">ds1307</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HAS_ALARM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* read all ALARM1, ALARM2, and status registers at once */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">read_block_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
			<span class="n">DS1339_REG_ALARM1_SECS</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;alarm read&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %02x %02x %02x %02x, %02x %02x %02x, %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;alarm read&quot;</span><span class="p">,</span>
			<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
			<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">	 * report alarm time (ALARM1); assume 24 hour and day-of-month modes,</span>
<span class="cm">	 * and that all four fields are checked matches</span>
<span class="cm">	 */</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_sec</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_min</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_hour</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mday</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mon</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_wday</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_yday</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_isdst</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* ... and status */</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DS1337_BIT_A1IE</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DS1337_BIT_A1I</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s secs=%d, mins=%d, &quot;</span>
		<span class="s">&quot;hours=%d, mday=%d, enabled=%d, pending=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="s">&quot;alarm read&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_sec</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_min</span><span class="p">,</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_hour</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mday</span><span class="p">,</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ds1337_set_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_wkalrm</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>	<span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ds1307</span>		<span class="o">*</span><span class="n">ds1307</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">control</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HAS_ALARM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s secs=%d, mins=%d, &quot;</span>
		<span class="s">&quot;hours=%d, mday=%d, enabled=%d, pending=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="s">&quot;alarm set&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_sec</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_min</span><span class="p">,</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_hour</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mday</span><span class="p">,</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>

	<span class="cm">/* read current status of both alarms and the chip */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">read_block_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
			<span class="n">DS1339_REG_ALARM1_SECS</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;alarm write&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %02x %02x %02x %02x, %02x %02x %02x, %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;alarm set (old status)&quot;</span><span class="p">,</span>
			<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">control</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="cm">/* set ALARM1, using 24 hour and day-of-month modes */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_sec</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_min</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_hour</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mday</span><span class="p">);</span>

	<span class="cm">/* set ALARM2 to non-garbage */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* optionally enable ALARM1 */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">control</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">DS1337_BIT_A1IE</span> <span class="o">|</span> <span class="n">DS1337_BIT_A2IE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;alarm IRQ armed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DS1337_BIT_A1IE</span><span class="p">;</span>	<span class="cm">/* only ALARM1 is used */</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">DS1337_BIT_A1I</span> <span class="o">|</span> <span class="n">DS1337_BIT_A2I</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">write_block_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
			<span class="n">DS1339_REG_ALARM1_SECS</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t set alarm time</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ds1307_alarm_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>	<span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ds1307</span>		<span class="o">*</span><span class="n">ds1307</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HAS_ALARM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DS1337_REG_CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">DS1337_BIT_A1IE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DS1337_BIT_A1IE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DS1337_REG_CONTROL</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rtc_class_ops</span> <span class="n">ds13xx_rtc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read_time</span>	<span class="o">=</span> <span class="n">ds1307_get_time</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_time</span>	<span class="o">=</span> <span class="n">ds1307_set_time</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_alarm</span>	<span class="o">=</span> <span class="n">ds1337_read_alarm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_alarm</span>	<span class="o">=</span> <span class="n">ds1337_set_alarm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alarm_irq_enable</span> <span class="o">=</span> <span class="n">ds1307_alarm_irq_enable</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">ds1307_nvram_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>	<span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ds1307</span>		<span class="o">*</span><span class="n">ds1307</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">result</span><span class="p">;</span>

	<span class="n">client</span> <span class="o">=</span> <span class="n">kobj_to_i2c_client</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
	<span class="n">ds1307</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">+</span> <span class="n">count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">off</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">read_block_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram_offset</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span>
								<span class="n">count</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;nvram read&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">ds1307_nvram_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>	<span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ds1307</span>		<span class="o">*</span><span class="n">ds1307</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">result</span><span class="p">;</span>

	<span class="n">client</span> <span class="o">=</span> <span class="n">kobj_to_i2c_client</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
	<span class="n">ds1307</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFBIG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">+</span> <span class="n">count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">off</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">write_block_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram_offset</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span>
								<span class="n">count</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;nvram write&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ds1307_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds1307</span>		<span class="o">*</span><span class="n">ds1307</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">tmp</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">chip_desc</span>	<span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chips</span><span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span>	<span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">to_i2c_adapter</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">want_irq</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ds1307_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span>	<span class="n">bbsqi_bitpos</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">ds_1337</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ds_1339</span><span class="p">]</span> <span class="o">=</span> <span class="n">DS1339_BIT_BBSQI</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ds_3231</span><span class="p">]</span> <span class="o">=</span> <span class="n">DS3231_BIT_BBSQW</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_BYTE_DATA</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_I2C_BLOCK</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">ds1307</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ds1307</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ds1307</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ds1307</span><span class="p">);</span>

	<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">client</span>	<span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">type</span>	<span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">trickle_charger_setup</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">trickle_charger_reg</span><span class="p">)</span>
		<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">trickle_charger_reg</span><span class="p">,</span>
			<span class="n">DS13XX_TRICKLE_CHARGER_MAGIC</span> <span class="o">|</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">trickle_charger_setup</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_I2C_BLOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">read_block_data</span> <span class="o">=</span> <span class="n">i2c_smbus_read_i2c_block_data</span><span class="p">;</span>
		<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">write_block_data</span> <span class="o">=</span> <span class="n">i2c_smbus_write_i2c_block_data</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">read_block_data</span> <span class="o">=</span> <span class="n">ds1307_read_block_data</span><span class="p">;</span>
		<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">write_block_data</span> <span class="o">=</span> <span class="n">ds1307_write_block_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ds_1337</span>:
	<span class="k">case</span> <span class="n">ds_1339</span>:
	<span class="k">case</span> <span class="n">ds_3231</span>:
		<span class="cm">/* get registers that the &quot;rtc&quot; read below won&#39;t read... */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">read_block_data</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
				<span class="n">DS1337_REG_CONTROL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;read error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_free</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* oscillator off?  turn it on, so clock can tick. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DS1337_BIT_nEOSC</span><span class="p">)</span>
			<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DS1337_BIT_nEOSC</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Using IRQ?  Disable the square wave and both alarms.</span>
<span class="cm">		 * For some variants, be sure alarms can trigger when we&#39;re</span>
<span class="cm">		 * running on Vbackup (BBSQI/BBSQW)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">alarm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">ds1307_work</span><span class="p">);</span>

			<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DS1337_BIT_INTCN</span>
					<span class="o">|</span> <span class="n">bbsqi_bitpos</span><span class="p">[</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">];</span>
			<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DS1337_BIT_A2IE</span> <span class="o">|</span> <span class="n">DS1337_BIT_A1IE</span><span class="p">);</span>

			<span class="n">want_irq</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DS1337_REG_CONTROL</span><span class="p">,</span>
							<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="cm">/* oscillator fault?  clear flag, and warn */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DS1337_BIT_OSF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DS1337_REG_STATUS</span><span class="p">,</span>
				<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DS1337_BIT_OSF</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SET TIME!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">rx_8025</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">i2c_smbus_read_i2c_block_data</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
				<span class="n">RX8025_REG_CTRL1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;read error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_free</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* oscillator off?  turn it on, so clock can tick. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RX8025_BIT_XST</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">RX8025_BIT_XST</span><span class="p">;</span>
			<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						  <span class="n">RX8025_REG_CTRL2</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">,</span>
						  <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;oscillator stop detected - SET TIME!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RX8025_BIT_PON</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RX8025_BIT_PON</span><span class="p">;</span>
			<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						  <span class="n">RX8025_REG_CTRL2</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">,</span>
						  <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;power-on detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RX8025_BIT_VDET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RX8025_BIT_VDET</span><span class="p">;</span>
			<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						  <span class="n">RX8025_REG_CTRL2</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">,</span>
						  <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;voltage drop detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* make sure we are running in 24hour mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RX8025_BIT_2412</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">hour</span><span class="p">;</span>

			<span class="cm">/* switch to 24 hour mode */</span>
			<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						  <span class="n">RX8025_REG_CTRL1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">,</span>
						  <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span>
						  <span class="n">RX8025_BIT_2412</span><span class="p">);</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">i2c_smbus_read_i2c_block_data</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
					<span class="n">RX8025_REG_CTRL1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;read error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">exit_free</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* correct hour */</span>
			<span class="n">hour</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">DS1307_REG_HOUR</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hour</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span>
				<span class="n">hour</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">DS1307_REG_HOUR</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DS1307_BIT_PM</span><span class="p">)</span>
				<span class="n">hour</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>

			<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						  <span class="n">DS1307_REG_HOUR</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">,</span>
						  <span class="n">hour</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ds_1388</span>:
		<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Seconds starts at 1 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">read_rtc:</span>
	<span class="cm">/* read RTC registers */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">read_block_data</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;read error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * minimal sanity checking; some chips (like DS1340) don&#39;t</span>
<span class="cm">	 * specify the extra bits as must-be-zero, but there are</span>
<span class="cm">	 * still a few values that are clearly out-of-range.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">DS1307_REG_SECS</span><span class="p">];</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ds_1307</span>:
	<span class="k">case</span> <span class="n">m41t00</span>:
		<span class="cm">/* clock halted?  turn it on, so clock can tick. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">DS1307_BIT_CH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DS1307_REG_SECS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SET TIME!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">read_rtc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ds_1338</span>:
		<span class="cm">/* clock halted?  turn it on, so clock can tick. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">DS1307_BIT_CH</span><span class="p">)</span>
			<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DS1307_REG_SECS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* oscillator fault?  clear flag, and warn */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">DS1307_REG_CONTROL</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DS1338_BIT_OSF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DS1307_REG_CONTROL</span><span class="p">,</span>
					<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">DS1307_REG_CONTROL</span><span class="p">]</span>
					<span class="o">&amp;</span> <span class="o">~</span><span class="n">DS1338_BIT_OSF</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SET TIME!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">read_rtc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ds_1340</span>:
		<span class="cm">/* clock halted?  turn it on, so clock can tick. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">DS1340_BIT_nEOSC</span><span class="p">)</span>
			<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DS1307_REG_SECS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DS1340_REG_FLAG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;read error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_free</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* oscillator fault?  clear flag, and warn */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">DS1340_BIT_OSF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DS1340_REG_FLAG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SET TIME!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">mcp7941x</span>:
		<span class="cm">/* make sure that the backup battery is enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">DS1307_REG_WDAY</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MCP7941X_BIT_VBATEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DS1307_REG_WDAY</span><span class="p">,</span>
					<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">DS1307_REG_WDAY</span><span class="p">]</span>
					<span class="o">|</span> <span class="n">MCP7941X_BIT_VBATEN</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* clock halted?  turn it on, so clock can tick. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MCP7941X_BIT_ST</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DS1307_REG_SECS</span><span class="p">,</span>
					<span class="n">MCP7941X_BIT_ST</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SET TIME!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">read_rtc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">DS1307_REG_HOUR</span><span class="p">];</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ds_1340</span>:
	<span class="k">case</span> <span class="n">m41t00</span>:
		<span class="cm">/*</span>
<span class="cm">		 * NOTE: ignores century bits; fix before deploying</span>
<span class="cm">		 * systems that will run through year 2100.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">rx_8025</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">DS1307_BIT_12HR</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Be sure we&#39;re in 24 hour mode.  Multi-master systems</span>
<span class="cm">		 * take note...</span>
<span class="cm">		 */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">DS1307_REG_HOUR</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DS1307_BIT_PM</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
				<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">DS1307_REG_HOUR</span><span class="p">,</span>
				<span class="n">bin2bcd</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">rtc</span> <span class="o">=</span> <span class="n">rtc_device_register</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ds13xx_rtc_ops</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;unable to register the class device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">want_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ds1307_irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			  <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;unable to request IRQ!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit_irq</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">device_set_wakeup_capable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">HAS_ALARM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;got IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">nvram_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bin_attribute</span><span class="p">),</span>
							<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_nvram</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;nvram&quot;</span><span class="p">;</span>
		<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>
		<span class="n">sysfs_bin_attr_init</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
		<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">ds1307_nvram_read</span><span class="p">,</span>
		<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">ds1307_nvram_write</span><span class="p">,</span>
		<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">nvram_size</span><span class="p">;</span>
		<span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram_offset</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">nvram_offset</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit_nvram</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">HAS_NVRAM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%zu bytes nvram</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_nvram:</span>
<span class="nl">exit_irq:</span>
	<span class="n">rtc_device_unregister</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">);</span>
<span class="nl">exit_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ds1307</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">ds1307_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds1307</span> <span class="o">*</span><span class="n">ds1307</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HAS_ALARM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>
		<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HAS_NVRAM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sysfs_remove_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtc_device_unregister</span><span class="p">(</span><span class="n">ds1307</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ds1307</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">ds1307_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;rtc-ds1307&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ds1307_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ds1307_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">ds1307_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">ds1307_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;RTC driver for DS1307 and similar chips&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
