<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › rtc › interface.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>interface.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * RTC subsystem, interface functions</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005 Tower Technologies</span>
<span class="cm"> * Author: Alessandro Zummo &lt;a.zummo@towertech.it&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * based on arch/arm/common/rtctime.c</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/rtc.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/log2.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rtc_timer_enqueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rtc_timer_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__rtc_read_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_time</span> <span class="o">*</span><span class="n">tm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_time</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_time</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_time</span><span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">tm</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtc_read_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_time</span> <span class="o">*</span><span class="n">tm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__rtc_read_time</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="n">tm</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rtc_read_time</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rtc_set_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_time</span> <span class="o">*</span><span class="n">tm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rtc_valid_tm</span><span class="p">(</span><span class="n">tm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_time</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_time</span><span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">tm</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_mmss</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">secs</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rtc_tm_to_time</span><span class="p">(</span><span class="n">tm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">secs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_mmss</span><span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">secs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="cm">/* A timer might have just expired */</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irqwork</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rtc_set_time</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rtc_set_mmss</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">secs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_mmss</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_mmss</span><span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">secs</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_time</span> <span class="o">&amp;&amp;</span> <span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_time</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rtc_time</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_time</span><span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtc_time_to_tm</span><span class="p">(</span><span class="n">secs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * avoid writing when we&#39;re going to change the day of</span>
<span class="cm">			 * the month. We will retry in the next minute. This</span>
<span class="cm">			 * basically means that if the RTC must not drift</span>
<span class="cm">			 * by more than 1 minute in 11 minutes.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">old</span><span class="p">.</span><span class="n">tm_hour</span> <span class="o">==</span> <span class="mi">23</span> <span class="o">&amp;&amp;</span> <span class="n">old</span><span class="p">.</span><span class="n">tm_min</span> <span class="o">==</span> <span class="mi">59</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">new</span><span class="p">.</span><span class="n">tm_hour</span> <span class="o">==</span> <span class="mi">23</span> <span class="o">&amp;&amp;</span> <span class="n">new</span><span class="p">.</span><span class="n">tm_min</span> <span class="o">==</span> <span class="mi">59</span><span class="p">)))</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_time</span><span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">new</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="cm">/* A timer might have just expired */</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irqwork</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rtc_set_mmss</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtc_read_alarm_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_wkalrm</span> <span class="o">*</span><span class="n">alarm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_alarm</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">alarm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_wkalrm</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_alarm</span><span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">alarm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__rtc_read_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_wkalrm</span> <span class="o">*</span><span class="n">alarm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtc_time</span> <span class="n">before</span><span class="p">,</span> <span class="n">now</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first_time</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t_now</span><span class="p">,</span> <span class="n">t_alm</span><span class="p">;</span>
	<span class="k">enum</span> <span class="p">{</span> <span class="n">none</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">year</span> <span class="p">}</span> <span class="n">missing</span> <span class="o">=</span> <span class="n">none</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">days</span><span class="p">;</span>

	<span class="cm">/* The lower level RTC driver may return -1 in some fields,</span>
<span class="cm">	 * creating invalid alarm-&gt;time values, for reasons like:</span>
<span class="cm">	 *</span>
<span class="cm">	 *   - The hardware may not be capable of filling them in;</span>
<span class="cm">	 *     many alarms match only on time-of-day fields, not</span>
<span class="cm">	 *     day/month/year calendar data.</span>
<span class="cm">	 *</span>
<span class="cm">	 *   - Some hardware uses illegal values as &quot;wildcard&quot; match</span>
<span class="cm">	 *     values, which non-Linux firmware (like a BIOS) may try</span>
<span class="cm">	 *     to set up as e.g. &quot;alarm 15 minutes after each hour&quot;.</span>
<span class="cm">	 *     Linux uses only oneshot alarms.</span>
<span class="cm">	 *</span>
<span class="cm">	 * When we see that here, we deal with it by using values from</span>
<span class="cm">	 * a current RTC timestamp for any missing (-1) values.  The</span>
<span class="cm">	 * RTC driver prevents &quot;periodic alarm&quot; modes.</span>
<span class="cm">	 *</span>
<span class="cm">	 * But this can be racey, because some fields of the RTC timestamp</span>
<span class="cm">	 * may have wrapped in the interval since we read the RTC alarm,</span>
<span class="cm">	 * which would lead to us inserting inconsistent values in place</span>
<span class="cm">	 * of the -1 fields.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Reading the alarm and timestamp in the reverse sequence</span>
<span class="cm">	 * would have the same race condition, and not solve the issue.</span>
<span class="cm">	 *</span>
<span class="cm">	 * So, we must first read the RTC timestamp,</span>
<span class="cm">	 * then read the RTC alarm value,</span>
<span class="cm">	 * and then read a second RTC timestamp.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If any fields of the second timestamp have changed</span>
<span class="cm">	 * when compared with the first timestamp, then we know</span>
<span class="cm">	 * our timestamp may be inconsistent with that used by</span>
<span class="cm">	 * the low-level rtc_read_alarm_internal() function.</span>
<span class="cm">	 *</span>
<span class="cm">	 * So, when the two timestamps disagree, we just loop and do</span>
<span class="cm">	 * the process again to get a fully consistent set of values.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This could all instead be done in the lower level driver,</span>
<span class="cm">	 * but since more than one lower level RTC implementation needs it,</span>
<span class="cm">	 * then it&#39;s probably best best to do it here instead of there..</span>
<span class="cm">	 */</span>

	<span class="cm">/* Get the &quot;before&quot; timestamp */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rtc_read_time</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">before</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first_time</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">before</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">now</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_time</span><span class="p">));</span>
		<span class="n">first_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* get the RTC alarm values, which may be incomplete */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rtc_read_alarm_internal</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="n">alarm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/* full-function RTCs won&#39;t have such missing fields */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtc_valid_tm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* get the &quot;after&quot; timestamp, to detect wrapped fields */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rtc_read_time</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/* note that tm_sec is a &quot;don&#39;t care&quot; value here: */</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span>   <span class="n">before</span><span class="p">.</span><span class="n">tm_min</span>   <span class="o">!=</span> <span class="n">now</span><span class="p">.</span><span class="n">tm_min</span>
		 <span class="o">||</span> <span class="n">before</span><span class="p">.</span><span class="n">tm_hour</span>  <span class="o">!=</span> <span class="n">now</span><span class="p">.</span><span class="n">tm_hour</span>
		 <span class="o">||</span> <span class="n">before</span><span class="p">.</span><span class="n">tm_mon</span>   <span class="o">!=</span> <span class="n">now</span><span class="p">.</span><span class="n">tm_mon</span>
		 <span class="o">||</span> <span class="n">before</span><span class="p">.</span><span class="n">tm_year</span>  <span class="o">!=</span> <span class="n">now</span><span class="p">.</span><span class="n">tm_year</span><span class="p">);</span>

	<span class="cm">/* Fill in the missing alarm fields using the timestamp; we</span>
<span class="cm">	 * know there&#39;s at least one since alarm-&gt;time is invalid.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_sec</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_sec</span> <span class="o">=</span> <span class="n">now</span><span class="p">.</span><span class="n">tm_sec</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_min</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_min</span> <span class="o">=</span> <span class="n">now</span><span class="p">.</span><span class="n">tm_min</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_hour</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_hour</span> <span class="o">=</span> <span class="n">now</span><span class="p">.</span><span class="n">tm_hour</span><span class="p">;</span>

	<span class="cm">/* For simplicity, only support date rollover for now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mday</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mday</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mday</span> <span class="o">=</span> <span class="n">now</span><span class="p">.</span><span class="n">tm_mday</span><span class="p">;</span>
		<span class="n">missing</span> <span class="o">=</span> <span class="n">day</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mon</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mon</span> <span class="o">=</span> <span class="n">now</span><span class="p">.</span><span class="n">tm_mon</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">missing</span> <span class="o">==</span> <span class="n">none</span><span class="p">)</span>
			<span class="n">missing</span> <span class="o">=</span> <span class="n">month</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">=</span> <span class="n">now</span><span class="p">.</span><span class="n">tm_year</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">missing</span> <span class="o">==</span> <span class="n">none</span><span class="p">)</span>
			<span class="n">missing</span> <span class="o">=</span> <span class="n">year</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* with luck, no rollover is needed */</span>
	<span class="n">rtc_tm_to_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t_now</span><span class="p">);</span>
	<span class="n">rtc_tm_to_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t_alm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t_now</span> <span class="o">&lt;</span> <span class="n">t_alm</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="p">{</span>

	<span class="cm">/* 24 hour rollover ... if it&#39;s now 10am Monday, an alarm that</span>
<span class="cm">	 * that will trigger at 5am will do so at 5am Tuesday, which</span>
<span class="cm">	 * could also be in the next month or year.  This is a common</span>
<span class="cm">	 * case, especially for PCs.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">day</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;alarm rollover: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;day&quot;</span><span class="p">);</span>
		<span class="n">t_alm</span> <span class="o">+=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>
		<span class="n">rtc_time_to_tm</span><span class="p">(</span><span class="n">t_alm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* Month rollover ... if it&#39;s the 31th, an alarm on the 3rd will</span>
<span class="cm">	 * be next month.  An alarm matching on the 30th, 29th, or 28th</span>
<span class="cm">	 * may end up in the month after that!  Many newer PCs support</span>
<span class="cm">	 * this type of alarm.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">month</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;alarm rollover: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;month&quot;</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mon</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">)</span>
				<span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mon</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_year</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">days</span> <span class="o">=</span> <span class="n">rtc_month_days</span><span class="p">(</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mon</span><span class="p">,</span>
					<span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_year</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">days</span> <span class="o">&lt;</span> <span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_mday</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* Year rollover ... easy except for leap years! */</span>
	<span class="k">case</span> <span class="n">year</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;alarm rollover: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;year&quot;</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tm_year</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rtc_valid_tm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;alarm rollover not handled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtc_read_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_wkalrm</span> <span class="o">*</span><span class="n">alarm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_alarm</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">alarm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_wkalrm</span><span class="p">));</span>
		<span class="n">alarm</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">rtc</span><span class="o">-&gt;</span><span class="n">aie_timer</span><span class="p">.</span><span class="n">enabled</span><span class="p">;</span>
		<span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="n">rtc_ktime_to_tm</span><span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">aie_timer</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">expires</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rtc_read_alarm</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__rtc_set_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_wkalrm</span> <span class="o">*</span><span class="n">alarm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtc_time</span> <span class="n">tm</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">now</span><span class="p">,</span> <span class="n">scheduled</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rtc_valid_tm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">rtc_tm_to_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scheduled</span><span class="p">);</span>

	<span class="cm">/* Make sure we&#39;re not setting alarms in the past */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__rtc_read_time</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tm</span><span class="p">);</span>
	<span class="n">rtc_tm_to_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scheduled</span> <span class="o">&lt;=</span> <span class="n">now</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * XXX - We just checked to make sure the alarm time is not</span>
<span class="cm">	 * in the past, but there is still a race window where if</span>
<span class="cm">	 * the is alarm set for the next second and the second ticks</span>
<span class="cm">	 * over right here, before we set the alarm.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_alarm</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_alarm</span><span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">alarm</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtc_set_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_wkalrm</span> <span class="o">*</span><span class="n">alarm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rtc_valid_tm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">aie_timer</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtc_timer_remove</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">aie_timer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtc</span><span class="o">-&gt;</span><span class="n">aie_timer</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">rtc_tm_to_ktime</span><span class="p">(</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">);</span>
	<span class="n">rtc</span><span class="o">-&gt;</span><span class="n">aie_timer</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">ktime_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rtc_timer_enqueue</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">aie_timer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rtc_set_alarm</span><span class="p">);</span>

<span class="cm">/* Called once per device from rtc_device_register */</span>
<span class="kt">int</span> <span class="nf">rtc_initialize_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_wkalrm</span> <span class="o">*</span><span class="n">alarm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtc_time</span> <span class="n">now</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rtc_valid_tm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rtc_read_time</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rtc</span><span class="o">-&gt;</span><span class="n">aie_timer</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">rtc_tm_to_ktime</span><span class="p">(</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">);</span>
	<span class="n">rtc</span><span class="o">-&gt;</span><span class="n">aie_timer</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">ktime_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Alarm has to be enabled &amp; in the futrure for us to enqueue it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alarm</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtc_tm_to_ktime</span><span class="p">(</span><span class="n">now</span><span class="p">).</span><span class="n">tv64</span> <span class="o">&lt;</span>
			 <span class="n">rtc</span><span class="o">-&gt;</span><span class="n">aie_timer</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">expires</span><span class="p">.</span><span class="n">tv64</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">rtc</span><span class="o">-&gt;</span><span class="n">aie_timer</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">timerqueue_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">timerqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">aie_timer</span><span class="p">.</span><span class="n">node</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rtc_initialize_alarm</span><span class="p">);</span>



<span class="kt">int</span> <span class="nf">rtc_alarm_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">aie_timer</span><span class="p">.</span><span class="n">enabled</span> <span class="o">!=</span> <span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">rtc_timer_enqueue</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">aie_timer</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rtc_timer_remove</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">aie_timer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="cm">/* nothing */</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">alarm_irq_enable</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">alarm_irq_enable</span><span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">enabled</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rtc_alarm_irq_enable</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rtc_update_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_RTC_INTF_DEV_UIE_EMUL</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rtc</span><span class="o">-&gt;</span><span class="n">uie_irq_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rtc_dev_update_irq_enable_emul</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* make sure we&#39;re changing state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">uie_rtctimer</span><span class="p">.</span><span class="n">enabled</span> <span class="o">==</span> <span class="n">enabled</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">uie_unsupported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rtc_time</span> <span class="n">tm</span><span class="p">;</span>
		<span class="n">ktime_t</span> <span class="n">now</span><span class="p">,</span> <span class="n">onesec</span><span class="p">;</span>

		<span class="n">__rtc_read_time</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tm</span><span class="p">);</span>
		<span class="n">onesec</span> <span class="o">=</span> <span class="n">ktime_set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">now</span> <span class="o">=</span> <span class="n">rtc_tm_to_ktime</span><span class="p">(</span><span class="n">tm</span><span class="p">);</span>
		<span class="n">rtc</span><span class="o">-&gt;</span><span class="n">uie_rtctimer</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">ktime_add</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">onesec</span><span class="p">);</span>
		<span class="n">rtc</span><span class="o">-&gt;</span><span class="n">uie_rtctimer</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">ktime_set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rtc_timer_enqueue</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">uie_rtctimer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rtc_timer_remove</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">uie_rtctimer</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_RTC_INTF_DEV_UIE_EMUL</span>
	<span class="cm">/*</span>
<span class="cm">	 * Enable emulation if the driver did not provide</span>
<span class="cm">	 * the update_irq_enable function pointer or if returned</span>
<span class="cm">	 * -EINVAL to signal that it has been configured without</span>
<span class="cm">	 * interrupts or that are not available at the moment.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rtc_dev_update_irq_enable_emul</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="n">enabled</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rtc_update_irq_enable</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> * rtc_handle_legacy_irq - AIE, UIE and PIE event hook</span>
<span class="cm"> * @rtc: pointer to the rtc device</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called when an AIE, UIE or PIE mode interrupt</span>
<span class="cm"> * has occurred (or been emulated).</span>
<span class="cm"> *</span>
<span class="cm"> * Triggers the registered irq_task function callback.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rtc_handle_legacy_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* mark one irq of the appropriate mode */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_data</span> <span class="o">+</span> <span class="p">(</span><span class="n">num</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">RTC_IRQF</span><span class="o">|</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* call the task func */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task</span><span class="p">)</span>
		<span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_queue</span><span class="p">);</span>
	<span class="n">kill_fasync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">async_queue</span><span class="p">,</span> <span class="n">SIGIO</span><span class="p">,</span> <span class="n">POLL_IN</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * rtc_aie_update_irq - AIE mode rtctimer hook</span>
<span class="cm"> * @private: pointer to the rtc_device</span>
<span class="cm"> *</span>
<span class="cm"> * This functions is called when the aie_timer expires.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rtc_aie_update_irq</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">private</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="p">)</span><span class="n">private</span><span class="p">;</span>
	<span class="n">rtc_handle_legacy_irq</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">RTC_AF</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * rtc_uie_update_irq - UIE mode rtctimer hook</span>
<span class="cm"> * @private: pointer to the rtc_device</span>
<span class="cm"> *</span>
<span class="cm"> * This functions is called when the uie_timer expires.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rtc_uie_update_irq</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">private</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="p">)</span><span class="n">private</span><span class="p">;</span>
	<span class="n">rtc_handle_legacy_irq</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="n">RTC_UF</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * rtc_pie_update_irq - PIE mode hrtimer hook</span>
<span class="cm"> * @timer: pointer to the pie mode hrtimer</span>
<span class="cm"> *</span>
<span class="cm"> * This function is used to emulate PIE mode interrupts</span>
<span class="cm"> * using an hrtimer. This function is called when the periodic</span>
<span class="cm"> * hrtimer expires.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">hrtimer_restart</span> <span class="nf">rtc_pie_update_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">hrtimer</span> <span class="o">*</span><span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">;</span>
	<span class="n">ktime_t</span> <span class="n">period</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">rtc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_device</span><span class="p">,</span> <span class="n">pie_timer</span><span class="p">);</span>

	<span class="n">period</span> <span class="o">=</span> <span class="n">ktime_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NSEC_PER_SEC</span><span class="o">/</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_freq</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">hrtimer_forward_now</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="n">period</span><span class="p">);</span>

	<span class="n">rtc_handle_legacy_irq</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">RTC_PF</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">HRTIMER_RESTART</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rtc_update_irq - Triggered when a RTC interrupt occurs.</span>
<span class="cm"> * @rtc: the rtc device</span>
<span class="cm"> * @num: how many irqs are being reported (usually one)</span>
<span class="cm"> * @events: mask of RTC_IRQF with one or more of RTC_PF, RTC_AF, RTC_UF</span>
<span class="cm"> * Context: any</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rtc_update_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">events</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irqwork</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rtc_update_irq</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__rtc_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="nf">rtc_class_open</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">class_find_device</span><span class="p">(</span><span class="n">rtc_class</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">__rtc_match</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">rtc</span> <span class="o">=</span> <span class="n">to_rtc_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">rtc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rtc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rtc_class_open</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rtc_class_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rtc_class_close</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rtc_irq_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Cannot register while the char dev is in use */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit_lock</span><span class="p">(</span><span class="n">RTC_DEV_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task</span> <span class="o">=</span> <span class="n">task</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task_lock</span><span class="p">);</span>

	<span class="n">clear_bit_unlock</span><span class="p">(</span><span class="n">RTC_DEV_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rtc_irq_register</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rtc_irq_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task</span> <span class="o">==</span> <span class="n">task</span><span class="p">)</span>
		<span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rtc_irq_unregister</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtc_update_hrtimer</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We always cancel the timer here first, because otherwise</span>
<span class="cm">	 * we could run into BUG_ON(timer-&gt;state != HRTIMER_STATE_CALLBACK);</span>
<span class="cm">	 * when we manage to start the timer before the callback</span>
<span class="cm">	 * returns HRTIMER_RESTART.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We cannot use hrtimer_cancel() here as a running callback</span>
<span class="cm">	 * could be blocked on rtc-&gt;irq_task_lock and hrtimer_cancel()</span>
<span class="cm">	 * would spin forever.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hrtimer_try_to_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">pie_timer</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ktime_t</span> <span class="n">period</span> <span class="o">=</span> <span class="n">ktime_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NSEC_PER_SEC</span> <span class="o">/</span> <span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_freq</span><span class="p">);</span>

		<span class="n">hrtimer_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">pie_timer</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">HRTIMER_MODE_REL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rtc_irq_set_state - enable/disable 2^N Hz periodic IRQs</span>
<span class="cm"> * @rtc: the rtc device</span>
<span class="cm"> * @task: currently registered with rtc_irq_register()</span>
<span class="cm"> * @enabled: true to enable periodic IRQs</span>
<span class="cm"> * Context: any</span>
<span class="cm"> *</span>
<span class="cm"> * Note that rtc_irq_set_freq() should previously have been used to</span>
<span class="cm"> * specify the desired frequency of periodic IRQ task-&gt;func() callbacks.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rtc_irq_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="nl">retry:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">task</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task</span> <span class="o">!=</span> <span class="n">task</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtc_update_hrtimer</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="n">enabled</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rtc</span><span class="o">-&gt;</span><span class="n">pie_enabled</span> <span class="o">=</span> <span class="n">enabled</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rtc_irq_set_state</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * rtc_irq_set_freq - set 2^N Hz periodic IRQ frequency for IRQ</span>
<span class="cm"> * @rtc: the rtc device</span>
<span class="cm"> * @task: currently registered with rtc_irq_register()</span>
<span class="cm"> * @freq: positive frequency with which task-&gt;func() will be called</span>
<span class="cm"> * Context: any</span>
<span class="cm"> *</span>
<span class="cm"> * Note that rtc_irq_set_state() is used to enable or disable the</span>
<span class="cm"> * periodic IRQs.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rtc_irq_set_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">freq</span> <span class="o">&gt;</span> <span class="n">RTC_MAX_FREQ</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="nl">retry:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">task</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task</span> <span class="o">!=</span> <span class="n">task</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_freq</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">pie_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">rtc_update_hrtimer</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irq_task_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rtc_irq_set_freq</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * rtc_timer_enqueue - Adds a rtc_timer to the rtc_device timerqueue</span>
<span class="cm"> * @rtc rtc device</span>
<span class="cm"> * @timer timer being added.</span>
<span class="cm"> *</span>
<span class="cm"> * Enqueues a timer onto the rtc devices timerqueue and sets</span>
<span class="cm"> * the next alarm event appropriately.</span>
<span class="cm"> *</span>
<span class="cm"> * Sets the enabled bit on the added timer.</span>
<span class="cm"> *</span>
<span class="cm"> * Must hold ops_lock for proper serialization of timerqueue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtc_timer_enqueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">timerqueue_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">timerqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">==</span> <span class="n">timerqueue_getnext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">timerqueue</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rtc_wkalrm</span> <span class="n">alarm</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">alarm</span><span class="p">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">rtc_ktime_to_tm</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">.</span><span class="n">expires</span><span class="p">);</span>
		<span class="n">alarm</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__rtc_set_alarm</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alarm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">)</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irqwork</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">timerqueue_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">timerqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
			<span class="n">timer</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtc_alarm_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">||</span> <span class="o">!</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">alarm_irq_enable</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">alarm_irq_enable</span><span class="p">(</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rtc_timer_remove - Removes a rtc_timer from the rtc_device timerqueue</span>
<span class="cm"> * @rtc rtc device</span>
<span class="cm"> * @timer timer being removed.</span>
<span class="cm"> *</span>
<span class="cm"> * Removes a timer onto the rtc devices timerqueue and sets</span>
<span class="cm"> * the next alarm event appropriately.</span>
<span class="cm"> *</span>
<span class="cm"> * Clears the enabled bit on the removed timer.</span>
<span class="cm"> *</span>
<span class="cm"> * Must hold ops_lock for proper serialization of timerqueue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtc_timer_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timerqueue_node</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">timerqueue_getnext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">timerqueue</span><span class="p">);</span>
	<span class="n">timerqueue_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">timerqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rtc_wkalrm</span> <span class="n">alarm</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">timerqueue_getnext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">timerqueue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtc_alarm_disable</span><span class="p">(</span><span class="n">rtc</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">alarm</span><span class="p">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">rtc_ktime_to_tm</span><span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">);</span>
		<span class="n">alarm</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__rtc_set_alarm</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alarm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">)</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">irqwork</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rtc_timer_do_work - Expires rtc timers</span>
<span class="cm"> * @rtc rtc device</span>
<span class="cm"> * @timer timer being removed.</span>
<span class="cm"> *</span>
<span class="cm"> * Expires rtc timers. Reprograms next alarm event if needed.</span>
<span class="cm"> * Called via worktask.</span>
<span class="cm"> *</span>
<span class="cm"> * Serializes access to timerqueue via ops_lock mutex</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rtc_timer_do_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtc_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timerqueue_node</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="n">ktime_t</span> <span class="n">now</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtc_time</span> <span class="n">tm</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_device</span><span class="p">,</span> <span class="n">irqwork</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
<span class="nl">again:</span>
	<span class="n">__rtc_read_time</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tm</span><span class="p">);</span>
	<span class="n">now</span> <span class="o">=</span> <span class="n">rtc_tm_to_ktime</span><span class="p">(</span><span class="n">tm</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">next</span> <span class="o">=</span> <span class="n">timerqueue_getnext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">timerqueue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">.</span><span class="n">tv64</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">.</span><span class="n">tv64</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* expire timer */</span>
		<span class="n">timer</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_timer</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">timerqueue_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">timerqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">timer</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">.</span><span class="n">func</span><span class="p">)</span>
			<span class="n">timer</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">.</span><span class="n">func</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">.</span><span class="n">private_data</span><span class="p">);</span>

		<span class="cm">/* Re-add/fwd periodic timers */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">timer</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">ktime_add</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">.</span><span class="n">expires</span><span class="p">,</span>
							<span class="n">timer</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">);</span>
			<span class="n">timer</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">timerqueue_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">timerqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set next alarm */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rtc_wkalrm</span> <span class="n">alarm</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">alarm</span><span class="p">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">rtc_ktime_to_tm</span><span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">);</span>
		<span class="n">alarm</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__rtc_set_alarm</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alarm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rtc_alarm_disable</span><span class="p">(</span><span class="n">rtc</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* rtc_timer_init - Initializes an rtc_timer</span>
<span class="cm"> * @timer: timer to be intiialized</span>
<span class="cm"> * @f: function pointer to be called when timer fires</span>
<span class="cm"> * @data: private data passed to function pointer</span>
<span class="cm"> *</span>
<span class="cm"> * Kernel interface to initializing an rtc_timer.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rtc_timer_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span> <span class="n">p</span><span class="p">),</span> <span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">timerqueue_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* rtc_timer_start - Sets an rtc_timer to fire in the future</span>
<span class="cm"> * @ rtc: rtc device to be used</span>
<span class="cm"> * @ timer: timer being set</span>
<span class="cm"> * @ expires: time at which to expire the timer</span>
<span class="cm"> * @ period: period that the timer will recur</span>
<span class="cm"> *</span>
<span class="cm"> * Kernel interface to set an rtc_timer</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rtc_timer_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_timer</span><span class="o">*</span> <span class="n">timer</span><span class="p">,</span>
			<span class="n">ktime_t</span> <span class="n">expires</span><span class="p">,</span> <span class="n">ktime_t</span> <span class="n">period</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">rtc_timer_remove</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="n">timer</span><span class="p">);</span>

	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">expires</span><span class="p">;</span>
	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rtc_timer_enqueue</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="n">timer</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* rtc_timer_cancel - Stops an rtc_timer</span>
<span class="cm"> * @ rtc: rtc device to be used</span>
<span class="cm"> * @ timer: timer being set</span>
<span class="cm"> *</span>
<span class="cm"> * Kernel interface to cancel an rtc_timer</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rtc_timer_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_timer</span><span class="o">*</span> <span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">rtc_timer_remove</span><span class="p">(</span><span class="n">rtc</span><span class="p">,</span> <span class="n">timer</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc</span><span class="o">-&gt;</span><span class="n">ops_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
