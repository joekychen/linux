<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › rtc › rtc-pcf8563.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>rtc-pcf8563.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * An I2C driver for the Philips PCF8563 RTC</span>
<span class="cm"> * Copyright 2005-06 Tower Technologies</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Alessandro Zummo &lt;a.zummo@towertech.it&gt;</span>
<span class="cm"> * Maintainers: http://www.nslu2-linux.org/</span>
<span class="cm"> *</span>
<span class="cm"> * based on the other drivers in this same directory.</span>
<span class="cm"> *</span>
<span class="cm"> * http://www.semiconductors.philips.com/acrobat/datasheets/PCF8563-04.pdf</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/bcd.h&gt;</span>
<span class="cp">#include &lt;linux/rtc.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#define DRV_VERSION &quot;0.4.3&quot;</span>

<span class="cp">#define PCF8563_REG_ST1		0x00 </span><span class="cm">/* status */</span><span class="cp"></span>
<span class="cp">#define PCF8563_REG_ST2		0x01</span>

<span class="cp">#define PCF8563_REG_SC		0x02 </span><span class="cm">/* datetime */</span><span class="cp"></span>
<span class="cp">#define PCF8563_REG_MN		0x03</span>
<span class="cp">#define PCF8563_REG_HR		0x04</span>
<span class="cp">#define PCF8563_REG_DM		0x05</span>
<span class="cp">#define PCF8563_REG_DW		0x06</span>
<span class="cp">#define PCF8563_REG_MO		0x07</span>
<span class="cp">#define PCF8563_REG_YR		0x08</span>

<span class="cp">#define PCF8563_REG_AMN		0x09 </span><span class="cm">/* alarm */</span><span class="cp"></span>
<span class="cp">#define PCF8563_REG_AHR		0x0A</span>
<span class="cp">#define PCF8563_REG_ADM		0x0B</span>
<span class="cp">#define PCF8563_REG_ADW		0x0C</span>

<span class="cp">#define PCF8563_REG_CLKO	0x0D </span><span class="cm">/* clock out */</span><span class="cp"></span>
<span class="cp">#define PCF8563_REG_TMRC	0x0E </span><span class="cm">/* timer control */</span><span class="cp"></span>
<span class="cp">#define PCF8563_REG_TMR		0x0F </span><span class="cm">/* timer */</span><span class="cp"></span>

<span class="cp">#define PCF8563_SC_LV		0x80 </span><span class="cm">/* low voltage */</span><span class="cp"></span>
<span class="cp">#define PCF8563_MO_C		0x80 </span><span class="cm">/* century */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">pcf8563_driver</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">pcf8563</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * The meaning of MO_C bit varies by the chip type.</span>
<span class="cm">	 * From PCF8563 datasheet: this bit is toggled when the years</span>
<span class="cm">	 * register overflows from 99 to 00</span>
<span class="cm">	 *   0 indicates the century is 20xx</span>
<span class="cm">	 *   1 indicates the century is 19xx</span>
<span class="cm">	 * From RTC8564 datasheet: this bit indicates change of</span>
<span class="cm">	 * century. When the year digit data overflows from 99 to 00,</span>
<span class="cm">	 * this bit is set. By presetting it to 0 while still in the</span>
<span class="cm">	 * 20th century, it will be set in year 2000, ...</span>
<span class="cm">	 * There seems no reliable way to know how the system use this</span>
<span class="cm">	 * bit.  So let&#39;s do it heuristically, assuming we are live in</span>
<span class="cm">	 * 1970...2069.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">c_polarity</span><span class="p">;</span>	<span class="cm">/* 0: MO_C=1 means 19xx, otherwise MO_C=1 means 20xx */</span>
	<span class="kt">int</span> <span class="n">voltage_low</span><span class="p">;</span> <span class="cm">/* incicates if a low_voltage was detected */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * In the routines that deal directly with the pcf8563 hardware, we use</span>
<span class="cm"> * rtc_time -- month 0-11, hour 0-23, yr = calendar year-epoch.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcf8563_get_datetime</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_time</span> <span class="o">*</span><span class="n">tm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcf8563</span> <span class="o">*</span><span class="n">pcf8563</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">PCF8563_REG_ST1</span> <span class="p">};</span>

	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buf</span> <span class="p">},</span>	<span class="cm">/* setup read ptr */</span>
		<span class="p">{</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">I2C_M_RD</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">buf</span> <span class="p">},</span>	<span class="cm">/* read status + date */</span>
	<span class="p">};</span>

	<span class="cm">/* read registers */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">PCF8563_REG_SC</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PCF8563_SC_LV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcf8563</span><span class="o">-&gt;</span><span class="n">voltage_low</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;low voltage detected, date/time is not reliable.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s: raw data is st1=%02x, st2=%02x, sec=%02x, min=%02x, hr=%02x, &quot;</span>
		<span class="s">&quot;mday=%02x, wday=%02x, mon=%02x, year=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>


	<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_sec</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">PCF8563_REG_SC</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">);</span>
	<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_min</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">PCF8563_REG_MN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">);</span>
	<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_hour</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">PCF8563_REG_HR</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span> <span class="cm">/* rtc hr 0-23 */</span>
	<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_mday</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">PCF8563_REG_DM</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span>
	<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_wday</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">PCF8563_REG_DW</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_mon</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">PCF8563_REG_MO</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* rtc mn 1-12 */</span>
	<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">PCF8563_REG_YR</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">&lt;</span> <span class="mi">70</span><span class="p">)</span>
		<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">+=</span> <span class="mi">100</span><span class="p">;</span>	<span class="cm">/* assume we are in 1970...2069 */</span>
	<span class="cm">/* detect the polarity heuristically. see note above. */</span>
	<span class="n">pcf8563</span><span class="o">-&gt;</span><span class="n">c_polarity</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">PCF8563_REG_MO</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PCF8563_MO_C</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">(</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: tm is secs=%d, mins=%d, hours=%d, &quot;</span>
		<span class="s">&quot;mday=%d, mon=%d, year=%d, wday=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_sec</span><span class="p">,</span> <span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_min</span><span class="p">,</span> <span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_hour</span><span class="p">,</span>
		<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_mday</span><span class="p">,</span> <span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_mon</span><span class="p">,</span> <span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_year</span><span class="p">,</span> <span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_wday</span><span class="p">);</span>

	<span class="cm">/* the clock can give out invalid datetime, but we cannot return</span>
<span class="cm">	 * -EINVAL otherwise hwclock will refuse to set the time on bootup.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtc_valid_tm</span><span class="p">(</span><span class="n">tm</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;retrieved date/time is not valid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcf8563_set_datetime</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_time</span> <span class="o">*</span><span class="n">tm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcf8563</span> <span class="o">*</span><span class="n">pcf8563</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: secs=%d, mins=%d, hours=%d, &quot;</span>
		<span class="s">&quot;mday=%d, mon=%d, year=%d, wday=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_sec</span><span class="p">,</span> <span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_min</span><span class="p">,</span> <span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_hour</span><span class="p">,</span>
		<span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_mday</span><span class="p">,</span> <span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_mon</span><span class="p">,</span> <span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_year</span><span class="p">,</span> <span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_wday</span><span class="p">);</span>

	<span class="cm">/* hours, minutes and seconds */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">PCF8563_REG_SC</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_sec</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">PCF8563_REG_MN</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_min</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">PCF8563_REG_HR</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_hour</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="n">PCF8563_REG_DM</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_mday</span><span class="p">);</span>

	<span class="cm">/* month, 1 - 12 */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">PCF8563_REG_MO</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_mon</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* year and century */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">PCF8563_REG_YR</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">%</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcf8563</span><span class="o">-&gt;</span><span class="n">c_polarity</span> <span class="o">?</span> <span class="p">(</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_year</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">))</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">PCF8563_REG_MO</span><span class="p">]</span> <span class="o">|=</span> <span class="n">PCF8563_MO_C</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="n">PCF8563_REG_DW</span><span class="p">]</span> <span class="o">=</span> <span class="n">tm</span><span class="o">-&gt;</span><span class="n">tm_wday</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>

	<span class="cm">/* write register&#39;s data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">PCF8563_REG_SC</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
						<span class="n">buf</span><span class="p">[</span><span class="n">PCF8563_REG_SC</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="p">};</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_master_send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: err=%d addr=%02x, data=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_RTC_INTF_DEV</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcf8563_rtc_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcf8563</span> <span class="o">*</span><span class="n">pcf8563</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">rtc_time</span> <span class="n">tm</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTC_VL_READ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pcf8563</span><span class="o">-&gt;</span><span class="n">voltage_low</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;low voltage detected, date/time is not reliable.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcf8563</span><span class="o">-&gt;</span><span class="n">voltage_low</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTC_VL_CLR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Clear the VL bit in the seconds register in case</span>
<span class="cm">		 * the time has not been set already (which would</span>
<span class="cm">		 * have cleared it). This does not really matter</span>
<span class="cm">		 * because of the cached voltage_low value but do it</span>
<span class="cm">		 * anyway for consistency.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcf8563_get_datetime</span><span class="p">(</span><span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tm</span><span class="p">))</span>
			<span class="n">pcf8563_set_datetime</span><span class="p">(</span><span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tm</span><span class="p">);</span>

		<span class="cm">/* Clear the cached value. */</span>
		<span class="n">pcf8563</span><span class="o">-&gt;</span><span class="n">voltage_low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define pcf8563_rtc_ioctl NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcf8563_rtc_read_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_time</span> <span class="o">*</span><span class="n">tm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pcf8563_get_datetime</span><span class="p">(</span><span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">tm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcf8563_rtc_set_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtc_time</span> <span class="o">*</span><span class="n">tm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pcf8563_set_datetime</span><span class="p">(</span><span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">tm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rtc_class_ops</span> <span class="n">pcf8563_rtc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span> <span class="n">pcf8563_rtc_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_time</span>	<span class="o">=</span> <span class="n">pcf8563_rtc_read_time</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_time</span>	<span class="o">=</span> <span class="n">pcf8563_rtc_set_time</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcf8563_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcf8563</span> <span class="o">*</span><span class="n">pcf8563</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_I2C</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pcf8563</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcf8563</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcf8563</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;chip found, driver version &quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">pcf8563</span><span class="p">);</span>

	<span class="n">pcf8563</span><span class="o">-&gt;</span><span class="n">rtc</span> <span class="o">=</span> <span class="n">rtc_device_register</span><span class="p">(</span><span class="n">pcf8563_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcf8563_rtc_ops</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pcf8563</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pcf8563</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_kfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_kfree:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pcf8563</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcf8563_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcf8563</span> <span class="o">*</span><span class="n">pcf8563</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcf8563</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">)</span>
		<span class="n">rtc_device_unregister</span><span class="p">(</span><span class="n">pcf8563</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pcf8563</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">pcf8563_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;pcf8563&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rtc8564&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">pcf8563_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">pcf8563_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;rtc-pcf8563&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">pcf8563_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">pcf8563_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">pcf8563_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">pcf8563_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Alessandro Zummo &lt;a.zummo@towertech.it&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Philips PCF8563/Epson RTC8564 RTC driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
