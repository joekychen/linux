<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › cpufreq › powernow-k8.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>powernow-k8.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   (c) 2003-2012 Advanced Micro Devices, Inc.</span>
<span class="cm"> *  Your use of this code is subject to the terms and conditions of the</span>
<span class="cm"> *  GNU general public license version 2. See &quot;COPYING&quot; or</span>
<span class="cm"> *  http://www.gnu.org/licenses/gpl.html</span>
<span class="cm"> *</span>
<span class="cm"> *  Maintainer:</span>
<span class="cm"> *  Andreas Herrmann &lt;andreas.herrmann3@amd.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Based on the powernow-k7.c module written by Dave Jones.</span>
<span class="cm"> *  (C) 2003 Dave Jones on behalf of SuSE Labs</span>
<span class="cm"> *  (C) 2004 Dominik Brodowski &lt;linux@brodo.de&gt;</span>
<span class="cm"> *  (C) 2004 Pavel Machek &lt;pavel@ucw.cz&gt;</span>
<span class="cm"> *  Licensed under the terms of the GNU GPL License version 2.</span>
<span class="cm"> *  Based upon datasheets &amp; sample CPUs kindly provided by AMD.</span>
<span class="cm"> *</span>
<span class="cm"> *  Valuable input gratefully received from Dave Jones, Pavel Machek,</span>
<span class="cm"> *  Dominik Brodowski, Jacob Shin, and others.</span>
<span class="cm"> *  Originally developed by Paul Devriendt.</span>
<span class="cm"> *</span>
<span class="cm"> *  Processor information obtained from Chapter 9 (Power and Thermal</span>
<span class="cm"> *  Management) of the &quot;BIOS and Kernel Developer&#39;s Guide (BKDG) for</span>
<span class="cm"> *  the AMD Athlon 64 and AMD Opteron Processors&quot; and section &quot;2.x</span>
<span class="cm"> *  Power Management&quot; in BKDGs for newer AMD CPU families.</span>
<span class="cm"> *</span>
<span class="cm"> *  Tables for specific CPUs can be inferred from AMD&#39;s processor</span>
<span class="cm"> *  power and thermal data sheets, (e.g. 30417.pdf, 30430.pdf, 43375.pdf)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/cpufreq.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/cpumask.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;	</span><span class="cm">/* for current / set_cpus_allowed() */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;asm/msr.h&gt;</span>
<span class="cp">#include &lt;asm/cpu_device_id.h&gt;</span>

<span class="cp">#include &lt;linux/acpi.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;acpi/processor.h&gt;</span>

<span class="cp">#define PFX &quot;powernow-k8: &quot;</span>
<span class="cp">#define VERSION &quot;version 2.20.00&quot;</span>
<span class="cp">#include &quot;powernow-k8.h&quot;</span>
<span class="cp">#include &quot;mperf.h&quot;</span>

<span class="cm">/* serialize freq changes  */</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">fidvid_mutex</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="p">,</span> <span class="n">powernow_data</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cpu_family</span> <span class="o">=</span> <span class="n">CPU_OPTERON</span><span class="p">;</span>

<span class="cm">/* array to map SW pstate number to acpi state */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">ps_to_as</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

<span class="cm">/* core performance boost */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">cpb_capable</span><span class="p">,</span> <span class="n">cpb_enabled</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">msr</span> <span class="n">__percpu</span> <span class="o">*</span><span class="n">msrs</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_driver</span> <span class="n">cpufreq_amd64_driver</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_SMP</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cpumask</span> <span class="o">*</span><span class="nf">cpu_core_mask</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cpumask_of</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Return a frequency in MHz, given an input fid */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">find_freq_from_fid</span><span class="p">(</span><span class="n">u32</span> <span class="n">fid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">800</span> <span class="o">+</span> <span class="p">(</span><span class="n">fid</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Return a frequency in KHz, given an input fid */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">find_khz_freq_from_fid</span><span class="p">(</span><span class="n">u32</span> <span class="n">fid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">find_freq_from_fid</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">find_khz_freq_from_pstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">pstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">ps_to_as</span><span class="p">[</span><span class="n">pstate</span><span class="p">]].</span><span class="n">frequency</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return the vco fid for an input fid</span>
<span class="cm"> *</span>
<span class="cm"> * Each &quot;low&quot; fid has corresponding &quot;high&quot; fid, and you can get to &quot;low&quot; fids</span>
<span class="cm"> * only from corresponding high fids. This returns &quot;high&quot; fid corresponding to</span>
<span class="cm"> * &quot;low&quot; one.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">convert_fid_to_vco_fid</span><span class="p">(</span><span class="n">u32</span> <span class="n">fid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fid</span> <span class="o">&lt;</span> <span class="n">HI_FID_TABLE_BOTTOM</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">8</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">fid</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">fid</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return 1 if the pending bit is set. Unless we just instructed the processor</span>
<span class="cm"> * to transition to a new state, seeing this bit set is really bad news.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pending_bit_stuck</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_family</span> <span class="o">==</span> <span class="n">CPU_HW_PSTATE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_FIDVID_STATUS</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">lo</span> <span class="o">&amp;</span> <span class="n">MSR_S_LO_CHANGE_PENDING</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update the global current fid / vid values from the status msr.</span>
<span class="cm"> * Returns 1 on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">query_current_values_with_pending_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_family</span> <span class="o">==</span> <span class="n">CPU_HW_PSTATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_PSTATE_STATUS</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">&amp;</span> <span class="n">HW_PSTATE_MASK</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">currpstate</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * a workaround for family 11h erratum 311 might cause</span>
<span class="cm">		 * an &quot;out-of-range Pstate if the core is in Pstate-0</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86</span> <span class="o">==</span> <span class="mh">0x11</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">numps</span><span class="p">))</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">currpstate</span> <span class="o">=</span> <span class="n">HW_PSTATE_0</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;detected change pending stuck</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_FIDVID_STATUS</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&amp;</span> <span class="n">MSR_S_LO_CHANGE_PENDING</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span> <span class="o">=</span> <span class="n">hi</span> <span class="o">&amp;</span> <span class="n">MSR_S_HI_CURRENT_VID</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">&amp;</span> <span class="n">MSR_S_LO_CURRENT_FID</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* the isochronous relief time */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">count_off_irt</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">udelay</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">irt</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* the voltage stabilization time */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">count_off_vst</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vstable</span> <span class="o">*</span> <span class="n">VST_UNITS_20US</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* need to init the control msr to a safe value (for each cpu) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fidvid_msr_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fid</span><span class="p">,</span> <span class="n">vid</span><span class="p">;</span>

	<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_FIDVID_STATUS</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
	<span class="n">vid</span> <span class="o">=</span> <span class="n">hi</span> <span class="o">&amp;</span> <span class="n">MSR_S_HI_CURRENT_VID</span><span class="p">;</span>
	<span class="n">fid</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">&amp;</span> <span class="n">MSR_S_LO_CURRENT_FID</span><span class="p">;</span>
	<span class="n">lo</span> <span class="o">=</span> <span class="n">fid</span> <span class="o">|</span> <span class="p">(</span><span class="n">vid</span> <span class="o">&lt;&lt;</span> <span class="n">MSR_C_LO_VID_SHIFT</span><span class="p">);</span>
	<span class="n">hi</span> <span class="o">=</span> <span class="n">MSR_C_HI_STP_GNT_BENIGN</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;cpu%d, init lo 0x%x, hi 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
	<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_FIDVID_CTL</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* write the new fid value along with the other control fields to the msr */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_new_fid</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">fid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lo</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">savevid</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">fid</span> <span class="o">&amp;</span> <span class="n">INVALID_FID_MASK</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span> <span class="o">&amp;</span> <span class="n">INVALID_VID_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;internal error - overflow on fid write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lo</span> <span class="o">=</span> <span class="n">fid</span><span class="p">;</span>
	<span class="n">lo</span> <span class="o">|=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span> <span class="o">&lt;&lt;</span> <span class="n">MSR_C_LO_VID_SHIFT</span><span class="p">);</span>
	<span class="n">lo</span> <span class="o">|=</span> <span class="n">MSR_C_LO_INIT_FID_VID</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;writing fid 0x%x, lo 0x%x, hi 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fid</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">plllock</span> <span class="o">*</span> <span class="n">PLL_LOCK_CONVERSION</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_FIDVID_CTL</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">plllock</span> <span class="o">*</span> <span class="n">PLL_LOCK_CONVERSION</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span>
				<span class="s">&quot;Hardware error - pending bit very stuck - &quot;</span>
				<span class="s">&quot;no further pstate changes possible</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">query_current_values_with_pending_wait</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>

	<span class="n">count_off_irt</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">savevid</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span>
			<span class="s">&quot;vid change on fid trans, old 0x%x, new 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">savevid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fid</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span>
			<span class="s">&quot;fid trans failed, fid 0x%x, curr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write a new vid to the hardware */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_new_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lo</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">savefid</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span> <span class="o">&amp;</span> <span class="n">INVALID_FID_MASK</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">vid</span> <span class="o">&amp;</span> <span class="n">INVALID_VID_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;internal error - overflow on vid write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lo</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">;</span>
	<span class="n">lo</span> <span class="o">|=</span> <span class="p">(</span><span class="n">vid</span> <span class="o">&lt;&lt;</span> <span class="n">MSR_C_LO_VID_SHIFT</span><span class="p">);</span>
	<span class="n">lo</span> <span class="o">|=</span> <span class="n">MSR_C_LO_INIT_FID_VID</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;writing vid 0x%x, lo 0x%x, hi 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">vid</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">STOP_GRANT_5NS</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_FIDVID_CTL</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">STOP_GRANT_5NS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;internal error - pending bit &quot;</span>
					<span class="s">&quot;very stuck - no further pstate &quot;</span>
					<span class="s">&quot;changes possible</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">query_current_values_with_pending_wait</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">savefid</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;fid changed on vid trans, old &quot;</span>
			<span class="s">&quot;0x%x new 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">savefid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vid</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;vid trans failed, vid 0x%x, &quot;</span>
				<span class="s">&quot;curr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">vid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reduce the vid by the max of step or reqvid.</span>
<span class="cm"> * Decreasing vid codes represent increasing voltages:</span>
<span class="cm"> * vid of 0 is 1.550V, vid of 0x1e is 0.800V, vid of VID_OFF is off.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">decrease_vid_code_by_step</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">reqvid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">step</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span> <span class="o">-</span> <span class="n">reqvid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">step</span><span class="p">)</span>
		<span class="n">reqvid</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span> <span class="o">-</span> <span class="n">step</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_new_vid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">reqvid</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">count_off_vst</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Change hardware pstate by single MSR write */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">transition_pstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_PSTATE_CTRL</span><span class="p">,</span> <span class="n">pstate</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">currpstate</span> <span class="o">=</span> <span class="n">pstate</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Change Opteron/Athlon64 fid and vid, by the 3 phases. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">transition_fid_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">reqfid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reqvid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core_voltage_pre_transition</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">reqvid</span><span class="p">,</span> <span class="n">reqfid</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core_frequency_transition</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">reqfid</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core_voltage_post_transition</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">reqvid</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">query_current_values_with_pending_wait</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">reqfid</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">reqvid</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;failed (cpu%d): req 0x%x 0x%x, &quot;</span>
				<span class="s">&quot;curr 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">smp_processor_id</span><span class="p">(),</span>
				<span class="n">reqfid</span><span class="p">,</span> <span class="n">reqvid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;transitioned (cpu%d): new fid 0x%x, vid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Phase 1 - core voltage transition ... setup voltage */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_voltage_pre_transition</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">reqvid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reqfid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rvosteps</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rvo</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">savefid</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">maxvid</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">rvomult</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ph1 (cpu%d): start, currfid 0x%x, currvid 0x%x, &quot;</span>
		<span class="s">&quot;reqvid 0x%x, rvo 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">smp_processor_id</span><span class="p">(),</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">,</span> <span class="n">reqvid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rvo</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">savefid</span> <span class="o">&lt;</span> <span class="n">LO_FID_TABLE_TOP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reqfid</span> <span class="o">&lt;</span> <span class="n">LO_FID_TABLE_TOP</span><span class="p">))</span>
		<span class="n">rvomult</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">rvosteps</span> <span class="o">*=</span> <span class="n">rvomult</span><span class="p">;</span>
	<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_FIDVID_STATUS</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">maxvid</span><span class="p">);</span>
	<span class="n">maxvid</span> <span class="o">=</span> <span class="mh">0x1f</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">maxvid</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ph1 maxvid=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">maxvid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reqvid</span> <span class="o">&lt;</span> <span class="n">maxvid</span><span class="p">)</span> <span class="cm">/* lower numbers are higher voltages */</span>
		<span class="n">reqvid</span> <span class="o">=</span> <span class="n">maxvid</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span> <span class="o">&gt;</span> <span class="n">reqvid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ph1: curr 0x%x, req vid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">,</span> <span class="n">reqvid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">decrease_vid_code_by_step</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">reqvid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">vidmvs</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">rvosteps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">rvomult</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rvo</span> <span class="o">+</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">reqvid</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span> <span class="o">==</span> <span class="n">maxvid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rvosteps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ph1: changing vid for rvo, req 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">decrease_vid_code_by_step</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rvosteps</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">query_current_values_with_pending_wait</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">savefid</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;ph1 err, currfid changed 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ph1 complete, currfid 0x%x, currvid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Phase 2 - core frequency transition */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_frequency_transition</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reqfid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">vcoreqfid</span><span class="p">,</span> <span class="n">vcocurrfid</span><span class="p">,</span> <span class="n">vcofiddiff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fid_interval</span><span class="p">,</span> <span class="n">savevid</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span> <span class="o">==</span> <span class="n">reqfid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;ph2 null fid transition 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ph2 (cpu%d): starting, currfid 0x%x, currvid 0x%x, &quot;</span>
		<span class="s">&quot;reqfid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">smp_processor_id</span><span class="p">(),</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">,</span> <span class="n">reqfid</span><span class="p">);</span>

	<span class="n">vcoreqfid</span> <span class="o">=</span> <span class="n">convert_fid_to_vco_fid</span><span class="p">(</span><span class="n">reqfid</span><span class="p">);</span>
	<span class="n">vcocurrfid</span> <span class="o">=</span> <span class="n">convert_fid_to_vco_fid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">);</span>
	<span class="n">vcofiddiff</span> <span class="o">=</span> <span class="n">vcocurrfid</span> <span class="o">&gt;</span> <span class="n">vcoreqfid</span> <span class="o">?</span> <span class="n">vcocurrfid</span> <span class="o">-</span> <span class="n">vcoreqfid</span>
	    <span class="o">:</span> <span class="n">vcoreqfid</span> <span class="o">-</span> <span class="n">vcocurrfid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">reqfid</span> <span class="o">&lt;=</span> <span class="n">LO_FID_TABLE_TOP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span> <span class="o">&lt;=</span> <span class="n">LO_FID_TABLE_TOP</span><span class="p">))</span>
		<span class="n">vcofiddiff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">vcofiddiff</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">fid_interval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">fid_interval</span> <span class="o">=</span> <span class="mi">2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reqfid</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span> <span class="o">&gt;</span> <span class="n">LO_FID_TABLE_TOP</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">write_new_fid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span> <span class="o">+</span> <span class="n">fid_interval</span><span class="p">))</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">write_new_fid</span>
				    <span class="p">(</span><span class="n">data</span><span class="p">,</span>
				     <span class="mi">2</span> <span class="o">+</span> <span class="n">convert_fid_to_vco_fid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">)))</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">write_new_fid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span> <span class="o">-</span> <span class="n">fid_interval</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vcocurrfid</span> <span class="o">=</span> <span class="n">convert_fid_to_vco_fid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">);</span>
		<span class="n">vcofiddiff</span> <span class="o">=</span> <span class="n">vcocurrfid</span> <span class="o">&gt;</span> <span class="n">vcoreqfid</span> <span class="o">?</span> <span class="n">vcocurrfid</span> <span class="o">-</span> <span class="n">vcoreqfid</span>
		    <span class="o">:</span> <span class="n">vcoreqfid</span> <span class="o">-</span> <span class="n">vcocurrfid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_new_fid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">reqfid</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">query_current_values_with_pending_wait</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span> <span class="o">!=</span> <span class="n">reqfid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span>
			<span class="s">&quot;ph2: mismatch, failed fid transition, &quot;</span>
			<span class="s">&quot;curr 0x%x, req 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">,</span> <span class="n">reqfid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">savevid</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;ph2: vid changed, save 0x%x, curr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">savevid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ph2 complete, currfid 0x%x, currvid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Phase 3 - core voltage transition flow ... jump to the final vid. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">core_voltage_post_transition</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">reqvid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">savefid</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">savereqvid</span> <span class="o">=</span> <span class="n">reqvid</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ph3 (cpu%d): starting, currfid 0x%x, currvid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">smp_processor_id</span><span class="p">(),</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reqvid</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">write_new_vid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">reqvid</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">savefid</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span>
			       <span class="s">&quot;ph3: bad fid change, save 0x%x, curr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">savefid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span> <span class="o">!=</span> <span class="n">reqvid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span>
			       <span class="s">&quot;ph3: failed vid transition</span><span class="se">\n</span><span class="s">, &quot;</span>
			       <span class="s">&quot;req 0x%x, curr 0x%x&quot;</span><span class="p">,</span>
			       <span class="n">reqvid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">query_current_values_with_pending_wait</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">savereqvid</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ph3 failed, currvid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">savefid</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ph3 failed, currfid changed 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ph3 complete, currfid 0x%x, currvid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">x86_cpu_id</span> <span class="n">powernow_k8_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* IO based frequency switching */</span>
	<span class="p">{</span> <span class="n">X86_VENDOR_AMD</span><span class="p">,</span> <span class="mh">0xf</span> <span class="p">},</span>
	<span class="cm">/* MSR based frequency switching supported */</span>
	<span class="n">X86_FEATURE_MATCH</span><span class="p">(</span><span class="n">X86_FEATURE_HW_PSTATE</span><span class="p">),</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">x86cpu</span><span class="p">,</span> <span class="n">powernow_k8_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_supported_cpu</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">_rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">edx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="n">_rc</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">eax</span> <span class="o">=</span> <span class="n">cpuid_eax</span><span class="p">(</span><span class="n">CPUID_PROCESSOR_SIGNATURE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="n">CPUID_XFAM</span><span class="p">)</span> <span class="o">==</span> <span class="n">CPUID_XFAM_K8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="n">CPUID_USE_XFAM_XMOD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CPUID_USE_XFAM_XMOD</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="n">CPUID_XMOD</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">CPUID_XMOD_REV_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span>
				<span class="s">&quot;Processor cpuid %x not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eax</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">eax</span> <span class="o">=</span> <span class="n">cpuid_eax</span><span class="p">(</span><span class="n">CPUID_GET_MAX_CAPABILITIES</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eax</span> <span class="o">&lt;</span> <span class="n">CPUID_FREQ_VOLT_CAPABILITIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span>
			       <span class="s">&quot;No frequency change capabilities detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cpuid</span><span class="p">(</span><span class="n">CPUID_FREQ_VOLT_CAPABILITIES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eax</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ebx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">edx</span> <span class="o">&amp;</span> <span class="n">P_STATE_TRANSITION_CAPABLE</span><span class="p">)</span>
			<span class="o">!=</span> <span class="n">P_STATE_TRANSITION_CAPABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span>
				<span class="s">&quot;Power state transitions not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* must be a HW Pstate capable processor */</span>
		<span class="n">cpuid</span><span class="p">(</span><span class="n">CPUID_FREQ_VOLT_CAPABILITIES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eax</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ebx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">edx</span> <span class="o">&amp;</span> <span class="n">USE_HW_PSTATE</span><span class="p">)</span> <span class="o">==</span> <span class="n">USE_HW_PSTATE</span><span class="p">)</span>
			<span class="n">cpu_family</span> <span class="o">=</span> <span class="n">CPU_HW_PSTATE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_pst_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pst_s</span> <span class="o">*</span><span class="n">pst</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">maxvid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lastfid</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">numps</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pst</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">vid</span> <span class="o">&gt;</span> <span class="n">LEAST_VID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">FW_BUG</span> <span class="n">PFX</span> <span class="s">&quot;vid %d invalid : 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">j</span><span class="p">,</span> <span class="n">pst</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">vid</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pst</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">vid</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rvo</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* vid + rvo &gt;= 0 */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">FW_BUG</span> <span class="n">PFX</span> <span class="s">&quot;0 vid exceeded with pstate&quot;</span>
			       <span class="s">&quot; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pst</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">vid</span> <span class="o">&lt;</span> <span class="n">maxvid</span> <span class="o">+</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rvo</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* vid + rvo &gt;= maxvid */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">FW_BUG</span> <span class="n">PFX</span> <span class="s">&quot;maxvid exceeded with pstate&quot;</span>
			       <span class="s">&quot; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pst</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">fid</span> <span class="o">&gt;</span> <span class="n">MAX_FID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">FW_BUG</span> <span class="n">PFX</span> <span class="s">&quot;maxfid exceeded with pstate&quot;</span>
			       <span class="s">&quot; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pst</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">fid</span> <span class="o">&lt;</span> <span class="n">HI_FID_TABLE_BOTTOM</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Only first fid is allowed to be in &quot;low&quot; range */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">FW_BUG</span> <span class="n">PFX</span> <span class="s">&quot;two low fids - %d : &quot;</span>
			       <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">pst</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">fid</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pst</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">fid</span> <span class="o">&lt;</span> <span class="n">lastfid</span><span class="p">)</span>
			<span class="n">lastfid</span> <span class="o">=</span> <span class="n">pst</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">fid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lastfid</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">FW_BUG</span> <span class="n">PFX</span> <span class="s">&quot;lastfid invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lastfid</span> <span class="o">&gt;</span> <span class="n">LO_FID_TABLE_TOP</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">FW_BUG</span> <span class="n">PFX</span>
			<span class="s">&quot;first fid not from lo freq table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">invalidate_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="o">*</span><span class="n">powernow_table</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">powernow_table</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">CPUFREQ_ENTRY_INVALID</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_basics</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">numps</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">frequency</span> <span class="o">!=</span>
				<span class="n">CPUFREQ_ENTRY_INVALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cpu_family</span> <span class="o">==</span> <span class="n">CPU_HW_PSTATE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span>
					<span class="s">&quot;   %d : pstate %d (%d MHz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">index</span><span class="p">,</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">frequency</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span>
					<span class="s">&quot;fid 0x%x (%d MHz), vid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">index</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">frequency</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">index</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">batps</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Only %d pstates on battery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">batps</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">freq_from_fid_did</span><span class="p">(</span><span class="n">u32</span> <span class="n">fid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">did</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mhz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">mhz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">fid</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">did</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86</span> <span class="o">==</span> <span class="mh">0x11</span><span class="p">)</span>
		<span class="n">mhz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">fid</span> <span class="o">+</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">did</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">mhz</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fill_powernow_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">pst_s</span> <span class="o">*</span><span class="n">pst</span><span class="p">,</span> <span class="n">u8</span> <span class="n">maxvid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="o">*</span><span class="n">powernow_table</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">batps</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* use ACPI support to get full speed on mains power */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PFX</span>
			<span class="s">&quot;Only %d pstates usable (use ACPI driver for full &quot;</span>
			<span class="s">&quot;range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">batps</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">numps</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">batps</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">numps</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pst</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">fid</span> <span class="o">&gt;=</span> <span class="n">pst</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">fid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;PST out of sequence</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">numps</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;no p states to transition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_pst_table</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pst</span><span class="p">,</span> <span class="n">maxvid</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">powernow_table</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_frequency_table</span><span class="p">)</span>
		<span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">numps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">powernow_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;powernow_table memory alloc failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">numps</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">freq</span><span class="p">;</span>
		<span class="n">powernow_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">pst</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">fid</span><span class="p">;</span> <span class="cm">/* lower 8 bits */</span>
		<span class="n">powernow_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">index</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pst</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">vid</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span> <span class="cm">/* upper 8 bits */</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="n">find_khz_freq_from_fid</span><span class="p">(</span><span class="n">pst</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">fid</span><span class="p">);</span>
		<span class="n">powernow_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">powernow_table</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">numps</span><span class="p">].</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">CPUFREQ_TABLE_END</span><span class="p">;</span>
	<span class="n">powernow_table</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">numps</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">query_current_values_with_pending_wait</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">powernow_table</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;cfid 0x%x, cvid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span> <span class="o">=</span> <span class="n">powernow_table</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpumask_first</span><span class="p">(</span><span class="n">cpu_core_mask</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">))</span> <span class="o">==</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span>
		<span class="n">print_basics</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">numps</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pst</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">fid</span> <span class="o">==</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">pst</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">vid</span> <span class="o">==</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;currfid/vid do not match PST, ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Find and validate the PSB/PST table in BIOS. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_psb_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psb_s</span> <span class="o">*</span><span class="n">psb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mvs</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">maxvid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cpst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">thiscpuid</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0xc0000</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0xffff0</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Scan BIOS looking for the signature. */</span>
		<span class="cm">/* It can not be at ffff0 - it is too big. */</span>

		<span class="n">psb</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">psb</span><span class="p">,</span> <span class="n">PSB_ID_STRING</span><span class="p">,</span> <span class="n">PSB_ID_STRING_LEN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;found PSB header at 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">psb</span><span class="p">);</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;table vers: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">psb</span><span class="o">-&gt;</span><span class="n">tableversion</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psb</span><span class="o">-&gt;</span><span class="n">tableversion</span> <span class="o">!=</span> <span class="n">PSB_VERSION_1_4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">FW_BUG</span> <span class="n">PFX</span> <span class="s">&quot;PSB table is not v1.4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;flags: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">psb</span><span class="o">-&gt;</span><span class="n">flags1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psb</span><span class="o">-&gt;</span><span class="n">flags1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">FW_BUG</span> <span class="n">PFX</span> <span class="s">&quot;unknown flags</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">vstable</span> <span class="o">=</span> <span class="n">psb</span><span class="o">-&gt;</span><span class="n">vstable</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;voltage stabilization time: %d(*20us)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">vstable</span><span class="p">);</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;flags2: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">psb</span><span class="o">-&gt;</span><span class="n">flags2</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rvo</span> <span class="o">=</span> <span class="n">psb</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">irt</span> <span class="o">=</span> <span class="p">((</span><span class="n">psb</span><span class="o">-&gt;</span><span class="n">flags2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">mvs</span> <span class="o">=</span> <span class="p">((</span><span class="n">psb</span><span class="o">-&gt;</span><span class="n">flags2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">vidmvs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mvs</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">batps</span> <span class="o">=</span> <span class="p">((</span><span class="n">psb</span><span class="o">-&gt;</span><span class="n">flags2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ramp voltage offset: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rvo</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;isochronous relief time: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">irt</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;maximum voltage step: %d - 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mvs</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">vidmvs</span><span class="p">);</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;numpst: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">psb</span><span class="o">-&gt;</span><span class="n">num_tables</span><span class="p">);</span>
		<span class="n">cpst</span> <span class="o">=</span> <span class="n">psb</span><span class="o">-&gt;</span><span class="n">num_tables</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">psb</span><span class="o">-&gt;</span><span class="n">cpuid</span> <span class="o">==</span> <span class="mh">0x00000fc0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">psb</span><span class="o">-&gt;</span><span class="n">cpuid</span> <span class="o">==</span> <span class="mh">0x00000fe0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">thiscpuid</span> <span class="o">=</span> <span class="n">cpuid_eax</span><span class="p">(</span><span class="n">CPUID_PROCESSOR_SIGNATURE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">thiscpuid</span> <span class="o">==</span> <span class="mh">0x00000fc0</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">thiscpuid</span> <span class="o">==</span> <span class="mh">0x00000fe0</span><span class="p">))</span>
				<span class="n">cpst</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpst</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">FW_BUG</span> <span class="n">PFX</span> <span class="s">&quot;numpst must be 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">plllock</span> <span class="o">=</span> <span class="n">psb</span><span class="o">-&gt;</span><span class="n">plllocktime</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;plllocktime: 0x%x (units 1us)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">psb</span><span class="o">-&gt;</span><span class="n">plllocktime</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;maxfid: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">psb</span><span class="o">-&gt;</span><span class="n">maxfid</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;maxvid: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">psb</span><span class="o">-&gt;</span><span class="n">maxvid</span><span class="p">);</span>
		<span class="n">maxvid</span> <span class="o">=</span> <span class="n">psb</span><span class="o">-&gt;</span><span class="n">maxvid</span><span class="p">;</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">numps</span> <span class="o">=</span> <span class="n">psb</span><span class="o">-&gt;</span><span class="n">numps</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;numpstates: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">numps</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">fill_powernow_table</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">pst_s</span> <span class="o">*</span><span class="p">)(</span><span class="n">psb</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">maxvid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If you see this message, complain to BIOS manufacturer. If</span>
<span class="cm">	 * he tells you &quot;we do not support Linux&quot; or some similar</span>
<span class="cm">	 * nonsense, remember that Windows 2000 uses the same legacy</span>
<span class="cm">	 * mechanism that the old Linux PSB driver uses. Tell them it</span>
<span class="cm">	 * is broken with Windows 2000.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The reference to the AMD documentation is chapter 9 in the</span>
<span class="cm">	 * BIOS and Kernel Developer&#39;s Guide, which is available on</span>
<span class="cm">	 * www.amd.com</span>
<span class="cm">	 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">FW_BUG</span> <span class="n">PFX</span> <span class="s">&quot;No PSB or ACPI _PSS objects</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Make sure that your BIOS is up to date&quot;</span>
		<span class="s">&quot; and Cool&#39;N&#39;Quiet support is enabled in BIOS setup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">powernow_k8_acpi_pst_values</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">control</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">state_count</span> <span class="o">||</span> <span class="p">(</span><span class="n">cpu_family</span> <span class="o">==</span> <span class="n">CPU_HW_PSTATE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">control</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">irt</span> <span class="o">=</span> <span class="p">(</span><span class="n">control</span> <span class="o">&gt;&gt;</span> <span class="n">IRT_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IRT_MASK</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">rvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">control</span> <span class="o">&gt;&gt;</span> <span class="n">RVO_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RVO_MASK</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">exttype</span> <span class="o">=</span> <span class="p">(</span><span class="n">control</span> <span class="o">&gt;&gt;</span> <span class="n">EXT_TYPE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EXT_TYPE_MASK</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">plllock</span> <span class="o">=</span> <span class="p">(</span><span class="n">control</span> <span class="o">&gt;&gt;</span> <span class="n">PLL_L_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PLL_L_MASK</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">vidmvs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">control</span> <span class="o">&gt;&gt;</span> <span class="n">MVS_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MVS_MASK</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">vstable</span> <span class="o">=</span> <span class="p">(</span><span class="n">control</span> <span class="o">&gt;&gt;</span> <span class="n">VST_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">VST_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">powernow_k8_cpu_init_acpi</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="o">*</span><span class="n">powernow_table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">control</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_processor_register_performance</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;register performance failed: bad ACPI data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* verify the data contained in the ACPI structures */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">state_count</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;No ACPI P-States</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">control_register</span><span class="p">.</span><span class="n">space_id</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">status_register</span><span class="p">.</span><span class="n">space_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">control</span> <span class="o">!=</span> <span class="n">ACPI_ADR_SPACE_FIXED_HARDWARE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">ACPI_ADR_SPACE_FIXED_HARDWARE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Invalid control/status registers (%llx - %llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">control</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fill in data-&gt;powernow_table */</span>
	<span class="n">powernow_table</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_frequency_table</span><span class="p">)</span>
		<span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">state_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">powernow_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;powernow_table memory alloc failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fill in data */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">numps</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">state_count</span><span class="p">;</span>
	<span class="n">powernow_k8_acpi_pst_values</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_family</span> <span class="o">==</span> <span class="n">CPU_HW_PSTATE</span><span class="p">)</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">fill_powernow_table_pstate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">powernow_table</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">fill_powernow_table_fidvid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">powernow_table</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_mem</span><span class="p">;</span>

	<span class="n">powernow_table</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">state_count</span><span class="p">].</span><span class="n">frequency</span> <span class="o">=</span>
		<span class="n">CPUFREQ_TABLE_END</span><span class="p">;</span>
	<span class="n">powernow_table</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">state_count</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span> <span class="o">=</span> <span class="n">powernow_table</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpumask_first</span><span class="p">(</span><span class="n">cpu_core_mask</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">))</span> <span class="o">==</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span>
		<span class="n">print_basics</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="cm">/* notify BIOS that we exist */</span>
	<span class="n">acpi_processor_notify_smm</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zalloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">shared_cpu_map</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span>
				<span class="s">&quot;unable to alloc powernow_k8_data cpumask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_mem:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">powernow_table</span><span class="p">);</span>

<span class="nl">err_out:</span>
	<span class="n">acpi_processor_unregister_performance</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>

	<span class="cm">/* data-&gt;acpi_data.state_count informs us at -&gt;exit()</span>
<span class="cm">	 * whether ACPI was used */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">state_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fill_powernow_table_pstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="o">*</span><span class="n">powernow_table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_PSTATE_CUR_LIMIT</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">max_hw_pstate</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&amp;</span> <span class="n">HW_PSTATE_MAX_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">HW_PSTATE_MAX_SHIFT</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">state_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">index</span><span class="p">;</span>

		<span class="n">index</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">HW_PSTATE_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">max_hw_pstate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;invalid pstate %d - &quot;</span>
					<span class="s">&quot;bad value %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Please report to BIOS &quot;</span>
					<span class="s">&quot;manufacturer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">invalidate_entry</span><span class="p">(</span><span class="n">powernow_table</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ps_to_as</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* Frequency may be rounded for these */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86</span> <span class="o">==</span> <span class="mh">0x10</span> <span class="o">&amp;&amp;</span> <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_model</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
				 <span class="o">||</span> <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86</span> <span class="o">==</span> <span class="mh">0x11</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_PSTATE_DEF_BASE</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hi</span> <span class="o">&amp;</span> <span class="n">HW_PSTATE_VALID_MASK</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;invalid pstate %d, ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
				<span class="n">invalidate_entry</span><span class="p">(</span><span class="n">powernow_table</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">powernow_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frequency</span> <span class="o">=</span>
				<span class="n">freq_from_fid_did</span><span class="p">(</span><span class="n">lo</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">powernow_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frequency</span> <span class="o">=</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">core_frequency</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

		<span class="n">powernow_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fill_powernow_table_fidvid</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="o">*</span><span class="n">powernow_table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">state_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">fid</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">vid</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">freq</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">status</span><span class="p">,</span> <span class="n">control</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">exttype</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span>  <span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">;</span>
			<span class="n">fid</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">EXT_FID_MASK</span><span class="p">;</span>
			<span class="n">vid</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="n">VID_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EXT_VID_MASK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">control</span> <span class="o">=</span>  <span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">control</span><span class="p">;</span>
			<span class="n">fid</span> <span class="o">=</span> <span class="n">control</span> <span class="o">&amp;</span> <span class="n">FID_MASK</span><span class="p">;</span>
			<span class="n">vid</span> <span class="o">=</span> <span class="p">(</span><span class="n">control</span> <span class="o">&gt;&gt;</span> <span class="n">VID_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">VID_MASK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;   %d : fid 0x%x, vid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>

		<span class="n">index</span> <span class="o">=</span> <span class="n">fid</span> <span class="o">|</span> <span class="p">(</span><span class="n">vid</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">powernow_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

		<span class="n">freq</span> <span class="o">=</span> <span class="n">find_khz_freq_from_fid</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>
		<span class="n">powernow_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>

		<span class="cm">/* verify frequency is OK */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">MAX_FREQ</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MIN_FREQ</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;invalid freq %u kHz, ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
			<span class="n">invalidate_entry</span><span class="p">(</span><span class="n">powernow_table</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* verify voltage is OK -</span>
<span class="cm">		 * BIOSs are using &quot;off&quot; to indicate invalid */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vid</span> <span class="o">==</span> <span class="n">VID_OFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;invalid vid %u, ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
			<span class="n">invalidate_entry</span><span class="p">(</span><span class="n">powernow_table</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">!=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">core_frequency</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;invalid freq entries &quot;</span>
				<span class="s">&quot;%u kHz vs. %u kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
				<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">core_frequency</span>
				 <span class="o">*</span> <span class="mi">1000</span><span class="p">));</span>
			<span class="n">invalidate_entry</span><span class="p">(</span><span class="n">powernow_table</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">powernow_k8_cpu_exit_acpi</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">state_count</span><span class="p">)</span>
		<span class="n">acpi_processor_unregister_performance</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">shared_cpu_map</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_transition_latency</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">max_latency</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">state_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cur_latency</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">transition_latency</span>
			<span class="o">+</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_data</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bus_master_latency</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_latency</span> <span class="o">&gt;</span> <span class="n">max_latency</span><span class="p">)</span>
			<span class="n">max_latency</span> <span class="o">=</span> <span class="n">cur_latency</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_latency</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Fam 11h and later may return 0 as transition latency. This</span>
<span class="cm">		 * is intended and means &quot;very fast&quot;. While cpufreq core and</span>
<span class="cm">		 * governors currently can handle that gracefully, better set it</span>
<span class="cm">		 * to 1 to avoid problems in the future.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86</span> <span class="o">&lt;</span> <span class="mh">0x11</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">FW_WARN</span> <span class="n">PFX</span> <span class="s">&quot;Invalid zero transition &quot;</span>
				<span class="s">&quot;latency</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">max_latency</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* value in usecs, needs to be in nanoseconds */</span>
	<span class="k">return</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">max_latency</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Take a frequency, and issue the fid/vid transition command */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">transition_frequency_fidvid</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">fid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpufreq_freqs</span> <span class="n">freqs</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;cpu %d transition to index %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">index</span><span class="p">);</span>

	<span class="cm">/* fid/vid correctness check for k8 */</span>
	<span class="cm">/* fid are the lower 8 bits of the index we stored into</span>
<span class="cm">	 * the cpufreq frequency table in find_psb_table, vid</span>
<span class="cm">	 * are the upper 8 bits.</span>
<span class="cm">	 */</span>
	<span class="n">fid</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">index</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">vid</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">index</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;table matched fid 0x%x, giving vid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">query_current_values_with_pending_wait</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span> <span class="o">==</span> <span class="n">vid</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span> <span class="o">==</span> <span class="n">fid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;target matches current values (fid 0x%x, vid 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fid</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;cpu %d, changing to fid 0x%x, vid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">fid</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
	<span class="n">freqs</span><span class="p">.</span><span class="n">old</span> <span class="o">=</span> <span class="n">find_khz_freq_from_fid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">);</span>
	<span class="n">freqs</span><span class="p">.</span><span class="n">new</span> <span class="o">=</span> <span class="n">find_khz_freq_from_fid</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>

	<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">available_cores</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">freqs</span><span class="p">.</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">cpufreq_notify_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">freqs</span><span class="p">,</span> <span class="n">CPUFREQ_PRECHANGE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">transition_fid_vid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">freqs</span><span class="p">.</span><span class="n">new</span> <span class="o">=</span> <span class="n">find_khz_freq_from_fid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">);</span>

	<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">available_cores</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">freqs</span><span class="p">.</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">cpufreq_notify_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">freqs</span><span class="p">,</span> <span class="n">CPUFREQ_POSTCHANGE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Take a frequency, and issue the hardware pstate transition command */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">transition_frequency_pstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpufreq_freqs</span> <span class="n">freqs</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;cpu %d transition to index %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">index</span><span class="p">);</span>

	<span class="cm">/* get MSR index for hardware pstate transition */</span>
	<span class="n">pstate</span> <span class="o">=</span> <span class="n">index</span> <span class="o">&amp;</span> <span class="n">HW_PSTATE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pstate</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">max_hw_pstate</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">freqs</span><span class="p">.</span><span class="n">old</span> <span class="o">=</span> <span class="n">find_khz_freq_from_pstate</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">currpstate</span><span class="p">);</span>
	<span class="n">freqs</span><span class="p">.</span><span class="n">new</span> <span class="o">=</span> <span class="n">find_khz_freq_from_pstate</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">,</span> <span class="n">pstate</span><span class="p">);</span>

	<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">available_cores</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">freqs</span><span class="p">.</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">cpufreq_notify_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">freqs</span><span class="p">,</span> <span class="n">CPUFREQ_PRECHANGE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">transition_pstate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pstate</span><span class="p">);</span>
	<span class="n">freqs</span><span class="p">.</span><span class="n">new</span> <span class="o">=</span> <span class="n">find_khz_freq_from_pstate</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">,</span> <span class="n">pstate</span><span class="p">);</span>

	<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">available_cores</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">freqs</span><span class="p">.</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">cpufreq_notify_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">freqs</span><span class="p">,</span> <span class="n">CPUFREQ_POSTCHANGE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Driver entry point to switch to the target frequency */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">powernowk8_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">pol</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">targfreq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">relation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpumask_var_t</span> <span class="n">oldmask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">powernow_data</span><span class="p">,</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">checkfid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">checkvid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">newstate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">checkfid</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">;</span>
	<span class="n">checkvid</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">;</span>

	<span class="cm">/* only run on specific CPU from here on. */</span>
	<span class="cm">/* This is poor form: use a workqueue or smp_call_function_single */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oldmask</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cpumask_copy</span><span class="p">(</span><span class="n">oldmask</span><span class="p">,</span> <span class="n">tsk_cpus_allowed</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>
	<span class="n">set_cpus_allowed_ptr</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">cpumask_of</span><span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">smp_processor_id</span><span class="p">()</span> <span class="o">!=</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;limiting to cpu %u failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pending_bit_stuck</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;failing targ, change pending bit set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;targ: cpu %d, %d kHz, min %d, max %d, relation %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span> <span class="n">targfreq</span><span class="p">,</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">,</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">,</span> <span class="n">relation</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">query_current_values_with_pending_wait</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_family</span> <span class="o">!=</span> <span class="n">CPU_HW_PSTATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;targ: curr fid 0x%x, vid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">checkvid</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">checkfid</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span>
				<span class="s">&quot;error - out of sync, fix 0x%x 0x%x, &quot;</span>
				<span class="s">&quot;vid 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">checkfid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">,</span>
				<span class="n">checkvid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_frequency_table_target</span><span class="p">(</span><span class="n">pol</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">,</span>
				<span class="n">targfreq</span><span class="p">,</span> <span class="n">relation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newstate</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fidvid_mutex</span><span class="p">);</span>

	<span class="n">powernow_k8_acpi_pst_values</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">newstate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_family</span> <span class="o">==</span> <span class="n">CPU_HW_PSTATE</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">transition_frequency_pstate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">[</span><span class="n">newstate</span><span class="p">].</span><span class="n">index</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">transition_frequency_fidvid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">newstate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;transition frequency failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fidvid_mutex</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fidvid_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_family</span> <span class="o">==</span> <span class="n">CPU_HW_PSTATE</span><span class="p">)</span>
		<span class="n">pol</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">=</span> <span class="n">find_khz_freq_from_pstate</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">[</span><span class="n">newstate</span><span class="p">].</span><span class="n">index</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pol</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">=</span> <span class="n">find_khz_freq_from_fid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">set_cpus_allowed_ptr</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">oldmask</span><span class="p">);</span>
	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">oldmask</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Driver entry point to verify the policy and range of frequencies */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">powernowk8_verify</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">pol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">powernow_data</span><span class="p">,</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cpufreq_frequency_table_verify</span><span class="p">(</span><span class="n">pol</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">init_on_cpu</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">powernowk8_cpu_init_on_cpu</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">_init_on_cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">init_on_cpu</span> <span class="o">*</span><span class="n">init_on_cpu</span> <span class="o">=</span> <span class="n">_init_on_cpu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pending_bit_stuck</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;failing init, change pending bit set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">init_on_cpu</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">query_current_values_with_pending_wait</span><span class="p">(</span><span class="n">init_on_cpu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">init_on_cpu</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_family</span> <span class="o">==</span> <span class="n">CPU_OPTERON</span><span class="p">)</span>
		<span class="n">fidvid_msr_init</span><span class="p">();</span>

	<span class="n">init_on_cpu</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* per CPU init entry point to the driver */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__cpuinit</span> <span class="nf">powernowk8_cpu_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">pol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ACPI_PSS_BIOS_BUG_MSG</span><span class="p">[]</span> <span class="o">=</span>
		<span class="n">KERN_ERR</span> <span class="n">FW_BUG</span> <span class="n">PFX</span> <span class="s">&quot;No compatible ACPI _PSS objects found.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="n">FW_BUG</span> <span class="n">PFX</span> <span class="s">&quot;Try again with latest BIOS.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">init_on_cpu</span> <span class="n">init_on_cpu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpu_data</span><span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_online</span><span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">smp_call_function_single</span><span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span> <span class="n">check_supported_cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">powernow_k8_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;unable to alloc powernow_k8_data&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">currpstate</span> <span class="o">=</span> <span class="n">HW_PSTATE_INVALID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">powernow_k8_cpu_init_acpi</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Use the PSB BIOS structure. This is only available on</span>
<span class="cm">		 * an UP version, and is deprecated by AMD.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_online_cpus</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk_once</span><span class="p">(</span><span class="n">ACPI_PSS_BIOS_BUG_MSG</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">FW_BUG</span> <span class="n">PFX</span> <span class="s">&quot;No ACPI _PSS objects for &quot;</span>
			       <span class="s">&quot;CPU other than CPU0. Complain to your BIOS &quot;</span>
			       <span class="s">&quot;vendor.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">find_psb_table</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

		<span class="cm">/* Take a crude guess here.</span>
<span class="cm">		 * That guess was in microseconds, so multiply with 1000 */</span>
		<span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpuinfo</span><span class="p">.</span><span class="n">transition_latency</span> <span class="o">=</span> <span class="p">(</span>
			 <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rvo</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">vstable</span> <span class="o">*</span> <span class="n">VST_UNITS_20US</span><span class="p">)</span> <span class="o">+</span>
			 <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">irt</span><span class="p">)</span> <span class="o">*</span> <span class="mi">30</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* ACPI _PSS objects available */</span>
		<span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpuinfo</span><span class="p">.</span><span class="n">transition_latency</span> <span class="o">=</span> <span class="n">get_transition_latency</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="cm">/* only run on specific CPU from here on */</span>
	<span class="n">init_on_cpu</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">smp_call_function_single</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span> <span class="n">powernowk8_cpu_init_on_cpu</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">init_on_cpu</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">init_on_cpu</span><span class="p">.</span><span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_exit_acpi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_family</span> <span class="o">==</span> <span class="n">CPU_HW_PSTATE</span><span class="p">)</span>
		<span class="n">cpumask_copy</span><span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">,</span> <span class="n">cpumask_of</span><span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">cpumask_copy</span><span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">,</span> <span class="n">cpu_core_mask</span><span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">));</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">available_cores</span> <span class="o">=</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_family</span> <span class="o">==</span> <span class="n">CPU_HW_PSTATE</span><span class="p">)</span>
		<span class="n">pol</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">=</span> <span class="n">find_khz_freq_from_pstate</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">currpstate</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pol</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">=</span> <span class="n">find_khz_freq_from_fid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;policy current frequency %d kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">);</span>

	<span class="cm">/* min/max the cpu is capable of */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_frequency_table_cpuinfo</span><span class="p">(</span><span class="n">pol</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">FW_BUG</span> <span class="n">PFX</span> <span class="s">&quot;invalid powernow_table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">powernow_k8_cpu_exit_acpi</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for APERF/MPERF support in hardware */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">X86_FEATURE_APERFMPERF</span><span class="p">))</span>
		<span class="n">cpufreq_amd64_driver</span><span class="p">.</span><span class="n">getavg</span> <span class="o">=</span> <span class="n">cpufreq_get_measured_perf</span><span class="p">;</span>

	<span class="n">cpufreq_frequency_table_get_attr</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">,</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_family</span> <span class="o">==</span> <span class="n">CPU_HW_PSTATE</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;cpu_init done, current pstate 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">currpstate</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;cpu_init done, current fid 0x%x, vid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currvid</span><span class="p">);</span>

	<span class="n">per_cpu</span><span class="p">(</span><span class="n">powernow_data</span><span class="p">,</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_exit_acpi:</span>
	<span class="n">powernow_k8_cpu_exit_acpi</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

<span class="nl">err_out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">powernowk8_cpu_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">pol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">powernow_data</span><span class="p">,</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">powernow_k8_cpu_exit_acpi</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="n">cpufreq_frequency_table_put_attr</span><span class="p">(</span><span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">per_cpu</span><span class="p">(</span><span class="n">powernow_data</span><span class="p">,</span> <span class="n">pol</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">query_values_on_cpu</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">_err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">_err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">__this_cpu_read</span><span class="p">(</span><span class="n">powernow_data</span><span class="p">);</span>

	<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="n">query_current_values_with_pending_wait</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">powernowk8_get</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">powernow_k8_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">powernow_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">khz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">smp_call_function_single</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">query_values_on_cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_family</span> <span class="o">==</span> <span class="n">CPU_HW_PSTATE</span><span class="p">)</span>
		<span class="n">khz</span> <span class="o">=</span> <span class="n">find_khz_freq_from_pstate</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">powernow_table</span><span class="p">,</span>
						<span class="n">data</span><span class="o">-&gt;</span><span class="n">currpstate</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">khz</span> <span class="o">=</span> <span class="n">find_khz_freq_from_fid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">currfid</span><span class="p">);</span>


<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">khz</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_cpb_toggle_msrs</span><span class="p">(</span><span class="n">bool</span> <span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">get_online_cpus</span><span class="p">();</span>

	<span class="n">rdmsr_on_cpus</span><span class="p">(</span><span class="n">cpu_online_mask</span><span class="p">,</span> <span class="n">MSR_K7_HWCR</span><span class="p">,</span> <span class="n">msrs</span><span class="p">);</span>

	<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">cpu_online_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">msr</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">msrs</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span>
			<span class="n">reg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">reg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wrmsr_on_cpus</span><span class="p">(</span><span class="n">cpu_online_mask</span><span class="p">,</span> <span class="n">MSR_K7_HWCR</span><span class="p">,</span> <span class="n">msrs</span><span class="p">);</span>

	<span class="n">put_online_cpus</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Switch on/off core performance boosting.</span>
<span class="cm"> *</span>
<span class="cm"> * 0=disable</span>
<span class="cm"> * 1=enable.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpb_toggle</span><span class="p">(</span><span class="n">bool</span> <span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpb_capable</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cpb_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpb_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">_cpb_toggle_msrs</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Core Boosting enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span> <span class="o">&amp;&amp;</span> <span class="n">cpb_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpb_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">_cpb_toggle_msrs</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Core Boosting disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_cpb</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				 <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cpb_capable</span><span class="p">)</span>
		<span class="n">cpb_toggle</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_cpb</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpb_enabled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define define_one_rw(_name) \</span>
<span class="cp">static struct freq_attr _name = \</span>
<span class="cp">__ATTR(_name, 0644, show_##_name, store_##_name)</span>

<span class="n">define_one_rw</span><span class="p">(</span><span class="n">cpb</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">freq_attr</span> <span class="o">*</span><span class="n">powernow_k8_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">cpufreq_freq_attr_scaling_available_freqs</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">cpb</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_driver</span> <span class="n">cpufreq_amd64_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">verify</span>		<span class="o">=</span> <span class="n">powernowk8_verify</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target</span>		<span class="o">=</span> <span class="n">powernowk8_target</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_limit</span>	<span class="o">=</span> <span class="n">acpi_processor_get_bios_limit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">powernowk8_cpu_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">powernowk8_cpu_exit</span><span class="p">),</span>
	<span class="p">.</span><span class="n">get</span>		<span class="o">=</span> <span class="n">powernowk8_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;powernow-k8&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attr</span>		<span class="o">=</span> <span class="n">powernow_k8_attr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Clear the boost-disable flag on the CPU_DOWN path so that this cpu</span>
<span class="cm"> * cannot block the remaining ones from boosting. On the CPU_UP path we</span>
<span class="cm"> * simply keep the boost-disable flag in sync with the current global</span>
<span class="cm"> * state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpb_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span>
		      <span class="kt">void</span> <span class="o">*</span><span class="n">hcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">cpu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">hcpu</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPU_UP_PREPARE</span>:
	<span class="k">case</span> <span class="n">CPU_UP_PREPARE_FROZEN</span>:

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpb_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdmsr_on_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">MSR_K7_HWCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hi</span><span class="p">);</span>
			<span class="n">lo</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
			<span class="n">wrmsr_on_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">MSR_K7_HWCR</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CPU_DOWN_PREPARE</span>:
	<span class="k">case</span> <span class="n">CPU_DOWN_PREPARE_FROZEN</span>:
		<span class="n">rdmsr_on_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">MSR_K7_HWCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hi</span><span class="p">);</span>
		<span class="n">lo</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
		<span class="n">wrmsr_on_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">MSR_K7_HWCR</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">cpb_nb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span>		<span class="o">=</span> <span class="n">cpb_notify</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* driver entry point for init */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__cpuinit</span> <span class="nf">powernowk8_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">supported_cpus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x86_match_cpu</span><span class="p">(</span><span class="n">powernow_k8_ids</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">smp_call_function_single</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">check_supported_cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">supported_cpus</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">supported_cpus</span> <span class="o">!=</span> <span class="n">num_online_cpus</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Found %d %s (%d cpu cores) (&quot;</span> <span class="n">VERSION</span> <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">num_online_nodes</span><span class="p">(),</span> <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_model_id</span><span class="p">,</span> <span class="n">supported_cpus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_CPB</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">cpb_capable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">msrs</span> <span class="o">=</span> <span class="n">msrs_alloc</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msrs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error allocating msrs!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">register_cpu_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpb_nb</span><span class="p">);</span>

		<span class="n">rdmsr_on_cpus</span><span class="p">(</span><span class="n">cpu_online_mask</span><span class="p">,</span> <span class="n">MSR_K7_HWCR</span><span class="p">,</span> <span class="n">msrs</span><span class="p">);</span>

		<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">cpu_online_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">msr</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">msrs</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
			<span class="n">cpb_enabled</span> <span class="o">|=</span> <span class="o">!</span><span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">25</span><span class="p">)));</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Core Performance Boosting: %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">cpb_enabled</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">cpufreq_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_amd64_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">boot_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_CPB</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">unregister_cpu_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpb_nb</span><span class="p">);</span>
		<span class="n">msrs_free</span><span class="p">(</span><span class="n">msrs</span><span class="p">);</span>
		<span class="n">msrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* driver entry point for term */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">powernowk8_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_CPB</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msrs_free</span><span class="p">(</span><span class="n">msrs</span><span class="p">);</span>
		<span class="n">msrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">unregister_cpu_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpb_nb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cpufreq_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_amd64_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Paul Devriendt &lt;paul.devriendt@amd.com&gt; and &quot;</span>
		<span class="s">&quot;Mark Langsdorf &lt;mark.langsdorf@amd.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;AMD Athlon 64 and Opteron processor frequency driver.&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">late_initcall</span><span class="p">(</span><span class="n">powernowk8_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">powernowk8_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
