<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › cpufreq › cpufreq.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>cpufreq.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/cpufreq/cpufreq.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2001 Russell King</span>
<span class="cm"> *            (C) 2002 - 2003 Dominik Brodowski &lt;linux@brodo.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Oct 2005 - Ashok Raj &lt;ashok.raj@intel.com&gt;</span>
<span class="cm"> *	Added handling for CPU hotplug</span>
<span class="cm"> *  Feb 2006 - Jacob Shin &lt;jacob.shin@amd.com&gt;</span>
<span class="cm"> *	Fix handling for CPU hotplug -- affected CPUs</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/cpufreq.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/cpu.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/syscore_ops.h&gt;</span>

<span class="cp">#include &lt;trace/events/power.h&gt;</span>

<span class="cm">/**</span>
<span class="cm"> * The &quot;cpufreq driver&quot; - the arch- or hardware-dependent low</span>
<span class="cm"> * level driver of CPUFreq support, and its spinlock. This lock</span>
<span class="cm"> * also protects the cpufreq_cpu_data array.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_driver</span> <span class="o">*</span><span class="n">cpufreq_driver</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="p">,</span> <span class="n">cpufreq_cpu_data</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_HOTPLUG_CPU</span>
<span class="cm">/* This one keeps track of the previously set governor of a removed CPU */</span>
<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="kt">char</span><span class="p">[</span><span class="n">CPUFREQ_NAME_LEN</span><span class="p">],</span> <span class="n">cpufreq_cpu_governor</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">cpufreq_driver_lock</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * cpu_policy_rwsem is a per CPU reader-writer semaphore designed to cure</span>
<span class="cm"> * all cpufreq/hotplug/workqueue/etc related lock issues.</span>
<span class="cm"> *</span>
<span class="cm"> * The rules for this semaphore:</span>
<span class="cm"> * - Any routine that wants to read from the policy structure will</span>
<span class="cm"> *   do a down_read on this semaphore.</span>
<span class="cm"> * - Any routine that will write to the policy structure and/or may take away</span>
<span class="cm"> *   the policy altogether (eg. CPU hotplug), will hold this lock in write</span>
<span class="cm"> *   mode before doing so.</span>
<span class="cm"> *</span>
<span class="cm"> * Additional rules:</span>
<span class="cm"> * - All holders of the lock should check to make sure that the CPU they</span>
<span class="cm"> *   are concerned with are online after they get the lock.</span>
<span class="cm"> * - Governor routines that can be called in cpufreq hotplug path should not</span>
<span class="cm"> *   take this sem as top level hotplug notifier handler takes this.</span>
<span class="cm"> * - Lock should not be held across</span>
<span class="cm"> *     __cpufreq_governor(data, CPUFREQ_GOV_STOP);</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">cpufreq_policy_cpu</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">rw_semaphore</span><span class="p">,</span> <span class="n">cpu_policy_rwsem</span><span class="p">);</span>

<span class="cp">#define lock_policy_rwsem(mode, cpu)					\</span>
<span class="cp">static int lock_policy_rwsem_##mode					\</span>
<span class="cp">(int cpu)								\</span>
<span class="cp">{									\</span>
<span class="cp">	int policy_cpu = per_cpu(cpufreq_policy_cpu, cpu);		\</span>
<span class="cp">	BUG_ON(policy_cpu == -1);					\</span>
<span class="cp">	down_##mode(&amp;per_cpu(cpu_policy_rwsem, policy_cpu));		\</span>
<span class="cp">	if (unlikely(!cpu_online(cpu))) {				\</span>
<span class="cp">		up_##mode(&amp;per_cpu(cpu_policy_rwsem, policy_cpu));	\</span>
<span class="cp">		return -1;						\</span>
<span class="cp">	}								\</span>
<span class="cp">									\</span>
<span class="cp">	return 0;							\</span>
<span class="cp">}</span>

<span class="n">lock_policy_rwsem</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

<span class="n">lock_policy_rwsem</span><span class="p">(</span><span class="n">write</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unlock_policy_rwsem_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">policy_cpu</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_policy_cpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">policy_cpu</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_policy_rwsem</span><span class="p">,</span> <span class="n">policy_cpu</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unlock_policy_rwsem_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">policy_cpu</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_policy_cpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">policy_cpu</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_policy_rwsem</span><span class="p">,</span> <span class="n">policy_cpu</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/* internal prototypes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__cpufreq_governor</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__cpufreq_get</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Two notifier lists: the &quot;policy&quot; list is involved in the</span>
<span class="cm"> * validation process for a new CPU frequency policy; the</span>
<span class="cm"> * &quot;transition&quot; list for kernel code that needs to handle</span>
<span class="cm"> * changes to devices when the CPU clock speed changes.</span>
<span class="cm"> * The mutex locks both lists.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">BLOCKING_NOTIFIER_HEAD</span><span class="p">(</span><span class="n">cpufreq_policy_notifier_list</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">srcu_notifier_head</span> <span class="n">cpufreq_transition_notifier_list</span><span class="p">;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">init_cpufreq_transition_notifier_list_called</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_cpufreq_transition_notifier_list</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">srcu_init_notifier_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_transition_notifier_list</span><span class="p">);</span>
	<span class="n">init_cpufreq_transition_notifier_list_called</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">pure_initcall</span><span class="p">(</span><span class="n">init_cpufreq_transition_notifier_list</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">off</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">cpufreq_disabled</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">off</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">disable_cpufreq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">cpufreq_governor_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">cpufreq_governor_mutex</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="nf">cpufreq_cpu_get</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">&gt;=</span> <span class="n">nr_cpu_ids</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="cm">/* get the cpufreq driver */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpufreq_driver</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out_unlock</span><span class="p">;</span>


	<span class="cm">/* get the CPU */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_cpu_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_put_module</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kobject_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out_put_module</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>

<span class="nl">err_out_put_module:</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
<span class="nl">err_out_unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cpufreq_cpu_get</span><span class="p">);</span>


<span class="kt">void</span> <span class="nf">cpufreq_cpu_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cpufreq_cpu_put</span><span class="p">);</span>


<span class="cm">/*********************************************************************</span>
<span class="cm"> *            EXTERNALLY AFFECTING FREQUENCY CHANGES                 *</span>
<span class="cm"> *********************************************************************/</span>

<span class="cm">/**</span>
<span class="cm"> * adjust_jiffies - adjust the system &quot;loops_per_jiffy&quot;</span>
<span class="cm"> *</span>
<span class="cm"> * This function alters the system &quot;loops_per_jiffy&quot; for the clock</span>
<span class="cm"> * speed change. Note that loops_per_jiffy cannot be updated on SMP</span>
<span class="cm"> * systems as each CPU might be scaled differently. So, use the arch</span>
<span class="cm"> * per-CPU loops_per_jiffy value wherever possible.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef CONFIG_SMP</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">l_p_j_ref</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">l_p_j_ref_freq</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">adjust_jiffies</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cpufreq_freqs</span> <span class="o">*</span><span class="n">ci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CPUFREQ_CONST_LOOPS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l_p_j_ref_freq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l_p_j_ref</span> <span class="o">=</span> <span class="n">loops_per_jiffy</span><span class="p">;</span>
		<span class="n">l_p_j_ref_freq</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">old</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;saving %lu as reference value for loops_per_jiffy; &quot;</span>
			<span class="s">&quot;freq is %u kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">l_p_j_ref</span><span class="p">,</span> <span class="n">l_p_j_ref_freq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">==</span> <span class="n">CPUFREQ_POSTCHANGE</span>  <span class="o">&amp;&amp;</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">old</span> <span class="o">!=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">new</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">CPUFREQ_RESUMECHANGE</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="n">CPUFREQ_SUSPENDCHANGE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">loops_per_jiffy</span> <span class="o">=</span> <span class="n">cpufreq_scale</span><span class="p">(</span><span class="n">l_p_j_ref</span><span class="p">,</span> <span class="n">l_p_j_ref_freq</span><span class="p">,</span>
								<span class="n">ci</span><span class="o">-&gt;</span><span class="n">new</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;scaling loops_per_jiffy to %lu &quot;</span>
			<span class="s">&quot;for frequency %u kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">loops_per_jiffy</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">new</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">adjust_jiffies</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cpufreq_freqs</span> <span class="o">*</span><span class="n">ci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/**</span>
<span class="cm"> * cpufreq_notify_transition - call notifier chain and adjust_jiffies</span>
<span class="cm"> * on frequency transition.</span>
<span class="cm"> *</span>
<span class="cm"> * This function calls the transition notifiers and the &quot;adjust_jiffies&quot;</span>
<span class="cm"> * function. It is called twice on all CPU frequency changes that have</span>
<span class="cm"> * external effects.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cpufreq_notify_transition</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_freqs</span> <span class="o">*</span><span class="n">freqs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">irqs_disabled</span><span class="p">());</span>

	<span class="n">freqs</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;notification %u of frequency transition to %u kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">state</span><span class="p">,</span> <span class="n">freqs</span><span class="o">-&gt;</span><span class="n">new</span><span class="p">);</span>

	<span class="n">policy</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_cpu_data</span><span class="p">,</span> <span class="n">freqs</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">CPUFREQ_PRECHANGE</span>:
		<span class="cm">/* detect if the driver reported a value as &quot;old frequency&quot;</span>
<span class="cm">		 * which is not equal to what the cpufreq core thinks is</span>
<span class="cm">		 * &quot;old frequency&quot;.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CPUFREQ_CONST_LOOPS</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">policy</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">==</span> <span class="n">freqs</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">!=</span> <span class="n">freqs</span><span class="o">-&gt;</span><span class="n">old</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Warning: CPU frequency is&quot;</span>
					<span class="s">&quot; %u, cpufreq assumed %u kHz.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">freqs</span><span class="o">-&gt;</span><span class="n">old</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">);</span>
				<span class="n">freqs</span><span class="o">-&gt;</span><span class="n">old</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">srcu_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_transition_notifier_list</span><span class="p">,</span>
				<span class="n">CPUFREQ_PRECHANGE</span><span class="p">,</span> <span class="n">freqs</span><span class="p">);</span>
		<span class="n">adjust_jiffies</span><span class="p">(</span><span class="n">CPUFREQ_PRECHANGE</span><span class="p">,</span> <span class="n">freqs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CPUFREQ_POSTCHANGE</span>:
		<span class="n">adjust_jiffies</span><span class="p">(</span><span class="n">CPUFREQ_POSTCHANGE</span><span class="p">,</span> <span class="n">freqs</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;FREQ: %lu - CPU: %lu&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">freqs</span><span class="o">-&gt;</span><span class="n">new</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">freqs</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
		<span class="n">trace_power_frequency</span><span class="p">(</span><span class="n">POWER_PSTATE</span><span class="p">,</span> <span class="n">freqs</span><span class="o">-&gt;</span><span class="n">new</span><span class="p">,</span> <span class="n">freqs</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
		<span class="n">trace_cpu_frequency</span><span class="p">(</span><span class="n">freqs</span><span class="o">-&gt;</span><span class="n">new</span><span class="p">,</span> <span class="n">freqs</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
		<span class="n">srcu_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_transition_notifier_list</span><span class="p">,</span>
				<span class="n">CPUFREQ_POSTCHANGE</span><span class="p">,</span> <span class="n">freqs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">likely</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">==</span> <span class="n">freqs</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">))</span>
			<span class="n">policy</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">=</span> <span class="n">freqs</span><span class="o">-&gt;</span><span class="n">new</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cpufreq_notify_transition</span><span class="p">);</span>



<span class="cm">/*********************************************************************</span>
<span class="cm"> *                          SYSFS INTERFACE                          *</span>
<span class="cm"> *********************************************************************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_governor</span> <span class="o">*</span><span class="nf">__find_governor</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str_governor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_governor</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpufreq_governor_list</span><span class="p">,</span> <span class="n">governor_list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">str_governor</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">CPUFREQ_NAME_LEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">t</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cpufreq_parse_governor - parse a governor string</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpufreq_parse_governor</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str_governor</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cpufreq_governor</span> <span class="o">**</span><span class="n">governor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpufreq_driver</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">setpolicy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">str_governor</span><span class="p">,</span> <span class="s">&quot;performance&quot;</span><span class="p">,</span> <span class="n">CPUFREQ_NAME_LEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">policy</span> <span class="o">=</span> <span class="n">CPUFREQ_POLICY_PERFORMANCE</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">str_governor</span><span class="p">,</span> <span class="s">&quot;powersave&quot;</span><span class="p">,</span>
						<span class="n">CPUFREQ_NAME_LEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">policy</span> <span class="o">=</span> <span class="n">CPUFREQ_POLICY_POWERSAVE</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cpufreq_governor</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_governor_mutex</span><span class="p">);</span>

		<span class="n">t</span> <span class="o">=</span> <span class="n">__find_governor</span><span class="p">(</span><span class="n">str_governor</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_governor_mutex</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">request_module</span><span class="p">(</span><span class="s">&quot;cpufreq_%s&quot;</span><span class="p">,</span> <span class="n">str_governor</span><span class="p">);</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_governor_mutex</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">__find_governor</span><span class="p">(</span><span class="n">str_governor</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">governor</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_governor_mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * cpufreq_per_cpu_attr_read() / show_##file_name() -</span>
<span class="cm"> * print out cpufreq information</span>
<span class="cm"> *</span>
<span class="cm"> * Write out information from cpufreq_driver-&gt;policy[cpu]; object must be</span>
<span class="cm"> * &quot;unsigned int&quot;.</span>
<span class="cm"> */</span>

<span class="cp">#define show_one(file_name, object)			\</span>
<span class="cp">static ssize_t show_##file_name				\</span>
<span class="cp">(struct cpufreq_policy *policy, char *buf)		\</span>
<span class="cp">{							\</span>
<span class="cp">	return sprintf(buf, &quot;%u\n&quot;, policy-&gt;object);	\</span>
<span class="cp">}</span>

<span class="n">show_one</span><span class="p">(</span><span class="n">cpuinfo_min_freq</span><span class="p">,</span> <span class="n">cpuinfo</span><span class="p">.</span><span class="n">min_freq</span><span class="p">);</span>
<span class="n">show_one</span><span class="p">(</span><span class="n">cpuinfo_max_freq</span><span class="p">,</span> <span class="n">cpuinfo</span><span class="p">.</span><span class="n">max_freq</span><span class="p">);</span>
<span class="n">show_one</span><span class="p">(</span><span class="n">cpuinfo_transition_latency</span><span class="p">,</span> <span class="n">cpuinfo</span><span class="p">.</span><span class="n">transition_latency</span><span class="p">);</span>
<span class="n">show_one</span><span class="p">(</span><span class="n">scaling_min_freq</span><span class="p">,</span> <span class="n">min</span><span class="p">);</span>
<span class="n">show_one</span><span class="p">(</span><span class="n">scaling_max_freq</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
<span class="n">show_one</span><span class="p">(</span><span class="n">scaling_cur_freq</span><span class="p">,</span> <span class="n">cur</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__cpufreq_set_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * cpufreq_per_cpu_attr_write() / store_##file_name() - sysfs write access</span>
<span class="cm"> */</span>
<span class="cp">#define store_one(file_name, object)			\</span>
<span class="cp">static ssize_t store_##file_name					\</span>
<span class="cp">(struct cpufreq_policy *policy, const char *buf, size_t count)		\</span>
<span class="cp">{									\</span>
<span class="cp">	unsigned int ret = -EINVAL;					\</span>
<span class="cp">	struct cpufreq_policy new_policy;				\</span>
<span class="cp">									\</span>
<span class="cp">	ret = cpufreq_get_policy(&amp;new_policy, policy-&gt;cpu);		\</span>
<span class="cp">	if (ret)							\</span>
<span class="cp">		return -EINVAL;						\</span>
<span class="cp">									\</span>
<span class="cp">	ret = sscanf(buf, &quot;%u&quot;, &amp;new_policy.object);			\</span>
<span class="cp">	if (ret != 1)							\</span>
<span class="cp">		return -EINVAL;						\</span>
<span class="cp">									\</span>
<span class="cp">	ret = __cpufreq_set_policy(policy, &amp;new_policy);		\</span>
<span class="cp">	policy-&gt;user_policy.object = policy-&gt;object;			\</span>
<span class="cp">									\</span>
<span class="cp">	return ret ? ret : count;					\</span>
<span class="cp">}</span>

<span class="n">store_one</span><span class="p">(</span><span class="n">scaling_min_freq</span><span class="p">,</span> <span class="n">min</span><span class="p">);</span>
<span class="n">store_one</span><span class="p">(</span><span class="n">scaling_max_freq</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * show_cpuinfo_cur_freq - current CPU frequency as detected by hardware</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_cpuinfo_cur_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_freq</span> <span class="o">=</span> <span class="n">__cpufreq_get</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cur_freq</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;&lt;unknown&gt;&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_freq</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * show_scaling_governor - show the current policy for the specified CPU</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_scaling_governor</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">policy</span> <span class="o">==</span> <span class="n">CPUFREQ_POLICY_POWERSAVE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;powersave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">policy</span> <span class="o">==</span> <span class="n">CPUFREQ_POLICY_PERFORMANCE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;performance</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">CPUFREQ_NAME_LEN</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * store_scaling_governor - store policy for the specified CPU</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_scaling_governor</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">str_governor</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="n">new_policy</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cpufreq_get_policy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_policy</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%15s&quot;</span><span class="p">,</span> <span class="n">str_governor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_parse_governor</span><span class="p">(</span><span class="n">str_governor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_policy</span><span class="p">.</span><span class="n">policy</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">new_policy</span><span class="p">.</span><span class="n">governor</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Do not use cpufreq_set_policy here or the user_policy.max</span>
<span class="cm">	   will be wrongly overridden */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__cpufreq_set_policy</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_policy</span><span class="p">);</span>

	<span class="n">policy</span><span class="o">-&gt;</span><span class="n">user_policy</span><span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">policy</span><span class="p">;</span>
	<span class="n">policy</span><span class="o">-&gt;</span><span class="n">user_policy</span><span class="p">.</span><span class="n">governor</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * show_scaling_driver - show the cpufreq driver currently loaded</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_scaling_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">CPUFREQ_NAME_LEN</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * show_scaling_available_governors - show the available CPUfreq governors</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_scaling_available_governors</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span>
						<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpufreq_governor</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;performance powersave&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpufreq_governor_list</span><span class="p">,</span> <span class="n">governor_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span> <span class="p">((</span><span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">))</span>
		    <span class="o">-</span> <span class="p">(</span><span class="n">CPUFREQ_NAME_LEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">CPUFREQ_NAME_LEN</span><span class="p">,</span> <span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_cpus</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cpumask</span> <span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">),</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">),</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">5</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * show_related_cpus - show the CPUs affected by each transition even if</span>
<span class="cm"> * hw coordination is in use</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_related_cpus</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpumask_empty</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">related_cpus</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">show_cpus</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">show_cpus</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">related_cpus</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * show_affected_cpus - show the CPUs affected by each transition</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_affected_cpus</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">show_cpus</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_scaling_setspeed</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span> <span class="o">||</span> <span class="o">!</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">store_setspeed</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">store_setspeed</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_scaling_setspeed</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span> <span class="o">||</span> <span class="o">!</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">show_setspeed</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;&lt;unsupported&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">show_setspeed</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * show_scaling_driver - show the current cpufreq HW/BIOS limitation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_bios_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">bios_limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">bios_limit</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">limit</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpuinfo</span><span class="p">.</span><span class="n">max_freq</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">cpufreq_freq_attr_ro_perm</span><span class="p">(</span><span class="n">cpuinfo_cur_freq</span><span class="p">,</span> <span class="mo">0400</span><span class="p">);</span>
<span class="n">cpufreq_freq_attr_ro</span><span class="p">(</span><span class="n">cpuinfo_min_freq</span><span class="p">);</span>
<span class="n">cpufreq_freq_attr_ro</span><span class="p">(</span><span class="n">cpuinfo_max_freq</span><span class="p">);</span>
<span class="n">cpufreq_freq_attr_ro</span><span class="p">(</span><span class="n">cpuinfo_transition_latency</span><span class="p">);</span>
<span class="n">cpufreq_freq_attr_ro</span><span class="p">(</span><span class="n">scaling_available_governors</span><span class="p">);</span>
<span class="n">cpufreq_freq_attr_ro</span><span class="p">(</span><span class="n">scaling_driver</span><span class="p">);</span>
<span class="n">cpufreq_freq_attr_ro</span><span class="p">(</span><span class="n">scaling_cur_freq</span><span class="p">);</span>
<span class="n">cpufreq_freq_attr_ro</span><span class="p">(</span><span class="n">bios_limit</span><span class="p">);</span>
<span class="n">cpufreq_freq_attr_ro</span><span class="p">(</span><span class="n">related_cpus</span><span class="p">);</span>
<span class="n">cpufreq_freq_attr_ro</span><span class="p">(</span><span class="n">affected_cpus</span><span class="p">);</span>
<span class="n">cpufreq_freq_attr_rw</span><span class="p">(</span><span class="n">scaling_min_freq</span><span class="p">);</span>
<span class="n">cpufreq_freq_attr_rw</span><span class="p">(</span><span class="n">scaling_max_freq</span><span class="p">);</span>
<span class="n">cpufreq_freq_attr_rw</span><span class="p">(</span><span class="n">scaling_governor</span><span class="p">);</span>
<span class="n">cpufreq_freq_attr_rw</span><span class="p">(</span><span class="n">scaling_setspeed</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">default_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">cpuinfo_min_freq</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">cpuinfo_max_freq</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">cpuinfo_transition_latency</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">scaling_min_freq</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">scaling_max_freq</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">affected_cpus</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">related_cpus</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">scaling_governor</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">scaling_driver</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">scaling_available_governors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">scaling_setspeed</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">cpufreq_global_kobject</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cpufreq_global_kobject</span><span class="p">);</span>

<span class="cp">#define to_policy(k) container_of(k, struct cpufreq_policy, kobj)</span>
<span class="cp">#define to_attr(a) container_of(a, struct freq_attr, attr)</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span> <span class="o">=</span> <span class="n">to_policy</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">freq_attr</span> <span class="o">*</span><span class="n">fattr</span> <span class="o">=</span> <span class="n">to_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">policy</span> <span class="o">=</span> <span class="n">cpufreq_cpu_get</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">policy</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_policy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock_policy_rwsem_read</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fattr</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fattr</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">unlock_policy_rwsem_read</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">cpufreq_cpu_put</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
<span class="nl">no_policy:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span> <span class="o">=</span> <span class="n">to_policy</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">freq_attr</span> <span class="o">*</span><span class="n">fattr</span> <span class="o">=</span> <span class="n">to_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">policy</span> <span class="o">=</span> <span class="n">cpufreq_cpu_get</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">policy</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_policy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock_policy_rwsem_write</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fattr</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fattr</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">unlock_policy_rwsem_write</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">cpufreq_cpu_put</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
<span class="nl">no_policy:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpufreq_sysfs_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span> <span class="o">=</span> <span class="n">to_policy</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;last reference is dropped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">kobj_unregister</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sysfs_ops</span> <span class="n">sysfs_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span>	<span class="o">=</span> <span class="n">store</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_type</span> <span class="n">ktype_cpufreq</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sysfs_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sysfs_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_attrs</span>	<span class="o">=</span> <span class="n">default_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">cpufreq_sysfs_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *   Negative: Failure</span>
<span class="cm"> *   0:        Success</span>
<span class="cm"> *   Positive: When we have a managed CPU and the sysfs got symlinked</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpufreq_add_dev_policy</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_HOTPLUG_CPU</span>
	<span class="k">struct</span> <span class="n">cpufreq_governor</span> <span class="o">*</span><span class="n">gov</span><span class="p">;</span>

	<span class="n">gov</span> <span class="o">=</span> <span class="n">__find_governor</span><span class="p">(</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_cpu_governor</span><span class="p">,</span> <span class="n">cpu</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gov</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span> <span class="o">=</span> <span class="n">gov</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Restoring governor %s for cpu %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">managed_policy</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">==</span> <span class="n">j</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Check for existing affected CPUs.</span>
<span class="cm">		 * They may not be aware of it due to CPU Hotplug.</span>
<span class="cm">		 * cpufreq_cpu_put is called when the device is removed</span>
<span class="cm">		 * in __cpufreq_remove_dev()</span>
<span class="cm">		 */</span>
		<span class="n">managed_policy</span> <span class="o">=</span> <span class="n">cpufreq_cpu_get</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">managed_policy</span><span class="p">))</span> <span class="p">{</span>

			<span class="cm">/* Set proper policy_cpu */</span>
			<span class="n">unlock_policy_rwsem_write</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
			<span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_policy_cpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="n">managed_policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">lock_policy_rwsem_write</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Should not go through policy unlock path */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">)</span>
					<span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
				<span class="n">cpufreq_cpu_put</span><span class="p">(</span><span class="n">managed_policy</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">cpumask_copy</span><span class="p">(</span><span class="n">managed_policy</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">);</span>
			<span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_cpu_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="n">managed_policy</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;CPU already managed, adding link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">managed_policy</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
						<span class="s">&quot;cpufreq&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">cpufreq_cpu_put</span><span class="p">(</span><span class="n">managed_policy</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Success. We only needed to be added to the mask.</span>
<span class="cm">			 * Call driver-&gt;exit() because only the cpu parent of</span>
<span class="cm">			 * the kobj needed to call init().</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">)</span>
				<span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* symlink affected CPUs */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpufreq_add_dev_symlink</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">managed_policy</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">cpu_dev</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">cpu</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_online</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;CPU %u already managed, adding link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
		<span class="n">managed_policy</span> <span class="o">=</span> <span class="n">cpufreq_cpu_get</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="n">cpu_dev</span> <span class="o">=</span> <span class="n">get_cpu_device</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
					<span class="s">&quot;cpufreq&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cpufreq_cpu_put</span><span class="p">(</span><span class="n">managed_policy</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpufreq_add_dev_interface</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="n">new_policy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">freq_attr</span> <span class="o">**</span><span class="n">drv_attr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="cm">/* prepare interface data */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">kobject_init_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ktype_cpufreq</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;cpufreq&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* set up files for this cpu device */</span>
	<span class="n">drv_attr</span> <span class="o">=</span> <span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">drv_attr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">drv_attr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="o">*</span><span class="n">drv_attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out_kobj_put</span><span class="p">;</span>
		<span class="n">drv_attr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpuinfo_cur_freq</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out_kobj_put</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scaling_cur_freq</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out_kobj_put</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">bios_limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bios_limit</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out_kobj_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_online</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_cpu_data</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">policy</span><span class="p">;</span>
		<span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_policy_cpu</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cpufreq_add_dev_symlink</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_kobj_put</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_policy</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span><span class="p">));</span>
	<span class="cm">/* assure that the starting sequence is run in __cpufreq_set_policy */</span>
	<span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* set default policy */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__cpufreq_set_policy</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_policy</span><span class="p">);</span>
	<span class="n">policy</span><span class="o">-&gt;</span><span class="n">user_policy</span><span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">policy</span><span class="p">;</span>
	<span class="n">policy</span><span class="o">-&gt;</span><span class="n">user_policy</span><span class="p">.</span><span class="n">governor</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;setting policy failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">)</span>
			<span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">err_out_kobj_put:</span>
	<span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">kobj_unregister</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * cpufreq_add_dev - add a CPU device</span>
<span class="cm"> *</span>
<span class="cm"> * Adds the cpufreq interface for a CPU device.</span>
<span class="cm"> *</span>
<span class="cm"> * The Oracle says: try running cpufreq registration/unregistration concurrently</span>
<span class="cm"> * with with cpu hotplugging and all hell will break loose. Tried to clean this</span>
<span class="cm"> * mess up, but more thorough testing is needed. - Mathieu</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpufreq_add_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">subsys_interface</span> <span class="o">*</span><span class="n">sif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_HOTPLUG_CPU</span>
	<span class="kt">int</span> <span class="n">sibling</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_offline</span><span class="p">(</span><span class="n">cpu</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;adding CPU %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="cm">/* check whether a different CPU already registered this</span>
<span class="cm">	 * CPU because it is in the same boat. */</span>
	<span class="n">policy</span> <span class="o">=</span> <span class="n">cpufreq_cpu_get</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">policy</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cpufreq_cpu_put</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">module_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">policy</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">policy</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nomem_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_free_policy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zalloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">related_cpus</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_free_cpumask</span><span class="p">;</span>

	<span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="n">cpumask_copy</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">,</span> <span class="n">cpumask_of</span><span class="p">(</span><span class="n">cpu</span><span class="p">));</span>

	<span class="cm">/* Initially set CPU itself as the policy_cpu */</span>
	<span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_policy_cpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">lock_policy_rwsem_write</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">kobj_unregister</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">,</span> <span class="n">handle_update</span><span class="p">);</span>

	<span class="cm">/* Set governor before -&gt;init, so that driver could check it */</span>
<span class="cp">#ifdef CONFIG_HOTPLUG_CPU</span>
	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">sibling</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_cpu_data</span><span class="p">,</span> <span class="n">sibling</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&amp;&amp;</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">governor</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">cpumask_test_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">related_cpus</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">governor</span><span class="p">;</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span> <span class="o">=</span> <span class="n">CPUFREQ_DEFAULT_GOVERNOR</span><span class="p">;</span>
	<span class="cm">/* call driver. From then on the cpufreq must be able</span>
<span class="cm">	 * to accept all calls to -&gt;verify and -&gt;setpolicy for this CPU</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unlock_policy</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">policy</span><span class="o">-&gt;</span><span class="n">user_policy</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">;</span>
	<span class="n">policy</span><span class="o">-&gt;</span><span class="n">user_policy</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>

	<span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_policy_notifier_list</span><span class="p">,</span>
				     <span class="n">CPUFREQ_START</span><span class="p">,</span> <span class="n">policy</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cpufreq_add_dev_policy</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* This is a managed cpu, symlink created,</span>
<span class="cm">			   exit with 0 */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unlock_policy</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cpufreq_add_dev_interface</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_unregister</span><span class="p">;</span>

	<span class="n">unlock_policy_rwsem_write</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>

	<span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_ADD</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;initialization complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


<span class="nl">err_out_unregister:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">)</span>
		<span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_cpu_data</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">kobj_unregister</span><span class="p">);</span>

<span class="nl">err_unlock_policy:</span>
	<span class="n">unlock_policy_rwsem_write</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">related_cpus</span><span class="p">);</span>
<span class="nl">err_free_cpumask:</span>
	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">);</span>
<span class="nl">err_free_policy:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
<span class="nl">nomem_out:</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
<span class="nl">module_out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * __cpufreq_remove_dev - remove a CPU device</span>
<span class="cm"> *</span>
<span class="cm"> * Removes the cpufreq interface for a CPU device.</span>
<span class="cm"> * Caller should already have policy_rwsem in write mode for this CPU.</span>
<span class="cm"> * This routine frees the rwsem before returning.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__cpufreq_remove_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">subsys_interface</span> <span class="o">*</span><span class="n">sif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">cmp</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">cpu_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;unregistering CPU %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_cpu_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">unlock_policy_rwsem_write</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_cpu_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>


<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="cm">/* if this isn&#39;t the CPU which is the parent of the kobj, we</span>
<span class="cm">	 * only need to unlink, put and exit</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cpu</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;removing link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cpumask_clear_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">kobj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">;</span>
		<span class="n">cpufreq_cpu_put</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">unlock_policy_rwsem_write</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;cpufreq&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SMP</span>

<span class="cp">#ifdef CONFIG_HOTPLUG_CPU</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_cpu_governor</span><span class="p">,</span> <span class="n">cpu</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">CPUFREQ_NAME_LEN</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* if we have other CPUs still registered, we need to unlink them,</span>
<span class="cm">	 * or else wait_for_completion below will lock up. Clean the</span>
<span class="cm">	 * per_cpu(cpufreq_cpu_data) while holding the lock, and remove</span>
<span class="cm">	 * the sysfs links afterwards.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cpumask_weight</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">cpu</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_cpu_data</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cpumask_weight</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">cpu</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;removing link for cpu %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_HOTPLUG_CPU</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_cpu_governor</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">CPUFREQ_NAME_LEN</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">cpu_dev</span> <span class="o">=</span> <span class="n">get_cpu_device</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
			<span class="n">kobj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpu_dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">;</span>
			<span class="n">unlock_policy_rwsem_write</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
			<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;cpufreq&quot;</span><span class="p">);</span>
			<span class="n">lock_policy_rwsem_write</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
			<span class="n">cpufreq_cpu_put</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">)</span>
		<span class="n">__cpufreq_governor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">CPUFREQ_GOV_STOP</span><span class="p">);</span>

	<span class="n">kobj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">;</span>
	<span class="n">cmp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kobj_unregister</span><span class="p">;</span>
	<span class="n">unlock_policy_rwsem_write</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="n">kobject_put</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>

	<span class="cm">/* we need to make sure that the underlying kobj is actually</span>
<span class="cm">	 * not referenced anymore by anybody before we proceed with</span>
<span class="cm">	 * unloading.</span>
<span class="cm">	 */</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;waiting for dropping of refcount</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="n">cmp</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;wait complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">lock_policy_rwsem_write</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">)</span>
		<span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">unlock_policy_rwsem_write</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_HOTPLUG_CPU</span>
	<span class="cm">/* when the CPU which is the parent of the kobj is hotplugged</span>
<span class="cm">	 * offline, check for siblings, and create cpufreq sysfs interface</span>
<span class="cm">	 * and symlinks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cpumask_weight</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* first sibling now owns the new sysfs dir */</span>
		<span class="n">cpumask_clear_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">);</span>
		<span class="n">cpufreq_add_dev</span><span class="p">(</span><span class="n">get_cpu_device</span><span class="p">(</span><span class="n">cpumask_first</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">)),</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="cm">/* finally remove our own symlink */</span>
		<span class="n">lock_policy_rwsem_write</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="n">__cpufreq_remove_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sif</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">related_cpus</span><span class="p">);</span>
	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpufreq_remove_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">subsys_interface</span> <span class="o">*</span><span class="n">sif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_offline</span><span class="p">(</span><span class="n">cpu</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lock_policy_rwsem_write</span><span class="p">(</span><span class="n">cpu</span><span class="p">)))</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">__cpufreq_remove_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sif</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cpufreq_policy</span><span class="p">,</span> <span class="n">update</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;handle_update for cpu %u called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="n">cpufreq_update_policy</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	cpufreq_out_of_sync - If actual and saved CPU frequency differs, we&#39;re in deep trouble.</span>
<span class="cm"> *	@cpu: cpu number</span>
<span class="cm"> *	@old_freq: CPU frequency the kernel thinks the CPU runs at</span>
<span class="cm"> *	@new_freq: CPU frequency the CPU actually runs at</span>
<span class="cm"> *</span>
<span class="cm"> *	We adjust to current frequency first, and need to clean up later.</span>
<span class="cm"> *	So either call to cpufreq_update_policy() or schedule handle_update()).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpufreq_out_of_sync</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old_freq</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_freqs</span> <span class="n">freqs</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Warning: CPU frequency out of sync: cpufreq and timing &quot;</span>
	       <span class="s">&quot;core thinks of %u, is %u kHz.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">old_freq</span><span class="p">,</span> <span class="n">new_freq</span><span class="p">);</span>

	<span class="n">freqs</span><span class="p">.</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="n">freqs</span><span class="p">.</span><span class="n">old</span> <span class="o">=</span> <span class="n">old_freq</span><span class="p">;</span>
	<span class="n">freqs</span><span class="p">.</span><span class="n">new</span> <span class="o">=</span> <span class="n">new_freq</span><span class="p">;</span>
	<span class="n">cpufreq_notify_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">freqs</span><span class="p">,</span> <span class="n">CPUFREQ_PRECHANGE</span><span class="p">);</span>
	<span class="n">cpufreq_notify_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">freqs</span><span class="p">,</span> <span class="n">CPUFREQ_POSTCHANGE</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * cpufreq_quick_get - get the CPU frequency (in kHz) from policy-&gt;cur</span>
<span class="cm"> * @cpu: CPU number</span>
<span class="cm"> *</span>
<span class="cm"> * This is the last known freq, without actually getting it from the driver.</span>
<span class="cm"> * Return value will be same as what is shown in scaling_cur_freq in sysfs.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">cpufreq_quick_get</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span> <span class="o">=</span> <span class="n">cpufreq_cpu_get</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_freq</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">;</span>
		<span class="n">cpufreq_cpu_put</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret_freq</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cpufreq_quick_get</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * cpufreq_quick_get_max - get the max reported CPU frequency for this CPU</span>
<span class="cm"> * @cpu: CPU number</span>
<span class="cm"> *</span>
<span class="cm"> * Just return the max possible frequency for a given CPU.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">cpufreq_quick_get_max</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span> <span class="o">=</span> <span class="n">cpufreq_cpu_get</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_freq</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
		<span class="n">cpufreq_cpu_put</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret_freq</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cpufreq_quick_get_max</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">__cpufreq_get</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_cpu_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_freq</span><span class="p">;</span>

	<span class="n">ret_freq</span> <span class="o">=</span> <span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret_freq</span> <span class="o">&amp;&amp;</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CPUFREQ_CONST_LOOPS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* verify no discrepancy between actual and</span>
<span class="cm">					saved value exists */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret_freq</span> <span class="o">!=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cpufreq_out_of_sync</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span> <span class="n">ret_freq</span><span class="p">);</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret_freq</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cpufreq_get - get the current CPU frequency (in kHz)</span>
<span class="cm"> * @cpu: CPU number</span>
<span class="cm"> *</span>
<span class="cm"> * Get the CPU current (static) CPU frequency</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">cpufreq_get</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span> <span class="o">=</span> <span class="n">cpufreq_cpu_get</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">policy</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lock_policy_rwsem_read</span><span class="p">(</span><span class="n">cpu</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_policy</span><span class="p">;</span>

	<span class="n">ret_freq</span> <span class="o">=</span> <span class="n">__cpufreq_get</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>

	<span class="n">unlock_policy_rwsem_read</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>

<span class="nl">out_policy:</span>
	<span class="n">cpufreq_cpu_put</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret_freq</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cpufreq_get</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">subsys_interface</span> <span class="n">cpufreq_interface</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cpufreq&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">subsys</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">cpu_subsys</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_dev</span>	<span class="o">=</span> <span class="n">cpufreq_add_dev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_dev</span>	<span class="o">=</span> <span class="n">cpufreq_remove_dev</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * cpufreq_bp_suspend - Prepare the boot CPU for system suspend.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is only executed for the boot processor.  The other CPUs</span>
<span class="cm"> * have been put offline by means of CPU hotplug.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpufreq_bp_suspend</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">cpu_policy</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;suspending cpu %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="cm">/* If there&#39;s no policy for the boot CPU, we have nothing to do. */</span>
	<span class="n">cpu_policy</span> <span class="o">=</span> <span class="n">cpufreq_cpu_get</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_policy</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">cpu_policy</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cpufreq: suspend failed in -&gt;suspend &quot;</span>
					<span class="s">&quot;step on CPU %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu_policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cpufreq_cpu_put</span><span class="p">(</span><span class="n">cpu_policy</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cpufreq_bp_resume - Restore proper frequency handling of the boot CPU.</span>
<span class="cm"> *</span>
<span class="cm"> *	1.) resume CPUfreq hardware support (cpufreq_driver-&gt;resume())</span>
<span class="cm"> *	2.) schedule call cpufreq_update_policy() ASAP as interrupts are</span>
<span class="cm"> *	    restored. It will verify that the current freq is in sync with</span>
<span class="cm"> *	    what we believe it to be. This is a bit later than when it</span>
<span class="cm"> *	    should be, but nonethteless it&#39;s better than calling</span>
<span class="cm"> *	    cpufreq_driver-&gt;get() here which might re-enable interrupts...</span>
<span class="cm"> *</span>
<span class="cm"> * This function is only executed for the boot CPU.  The other CPUs have not</span>
<span class="cm"> * been turned on yet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpufreq_bp_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">cpu_policy</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;resuming cpu %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="cm">/* If there&#39;s no policy for the boot CPU, we have nothing to do. */</span>
	<span class="n">cpu_policy</span> <span class="o">=</span> <span class="n">cpufreq_cpu_get</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_policy</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">cpu_policy</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cpufreq: resume failed in -&gt;resume &quot;</span>
					<span class="s">&quot;step on CPU %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu_policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_policy</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">);</span>

<span class="nl">fail:</span>
	<span class="n">cpufreq_cpu_put</span><span class="p">(</span><span class="n">cpu_policy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">syscore_ops</span> <span class="n">cpufreq_syscore_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">cpufreq_bp_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">cpufreq_bp_resume</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*********************************************************************</span>
<span class="cm"> *                     NOTIFIER LISTS INTERFACE                      *</span>
<span class="cm"> *********************************************************************/</span>

<span class="cm">/**</span>
<span class="cm"> *	cpufreq_register_notifier - register a driver with cpufreq</span>
<span class="cm"> *	@nb: notifier function to register</span>
<span class="cm"> *      @list: CPUFREQ_TRANSITION_NOTIFIER or CPUFREQ_POLICY_NOTIFIER</span>
<span class="cm"> *</span>
<span class="cm"> *	Add a driver to one of two lists: either a list of drivers that</span>
<span class="cm"> *      are notified about clock rate changes (once before and once after</span>
<span class="cm"> *      the transition), or a list of drivers that are notified about</span>
<span class="cm"> *      changes in cpufreq policy.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function may sleep, and has the same return conditions as</span>
<span class="cm"> *	blocking_notifier_chain_register.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cpufreq_register_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">init_cpufreq_transition_notifier_list_called</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPUFREQ_TRANSITION_NOTIFIER</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">srcu_notifier_chain_register</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">cpufreq_transition_notifier_list</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPUFREQ_POLICY_NOTIFIER</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">blocking_notifier_chain_register</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">cpufreq_policy_notifier_list</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cpufreq_register_notifier</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> *	cpufreq_unregister_notifier - unregister a driver with cpufreq</span>
<span class="cm"> *	@nb: notifier block to be unregistered</span>
<span class="cm"> *      @list: CPUFREQ_TRANSITION_NOTIFIER or CPUFREQ_POLICY_NOTIFIER</span>
<span class="cm"> *</span>
<span class="cm"> *	Remove a driver from the CPU frequency notifier list.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function may sleep, and has the same return conditions as</span>
<span class="cm"> *	blocking_notifier_chain_unregister.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cpufreq_unregister_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPUFREQ_TRANSITION_NOTIFIER</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">srcu_notifier_chain_unregister</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">cpufreq_transition_notifier_list</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPUFREQ_POLICY_NOTIFIER</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">blocking_notifier_chain_unregister</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">cpufreq_policy_notifier_list</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cpufreq_unregister_notifier</span><span class="p">);</span>


<span class="cm">/*********************************************************************</span>
<span class="cm"> *                              GOVERNORS                            *</span>
<span class="cm"> *********************************************************************/</span>


<span class="kt">int</span> <span class="nf">__cpufreq_driver_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">target_freq</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">relation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_disabled</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;target for CPU %u: %u kHz, relation %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span>
		<span class="n">target_freq</span><span class="p">,</span> <span class="n">relation</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_online</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">target_freq</span><span class="p">,</span> <span class="n">relation</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">__cpufreq_driver_target</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cpufreq_driver_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">target_freq</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">relation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">policy</span> <span class="o">=</span> <span class="n">cpufreq_cpu_get</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">policy</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_policy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lock_policy_rwsem_write</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__cpufreq_driver_target</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">target_freq</span><span class="p">,</span> <span class="n">relation</span><span class="p">);</span>

	<span class="n">unlock_policy_rwsem_write</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>

<span class="nl">fail:</span>
	<span class="n">cpufreq_cpu_put</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
<span class="nl">no_policy:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cpufreq_driver_target</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">__cpufreq_driver_getavg</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">policy</span> <span class="o">=</span> <span class="n">cpufreq_cpu_get</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">policy</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_online</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">getavg</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">getavg</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="n">cpufreq_cpu_put</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">__cpufreq_driver_getavg</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * when &quot;event&quot; is CPUFREQ_GOV_LIMITS</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__cpufreq_governor</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Only must be defined when default governor is known to have latency</span>
<span class="cm">	   restrictions, like e.g. conservative or ondemand.</span>
<span class="cm">	   That this is the case is already ensured in Kconfig</span>
<span class="cm">	*/</span>
<span class="cp">#ifdef CONFIG_CPU_FREQ_GOV_PERFORMANCE</span>
	<span class="k">struct</span> <span class="n">cpufreq_governor</span> <span class="o">*</span><span class="n">gov</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpufreq_gov_performance</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">struct</span> <span class="n">cpufreq_governor</span> <span class="o">*</span><span class="n">gov</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">max_transition_latency</span> <span class="o">&amp;&amp;</span>
	    <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpuinfo</span><span class="p">.</span><span class="n">transition_latency</span> <span class="o">&gt;</span>
	    <span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">max_transition_latency</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gov</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s governor failed, too long&quot;</span>
			       <span class="s">&quot; transition latency of HW, fallback&quot;</span>
			       <span class="s">&quot; to %s governor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">gov</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span> <span class="o">=</span> <span class="n">gov</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;__cpufreq_governor for CPU %u, event %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">governor</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="cm">/* we keep one module reference alive for</span>
<span class="cm">			each CPU governed by this CPU */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">event</span> <span class="o">!=</span> <span class="n">CPUFREQ_GOV_START</span><span class="p">)</span> <span class="o">||</span> <span class="n">ret</span><span class="p">)</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">event</span> <span class="o">==</span> <span class="n">CPUFREQ_GOV_STOP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">cpufreq_register_governor</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_governor</span> <span class="o">*</span><span class="n">governor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">governor</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_disabled</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_governor_mutex</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__find_governor</span><span class="p">(</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">governor_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpufreq_governor_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_governor_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cpufreq_register_governor</span><span class="p">);</span>


<span class="kt">void</span> <span class="nf">cpufreq_unregister_governor</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_governor</span> <span class="o">*</span><span class="n">governor</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_HOTPLUG_CPU</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">governor</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_disabled</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_HOTPLUG_CPU</span>
	<span class="n">for_each_present_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_online</span><span class="p">(</span><span class="n">cpu</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_cpu_governor</span><span class="p">,</span> <span class="n">cpu</span><span class="p">),</span> <span class="n">governor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_cpu_governor</span><span class="p">,</span> <span class="n">cpu</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_governor_mutex</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">governor_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_governor_mutex</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cpufreq_unregister_governor</span><span class="p">);</span>



<span class="cm">/*********************************************************************</span>
<span class="cm"> *                          POLICY INTERFACE                         *</span>
<span class="cm"> *********************************************************************/</span>

<span class="cm">/**</span>
<span class="cm"> * cpufreq_get_policy - get the current cpufreq_policy</span>
<span class="cm"> * @policy: struct cpufreq_policy into which the current cpufreq_policy</span>
<span class="cm"> *	is written</span>
<span class="cm"> *</span>
<span class="cm"> * Reads the current cpufreq policy.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cpufreq_get_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">cpu_policy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">policy</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cpu_policy</span> <span class="o">=</span> <span class="n">cpufreq_cpu_get</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_policy</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">cpu_policy</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span><span class="p">));</span>

	<span class="n">cpufreq_cpu_put</span><span class="p">(</span><span class="n">cpu_policy</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cpufreq_get_policy</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * data   : current policy.</span>
<span class="cm"> * policy : policy to be set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__cpufreq_set_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;setting new policy for CPU %u: %u - %u kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span>
		<span class="n">policy</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpuinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpuinfo</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_cpuinfo</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">||</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* verify the cpu speed can be set within this limit */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">verify</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="cm">/* adjust if necessary - all reasons */</span>
	<span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_policy_notifier_list</span><span class="p">,</span>
			<span class="n">CPUFREQ_ADJUST</span><span class="p">,</span> <span class="n">policy</span><span class="p">);</span>

	<span class="cm">/* adjust if necessary - hardware incompatibility*/</span>
	<span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_policy_notifier_list</span><span class="p">,</span>
			<span class="n">CPUFREQ_INCOMPATIBLE</span><span class="p">,</span> <span class="n">policy</span><span class="p">);</span>

	<span class="cm">/* verify the cpu speed can be set within this limit,</span>
<span class="cm">	   which might be different to the first one */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">verify</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="cm">/* notification of the new policy */</span>
	<span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_policy_notifier_list</span><span class="p">,</span>
			<span class="n">CPUFREQ_NOTIFY</span><span class="p">,</span> <span class="n">policy</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;new min and max freqs are %u - %u kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">setpolicy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">policy</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;setting range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">setpolicy</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">governor</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* save old, working values */</span>
			<span class="k">struct</span> <span class="n">cpufreq_governor</span> <span class="o">*</span><span class="n">old_gov</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">governor</span><span class="p">;</span>

			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;governor switch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="cm">/* end old governor */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">governor</span><span class="p">)</span>
				<span class="n">__cpufreq_governor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">CPUFREQ_GOV_STOP</span><span class="p">);</span>

			<span class="cm">/* start new governor */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">governor</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">governor</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">__cpufreq_governor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">CPUFREQ_GOV_START</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* new governor failed, so re-start old one */</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;starting governor %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">governor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">old_gov</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">governor</span> <span class="o">=</span> <span class="n">old_gov</span><span class="p">;</span>
					<span class="n">__cpufreq_governor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
							   <span class="n">CPUFREQ_GOV_START</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* might be a policy change, too, so fall through */</span>
		<span class="p">}</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;governor: change or update limits</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">__cpufreq_governor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">CPUFREQ_GOV_LIMITS</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">error_out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	cpufreq_update_policy - re-evaluate an existing cpufreq policy</span>
<span class="cm"> *	@cpu: CPU which shall be re-evaluated</span>
<span class="cm"> *</span>
<span class="cm"> *	Useful for policy notifiers which have different necessities</span>
<span class="cm"> *	at different times.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cpufreq_update_policy</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">cpufreq_cpu_get</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="n">policy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">no_policy</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lock_policy_rwsem_write</span><span class="p">(</span><span class="n">cpu</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;updating policy for CPU %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span><span class="p">));</span>
	<span class="n">policy</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">user_policy</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
	<span class="n">policy</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">user_policy</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
	<span class="n">policy</span><span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">user_policy</span><span class="p">.</span><span class="n">policy</span><span class="p">;</span>
	<span class="n">policy</span><span class="p">.</span><span class="n">governor</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">user_policy</span><span class="p">.</span><span class="n">governor</span><span class="p">;</span>

	<span class="cm">/* BIOS might change freq behind our back</span>
<span class="cm">	  -&gt; ask driver for current freq and notify governors about a change */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">policy</span><span class="p">.</span><span class="n">cur</span> <span class="o">=</span> <span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Driver did not initialize current freq&quot;</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">=</span> <span class="n">policy</span><span class="p">.</span><span class="n">cur</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">!=</span> <span class="n">policy</span><span class="p">.</span><span class="n">cur</span><span class="p">)</span>
				<span class="n">cpufreq_out_of_sync</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">,</span>
								<span class="n">policy</span><span class="p">.</span><span class="n">cur</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__cpufreq_set_policy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">policy</span><span class="p">);</span>

	<span class="n">unlock_policy_rwsem_write</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>

<span class="nl">fail:</span>
	<span class="n">cpufreq_cpu_put</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="nl">no_policy:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cpufreq_update_policy</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__cpuinit</span> <span class="nf">cpufreq_cpu_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nfb</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">hcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hcpu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">get_cpu_device</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CPU_ONLINE</span>:
		<span class="k">case</span> <span class="n">CPU_ONLINE_FROZEN</span>:
			<span class="n">cpufreq_add_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CPU_DOWN_PREPARE</span>:
		<span class="k">case</span> <span class="n">CPU_DOWN_PREPARE_FROZEN</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lock_policy_rwsem_write</span><span class="p">(</span><span class="n">cpu</span><span class="p">)))</span>
				<span class="n">BUG</span><span class="p">();</span>

			<span class="n">__cpufreq_remove_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CPU_DOWN_FAILED</span>:
		<span class="k">case</span> <span class="n">CPU_DOWN_FAILED_FROZEN</span>:
			<span class="n">cpufreq_add_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">__refdata</span> <span class="n">cpufreq_cpu_notifier</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">cpufreq_cpu_callback</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> *               REGISTER / UNREGISTER CPUFREQ DRIVER                *</span>
<span class="cm"> *********************************************************************/</span>

<span class="cm">/**</span>
<span class="cm"> * cpufreq_register_driver - register a CPU Frequency driver</span>
<span class="cm"> * @driver_data: A struct cpufreq_driver containing the values#</span>
<span class="cm"> * submitted by the CPU Frequency driver.</span>
<span class="cm"> *</span>
<span class="cm"> *   Registers a CPU Frequency driver to this core code. This code</span>
<span class="cm"> * returns zero on success, -EBUSY when another driver got here first</span>
<span class="cm"> * (and isn&#39;t unregistered in the meantime).</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cpufreq_register_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_driver</span> <span class="o">*</span><span class="n">driver_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_disabled</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver_data</span> <span class="o">||</span> <span class="o">!</span><span class="n">driver_data</span><span class="o">-&gt;</span><span class="n">verify</span> <span class="o">||</span> <span class="o">!</span><span class="n">driver_data</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">||</span>
	    <span class="p">((</span><span class="o">!</span><span class="n">driver_data</span><span class="o">-&gt;</span><span class="n">setpolicy</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">driver_data</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;trying to register driver %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">driver_data</span><span class="o">-&gt;</span><span class="n">setpolicy</span><span class="p">)</span>
		<span class="n">driver_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CPUFREQ_CONST_LOOPS</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cpufreq_driver</span> <span class="o">=</span> <span class="n">driver_data</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">subsys_interface_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_null_driver</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cpufreq_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CPUFREQ_STICKY</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

		<span class="cm">/* check for at least one working CPU */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_cpu_ids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cpu_possible</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_cpu_data</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="cm">/* if all -&gt;init() calls failed, unregister */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;no CPU initialized for driver %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">driver_data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_if_unreg</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">register_hotcpu_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_cpu_notifier</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;driver %s up and running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_if_unreg:</span>
	<span class="n">subsys_interface_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_interface</span><span class="p">);</span>
<span class="nl">err_null_driver:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cpufreq_driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cpufreq_register_driver</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> * cpufreq_unregister_driver - unregister the current CPUFreq driver</span>
<span class="cm"> *</span>
<span class="cm"> *    Unregister the current CPUFreq driver. Only call this if you have</span>
<span class="cm"> * the right to do so, i.e. if you have succeeded in initialising before!</span>
<span class="cm"> * Returns zero if successful, and -EINVAL if the cpufreq_driver is</span>
<span class="cm"> * currently not initialised.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cpufreq_unregister_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpufreq_driver</span> <span class="o">||</span> <span class="p">(</span><span class="n">driver</span> <span class="o">!=</span> <span class="n">cpufreq_driver</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;unregistering driver %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">subsys_interface_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_interface</span><span class="p">);</span>
	<span class="n">unregister_hotcpu_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_cpu_notifier</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cpufreq_driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cpufreq_unregister_driver</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cpufreq_core_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_disabled</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">per_cpu</span><span class="p">(</span><span class="n">cpufreq_policy_cpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_policy_rwsem</span><span class="p">,</span> <span class="n">cpu</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">cpufreq_global_kobject</span> <span class="o">=</span> <span class="n">kobject_create_and_add</span><span class="p">(</span><span class="s">&quot;cpufreq&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpu_subsys</span><span class="p">.</span><span class="n">dev_root</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">cpufreq_global_kobject</span><span class="p">);</span>
	<span class="n">register_syscore_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpufreq_syscore_ops</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">core_initcall</span><span class="p">(</span><span class="n">cpufreq_core_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
