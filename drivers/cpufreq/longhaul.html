<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › cpufreq › longhaul.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>longhaul.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  (C) 2001-2004  Dave Jones. &lt;davej@redhat.com&gt;</span>
<span class="cm"> *  (C) 2002  Padraig Brady. &lt;padraig@antefacto.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Licensed under the terms of the GNU GPL License version 2.</span>
<span class="cm"> *  Based upon datasheets &amp; sample CPUs kindly provided by VIA.</span>
<span class="cm"> *</span>
<span class="cm"> *  VIA have currently 3 different versions of Longhaul.</span>
<span class="cm"> *  Version 1 (Longhaul) uses the BCR2 MSR at 0x1147.</span>
<span class="cm"> *   It is present only in Samuel 1 (C5A), Samuel 2 (C5B) stepping 0.</span>
<span class="cm"> *  Version 2 of longhaul is backward compatible with v1, but adds</span>
<span class="cm"> *   LONGHAUL MSR for purpose of both frequency and voltage scaling.</span>
<span class="cm"> *   Present in Samuel 2 (steppings 1-7 only) (C5B), and Ezra (C5C).</span>
<span class="cm"> *  Version 3 of longhaul got renamed to Powersaver and redesigned</span>
<span class="cm"> *   to use only the POWERSAVER MSR at 0x110a.</span>
<span class="cm"> *   It is present in Ezra-T (C5M), Nehemiah (C5X) and above.</span>
<span class="cm"> *   It&#39;s pretty much the same feature wise to longhaul v2, though</span>
<span class="cm"> *   there is provision for scaling FSB too, but this doesn&#39;t work</span>
<span class="cm"> *   too well in practice so we don&#39;t even try to use this.</span>
<span class="cm"> *</span>
<span class="cm"> *  BIG FAT DISCLAIMER: Work in progress code. Possibly *dangerous*</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/cpufreq.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/timex.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/acpi.h&gt;</span>

<span class="cp">#include &lt;asm/msr.h&gt;</span>
<span class="cp">#include &lt;asm/cpu_device_id.h&gt;</span>
<span class="cp">#include &lt;acpi/processor.h&gt;</span>

<span class="cp">#include &quot;longhaul.h&quot;</span>

<span class="cp">#define PFX &quot;longhaul: &quot;</span>

<span class="cp">#define TYPE_LONGHAUL_V1	1</span>
<span class="cp">#define TYPE_LONGHAUL_V2	2</span>
<span class="cp">#define TYPE_POWERSAVER		3</span>

<span class="cp">#define	CPU_SAMUEL	1</span>
<span class="cp">#define	CPU_SAMUEL2	2</span>
<span class="cp">#define	CPU_EZRA	3</span>
<span class="cp">#define	CPU_EZRA_T	4</span>
<span class="cp">#define	CPU_NEHEMIAH	5</span>
<span class="cp">#define	CPU_NEHEMIAH_C	6</span>

<span class="cm">/* Flags */</span>
<span class="cp">#define USE_ACPI_C3		(1 &lt;&lt; 1)</span>
<span class="cp">#define USE_NORTHBRIDGE		(1 &lt;&lt; 2)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cpu_model</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">numscales</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fsb</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mV_pos</span> <span class="o">*</span><span class="n">vrm_mV_table</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mV_vrm_table</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">highest_speed</span><span class="p">,</span> <span class="n">lowest_speed</span><span class="p">;</span> <span class="cm">/* kHz */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">minmult</span><span class="p">,</span> <span class="n">maxmult</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">can_scale_voltage</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">acpi_processor</span> <span class="o">*</span><span class="n">pr</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">acpi_processor_cx</span> <span class="o">*</span><span class="n">cx</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">acpi_regs_addr</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">longhaul_flags</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">longhaul_index</span><span class="p">;</span>

<span class="cm">/* Module parameters */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scale_voltage</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">disable_acpi_c3</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">revid_errata</span><span class="p">;</span>


<span class="cm">/* Clock ratios multiplied by 10 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mults</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eblcr</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">longhaul_version</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="o">*</span><span class="n">longhaul_table</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">speedbuffer</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">print_speed</span><span class="p">(</span><span class="kt">int</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">speedbuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">speedbuffer</span><span class="p">),</span> <span class="s">&quot;%dMHz&quot;</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">speedbuffer</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span><span class="o">%</span><span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">speedbuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">speedbuffer</span><span class="p">),</span>
			<span class="s">&quot;%dGHz&quot;</span><span class="p">,</span> <span class="n">speed</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">speedbuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">speedbuffer</span><span class="p">),</span>
			<span class="s">&quot;%d.%dGHz&quot;</span><span class="p">,</span> <span class="n">speed</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="p">(</span><span class="n">speed</span><span class="o">%</span><span class="mi">1000</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">speedbuffer</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">calc_speed</span><span class="p">(</span><span class="kt">int</span> <span class="n">mult</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">khz</span><span class="p">;</span>
	<span class="n">khz</span> <span class="o">=</span> <span class="p">(</span><span class="n">mult</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="n">fsb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mult</span><span class="o">%</span><span class="mi">10</span><span class="p">)</span>
		<span class="n">khz</span> <span class="o">+=</span> <span class="n">fsb</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">khz</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">khz</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">longhaul_get_cpu_mult</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">invalue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>

	<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_IA32_EBL_CR_POWERON</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
	<span class="n">invalue</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">22</span><span class="o">|</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">23</span><span class="o">|</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="o">|</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">25</span><span class="p">))</span><span class="o">&gt;&gt;</span><span class="mi">22</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">longhaul_version</span> <span class="o">==</span> <span class="n">TYPE_LONGHAUL_V2</span> <span class="o">||</span>
	    <span class="n">longhaul_version</span> <span class="o">==</span> <span class="n">TYPE_POWERSAVER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">27</span><span class="p">))</span>
			<span class="n">invalue</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">eblcr</span><span class="p">[</span><span class="n">invalue</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* For processor with BCR2 MSR */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_longhaul1</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mults_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">msr_bcr2</span> <span class="n">bcr2</span><span class="p">;</span>

	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_VIA_BCR2</span><span class="p">,</span> <span class="n">bcr2</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
	<span class="cm">/* Enable software clock multiplier */</span>
	<span class="n">bcr2</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">ESOFTBF</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bcr2</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CLOCKMUL</span> <span class="o">=</span> <span class="n">mults_index</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* Sync to timer tick */</span>
	<span class="n">safe_halt</span><span class="p">();</span>
	<span class="cm">/* Change frequency on next halt or sleep */</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_VIA_BCR2</span><span class="p">,</span> <span class="n">bcr2</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
	<span class="cm">/* Invoke transition */</span>
	<span class="n">ACPI_FLUSH_CPU_CACHE</span><span class="p">();</span>
	<span class="n">halt</span><span class="p">();</span>

	<span class="cm">/* Disable software clock multiplier */</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>
	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_VIA_BCR2</span><span class="p">,</span> <span class="n">bcr2</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
	<span class="n">bcr2</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">ESOFTBF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_VIA_BCR2</span><span class="p">,</span> <span class="n">bcr2</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* For processor with Longhaul MSR */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_powersaver</span><span class="p">(</span><span class="kt">int</span> <span class="n">cx_address</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mults_index</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">msr_longhaul</span> <span class="n">longhaul</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">t</span><span class="p">;</span>

	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_VIA_LONGHAUL</span><span class="p">,</span> <span class="n">longhaul</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
	<span class="cm">/* Setup new frequency */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">revid_errata</span><span class="p">)</span>
		<span class="n">longhaul</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">RevisionKey</span> <span class="o">=</span> <span class="n">longhaul</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">RevisionID</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">longhaul</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">RevisionKey</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">longhaul</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">SoftBusRatio</span> <span class="o">=</span> <span class="n">mults_index</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">longhaul</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">SoftBusRatio4</span> <span class="o">=</span> <span class="p">(</span><span class="n">mults_index</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="cm">/* Setup new voltage */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">can_scale_voltage</span><span class="p">)</span>
		<span class="n">longhaul</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">SoftVID</span> <span class="o">=</span> <span class="p">(</span><span class="n">mults_index</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="cm">/* Sync to timer tick */</span>
	<span class="n">safe_halt</span><span class="p">();</span>
	<span class="cm">/* Raise voltage if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">can_scale_voltage</span> <span class="o">&amp;&amp;</span> <span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">longhaul</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">EnableSoftVID</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_VIA_LONGHAUL</span><span class="p">,</span> <span class="n">longhaul</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
		<span class="cm">/* Change voltage */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cx_address</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ACPI_FLUSH_CPU_CACHE</span><span class="p">();</span>
			<span class="n">halt</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ACPI_FLUSH_CPU_CACHE</span><span class="p">();</span>
			<span class="cm">/* Invoke C3 */</span>
			<span class="n">inb</span><span class="p">(</span><span class="n">cx_address</span><span class="p">);</span>
			<span class="cm">/* Dummy op - must do something useless after P_LVL3</span>
<span class="cm">			 * read */</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">acpi_gbl_FADT</span><span class="p">.</span><span class="n">xpm_timer_block</span><span class="p">.</span><span class="n">address</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">longhaul</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">EnableSoftVID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_VIA_LONGHAUL</span><span class="p">,</span> <span class="n">longhaul</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Change frequency on next halt or sleep */</span>
	<span class="n">longhaul</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">EnableSoftBusRatio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_VIA_LONGHAUL</span><span class="p">,</span> <span class="n">longhaul</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cx_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ACPI_FLUSH_CPU_CACHE</span><span class="p">();</span>
		<span class="n">halt</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ACPI_FLUSH_CPU_CACHE</span><span class="p">();</span>
		<span class="cm">/* Invoke C3 */</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">cx_address</span><span class="p">);</span>
		<span class="cm">/* Dummy op - must do something useless after P_LVL3 read */</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">acpi_gbl_FADT</span><span class="p">.</span><span class="n">xpm_timer_block</span><span class="p">.</span><span class="n">address</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Disable bus ratio bit */</span>
	<span class="n">longhaul</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">EnableSoftBusRatio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_VIA_LONGHAUL</span><span class="p">,</span> <span class="n">longhaul</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Reduce voltage if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">can_scale_voltage</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">longhaul</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">EnableSoftVID</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_VIA_LONGHAUL</span><span class="p">,</span> <span class="n">longhaul</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
		<span class="cm">/* Change voltage */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cx_address</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ACPI_FLUSH_CPU_CACHE</span><span class="p">();</span>
			<span class="n">halt</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ACPI_FLUSH_CPU_CACHE</span><span class="p">();</span>
			<span class="cm">/* Invoke C3 */</span>
			<span class="n">inb</span><span class="p">(</span><span class="n">cx_address</span><span class="p">);</span>
			<span class="cm">/* Dummy op - must do something useless after P_LVL3</span>
<span class="cm">			 * read */</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">acpi_gbl_FADT</span><span class="p">.</span><span class="n">xpm_timer_block</span><span class="p">.</span><span class="n">address</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">longhaul</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">EnableSoftVID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_VIA_LONGHAUL</span><span class="p">,</span> <span class="n">longhaul</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * longhaul_set_cpu_frequency()</span>
<span class="cm"> * @mults_index : bitpattern of the new multiplier.</span>
<span class="cm"> *</span>
<span class="cm"> * Sets a new clock ratio.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">longhaul_setstate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">table_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mults_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">speed</span><span class="p">,</span> <span class="n">mult</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpufreq_freqs</span> <span class="n">freqs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pic1_mask</span><span class="p">,</span> <span class="n">pic2_mask</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bm_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bm_timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mults_index</span> <span class="o">=</span> <span class="n">longhaul_table</span><span class="p">[</span><span class="n">table_index</span><span class="p">].</span><span class="n">index</span><span class="p">;</span>
	<span class="cm">/* Safety precautions */</span>
	<span class="n">mult</span> <span class="o">=</span> <span class="n">mults</span><span class="p">[</span><span class="n">mults_index</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mult</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">speed</span> <span class="o">=</span> <span class="n">calc_speed</span><span class="p">(</span><span class="n">mult</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">highest_speed</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="n">lowest_speed</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* Voltage transition before frequency transition? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">can_scale_voltage</span> <span class="o">&amp;&amp;</span> <span class="n">longhaul_index</span> <span class="o">&lt;</span> <span class="n">table_index</span><span class="p">)</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">freqs</span><span class="p">.</span><span class="n">old</span> <span class="o">=</span> <span class="n">calc_speed</span><span class="p">(</span><span class="n">longhaul_get_cpu_mult</span><span class="p">());</span>
	<span class="n">freqs</span><span class="p">.</span><span class="n">new</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="n">freqs</span><span class="p">.</span><span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* longhaul.c is UP only driver */</span>

	<span class="n">cpufreq_notify_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">freqs</span><span class="p">,</span> <span class="n">CPUFREQ_PRECHANGE</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Setting to FSB:%dMHz Mult:%d.%dx (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fsb</span><span class="p">,</span> <span class="n">mult</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="n">mult</span><span class="o">%</span><span class="mi">10</span><span class="p">,</span> <span class="n">print_speed</span><span class="p">(</span><span class="n">speed</span><span class="o">/</span><span class="mi">1000</span><span class="p">));</span>
<span class="nl">retry_loop:</span>
	<span class="n">preempt_disable</span><span class="p">();</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">pic2_mask</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xA1</span><span class="p">);</span>
	<span class="n">pic1_mask</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0x21</span><span class="p">);</span>	<span class="cm">/* works on C3. save mask. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">);</span>	<span class="cm">/* Overkill */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>	<span class="cm">/* TMR0 only */</span>

	<span class="cm">/* Wait while PCI bus is busy. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_regs_addr</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">longhaul_flags</span> <span class="o">&amp;</span> <span class="n">USE_NORTHBRIDGE</span>
	    <span class="o">||</span> <span class="p">((</span><span class="n">pr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">bm_control</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">bm_status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">acpi_regs_addr</span><span class="p">);</span>
		<span class="n">bm_status</span> <span class="o">&amp;=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">bm_status</span> <span class="o">&amp;&amp;</span> <span class="n">bm_timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outw</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">acpi_regs_addr</span><span class="p">);</span>
			<span class="n">bm_timeout</span><span class="o">--</span><span class="p">;</span>
			<span class="n">bm_status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">acpi_regs_addr</span><span class="p">);</span>
			<span class="n">bm_status</span> <span class="o">&amp;=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">longhaul_flags</span> <span class="o">&amp;</span> <span class="n">USE_NORTHBRIDGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable AGP and PCI arbiters */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">bm_control</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable bus master arbitration */</span>
		<span class="n">acpi_write_bit_register</span><span class="p">(</span><span class="n">ACPI_BITREG_ARB_DISABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">longhaul_version</span><span class="p">)</span> <span class="p">{</span>

	<span class="cm">/*</span>
<span class="cm">	 * Longhaul v1. (Samuel[C5A] and Samuel2 stepping 0[C5B])</span>
<span class="cm">	 * Software controlled multipliers only.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">TYPE_LONGHAUL_V1</span>:
		<span class="n">do_longhaul1</span><span class="p">(</span><span class="n">mults_index</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Longhaul v2 appears in Samuel2 Steppings 1-&gt;7 [C5B] and Ezra [C5C]</span>
<span class="cm">	 *</span>
<span class="cm">	 * Longhaul v3 (aka Powersaver). (Ezra-T [C5M] &amp; Nehemiah [C5N])</span>
<span class="cm">	 * Nehemiah can do FSB scaling too, but this has never been proven</span>
<span class="cm">	 * to work in practice.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">TYPE_LONGHAUL_V2</span>:
	<span class="k">case</span> <span class="n">TYPE_POWERSAVER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">longhaul_flags</span> <span class="o">&amp;</span> <span class="n">USE_ACPI_C3</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Don&#39;t allow wakeup */</span>
			<span class="n">acpi_write_bit_register</span><span class="p">(</span><span class="n">ACPI_BITREG_BUS_MASTER_RLD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">do_powersaver</span><span class="p">(</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">mults_index</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">do_powersaver</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mults_index</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">longhaul_flags</span> <span class="o">&amp;</span> <span class="n">USE_NORTHBRIDGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable arbiters */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">bm_control</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable bus master arbitration */</span>
		<span class="n">acpi_write_bit_register</span><span class="p">(</span><span class="n">ACPI_BITREG_ARB_DISABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">pic2_mask</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">);</span>	<span class="cm">/* restore mask */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">pic1_mask</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">preempt_enable</span><span class="p">();</span>

	<span class="n">freqs</span><span class="p">.</span><span class="n">new</span> <span class="o">=</span> <span class="n">calc_speed</span><span class="p">(</span><span class="n">longhaul_get_cpu_mult</span><span class="p">());</span>
	<span class="cm">/* Check if requested frequency is set. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">freqs</span><span class="p">.</span><span class="n">new</span> <span class="o">!=</span> <span class="n">speed</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Failed to set requested frequency!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Revision ID = 1 but processor is expecting revision key</span>
<span class="cm">		 * equal to 0. Jumpers at the bottom of processor will change</span>
<span class="cm">		 * multiplier and FSB, but will not change bits in Longhaul</span>
<span class="cm">		 * MSR nor enable voltage scaling. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">revid_errata</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Enabling </span><span class="se">\&quot;</span><span class="s">Ignore Revision ID</span><span class="se">\&quot;</span><span class="s"> &quot;</span>
						<span class="s">&quot;option.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">revid_errata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">retry_loop</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Why ACPI C3 sometimes doesn&#39;t work is a mystery for me.</span>
<span class="cm">		 * But it does happen. Processor is entering ACPI C3 state,</span>
<span class="cm">		 * but it doesn&#39;t change frequency. I tried poking various</span>
<span class="cm">		 * bits in northbridge registers, but without success. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">longhaul_flags</span> <span class="o">&amp;</span> <span class="n">USE_ACPI_C3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Disabling ACPI C3 support.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">longhaul_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USE_ACPI_C3</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">revid_errata</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Disabling </span><span class="se">\&quot;</span><span class="s">Ignore &quot;</span>
						<span class="s">&quot;Revision ID</span><span class="se">\&quot;</span><span class="s"> option.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">revid_errata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">retry_loop</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* This shouldn&#39;t happen. Longhaul ver. 2 was reported not</span>
<span class="cm">		 * working on processors without voltage scaling, but with</span>
<span class="cm">		 * RevID = 1. RevID errata will make things right. Just</span>
<span class="cm">		 * to be 100% sure. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">longhaul_version</span> <span class="o">==</span> <span class="n">TYPE_LONGHAUL_V2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Switching to Longhaul ver. 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">longhaul_version</span> <span class="o">=</span> <span class="n">TYPE_LONGHAUL_V1</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">retry_loop</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Report true CPU frequency */</span>
	<span class="n">cpufreq_notify_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">freqs</span><span class="p">,</span> <span class="n">CPUFREQ_POSTCHANGE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bm_timeout</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Warning: Timeout while waiting for &quot;</span>
				<span class="s">&quot;idle PCI bus.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Centaur decided to make life a little more tricky.</span>
<span class="cm"> * Only longhaul v1 is allowed to read EBLCR BSEL[0:1].</span>
<span class="cm"> * Samuel2 and above have to try and guess what the FSB is.</span>
<span class="cm"> * We do this by assuming we booted at maximum multiplier, and interpolate</span>
<span class="cm"> * between that value multiplied by possible FSBs and cpu_mhz which</span>
<span class="cm"> * was calculated at boot time. Really ugly, but no other way to do this.</span>
<span class="cm"> */</span>

<span class="cp">#define ROUNDING	0xf</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">guess_fsb</span><span class="p">(</span><span class="kt">int</span> <span class="n">mult</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">cpu_khz</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">speeds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">666</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1333</span><span class="p">,</span> <span class="mi">2000</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">f_max</span><span class="p">,</span> <span class="n">f_min</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">f_max</span> <span class="o">=</span> <span class="p">((</span><span class="n">speeds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">mult</span><span class="p">)</span> <span class="o">+</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">f_max</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ROUNDING</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">f_min</span> <span class="o">=</span> <span class="n">f_max</span> <span class="o">-</span> <span class="n">ROUNDING</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">speed</span> <span class="o">&lt;=</span> <span class="n">f_max</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;=</span> <span class="n">f_min</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">speeds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__cpuinit</span> <span class="nf">longhaul_get_ranges</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ratio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mult</span><span class="p">;</span>

	<span class="cm">/* Get current frequency */</span>
	<span class="n">mult</span> <span class="o">=</span> <span class="n">longhaul_get_cpu_mult</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mult</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Invalid (reserved) multiplier!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fsb</span> <span class="o">=</span> <span class="n">guess_fsb</span><span class="p">(</span><span class="n">mult</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fsb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Invalid (reserved) FSB!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Get max multiplier - as we always did.</span>
<span class="cm">	 * Longhaul MSR is useful only when voltage scaling is enabled.</span>
<span class="cm">	 * C3 is booting at max anyway. */</span>
	<span class="n">maxmult</span> <span class="o">=</span> <span class="n">mult</span><span class="p">;</span>
	<span class="cm">/* Get min multiplier */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cpu_model</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPU_NEHEMIAH</span>:
		<span class="n">minmult</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_NEHEMIAH_C</span>:
		<span class="n">minmult</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">minmult</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;MinMult:%d.%dx MaxMult:%d.%dx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">minmult</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="n">minmult</span><span class="o">%</span><span class="mi">10</span><span class="p">,</span> <span class="n">maxmult</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="n">maxmult</span><span class="o">%</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">highest_speed</span> <span class="o">=</span> <span class="n">calc_speed</span><span class="p">(</span><span class="n">maxmult</span><span class="p">);</span>
	<span class="n">lowest_speed</span> <span class="o">=</span> <span class="n">calc_speed</span><span class="p">(</span><span class="n">minmult</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;FSB:%dMHz  Lowest speed: %s   Highest speed:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fsb</span><span class="p">,</span>
		 <span class="n">print_speed</span><span class="p">(</span><span class="n">lowest_speed</span><span class="o">/</span><span class="mi">1000</span><span class="p">),</span>
		 <span class="n">print_speed</span><span class="p">(</span><span class="n">highest_speed</span><span class="o">/</span><span class="mi">1000</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lowest_speed</span> <span class="o">==</span> <span class="n">highest_speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;highestspeed == lowest, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lowest_speed</span> <span class="o">&gt;</span> <span class="n">highest_speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;nonsense! lowest (%d &gt; %d) !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">lowest_speed</span><span class="p">,</span> <span class="n">highest_speed</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">longhaul_table</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="n">numscales</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">longhaul_table</span><span class="p">),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">longhaul_table</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">numscales</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ratio</span> <span class="o">=</span> <span class="n">mults</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&gt;</span> <span class="n">maxmult</span> <span class="o">||</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="n">minmult</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">longhaul_table</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">calc_speed</span><span class="p">(</span><span class="n">ratio</span><span class="p">);</span>
		<span class="n">longhaul_table</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">index</span>	<span class="o">=</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">k</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">longhaul_table</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Sort */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min_f</span><span class="p">,</span> <span class="n">min_i</span><span class="p">;</span>
		<span class="n">min_f</span> <span class="o">=</span> <span class="n">longhaul_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">frequency</span><span class="p">;</span>
		<span class="n">min_i</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">longhaul_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="n">min_f</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">min_f</span> <span class="o">=</span> <span class="n">longhaul_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frequency</span><span class="p">;</span>
				<span class="n">min_i</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">min_i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">swap</span><span class="p">(</span><span class="n">longhaul_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">frequency</span><span class="p">,</span>
			     <span class="n">longhaul_table</span><span class="p">[</span><span class="n">min_i</span><span class="p">].</span><span class="n">frequency</span><span class="p">);</span>
			<span class="n">swap</span><span class="p">(</span><span class="n">longhaul_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">index</span><span class="p">,</span>
			     <span class="n">longhaul_table</span><span class="p">[</span><span class="n">min_i</span><span class="p">].</span><span class="n">index</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">longhaul_table</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">CPUFREQ_TABLE_END</span><span class="p">;</span>

	<span class="cm">/* Find index we are running on */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mults</span><span class="p">[</span><span class="n">longhaul_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">index</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">]</span> <span class="o">==</span> <span class="n">mult</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">longhaul_index</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">longhaul_setup_voltagescaling</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">msr_longhaul</span> <span class="n">longhaul</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mV_pos</span> <span class="n">minvid</span><span class="p">,</span> <span class="n">maxvid</span><span class="p">,</span> <span class="n">vid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">kHz_step</span><span class="p">,</span> <span class="n">numvscales</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min_vid_speed</span><span class="p">;</span>

	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_VIA_LONGHAUL</span><span class="p">,</span> <span class="n">longhaul</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">longhaul</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">RevisionID</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Voltage scaling not supported by CPU.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">longhaul</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">VRMRev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;VRM 8.5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vrm_mV_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vrm85_mV</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">mV_vrm_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mV_vrm85</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Mobile VRM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_model</span> <span class="o">&lt;</span> <span class="n">CPU_NEHEMIAH</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">vrm_mV_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mobilevrm_mV</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">mV_vrm_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mV_mobilevrm</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">minvid</span> <span class="o">=</span> <span class="n">vrm_mV_table</span><span class="p">[</span><span class="n">longhaul</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">MinimumVID</span><span class="p">];</span>
	<span class="n">maxvid</span> <span class="o">=</span> <span class="n">vrm_mV_table</span><span class="p">[</span><span class="n">longhaul</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">MaximumVID</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minvid</span><span class="p">.</span><span class="n">mV</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">maxvid</span><span class="p">.</span><span class="n">mV</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">minvid</span><span class="p">.</span><span class="n">mV</span> <span class="o">&gt;</span> <span class="n">maxvid</span><span class="p">.</span><span class="n">mV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Bogus values Min:%d.%03d Max:%d.%03d. &quot;</span>
					<span class="s">&quot;Voltage scaling disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">minvid</span><span class="p">.</span><span class="n">mV</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">minvid</span><span class="p">.</span><span class="n">mV</span><span class="o">%</span><span class="mi">1000</span><span class="p">,</span>
					<span class="n">maxvid</span><span class="p">.</span><span class="n">mV</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">maxvid</span><span class="p">.</span><span class="n">mV</span><span class="o">%</span><span class="mi">1000</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minvid</span><span class="p">.</span><span class="n">mV</span> <span class="o">==</span> <span class="n">maxvid</span><span class="p">.</span><span class="n">mV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Claims to support voltage scaling but &quot;</span>
				<span class="s">&quot;min &amp; max are both %d.%03d. &quot;</span>
				<span class="s">&quot;Voltage scaling disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">maxvid</span><span class="p">.</span><span class="n">mV</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">maxvid</span><span class="p">.</span><span class="n">mV</span><span class="o">%</span><span class="mi">1000</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* How many voltage steps*/</span>
	<span class="n">numvscales</span> <span class="o">=</span> <span class="n">maxvid</span><span class="p">.</span><span class="n">pos</span> <span class="o">-</span> <span class="n">minvid</span><span class="p">.</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span>
		<span class="s">&quot;Max VID=%d.%03d  &quot;</span>
		<span class="s">&quot;Min VID=%d.%03d, &quot;</span>
		<span class="s">&quot;%d possible voltage scales</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">maxvid</span><span class="p">.</span><span class="n">mV</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">maxvid</span><span class="p">.</span><span class="n">mV</span><span class="o">%</span><span class="mi">1000</span><span class="p">,</span>
		<span class="n">minvid</span><span class="p">.</span><span class="n">mV</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">minvid</span><span class="p">.</span><span class="n">mV</span><span class="o">%</span><span class="mi">1000</span><span class="p">,</span>
		<span class="n">numvscales</span><span class="p">);</span>

	<span class="cm">/* Calculate max frequency at min voltage */</span>
	<span class="n">j</span> <span class="o">=</span> <span class="n">longhaul</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">MinMHzBR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">longhaul</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">MinMHzBR4</span><span class="p">)</span>
		<span class="n">j</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">min_vid_speed</span> <span class="o">=</span> <span class="n">eblcr</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">min_vid_speed</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">longhaul</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">MinMHzFSB</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">min_vid_speed</span> <span class="o">*=</span> <span class="mi">13333</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">min_vid_speed</span> <span class="o">*=</span> <span class="mi">10000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">min_vid_speed</span> <span class="o">*=</span> <span class="mi">6666</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">min_vid_speed</span> <span class="o">&gt;=</span> <span class="n">highest_speed</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* Calculate kHz for one voltage step */</span>
	<span class="n">kHz_step</span> <span class="o">=</span> <span class="p">(</span><span class="n">highest_speed</span> <span class="o">-</span> <span class="n">min_vid_speed</span><span class="p">)</span> <span class="o">/</span> <span class="n">numvscales</span><span class="p">;</span>

	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">longhaul_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">frequency</span> <span class="o">!=</span> <span class="n">CPUFREQ_TABLE_END</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">longhaul_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">frequency</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">min_vid_speed</span><span class="p">)</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">speed</span> <span class="o">-</span> <span class="n">min_vid_speed</span><span class="p">)</span> <span class="o">/</span> <span class="n">kHz_step</span> <span class="o">+</span> <span class="n">minvid</span><span class="p">.</span><span class="n">pos</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="n">minvid</span><span class="p">.</span><span class="n">pos</span><span class="p">;</span>
		<span class="n">longhaul_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">index</span> <span class="o">|=</span> <span class="n">mV_vrm_table</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">vid</span> <span class="o">=</span> <span class="n">vrm_mV_table</span><span class="p">[</span><span class="n">mV_vrm_table</span><span class="p">[</span><span class="n">pos</span><span class="p">]];</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;f: %d kHz, index: %d, vid: %d mV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">speed</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">vid</span><span class="p">.</span><span class="n">mV</span><span class="p">);</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">can_scale_voltage</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Voltage scaling enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">longhaul_verify</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cpufreq_frequency_table_verify</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">longhaul_table</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">longhaul_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">target_freq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">relation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">table_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vid</span><span class="p">,</span> <span class="n">current_vid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_frequency_table_target</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">longhaul_table</span><span class="p">,</span> <span class="n">target_freq</span><span class="p">,</span>
				<span class="n">relation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">table_index</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t set same frequency again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">longhaul_index</span> <span class="o">==</span> <span class="n">table_index</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">can_scale_voltage</span><span class="p">)</span>
		<span class="n">longhaul_setstate</span><span class="p">(</span><span class="n">table_index</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* On test system voltage transitions exceeding single</span>
<span class="cm">		 * step up or down were turning motherboard off. Both</span>
<span class="cm">		 * &quot;ondemand&quot; and &quot;userspace&quot; are unsafe. C7 is doing</span>
<span class="cm">		 * this in hardware, C3 is old and we need to do this</span>
<span class="cm">		 * in software. */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">longhaul_index</span><span class="p">;</span>
		<span class="n">current_vid</span> <span class="o">=</span> <span class="p">(</span><span class="n">longhaul_table</span><span class="p">[</span><span class="n">longhaul_index</span><span class="p">].</span><span class="n">index</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">current_vid</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">table_index</span> <span class="o">&gt;</span> <span class="n">longhaul_index</span><span class="p">)</span>
			<span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">table_index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vid</span> <span class="o">=</span> <span class="p">(</span><span class="n">longhaul_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vid</span> <span class="o">!=</span> <span class="n">current_vid</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">longhaul_setstate</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
				<span class="n">current_vid</span> <span class="o">=</span> <span class="n">vid</span><span class="p">;</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">i</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">longhaul_setstate</span><span class="p">(</span><span class="n">table_index</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">longhaul_index</span> <span class="o">=</span> <span class="n">table_index</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">longhaul_get</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">calc_speed</span><span class="p">(</span><span class="n">longhaul_get_cpu_mult</span><span class="p">());</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">longhaul_walk_callback</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">obj_handle</span><span class="p">,</span>
					  <span class="n">u32</span> <span class="n">nesting_level</span><span class="p">,</span>
					  <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">return_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_bus_get_device</span><span class="p">(</span><span class="n">obj_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">acpi_driver_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* VIA don&#39;t support PM2 reg, but have something similar */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">enable_arbiter_disable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pci_cmd</span><span class="p">;</span>

	<span class="cm">/* Find PLE133 host bridge */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x78</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_VIA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_VIA_8601_0</span><span class="p">,</span>
			     <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* Find PM133/VT8605 host bridge */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_VIA</span><span class="p">,</span>
				     <span class="n">PCI_DEVICE_ID_VIA_8605_0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* Find CLE266 host bridge */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x76</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_VIA</span><span class="p">,</span>
				     <span class="n">PCI_DEVICE_ID_VIA_862X_0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="cm">/* Find CN400 V-Link host bridge */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_VIA</span><span class="p">,</span> <span class="mh">0x7259</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable access to port 0x22 */</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_cmd</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pci_cmd</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">;</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">pci_cmd</span><span class="p">);</span>
			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_cmd</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span>
					<span class="s">&quot;Can&#39;t enable access to port 0x22.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">longhaul_setup_southbridge</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pci_cmd</span><span class="p">;</span>

	<span class="cm">/* Find VT8235 southbridge */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_VIA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_VIA_8235</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="cm">/* Find VT8237 southbridge */</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_VIA</span><span class="p">,</span>
				     <span class="n">PCI_DEVICE_ID_VIA_8237</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set transition time to max */</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_cmd</span><span class="p">);</span>
		<span class="n">pci_cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="n">pci_cmd</span><span class="p">);</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_cmd</span><span class="p">);</span>
		<span class="n">pci_cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="n">pci_cmd</span><span class="p">);</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_cmd</span><span class="p">);</span>
		<span class="n">pci_cmd</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="n">pci_cmd</span><span class="p">);</span>
		<span class="cm">/* Get address of ACPI registers block*/</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_cmd</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acpi_regs_addr</span><span class="p">);</span>
			<span class="n">acpi_regs_addr</span> <span class="o">&amp;=</span> <span class="mh">0xff00</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;ACPI I/O at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">acpi_regs_addr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__cpuinit</span> <span class="nf">longhaul_cpu_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpu_data</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cpuname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>

	<span class="cm">/* Check what we have on this motherboard */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">cpu_model</span> <span class="o">=</span> <span class="n">CPU_SAMUEL</span><span class="p">;</span>
		<span class="n">cpuname</span> <span class="o">=</span> <span class="s">&quot;C3 &#39;Samuel&#39; [C5A]&quot;</span><span class="p">;</span>
		<span class="n">longhaul_version</span> <span class="o">=</span> <span class="n">TYPE_LONGHAUL_V1</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mults</span><span class="p">,</span> <span class="n">samuel1_mults</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">samuel1_mults</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">eblcr</span><span class="p">,</span> <span class="n">samuel1_eblcr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">samuel1_eblcr</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">7</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">longhaul_version</span> <span class="o">=</span> <span class="n">TYPE_LONGHAUL_V1</span><span class="p">;</span>
			<span class="n">cpu_model</span> <span class="o">=</span> <span class="n">CPU_SAMUEL2</span><span class="p">;</span>
			<span class="n">cpuname</span> <span class="o">=</span> <span class="s">&quot;C3 &#39;Samuel 2&#39; [C5B]&quot;</span><span class="p">;</span>
			<span class="cm">/* Note, this is not a typo, early Samuel2&#39;s had</span>
<span class="cm">			 * Samuel1 ratios. */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mults</span><span class="p">,</span> <span class="n">samuel1_mults</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">samuel1_mults</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">eblcr</span><span class="p">,</span> <span class="n">samuel2_eblcr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">samuel2_eblcr</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span> <span class="p">...</span> <span class="mi">15</span>:
			<span class="n">longhaul_version</span> <span class="o">=</span> <span class="n">TYPE_LONGHAUL_V2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_mask</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cpu_model</span> <span class="o">=</span> <span class="n">CPU_SAMUEL2</span><span class="p">;</span>
				<span class="n">cpuname</span> <span class="o">=</span> <span class="s">&quot;C3 &#39;Samuel 2&#39; [C5B]&quot;</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cpu_model</span> <span class="o">=</span> <span class="n">CPU_EZRA</span><span class="p">;</span>
				<span class="n">cpuname</span> <span class="o">=</span> <span class="s">&quot;C3 &#39;Ezra&#39; [C5C]&quot;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mults</span><span class="p">,</span> <span class="n">ezra_mults</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ezra_mults</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">eblcr</span><span class="p">,</span> <span class="n">ezra_eblcr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ezra_eblcr</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">cpu_model</span> <span class="o">=</span> <span class="n">CPU_EZRA_T</span><span class="p">;</span>
		<span class="n">cpuname</span> <span class="o">=</span> <span class="s">&quot;C3 &#39;Ezra-T&#39; [C5M]&quot;</span><span class="p">;</span>
		<span class="n">longhaul_version</span> <span class="o">=</span> <span class="n">TYPE_POWERSAVER</span><span class="p">;</span>
		<span class="n">numscales</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mults</span><span class="p">,</span> <span class="n">ezrat_mults</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ezrat_mults</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">eblcr</span><span class="p">,</span> <span class="n">ezrat_eblcr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ezrat_eblcr</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">9</span>:
		<span class="n">longhaul_version</span> <span class="o">=</span> <span class="n">TYPE_POWERSAVER</span><span class="p">;</span>
		<span class="n">numscales</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mults</span><span class="p">,</span> <span class="n">nehemiah_mults</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nehemiah_mults</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">eblcr</span><span class="p">,</span> <span class="n">nehemiah_eblcr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nehemiah_eblcr</span><span class="p">));</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span> <span class="p">...</span> <span class="mi">1</span>:
			<span class="n">cpu_model</span> <span class="o">=</span> <span class="n">CPU_NEHEMIAH</span><span class="p">;</span>
			<span class="n">cpuname</span> <span class="o">=</span> <span class="s">&quot;C3 &#39;Nehemiah A&#39; [C5XLOE]&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span> <span class="p">...</span> <span class="mi">4</span>:
			<span class="n">cpu_model</span> <span class="o">=</span> <span class="n">CPU_NEHEMIAH</span><span class="p">;</span>
			<span class="n">cpuname</span> <span class="o">=</span> <span class="s">&quot;C3 &#39;Nehemiah B&#39; [C5XLOH]&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span> <span class="p">...</span> <span class="mi">15</span>:
			<span class="n">cpu_model</span> <span class="o">=</span> <span class="n">CPU_NEHEMIAH_C</span><span class="p">;</span>
			<span class="n">cpuname</span> <span class="o">=</span> <span class="s">&quot;C3 &#39;Nehemiah C&#39; [C5P]&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">cpuname</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Check Longhaul ver. 2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">longhaul_version</span> <span class="o">==</span> <span class="n">TYPE_LONGHAUL_V2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_VIA_LONGHAUL</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lo</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* Looks like MSR isn&#39;t present */</span>
			<span class="n">longhaul_version</span> <span class="o">=</span> <span class="n">TYPE_LONGHAUL_V1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;VIA %s CPU detected.  &quot;</span><span class="p">,</span> <span class="n">cpuname</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">longhaul_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TYPE_LONGHAUL_V1</span>:
	<span class="k">case</span> <span class="n">TYPE_LONGHAUL_V2</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;Longhaul v%d supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">longhaul_version</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TYPE_POWERSAVER</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;Powersaver supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="cm">/* Doesn&#39;t hurt */</span>
	<span class="n">longhaul_setup_southbridge</span><span class="p">();</span>

	<span class="cm">/* Find ACPI data for processor */</span>
	<span class="n">acpi_walk_namespace</span><span class="p">(</span><span class="n">ACPI_TYPE_PROCESSOR</span><span class="p">,</span> <span class="n">ACPI_ROOT_OBJECT</span><span class="p">,</span>
				<span class="n">ACPI_UINT32_MAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">longhaul_walk_callback</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pr</span><span class="p">);</span>

	<span class="cm">/* Check ACPI support for C3 state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">longhaul_version</span> <span class="o">==</span> <span class="n">TYPE_POWERSAVER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">ACPI_STATE_C3</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cx</span><span class="o">-&gt;</span><span class="n">latency</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">)</span>
			<span class="n">longhaul_flags</span> <span class="o">|=</span> <span class="n">USE_ACPI_C3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Disable if it isn&#39;t working */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disable_acpi_c3</span><span class="p">)</span>
		<span class="n">longhaul_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USE_ACPI_C3</span><span class="p">;</span>
	<span class="cm">/* Check if northbridge is friendly */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_arbiter_disable</span><span class="p">())</span>
		<span class="n">longhaul_flags</span> <span class="o">|=</span> <span class="n">USE_NORTHBRIDGE</span><span class="p">;</span>

	<span class="cm">/* Check ACPI support for bus master arbiter disable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">longhaul_flags</span> <span class="o">&amp;</span> <span class="n">USE_ACPI_C3</span>
	     <span class="o">||</span> <span class="n">longhaul_flags</span> <span class="o">&amp;</span> <span class="n">USE_NORTHBRIDGE</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">pr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">bm_control</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span>
			<span class="s">&quot;No ACPI support. Unsupported northbridge.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">longhaul_flags</span> <span class="o">&amp;</span> <span class="n">USE_NORTHBRIDGE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Using northbridge support.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">longhaul_flags</span> <span class="o">&amp;</span> <span class="n">USE_ACPI_C3</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Using ACPI support.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">longhaul_get_ranges</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">longhaul_version</span> <span class="o">!=</span> <span class="n">TYPE_LONGHAUL_V1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">scale_voltage</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">longhaul_setup_voltagescaling</span><span class="p">();</span>

	<span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpuinfo</span><span class="p">.</span><span class="n">transition_latency</span> <span class="o">=</span> <span class="mi">200000</span><span class="p">;</span>	<span class="cm">/* nsec */</span>
	<span class="n">policy</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">=</span> <span class="n">calc_speed</span><span class="p">(</span><span class="n">longhaul_get_cpu_mult</span><span class="p">());</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cpufreq_frequency_table_cpuinfo</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">longhaul_table</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cpufreq_frequency_table_get_attr</span><span class="p">(</span><span class="n">longhaul_table</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">longhaul_cpu_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpufreq_frequency_table_put_attr</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">freq_attr</span> <span class="o">*</span><span class="n">longhaul_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">cpufreq_freq_attr_scaling_available_freqs</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_driver</span> <span class="n">longhaul_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">verify</span>	<span class="o">=</span> <span class="n">longhaul_verify</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target</span>	<span class="o">=</span> <span class="n">longhaul_target</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span>	<span class="o">=</span> <span class="n">longhaul_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>	<span class="o">=</span> <span class="n">longhaul_cpu_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span>	<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">longhaul_cpu_exit</span><span class="p">),</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;longhaul&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attr</span>	<span class="o">=</span> <span class="n">longhaul_attr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">x86_cpu_id</span> <span class="n">longhaul_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">X86_VENDOR_CENTAUR</span><span class="p">,</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">x86cpu</span><span class="p">,</span> <span class="n">longhaul_id</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">longhaul_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpu_data</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x86_match_cpu</span><span class="p">(</span><span class="n">longhaul_id</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_online_cpus</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;More than 1 CPU detected, &quot;</span>
				<span class="s">&quot;longhaul disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_X86_IO_APIC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_apic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;APIC detected. Longhaul is currently &quot;</span>
				<span class="s">&quot;broken in this configuration.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">6</span> <span class="p">...</span> <span class="mi">9</span>:
		<span class="k">return</span> <span class="n">cpufreq_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">longhaul_driver</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Use acpi-cpufreq driver for VIA C7</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">longhaul_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numscales</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mults</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">maxmult</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">longhaul_setstate</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cpufreq_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">longhaul_driver</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">longhaul_table</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Even if BIOS is exporting ACPI C3 state, and it is used</span>
<span class="cm"> * with success when CPU is idle, this state doesn&#39;t</span>
<span class="cm"> * trigger frequency transition in some cases. */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">disable_acpi_c3</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disable_acpi_c3</span><span class="p">,</span> <span class="s">&quot;Don&#39;t use ACPI C3 support&quot;</span><span class="p">);</span>
<span class="cm">/* Change CPU voltage with frequency. Very useful to save</span>
<span class="cm"> * power, but most VIA C3 processors aren&#39;t supporting it. */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">scale_voltage</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">scale_voltage</span><span class="p">,</span> <span class="s">&quot;Scale voltage of processor&quot;</span><span class="p">);</span>
<span class="cm">/* Force revision key to 0 for processors which doesn&#39;t</span>
<span class="cm"> * support voltage scaling, but are introducing itself as</span>
<span class="cm"> * such. */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">revid_errata</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">revid_errata</span><span class="p">,</span> <span class="s">&quot;Ignore CPU Revision ID&quot;</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Dave Jones &lt;davej@redhat.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Longhaul driver for VIA Cyrix processors.&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">late_initcall</span><span class="p">(</span><span class="n">longhaul_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">longhaul_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
