<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › cpufreq › speedstep-centrino.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>speedstep-centrino.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * cpufreq driver for Enhanced SpeedStep, as found in Intel&#39;s Pentium</span>
<span class="cm"> * M (part of the Centrino chipset).</span>
<span class="cm"> *</span>
<span class="cm"> * Since the original Pentium M, most new Intel CPUs support Enhanced</span>
<span class="cm"> * SpeedStep.</span>
<span class="cm"> *</span>
<span class="cm"> * Despite the &quot;SpeedStep&quot; in the name, this is almost entirely unlike</span>
<span class="cm"> * traditional SpeedStep.</span>
<span class="cm"> *</span>
<span class="cm"> * Modelled on speedstep.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2003 Jeremy Fitzhardinge &lt;jeremy@goop.org&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/cpufreq.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;	</span><span class="cm">/* current */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;asm/msr.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/cpufeature.h&gt;</span>
<span class="cp">#include &lt;asm/cpu_device_id.h&gt;</span>

<span class="cp">#define PFX		&quot;speedstep-centrino: &quot;</span>
<span class="cp">#define MAINTAINER	&quot;cpufreq@vger.kernel.org&quot;</span>

<span class="cp">#define INTEL_MSR_RANGE	(0xffff)</span>

<span class="k">struct</span> <span class="n">cpu_id</span>
<span class="p">{</span>
	<span class="n">__u8</span>	<span class="n">x86</span><span class="p">;</span>            <span class="cm">/* CPU family */</span>
	<span class="n">__u8</span>	<span class="n">x86_model</span><span class="p">;</span>	<span class="cm">/* model */</span>
	<span class="n">__u8</span>	<span class="n">x86_mask</span><span class="p">;</span>	<span class="cm">/* stepping */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">CPU_BANIAS</span><span class="p">,</span>
	<span class="n">CPU_DOTHAN_A1</span><span class="p">,</span>
	<span class="n">CPU_DOTHAN_A2</span><span class="p">,</span>
	<span class="n">CPU_DOTHAN_B0</span><span class="p">,</span>
	<span class="n">CPU_MP4HT_D0</span><span class="p">,</span>
	<span class="n">CPU_MP4HT_E0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cpu_id</span> <span class="n">cpu_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CPU_BANIAS</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mi">6</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">5</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CPU_DOTHAN_A1</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CPU_DOTHAN_A2</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CPU_DOTHAN_B0</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CPU_MP4HT_D0</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span><span class="mi">15</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">CPU_MP4HT_E0</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span><span class="mi">15</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
<span class="p">};</span>
<span class="cp">#define N_IDS	ARRAY_SIZE(cpu_ids)</span>

<span class="k">struct</span> <span class="n">cpu_model</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cpu_id</span> <span class="o">*</span><span class="n">cpu_id</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">model_name</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">max_freq</span><span class="p">;</span> <span class="cm">/* max clock in kHz */</span>

	<span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="o">*</span><span class="n">op_points</span><span class="p">;</span> <span class="cm">/* clock/voltage pairs */</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">centrino_verify_cpu_id</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">cpu_id</span> <span class="o">*</span><span class="n">x</span><span class="p">);</span>

<span class="cm">/* Operating points for current CPU */</span>
<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_model</span> <span class="o">*</span><span class="p">,</span> <span class="n">centrino_model</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cpu_id</span> <span class="o">*</span><span class="p">,</span> <span class="n">centrino_cpu</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_driver</span> <span class="n">centrino_driver</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_X86_SPEEDSTEP_CENTRINO_TABLE</span>

<span class="cm">/* Computes the correct form for IA32_PERF_CTL MSR for a particular</span>
<span class="cm">   frequency/voltage operating point; frequency in MHz, volts in mV.</span>
<span class="cm">   This is stored as &quot;index&quot; in the structure. */</span>
<span class="cp">#define OP(mhz, mv)							\</span>
<span class="cp">	{								\</span>
<span class="cp">		.frequency = (mhz) * 1000,				\</span>
<span class="cp">		.index = (((mhz)/100) &lt;&lt; 8) | ((mv - 700) / 16)		\</span>
<span class="cp">	}</span>

<span class="cm">/*</span>
<span class="cm"> * These voltage tables were derived from the Intel Pentium M</span>
<span class="cm"> * datasheet, document 25261202.pdf, Table 5.  I have verified they</span>
<span class="cm"> * are consistent with my IBM ThinkPad X31, which has a 1.3GHz Pentium</span>
<span class="cm"> * M.</span>
<span class="cm"> */</span>

<span class="cm">/* Ultra Low Voltage Intel Pentium M processor 900MHz (Banias) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="n">banias_900</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span>  <span class="mi">844</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span>  <span class="mi">988</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">900</span><span class="p">,</span> <span class="mi">1004</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">CPUFREQ_TABLE_END</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Ultra Low Voltage Intel Pentium M processor 1000MHz (Banias) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="n">banias_1000</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span>   <span class="mi">844</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span>   <span class="mi">972</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">900</span><span class="p">,</span>   <span class="mi">988</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1004</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">CPUFREQ_TABLE_END</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Low Voltage Intel Pentium M processor 1.10GHz (Banias) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="n">banias_1100</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">OP</span><span class="p">(</span> <span class="mi">600</span><span class="p">,</span>  <span class="mi">956</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">1020</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">1100</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1164</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1100</span><span class="p">,</span> <span class="mi">1180</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">CPUFREQ_TABLE_END</span> <span class="p">}</span>
<span class="p">};</span>


<span class="cm">/* Low Voltage Intel Pentium M processor 1.20GHz (Banias) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="n">banias_1200</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">OP</span><span class="p">(</span> <span class="mi">600</span><span class="p">,</span>  <span class="mi">956</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">1004</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">1020</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1100</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1100</span><span class="p">,</span> <span class="mi">1164</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1180</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">CPUFREQ_TABLE_END</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Intel Pentium M processor 1.30GHz (Banias) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="n">banias_1300</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">OP</span><span class="p">(</span> <span class="mi">600</span><span class="p">,</span>  <span class="mi">956</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">1260</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1292</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1356</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1300</span><span class="p">,</span> <span class="mi">1388</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">CPUFREQ_TABLE_END</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Intel Pentium M processor 1.40GHz (Banias) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="n">banias_1400</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">OP</span><span class="p">(</span> <span class="mi">600</span><span class="p">,</span>  <span class="mi">956</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">1180</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1308</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1436</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">1484</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">CPUFREQ_TABLE_END</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Intel Pentium M processor 1.50GHz (Banias) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="n">banias_1500</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">OP</span><span class="p">(</span> <span class="mi">600</span><span class="p">,</span>  <span class="mi">956</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">1116</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1228</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1356</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">1452</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1500</span><span class="p">,</span> <span class="mi">1484</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">CPUFREQ_TABLE_END</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Intel Pentium M processor 1.60GHz (Banias) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="n">banias_1600</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">OP</span><span class="p">(</span> <span class="mi">600</span><span class="p">,</span>  <span class="mi">956</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">1036</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1164</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1276</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">1420</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1600</span><span class="p">,</span> <span class="mi">1484</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">CPUFREQ_TABLE_END</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Intel Pentium M processor 1.70GHz (Banias) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="n">banias_1700</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">OP</span><span class="p">(</span> <span class="mi">600</span><span class="p">,</span>  <span class="mi">956</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">1004</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1116</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1228</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">1308</span><span class="p">),</span>
	<span class="n">OP</span><span class="p">(</span><span class="mi">1700</span><span class="p">,</span> <span class="mi">1484</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">CPUFREQ_TABLE_END</span> <span class="p">}</span>
<span class="p">};</span>
<span class="cp">#undef OP</span>

<span class="cp">#define _BANIAS(cpuid, max, name)	\</span>
<span class="cp">{	.cpu_id		= cpuid,	\</span>
<span class="cp">	.model_name	= &quot;Intel(R) Pentium(R) M processor &quot; name &quot;MHz&quot;, \</span>
<span class="cp">	.max_freq	= (max)*1000,	\</span>
<span class="cp">	.op_points	= banias_##max,	\</span>
<span class="cp">}</span>
<span class="cp">#define BANIAS(max)	_BANIAS(&amp;cpu_ids[CPU_BANIAS], max, #max)</span>

<span class="cm">/* CPU models, their operating frequency range, and freq/voltage</span>
<span class="cm">   operating points */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cpu_model</span> <span class="n">models</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">_BANIAS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_ids</span><span class="p">[</span><span class="n">CPU_BANIAS</span><span class="p">],</span> <span class="mi">900</span><span class="p">,</span> <span class="s">&quot; 900&quot;</span><span class="p">),</span>
	<span class="n">BANIAS</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span>
	<span class="n">BANIAS</span><span class="p">(</span><span class="mi">1100</span><span class="p">),</span>
	<span class="n">BANIAS</span><span class="p">(</span><span class="mi">1200</span><span class="p">),</span>
	<span class="n">BANIAS</span><span class="p">(</span><span class="mi">1300</span><span class="p">),</span>
	<span class="n">BANIAS</span><span class="p">(</span><span class="mi">1400</span><span class="p">),</span>
	<span class="n">BANIAS</span><span class="p">(</span><span class="mi">1500</span><span class="p">),</span>
	<span class="n">BANIAS</span><span class="p">(</span><span class="mi">1600</span><span class="p">),</span>
	<span class="n">BANIAS</span><span class="p">(</span><span class="mi">1700</span><span class="p">),</span>

	<span class="cm">/* NULL model_name is a wildcard */</span>
	<span class="p">{</span> <span class="o">&amp;</span><span class="n">cpu_ids</span><span class="p">[</span><span class="n">CPU_DOTHAN_A1</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">&amp;</span><span class="n">cpu_ids</span><span class="p">[</span><span class="n">CPU_DOTHAN_A2</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">&amp;</span><span class="n">cpu_ids</span><span class="p">[</span><span class="n">CPU_DOTHAN_B0</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">&amp;</span><span class="n">cpu_ids</span><span class="p">[</span><span class="n">CPU_MP4HT_D0</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">&amp;</span><span class="n">cpu_ids</span><span class="p">[</span><span class="n">CPU_MP4HT_E0</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>

	<span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>
<span class="cp">#undef _BANIAS</span>
<span class="cp">#undef BANIAS</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">centrino_cpu_init_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">cpu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpu_data</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cpu_model</span> <span class="o">*</span><span class="n">model</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="p">;</span> <span class="n">model</span><span class="o">-&gt;</span><span class="n">cpu_id</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">model</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">centrino_verify_cpu_id</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">model</span><span class="o">-&gt;</span><span class="n">cpu_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">model_name</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		     <span class="n">strcmp</span><span class="p">(</span><span class="n">cpu</span><span class="o">-&gt;</span><span class="n">x86_model_id</span><span class="p">,</span> <span class="n">model</span><span class="o">-&gt;</span><span class="n">model_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">cpu_id</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No match at all */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;no support for CPU model </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">: &quot;</span>
		       <span class="s">&quot;send /proc/cpuinfo to &quot;</span> <span class="n">MAINTAINER</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">x86_model_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">op_points</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Matched a non-match */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;no table support for CPU model </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">x86_model_id</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;try using the acpi-cpufreq driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_model</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="n">model</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;found </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">: max frequency: %dkHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">model</span><span class="o">-&gt;</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model</span><span class="o">-&gt;</span><span class="n">max_freq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">centrino_cpu_init_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_X86_SPEEDSTEP_CENTRINO_TABLE */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">centrino_verify_cpu_id</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">cpu_id</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86</span> <span class="o">==</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">x86</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_model</span> <span class="o">==</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">x86_model</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x86_mask</span> <span class="o">==</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">x86_mask</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* To be called only after centrino_model is initialized */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">extract_clock</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">msr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">failsafe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Extract clock in kHz from PERF_CTL value</span>
<span class="cm">	 * for centrino, as some DSDTs are buggy.</span>
<span class="cm">	 * Ideally, this can be done using the acpi_data structure.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_cpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">cpu_ids</span><span class="p">[</span><span class="n">CPU_BANIAS</span><span class="p">])</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_cpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">cpu_ids</span><span class="p">[</span><span class="n">CPU_DOTHAN_A1</span><span class="p">])</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_cpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">cpu_ids</span><span class="p">[</span><span class="n">CPU_DOTHAN_B0</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">msr</span> <span class="o">=</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">msr</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_model</span><span class="p">,</span> <span class="n">cpu</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_model</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">op_points</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">msr</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_model</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">op_points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frequency</span>
							<span class="o">!=</span> <span class="n">CPUFREQ_TABLE_END</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">==</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_model</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">op_points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_model</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span>
							<span class="n">op_points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frequency</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">failsafe</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_model</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">op_points</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">frequency</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return the current CPU frequency in kHz */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_cur_freq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">clock_freq</span><span class="p">;</span>

	<span class="n">rdmsr_on_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">MSR_IA32_PERF_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">);</span>
	<span class="n">clock_freq</span> <span class="o">=</span> <span class="n">extract_clock</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">clock_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * On some CPUs, we can see transient MSR values (which are</span>
<span class="cm">		 * not present in _PSS), while CPU is doing some automatic</span>
<span class="cm">		 * P-state transition (like TM2). Get the last freq set </span>
<span class="cm">		 * in PERF_CTL.</span>
<span class="cm">		 */</span>
		<span class="n">rdmsr_on_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">MSR_IA32_PERF_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">);</span>
		<span class="n">clock_freq</span> <span class="o">=</span> <span class="n">extract_clock</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">clock_freq</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">centrino_cpu_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpuinfo_x86</span> <span class="o">*</span><span class="n">cpu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpu_data</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">freq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Only Intel makes Enhanced Speedstep-capable CPUs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span><span class="o">-&gt;</span><span class="n">x86_vendor</span> <span class="o">!=</span> <span class="n">X86_VENDOR_INTEL</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">cpu_has</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">X86_FEATURE_EST</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">X86_FEATURE_CONSTANT_TSC</span><span class="p">))</span>
		<span class="n">centrino_driver</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CPUFREQ_CONST_LOOPS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_IDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">centrino_verify_cpu_id</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpu_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">N_IDS</span><span class="p">)</span>
		<span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_cpu</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpu_ids</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_cpu</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;found unsupported CPU with &quot;</span>
		<span class="s">&quot;Enhanced SpeedStep: send /proc/cpuinfo to &quot;</span>
		<span class="n">MAINTAINER</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">centrino_cpu_init_table</span><span class="p">(</span><span class="n">policy</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check to see if Enhanced SpeedStep is enabled, and try to</span>
<span class="cm">	   enable it if not. */</span>
	<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_IA32_MISC_ENABLE</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">l</span> <span class="o">&amp;</span> <span class="n">MSR_IA32_MISC_ENABLE_ENHANCED_SPEEDSTEP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="n">MSR_IA32_MISC_ENABLE_ENHANCED_SPEEDSTEP</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;trying to enable Enhanced SpeedStep (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
		<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_IA32_MISC_ENABLE</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>

		<span class="cm">/* check to see if it stuck */</span>
		<span class="n">rdmsr</span><span class="p">(</span><span class="n">MSR_IA32_MISC_ENABLE</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">l</span> <span class="o">&amp;</span> <span class="n">MSR_IA32_MISC_ENABLE_ENHANCED_SPEEDSTEP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span>
				<span class="s">&quot;couldn&#39;t enable Enhanced SpeedStep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="n">get_cur_freq</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
	<span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpuinfo</span><span class="p">.</span><span class="n">transition_latency</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
						<span class="cm">/* 10uS transition latency */</span>
	<span class="n">policy</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;centrino_cpu_init: cur=%dkHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cpufreq_frequency_table_cpuinfo</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span>
		<span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_model</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">op_points</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>

	<span class="n">cpufreq_frequency_table_get_attr</span><span class="p">(</span>
		<span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_model</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">op_points</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">centrino_cpu_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_model</span><span class="p">,</span> <span class="n">cpu</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">cpufreq_frequency_table_put_attr</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>

	<span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_model</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * centrino_verify - verifies a new CPUFreq policy</span>
<span class="cm"> * @policy: new policy</span>
<span class="cm"> *</span>
<span class="cm"> * Limit must be within this model&#39;s frequency range at least one</span>
<span class="cm"> * border included.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">centrino_verify</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cpufreq_frequency_table_verify</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span>
			<span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_model</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">op_points</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * centrino_setpolicy - set a new CPUFreq policy</span>
<span class="cm"> * @policy: new policy</span>
<span class="cm"> * @target_freq: the target frequency</span>
<span class="cm"> * @relation: how that frequency relates to achieved frequency</span>
<span class="cm"> *	(CPUFREQ_RELATION_L or CPUFREQ_RELATION_H)</span>
<span class="cm"> *</span>
<span class="cm"> * Sets a new CPUFreq policy.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">centrino_target</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">target_freq</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">relation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>    <span class="n">newstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">msr</span><span class="p">,</span> <span class="n">oldmsr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpufreq_freqs</span>	<span class="n">freqs</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">first_cpu</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">cpumask_var_t</span> <span class="n">covered_cpus</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">zalloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">covered_cpus</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_model</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cpufreq_frequency_table_target</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span>
			<span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_model</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">op_points</span><span class="p">,</span>
			<span class="n">target_freq</span><span class="p">,</span>
			<span class="n">relation</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">newstate</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">first_cpu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">good_cpu</span><span class="p">;</span>

		<span class="cm">/* cpufreq holds the hotplug lock, so we are safe here */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_online</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Support for SMP systems.</span>
<span class="cm">		 * Make sure we are running on CPU that wants to change freq</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">shared_type</span> <span class="o">==</span> <span class="n">CPUFREQ_SHARED_TYPE_ANY</span><span class="p">)</span>
			<span class="n">good_cpu</span> <span class="o">=</span> <span class="n">cpumask_any_and</span><span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">,</span>
						   <span class="n">cpu_online_mask</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">good_cpu</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">good_cpu</span> <span class="o">&gt;=</span> <span class="n">nr_cpu_ids</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;couldn&#39;t limit to CPUs in this domain</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first_cpu</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* We haven&#39;t started the transition yet. */</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msr</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">centrino_model</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">op_points</span><span class="p">[</span><span class="n">newstate</span><span class="p">].</span><span class="n">index</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">first_cpu</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdmsr_on_cpu</span><span class="p">(</span><span class="n">good_cpu</span><span class="p">,</span> <span class="n">MSR_IA32_PERF_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldmsr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">==</span> <span class="p">(</span><span class="n">oldmsr</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;no change needed - msr was and needs &quot;</span>
					<span class="s">&quot;to be %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">oldmsr</span><span class="p">);</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">freqs</span><span class="p">.</span><span class="n">old</span> <span class="o">=</span> <span class="n">extract_clock</span><span class="p">(</span><span class="n">oldmsr</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">freqs</span><span class="p">.</span><span class="n">new</span> <span class="o">=</span> <span class="n">extract_clock</span><span class="p">(</span><span class="n">msr</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;target=%dkHz old=%d new=%d msr=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">target_freq</span><span class="p">,</span> <span class="n">freqs</span><span class="p">.</span><span class="n">old</span><span class="p">,</span> <span class="n">freqs</span><span class="p">.</span><span class="n">new</span><span class="p">,</span> <span class="n">msr</span><span class="p">);</span>

			<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_online</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">freqs</span><span class="p">.</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
				<span class="n">cpufreq_notify_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">freqs</span><span class="p">,</span>
					<span class="n">CPUFREQ_PRECHANGE</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">first_cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* all but 16 LSB are reserved, treat them with care */</span>
			<span class="n">oldmsr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xffff</span><span class="p">;</span>
			<span class="n">msr</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="n">oldmsr</span> <span class="o">|=</span> <span class="n">msr</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">wrmsr_on_cpu</span><span class="p">(</span><span class="n">good_cpu</span><span class="p">,</span> <span class="n">MSR_IA32_PERF_CTL</span><span class="p">,</span> <span class="n">oldmsr</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">shared_type</span> <span class="o">==</span> <span class="n">CPUFREQ_SHARED_TYPE_ANY</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">cpumask_set_cpu</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">covered_cpus</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_online</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">freqs</span><span class="p">.</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
		<span class="n">cpufreq_notify_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">freqs</span><span class="p">,</span> <span class="n">CPUFREQ_POSTCHANGE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">retval</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We have failed halfway through the frequency change.</span>
<span class="cm">		 * We have sent callbacks to policy-&gt;cpus and</span>
<span class="cm">		 * MSRs have already been written on coverd_cpus.</span>
<span class="cm">		 * Best effort undo..</span>
<span class="cm">		 */</span>

		<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">covered_cpus</span><span class="p">)</span>
			<span class="n">wrmsr_on_cpu</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">MSR_IA32_PERF_CTL</span><span class="p">,</span> <span class="n">oldmsr</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">.</span><span class="n">new</span><span class="p">;</span>
		<span class="n">freqs</span><span class="p">.</span><span class="n">new</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">.</span><span class="n">old</span><span class="p">;</span>
		<span class="n">freqs</span><span class="p">.</span><span class="n">old</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">for_each_cpu</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpus</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_online</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">cpufreq_notify_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">freqs</span><span class="p">,</span> <span class="n">CPUFREQ_PRECHANGE</span><span class="p">);</span>
			<span class="n">cpufreq_notify_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">freqs</span><span class="p">,</span> <span class="n">CPUFREQ_POSTCHANGE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">covered_cpus</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">freq_attr</span><span class="o">*</span> <span class="n">centrino_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">cpufreq_freq_attr_scaling_available_freqs</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_driver</span> <span class="n">centrino_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;centrino&quot;</span><span class="p">,</span> <span class="cm">/* should be speedstep-centrino,</span>
<span class="cm">					 but there&#39;s a 16 char limit */</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">centrino_cpu_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span>		<span class="o">=</span> <span class="n">centrino_cpu_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">verify</span>		<span class="o">=</span> <span class="n">centrino_verify</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target</span>		<span class="o">=</span> <span class="n">centrino_target</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span>		<span class="o">=</span> <span class="n">get_cur_freq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attr</span>           <span class="o">=</span> <span class="n">centrino_attr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This doesn&#39;t replace the detailed checks above because</span>
<span class="cm"> * the generic CPU IDs don&#39;t have a way to match for steppings</span>
<span class="cm"> * or ASCII model IDs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">x86_cpu_id</span> <span class="n">centrino_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">X86_VENDOR_INTEL</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">X86_FEATURE_EST</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">X86_VENDOR_INTEL</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">X86_FEATURE_EST</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">X86_VENDOR_INTEL</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">X86_FEATURE_EST</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">X86_VENDOR_INTEL</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">X86_FEATURE_EST</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">X86_VENDOR_INTEL</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">X86_FEATURE_EST</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">X86_VENDOR_INTEL</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">X86_FEATURE_EST</span> <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* Autoload or not? Do not for now. */</span>
<span class="c">MODULE_DEVICE_TABLE(x86cpu, centrino_ids);</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * centrino_init - initializes the Enhanced SpeedStep CPUFreq driver</span>
<span class="cm"> *</span>
<span class="cm"> * Initializes the Enhanced SpeedStep support. Returns -ENODEV on</span>
<span class="cm"> * unsupported devices, -ENOENT if there&#39;s no voltage table for this</span>
<span class="cm"> * particular CPU model, -EINVAL on problems during initiatization,</span>
<span class="cm"> * and zero on success.</span>
<span class="cm"> *</span>
<span class="cm"> * This is quite picky.  Not only does the CPU have to advertise the</span>
<span class="cm"> * &quot;est&quot; flag in the cpuid capability flags, we look for a specific</span>
<span class="cm"> * CPU model and stepping, and we need to have the exact model name in</span>
<span class="cm"> * our voltage tables.  That is, be paranoid about not releasing</span>
<span class="cm"> * someone&#39;s valuable magic smoke.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">centrino_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x86_match_cpu</span><span class="p">(</span><span class="n">centrino_ids</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cpufreq_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">centrino_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">centrino_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpufreq_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">centrino_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span> <span class="p">(</span><span class="s">&quot;Jeremy Fitzhardinge &lt;jeremy@goop.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span> <span class="p">(</span><span class="s">&quot;Enhanced SpeedStep driver for Intel Pentium M processors.&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span> <span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">late_initcall</span><span class="p">(</span><span class="n">centrino_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">centrino_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
