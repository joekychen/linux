<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › nubus › nubus.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>nubus.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	Macintosh Nubus Interface Code</span>
<span class="cm"> *</span>
<span class="cm"> *      Originally by Alan Cox</span>
<span class="cm"> *</span>
<span class="cm"> *      Mostly rewritten by David Huggins-Daines, C. Scott Ananian,</span>
<span class="cm"> *      and others.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/nubus.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/hwtest.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;asm/mac_via.h&gt;</span>
<span class="cp">#include &lt;asm/mac_oss.h&gt;</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">via_nubus_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">oss_nubus_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* Constants */</span>

<span class="cm">/* This is, of course, the size in bytelanes, rather than the size in</span>
<span class="cm">   actual bytes */</span>
<span class="cp">#define FORMAT_BLOCK_SIZE 20</span>
<span class="cp">#define ROM_DIR_OFFSET 0x24</span>

<span class="cp">#define NUBUS_TEST_PATTERN 0x5A932BC7</span>

<span class="cm">/* Define this if you like to live dangerously - it is known not to</span>
<span class="cm">   work on pretty much every machine except the Quadra 630 and the LC</span>
<span class="cm">   III. */</span>
<span class="cp">#undef I_WANT_TO_PROBE_SLOT_ZERO</span>

<span class="cm">/* This sometimes helps combat failure to boot */</span>
<span class="cp">#undef TRY_TO_DODGE_WSOD</span>

<span class="cm">/* Globals */</span>

<span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span>   <span class="n">nubus_devices</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">nubus_board</span><span class="o">*</span> <span class="n">nubus_boards</span><span class="p">;</span>

<span class="cm">/* Meaning of &quot;bytelanes&quot;:</span>

<span class="cm">   The card ROM may appear on any or all bytes of each long word in</span>
<span class="cm">   NuBus memory.  The low 4 bits of the &quot;map&quot; value found in the</span>
<span class="cm">   format block (at the top of the slot address space, as well as at</span>
<span class="cm">   the top of the MacOS ROM) tells us which bytelanes, i.e. which byte</span>
<span class="cm">   offsets within each longword, are valid.  Thus:</span>

<span class="cm">   A map of 0x0f, as found in the MacOS ROM, means that all bytelanes</span>
<span class="cm">   are valid.</span>

<span class="cm">   A map of 0xf0 means that no bytelanes are valid (We pray that we</span>
<span class="cm">   will never encounter this, but stranger things have happened)</span>

<span class="cm">   A map of 0xe1 means that only the MSB of each long word is actually</span>
<span class="cm">   part of the card ROM.  (We hope to never encounter NuBus on a</span>
<span class="cm">   little-endian machine.  Again, stranger things have happened)</span>

<span class="cm">   A map of 0x78 means that only the LSB of each long word is valid.</span>

<span class="cm">   Etcetera, etcetera.  Hopefully this clears up some confusion over</span>
<span class="cm">   what the following code actually does.  */</span>
 
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">not_useful</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pv</span><span class="o">=</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="n">pv</span> <span class="o">&amp;=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">map</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">pv</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">nubus_get_rom</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This will hold the result */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">len</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">v</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">while</span><span class="p">(</span><span class="n">not_useful</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">map</span><span class="p">))</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nubus_rewind</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="o">=*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="cm">/* Sanity check */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">65536</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;rewind of 0x%08x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">len</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">do</span>
		<span class="p">{</span>
			<span class="n">p</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span><span class="p">(</span><span class="n">not_useful</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">map</span><span class="p">));</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">=</span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nubus_advance</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">len</span><span class="o">&gt;</span><span class="mi">65536</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;advance of 0x%08x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">len</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">while</span><span class="p">(</span><span class="n">not_useful</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">map</span><span class="p">))</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nubus_move</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nubus_advance</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nubus_rewind</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Now, functions to read the sResource tree */</span>

<span class="cm">/* Each sResource entry consists of a 1-byte ID and a 3-byte data</span>
<span class="cm">   field.  If that data field contains an offset, then obviously we</span>
<span class="cm">   have to expand it from a 24-bit signed number to a 32-bit signed</span>
<span class="cm">   number. */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span> <span class="nf">nubus_expand32</span><span class="p">(</span><span class="kt">long</span> <span class="n">foo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">foo</span> <span class="o">&amp;</span> <span class="mh">0x00800000</span><span class="p">)</span>	<span class="cm">/* 24bit negative */</span>
		<span class="n">foo</span> <span class="o">|=</span> <span class="mh">0xFF000000</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">foo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">nubus_rom_addr</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>	
	<span class="cm">/*</span>
<span class="cm">	 *	Returns the first byte after the card. We then walk</span>
<span class="cm">	 *	backwards to get the lane register and the config</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="mh">0xF1000000</span><span class="o">+</span><span class="p">(</span><span class="n">slot</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">nubus_dirptr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nubus_dirent</span> <span class="o">*</span><span class="n">nd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">nd</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="cm">/* Essentially, just step over the bytelanes using whatever</span>
<span class="cm">	   offset we might have found */</span>
	<span class="n">nubus_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">nubus_expand32</span><span class="p">(</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="n">nd</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
	<span class="cm">/* And return the value */</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* These two are for pulling resource data blocks (i.e. stuff that&#39;s</span>
<span class="cm">   pointed to with offsets) out of the card ROM. */</span>

<span class="kt">void</span> <span class="nf">nubus_get_rsrc_mem</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nubus_dirent</span><span class="o">*</span> <span class="n">dirent</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dest</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">nubus_dirptr</span><span class="p">(</span><span class="n">dirent</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">len</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="o">*</span><span class="n">t</span><span class="o">++</span> <span class="o">=</span> <span class="n">nubus_get_rom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dirent</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nubus_get_rsrc_mem</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">nubus_get_rsrc_str</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nubus_dirent</span><span class="o">*</span> <span class="n">dirent</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">t</span><span class="o">=</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dest</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">nubus_dirptr</span><span class="p">(</span><span class="n">dirent</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">len</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">nubus_get_rom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dirent</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!*</span><span class="n">t</span><span class="o">++</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nubus_get_rsrc_str</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">nubus_get_root_dir</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nubus_board</span><span class="o">*</span> <span class="n">board</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">nubus_dir</span><span class="o">*</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dir</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">directory</span><span class="p">;</span>
	<span class="n">dir</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dir</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">lanes</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nubus_get_root_dir</span><span class="p">);</span>

<span class="cm">/* This is a slyly renamed version of the above */</span>
<span class="kt">int</span> <span class="nf">nubus_get_func_dir</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">nubus_dir</span><span class="o">*</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dir</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">directory</span><span class="p">;</span>
	<span class="n">dir</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dir</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">lanes</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nubus_get_func_dir</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">nubus_get_board_dir</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nubus_board</span><span class="o">*</span> <span class="n">board</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">nubus_dir</span><span class="o">*</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nubus_dirent</span> <span class="n">ent</span><span class="p">;</span>
	
	<span class="n">dir</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">directory</span><span class="p">;</span>
	<span class="n">dir</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dir</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">lanes</span><span class="p">;</span>

	<span class="cm">/* Now dereference it (the first directory is always the board</span>
<span class="cm">	   directory) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nubus_readdir</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nubus_get_subdir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="p">,</span> <span class="n">dir</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nubus_get_board_dir</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">nubus_get_subdir</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">nubus_dirent</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">nubus_dir</span> <span class="o">*</span><span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dir</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">nubus_dirptr</span><span class="p">(</span><span class="n">ent</span><span class="p">);</span>
	<span class="n">dir</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dir</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nubus_get_subdir</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">nubus_readdir</span><span class="p">(</span><span class="k">struct</span> <span class="n">nubus_dir</span> <span class="o">*</span><span class="n">nd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nubus_dirent</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">resid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Do this first, otherwise nubus_rewind &amp; co are off by 4 */</span>
	<span class="n">ent</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">nd</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>

	<span class="cm">/* This moves nd-&gt;ptr forward */</span>
	<span class="n">resid</span> <span class="o">=</span> <span class="n">nubus_get_rom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">nd</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>

	<span class="cm">/* EOL marker, as per the Apple docs */</span>
	<span class="k">if</span><span class="p">((</span><span class="n">resid</span><span class="o">&amp;</span><span class="mh">0xff000000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xff000000</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* Mark it as done */</span>
		<span class="n">nd</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* First byte is the resource ID */</span>
	<span class="n">ent</span><span class="o">-&gt;</span><span class="n">type</span>  <span class="o">=</span> <span class="n">resid</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="cm">/* Low 3 bytes might contain data (or might not) */</span>
	<span class="n">ent</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">resid</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">;</span>
	<span class="n">ent</span><span class="o">-&gt;</span><span class="n">mask</span>  <span class="o">=</span> <span class="n">nd</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nubus_readdir</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">nubus_rewinddir</span><span class="p">(</span><span class="k">struct</span> <span class="n">nubus_dir</span><span class="o">*</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dir</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nubus_rewinddir</span><span class="p">);</span>

<span class="cm">/* Driver interface functions, more or less like in pci.c */</span>

<span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span>
<span class="nf">nubus_find_device</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">category</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">type</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">dr_hw</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">dr_sw</span><span class="p">,</span>
		  <span class="k">const</span> <span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span> <span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span> <span class="n">itor</span> <span class="o">=</span>
		<span class="n">from</span> <span class="o">?</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">:</span> <span class="n">nubus_devices</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">itor</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">itor</span><span class="o">-&gt;</span><span class="n">category</span> <span class="o">==</span> <span class="n">category</span>
		    <span class="o">&amp;&amp;</span> <span class="n">itor</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">type</span>
		    <span class="o">&amp;&amp;</span> <span class="n">itor</span><span class="o">-&gt;</span><span class="n">dr_hw</span> <span class="o">==</span> <span class="n">dr_hw</span>
		    <span class="o">&amp;&amp;</span> <span class="n">itor</span><span class="o">-&gt;</span><span class="n">dr_sw</span> <span class="o">==</span> <span class="n">dr_sw</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">itor</span><span class="p">;</span>
		<span class="n">itor</span> <span class="o">=</span> <span class="n">itor</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nubus_find_device</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span>
<span class="nf">nubus_find_type</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">category</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">type</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span> <span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span> <span class="n">itor</span> <span class="o">=</span>
		<span class="n">from</span> <span class="o">?</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">:</span> <span class="n">nubus_devices</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">itor</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">itor</span><span class="o">-&gt;</span><span class="n">category</span> <span class="o">==</span> <span class="n">category</span>
		    <span class="o">&amp;&amp;</span> <span class="n">itor</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">itor</span><span class="p">;</span>
		<span class="n">itor</span> <span class="o">=</span> <span class="n">itor</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nubus_find_type</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span>
<span class="nf">nubus_find_slot</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span> <span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span> <span class="n">itor</span> <span class="o">=</span>
		<span class="n">from</span> <span class="o">?</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">:</span> <span class="n">nubus_devices</span><span class="p">;</span>
	
	<span class="k">while</span> <span class="p">(</span><span class="n">itor</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">itor</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">==</span> <span class="n">slot</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">itor</span><span class="p">;</span>
		<span class="n">itor</span> <span class="o">=</span> <span class="n">itor</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nubus_find_slot</span><span class="p">);</span>

<span class="kt">int</span>
<span class="nf">nubus_find_rsrc</span><span class="p">(</span><span class="k">struct</span> <span class="n">nubus_dir</span><span class="o">*</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rsrc_type</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nubus_dirent</span><span class="o">*</span> <span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nubus_readdir</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">ent</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">rsrc_type</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>	
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nubus_find_rsrc</span><span class="p">);</span>

<span class="cm">/* Initialization functions - decide which slots contain stuff worth</span>
<span class="cm">   looking at, and print out lots and lots of information from the</span>
<span class="cm">   resource blocks. */</span>

<span class="cm">/* FIXME: A lot of this stuff will eventually be useful after</span>
<span class="cm">   initialization, for intelligently probing Ethernet and video chips,</span>
<span class="cm">   among other things.  The rest of it should go in the /proc code.</span>
<span class="cm">   For now, we just use it to give verbose boot logs. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nubus_show_display_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span>
					      <span class="k">const</span> <span class="k">struct</span> <span class="n">nubus_dirent</span><span class="o">*</span> <span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NUBUS_RESID_GAMMADIR</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    gamma directory offset: 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0080</span> <span class="p">...</span> <span class="mh">0x0085</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    mode %02X info offset: 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ent</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    unknown resource %02X, data 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ent</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nubus_show_network_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span>
					      <span class="k">const</span> <span class="k">struct</span> <span class="n">nubus_dirent</span><span class="o">*</span> <span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NUBUS_RESID_MAC_ADDRESS</span>:
	<span class="p">{</span>
		<span class="kt">char</span> <span class="n">addr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		
		<span class="n">nubus_get_rsrc_mem</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">ent</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    MAC address: &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x%s&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
			       <span class="n">i</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;:&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    unknown resource %02X, data 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ent</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nubus_show_cpu_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span>
					  <span class="k">const</span> <span class="k">struct</span> <span class="n">nubus_dirent</span><span class="o">*</span> <span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NUBUS_RESID_MEMINFO</span>:
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">meminfo</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">nubus_get_rsrc_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meminfo</span><span class="p">,</span> <span class="n">ent</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    memory: [ 0x%08lx 0x%08lx ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">meminfo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">meminfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">NUBUS_RESID_ROMINFO</span>:
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rominfo</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">nubus_get_rsrc_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rominfo</span><span class="p">,</span> <span class="n">ent</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    ROM:    [ 0x%08lx 0x%08lx ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rominfo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rominfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    unknown resource %02X, data 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ent</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nubus_show_private_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span>
					      <span class="k">const</span> <span class="k">struct</span> <span class="n">nubus_dirent</span><span class="o">*</span> <span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">category</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NUBUS_CAT_DISPLAY</span>:
		<span class="n">nubus_show_display_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NUBUS_CAT_NETWORK</span>:
		<span class="n">nubus_show_network_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NUBUS_CAT_CPU</span>:
		<span class="n">nubus_show_cpu_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    unknown resource %02X, data 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ent</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span> <span class="n">__init</span>
	   <span class="nf">nubus_get_functional_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">nubus_board</span><span class="o">*</span> <span class="n">board</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span>
					 <span class="k">const</span> <span class="k">struct</span> <span class="n">nubus_dirent</span><span class="o">*</span> <span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nubus_dir</span>    <span class="n">dir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nubus_dirent</span> <span class="n">ent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span>   <span class="n">dev</span><span class="p">;</span>
	
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  Function 0x%02x:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">nubus_get_subdir</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dir</span><span class="p">);</span>

	<span class="cm">/* Apple seems to have botched the ROM on the IIx */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dir</span><span class="p">.</span><span class="n">base</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dir</span><span class="p">.</span><span class="n">base</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">console_loglevel</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;nubus_get_functional_resource: parent is 0x%p, dir is 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">parent</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">dir</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>

	<span class="cm">/* Actually we should probably panic if this fails */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dev</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>	
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">resid</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">directory</span> <span class="o">=</span> <span class="n">dir</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">=</span> <span class="n">board</span><span class="p">;</span>
	
	<span class="k">while</span> <span class="p">(</span><span class="n">nubus_readdir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">ent</span><span class="p">.</span><span class="n">type</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">NUBUS_RESID_TYPE</span>:
		<span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">nbtdata</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
			<span class="n">nubus_get_rsrc_mem</span><span class="p">(</span><span class="n">nbtdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">category</span> <span class="o">=</span> <span class="n">nbtdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span>     <span class="o">=</span> <span class="n">nbtdata</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dr_sw</span>    <span class="o">=</span> <span class="n">nbtdata</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dr_hw</span>    <span class="o">=</span> <span class="n">nbtdata</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    type: [cat 0x%x type 0x%x hw 0x%x sw 0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">nbtdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nbtdata</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nbtdata</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">nbtdata</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">NUBUS_RESID_NAME</span>:
		<span class="p">{</span>
			<span class="n">nubus_get_rsrc_str</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    name: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">NUBUS_RESID_DRVRDIR</span>:
		<span class="p">{</span>
			<span class="cm">/* MacOS driver.  If we were NetBSD we might</span>
<span class="cm">			   use this :-) */</span>
			<span class="k">struct</span> <span class="n">nubus_dir</span> <span class="n">drvr_dir</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">nubus_dirent</span> <span class="n">drvr_ent</span><span class="p">;</span>
			<span class="n">nubus_get_subdir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drvr_dir</span><span class="p">);</span>
			<span class="n">nubus_readdir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drvr_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drvr_ent</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">nubus_dirptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drvr_ent</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    driver at: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">NUBUS_RESID_MINOR_BASEOS</span>:
			<span class="cm">/* We will need this in order to support</span>
<span class="cm">			   multiple framebuffers.  It might be handy</span>
<span class="cm">			   for Ethernet as well */</span>
			<span class="n">nubus_get_rsrc_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    memory offset: 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NUBUS_RESID_MINOR_LENGTH</span>:
			<span class="cm">/* Ditto */</span>
			<span class="n">nubus_get_rsrc_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iosize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    memory length: 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iosize</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>			
		<span class="k">case</span> <span class="n">NUBUS_RESID_FLAGS</span>:
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ent</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    flags: 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NUBUS_RESID_HWDEVID</span>:
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwdevid</span> <span class="o">=</span> <span class="n">ent</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    hwdevid: 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwdevid</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* Local/Private resources have their own</span>
<span class="cm">			   function */</span>
			<span class="n">nubus_show_private_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
		
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This is cool. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nubus_get_vidnames</span><span class="p">(</span><span class="k">struct</span> <span class="n">nubus_board</span><span class="o">*</span> <span class="n">board</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">nubus_dirent</span><span class="o">*</span> <span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nubus_dir</span>    <span class="n">dir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nubus_dirent</span> <span class="n">ent</span><span class="p">;</span>
	<span class="cm">/* FIXME: obviously we want to put this in a header file soon */</span>
	<span class="k">struct</span> <span class="n">vidmode</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
		<span class="cm">/* Don&#39;t know what this is yet */</span>
		<span class="n">u16</span> <span class="n">id</span><span class="p">;</span>
		<span class="cm">/* Longest one I&#39;ve seen so far is 26 characters */</span>
		<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="p">};</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    video modes supported:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">nubus_get_subdir</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">console_loglevel</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;nubus_get_vidnames: parent is 0x%p, dir is 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">parent</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">dir</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>

	<span class="k">while</span><span class="p">(</span><span class="n">nubus_readdir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">vidmode</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>

		<span class="cm">/* First get the length */</span>
		<span class="n">nubus_get_rsrc_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		
		<span class="cm">/* Now clobber the whole thing */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mode</span><span class="p">));</span>
		<span class="n">nubus_get_rsrc_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;      %02X: (%02X) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ent</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
			<span class="n">mode</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">mode</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This is *really* cool. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nubus_get_icon</span><span class="p">(</span><span class="k">struct</span> <span class="n">nubus_board</span><span class="o">*</span> <span class="n">board</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">nubus_dirent</span><span class="o">*</span> <span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Should be 32x32 if my memory serves me correctly */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">icon</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
	
	<span class="n">nubus_get_rsrc_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">icon</span><span class="p">,</span> <span class="n">ent</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    icon:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* We should actually plot these somewhere in the framebuffer</span>
<span class="cm">	   init.  This is just to demonstrate that they do, in fact,</span>
<span class="cm">	   exist */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;      &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">icon</span><span class="p">[</span><span class="n">y</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="n">x</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span>
			    <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">x</span><span class="o">%</span><span class="mi">8</span><span class="p">)))</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nubus_get_vendorinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">nubus_board</span><span class="o">*</span> <span class="n">board</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">nubus_dirent</span><span class="o">*</span> <span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nubus_dir</span>    <span class="n">dir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nubus_dirent</span> <span class="n">ent</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span><span class="o">*</span> <span class="n">vendor_fields</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;ID&quot;</span><span class="p">,</span> <span class="s">&quot;serial&quot;</span><span class="p">,</span> <span class="s">&quot;revision&quot;</span><span class="p">,</span>
					 <span class="s">&quot;part&quot;</span><span class="p">,</span> <span class="s">&quot;date&quot;</span><span class="p">,</span> <span class="s">&quot;unknown field&quot;</span><span class="p">};</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    vendor info:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">nubus_get_subdir</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">console_loglevel</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;nubus_get_vendorinfo: parent is 0x%p, dir is 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">parent</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">dir</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>

	<span class="k">while</span><span class="p">(</span><span class="n">nubus_readdir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
		
		<span class="cm">/* These are all strings, we think */</span>
		<span class="n">nubus_get_rsrc_str</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="p">.</span><span class="n">type</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">ent</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">vendor_fields</span><span class="p">[</span><span class="n">ent</span><span class="p">.</span><span class="n">type</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nubus_get_board_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">nubus_board</span><span class="o">*</span> <span class="n">board</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span>
					   <span class="k">const</span> <span class="k">struct</span> <span class="n">nubus_dirent</span><span class="o">*</span> <span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nubus_dir</span>    <span class="n">dir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nubus_dirent</span> <span class="n">ent</span><span class="p">;</span>
	
	<span class="n">nubus_get_subdir</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">console_loglevel</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;nubus_get_board_resource: parent is 0x%p, dir is 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">parent</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">dir</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>

	<span class="k">while</span><span class="p">(</span><span class="n">nubus_readdir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ent</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NUBUS_RESID_TYPE</span>:
		<span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">nbtdata</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
			<span class="cm">/* This type is always the same, and is not</span>
<span class="cm">			   useful except insofar as it tells us that</span>
<span class="cm">			   we really are looking at a board resource. */</span>
			<span class="n">nubus_get_rsrc_mem</span><span class="p">(</span><span class="n">nbtdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    type: [cat 0x%x type 0x%x hw 0x%x sw 0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">nbtdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nbtdata</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nbtdata</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			       <span class="n">nbtdata</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nbtdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">nbtdata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">nbtdata</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">nbtdata</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;this sResource is not a board resource!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">NUBUS_RESID_NAME</span>:
			<span class="n">nubus_get_rsrc_str</span><span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    name: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NUBUS_RESID_ICON</span>:
			<span class="n">nubus_get_icon</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NUBUS_RESID_BOARDID</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    board id: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ent</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NUBUS_RESID_PRIMARYINIT</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    primary init offset: 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ent</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NUBUS_RESID_VENDORINFO</span>:
			<span class="n">nubus_get_vendorinfo</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NUBUS_RESID_FLAGS</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    flags: 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ent</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NUBUS_RESID_HWDEVID</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    hwdevid: 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ent</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NUBUS_RESID_SECONDINIT</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    secondary init offset: 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ent</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* WTF isn&#39;t this in the functional resources? */</span> 
		<span class="k">case</span> <span class="n">NUBUS_RESID_VIDNAMES</span>:
			<span class="n">nubus_get_vidnames</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* Same goes for this */</span>
		<span class="k">case</span> <span class="n">NUBUS_RESID_VIDMODES</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    video mode parameter directory offset: 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ent</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>			
		<span class="k">default</span><span class="o">:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    unknown resource %02X, data 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ent</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">ent</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Attempt to bypass the somewhat non-obvious arrangement of</span>
<span class="cm">   sResources in the motherboard ROM */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">nubus_find_rom_dir</span><span class="p">(</span><span class="k">struct</span> <span class="n">nubus_board</span><span class="o">*</span> <span class="n">board</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">rp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">romdir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nubus_dir</span> <span class="n">dir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nubus_dirent</span> <span class="n">ent</span><span class="p">;</span>

	<span class="cm">/* Check for the extra directory just under the format block */</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">fblock</span><span class="p">;</span>
	<span class="n">nubus_rewind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">lanes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nubus_get_rom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">lanes</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NUBUS_TEST_PATTERN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* OK, the ROM was telling the truth */</span>
		<span class="n">board</span><span class="o">-&gt;</span><span class="n">directory</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">fblock</span><span class="p">;</span>
		<span class="n">nubus_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">directory</span><span class="p">,</span>
			   <span class="n">nubus_expand32</span><span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">doffset</span><span class="p">),</span>
			   <span class="n">board</span><span class="o">-&gt;</span><span class="n">lanes</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* On &quot;slot zero&quot;, you have to walk down a few more</span>
<span class="cm">	   directories to get to the equivalent of a real card&#39;s root</span>
<span class="cm">	   directory.  We don&#39;t know what they were smoking when they</span>
<span class="cm">	   came up with this. */</span>
	<span class="n">romdir</span> <span class="o">=</span> <span class="n">nubus_rom_addr</span><span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
	<span class="n">nubus_rewind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">romdir</span><span class="p">,</span> <span class="n">ROM_DIR_OFFSET</span><span class="p">,</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">lanes</span><span class="p">);</span>
	<span class="n">dir</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">dir</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">romdir</span><span class="p">;</span>
	<span class="n">dir</span><span class="p">.</span><span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dir</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">lanes</span><span class="p">;</span>

	<span class="cm">/* This one points to an &quot;Unknown Macintosh&quot; directory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nubus_readdir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">badrom</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">console_loglevel</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;nubus_get_rom_dir: entry %02x %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ent</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">ent</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="cm">/* This one takes us to where we want to go. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nubus_readdir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
		<span class="k">goto</span> <span class="n">badrom</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">console_loglevel</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;nubus_get_rom_dir: entry %02x %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ent</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">ent</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="n">nubus_get_subdir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dir</span><span class="p">);</span>

	<span class="cm">/* Resource ID 01, also an &quot;Unknown Macintosh&quot; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nubus_readdir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
		<span class="k">goto</span> <span class="n">badrom</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">console_loglevel</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;nubus_get_rom_dir: entry %02x %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ent</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">ent</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>

	<span class="cm">/* FIXME: the first one is *not* always the right one.  We</span>
<span class="cm">	   suspect this has something to do with the ROM revision.</span>
<span class="cm">	   &quot;The HORROR ROM&quot; (LC-series) uses 0x7e, while &quot;The HORROR</span>
<span class="cm">	   Continues&quot; (Q630) uses 0x7b.  The DAFB Macs evidently use</span>
<span class="cm">	   something else.  Please run &quot;Slots&quot; on your Mac (see</span>
<span class="cm">	   include/linux/nubus.h for where to get this program) and</span>
<span class="cm">	   tell us where the &#39;SiDirPtr&#39; for Slot 0 is.  If you feel</span>
<span class="cm">	   brave, you should also use MacsBug to walk down the ROM</span>
<span class="cm">	   directories like this function does and try to find the</span>
<span class="cm">	   path to that address... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nubus_readdir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">badrom</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">console_loglevel</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;nubus_get_rom_dir: entry %02x %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ent</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">ent</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	
	<span class="cm">/* Bwahahahaha... */</span>
	<span class="n">nubus_get_subdir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dir</span><span class="p">);</span>
	<span class="n">board</span><span class="o">-&gt;</span><span class="n">directory</span> <span class="o">=</span> <span class="n">dir</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
	
	<span class="cm">/* Even more evil laughter... */</span>
 <span class="nl">badrom:</span>
	<span class="n">board</span><span class="o">-&gt;</span><span class="n">directory</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">fblock</span><span class="p">;</span>
	<span class="n">nubus_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">directory</span><span class="p">,</span> <span class="n">nubus_expand32</span><span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">doffset</span><span class="p">),</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">lanes</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;nubus_get_rom_dir: ROM weirdness!  Notify the developers...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Add a board (might be many devices) to the list */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nubus_board</span><span class="o">*</span> <span class="n">__init</span> <span class="nf">nubus_add_board</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bytelanes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nubus_board</span><span class="o">*</span> <span class="n">board</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nubus_board</span><span class="o">**</span> <span class="n">boardp</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dpat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nubus_dir</span> <span class="n">dir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nubus_dirent</span> <span class="n">ent</span><span class="p">;</span>

	<span class="cm">/* Move to the start of the format block */</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="n">nubus_rom_addr</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>		
	<span class="n">nubus_rewind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="n">FORMAT_BLOCK_SIZE</span><span class="p">,</span> <span class="n">bytelanes</span><span class="p">);</span>

	<span class="cm">/* Actually we should probably panic if this fails */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">board</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">board</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>	
	<span class="n">board</span><span class="o">-&gt;</span><span class="n">fblock</span> <span class="o">=</span> <span class="n">rp</span><span class="p">;</span>

	<span class="cm">/* Dump the format block for debugging purposes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">console_loglevel</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Slot %X, format block at 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">slot</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Format block: &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FORMAT_BLOCK_SIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">foo</span><span class="p">,</span> <span class="n">bar</span><span class="p">;</span>
			<span class="n">foo</span> <span class="o">=</span> <span class="n">nubus_get_rom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bytelanes</span><span class="p">);</span>
			<span class="n">bar</span> <span class="o">=</span> <span class="n">nubus_get_rom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bytelanes</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%04x %04x  &quot;</span><span class="p">,</span> <span class="n">foo</span><span class="p">,</span> <span class="n">bar</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rp</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">fblock</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">board</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
	<span class="n">board</span><span class="o">-&gt;</span><span class="n">slot_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">nubus_slot_addr</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>
	<span class="n">board</span><span class="o">-&gt;</span><span class="n">doffset</span> <span class="o">=</span> <span class="n">nubus_get_rom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">bytelanes</span><span class="p">);</span>
	<span class="cm">/* rom_length is *supposed* to be the total length of the</span>
<span class="cm">	 * ROM.  In practice it is the &quot;amount of ROM used to compute</span>
<span class="cm">	 * the CRC.&quot;  So some jokers decide to set it to zero and</span>
<span class="cm">	 * set the crc to zero so they don&#39;t have to do any math.</span>
<span class="cm">	 * See the Performa 460 ROM, for example.  Those Apple &quot;engineers&quot;.</span>
<span class="cm">	 */</span>
	<span class="n">board</span><span class="o">-&gt;</span><span class="n">rom_length</span> <span class="o">=</span> <span class="n">nubus_get_rom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">bytelanes</span><span class="p">);</span>
	<span class="n">board</span><span class="o">-&gt;</span><span class="n">crc</span> <span class="o">=</span> <span class="n">nubus_get_rom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">bytelanes</span><span class="p">);</span>
	<span class="n">board</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="n">nubus_get_rom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bytelanes</span><span class="p">);</span>
	<span class="n">board</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">nubus_get_rom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">bytelanes</span><span class="p">);</span>
	<span class="n">board</span><span class="o">-&gt;</span><span class="n">lanes</span> <span class="o">=</span> <span class="n">bytelanes</span><span class="p">;</span>

	<span class="cm">/* Directory offset should be small and negative... */</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">doffset</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Dodgy doffset!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dpat</span> <span class="o">=</span> <span class="n">nubus_get_rom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">bytelanes</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">dpat</span> <span class="o">!=</span> <span class="n">NUBUS_TEST_PATTERN</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Wrong test pattern %08lx!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dpat</span><span class="p">);</span>
		
	<span class="cm">/*</span>
<span class="cm">	 *	I wonder how the CRC is meant to work -</span>
<span class="cm">	 *		any takers ?</span>
<span class="cm">	 * CSA: According to MAC docs, not all cards pass the CRC anyway,</span>
<span class="cm">	 * since the initial Macintosh ROM releases skipped the check.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Attempt to work around slot zero weirdness */</span>
	<span class="n">nubus_find_rom_dir</span><span class="p">(</span><span class="n">board</span><span class="p">);</span>
	<span class="n">nubus_get_root_dir</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dir</span><span class="p">);</span>	

	<span class="cm">/* We&#39;re ready to rock */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Slot %X:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

	<span class="cm">/* Each slot should have one board resource and any number of</span>
<span class="cm">	   functional resources.  So we&#39;ll fill in some fields in the</span>
<span class="cm">	   struct nubus_board from the board resource, then walk down</span>
<span class="cm">	   the list of functional resources, spinning out a nubus_dev</span>
<span class="cm">	   for each of them. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nubus_readdir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We can&#39;t have this! */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Board resource not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  Board resource:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">nubus_get_board_resource</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Aaaarrrrgghh!  The LC III motherboard has *two* board</span>
<span class="cm">	   resources.  I have no idea WTF to do about this. */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">nubus_readdir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">*</span>  <span class="n">dev</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">nubus_dev</span><span class="o">**</span> <span class="n">devp</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">nubus_get_functional_resource</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* We zeroed this out above */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">first_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">board</span><span class="o">-&gt;</span><span class="n">first_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		
		<span class="cm">/* Put it on the global NuBus device chain. Keep entries in order. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">devp</span><span class="o">=&amp;</span><span class="n">nubus_devices</span><span class="p">;</span> <span class="o">*</span><span class="n">devp</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">;</span> <span class="n">devp</span><span class="o">=&amp;</span><span class="p">((</span><span class="o">*</span><span class="n">devp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">))</span>
			<span class="cm">/* spin */</span><span class="p">;</span>
		<span class="o">*</span><span class="n">devp</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>		
	<span class="p">}</span>

	<span class="cm">/* Put it on the global NuBus board chain. Keep entries in order. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">boardp</span><span class="o">=&amp;</span><span class="n">nubus_boards</span><span class="p">;</span> <span class="o">*</span><span class="n">boardp</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">;</span> <span class="n">boardp</span><span class="o">=&amp;</span><span class="p">((</span><span class="o">*</span><span class="n">boardp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">))</span>
		<span class="cm">/* spin */</span><span class="p">;</span>
	<span class="o">*</span><span class="n">boardp</span> <span class="o">=</span> <span class="n">board</span><span class="p">;</span>
	<span class="n">board</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	
	<span class="k">return</span> <span class="n">board</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">nubus_probe_slot</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">rp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rp</span> <span class="o">=</span> <span class="n">nubus_rom_addr</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>	
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">card_present</span><span class="p">;</span>

		<span class="n">rp</span><span class="o">--</span><span class="p">;</span>
		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">card_present</span> <span class="o">=</span> <span class="n">hwreg_present</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	       
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card_present</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Now probing slot %X at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
		<span class="n">dp</span> <span class="o">=</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">dp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* The last byte of the format block consists of two</span>
<span class="cm">		   nybbles which are &quot;mirror images&quot; of each other.</span>
<span class="cm">		   These show us the valid bytelanes */</span>
		<span class="k">if</span> <span class="p">((((</span><span class="n">dp</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">^</span> <span class="n">dp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0F</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Check that this value is actually *on* one of the</span>
<span class="cm">		   bytelanes it claims are valid! */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dp</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Looks promising.  Let&#39;s put it on the list. */</span>
		<span class="n">nubus_add_board</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">dp</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_PROC_FS)</span>

<span class="cm">/* /proc/nubus stuff */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sprint_nubus_board</span><span class="p">(</span><span class="k">struct</span> <span class="n">nubus_board</span><span class="o">*</span> <span class="n">board</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	
	<span class="n">sprintf</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="s">&quot;Slot %X: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">board</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nubus_read_proc</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">off</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nprinted</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">begin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nubus_board</span><span class="o">*</span> <span class="n">board</span><span class="p">;</span>
	
	<span class="n">len</span>   <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;Nubus devices found:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Walk the list of NuBus boards */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">board</span> <span class="o">=</span> <span class="n">nubus_boards</span><span class="p">;</span> <span class="n">board</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">board</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">nprinted</span> <span class="o">=</span> <span class="n">sprint_nubus_board</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nprinted</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">nprinted</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="o">+</span><span class="n">begin</span> <span class="o">&lt;</span> <span class="n">off</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">begin</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="o">+</span><span class="n">begin</span> <span class="o">&gt;=</span> <span class="n">off</span><span class="o">+</span><span class="n">count</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="o">+</span><span class="n">begin</span> <span class="o">&lt;</span> <span class="n">off</span><span class="p">)</span>
		<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">off</span> <span class="o">-=</span> <span class="n">begin</span><span class="p">;</span>
	<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="n">off</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="o">&gt;</span><span class="n">count</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">nubus_scan_bus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>
	<span class="cm">/* This might not work on your machine */</span>
<span class="cp">#ifdef I_WANT_TO_PROBE_SLOT_ZERO</span>
	<span class="n">nubus_probe_slot</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">for</span><span class="p">(</span><span class="n">slot</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">slot</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">nubus_probe_slot</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nubus_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MACH_IS_MAC</span><span class="p">)</span> 
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Initialize the NuBus interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oss_present</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">oss_nubus_init</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">via_nubus_init</span><span class="p">();</span>
	<span class="p">}</span>

<span class="cp">#ifdef TRY_TO_DODGE_WSOD</span>
	<span class="cm">/* Rogue Ethernet interrupts can kill the machine if we don&#39;t</span>
<span class="cm">	   do this.  Obviously this is bogus.  Hopefully the local VIA</span>
<span class="cm">	   gurus can fix the real cause of the problem. */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="cp">#endif</span>
	
	<span class="cm">/* And probe */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NuBus: Scanning NuBus slots.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">nubus_devices</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">nubus_boards</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">nubus_scan_bus</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="n">create_proc_read_entry</span><span class="p">(</span><span class="s">&quot;nubus&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">nubus_read_proc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">nubus_proc_init</span><span class="p">();</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">nubus_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
