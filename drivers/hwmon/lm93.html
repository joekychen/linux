<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › hwmon › lm93.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>lm93.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * lm93.c - Part of lm_sensors, Linux kernel modules for hardware monitoring</span>
<span class="cm"> *</span>
<span class="cm"> * Author/Maintainer: Mark M. Hoffman &lt;mhoffman@lightlink.com&gt;</span>
<span class="cm"> *	Copyright (c) 2004 Utilitek Systems, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * derived in part from lm78.c:</span>
<span class="cm"> *	Copyright (c) 1998, 1999  Frodo Looijaard &lt;frodol@dds.nl&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * derived in part from lm85.c:</span>
<span class="cm"> *	Copyright (c) 2002, 2003 Philip Pokorny &lt;ppokorny@penguincomputing.com&gt;</span>
<span class="cm"> *	Copyright (c) 2003       Margit Schubert-While &lt;margitsw@t-online.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * derived in part from w83l785ts.c:</span>
<span class="cm"> *	Copyright (c) 2003-2004 Jean Delvare &lt;khali@linux-fr.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Ported to Linux 2.6 by Eric J. Bowersox &lt;ericb@aspsys.com&gt;</span>
<span class="cm"> *	Copyright (c) 2005 Aspen Systems, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Adapted to 2.6.20 by Carsten Emde &lt;cbe@osadl.org&gt;</span>
<span class="cm"> *	Copyright (c) 2006 Carsten Emde, Open Source Automation Development Lab</span>
<span class="cm"> *</span>
<span class="cm"> * Modified for mainline integration by Hans J. Koch &lt;hjk@hansjkoch.de&gt;</span>
<span class="cm"> *	Copyright (c) 2007 Hans J. Koch, Linutronix GmbH</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon-sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon-vid.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cm">/* LM93 REGISTER ADDRESSES */</span>

<span class="cm">/* miscellaneous */</span>
<span class="cp">#define LM93_REG_MFR_ID			0x3e</span>
<span class="cp">#define LM93_REG_VER			0x3f</span>
<span class="cp">#define LM93_REG_STATUS_CONTROL		0xe2</span>
<span class="cp">#define LM93_REG_CONFIG			0xe3</span>
<span class="cp">#define LM93_REG_SLEEP_CONTROL		0xe4</span>

<span class="cm">/* alarm values start here */</span>
<span class="cp">#define LM93_REG_HOST_ERROR_1		0x48</span>

<span class="cm">/* voltage inputs: in1-in16 (nr =&gt; 0-15) */</span>
<span class="cp">#define LM93_REG_IN(nr)			(0x56 + (nr))</span>
<span class="cp">#define LM93_REG_IN_MIN(nr)		(0x90 + (nr) * 2)</span>
<span class="cp">#define LM93_REG_IN_MAX(nr)		(0x91 + (nr) * 2)</span>

<span class="cm">/* temperature inputs: temp1-temp4 (nr =&gt; 0-3) */</span>
<span class="cp">#define LM93_REG_TEMP(nr)		(0x50 + (nr))</span>
<span class="cp">#define LM93_REG_TEMP_MIN(nr)		(0x78 + (nr) * 2)</span>
<span class="cp">#define LM93_REG_TEMP_MAX(nr)		(0x79 + (nr) * 2)</span>

<span class="cm">/* temp[1-4]_auto_boost (nr =&gt; 0-3) */</span>
<span class="cp">#define LM93_REG_BOOST(nr)		(0x80 + (nr))</span>

<span class="cm">/* #PROCHOT inputs: prochot1-prochot2 (nr =&gt; 0-1) */</span>
<span class="cp">#define LM93_REG_PROCHOT_CUR(nr)	(0x67 + (nr) * 2)</span>
<span class="cp">#define LM93_REG_PROCHOT_AVG(nr)	(0x68 + (nr) * 2)</span>
<span class="cp">#define LM93_REG_PROCHOT_MAX(nr)	(0xb0 + (nr))</span>

<span class="cm">/* fan tach inputs: fan1-fan4 (nr =&gt; 0-3) */</span>
<span class="cp">#define LM93_REG_FAN(nr)		(0x6e + (nr) * 2)</span>
<span class="cp">#define LM93_REG_FAN_MIN(nr)		(0xb4 + (nr) * 2)</span>

<span class="cm">/* pwm outputs: pwm1-pwm2 (nr =&gt; 0-1, reg =&gt; 0-3) */</span>
<span class="cp">#define LM93_REG_PWM_CTL(nr, reg)	(0xc8 + (reg) + (nr) * 4)</span>
<span class="cp">#define LM93_PWM_CTL1	0x0</span>
<span class="cp">#define LM93_PWM_CTL2	0x1</span>
<span class="cp">#define LM93_PWM_CTL3	0x2</span>
<span class="cp">#define LM93_PWM_CTL4	0x3</span>

<span class="cm">/* GPIO input state */</span>
<span class="cp">#define LM93_REG_GPI			0x6b</span>

<span class="cm">/* vid inputs: vid1-vid2 (nr =&gt; 0-1) */</span>
<span class="cp">#define LM93_REG_VID(nr)		(0x6c + (nr))</span>

<span class="cm">/* vccp1 &amp; vccp2: VID relative inputs (nr =&gt; 0-1) */</span>
<span class="cp">#define LM93_REG_VCCP_LIMIT_OFF(nr)	(0xb2 + (nr))</span>

<span class="cm">/* temp[1-4]_auto_boost_hyst */</span>
<span class="cp">#define LM93_REG_BOOST_HYST_12		0xc0</span>
<span class="cp">#define LM93_REG_BOOST_HYST_34		0xc1</span>
<span class="cp">#define LM93_REG_BOOST_HYST(nr)		(0xc0 + (nr)/2)</span>

<span class="cm">/* temp[1-4]_auto_pwm_[min|hyst] */</span>
<span class="cp">#define LM93_REG_PWM_MIN_HYST_12	0xc3</span>
<span class="cp">#define LM93_REG_PWM_MIN_HYST_34	0xc4</span>
<span class="cp">#define LM93_REG_PWM_MIN_HYST(nr)	(0xc3 + (nr)/2)</span>

<span class="cm">/* prochot_override &amp; prochot_interval */</span>
<span class="cp">#define LM93_REG_PROCHOT_OVERRIDE	0xc6</span>
<span class="cp">#define LM93_REG_PROCHOT_INTERVAL	0xc7</span>

<span class="cm">/* temp[1-4]_auto_base (nr =&gt; 0-3) */</span>
<span class="cp">#define LM93_REG_TEMP_BASE(nr)		(0xd0 + (nr))</span>

<span class="cm">/* temp[1-4]_auto_offsets (step =&gt; 0-11) */</span>
<span class="cp">#define LM93_REG_TEMP_OFFSET(step)	(0xd4 + (step))</span>

<span class="cm">/* #PROCHOT &amp; #VRDHOT PWM ramp control */</span>
<span class="cp">#define LM93_REG_PWM_RAMP_CTL		0xbf</span>

<span class="cm">/* miscellaneous */</span>
<span class="cp">#define LM93_REG_SFC1		0xbc</span>
<span class="cp">#define LM93_REG_SFC2		0xbd</span>
<span class="cp">#define LM93_REG_GPI_VID_CTL	0xbe</span>
<span class="cp">#define LM93_REG_SF_TACH_TO_PWM	0xe0</span>

<span class="cm">/* error masks */</span>
<span class="cp">#define LM93_REG_GPI_ERR_MASK	0xec</span>
<span class="cp">#define LM93_REG_MISC_ERR_MASK	0xed</span>

<span class="cm">/* LM93 REGISTER VALUES */</span>
<span class="cp">#define LM93_MFR_ID		0x73</span>
<span class="cp">#define LM93_MFR_ID_PROTOTYPE	0x72</span>

<span class="cm">/* LM94 REGISTER VALUES */</span>
<span class="cp">#define LM94_MFR_ID_2		0x7a</span>
<span class="cp">#define LM94_MFR_ID		0x79</span>
<span class="cp">#define LM94_MFR_ID_PROTOTYPE	0x78</span>

<span class="cm">/* SMBus capabilities */</span>
<span class="cp">#define LM93_SMBUS_FUNC_FULL (I2C_FUNC_SMBUS_BYTE_DATA | \</span>
<span class="cp">		I2C_FUNC_SMBUS_WORD_DATA | I2C_FUNC_SMBUS_BLOCK_DATA)</span>
<span class="cp">#define LM93_SMBUS_FUNC_MIN  (I2C_FUNC_SMBUS_BYTE_DATA | \</span>
<span class="cp">		I2C_FUNC_SMBUS_WORD_DATA)</span>

<span class="cm">/* Addresses to scan */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">normal_i2c</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="n">I2C_CLIENT_END</span> <span class="p">};</span>

<span class="cm">/* Insmod parameters */</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">disable_block</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">disable_block</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disable_block</span><span class="p">,</span>
	<span class="s">&quot;Set to non-zero to disable SMBus block data transactions.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">init</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="s">&quot;Set to non-zero to force chip initialization.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">vccp_limit_type</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">vccp_limit_type</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vccp_limit_type</span><span class="p">,</span> <span class="s">&quot;Configures in7 and in8 limit modes.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">vid_agtl</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">vid_agtl</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vid_agtl</span><span class="p">,</span> <span class="s">&quot;Configures VID pin input thresholds.&quot;</span><span class="p">);</span>

<span class="cm">/* Driver data */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">lm93_driver</span><span class="p">;</span>

<span class="cm">/* LM93 BLOCK READ COMMANDS */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">;</span> <span class="n">u8</span> <span class="n">len</span><span class="p">;</span> <span class="p">}</span> <span class="n">lm93_block_read_cmds</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0xf2</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xf3</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xf4</span><span class="p">,</span>  <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mi">16</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xf6</span><span class="p">,</span>  <span class="mi">4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xf7</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mi">12</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mi">32</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xfa</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xfb</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mi">16</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xfd</span><span class="p">,</span>  <span class="mi">9</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ALARMS: SYSCTL format described further below</span>
<span class="cm"> * REG: 64 bits in 8 registers, as immediately below</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">block1_t</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">host_status_1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">host_status_2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">host_status_3</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">host_status_4</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">p1_prochot_status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">p2_prochot_status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">gpi_status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fan_status</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Client-specific data</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">lm93_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">hwmon_dev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">update_lock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_updated</span><span class="p">;</span>	<span class="cm">/* In jiffies */</span>

	<span class="cm">/* client update function */</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">update</span><span class="p">)(</span><span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="p">);</span>

	<span class="kt">char</span> <span class="n">valid</span><span class="p">;</span> <span class="cm">/* !=0 if following fields are valid */</span>

	<span class="cm">/* register values, arranged by block read groups */</span>
	<span class="k">struct</span> <span class="n">block1_t</span> <span class="n">block1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * temp1 - temp4: unfiltered readings</span>
<span class="cm">	 * temp1 - temp2: filtered readings</span>
<span class="cm">	 */</span>
	<span class="n">u8</span> <span class="n">block2</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="cm">/* vin1 - vin16: readings */</span>
	<span class="n">u8</span> <span class="n">block3</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="cm">/* prochot1 - prochot2: readings */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">cur</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">avg</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">block4</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* fan counts 1-4 =&gt; 14-bits, LE, *left* justified */</span>
	<span class="n">u16</span> <span class="n">block5</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/* block6 has a lot of data we don&#39;t need */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">min</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">max</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">temp_lim</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/* vin1 - vin16: low and high limits */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">min</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">max</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">block7</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="cm">/* fan count limits 1-4 =&gt; same format as block5 */</span>
	<span class="n">u16</span> <span class="n">block8</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/* pwm control registers (2 pwms, 4 regs) */</span>
	<span class="n">u8</span> <span class="n">block9</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/* auto/pwm base temp and offset temp registers */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">base</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">offset</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">block10</span><span class="p">;</span>

	<span class="cm">/* master config register */</span>
	<span class="n">u8</span> <span class="n">config</span><span class="p">;</span>

	<span class="cm">/* VID1 &amp; VID2 =&gt; register format, 6-bits, right justified */</span>
	<span class="n">u8</span> <span class="n">vid</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* prochot1 - prochot2: limits */</span>
	<span class="n">u8</span> <span class="n">prochot_max</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* vccp1 &amp; vccp2 (in7 &amp; in8): VID relative limits (register format) */</span>
	<span class="n">u8</span> <span class="n">vccp_limits</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* GPIO input state (register format, i.e. inverted) */</span>
	<span class="n">u8</span> <span class="n">gpi</span><span class="p">;</span>

	<span class="cm">/* #PROCHOT override (register format) */</span>
	<span class="n">u8</span> <span class="n">prochot_override</span><span class="p">;</span>

	<span class="cm">/* #PROCHOT intervals (register format) */</span>
	<span class="n">u8</span> <span class="n">prochot_interval</span><span class="p">;</span>

	<span class="cm">/* Fan Boost Temperatures (register format) */</span>
	<span class="n">u8</span> <span class="n">boost</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/* Fan Boost Hysteresis (register format) */</span>
	<span class="n">u8</span> <span class="n">boost_hyst</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* Temperature Zone Min. PWM &amp; Hysteresis (register format) */</span>
	<span class="n">u8</span> <span class="n">auto_pwm_min_hyst</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* #PROCHOT &amp; #VRDHOT PWM Ramp Control */</span>
	<span class="n">u8</span> <span class="n">pwm_ramp_ctl</span><span class="p">;</span>

	<span class="cm">/* miscellaneous setup regs */</span>
	<span class="n">u8</span> <span class="n">sfc1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sfc2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sf_tach_to_pwm</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The two PWM CTL2  registers can read something other than what was</span>
<span class="cm">	 * last written for the OVR_DC field (duty cycle override).  So, we</span>
<span class="cm">	 * save the user-commanded value here.</span>
<span class="cm">	 */</span>
	<span class="n">u8</span> <span class="n">pwm_override</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * VID:	mV</span>
<span class="cm"> * REG: 6-bits, right justified, *always* using Intel VRM/VRD 10</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">LM93_VID_FROM_REG</span><span class="p">(</span><span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vid_from_reg</span><span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">),</span> <span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* min, max, and nominal register values, per channel (u8) */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">lm93_vin_reg_min</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">lm93_vin_reg_max</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span>
<span class="p">};</span>
<span class="cm">/*</span>
<span class="cm"> * Values from the datasheet. They&#39;re here for documentation only.</span>
<span class="cm"> * static const u8 lm93_vin_reg_nom[16] = {</span>
<span class="cm"> * 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0,</span>
<span class="cm"> * 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x40, 0xc0,</span>
<span class="cm"> * };</span>
<span class="cm"> */</span>

<span class="cm">/* min, max, and nominal voltage readings, per channel (mV)*/</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lm93_vin_val_min</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lm93_vin_val_max</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1236</span><span class="p">,</span> <span class="mi">1236</span><span class="p">,</span> <span class="mi">1236</span><span class="p">,</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">1600</span><span class="p">,</span>
	<span class="mi">4400</span><span class="p">,</span> <span class="mi">6500</span><span class="p">,</span> <span class="mi">3333</span><span class="p">,</span> <span class="mi">2625</span><span class="p">,</span> <span class="mi">1312</span><span class="p">,</span> <span class="mi">1312</span><span class="p">,</span> <span class="mi">1236</span><span class="p">,</span> <span class="mi">3600</span><span class="p">,</span>
<span class="p">};</span>
<span class="cm">/*</span>
<span class="cm"> * Values from the datasheet. They&#39;re here for documentation only.</span>
<span class="cm"> * static const unsigned long lm93_vin_val_nom[16] = {</span>
<span class="cm"> * 927,  927,  927, 1200, 1500, 1500, 1200, 1200,</span>
<span class="cm"> * 3300, 5000, 2500, 1969,  984,  984,  309, 3300,</span>
<span class="cm"> * };</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">LM93_IN_FROM_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">long</span> <span class="n">uV_max</span> <span class="o">=</span> <span class="n">lm93_vin_val_max</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">long</span> <span class="n">uV_min</span> <span class="o">=</span> <span class="n">lm93_vin_val_min</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">const</span> <span class="kt">long</span> <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">uV_max</span> <span class="o">-</span> <span class="n">uV_min</span><span class="p">)</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">lm93_vin_reg_max</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">-</span> <span class="n">lm93_vin_reg_min</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
	<span class="k">const</span> <span class="kt">long</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">uV_min</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">lm93_vin_reg_min</span><span class="p">[</span><span class="n">nr</span><span class="p">];</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">slope</span> <span class="o">*</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">intercept</span> <span class="o">+</span> <span class="mi">500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IN: mV, limits determined by channel nr</span>
<span class="cm"> * REG: scaling determined by channel nr</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">LM93_IN_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* range limit */</span>
	<span class="k">const</span> <span class="kt">long</span> <span class="n">mV</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span>
		<span class="n">lm93_vin_val_min</span><span class="p">[</span><span class="n">nr</span><span class="p">],</span> <span class="n">lm93_vin_val_max</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>

	<span class="cm">/* try not to lose too much precision here */</span>
	<span class="k">const</span> <span class="kt">long</span> <span class="n">uV</span> <span class="o">=</span> <span class="n">mV</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">long</span> <span class="n">uV_max</span> <span class="o">=</span> <span class="n">lm93_vin_val_max</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">long</span> <span class="n">uV_min</span> <span class="o">=</span> <span class="n">lm93_vin_val_min</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="cm">/* convert */</span>
	<span class="k">const</span> <span class="kt">long</span> <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">uV_max</span> <span class="o">-</span> <span class="n">uV_min</span><span class="p">)</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">lm93_vin_reg_max</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">-</span> <span class="n">lm93_vin_reg_min</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
	<span class="k">const</span> <span class="kt">long</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">uV_min</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">lm93_vin_reg_min</span><span class="p">[</span><span class="n">nr</span><span class="p">];</span>

	<span class="n">u8</span> <span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">uV</span> <span class="o">-</span> <span class="n">intercept</span> <span class="o">+</span> <span class="p">(</span><span class="n">slope</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">slope</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">result</span><span class="p">,</span>
			<span class="n">lm93_vin_reg_min</span><span class="p">[</span><span class="n">nr</span><span class="p">],</span> <span class="n">lm93_vin_reg_max</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* vid in mV, upper == 0 indicates low limit, otherwise upper limit */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">LM93_IN_REL_FROM_REG</span><span class="p">(</span><span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">upper</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">long</span> <span class="n">uV_offset</span> <span class="o">=</span> <span class="n">upper</span> <span class="o">?</span> <span class="p">(((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">12500</span><span class="p">)</span> <span class="o">:</span>
				<span class="p">(((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">25000</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">long</span> <span class="n">uV_vid</span> <span class="o">=</span> <span class="n">vid</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">uV_vid</span> <span class="o">+</span> <span class="n">uV_offset</span> <span class="o">+</span> <span class="mi">5000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define LM93_IN_MIN_FROM_REG(reg, vid)	LM93_IN_REL_FROM_REG((reg), 0, (vid))</span>
<span class="cp">#define LM93_IN_MAX_FROM_REG(reg, vid)	LM93_IN_REL_FROM_REG((reg), 1, (vid))</span>

<span class="cm">/*</span>
<span class="cm"> * vid in mV , upper == 0 indicates low limit, otherwise upper limit</span>
<span class="cm"> * upper also determines which nibble of the register is returned</span>
<span class="cm"> * (the other nibble will be 0x0)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">LM93_IN_REL_TO_REG</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">upper</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">uV_offset</span> <span class="o">=</span> <span class="n">vid</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">-</span> <span class="n">val</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">upper</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uV_offset</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">uV_offset</span><span class="p">,</span> <span class="mi">12500</span><span class="p">,</span> <span class="mi">200000</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">uV_offset</span> <span class="o">/</span>  <span class="mi">12500</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">uV_offset</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">uV_offset</span><span class="p">,</span> <span class="o">-</span><span class="mi">400000</span><span class="p">,</span> <span class="o">-</span><span class="mi">25000</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">uV_offset</span> <span class="o">/</span> <span class="o">-</span><span class="mi">25000</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TEMP: 1/1000 degrees C (-128C to +127C)</span>
<span class="cm"> * REG: 1C/bit, two&#39;s complement</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">LM93_TEMP_FROM_REG</span><span class="p">(</span><span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span><span class="n">reg</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define LM93_TEMP_MIN (-128000)</span>
<span class="cp">#define LM93_TEMP_MAX (127000)</span>

<span class="cm">/*</span>
<span class="cm"> * TEMP: 1/1000 degrees C (-128C to +127C)</span>
<span class="cm"> * REG: 1C/bit, two&#39;s complement</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">LM93_TEMP_TO_REG</span><span class="p">(</span><span class="kt">long</span> <span class="n">temp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ntemp</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">LM93_TEMP_MIN</span><span class="p">,</span> <span class="n">LM93_TEMP_MAX</span><span class="p">);</span>
	<span class="n">ntemp</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ntemp</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">500</span> <span class="o">:</span> <span class="mi">500</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">ntemp</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Determine 4-bit temperature offset resolution */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">LM93_TEMP_OFFSET_MODE_FROM_REG</span><span class="p">(</span><span class="n">u8</span> <span class="n">sfc2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* mode: 0 =&gt; 1C/bit, nonzero =&gt; 0.5C/bit */</span>
	<span class="k">return</span> <span class="n">sfc2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mh">0x20</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is common to all 4-bit temperature offsets</span>
<span class="cm"> * reg is 4 bits right justified</span>
<span class="cm"> * mode 0 =&gt; 1C/bit, mode !0 =&gt; 0.5C/bit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">LM93_TEMP_OFFSET_FROM_REG</span><span class="p">(</span><span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">mode</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define LM93_TEMP_OFFSET_MIN  (0)</span>
<span class="cp">#define LM93_TEMP_OFFSET_MAX0 (150)</span>
<span class="cp">#define LM93_TEMP_OFFSET_MAX1 (75)</span>

<span class="cm">/*</span>
<span class="cm"> * This function is common to all 4-bit temperature offsets</span>
<span class="cm"> * returns 4 bits right justified</span>
<span class="cm"> * mode 0 =&gt; 1C/bit, mode !0 =&gt; 0.5C/bit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">LM93_TEMP_OFFSET_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">factor</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">off</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">LM93_TEMP_OFFSET_MIN</span><span class="p">,</span>
		<span class="n">mode</span> <span class="o">?</span> <span class="n">LM93_TEMP_OFFSET_MAX1</span> <span class="o">:</span> <span class="n">LM93_TEMP_OFFSET_MAX0</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">off</span> <span class="o">+</span> <span class="n">factor</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">factor</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* 0 &lt;= nr &lt;= 3 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">LM93_TEMP_AUTO_OFFSET_FROM_REG</span><span class="p">(</span><span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* temp1-temp2 (nr=0,1) use lower nibble */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">LM93_TEMP_OFFSET_FROM_REG</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="cm">/* temp3-temp4 (nr=2,3) use upper nibble */</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">LM93_TEMP_OFFSET_FROM_REG</span><span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TEMP: 1/10 degrees C (0C to +15C (mode 0) or +7.5C (mode non-zero))</span>
<span class="cm"> * REG: 1.0C/bit (mode 0) or 0.5C/bit (mode non-zero)</span>
<span class="cm"> * 0 &lt;= nr &lt;= 3</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">LM93_TEMP_AUTO_OFFSET_TO_REG</span><span class="p">(</span><span class="n">u8</span> <span class="n">old</span><span class="p">,</span> <span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">new</span> <span class="o">=</span> <span class="n">LM93_TEMP_OFFSET_TO_REG</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="cm">/* temp1-temp2 (nr=0,1) use lower nibble */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">new</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>

	<span class="cm">/* temp3-temp4 (nr=2,3) use upper nibble */</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">new</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">LM93_AUTO_BOOST_HYST_FROM_REGS</span><span class="p">(</span><span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">boost_hyst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">boost_hyst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">boost_hyst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
	<span class="nl">default:</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">boost_hyst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">LM93_TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">boost</span><span class="p">[</span><span class="n">nr</span><span class="p">])</span> <span class="o">-</span>
			<span class="n">LM93_TEMP_OFFSET_FROM_REG</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">LM93_AUTO_BOOST_HYST_TO_REG</span><span class="p">(</span><span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">long</span> <span class="n">hyst</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">LM93_TEMP_OFFSET_TO_REG</span><span class="p">(</span>
			<span class="p">(</span><span class="n">LM93_TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">boost</span><span class="p">[</span><span class="n">nr</span><span class="p">])</span> <span class="o">-</span> <span class="n">hyst</span><span class="p">),</span> <span class="n">mode</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">boost_hyst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">boost_hyst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">boost_hyst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
	<span class="nl">default:</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">boost_hyst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PWM: 0-255 per sensors documentation</span>
<span class="cm"> * REG: 0-13 as mapped below... right justified</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">pwm_freq</span> <span class="p">{</span> <span class="n">LM93_PWM_MAP_HI_FREQ</span><span class="p">,</span> <span class="n">LM93_PWM_MAP_LO_FREQ</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">lm93_pwm_map</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/*   0.00% */</span> <span class="mh">0x40</span><span class="p">,</span> <span class="cm">/*  25.00% */</span>
		<span class="mh">0x50</span><span class="p">,</span> <span class="cm">/*  31.25% */</span> <span class="mh">0x60</span><span class="p">,</span> <span class="cm">/*  37.50% */</span>
		<span class="mh">0x70</span><span class="p">,</span> <span class="cm">/*  43.75% */</span> <span class="mh">0x80</span><span class="p">,</span> <span class="cm">/*  50.00% */</span>
		<span class="mh">0x90</span><span class="p">,</span> <span class="cm">/*  56.25% */</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="cm">/*  62.50% */</span>
		<span class="mh">0xb0</span><span class="p">,</span> <span class="cm">/*  68.75% */</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="cm">/*  75.00% */</span>
		<span class="mh">0xd0</span><span class="p">,</span> <span class="cm">/*  81.25% */</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="cm">/*  87.50% */</span>
		<span class="mh">0xf0</span><span class="p">,</span> <span class="cm">/*  93.75% */</span> <span class="mh">0xff</span><span class="p">,</span> <span class="cm">/* 100.00% */</span>
		<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="cm">/* 14, 15 are reserved and should never occur */</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="cm">/*   0.00% */</span> <span class="mh">0x40</span><span class="p">,</span> <span class="cm">/*  25.00% */</span>
		<span class="mh">0x49</span><span class="p">,</span> <span class="cm">/*  28.57% */</span> <span class="mh">0x52</span><span class="p">,</span> <span class="cm">/*  32.14% */</span>
		<span class="mh">0x5b</span><span class="p">,</span> <span class="cm">/*  35.71% */</span> <span class="mh">0x64</span><span class="p">,</span> <span class="cm">/*  39.29% */</span>
		<span class="mh">0x6d</span><span class="p">,</span> <span class="cm">/*  42.86% */</span> <span class="mh">0x76</span><span class="p">,</span> <span class="cm">/*  46.43% */</span>
		<span class="mh">0x80</span><span class="p">,</span> <span class="cm">/*  50.00% */</span> <span class="mh">0x89</span><span class="p">,</span> <span class="cm">/*  53.57% */</span>
		<span class="mh">0x92</span><span class="p">,</span> <span class="cm">/*  57.14% */</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="cm">/*  71.43% */</span>
		<span class="mh">0xdb</span><span class="p">,</span> <span class="cm">/*  85.71% */</span> <span class="mh">0xff</span><span class="p">,</span> <span class="cm">/* 100.00% */</span>
		<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="cm">/* 14, 15 are reserved and should never occur */</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">LM93_PWM_FROM_REG</span><span class="p">(</span><span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pwm_freq</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">lm93_pwm_map</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* round up to nearest match */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">LM93_PWM_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">pwm</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pwm_freq</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pwm</span> <span class="o">&lt;=</span> <span class="n">lm93_pwm_map</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* can fall through with i==13 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">LM93_FAN_FROM_REG</span><span class="p">(</span><span class="n">u16</span> <span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="n">count</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">count</span> <span class="o">==</span> <span class="mh">0x3fff</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1350000</span> <span class="o">/</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * RPM: (82.5 to 1350000)</span>
<span class="cm"> * REG: 14-bits, LE, *left* justified</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">LM93_FAN_TO_REG</span><span class="p">(</span><span class="kt">long</span> <span class="n">rpm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">count</span><span class="p">,</span> <span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mh">0x3fff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rpm</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">rpm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">((</span><span class="mi">1350000</span> <span class="o">+</span> <span class="n">rpm</span><span class="p">)</span> <span class="o">/</span> <span class="n">rpm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x3ffe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PWM FREQ: HZ</span>
<span class="cm"> * REG: 0-7 as mapped below</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lm93_pwm_freq_map</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">22500</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">12</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">LM93_PWM_FREQ_FROM_REG</span><span class="p">(</span><span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">lm93_pwm_freq_map</span><span class="p">[</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* round up to nearest match */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">LM93_PWM_FREQ_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;=</span> <span class="n">lm93_pwm_freq_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* can fall through with i==0 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TIME: 1/100 seconds</span>
<span class="cm"> * REG: 0-7 as mapped below</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lm93_spinup_time_map</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">LM93_SPINUP_TIME_FROM_REG</span><span class="p">(</span><span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">lm93_spinup_time_map</span><span class="p">[</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* round up to nearest match */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">LM93_SPINUP_TIME_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">&lt;=</span> <span class="n">lm93_spinup_time_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* can fall through with i==8 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define LM93_RAMP_MIN 0</span>
<span class="cp">#define LM93_RAMP_MAX 75</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">LM93_RAMP_FROM_REG</span><span class="p">(</span><span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * RAMP: 1/100 seconds</span>
<span class="cm"> * REG: 50mS/bit 4-bits right justified</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">LM93_RAMP_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">ramp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ramp</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">ramp</span><span class="p">,</span> <span class="n">LM93_RAMP_MIN</span><span class="p">,</span> <span class="n">LM93_RAMP_MAX</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">ramp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PROCHOT: 0-255, 0 =&gt; 0%, 255 =&gt; &gt; 96.6%</span>
<span class="cm"> * REG: (same)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">LM93_PROCHOT_TO_REG</span><span class="p">(</span><span class="kt">long</span> <span class="n">prochot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">prochot</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">prochot</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">prochot</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PROCHOT-INTERVAL: 73 - 37200 (1/100 seconds)</span>
<span class="cm"> * REG: 0-9 as mapped below</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lm93_interval_map</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">73</span><span class="p">,</span> <span class="mi">146</span><span class="p">,</span> <span class="mi">290</span><span class="p">,</span> <span class="mi">580</span><span class="p">,</span> <span class="mi">1170</span><span class="p">,</span> <span class="mi">2330</span><span class="p">,</span> <span class="mi">4660</span><span class="p">,</span> <span class="mi">9320</span><span class="p">,</span> <span class="mi">18600</span><span class="p">,</span> <span class="mi">37200</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">LM93_INTERVAL_FROM_REG</span><span class="p">(</span><span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">lm93_interval_map</span><span class="p">[</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* round up to nearest match */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">LM93_INTERVAL_TO_REG</span><span class="p">(</span><span class="kt">long</span> <span class="n">interval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">interval</span> <span class="o">&lt;=</span> <span class="n">lm93_interval_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* can fall through with i==9 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * GPIO: 0-255, GPIO0 is LSB</span>
<span class="cm"> * REG: inverted</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">LM93_GPI_FROM_REG</span><span class="p">(</span><span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">~</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * alarm bitmask definitions</span>
<span class="cm"> * The LM93 has nearly 64 bits of error status... I&#39;ve pared that down to</span>
<span class="cm"> * what I think is a useful subset in order to fit it into 32 bits.</span>
<span class="cm"> *</span>
<span class="cm"> * Especially note that the #VRD_HOT alarms are missing because we provide</span>
<span class="cm"> * that information as values in another sysfs file.</span>
<span class="cm"> *</span>
<span class="cm"> * If libsensors is extended to support 64 bit values, this could be revisited.</span>
<span class="cm"> */</span>
<span class="cp">#define LM93_ALARM_IN1		0x00000001</span>
<span class="cp">#define LM93_ALARM_IN2		0x00000002</span>
<span class="cp">#define LM93_ALARM_IN3		0x00000004</span>
<span class="cp">#define LM93_ALARM_IN4		0x00000008</span>
<span class="cp">#define LM93_ALARM_IN5		0x00000010</span>
<span class="cp">#define LM93_ALARM_IN6		0x00000020</span>
<span class="cp">#define LM93_ALARM_IN7		0x00000040</span>
<span class="cp">#define LM93_ALARM_IN8		0x00000080</span>
<span class="cp">#define LM93_ALARM_IN9		0x00000100</span>
<span class="cp">#define LM93_ALARM_IN10		0x00000200</span>
<span class="cp">#define LM93_ALARM_IN11		0x00000400</span>
<span class="cp">#define LM93_ALARM_IN12		0x00000800</span>
<span class="cp">#define LM93_ALARM_IN13		0x00001000</span>
<span class="cp">#define LM93_ALARM_IN14		0x00002000</span>
<span class="cp">#define LM93_ALARM_IN15		0x00004000</span>
<span class="cp">#define LM93_ALARM_IN16		0x00008000</span>
<span class="cp">#define LM93_ALARM_FAN1		0x00010000</span>
<span class="cp">#define LM93_ALARM_FAN2		0x00020000</span>
<span class="cp">#define LM93_ALARM_FAN3		0x00040000</span>
<span class="cp">#define LM93_ALARM_FAN4		0x00080000</span>
<span class="cp">#define LM93_ALARM_PH1_ERR	0x00100000</span>
<span class="cp">#define LM93_ALARM_PH2_ERR	0x00200000</span>
<span class="cp">#define LM93_ALARM_SCSI1_ERR	0x00400000</span>
<span class="cp">#define LM93_ALARM_SCSI2_ERR	0x00800000</span>
<span class="cp">#define LM93_ALARM_DVDDP1_ERR	0x01000000</span>
<span class="cp">#define LM93_ALARM_DVDDP2_ERR	0x02000000</span>
<span class="cp">#define LM93_ALARM_D1_ERR	0x04000000</span>
<span class="cp">#define LM93_ALARM_D2_ERR	0x08000000</span>
<span class="cp">#define LM93_ALARM_TEMP1	0x10000000</span>
<span class="cp">#define LM93_ALARM_TEMP2	0x20000000</span>
<span class="cp">#define LM93_ALARM_TEMP3	0x40000000</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">LM93_ALARMS_FROM_REG</span><span class="p">(</span><span class="k">struct</span> <span class="n">block1_t</span> <span class="n">b1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">result</span>  <span class="o">=</span> <span class="n">b1</span><span class="p">.</span><span class="n">host_status_2</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vccp_limit_type</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">b1</span><span class="p">.</span><span class="n">host_status_4</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">b1</span><span class="p">.</span><span class="n">host_status_2</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vccp_limit_type</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">b1</span><span class="p">.</span><span class="n">host_status_4</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">b1</span><span class="p">.</span><span class="n">host_status_2</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">|=</span> <span class="n">b1</span><span class="p">.</span><span class="n">host_status_3</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">b1</span><span class="p">.</span><span class="n">fan_status</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">b1</span><span class="p">.</span><span class="n">p1_prochot_status</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">b1</span><span class="p">.</span><span class="n">p2_prochot_status</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">b1</span><span class="p">.</span><span class="n">host_status_4</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">b1</span><span class="p">.</span><span class="n">host_status_1</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MAX_RETRIES 5</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">lm93_read_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* retry in case of read errors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">MAX_RETRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;lm93: read byte data failed, &quot;</span>
				<span class="s">&quot;address 0x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="cm">/* &lt;TODO&gt; what to return in case of error? */</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;lm93: All read byte retries failed!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lm93_write_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="cm">/* &lt;TODO&gt; how to handle write errors? */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;lm93: write byte data failed, &quot;</span>
			 <span class="s">&quot;0x%02x at address 0x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">lm93_read_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* retry in case of read errors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">MAX_RETRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">i2c_smbus_read_word_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;lm93: read word data failed, &quot;</span>
				 <span class="s">&quot;address 0x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="cm">/* &lt;TODO&gt; what to return in case of error? */</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;lm93: All read word retries failed!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lm93_write_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="cm">/* &lt;TODO&gt; how to handle write errors? */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i2c_smbus_write_word_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;lm93: write word data failed, &quot;</span>
			 <span class="s">&quot;0x%04x at address 0x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">lm93_block_buffer</span><span class="p">[</span><span class="n">I2C_SMBUS_BLOCK_MAX</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * read block data into values, retry if not expected length</span>
<span class="cm"> * fbn =&gt; index to lm93_block_read_cmds table</span>
<span class="cm"> * (Fixed Block Number - section 14.5.2 of LM93 datasheet)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lm93_read_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">fbn</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">values</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">MAX_RETRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">i2c_smbus_read_block_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
			<span class="n">lm93_block_read_cmds</span><span class="p">[</span><span class="n">fbn</span><span class="p">].</span><span class="n">cmd</span><span class="p">,</span> <span class="n">lm93_block_buffer</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">lm93_block_read_cmds</span><span class="p">[</span><span class="n">fbn</span><span class="p">].</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;lm93: block read data failed, &quot;</span>
				 <span class="s">&quot;command 0x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">lm93_block_read_cmds</span><span class="p">[</span><span class="n">fbn</span><span class="p">].</span><span class="n">cmd</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">lm93_block_read_cmds</span><span class="p">[</span><span class="n">fbn</span><span class="p">].</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">lm93_block_buffer</span><span class="p">,</span>
		       <span class="n">lm93_block_read_cmds</span><span class="p">[</span><span class="n">fbn</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* &lt;TODO&gt; what to do in case of error? */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="nf">lm93_update_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">interval</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">last_updated</span> <span class="o">+</span> <span class="n">interval</span><span class="p">)</span> <span class="o">||</span>
		<span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">last_updated</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* update routine for data that has no corresponding SMBus block command */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lm93_update_client_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="cm">/* temp1 - temp4: limits */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_lim</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">min</span> <span class="o">=</span>
			<span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_TEMP_MIN</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_lim</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max</span> <span class="o">=</span>
			<span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_TEMP_MAX</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* config register */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_CONFIG</span><span class="p">);</span>

	<span class="cm">/* vid1 - vid2: values */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_VID</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

	<span class="cm">/* prochot1 - prochot2: limits */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">prochot_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
				<span class="n">LM93_REG_PROCHOT_MAX</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

	<span class="cm">/* vccp1 - vccp2: VID relative limits */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">vccp_limits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
				<span class="n">LM93_REG_VCCP_LIMIT_OFF</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

	<span class="cm">/* GPIO input state */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">gpi</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_GPI</span><span class="p">);</span>

	<span class="cm">/* #PROCHOT override state */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">prochot_override</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
			<span class="n">LM93_REG_PROCHOT_OVERRIDE</span><span class="p">);</span>

	<span class="cm">/* #PROCHOT intervals */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">prochot_interval</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
			<span class="n">LM93_REG_PROCHOT_INTERVAL</span><span class="p">);</span>

	<span class="cm">/* Fan Boost Temperature registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">boost</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_BOOST</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

	<span class="cm">/* Fan Boost Temperature Hyst. registers */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">boost_hyst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_BOOST_HYST_12</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">boost_hyst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_BOOST_HYST_34</span><span class="p">);</span>

	<span class="cm">/* Temperature Zone Min. PWM &amp; Hysteresis registers */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">auto_pwm_min_hyst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_MIN_HYST_12</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">auto_pwm_min_hyst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_MIN_HYST_34</span><span class="p">);</span>

	<span class="cm">/* #PROCHOT &amp; #VRDHOT PWM Ramp Control register */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_ramp_ctl</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_RAMP_CTL</span><span class="p">);</span>

	<span class="cm">/* misc setup registers */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc1</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_SFC1</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_SFC2</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sf_tach_to_pwm</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
			<span class="n">LM93_REG_SF_TACH_TO_PWM</span><span class="p">);</span>

	<span class="cm">/* write back alarm values to clear */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block1</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_HOST_ERROR_1</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* update routine which uses SMBus block data commands */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lm93_update_client_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;starting device update (block data enabled)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* in1 - in16: values &amp; limits */</span>
	<span class="n">lm93_read_block</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block3</span><span class="p">));</span>
	<span class="n">lm93_read_block</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block7</span><span class="p">));</span>

	<span class="cm">/* temp1 - temp4: values */</span>
	<span class="n">lm93_read_block</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block2</span><span class="p">));</span>

	<span class="cm">/* prochot1 - prochot2: values */</span>
	<span class="n">lm93_read_block</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block4</span><span class="p">));</span>

	<span class="cm">/* fan1 - fan4: values &amp; limits */</span>
	<span class="n">lm93_read_block</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block5</span><span class="p">));</span>
	<span class="n">lm93_read_block</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block8</span><span class="p">));</span>

	<span class="cm">/* pmw control registers */</span>
	<span class="n">lm93_read_block</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block9</span><span class="p">));</span>

	<span class="cm">/* alarm values */</span>
	<span class="n">lm93_read_block</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block1</span><span class="p">));</span>

	<span class="cm">/* auto/pwm registers */</span>
	<span class="n">lm93_read_block</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block10</span><span class="p">));</span>

	<span class="n">lm93_update_client_common</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* update routine which uses SMBus byte/word data commands only */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lm93_update_client_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;starting device update (block data disabled)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* in1 - in16: values &amp; limits */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">block3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_IN</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">block7</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">min</span> <span class="o">=</span>
			<span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_IN_MIN</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">block7</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max</span> <span class="o">=</span>
			<span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_IN_MAX</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* temp1 - temp4: values */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">block2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_TEMP</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* prochot1 - prochot2: values */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">block4</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cur</span> <span class="o">=</span>
			<span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PROCHOT_CUR</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">block4</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">avg</span> <span class="o">=</span>
			<span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PROCHOT_AVG</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* fan1 - fan4: values &amp; limits */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">block5</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">lm93_read_word</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_FAN</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">block8</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">lm93_read_word</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_FAN_MIN</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* pwm control registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">block9</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_CTL</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* alarm values */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block1</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span>
			<span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_HOST_ERROR_1</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* auto/pwm (base temp) registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">block10</span><span class="p">.</span><span class="n">base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_TEMP_BASE</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* auto/pwm (offset temp) registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">block10</span><span class="p">.</span><span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_TEMP_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">lm93_update_client_common</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* following are the sysfs callback functions */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LM93_IN_FROM_REG</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">block3</span><span class="p">[</span><span class="n">nr</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in1_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_in</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in2_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_in</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in3_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_in</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in4_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_in</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in5_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_in</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in6_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_in</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in7_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_in</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in8_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_in</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in9_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_in</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in10_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_in</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in11_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_in</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in12_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_in</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in13_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_in</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in14_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_in</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in15_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_in</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in16_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_in</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_in_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">vccp</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">-</span> <span class="mi">6</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">rc</span><span class="p">,</span> <span class="n">vid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">||</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">vccp_limit_type</span><span class="p">[</span><span class="n">vccp</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">vid</span> <span class="o">=</span> <span class="n">LM93_VID_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">[</span><span class="n">vccp</span><span class="p">]);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">LM93_IN_MIN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vccp_limits</span><span class="p">[</span><span class="n">vccp</span><span class="p">],</span> <span class="n">vid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">LM93_IN_FROM_REG</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">block7</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">min</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_in_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">vccp</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">-</span> <span class="mi">6</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">vid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">||</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">vccp_limit_type</span><span class="p">[</span><span class="n">vccp</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">vid</span> <span class="o">=</span> <span class="n">LM93_VID_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">[</span><span class="n">vccp</span><span class="p">]);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">vccp_limits</span><span class="p">[</span><span class="n">vccp</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vccp_limits</span><span class="p">[</span><span class="n">vccp</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">LM93_IN_REL_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
		<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_VCCP_LIMIT_OFF</span><span class="p">(</span><span class="n">vccp</span><span class="p">),</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">vccp_limits</span><span class="p">[</span><span class="n">vccp</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">block7</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">min</span> <span class="o">=</span> <span class="n">LM93_IN_TO_REG</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_IN_MIN</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">block7</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">min</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in1_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_min</span><span class="p">,</span> <span class="n">store_in_min</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in2_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_min</span><span class="p">,</span> <span class="n">store_in_min</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in3_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_min</span><span class="p">,</span> <span class="n">store_in_min</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in4_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_min</span><span class="p">,</span> <span class="n">store_in_min</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in5_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_min</span><span class="p">,</span> <span class="n">store_in_min</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in6_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_min</span><span class="p">,</span> <span class="n">store_in_min</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in7_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_min</span><span class="p">,</span> <span class="n">store_in_min</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in8_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_min</span><span class="p">,</span> <span class="n">store_in_min</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in9_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_min</span><span class="p">,</span> <span class="n">store_in_min</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in10_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_min</span><span class="p">,</span> <span class="n">store_in_min</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in11_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_min</span><span class="p">,</span> <span class="n">store_in_min</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in12_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_min</span><span class="p">,</span> <span class="n">store_in_min</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in13_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_min</span><span class="p">,</span> <span class="n">store_in_min</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in14_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_min</span><span class="p">,</span> <span class="n">store_in_min</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in15_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_min</span><span class="p">,</span> <span class="n">store_in_min</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in16_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_min</span><span class="p">,</span> <span class="n">store_in_min</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_in_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">vccp</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">-</span> <span class="mi">6</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">rc</span><span class="p">,</span> <span class="n">vid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">||</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">vccp_limit_type</span><span class="p">[</span><span class="n">vccp</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">vid</span> <span class="o">=</span> <span class="n">LM93_VID_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">[</span><span class="n">vccp</span><span class="p">]);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">LM93_IN_MAX_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vccp_limits</span><span class="p">[</span><span class="n">vccp</span><span class="p">],</span> <span class="n">vid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">LM93_IN_FROM_REG</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">block7</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">max</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_in_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">vccp</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">-</span> <span class="mi">6</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">vid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">||</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">vccp_limit_type</span><span class="p">[</span><span class="n">vccp</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">vid</span> <span class="o">=</span> <span class="n">LM93_VID_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">[</span><span class="n">vccp</span><span class="p">]);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">vccp_limits</span><span class="p">[</span><span class="n">vccp</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vccp_limits</span><span class="p">[</span><span class="n">vccp</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">LM93_IN_REL_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
		<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_VCCP_LIMIT_OFF</span><span class="p">(</span><span class="n">vccp</span><span class="p">),</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">vccp_limits</span><span class="p">[</span><span class="n">vccp</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">block7</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">max</span> <span class="o">=</span> <span class="n">LM93_IN_TO_REG</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_IN_MAX</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">block7</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">max</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in1_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_max</span><span class="p">,</span> <span class="n">store_in_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in2_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_max</span><span class="p">,</span> <span class="n">store_in_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in3_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_max</span><span class="p">,</span> <span class="n">store_in_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in4_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_max</span><span class="p">,</span> <span class="n">store_in_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in5_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_max</span><span class="p">,</span> <span class="n">store_in_max</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in6_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_max</span><span class="p">,</span> <span class="n">store_in_max</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in7_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_max</span><span class="p">,</span> <span class="n">store_in_max</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in8_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_max</span><span class="p">,</span> <span class="n">store_in_max</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in9_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_max</span><span class="p">,</span> <span class="n">store_in_max</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in10_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_max</span><span class="p">,</span> <span class="n">store_in_max</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in11_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_max</span><span class="p">,</span> <span class="n">store_in_max</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in12_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_max</span><span class="p">,</span> <span class="n">store_in_max</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in13_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_max</span><span class="p">,</span> <span class="n">store_in_max</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in14_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_max</span><span class="p">,</span> <span class="n">store_in_max</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in15_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_max</span><span class="p">,</span> <span class="n">store_in_max</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in16_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_in_max</span><span class="p">,</span> <span class="n">store_in_max</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LM93_TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block2</span><span class="p">[</span><span class="n">nr</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LM93_TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_lim</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">min</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_temp_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_lim</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">min</span> <span class="o">=</span> <span class="n">LM93_TEMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_TEMP_MIN</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_lim</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">min</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_min</span><span class="p">,</span> <span class="n">store_temp_min</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_min</span><span class="p">,</span> <span class="n">store_temp_min</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_min</span><span class="p">,</span> <span class="n">store_temp_min</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LM93_TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_lim</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">max</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_temp_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_lim</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">max</span> <span class="o">=</span> <span class="n">LM93_TEMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_TEMP_MAX</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_lim</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">max</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_max</span><span class="p">,</span> <span class="n">store_temp_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_max</span><span class="p">,</span> <span class="n">store_temp_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_max</span><span class="p">,</span> <span class="n">store_temp_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp_auto_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LM93_TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block10</span><span class="p">.</span><span class="n">base</span><span class="p">[</span><span class="n">nr</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_temp_auto_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">block10</span><span class="p">.</span><span class="n">base</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">LM93_TEMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_TEMP_BASE</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">block10</span><span class="p">.</span><span class="n">base</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_auto_base</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_base</span><span class="p">,</span> <span class="n">store_temp_auto_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_auto_base</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_base</span><span class="p">,</span> <span class="n">store_temp_auto_base</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_auto_base</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_base</span><span class="p">,</span> <span class="n">store_temp_auto_base</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp_auto_boost</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LM93_TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">boost</span><span class="p">[</span><span class="n">nr</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_temp_auto_boost</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">boost</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">LM93_TEMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_BOOST</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">boost</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_auto_boost</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_boost</span><span class="p">,</span> <span class="n">store_temp_auto_boost</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_auto_boost</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_boost</span><span class="p">,</span> <span class="n">store_temp_auto_boost</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_auto_boost</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_boost</span><span class="p">,</span> <span class="n">store_temp_auto_boost</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp_auto_boost_hyst</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">LM93_TEMP_OFFSET_MODE_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">LM93_AUTO_BOOST_HYST_FROM_REGS</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">mode</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_temp_auto_boost_hyst</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="cm">/* force 0.5C/bit mode */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_SFC2</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span> <span class="o">|=</span> <span class="p">((</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_SFC2</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">boost_hyst</span><span class="p">[</span><span class="n">nr</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LM93_AUTO_BOOST_HYST_TO_REG</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_BOOST_HYST</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">boost_hyst</span><span class="p">[</span><span class="n">nr</span><span class="o">/</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_auto_boost_hyst</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_boost_hyst</span><span class="p">,</span>
			  <span class="n">store_temp_auto_boost_hyst</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_auto_boost_hyst</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_boost_hyst</span><span class="p">,</span>
			  <span class="n">store_temp_auto_boost_hyst</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_auto_boost_hyst</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_boost_hyst</span><span class="p">,</span>
			  <span class="n">store_temp_auto_boost_hyst</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp_auto_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">s_attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">s_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ofs</span> <span class="o">=</span> <span class="n">s_attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">LM93_TEMP_OFFSET_MODE_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">LM93_TEMP_AUTO_OFFSET_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block10</span><span class="p">.</span><span class="n">offset</span><span class="p">[</span><span class="n">ofs</span><span class="p">],</span>
					      <span class="n">nr</span><span class="p">,</span> <span class="n">mode</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_temp_auto_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">s_attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">s_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ofs</span> <span class="o">=</span> <span class="n">s_attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="cm">/* force 0.5C/bit mode */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_SFC2</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span> <span class="o">|=</span> <span class="p">((</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_SFC2</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">block10</span><span class="p">.</span><span class="n">offset</span><span class="p">[</span><span class="n">ofs</span><span class="p">]</span> <span class="o">=</span> <span class="n">LM93_TEMP_AUTO_OFFSET_TO_REG</span><span class="p">(</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">block10</span><span class="p">.</span><span class="n">offset</span><span class="p">[</span><span class="n">ofs</span><span class="p">],</span> <span class="n">val</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_TEMP_OFFSET</span><span class="p">(</span><span class="n">ofs</span><span class="p">),</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">block10</span><span class="p">.</span><span class="n">offset</span><span class="p">[</span><span class="n">ofs</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp1_auto_offset1</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp1_auto_offset2</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp1_auto_offset3</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp1_auto_offset4</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp1_auto_offset5</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp1_auto_offset6</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp1_auto_offset7</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp1_auto_offset8</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp1_auto_offset9</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp1_auto_offset10</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp1_auto_offset11</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp1_auto_offset12</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp2_auto_offset1</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp2_auto_offset2</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp2_auto_offset3</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp2_auto_offset4</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp2_auto_offset5</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp2_auto_offset6</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp2_auto_offset7</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp2_auto_offset8</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp2_auto_offset9</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp2_auto_offset10</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp2_auto_offset11</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp2_auto_offset12</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp3_auto_offset1</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp3_auto_offset2</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp3_auto_offset3</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp3_auto_offset4</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp3_auto_offset5</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp3_auto_offset6</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp3_auto_offset7</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp3_auto_offset8</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp3_auto_offset9</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp3_auto_offset10</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp3_auto_offset11</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp3_auto_offset12</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset</span><span class="p">,</span> <span class="n">store_temp_auto_offset</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp_auto_pwm_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ctl4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">auto_pwm_min_hyst</span><span class="p">[</span><span class="n">nr</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">ctl4</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">block9</span><span class="p">[</span><span class="n">nr</span><span class="p">][</span><span class="n">LM93_PWM_CTL4</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LM93_PWM_FROM_REG</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">ctl4</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">LM93_PWM_MAP_LO_FREQ</span> <span class="o">:</span> <span class="n">LM93_PWM_MAP_HI_FREQ</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_temp_auto_pwm_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ctl4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_MIN_HYST</span><span class="p">(</span><span class="n">nr</span><span class="p">));</span>
	<span class="n">ctl4</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_CTL</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">LM93_PWM_CTL4</span><span class="p">));</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">LM93_PWM_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">ctl4</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">LM93_PWM_MAP_LO_FREQ</span> <span class="o">:</span>
				<span class="n">LM93_PWM_MAP_HI_FREQ</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">auto_pwm_min_hyst</span><span class="p">[</span><span class="n">nr</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_MIN_HYST</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_auto_pwm_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_pwm_min</span><span class="p">,</span>
			  <span class="n">store_temp_auto_pwm_min</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_auto_pwm_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_pwm_min</span><span class="p">,</span>
			  <span class="n">store_temp_auto_pwm_min</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_auto_pwm_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_pwm_min</span><span class="p">,</span>
			  <span class="n">store_temp_auto_pwm_min</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp_auto_offset_hyst</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">LM93_TEMP_OFFSET_MODE_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LM93_TEMP_OFFSET_FROM_REG</span><span class="p">(</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">auto_pwm_min_hyst</span><span class="p">[</span><span class="n">nr</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="n">mode</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_temp_auto_offset_hyst</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="cm">/* force 0.5C/bit mode */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_SFC2</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span> <span class="o">|=</span> <span class="p">((</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_SFC2</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">auto_pwm_min_hyst</span><span class="p">[</span><span class="n">nr</span><span class="o">/</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">LM93_TEMP_OFFSET_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">auto_pwm_min_hyst</span><span class="p">[</span><span class="n">nr</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_MIN_HYST</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_auto_offset_hyst</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset_hyst</span><span class="p">,</span>
			  <span class="n">store_temp_auto_offset_hyst</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_auto_offset_hyst</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset_hyst</span><span class="p">,</span>
			  <span class="n">store_temp_auto_offset_hyst</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_auto_offset_hyst</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_temp_auto_offset_hyst</span><span class="p">,</span>
			  <span class="n">store_temp_auto_offset_hyst</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_fan_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="o">*</span><span class="n">s_attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">s_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LM93_FAN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block5</span><span class="p">[</span><span class="n">nr</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan1_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_fan_input</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan2_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_fan_input</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan3_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_fan_input</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan4_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_fan_input</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_fan_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LM93_FAN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block8</span><span class="p">[</span><span class="n">nr</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_fan_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">block8</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">LM93_FAN_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">lm93_write_word</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_FAN_MIN</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">block8</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan1_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_fan_min</span><span class="p">,</span> <span class="n">store_fan_min</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan2_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_fan_min</span><span class="p">,</span> <span class="n">store_fan_min</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan3_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_fan_min</span><span class="p">,</span> <span class="n">store_fan_min</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan4_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_fan_min</span><span class="p">,</span> <span class="n">store_fan_min</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * some tedious bit-twiddling here to deal with the register format:</span>
<span class="cm"> *</span>
<span class="cm"> *	data-&gt;sf_tach_to_pwm: (tach to pwm mapping bits)</span>
<span class="cm"> *</span>
<span class="cm"> *		bit |  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0</span>
<span class="cm"> *		     T4:P2 T4:P1 T3:P2 T3:P1 T2:P2 T2:P1 T1:P2 T1:P1</span>
<span class="cm"> *</span>
<span class="cm"> *	data-&gt;sfc2: (enable bits)</span>
<span class="cm"> *</span>
<span class="cm"> *		bit |  3  |  2  |  1  |  0</span>
<span class="cm"> *		       T4    T3    T2    T1</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_fan_smart_tach</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mapping</span><span class="p">;</span>

	<span class="cm">/* extract the relevant mapping */</span>
	<span class="n">mapping</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sf_tach_to_pwm</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">nr</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>

	<span class="cm">/* if there&#39;s a mapping and it&#39;s enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mapping</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span> <span class="o">&gt;&gt;</span> <span class="n">nr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * helper function - must grab data-&gt;update_lock before calling</span>
<span class="cm"> * fan is 0-3, indicating fan1-fan4</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lm93_write_fan_smart_tach</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fan</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* insert the new mapping and write it out */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sf_tach_to_pwm</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_SF_TACH_TO_PWM</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sf_tach_to_pwm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="n">fan</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sf_tach_to_pwm</span> <span class="o">|=</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">fan</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_SF_TACH_TO_PWM</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sf_tach_to_pwm</span><span class="p">);</span>

	<span class="cm">/* insert the enable bit and write it out */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_SFC2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fan</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fan</span><span class="p">);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_SFC2</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_fan_smart_tach</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="cm">/* sanity test, ignore the write otherwise */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">val</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* can&#39;t enable if pwm freq is 22.5KHz */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">ctl4</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
				<span class="n">LM93_REG_PWM_CTL</span><span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LM93_PWM_CTL4</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ctl4</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lm93_write_fan_smart_tach</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan1_smart_tach</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_fan_smart_tach</span><span class="p">,</span> <span class="n">store_fan_smart_tach</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan2_smart_tach</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_fan_smart_tach</span><span class="p">,</span> <span class="n">store_fan_smart_tach</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan3_smart_tach</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_fan_smart_tach</span><span class="p">,</span> <span class="n">store_fan_smart_tach</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan4_smart_tach</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_fan_smart_tach</span><span class="p">,</span> <span class="n">store_fan_smart_tach</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ctl2</span><span class="p">,</span> <span class="n">ctl4</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ctl2</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">block9</span><span class="p">[</span><span class="n">nr</span><span class="p">][</span><span class="n">LM93_PWM_CTL2</span><span class="p">];</span>
	<span class="n">ctl4</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">block9</span><span class="p">[</span><span class="n">nr</span><span class="p">][</span><span class="n">LM93_PWM_CTL4</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl2</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="cm">/* show user commanded value if enabled */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_override</span><span class="p">[</span><span class="n">nr</span><span class="p">];</span>
	<span class="k">else</span> <span class="cm">/* show present h/w value if manual pwm disabled */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">LM93_PWM_FROM_REG</span><span class="p">(</span><span class="n">ctl2</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="n">ctl4</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">LM93_PWM_MAP_LO_FREQ</span> <span class="o">:</span> <span class="n">LM93_PWM_MAP_HI_FREQ</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_pwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ctl2</span><span class="p">,</span> <span class="n">ctl4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">ctl2</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_CTL</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">LM93_PWM_CTL2</span><span class="p">));</span>
	<span class="n">ctl4</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_CTL</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">LM93_PWM_CTL4</span><span class="p">));</span>
	<span class="n">ctl2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctl2</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="n">LM93_PWM_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">ctl4</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">LM93_PWM_MAP_LO_FREQ</span> <span class="o">:</span> <span class="n">LM93_PWM_MAP_HI_FREQ</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="cm">/* save user commanded value */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_override</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">LM93_PWM_FROM_REG</span><span class="p">(</span><span class="n">ctl2</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ctl4</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">?</span>  <span class="n">LM93_PWM_MAP_LO_FREQ</span> <span class="o">:</span>
			<span class="n">LM93_PWM_MAP_HI_FREQ</span><span class="p">);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_CTL</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">LM93_PWM_CTL2</span><span class="p">),</span> <span class="n">ctl2</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">pwm1</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_pwm</span><span class="p">,</span> <span class="n">store_pwm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">pwm2</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_pwm</span><span class="p">,</span> <span class="n">store_pwm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pwm_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ctl2</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ctl2</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">block9</span><span class="p">[</span><span class="n">nr</span><span class="p">][</span><span class="n">LM93_PWM_CTL2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl2</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="cm">/* manual override enabled ? */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="p">((</span><span class="n">ctl2</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_pwm_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ctl2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">ctl2</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_CTL</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">LM93_PWM_CTL2</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">ctl2</span> <span class="o">|=</span> <span class="mh">0xF1</span><span class="p">;</span> <span class="cm">/* enable manual override, set PWM to max */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">ctl2</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* enable manual override */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">ctl2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* disable manual override */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_CTL</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">LM93_PWM_CTL2</span><span class="p">),</span> <span class="n">ctl2</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">pwm1_enable</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				<span class="n">show_pwm_enable</span><span class="p">,</span> <span class="n">store_pwm_enable</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">pwm2_enable</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				<span class="n">show_pwm_enable</span><span class="p">,</span> <span class="n">store_pwm_enable</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pwm_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ctl4</span><span class="p">;</span>

	<span class="n">ctl4</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">block9</span><span class="p">[</span><span class="n">nr</span><span class="p">][</span><span class="n">LM93_PWM_CTL4</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LM93_PWM_FREQ_FROM_REG</span><span class="p">(</span><span class="n">ctl4</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * helper function - must grab data-&gt;update_lock before calling</span>
<span class="cm"> * pwm is 0-1, indicating pwm1-pwm2</span>
<span class="cm"> * this disables smart tach for all tach channels bound to the given pwm</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lm93_disable_fan_smart_tach</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pwm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mapping</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_SF_TACH_TO_PWM</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* collapse the mapping into a mask of enable bits */</span>
	<span class="n">mapping</span> <span class="o">=</span> <span class="p">(</span><span class="n">mapping</span> <span class="o">&gt;&gt;</span> <span class="n">pwm</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x55</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">mapping</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mapping</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mapping</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mapping</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* disable smart tach according to the mask */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_SFC2</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_SFC2</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sfc2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_pwm_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ctl4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">ctl4</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_CTL</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">LM93_PWM_CTL4</span><span class="p">));</span>
	<span class="n">ctl4</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctl4</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">|</span> <span class="n">LM93_PWM_FREQ_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">block9</span><span class="p">[</span><span class="n">nr</span><span class="p">][</span><span class="n">LM93_PWM_CTL4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctl4</span><span class="p">;</span>
	<span class="cm">/* ctl4 == 0 -&gt; 22.5KHz -&gt; disable smart tach */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctl4</span><span class="p">)</span>
		<span class="n">lm93_disable_fan_smart_tach</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_CTL</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">LM93_PWM_CTL4</span><span class="p">),</span> <span class="n">ctl4</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">pwm1_freq</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_pwm_freq</span><span class="p">,</span> <span class="n">store_pwm_freq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">pwm2_freq</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_pwm_freq</span><span class="p">,</span> <span class="n">store_pwm_freq</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pwm_auto_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">block9</span><span class="p">[</span><span class="n">nr</span><span class="p">][</span><span class="n">LM93_PWM_CTL1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_pwm_auto_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">block9</span><span class="p">[</span><span class="n">nr</span><span class="p">][</span><span class="n">LM93_PWM_CTL1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_CTL</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">LM93_PWM_CTL1</span><span class="p">),</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">block9</span><span class="p">[</span><span class="n">nr</span><span class="p">][</span><span class="n">LM93_PWM_CTL1</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">pwm1_auto_channels</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_pwm_auto_channels</span><span class="p">,</span> <span class="n">store_pwm_auto_channels</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">pwm2_auto_channels</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_pwm_auto_channels</span><span class="p">,</span> <span class="n">store_pwm_auto_channels</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pwm_auto_spinup_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ctl3</span><span class="p">,</span> <span class="n">ctl4</span><span class="p">;</span>

	<span class="n">ctl3</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">block9</span><span class="p">[</span><span class="n">nr</span><span class="p">][</span><span class="n">LM93_PWM_CTL3</span><span class="p">];</span>
	<span class="n">ctl4</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">block9</span><span class="p">[</span><span class="n">nr</span><span class="p">][</span><span class="n">LM93_PWM_CTL4</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">LM93_PWM_FROM_REG</span><span class="p">(</span><span class="n">ctl3</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="p">(</span><span class="n">ctl4</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">LM93_PWM_MAP_LO_FREQ</span> <span class="o">:</span> <span class="n">LM93_PWM_MAP_HI_FREQ</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_pwm_auto_spinup_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ctl3</span><span class="p">,</span> <span class="n">ctl4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">ctl3</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_CTL</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">LM93_PWM_CTL3</span><span class="p">));</span>
	<span class="n">ctl4</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_CTL</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">LM93_PWM_CTL4</span><span class="p">));</span>
	<span class="n">ctl3</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctl3</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="n">LM93_PWM_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">ctl4</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">LM93_PWM_MAP_LO_FREQ</span> <span class="o">:</span>
			<span class="n">LM93_PWM_MAP_HI_FREQ</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">block9</span><span class="p">[</span><span class="n">nr</span><span class="p">][</span><span class="n">LM93_PWM_CTL3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctl3</span><span class="p">;</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_CTL</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">LM93_PWM_CTL3</span><span class="p">),</span> <span class="n">ctl3</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">pwm1_auto_spinup_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_pwm_auto_spinup_min</span><span class="p">,</span>
			  <span class="n">store_pwm_auto_spinup_min</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">pwm2_auto_spinup_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_pwm_auto_spinup_min</span><span class="p">,</span>
			  <span class="n">store_pwm_auto_spinup_min</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pwm_auto_spinup_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LM93_SPINUP_TIME_FROM_REG</span><span class="p">(</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">block9</span><span class="p">[</span><span class="n">nr</span><span class="p">][</span><span class="n">LM93_PWM_CTL3</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_pwm_auto_spinup_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ctl3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">ctl3</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_CTL</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">LM93_PWM_CTL3</span><span class="p">));</span>
	<span class="n">ctl3</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctl3</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">LM93_SPINUP_TIME_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">block9</span><span class="p">[</span><span class="n">nr</span><span class="p">][</span><span class="n">LM93_PWM_CTL3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctl3</span><span class="p">;</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_CTL</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">LM93_PWM_CTL3</span><span class="p">),</span> <span class="n">ctl3</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">pwm1_auto_spinup_time</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_pwm_auto_spinup_time</span><span class="p">,</span>
			  <span class="n">store_pwm_auto_spinup_time</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">pwm2_auto_spinup_time</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_pwm_auto_spinup_time</span><span class="p">,</span>
			  <span class="n">store_pwm_auto_spinup_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pwm_auto_prochot_ramp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">LM93_RAMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_ramp_ctl</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_pwm_auto_prochot_ramp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ramp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">ramp</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_RAMP_CTL</span><span class="p">);</span>
	<span class="n">ramp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ramp</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">LM93_RAMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_RAMP_CTL</span><span class="p">,</span> <span class="n">ramp</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">pwm_auto_prochot_ramp</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
			<span class="n">show_pwm_auto_prochot_ramp</span><span class="p">,</span>
			<span class="n">store_pwm_auto_prochot_ramp</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pwm_auto_vrdhot_ramp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">LM93_RAMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_ramp_ctl</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_pwm_auto_vrdhot_ramp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ramp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">ramp</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_RAMP_CTL</span><span class="p">);</span>
	<span class="n">ramp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ramp</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">LM93_RAMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PWM_RAMP_CTL</span><span class="p">,</span> <span class="n">ramp</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">pwm_auto_vrdhot_ramp</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
			<span class="n">show_pwm_auto_vrdhot_ramp</span><span class="p">,</span>
			<span class="n">store_pwm_auto_vrdhot_ramp</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LM93_VID_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">[</span><span class="n">nr</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">cpu0_vid</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_vid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">cpu1_vid</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_vid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_prochot</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">block4</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">cur</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">prochot1</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_prochot</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">prochot2</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_prochot</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_prochot_avg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">block4</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">avg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">prochot1_avg</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_prochot_avg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">prochot2_avg</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_prochot_avg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_prochot_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">prochot_max</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_prochot_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">prochot_max</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">LM93_PROCHOT_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PROCHOT_MAX</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">prochot_max</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">prochot1_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_prochot_max</span><span class="p">,</span> <span class="n">store_prochot_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">prochot2_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_prochot_max</span><span class="p">,</span> <span class="n">store_prochot_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">prochot_override_mask</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_prochot_override</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">prochot_override</span> <span class="o">&amp;</span> <span class="n">prochot_override_mask</span><span class="p">[</span><span class="n">nr</span><span class="p">])</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_prochot_override</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">prochot_override</span> <span class="o">|=</span> <span class="n">prochot_override_mask</span><span class="p">[</span><span class="n">nr</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">prochot_override</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">prochot_override_mask</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PROCHOT_OVERRIDE</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">prochot_override</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">prochot1_override</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_prochot_override</span><span class="p">,</span> <span class="n">store_prochot_override</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">prochot2_override</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_prochot_override</span><span class="p">,</span> <span class="n">store_prochot_override</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_prochot_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">prochot_interval</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">prochot_interval</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LM93_INTERVAL_FROM_REG</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_prochot_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PROCHOT_INTERVAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">LM93_INTERVAL_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="n">LM93_INTERVAL_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">prochot_interval</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PROCHOT_INTERVAL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">prochot1_interval</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_prochot_interval</span><span class="p">,</span> <span class="n">store_prochot_interval</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">prochot2_interval</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">show_prochot_interval</span><span class="p">,</span> <span class="n">store_prochot_interval</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_prochot_override_duty_cycle</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
						<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">prochot_override</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_prochot_override_duty_cycle</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">prochot_override</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">prochot_override</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_PROCHOT_OVERRIDE</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">prochot_override</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">prochot_override_duty_cycle</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
			<span class="n">show_prochot_override_duty_cycle</span><span class="p">,</span>
			<span class="n">store_prochot_override_duty_cycle</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_prochot_short</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_prochot_short</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">;</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_CONFIG</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">prochot_short</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_prochot_short</span><span class="p">,</span> <span class="n">store_prochot_short</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_vrdhot</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">data</span><span class="o">-&gt;</span><span class="n">block1</span><span class="p">.</span><span class="n">host_status_1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">nr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">vrdhot1</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_vrdhot</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">vrdhot2</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_vrdhot</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LM93_GPI_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">gpi</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">gpio</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_gpio</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_alarms</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm93_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LM93_ALARMS_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">block1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">alarms</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarms</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">lm93_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in1_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in2_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in3_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in4_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in5_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in6_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in7_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in8_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in9_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in10_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in11_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in12_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in13_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in14_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in15_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in16_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in1_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in2_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in3_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in4_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in5_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in6_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in7_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in8_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in9_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in10_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in11_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in12_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in13_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in14_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in15_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in16_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in1_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in2_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in3_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in4_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in5_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in6_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in7_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in8_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in9_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in10_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in11_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in12_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in13_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in14_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in15_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in16_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_base</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_base</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_base</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_boost</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_boost</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_boost</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_boost_hyst</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_boost_hyst</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_boost_hyst</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_offset1</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_offset2</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_offset3</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_offset4</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_offset5</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_offset6</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_offset7</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_offset8</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_offset9</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_offset10</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_offset11</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_offset12</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_offset1</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_offset2</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_offset3</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_offset4</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_offset5</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_offset6</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_offset7</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_offset8</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_offset9</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_offset10</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_offset11</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_offset12</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_offset1</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_offset2</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_offset3</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_offset4</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_offset5</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_offset6</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_offset7</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_offset8</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_offset9</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_offset10</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_offset11</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_offset12</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_pwm_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_pwm_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_pwm_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_offset_hyst</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_offset_hyst</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_offset_hyst</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan1_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan2_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan3_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan4_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan1_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan2_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan3_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan4_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan1_smart_tach</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan2_smart_tach</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan3_smart_tach</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan4_smart_tach</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_enable</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_enable</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_freq</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_freq</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_auto_channels</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_auto_channels</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_auto_spinup_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_auto_spinup_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_auto_spinup_time</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_auto_spinup_time</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_pwm_auto_prochot_ramp</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_pwm_auto_vrdhot_ramp</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_cpu0_vid</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_cpu1_vid</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_prochot1</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_prochot2</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_prochot1_avg</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_prochot2_avg</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_prochot1_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_prochot2_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_prochot1_override</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_prochot2_override</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_prochot1_interval</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_prochot2_interval</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_prochot_override_duty_cycle</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_prochot_short</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_vrdhot1</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_vrdhot2</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_gpio</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_alarms</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">lm93_attr_grp</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">lm93_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lm93_init_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* configure VID pin input thresholds */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_GPI_VID_CTL</span><span class="p">);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_GPI_VID_CTL</span><span class="p">,</span>
			<span class="n">reg</span> <span class="o">|</span> <span class="p">(</span><span class="n">vid_agtl</span> <span class="o">?</span> <span class="mh">0x03</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable #ALERT pin */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_CONFIG</span><span class="p">);</span>
		<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_CONFIG</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">);</span>

		<span class="cm">/* enable ASF mode for BMC status registers */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_STATUS_CONTROL</span><span class="p">);</span>
		<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_STATUS_CONTROL</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="mh">0x02</span><span class="p">);</span>

		<span class="cm">/* set sleep state to S0 */</span>
		<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_SLEEP_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* unmask #VRDHOT and dynamic VCCP (if nec) error events */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_MISC_ERR_MASK</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">vccp_limit_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">vccp_limit_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">?</span> <span class="mh">0x20</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_MISC_ERR_MASK</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* start monitoring */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_CONFIG</span><span class="p">);</span>
	<span class="n">lm93_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_CONFIG</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="cm">/* spin until ready */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_CONFIG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timed out waiting for sensor &quot;</span>
		 <span class="s">&quot;chip to signal ready!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Return 0 if detection is successful, -ENODEV otherwise */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lm93_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mfr</span><span class="p">,</span> <span class="n">ver</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">LM93_SMBUS_FUNC_MIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* detection */</span>
	<span class="n">mfr</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_MFR_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mfr</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;detect failed, bad manufacturer id 0x%02x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mfr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ver</span> <span class="o">=</span> <span class="n">lm93_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM93_REG_VER</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ver</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LM93_MFR_ID</span>:
	<span class="k">case</span> <span class="n">LM93_MFR_ID_PROTOTYPE</span>:
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;lm93&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LM94_MFR_ID_2</span>:
	<span class="k">case</span> <span class="n">LM94_MFR_ID</span>:
	<span class="k">case</span> <span class="n">LM94_MFR_ID_PROTOTYPE</span>:
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;lm94&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;detect failed, bad version id 0x%02x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ver</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">I2C_NAME_SIZE</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;loading %s at %d, 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i2c_adapter_id</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">),</span>
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lm93_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">func</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">update</span><span class="p">)(</span><span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="p">);</span>

	<span class="cm">/* choose update routine based on bus capabilities */</span>
	<span class="n">func</span> <span class="o">=</span> <span class="n">i2c_get_functionality</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">LM93_SMBUS_FUNC_FULL</span> <span class="o">&amp;</span> <span class="n">func</span><span class="p">)</span> <span class="o">==</span> <span class="n">LM93_SMBUS_FUNC_FULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="o">!</span><span class="n">disable_block</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using SMBus block data transactions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">update</span> <span class="o">=</span> <span class="n">lm93_update_client_full</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">LM93_SMBUS_FUNC_MIN</span> <span class="o">&amp;</span> <span class="n">func</span><span class="p">)</span> <span class="o">==</span> <span class="n">LM93_SMBUS_FUNC_MIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disabled SMBus block data &quot;</span>
			<span class="s">&quot;transactions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">update</span> <span class="o">=</span> <span class="n">lm93_update_client_min</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;detect failed, &quot;</span>
			<span class="s">&quot;smbus byte and/or word data not supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lm93_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/* housekeeping */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">=</span> <span class="n">update</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="cm">/* initialize the chip */</span>
	<span class="n">lm93_init_client</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm93_attr_grp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>

	<span class="cm">/* Register hwmon driver class */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span> <span class="o">=</span> <span class="n">hwmon_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error registering hwmon device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm93_attr_grp</span><span class="p">);</span>
<span class="nl">err_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lm93_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm93_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm93_attr_grp</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">lm93_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;lm93&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;lm94&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">lm93_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">lm93_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">class</span>		<span class="o">=</span> <span class="n">I2C_CLASS_HWMON</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;lm93&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">lm93_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">lm93_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">lm93_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">lm93_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">address_list</span>	<span class="o">=</span> <span class="n">normal_i2c</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">lm93_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mark M. Hoffman &lt;mhoffman@lightlink.com&gt;, &quot;</span>
		<span class="s">&quot;Hans J. Koch &lt;hjk@hansjkoch.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;LM93 driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
