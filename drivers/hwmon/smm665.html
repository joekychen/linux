<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › hwmon › smm665.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>smm665.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for SMM665 Power Controller / Monitor</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Ericsson AB.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver should also work for SMM465, SMM764, and SMM766, but is untested</span>
<span class="cm"> * for those chips. Only monitoring functionality is implemented.</span>
<span class="cm"> *</span>
<span class="cm"> * Datasheets:</span>
<span class="cm"> * http://www.summitmicro.com/prod_select/summary/SMM665/SMM665B_2089_20.pdf</span>
<span class="cm"> * http://www.summitmicro.com/prod_select/summary/SMM766B/SMM766B_2122.pdf</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon-sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cm">/* Internal reference voltage (VREF, x 1000 */</span>
<span class="cp">#define SMM665_VREF_ADC_X1000	1250</span>

<span class="cm">/* module parameters */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vref</span> <span class="o">=</span> <span class="n">SMM665_VREF_ADC_X1000</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">vref</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vref</span><span class="p">,</span> <span class="s">&quot;Reference voltage in mV&quot;</span><span class="p">);</span>

<span class="k">enum</span> <span class="n">chips</span> <span class="p">{</span> <span class="n">smm465</span><span class="p">,</span> <span class="n">smm665</span><span class="p">,</span> <span class="n">smm665c</span><span class="p">,</span> <span class="n">smm764</span><span class="p">,</span> <span class="n">smm766</span> <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ADC channel addresses</span>
<span class="cm"> */</span>
<span class="cp">#define	SMM665_MISC16_ADC_DATA_A	0x00</span>
<span class="cp">#define	SMM665_MISC16_ADC_DATA_B	0x01</span>
<span class="cp">#define	SMM665_MISC16_ADC_DATA_C	0x02</span>
<span class="cp">#define	SMM665_MISC16_ADC_DATA_D	0x03</span>
<span class="cp">#define	SMM665_MISC16_ADC_DATA_E	0x04</span>
<span class="cp">#define	SMM665_MISC16_ADC_DATA_F	0x05</span>
<span class="cp">#define	SMM665_MISC16_ADC_DATA_VDD	0x06</span>
<span class="cp">#define	SMM665_MISC16_ADC_DATA_12V	0x07</span>
<span class="cp">#define	SMM665_MISC16_ADC_DATA_INT_TEMP	0x08</span>
<span class="cp">#define	SMM665_MISC16_ADC_DATA_AIN1	0x09</span>
<span class="cp">#define	SMM665_MISC16_ADC_DATA_AIN2	0x0a</span>

<span class="cm">/*</span>
<span class="cm"> * Command registers</span>
<span class="cm"> */</span>
<span class="cp">#define	SMM665_MISC8_CMD_STS		0x80</span>
<span class="cp">#define	SMM665_MISC8_STATUS1		0x81</span>
<span class="cp">#define	SMM665_MISC8_STATUSS2		0x82</span>
<span class="cp">#define	SMM665_MISC8_IO_POLARITY	0x83</span>
<span class="cp">#define	SMM665_MISC8_PUP_POLARITY	0x84</span>
<span class="cp">#define	SMM665_MISC8_ADOC_STATUS1	0x85</span>
<span class="cp">#define	SMM665_MISC8_ADOC_STATUS2	0x86</span>
<span class="cp">#define	SMM665_MISC8_WRITE_PROT		0x87</span>
<span class="cp">#define	SMM665_MISC8_STS_TRACK		0x88</span>

<span class="cm">/*</span>
<span class="cm"> * Configuration registers and register groups</span>
<span class="cm"> */</span>
<span class="cp">#define SMM665_ADOC_ENABLE		0x0d</span>
<span class="cp">#define SMM665_LIMIT_BASE		0x80	</span><span class="cm">/* First limit register */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Limit register bit masks</span>
<span class="cm"> */</span>
<span class="cp">#define SMM665_TRIGGER_RST		0x8000</span>
<span class="cp">#define SMM665_TRIGGER_HEALTHY		0x4000</span>
<span class="cp">#define SMM665_TRIGGER_POWEROFF		0x2000</span>
<span class="cp">#define SMM665_TRIGGER_SHUTDOWN		0x1000</span>
<span class="cp">#define SMM665_ADC_MASK			0x03ff</span>

<span class="cp">#define smm665_is_critical(lim)	((lim) &amp; (SMM665_TRIGGER_RST \</span>
<span class="cp">					| SMM665_TRIGGER_POWEROFF \</span>
<span class="cp">					| SMM665_TRIGGER_SHUTDOWN))</span>
<span class="cm">/*</span>
<span class="cm"> * Fault register bit definitions</span>
<span class="cm"> * Values are merged from status registers 1/2,</span>
<span class="cm"> * with status register 1 providing the upper 8 bits.</span>
<span class="cm"> */</span>
<span class="cp">#define SMM665_FAULT_A		0x0001</span>
<span class="cp">#define SMM665_FAULT_B		0x0002</span>
<span class="cp">#define SMM665_FAULT_C		0x0004</span>
<span class="cp">#define SMM665_FAULT_D		0x0008</span>
<span class="cp">#define SMM665_FAULT_E		0x0010</span>
<span class="cp">#define SMM665_FAULT_F		0x0020</span>
<span class="cp">#define SMM665_FAULT_VDD	0x0040</span>
<span class="cp">#define SMM665_FAULT_12V	0x0080</span>
<span class="cp">#define SMM665_FAULT_TEMP	0x0100</span>
<span class="cp">#define SMM665_FAULT_AIN1	0x0200</span>
<span class="cp">#define SMM665_FAULT_AIN2	0x0400</span>

<span class="cm">/*</span>
<span class="cm"> * I2C Register addresses</span>
<span class="cm"> *</span>
<span class="cm"> * The configuration register needs to be the configured base register.</span>
<span class="cm"> * The command/status register address is derived from it.</span>
<span class="cm"> */</span>
<span class="cp">#define SMM665_REGMASK		0x78</span>
<span class="cp">#define SMM665_CMDREG_BASE	0x48</span>
<span class="cp">#define SMM665_CONFREG_BASE	0x50</span>

<span class="cm">/*</span>
<span class="cm"> *  Equations given by chip manufacturer to calculate voltage/temperature values</span>
<span class="cm"> *  vref = Reference voltage on VREF_ADC pin (module parameter)</span>
<span class="cm"> *  adc  = 10bit ADC value read back from registers</span>
<span class="cm"> */</span>

<span class="cm">/* Voltage A-F and VDD */</span>
<span class="cp">#define SMM665_VMON_ADC_TO_VOLTS(adc)  ((adc) * vref / 256)</span>

<span class="cm">/* Voltage 12VIN */</span>
<span class="cp">#define SMM665_12VIN_ADC_TO_VOLTS(adc) ((adc) * vref * 3 / 256)</span>

<span class="cm">/* Voltage AIN1, AIN2 */</span>
<span class="cp">#define SMM665_AIN_ADC_TO_VOLTS(adc)   ((adc) * vref / 512)</span>

<span class="cm">/* Temp Sensor */</span>
<span class="cp">#define SMM665_TEMP_ADC_TO_CELSIUS(adc) (((adc) &lt;= 511) ?		   \</span>
<span class="cp">					 ((int)(adc) * 1000 / 4) :	   \</span>
<span class="cp">					 (((int)(adc) - 0x400) * 1000 / 4))</span>

<span class="cp">#define SMM665_NUM_ADC		11</span>

<span class="cm">/*</span>
<span class="cm"> * Chip dependent ADC conversion time, in uS</span>
<span class="cm"> */</span>
<span class="cp">#define SMM665_ADC_WAIT_SMM665	70</span>
<span class="cp">#define SMM665_ADC_WAIT_SMM766	185</span>

<span class="k">struct</span> <span class="n">smm665_data</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">chips</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">conversion_time</span><span class="p">;</span>		<span class="cm">/* ADC conversion time */</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">hwmon_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">update_lock</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">valid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_updated</span><span class="p">;</span>	<span class="cm">/* in jiffies */</span>
	<span class="n">u16</span> <span class="n">adc</span><span class="p">[</span><span class="n">SMM665_NUM_ADC</span><span class="p">];</span>	<span class="cm">/* adc values (raw) */</span>
	<span class="n">u16</span> <span class="n">faults</span><span class="p">;</span>			<span class="cm">/* fault status */</span>
	<span class="cm">/* The following values are in mV */</span>
	<span class="kt">int</span> <span class="n">critical_min_limit</span><span class="p">[</span><span class="n">SMM665_NUM_ADC</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">alarm_min_limit</span><span class="p">[</span><span class="n">SMM665_NUM_ADC</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">critical_max_limit</span><span class="p">[</span><span class="n">SMM665_NUM_ADC</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">alarm_max_limit</span><span class="p">[</span><span class="n">SMM665_NUM_ADC</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">cmdreg</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * smm665_read16()</span>
<span class="cm"> *</span>
<span class="cm"> * Read 16 bit value from &lt;reg&gt;, &lt;reg+1&gt;. Upper 8 bits are in &lt;reg&gt;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">smm665_read16</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">rv</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">rv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read adc value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">smm665_read_adc</span><span class="p">(</span><span class="k">struct</span> <span class="n">smm665_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cmdreg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">radc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Algorithm for reading ADC, per SMM665 datasheet</span>
<span class="cm">	 *</span>
<span class="cm">	 *  {[S][addr][W][Ack]} {[offset][Ack]} {[S][addr][R][Nack]}</span>
<span class="cm">	 * [wait conversion time]</span>
<span class="cm">	 *  {[S][addr][R][Ack]} {[datahi][Ack]} {[datalo][Ack][P]}</span>
<span class="cm">	 *</span>
<span class="cm">	 * To implement the first part of this exchange,</span>
<span class="cm">	 * do a full read transaction and expect a failure/Nack.</span>
<span class="cm">	 * This sets up the address pointer on the SMM665</span>
<span class="cm">	 * and starts the ADC conversion.</span>
<span class="cm">	 * Then do a two-byte read transaction.</span>
<span class="cm">	 */</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">adc</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We expect ENXIO to reflect NACK</span>
<span class="cm">		 * (per Documentation/i2c/fault-codes).</span>
<span class="cm">		 * Everything else is an error.</span>
<span class="cm">		 */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Unexpected return code %d when setting ADC index&quot;</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">rv</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">conversion_time</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now read two bytes.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Neither i2c_smbus_read_byte() nor</span>
<span class="cm">	 * i2c_smbus_read_block_data() worked here,</span>
<span class="cm">	 * so use i2c_smbus_read_word_swapped() instead.</span>
<span class="cm">	 * We could also try to use i2c_master_recv(),</span>
<span class="cm">	 * but that is not always supported.</span>
<span class="cm">	 */</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">i2c_smbus_read_word_swapped</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to read ADC value: error %d&quot;</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Validate/verify readback adc channel (in bit 11..14).</span>
<span class="cm">	 */</span>
	<span class="n">radc</span> <span class="o">=</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radc</span> <span class="o">!=</span> <span class="n">adc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unexpected RADC: Expected %d got %d&quot;</span><span class="p">,</span>
			<span class="n">adc</span><span class="p">,</span> <span class="n">radc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rv</span> <span class="o">&amp;</span> <span class="n">SMM665_ADC_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">smm665_data</span> <span class="o">*</span><span class="nf">smm665_update_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smm665_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smm665_data</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">last_updated</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * read status registers</span>
<span class="cm">		 */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">smm665_read16</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">SMM665_MISC8_STATUS1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">faults</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

		<span class="cm">/* Read adc registers */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SMM665_NUM_ADC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">smm665_read_adc</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">abort</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">adc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">last_updated</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">abort:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return converted value from given adc */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">smm665_convert</span><span class="p">(</span><span class="n">u16</span> <span class="n">adcval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SMM665_MISC16_ADC_DATA_12V</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">SMM665_12VIN_ADC_TO_VOLTS</span><span class="p">(</span><span class="n">adcval</span> <span class="o">&amp;</span> <span class="n">SMM665_ADC_MASK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SMM665_MISC16_ADC_DATA_VDD</span>:
	<span class="k">case</span> <span class="n">SMM665_MISC16_ADC_DATA_A</span>:
	<span class="k">case</span> <span class="n">SMM665_MISC16_ADC_DATA_B</span>:
	<span class="k">case</span> <span class="n">SMM665_MISC16_ADC_DATA_C</span>:
	<span class="k">case</span> <span class="n">SMM665_MISC16_ADC_DATA_D</span>:
	<span class="k">case</span> <span class="n">SMM665_MISC16_ADC_DATA_E</span>:
	<span class="k">case</span> <span class="n">SMM665_MISC16_ADC_DATA_F</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">SMM665_VMON_ADC_TO_VOLTS</span><span class="p">(</span><span class="n">adcval</span> <span class="o">&amp;</span> <span class="n">SMM665_ADC_MASK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SMM665_MISC16_ADC_DATA_AIN1</span>:
	<span class="k">case</span> <span class="n">SMM665_MISC16_ADC_DATA_AIN2</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">SMM665_AIN_ADC_TO_VOLTS</span><span class="p">(</span><span class="n">adcval</span> <span class="o">&amp;</span> <span class="n">SMM665_ADC_MASK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SMM665_MISC16_ADC_DATA_INT_TEMP</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">SMM665_TEMP_ADC_TO_CELSIUS</span><span class="p">(</span><span class="n">adcval</span> <span class="o">&amp;</span> <span class="n">SMM665_ADC_MASK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* If we get here, the developer messed up */</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smm665_get_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smm665_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">alarm_min_limit</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smm665_get_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smm665_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">alarm_max_limit</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smm665_get_lcrit</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smm665_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">critical_min_limit</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smm665_get_crit</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smm665_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">critical_max_limit</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">smm665_show_crit_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">da</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">da</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smm665_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">smm665_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">faults</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">smm665_show_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">da</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">da</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smm665_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">smm665_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">adc</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">smm665_convert</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">adc</span><span class="p">[</span><span class="n">adc</span><span class="p">],</span> <span class="n">adc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SMM665_SHOW(what) \</span>
<span class="cp">static ssize_t smm665_show_##what(struct device *dev, \</span>
<span class="cp">				    struct device_attribute *da, char *buf) \</span>
<span class="cp">{ \</span>
<span class="cp">	struct sensor_device_attribute *attr = to_sensor_dev_attr(da); \</span>
<span class="cp">	const int val = smm665_get_##what(dev, attr-&gt;index); \</span>
<span class="cp">	return snprintf(buf, PAGE_SIZE, &quot;%d\n&quot;, val); \</span>
<span class="cp">}</span>

<span class="n">SMM665_SHOW</span><span class="p">(</span><span class="n">min</span><span class="p">);</span>
<span class="n">SMM665_SHOW</span><span class="p">(</span><span class="n">max</span><span class="p">);</span>
<span class="n">SMM665_SHOW</span><span class="p">(</span><span class="n">lcrit</span><span class="p">);</span>
<span class="n">SMM665_SHOW</span><span class="p">(</span><span class="n">crit</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * These macros are used below in constructing device attribute objects</span>
<span class="cm"> * for use with sysfs_create_group() to make a sysfs device file</span>
<span class="cm"> * for each register.</span>
<span class="cm"> */</span>

<span class="cp">#define SMM665_ATTR(name, type, cmd_idx) \</span>
<span class="cp">	static SENSOR_DEVICE_ATTR(name##_##type, S_IRUGO, \</span>
<span class="cp">				  smm665_show_##type, NULL, cmd_idx)</span>

<span class="cm">/* Construct a sensor_device_attribute structure for each register */</span>

<span class="cm">/* Input voltages */</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_12V</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in2</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_VDD</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in3</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_A</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in4</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_B</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in5</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_C</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in6</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_D</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in7</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_E</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in8</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_F</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in9</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_AIN1</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in10</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_AIN2</span><span class="p">);</span>

<span class="cm">/* Input voltages min */</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_12V</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in2</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_VDD</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in3</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_A</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in4</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_B</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in5</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_C</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in6</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_D</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in7</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_E</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in8</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_F</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in9</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_AIN1</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in10</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_AIN2</span><span class="p">);</span>

<span class="cm">/* Input voltages max */</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_12V</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in2</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_VDD</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in3</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_A</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in4</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_B</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in5</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_C</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in6</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_D</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in7</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_E</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in8</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_F</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in9</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_AIN1</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in10</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_AIN2</span><span class="p">);</span>

<span class="cm">/* Input voltages lcrit */</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">lcrit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_12V</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in2</span><span class="p">,</span> <span class="n">lcrit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_VDD</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in3</span><span class="p">,</span> <span class="n">lcrit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_A</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in4</span><span class="p">,</span> <span class="n">lcrit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_B</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in5</span><span class="p">,</span> <span class="n">lcrit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_C</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in6</span><span class="p">,</span> <span class="n">lcrit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_D</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in7</span><span class="p">,</span> <span class="n">lcrit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_E</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in8</span><span class="p">,</span> <span class="n">lcrit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_F</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in9</span><span class="p">,</span> <span class="n">lcrit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_AIN1</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in10</span><span class="p">,</span> <span class="n">lcrit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_AIN2</span><span class="p">);</span>

<span class="cm">/* Input voltages crit */</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">crit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_12V</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in2</span><span class="p">,</span> <span class="n">crit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_VDD</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in3</span><span class="p">,</span> <span class="n">crit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_A</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in4</span><span class="p">,</span> <span class="n">crit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_B</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in5</span><span class="p">,</span> <span class="n">crit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_C</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in6</span><span class="p">,</span> <span class="n">crit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_D</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in7</span><span class="p">,</span> <span class="n">crit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_E</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in8</span><span class="p">,</span> <span class="n">crit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_F</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in9</span><span class="p">,</span> <span class="n">crit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_AIN1</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in10</span><span class="p">,</span> <span class="n">crit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_AIN2</span><span class="p">);</span>

<span class="cm">/* critical alarms */</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">crit_alarm</span><span class="p">,</span> <span class="n">SMM665_FAULT_12V</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in2</span><span class="p">,</span> <span class="n">crit_alarm</span><span class="p">,</span> <span class="n">SMM665_FAULT_VDD</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in3</span><span class="p">,</span> <span class="n">crit_alarm</span><span class="p">,</span> <span class="n">SMM665_FAULT_A</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in4</span><span class="p">,</span> <span class="n">crit_alarm</span><span class="p">,</span> <span class="n">SMM665_FAULT_B</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in5</span><span class="p">,</span> <span class="n">crit_alarm</span><span class="p">,</span> <span class="n">SMM665_FAULT_C</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in6</span><span class="p">,</span> <span class="n">crit_alarm</span><span class="p">,</span> <span class="n">SMM665_FAULT_D</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in7</span><span class="p">,</span> <span class="n">crit_alarm</span><span class="p">,</span> <span class="n">SMM665_FAULT_E</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in8</span><span class="p">,</span> <span class="n">crit_alarm</span><span class="p">,</span> <span class="n">SMM665_FAULT_F</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in9</span><span class="p">,</span> <span class="n">crit_alarm</span><span class="p">,</span> <span class="n">SMM665_FAULT_AIN1</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">in10</span><span class="p">,</span> <span class="n">crit_alarm</span><span class="p">,</span> <span class="n">SMM665_FAULT_AIN2</span><span class="p">);</span>

<span class="cm">/* Temperature */</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_INT_TEMP</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_INT_TEMP</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_INT_TEMP</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span> <span class="n">lcrit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_INT_TEMP</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span> <span class="n">crit</span><span class="p">,</span> <span class="n">SMM665_MISC16_ADC_DATA_INT_TEMP</span><span class="p">);</span>
<span class="n">SMM665_ATTR</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span> <span class="n">crit_alarm</span><span class="p">,</span> <span class="n">SMM665_FAULT_TEMP</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Finally, construct an array of pointers to members of the above objects,</span>
<span class="cm"> * as required for sysfs_create_group()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">smm665_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in1_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in1_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in1_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in1_lcrit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in1_crit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in1_crit_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in2_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in2_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in2_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in2_lcrit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in2_crit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in2_crit_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in3_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in3_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in3_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in3_lcrit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in3_crit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in3_crit_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in4_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in4_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in4_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in4_lcrit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in4_crit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in4_crit_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in5_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in5_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in5_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in5_lcrit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in5_crit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in5_crit_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in6_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in6_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in6_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in6_lcrit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in6_crit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in6_crit_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in7_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in7_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in7_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in7_lcrit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in7_crit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in7_crit_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in8_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in8_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in8_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in8_lcrit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in8_crit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in8_crit_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in9_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in9_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in9_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in9_lcrit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in9_crit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in9_crit_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in10_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in10_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in10_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in10_lcrit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in10_crit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in10_crit_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_lcrit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_crit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_crit_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">smm665_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">smm665_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smm665_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smm665_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_BYTE_DATA</span>
				     <span class="o">|</span> <span class="n">I2C_FUNC_SMBUS_WORD_DATA</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">SMM665_ADOC_ENABLE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">cmdreg</span> <span class="o">=</span> <span class="n">i2c_new_dummy</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SMM665_REGMASK</span><span class="p">)</span>
				     <span class="o">|</span> <span class="n">SMM665_CMDREG_BASE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cmdreg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">smm465</span>:
	<span class="k">case</span> <span class="n">smm665</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">conversion_time</span> <span class="o">=</span> <span class="n">SMM665_ADC_WAIT_SMM665</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">smm665c</span>:
	<span class="k">case</span> <span class="n">smm764</span>:
	<span class="k">case</span> <span class="n">smm766</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">conversion_time</span> <span class="o">=</span> <span class="n">SMM665_ADC_WAIT_SMM766</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cmdreg</span><span class="p">,</span> <span class="n">SMM665_MISC8_CMD_STS</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unregister</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read limits.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Limit registers start with register SMM665_LIMIT_BASE.</span>
<span class="cm">	 * Each channel uses 8 registers, providing four limit values</span>
<span class="cm">	 * per channel. Each limit value requires two registers, with the</span>
<span class="cm">	 * high byte in the first register and the low byte in the second</span>
<span class="cm">	 * register. The first two limits are under limit values, followed</span>
<span class="cm">	 * by two over limit values.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Limit register order matches the ADC register order, so we use</span>
<span class="cm">	 * ADC register defines throughout the code to index limit registers.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We save the first retrieved value both as &quot;critical&quot; and &quot;alarm&quot;</span>
<span class="cm">	 * value. The second value overwrites either the critical or the</span>
<span class="cm">	 * alarm value, depending on its configuration. This ensures that both</span>
<span class="cm">	 * critical and alarm values are initialized, even if both registers are</span>
<span class="cm">	 * configured as critical or non-critical.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SMM665_NUM_ADC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">smm665_read16</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">SMM665_LIMIT_BASE</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_unregister</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">critical_min_limit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">alarm_min_limit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
		  <span class="o">=</span> <span class="n">smm665_convert</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">smm665_read16</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">SMM665_LIMIT_BASE</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_unregister</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smm665_is_critical</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">critical_min_limit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">smm665_convert</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">alarm_min_limit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">smm665_convert</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">smm665_read16</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">SMM665_LIMIT_BASE</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_unregister</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">critical_max_limit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">alarm_max_limit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
		  <span class="o">=</span> <span class="n">smm665_convert</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">smm665_read16</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">SMM665_LIMIT_BASE</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_unregister</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smm665_is_critical</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">critical_max_limit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">smm665_convert</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">alarm_max_limit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">smm665_convert</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Register sysfs hooks */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smm665_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unregister</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span> <span class="o">=</span> <span class="n">hwmon_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_remove_group</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_remove_group:</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smm665_group</span><span class="p">);</span>
<span class="nl">out_unregister:</span>
	<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cmdreg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smm665_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smm665_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cmdreg</span><span class="p">);</span>
	<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smm665_group</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">smm665_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;smm465&quot;</span><span class="p">,</span> <span class="n">smm465</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;smm665&quot;</span><span class="p">,</span> <span class="n">smm665</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;smm665c&quot;</span><span class="p">,</span> <span class="n">smm665c</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;smm764&quot;</span><span class="p">,</span> <span class="n">smm764</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;smm766&quot;</span><span class="p">,</span> <span class="n">smm766</span><span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">smm665_id</span><span class="p">);</span>

<span class="cm">/* This is the driver that will be inserted */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">smm665_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		   <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;smm665&quot;</span><span class="p">,</span>
		   <span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">smm665_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">smm665_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">smm665_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">smm665_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Guenter Roeck&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SMM665 driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
