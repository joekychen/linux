<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › hwmon › pmbus › pmbus_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pmbus_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Hardware monitoring driver for PMBus devices</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2010, 2011 Ericsson AB.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon-sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/i2c/pmbus.h&gt;</span>
<span class="cp">#include &quot;pmbus.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Constants needed to determine number of sensors, booleans, and labels.</span>
<span class="cm"> */</span>
<span class="cp">#define PMBUS_MAX_INPUT_SENSORS		22	</span><span class="cm">/* 10*volt, 7*curr, 5*power */</span><span class="cp"></span>
<span class="cp">#define PMBUS_VOUT_SENSORS_PER_PAGE	9	</span><span class="cm">/* input, min, max, lcrit,</span>
<span class="cm">						   crit, lowest, highest, avg,</span>
<span class="cm">						   reset */</span><span class="cp"></span>
<span class="cp">#define PMBUS_IOUT_SENSORS_PER_PAGE	8	</span><span class="cm">/* input, min, max, crit,</span>
<span class="cm">						   lowest, highest, avg,</span>
<span class="cm">						   reset */</span><span class="cp"></span>
<span class="cp">#define PMBUS_POUT_SENSORS_PER_PAGE	7	</span><span class="cm">/* input, cap, max, crit,</span>
<span class="cm">						 * highest, avg, reset</span>
<span class="cm">						 */</span><span class="cp"></span>
<span class="cp">#define PMBUS_MAX_SENSORS_PER_FAN	1	</span><span class="cm">/* input */</span><span class="cp"></span>
<span class="cp">#define PMBUS_MAX_SENSORS_PER_TEMP	9	</span><span class="cm">/* input, min, max, lcrit,</span>
<span class="cm">						 * crit, lowest, highest, avg,</span>
<span class="cm">						 * reset</span>
<span class="cm">						 */</span><span class="cp"></span>

<span class="cp">#define PMBUS_MAX_INPUT_BOOLEANS	7	</span><span class="cm">/* v: min_alarm, max_alarm,</span>
<span class="cm">						   lcrit_alarm, crit_alarm;</span>
<span class="cm">						   c: alarm, crit_alarm;</span>
<span class="cm">						   p: crit_alarm */</span><span class="cp"></span>
<span class="cp">#define PMBUS_VOUT_BOOLEANS_PER_PAGE	4	</span><span class="cm">/* min_alarm, max_alarm,</span>
<span class="cm">						   lcrit_alarm, crit_alarm */</span><span class="cp"></span>
<span class="cp">#define PMBUS_IOUT_BOOLEANS_PER_PAGE	3	</span><span class="cm">/* alarm, lcrit_alarm,</span>
<span class="cm">						   crit_alarm */</span><span class="cp"></span>
<span class="cp">#define PMBUS_POUT_BOOLEANS_PER_PAGE	3	</span><span class="cm">/* cap_alarm, alarm, crit_alarm</span>
<span class="cm">						 */</span><span class="cp"></span>
<span class="cp">#define PMBUS_MAX_BOOLEANS_PER_FAN	2	</span><span class="cm">/* alarm, fault */</span><span class="cp"></span>
<span class="cp">#define PMBUS_MAX_BOOLEANS_PER_TEMP	4	</span><span class="cm">/* min_alarm, max_alarm,</span>
<span class="cm">						   lcrit_alarm, crit_alarm */</span><span class="cp"></span>

<span class="cp">#define PMBUS_MAX_INPUT_LABELS		4	</span><span class="cm">/* vin, vcap, iin, pin */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * status, status_vout, status_iout, status_fans, status_fan34, and status_temp</span>
<span class="cm"> * are paged. status_input is unpaged.</span>
<span class="cm"> */</span>
<span class="cp">#define PB_NUM_STATUS_REG	(PMBUS_PAGES * 6 + 1)</span>

<span class="cm">/*</span>
<span class="cm"> * Index into status register array, per status register group</span>
<span class="cm"> */</span>
<span class="cp">#define PB_STATUS_BASE		0</span>
<span class="cp">#define PB_STATUS_VOUT_BASE	(PB_STATUS_BASE + PMBUS_PAGES)</span>
<span class="cp">#define PB_STATUS_IOUT_BASE	(PB_STATUS_VOUT_BASE + PMBUS_PAGES)</span>
<span class="cp">#define PB_STATUS_FAN_BASE	(PB_STATUS_IOUT_BASE + PMBUS_PAGES)</span>
<span class="cp">#define PB_STATUS_FAN34_BASE	(PB_STATUS_FAN_BASE + PMBUS_PAGES)</span>
<span class="cp">#define PB_STATUS_INPUT_BASE	(PB_STATUS_FAN34_BASE + PMBUS_PAGES)</span>
<span class="cp">#define PB_STATUS_TEMP_BASE	(PB_STATUS_INPUT_BASE + 1)</span>

<span class="cp">#define PMBUS_NAME_SIZE		24</span>

<span class="k">struct</span> <span class="n">pmbus_sensor</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">PMBUS_NAME_SIZE</span><span class="p">];</span>	<span class="cm">/* sysfs sensor name */</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="n">attribute</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">page</span><span class="p">;</span>		<span class="cm">/* page number */</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>		<span class="cm">/* register */</span>
	<span class="k">enum</span> <span class="n">pmbus_sensor_classes</span> <span class="n">class</span><span class="p">;</span>	<span class="cm">/* sensor class */</span>
	<span class="n">bool</span> <span class="n">update</span><span class="p">;</span>		<span class="cm">/* runtime sensor update needed */</span>
	<span class="kt">int</span> <span class="n">data</span><span class="p">;</span>		<span class="cm">/* Sensor data.</span>
<span class="cm">				   Negative if there was a read error */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pmbus_boolean</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">PMBUS_NAME_SIZE</span><span class="p">];</span>	<span class="cm">/* sysfs boolean name */</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="n">attribute</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pmbus_label</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">PMBUS_NAME_SIZE</span><span class="p">];</span>	<span class="cm">/* sysfs label name */</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="n">attribute</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">label</span><span class="p">[</span><span class="n">PMBUS_NAME_SIZE</span><span class="p">];</span>	<span class="cm">/* label */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pmbus_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">hwmon_dev</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>		<span class="cm">/* from platform data */</span>

	<span class="kt">int</span> <span class="n">exponent</span><span class="p">;</span>		<span class="cm">/* linear mode: exponent for output voltages */</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_driver_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">max_attributes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_attributes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">attribute</span> <span class="o">**</span><span class="n">attributes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">group</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sensors cover both sensor and limit registers.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">max_sensors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_sensors</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmbus_sensor</span> <span class="o">*</span><span class="n">sensors</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Booleans are used for alarms.</span>
<span class="cm">	 * Values are determined from status registers.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">max_booleans</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_booleans</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmbus_boolean</span> <span class="o">*</span><span class="n">booleans</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Labels are used to map generic names (e.g., &quot;in1&quot;)</span>
<span class="cm">	 * to PMBus specific names (e.g., &quot;vin&quot; or &quot;vout1&quot;).</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">max_labels</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_labels</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmbus_label</span> <span class="o">*</span><span class="n">labels</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">update_lock</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">valid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_updated</span><span class="p">;</span>	<span class="cm">/* in jiffies */</span>

	<span class="cm">/*</span>
<span class="cm">	 * A single status register covers multiple attributes,</span>
<span class="cm">	 * so we keep them all together.</span>
<span class="cm">	 */</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">[</span><span class="n">PB_NUM_STATUS_REG</span><span class="p">];</span>

	<span class="n">u8</span> <span class="n">currpage</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">pmbus_set_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">newpage</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">currpage</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">PMBUS_PAGE</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
		<span class="n">newpage</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">PMBUS_PAGE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newpage</span> <span class="o">!=</span> <span class="n">page</span><span class="p">)</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">currpage</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmbus_set_page</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">pmbus_write_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">pmbus_set_page</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i2c_smbus_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmbus_write_byte</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * _pmbus_write_byte() is similar to pmbus_write_byte(), but checks if</span>
<span class="cm"> * a device specific mapping funcion exists and calls it if necessary.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_pmbus_write_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_driver_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pmbus_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">pmbus_write_word_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">page</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">word</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">pmbus_set_page</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i2c_smbus_write_word_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmbus_write_word_data</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * _pmbus_write_word_data() is similar to pmbus_write_word_data(), but checks if</span>
<span class="cm"> * a device specific mapping function exists and calls it if necessary.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_pmbus_write_word_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="n">word</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_driver_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">write_word_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">write_word_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">PMBUS_VIRT_BASE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pmbus_write_word_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">pmbus_read_word_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">page</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">pmbus_set_page</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i2c_smbus_read_word_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmbus_read_word_data</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * _pmbus_read_word_data() is similar to pmbus_read_word_data(), but checks if</span>
<span class="cm"> * a device specific mapping function exists and calls it if necessary.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_pmbus_read_word_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_driver_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">read_word_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">read_word_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">PMBUS_VIRT_BASE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pmbus_read_word_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">pmbus_read_byte_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">pmbus_set_page</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmbus_read_byte_data</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * _pmbus_read_byte_data() is similar to pmbus_read_byte_data(), but checks if</span>
<span class="cm"> * a device specific mapping function exists and calls it if necessary.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_pmbus_read_byte_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_driver_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">read_byte_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pmbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmbus_clear_fault_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_pmbus_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">PMBUS_CLEAR_FAULTS</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pmbus_clear_faults</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pmbus_clear_fault_page</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmbus_clear_faults</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmbus_check_status_cml</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">status2</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">_pmbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">PMBUS_STATUS_BYTE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PB_STATUS_CML</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status2</span> <span class="o">=</span> <span class="n">_pmbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">PMBUS_STATUS_CML</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status2</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="n">PB_CML_FAULT_INVALID_COMMAND</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">pmbus_check_byte_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">_pmbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PMBUS_SKIP_STATUS_CHECK</span><span class="p">))</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">pmbus_check_status_cml</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">pmbus_clear_fault_page</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmbus_check_byte_register</span><span class="p">);</span>

<span class="n">bool</span> <span class="nf">pmbus_check_word_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">_pmbus_read_word_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PMBUS_SKIP_STATUS_CHECK</span><span class="p">))</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">pmbus_check_status_cml</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">pmbus_clear_fault_page</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmbus_check_word_register</span><span class="p">);</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_driver_info</span> <span class="o">*</span><span class="nf">pmbus_get_driver_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmbus_get_driver_info</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="nf">pmbus_update_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_driver_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">last_updated</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">PB_STATUS_BASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>
			    <span class="o">=</span> <span class="n">_pmbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						    <span class="n">PMBUS_STATUS_BYTE</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PMBUS_HAVE_STATUS_VOUT</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">PB_STATUS_VOUT_BASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>
			  <span class="o">=</span> <span class="n">_pmbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">PMBUS_STATUS_VOUT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PMBUS_HAVE_STATUS_IOUT</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">PB_STATUS_IOUT_BASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>
			  <span class="o">=</span> <span class="n">_pmbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">PMBUS_STATUS_IOUT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PMBUS_HAVE_STATUS_TEMP</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">PB_STATUS_TEMP_BASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>
			  <span class="o">=</span> <span class="n">_pmbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						  <span class="n">PMBUS_STATUS_TEMPERATURE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PMBUS_HAVE_STATUS_FAN12</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">PB_STATUS_FAN_BASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>
			  <span class="o">=</span> <span class="n">_pmbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						  <span class="n">PMBUS_STATUS_FAN_12</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PMBUS_HAVE_STATUS_FAN34</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">PB_STATUS_FAN34_BASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>
			  <span class="o">=</span> <span class="n">_pmbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						  <span class="n">PMBUS_STATUS_FAN_34</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PMBUS_HAVE_STATUS_INPUT</span><span class="p">)</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">PB_STATUS_INPUT_BASE</span><span class="p">]</span>
			  <span class="o">=</span> <span class="n">_pmbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						  <span class="n">PMBUS_STATUS_INPUT</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">num_sensors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">pmbus_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sensors</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">||</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">)</span>
				<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">data</span>
				    <span class="o">=</span> <span class="n">_pmbus_read_word_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
							    <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">,</span>
							    <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pmbus_clear_faults</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">last_updated</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert linear sensor values to milli- or micro-units</span>
<span class="cm"> * depending on sensor type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">pmbus_reg2data_linear</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">pmbus_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s16</span> <span class="n">exponent</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">mantissa</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">PSC_VOLTAGE_OUT</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* LINEAR16 */</span>
		<span class="n">exponent</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">exponent</span><span class="p">;</span>
		<span class="n">mantissa</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>				<span class="cm">/* LINEAR11 */</span>
		<span class="n">exponent</span> <span class="o">=</span> <span class="p">((</span><span class="n">s16</span><span class="p">)</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">mantissa</span> <span class="o">=</span> <span class="p">((</span><span class="n">s16</span><span class="p">)((</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">mantissa</span><span class="p">;</span>

	<span class="cm">/* scale result to milli-units for all sensors except fans */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">!=</span> <span class="n">PSC_FAN</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="mi">1000L</span><span class="p">;</span>

	<span class="cm">/* scale result to micro-units for power sensors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">PSC_POWER</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="mi">1000L</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">exponent</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">&lt;&lt;=</span> <span class="n">exponent</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&gt;&gt;=</span> <span class="o">-</span><span class="n">exponent</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert direct sensor values to milli- or micro-units</span>
<span class="cm"> * depending on sensor type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">pmbus_reg2data_direct</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">pmbus_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">m</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">R</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">[</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">];</span>
	<span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">[</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">];</span>
	<span class="n">R</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">R</span><span class="p">[</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* X = 1/m * (Y * 10^-R - b) */</span>
	<span class="n">R</span> <span class="o">=</span> <span class="o">-</span><span class="n">R</span><span class="p">;</span>
	<span class="cm">/* scale result to milli-units for everything but fans */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">!=</span> <span class="n">PSC_FAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">R</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">b</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* scale result to micro-units for power sensors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">PSC_POWER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">R</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">b</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">R</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">R</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">R</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">R</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="n">m</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert VID sensor values to milli- or micro-units</span>
<span class="cm"> * depending on sensor type.</span>
<span class="cm"> * We currently only support VR11.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">pmbus_reg2data_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">pmbus_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mh">0x02</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mh">0xb2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span><span class="mi">160000</span> <span class="o">-</span> <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">625</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">pmbus_reg2data</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmbus_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">[</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">direct</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">pmbus_reg2data_direct</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sensor</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">vid</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">pmbus_reg2data_vid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sensor</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">linear</span>:
	<span class="nl">default:</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">pmbus_reg2data_linear</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sensor</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MAX_MANTISSA	(1023 * 1000)</span>
<span class="cp">#define MIN_MANTISSA	(511 * 1000)</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">pmbus_data2reg_linear</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">pmbus_sensor_classes</span> <span class="n">class</span><span class="p">,</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s16</span> <span class="n">exponent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mantissa</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">negative</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* simple case */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="n">PSC_VOLTAGE_OUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* LINEAR16 does not support negative voltages */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * For a static exponents, we don&#39;t have a choice</span>
<span class="cm">		 * but to adjust the value to it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">exponent</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">&lt;&lt;=</span> <span class="o">-</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">exponent</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">&gt;&gt;=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">exponent</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">negative</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Power is in uW. Convert to mW before converting. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="n">PSC_POWER</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">1000L</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For simplicity, convert fan data to milli-units</span>
<span class="cm">	 * before calculating the exponent.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="n">PSC_FAN</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="cm">/* Reduce large mantissa until it fits into 10 bit */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">MAX_MANTISSA</span> <span class="o">&amp;&amp;</span> <span class="n">exponent</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">exponent</span><span class="o">++</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Increase small mantissa to improve precision */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">MIN_MANTISSA</span> <span class="o">&amp;&amp;</span> <span class="n">exponent</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">exponent</span><span class="o">--</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Convert mantissa from milli-units to units */</span>
	<span class="n">mantissa</span> <span class="o">=</span> <span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/* Ensure that resulting number is within range */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mantissa</span> <span class="o">&gt;</span> <span class="mh">0x3ff</span><span class="p">)</span>
		<span class="n">mantissa</span> <span class="o">=</span> <span class="mh">0x3ff</span><span class="p">;</span>

	<span class="cm">/* restore sign */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">negative</span><span class="p">)</span>
		<span class="n">mantissa</span> <span class="o">=</span> <span class="o">-</span><span class="n">mantissa</span><span class="p">;</span>

	<span class="cm">/* Convert to 5 bit exponent, 11 bit mantissa */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">mantissa</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">exponent</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">pmbus_data2reg_direct</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">pmbus_sensor_classes</span> <span class="n">class</span><span class="p">,</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">m</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">R</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">[</span><span class="n">class</span><span class="p">];</span>
	<span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">[</span><span class="n">class</span><span class="p">];</span>
	<span class="n">R</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">R</span><span class="p">[</span><span class="n">class</span><span class="p">];</span>

	<span class="cm">/* Power is in uW. Adjust R and b. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="n">PSC_POWER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">R</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">b</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate Y = (m * X + b) * 10^R */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">!=</span> <span class="n">PSC_FAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">R</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>		<span class="cm">/* Adjust R and b for data in milli-units */</span>
		<span class="n">b</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="n">m</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">R</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">R</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">R</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">R</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">pmbus_data2reg_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">pmbus_sensor_classes</span> <span class="n">class</span><span class="p">,</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1600</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">DIV_ROUND_CLOSEST</span><span class="p">((</span><span class="mi">1600</span> <span class="o">-</span> <span class="n">val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">625</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">pmbus_data2reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">pmbus_sensor_classes</span> <span class="n">class</span><span class="p">,</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">regval</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">[</span><span class="n">class</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">direct</span>:
		<span class="n">regval</span> <span class="o">=</span> <span class="n">pmbus_data2reg_direct</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">vid</span>:
		<span class="n">regval</span> <span class="o">=</span> <span class="n">pmbus_data2reg_vid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">linear</span>:
	<span class="nl">default:</span>
		<span class="n">regval</span> <span class="o">=</span> <span class="n">pmbus_data2reg_linear</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">regval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return boolean calculated from converted data.</span>
<span class="cm"> * &lt;index&gt; defines a status register index and mask, and optionally</span>
<span class="cm"> * two sensor indexes.</span>
<span class="cm"> * The upper half-word references the two sensors,</span>
<span class="cm"> * two sensor indices.</span>
<span class="cm"> * The upper half-word references the two optional sensors,</span>
<span class="cm"> * the lower half word references status register and mask.</span>
<span class="cm"> * The function returns true if (status[reg] &amp; mask) is true and,</span>
<span class="cm"> * if specified, if v1 &gt;= v2.</span>
<span class="cm"> * To determine if an object exceeds upper limits, specify &lt;v, limit&gt;.</span>
<span class="cm"> * To determine if an object exceeds lower limits, specify &lt;limit, v&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * For booleans created with pmbus_add_boolean_reg(), only the lower 16 bits of</span>
<span class="cm"> * index are set. s1 and s2 (the sensor index values) are zero in this case.</span>
<span class="cm"> * The function returns true if (status[reg] &amp; mask) is true.</span>
<span class="cm"> *</span>
<span class="cm"> * If the boolean was created with pmbus_add_boolean_cmp(), a comparison against</span>
<span class="cm"> * a specified limit has to be performed to determine the boolean result.</span>
<span class="cm"> * In this case, the function returns true if v1 &gt;= v2 (where v1 and v2 are</span>
<span class="cm"> * sensor values referenced by sensor indices s1 and s2).</span>
<span class="cm"> *</span>
<span class="cm"> * To determine if an object exceeds upper limits, specify &lt;s1,s2&gt; = &lt;v,limit&gt;.</span>
<span class="cm"> * To determine if an object exceeds lower limits, specify &lt;s1,s2&gt; = &lt;limit,v&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * If a negative value is stored in any of the referenced registers, this value</span>
<span class="cm"> * reflects an error code which will be returned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmbus_get_boolean</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">s1</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">s2</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">index</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">regval</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">reg</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">regval</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">s2</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">!!</span><span class="n">regval</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">long</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">pmbus_sensor</span> <span class="o">*</span><span class="n">sensor1</span><span class="p">,</span> <span class="o">*</span><span class="n">sensor2</span><span class="p">;</span>

		<span class="n">sensor1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sensors</span><span class="p">[</span><span class="n">s1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sensor1</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">sensor1</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">sensor2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sensors</span><span class="p">[</span><span class="n">s2</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sensor2</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">sensor2</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="n">v1</span> <span class="o">=</span> <span class="n">pmbus_reg2data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sensor1</span><span class="p">);</span>
		<span class="n">v2</span> <span class="o">=</span> <span class="n">pmbus_reg2data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sensor2</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">regval</span> <span class="o">&amp;&amp;</span> <span class="n">v1</span> <span class="o">&gt;=</span> <span class="n">v2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pmbus_show_boolean</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">da</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">da</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">pmbus_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">pmbus_get_boolean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pmbus_show_sensor</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">da</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">da</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">pmbus_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmbus_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">;</span>

	<span class="n">sensor</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sensors</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pmbus_reg2data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sensor</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pmbus_set_sensor</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmbus_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sensors</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="kt">ssize_t</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">regval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">regval</span> <span class="o">=</span> <span class="n">pmbus_data2reg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">_pmbus_write_word_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">sensors</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">regval</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pmbus_show_label</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">da</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">da</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">labels</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">label</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PMBUS_ADD_ATTR(data, _name, _idx, _mode, _type, _show, _set)	\</span>
<span class="cp">do {									\</span>
<span class="cp">	struct sensor_device_attribute *a				\</span>
<span class="cp">	    = &amp;data-&gt;_type##s[data-&gt;num_##_type##s].attribute;		\</span>
<span class="cp">	BUG_ON(data-&gt;num_attributes &gt;= data-&gt;max_attributes);		\</span>
<span class="cp">	sysfs_attr_init(&amp;a-&gt;dev_attr.attr);				\</span>
<span class="cp">	a-&gt;dev_attr.attr.name = _name;					\</span>
<span class="cp">	a-&gt;dev_attr.attr.mode = _mode;					\</span>
<span class="cp">	a-&gt;dev_attr.show = _show;					\</span>
<span class="cp">	a-&gt;dev_attr.store = _set;					\</span>
<span class="cp">	a-&gt;index = _idx;						\</span>
<span class="cp">	data-&gt;attributes[data-&gt;num_attributes] = &amp;a-&gt;dev_attr.attr;	\</span>
<span class="cp">	data-&gt;num_attributes++;						\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define PMBUS_ADD_GET_ATTR(data, _name, _type, _idx)			\</span>
<span class="cp">	PMBUS_ADD_ATTR(data, _name, _idx, S_IRUGO, _type,		\</span>
<span class="cp">		       pmbus_show_##_type,  NULL)</span>

<span class="cp">#define PMBUS_ADD_SET_ATTR(data, _name, _type, _idx)			\</span>
<span class="cp">	PMBUS_ADD_ATTR(data, _name, _idx, S_IWUSR | S_IRUGO, _type,	\</span>
<span class="cp">		       pmbus_show_##_type, pmbus_set_##_type)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmbus_add_boolean</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seq</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmbus_boolean</span> <span class="o">*</span><span class="n">boolean</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">num_booleans</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">max_booleans</span><span class="p">);</span>

	<span class="n">boolean</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">booleans</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">num_booleans</span><span class="p">];</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">boolean</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">boolean</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s%d_%s&quot;</span><span class="p">,</span>
		 <span class="n">name</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">PMBUS_ADD_GET_ATTR</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">boolean</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">boolean</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">num_booleans</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmbus_add_boolean_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">seq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pmbus_add_boolean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">bit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmbus_add_boolean_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">seq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pmbus_add_boolean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">i1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">i2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmbus_add_sensor</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seq</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pmbus_sensor_classes</span> <span class="n">class</span><span class="p">,</span>
			     <span class="n">bool</span> <span class="n">update</span><span class="p">,</span> <span class="n">bool</span> <span class="n">readonly</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmbus_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">num_sensors</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">max_sensors</span><span class="p">);</span>

	<span class="n">sensor</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sensors</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">num_sensors</span><span class="p">];</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s%d_%s&quot;</span><span class="p">,</span>
		 <span class="n">name</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">class</span><span class="p">;</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">=</span> <span class="n">update</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readonly</span><span class="p">)</span>
		<span class="n">PMBUS_ADD_GET_ATTR</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sensor</span><span class="p">,</span>
				   <span class="n">data</span><span class="o">-&gt;</span><span class="n">num_sensors</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">PMBUS_ADD_SET_ATTR</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sensor</span><span class="p">,</span>
				   <span class="n">data</span><span class="o">-&gt;</span><span class="n">num_sensors</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">num_sensors</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmbus_add_label</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seq</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">lstring</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmbus_label</span> <span class="o">*</span><span class="n">label</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">num_labels</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">max_labels</span><span class="p">);</span>

	<span class="n">label</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">labels</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">num_labels</span><span class="p">];</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">label</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">label</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s%d_label&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">seq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">index</span><span class="p">)</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">label</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">,</span> <span class="n">lstring</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">label</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">label</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">label</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">),</span> <span class="s">&quot;%s%d&quot;</span><span class="p">,</span> <span class="n">lstring</span><span class="p">,</span>
			 <span class="n">index</span><span class="p">);</span>

	<span class="n">PMBUS_ADD_GET_ATTR</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">num_labels</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">num_labels</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Determine maximum number of sensors, booleans, and labels.</span>
<span class="cm"> * To keep things simple, only make a rough high estimate.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmbus_find_max_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_driver_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="n">max_sensors</span><span class="p">,</span> <span class="n">max_booleans</span><span class="p">,</span> <span class="n">max_labels</span><span class="p">;</span>

	<span class="n">max_sensors</span> <span class="o">=</span> <span class="n">PMBUS_MAX_INPUT_SENSORS</span><span class="p">;</span>
	<span class="n">max_booleans</span> <span class="o">=</span> <span class="n">PMBUS_MAX_INPUT_BOOLEANS</span><span class="p">;</span>
	<span class="n">max_labels</span> <span class="o">=</span> <span class="n">PMBUS_MAX_INPUT_LABELS</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span> <span class="n">page</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="n">page</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PMBUS_HAVE_VOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max_sensors</span> <span class="o">+=</span> <span class="n">PMBUS_VOUT_SENSORS_PER_PAGE</span><span class="p">;</span>
			<span class="n">max_booleans</span> <span class="o">+=</span> <span class="n">PMBUS_VOUT_BOOLEANS_PER_PAGE</span><span class="p">;</span>
			<span class="n">max_labels</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="n">page</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PMBUS_HAVE_IOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max_sensors</span> <span class="o">+=</span> <span class="n">PMBUS_IOUT_SENSORS_PER_PAGE</span><span class="p">;</span>
			<span class="n">max_booleans</span> <span class="o">+=</span> <span class="n">PMBUS_IOUT_BOOLEANS_PER_PAGE</span><span class="p">;</span>
			<span class="n">max_labels</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="n">page</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PMBUS_HAVE_POUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max_sensors</span> <span class="o">+=</span> <span class="n">PMBUS_POUT_SENSORS_PER_PAGE</span><span class="p">;</span>
			<span class="n">max_booleans</span> <span class="o">+=</span> <span class="n">PMBUS_POUT_BOOLEANS_PER_PAGE</span><span class="p">;</span>
			<span class="n">max_labels</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="n">page</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PMBUS_HAVE_FAN12</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max_sensors</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PMBUS_MAX_SENSORS_PER_FAN</span><span class="p">;</span>
			<span class="n">max_booleans</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PMBUS_MAX_BOOLEANS_PER_FAN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="n">page</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PMBUS_HAVE_FAN34</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max_sensors</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PMBUS_MAX_SENSORS_PER_FAN</span><span class="p">;</span>
			<span class="n">max_booleans</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PMBUS_MAX_BOOLEANS_PER_FAN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="n">page</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PMBUS_HAVE_TEMP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max_sensors</span> <span class="o">+=</span> <span class="n">PMBUS_MAX_SENSORS_PER_TEMP</span><span class="p">;</span>
			<span class="n">max_booleans</span> <span class="o">+=</span> <span class="n">PMBUS_MAX_BOOLEANS_PER_TEMP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="n">page</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PMBUS_HAVE_TEMP2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max_sensors</span> <span class="o">+=</span> <span class="n">PMBUS_MAX_SENSORS_PER_TEMP</span><span class="p">;</span>
			<span class="n">max_booleans</span> <span class="o">+=</span> <span class="n">PMBUS_MAX_BOOLEANS_PER_TEMP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="n">page</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PMBUS_HAVE_TEMP3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max_sensors</span> <span class="o">+=</span> <span class="n">PMBUS_MAX_SENSORS_PER_TEMP</span><span class="p">;</span>
			<span class="n">max_booleans</span> <span class="o">+=</span> <span class="n">PMBUS_MAX_BOOLEANS_PER_TEMP</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">max_sensors</span> <span class="o">=</span> <span class="n">max_sensors</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">max_booleans</span> <span class="o">=</span> <span class="n">max_booleans</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">max_labels</span> <span class="o">=</span> <span class="n">max_labels</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">max_attributes</span> <span class="o">=</span> <span class="n">max_sensors</span> <span class="o">+</span> <span class="n">max_booleans</span> <span class="o">+</span> <span class="n">max_labels</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Search for attributes. Allocate sensors, booleans, and labels as needed.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The pmbus_limit_attr structure describes a single limit attribute</span>
<span class="cm"> * and its associated alarm attribute.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pmbus_limit_attr</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>		<span class="cm">/* Limit register */</span>
	<span class="n">bool</span> <span class="n">update</span><span class="p">;</span>		<span class="cm">/* True if register needs updates */</span>
	<span class="n">bool</span> <span class="n">low</span><span class="p">;</span>		<span class="cm">/* True if low limit; for limits with compare</span>
<span class="cm">				   functions only */</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>	<span class="cm">/* Attribute name */</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alarm</span><span class="p">;</span>	<span class="cm">/* Alarm attribute name */</span>
	<span class="n">u32</span> <span class="n">sbit</span><span class="p">;</span>		<span class="cm">/* Alarm attribute status bit */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The pmbus_sensor_attr structure describes one sensor attribute. This</span>
<span class="cm"> * description includes a reference to the associated limit attributes.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pmbus_sensor_attr</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>				<span class="cm">/* sensor register */</span>
	<span class="k">enum</span> <span class="n">pmbus_sensor_classes</span> <span class="n">class</span><span class="p">;</span><span class="cm">/* sensor class */</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">;</span>		<span class="cm">/* sensor label */</span>
	<span class="n">bool</span> <span class="n">paged</span><span class="p">;</span>			<span class="cm">/* true if paged sensor */</span>
	<span class="n">bool</span> <span class="n">update</span><span class="p">;</span>			<span class="cm">/* true if update needed */</span>
	<span class="n">bool</span> <span class="n">compare</span><span class="p">;</span>			<span class="cm">/* true if compare function needed */</span>
	<span class="n">u32</span> <span class="n">func</span><span class="p">;</span>			<span class="cm">/* sensor mask */</span>
	<span class="n">u32</span> <span class="n">sfunc</span><span class="p">;</span>			<span class="cm">/* sensor status mask */</span>
	<span class="kt">int</span> <span class="n">sbase</span><span class="p">;</span>			<span class="cm">/* status base register */</span>
	<span class="n">u32</span> <span class="n">gbit</span><span class="p">;</span>			<span class="cm">/* generic status bit */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_limit_attr</span> <span class="o">*</span><span class="n">limit</span><span class="p">;</span><span class="cm">/* limit registers */</span>
	<span class="kt">int</span> <span class="n">nlimit</span><span class="p">;</span>			<span class="cm">/* # of limit registers */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Add a set of limit attributes and, if supported, the associated</span>
<span class="cm"> * alarm attributes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">pmbus_add_limit_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_driver_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">cbase</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_sensor_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_limit_attr</span> <span class="o">*</span><span class="n">l</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nlimit</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">nlimit</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">have_alarm</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cindex</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nlimit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmbus_check_word_register</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cindex</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">num_sensors</span><span class="p">;</span>
			<span class="n">pmbus_add_sensor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span>
					 <span class="n">l</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">,</span>
					 <span class="n">attr</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">||</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">,</span>
					 <span class="nb">false</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">sbit</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="n">page</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">sfunc</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">compare</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pmbus_add_boolean_cmp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
						<span class="n">l</span><span class="o">-&gt;</span><span class="n">alarm</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
						<span class="n">l</span><span class="o">-&gt;</span><span class="n">low</span> <span class="o">?</span> <span class="n">cindex</span> <span class="o">:</span> <span class="n">cbase</span><span class="p">,</span>
						<span class="n">l</span><span class="o">-&gt;</span><span class="n">low</span> <span class="o">?</span> <span class="n">cbase</span> <span class="o">:</span> <span class="n">cindex</span><span class="p">,</span>
						<span class="n">attr</span><span class="o">-&gt;</span><span class="n">sbase</span> <span class="o">+</span> <span class="n">page</span><span class="p">,</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">sbit</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">pmbus_add_boolean_reg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
						<span class="n">l</span><span class="o">-&gt;</span><span class="n">alarm</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
						<span class="n">attr</span><span class="o">-&gt;</span><span class="n">sbase</span> <span class="o">+</span> <span class="n">page</span><span class="p">,</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">sbit</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">have_alarm</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">l</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">have_alarm</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmbus_add_sensor_attrs_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_driver_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_sensor_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">have_alarm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cbase</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">num_sensors</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">)</span>
		<span class="n">pmbus_add_label</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">,</span>
				<span class="n">attr</span><span class="o">-&gt;</span><span class="n">paged</span> <span class="o">?</span> <span class="n">page</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmbus_add_sensor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span>
			 <span class="n">attr</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">sfunc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">have_alarm</span> <span class="o">=</span> <span class="n">pmbus_add_limit_attrs</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
						   <span class="n">index</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">cbase</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Add generic alarm attribute only if there are no individual</span>
<span class="cm">		 * alarm attributes, if there is a global alarm bit, and if</span>
<span class="cm">		 * the generic status register for this page is accessible.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">have_alarm</span> <span class="o">&amp;&amp;</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">gbit</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pmbus_check_byte_register</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">PMBUS_STATUS_BYTE</span><span class="p">))</span>
			<span class="n">pmbus_add_boolean_reg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s">&quot;alarm&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
					      <span class="n">PB_STATUS_BASE</span> <span class="o">+</span> <span class="n">page</span><span class="p">,</span>
					      <span class="n">attr</span><span class="o">-&gt;</span><span class="n">gbit</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmbus_add_sensor_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_sensor_attr</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">nattrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_driver_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nattrs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="n">pages</span><span class="p">;</span>

		<span class="n">pages</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">paged</span> <span class="o">?</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">pages</span><span class="p">;</span> <span class="n">page</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="n">page</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">pmbus_add_sensor_attrs_one</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
						   <span class="n">index</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">attrs</span><span class="p">);</span>
			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">attrs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_limit_attr</span> <span class="n">vin_limit_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIN_UV_WARN_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;min&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;min_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_VOLTAGE_UV_WARNING</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIN_UV_FAULT_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;lcrit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;lcrit_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_VOLTAGE_UV_FAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIN_OV_WARN_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;max&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;max_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_VOLTAGE_OV_WARNING</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIN_OV_FAULT_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;crit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;crit_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_VOLTAGE_OV_FAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_VIN_AVG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;average&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_VIN_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;lowest&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_VIN_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;highest&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_RESET_VIN_HISTORY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;reset_history&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_limit_attr</span> <span class="n">vout_limit_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VOUT_UV_WARN_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;min&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;min_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_VOLTAGE_UV_WARNING</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VOUT_UV_FAULT_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;lcrit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;lcrit_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_VOLTAGE_UV_FAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VOUT_OV_WARN_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;max&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;max_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_VOLTAGE_OV_WARNING</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VOUT_OV_FAULT_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;crit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;crit_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_VOLTAGE_OV_FAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_VOUT_AVG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;average&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_VOUT_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;lowest&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_VOUT_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;highest&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_RESET_VOUT_HISTORY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;reset_history&quot;</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_sensor_attr</span> <span class="n">voltage_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_READ_VIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">PSC_VOLTAGE_IN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">label</span> <span class="o">=</span> <span class="s">&quot;vin&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">PMBUS_HAVE_VIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sfunc</span> <span class="o">=</span> <span class="n">PMBUS_HAVE_STATUS_INPUT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbase</span> <span class="o">=</span> <span class="n">PB_STATUS_INPUT_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gbit</span> <span class="o">=</span> <span class="n">PB_STATUS_VIN_UV</span><span class="p">,</span>
		<span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">vin_limit_attrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nlimit</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vin_limit_attrs</span><span class="p">),</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_READ_VCAP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">PSC_VOLTAGE_IN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">label</span> <span class="o">=</span> <span class="s">&quot;vcap&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">PMBUS_HAVE_VCAP</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_READ_VOUT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">PSC_VOLTAGE_OUT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">label</span> <span class="o">=</span> <span class="s">&quot;vout&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">paged</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">PMBUS_HAVE_VOUT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sfunc</span> <span class="o">=</span> <span class="n">PMBUS_HAVE_STATUS_VOUT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbase</span> <span class="o">=</span> <span class="n">PB_STATUS_VOUT_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gbit</span> <span class="o">=</span> <span class="n">PB_STATUS_VOUT_OV</span><span class="p">,</span>
		<span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">vout_limit_attrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nlimit</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vout_limit_attrs</span><span class="p">),</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Current attributes */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_limit_attr</span> <span class="n">iin_limit_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_IIN_OC_WARN_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;max&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;max_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_IIN_OC_WARNING</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_IIN_OC_FAULT_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;crit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;crit_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_IIN_OC_FAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_IIN_AVG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;average&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_IIN_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;lowest&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_IIN_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;highest&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_RESET_IIN_HISTORY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;reset_history&quot;</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_limit_attr</span> <span class="n">iout_limit_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_IOUT_OC_WARN_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;max&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;max_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_IOUT_OC_WARNING</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_IOUT_UC_FAULT_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;lcrit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;lcrit_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_IOUT_UC_FAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_IOUT_OC_FAULT_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;crit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;crit_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_IOUT_OC_FAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_IOUT_AVG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;average&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_IOUT_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;lowest&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_IOUT_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;highest&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_RESET_IOUT_HISTORY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;reset_history&quot;</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_sensor_attr</span> <span class="n">current_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_READ_IIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">PSC_CURRENT_IN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">label</span> <span class="o">=</span> <span class="s">&quot;iin&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">PMBUS_HAVE_IIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sfunc</span> <span class="o">=</span> <span class="n">PMBUS_HAVE_STATUS_INPUT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbase</span> <span class="o">=</span> <span class="n">PB_STATUS_INPUT_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">iin_limit_attrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nlimit</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">iin_limit_attrs</span><span class="p">),</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_READ_IOUT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">PSC_CURRENT_OUT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">label</span> <span class="o">=</span> <span class="s">&quot;iout&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">paged</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">PMBUS_HAVE_IOUT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sfunc</span> <span class="o">=</span> <span class="n">PMBUS_HAVE_STATUS_IOUT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbase</span> <span class="o">=</span> <span class="n">PB_STATUS_IOUT_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gbit</span> <span class="o">=</span> <span class="n">PB_STATUS_IOUT_OC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">iout_limit_attrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nlimit</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">iout_limit_attrs</span><span class="p">),</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Power attributes */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_limit_attr</span> <span class="n">pin_limit_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_PIN_OP_WARN_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;max&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_PIN_OP_WARNING</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_PIN_AVG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;average&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_PIN_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;input_highest&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_RESET_PIN_HISTORY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;reset_history&quot;</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_limit_attr</span> <span class="n">pout_limit_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_POUT_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;cap&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;cap_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_POWER_LIMITING</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_POUT_OP_WARN_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;max&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;max_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_POUT_OP_WARNING</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_POUT_OP_FAULT_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;crit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;crit_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_POUT_OP_FAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_POUT_AVG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;average&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_POUT_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;input_highest&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_RESET_POUT_HISTORY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;reset_history&quot;</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_sensor_attr</span> <span class="n">power_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_READ_PIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">PSC_POWER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">label</span> <span class="o">=</span> <span class="s">&quot;pin&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">PMBUS_HAVE_PIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sfunc</span> <span class="o">=</span> <span class="n">PMBUS_HAVE_STATUS_INPUT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbase</span> <span class="o">=</span> <span class="n">PB_STATUS_INPUT_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">pin_limit_attrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nlimit</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pin_limit_attrs</span><span class="p">),</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_READ_POUT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">PSC_POWER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">label</span> <span class="o">=</span> <span class="s">&quot;pout&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">paged</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">PMBUS_HAVE_POUT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sfunc</span> <span class="o">=</span> <span class="n">PMBUS_HAVE_STATUS_IOUT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbase</span> <span class="o">=</span> <span class="n">PB_STATUS_IOUT_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">pout_limit_attrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nlimit</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pout_limit_attrs</span><span class="p">),</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Temperature atributes */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_limit_attr</span> <span class="n">temp_limit_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_UT_WARN_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;min&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;min_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_TEMP_UT_WARNING</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_UT_FAULT_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;lcrit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;lcrit_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_TEMP_UT_FAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_OT_WARN_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;max&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;max_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_TEMP_OT_WARNING</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_OT_FAULT_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;crit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;crit_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_TEMP_OT_FAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_TEMP_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;lowest&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_TEMP_AVG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;average&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_TEMP_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;highest&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_RESET_TEMP_HISTORY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;reset_history&quot;</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_limit_attr</span> <span class="n">temp_limit_attrs2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_UT_WARN_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;min&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;min_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_TEMP_UT_WARNING</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_UT_FAULT_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;lcrit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;lcrit_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_TEMP_UT_FAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_OT_WARN_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;max&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;max_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_TEMP_OT_WARNING</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_OT_FAULT_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;crit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;crit_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_TEMP_OT_FAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_TEMP2_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;lowest&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_TEMP2_AVG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;average&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_READ_TEMP2_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;highest&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_VIRT_RESET_TEMP2_HISTORY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;reset_history&quot;</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_limit_attr</span> <span class="n">temp_limit_attrs3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_UT_WARN_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;min&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;min_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_TEMP_UT_WARNING</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_UT_FAULT_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;lcrit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;lcrit_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_TEMP_UT_FAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_OT_WARN_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;max&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;max_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_TEMP_OT_WARNING</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_OT_FAULT_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;crit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="s">&quot;crit_alarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">PB_TEMP_OT_FAULT</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_sensor_attr</span> <span class="n">temp_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_READ_TEMPERATURE_1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">PSC_TEMPERATURE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">paged</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">compare</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">PMBUS_HAVE_TEMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sfunc</span> <span class="o">=</span> <span class="n">PMBUS_HAVE_STATUS_TEMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbase</span> <span class="o">=</span> <span class="n">PB_STATUS_TEMP_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gbit</span> <span class="o">=</span> <span class="n">PB_STATUS_TEMPERATURE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">temp_limit_attrs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nlimit</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">temp_limit_attrs</span><span class="p">),</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_READ_TEMPERATURE_2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">PSC_TEMPERATURE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">paged</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">compare</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">PMBUS_HAVE_TEMP2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sfunc</span> <span class="o">=</span> <span class="n">PMBUS_HAVE_STATUS_TEMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbase</span> <span class="o">=</span> <span class="n">PB_STATUS_TEMP_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gbit</span> <span class="o">=</span> <span class="n">PB_STATUS_TEMPERATURE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">temp_limit_attrs2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nlimit</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">temp_limit_attrs2</span><span class="p">),</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PMBUS_READ_TEMPERATURE_3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">PSC_TEMPERATURE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">paged</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">compare</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">PMBUS_HAVE_TEMP3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sfunc</span> <span class="o">=</span> <span class="n">PMBUS_HAVE_STATUS_TEMP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sbase</span> <span class="o">=</span> <span class="n">PB_STATUS_TEMP_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gbit</span> <span class="o">=</span> <span class="n">PB_STATUS_TEMPERATURE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">temp_limit_attrs3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nlimit</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">temp_limit_attrs3</span><span class="p">),</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">pmbus_fan_registers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PMBUS_READ_FAN_SPEED_1</span><span class="p">,</span>
	<span class="n">PMBUS_READ_FAN_SPEED_2</span><span class="p">,</span>
	<span class="n">PMBUS_READ_FAN_SPEED_3</span><span class="p">,</span>
	<span class="n">PMBUS_READ_FAN_SPEED_4</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">pmbus_fan_config_registers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PMBUS_FAN_CONFIG_12</span><span class="p">,</span>
	<span class="n">PMBUS_FAN_CONFIG_12</span><span class="p">,</span>
	<span class="n">PMBUS_FAN_CONFIG_34</span><span class="p">,</span>
	<span class="n">PMBUS_FAN_CONFIG_34</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">pmbus_fan_status_registers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PMBUS_STATUS_FAN_12</span><span class="p">,</span>
	<span class="n">PMBUS_STATUS_FAN_12</span><span class="p">,</span>
	<span class="n">PMBUS_STATUS_FAN_34</span><span class="p">,</span>
	<span class="n">PMBUS_STATUS_FAN_34</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">pmbus_fan_flags</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PMBUS_HAVE_FAN12</span><span class="p">,</span>
	<span class="n">PMBUS_HAVE_FAN12</span><span class="p">,</span>
	<span class="n">PMBUS_HAVE_FAN34</span><span class="p">,</span>
	<span class="n">PMBUS_HAVE_FAN34</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">pmbus_fan_status_flags</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PMBUS_HAVE_STATUS_FAN12</span><span class="p">,</span>
	<span class="n">PMBUS_HAVE_STATUS_FAN12</span><span class="p">,</span>
	<span class="n">PMBUS_HAVE_STATUS_FAN34</span><span class="p">,</span>
	<span class="n">PMBUS_HAVE_STATUS_FAN34</span>
<span class="p">};</span>

<span class="cm">/* Fans */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmbus_add_fan_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_driver_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">page</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span> <span class="n">page</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">f</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pmbus_fan_registers</span><span class="p">);</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">regval</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="n">page</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">pmbus_fan_flags</span><span class="p">[</span><span class="n">f</span><span class="p">]))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmbus_check_word_register</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span>
						       <span class="n">pmbus_fan_registers</span><span class="p">[</span><span class="n">f</span><span class="p">]))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Skip fan if not installed.</span>
<span class="cm">			 * Each fan configuration register covers multiple fans,</span>
<span class="cm">			 * so we have to do some magic.</span>
<span class="cm">			 */</span>
			<span class="n">regval</span> <span class="o">=</span> <span class="n">_pmbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span>
				<span class="n">pmbus_fan_config_registers</span><span class="p">[</span><span class="n">f</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">regval</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PB_FAN_1_INSTALLED</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">pmbus_add_sensor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;fan&quot;</span><span class="p">,</span> <span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span>
					 <span class="n">pmbus_fan_registers</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">PSC_FAN</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
					 <span class="nb">true</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Each fan status register covers multiple fans,</span>
<span class="cm">			 * so we have to do some magic.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">[</span><span class="n">page</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">pmbus_fan_status_flags</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			    <span class="n">pmbus_check_byte_register</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
					<span class="n">page</span><span class="p">,</span> <span class="n">pmbus_fan_status_registers</span><span class="p">[</span><span class="n">f</span><span class="p">]))</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">base</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* fan 3, 4 */</span>
					<span class="n">base</span> <span class="o">=</span> <span class="n">PB_STATUS_FAN34_BASE</span> <span class="o">+</span> <span class="n">page</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">base</span> <span class="o">=</span> <span class="n">PB_STATUS_FAN_BASE</span> <span class="o">+</span> <span class="n">page</span><span class="p">;</span>
				<span class="n">pmbus_add_boolean_reg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;fan&quot;</span><span class="p">,</span> <span class="s">&quot;alarm&quot;</span><span class="p">,</span>
					<span class="n">index</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span>
					<span class="n">PB_FAN_FAN1_WARNING</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>
				<span class="n">pmbus_add_boolean_reg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;fan&quot;</span><span class="p">,</span> <span class="s">&quot;fault&quot;</span><span class="p">,</span>
					<span class="n">index</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span>
					<span class="n">PB_FAN_FAN1_FAULT</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmbus_find_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Voltage sensors */</span>
	<span class="n">pmbus_add_sensor_attrs</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="s">&quot;in&quot;</span><span class="p">,</span> <span class="n">voltage_attributes</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">voltage_attributes</span><span class="p">));</span>

	<span class="cm">/* Current sensors */</span>
	<span class="n">pmbus_add_sensor_attrs</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="s">&quot;curr&quot;</span><span class="p">,</span> <span class="n">current_attributes</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">current_attributes</span><span class="p">));</span>

	<span class="cm">/* Power sensors */</span>
	<span class="n">pmbus_add_sensor_attrs</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="s">&quot;power&quot;</span><span class="p">,</span> <span class="n">power_attributes</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">power_attributes</span><span class="p">));</span>

	<span class="cm">/* Temperature sensors */</span>
	<span class="n">pmbus_add_sensor_attrs</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="s">&quot;temp&quot;</span><span class="p">,</span> <span class="n">temp_attributes</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">temp_attributes</span><span class="p">));</span>

	<span class="cm">/* Fans */</span>
	<span class="n">pmbus_add_fan_attributes</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Identify chip parameters.</span>
<span class="cm"> * This function is called for all chips.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmbus_identify_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vout_mode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmbus_check_byte_register</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PMBUS_VOUT_MODE</span><span class="p">))</span>
		<span class="n">vout_mode</span> <span class="o">=</span> <span class="n">_pmbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PMBUS_VOUT_MODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vout_mode</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">vout_mode</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Not all chips support the VOUT_MODE command,</span>
<span class="cm">		 * so a failure to read it is not an error.</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">vout_mode</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* linear mode      */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">[</span><span class="n">PSC_VOLTAGE_OUT</span><span class="p">]</span> <span class="o">!=</span> <span class="n">linear</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

			<span class="n">data</span><span class="o">-&gt;</span><span class="n">exponent</span> <span class="o">=</span> <span class="p">((</span><span class="n">s8</span><span class="p">)(</span><span class="n">vout_mode</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* VID mode         */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">[</span><span class="n">PSC_VOLTAGE_OUT</span><span class="p">]</span> <span class="o">!=</span> <span class="n">vid</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* direct mode      */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">[</span><span class="n">PSC_VOLTAGE_OUT</span><span class="p">]</span> <span class="o">!=</span> <span class="n">direct</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Determine maximum number of sensors, booleans, and labels */</span>
	<span class="n">pmbus_find_max_attr</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">pmbus_clear_fault_page</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">pmbus_do_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">pmbus_driver_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pmbus_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Missing chip information&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_WRITE_BYTE</span>
				     <span class="o">|</span> <span class="n">I2C_FUNC_SMBUS_BYTE_DATA</span>
				     <span class="o">|</span> <span class="n">I2C_FUNC_SMBUS_WORD_DATA</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No memory to allocate driver data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="cm">/* Bail out if PMBus status register does not exist. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">PMBUS_STATUS_BYTE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PMBus status register not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">pmbus_clear_faults</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">)(</span><span class="n">client</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Chip identification failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">&gt;</span> <span class="n">PMBUS_PAGES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Bad number of PMBus pages: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pmbus_identify_common</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to identify chip capabilities</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sensors</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmbus_sensor</span><span class="p">)</span>
				     <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">max_sensors</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sensors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No memory to allocate sensor data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">booleans</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmbus_boolean</span><span class="p">)</span>
				 <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">max_booleans</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">booleans</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No memory to allocate boolean data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">labels</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmbus_label</span><span class="p">)</span>
				    <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">max_labels</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">labels</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No memory to allocate label data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">attributes</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="p">)</span>
					<span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">max_attributes</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No memory to allocate attribute data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pmbus_find_attributes</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there are no attributes, something is wrong.</span>
<span class="cm">	 * Bail out instead of trying to register nothing.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">num_attributes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No attributes found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Register sysfs hooks */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to create sysfs entries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span> <span class="o">=</span> <span class="n">hwmon_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to register hwmon device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_hwmon_device_register</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_hwmon_device_register:</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmbus_do_probe</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">pmbus_do_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmbus_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmbus_do_remove</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Guenter Roeck&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;PMBus core driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
