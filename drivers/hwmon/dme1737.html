<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › hwmon › dme1737.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>dme1737.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * dme1737.c - Driver for the SMSC DME1737, Asus A8000, SMSC SCH311x, SCH5027,</span>
<span class="cm"> *             and SCH5127 Super-I/O chips integrated hardware monitoring</span>
<span class="cm"> *             features.</span>
<span class="cm"> * Copyright (c) 2007, 2008, 2009, 2010 Juerg Haefliger &lt;juergh@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is an I2C/ISA hybrid, meaning that it uses the I2C bus to access</span>
<span class="cm"> * the chip registers if a DME1737, A8000, or SCH5027 is found and the ISA bus</span>
<span class="cm"> * if a SCH311x or SCH5127 chip is found. Both types of chips have very</span>
<span class="cm"> * similar hardware monitoring capabilities but differ in the way they can be</span>
<span class="cm"> * accessed.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon-sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon-vid.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/acpi.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cm">/* ISA device, if found */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

<span class="cm">/* Module load parameters */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">force_start</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">force_start</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">force_start</span><span class="p">,</span> <span class="s">&quot;Force the chip to start monitoring inputs&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">force_id</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">force_id</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">force_id</span><span class="p">,</span> <span class="s">&quot;Override the detected device ID&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">probe_all_addr</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">probe_all_addr</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">probe_all_addr</span><span class="p">,</span> <span class="s">&quot;Include probing of non-standard LPC &quot;</span>
		 <span class="s">&quot;addresses&quot;</span><span class="p">);</span>

<span class="cm">/* Addresses to scan */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">normal_i2c</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="n">I2C_CLIENT_END</span><span class="p">};</span>

<span class="k">enum</span> <span class="n">chips</span> <span class="p">{</span> <span class="n">dme1737</span><span class="p">,</span> <span class="n">sch5027</span><span class="p">,</span> <span class="n">sch311x</span><span class="p">,</span> <span class="n">sch5127</span> <span class="p">};</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * Registers</span>
<span class="cm"> *</span>
<span class="cm"> * The sensors are defined as follows:</span>
<span class="cm"> *</span>
<span class="cm"> * Voltages                          Temperatures</span>
<span class="cm"> * --------                          ------------</span>
<span class="cm"> * in0   +5VTR (+5V stdby)           temp1   Remote diode 1</span>
<span class="cm"> * in1   Vccp  (proc core)           temp2   Internal temp</span>
<span class="cm"> * in2   VCC   (internal +3.3V)      temp3   Remote diode 2</span>
<span class="cm"> * in3   +5V</span>
<span class="cm"> * in4   +12V</span>
<span class="cm"> * in5   VTR   (+3.3V stby)</span>
<span class="cm"> * in6   Vbat</span>
<span class="cm"> * in7   Vtrip (sch5127 only)</span>
<span class="cm"> *</span>
<span class="cm"> * --------------------------------------------------------------------- */</span>

<span class="cm">/* Voltages (in) numbered 0-7 (ix) */</span>
<span class="cp">#define DME1737_REG_IN(ix)		((ix) &lt; 5 ? 0x20 + (ix) : \</span>
<span class="cp">					 (ix) &lt; 7 ? 0x94 + (ix) : \</span>
<span class="cp">						    0x1f)</span>
<span class="cp">#define DME1737_REG_IN_MIN(ix)		((ix) &lt; 5 ? 0x44 + (ix) * 2 \</span>
<span class="cp">						  : 0x91 + (ix) * 2)</span>
<span class="cp">#define DME1737_REG_IN_MAX(ix)		((ix) &lt; 5 ? 0x45 + (ix) * 2 \</span>
<span class="cp">						  : 0x92 + (ix) * 2)</span>

<span class="cm">/* Temperatures (temp) numbered 0-2 (ix) */</span>
<span class="cp">#define DME1737_REG_TEMP(ix)		(0x25 + (ix))</span>
<span class="cp">#define DME1737_REG_TEMP_MIN(ix)	(0x4e + (ix) * 2)</span>
<span class="cp">#define DME1737_REG_TEMP_MAX(ix)	(0x4f + (ix) * 2)</span>
<span class="cp">#define DME1737_REG_TEMP_OFFSET(ix)	((ix) == 0 ? 0x1f \</span>
<span class="cp">						   : 0x1c + (ix))</span>

<span class="cm">/*</span>
<span class="cm"> * Voltage and temperature LSBs</span>
<span class="cm"> * The LSBs (4 bits each) are stored in 5 registers with the following layouts:</span>
<span class="cm"> *    IN_TEMP_LSB(0) = [in5, in6]</span>
<span class="cm"> *    IN_TEMP_LSB(1) = [temp3, temp1]</span>
<span class="cm"> *    IN_TEMP_LSB(2) = [in4, temp2]</span>
<span class="cm"> *    IN_TEMP_LSB(3) = [in3, in0]</span>
<span class="cm"> *    IN_TEMP_LSB(4) = [in2, in1]</span>
<span class="cm"> *    IN_TEMP_LSB(5) = [res, in7]</span>
<span class="cm"> */</span>
<span class="cp">#define DME1737_REG_IN_TEMP_LSB(ix)	(0x84 + (ix))</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">DME1737_REG_IN_LSB</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">DME1737_REG_IN_LSB_SHL</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">DME1737_REG_TEMP_LSB</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">DME1737_REG_TEMP_LSB_SHL</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

<span class="cm">/* Fans numbered 0-5 (ix) */</span>
<span class="cp">#define DME1737_REG_FAN(ix)		((ix) &lt; 4 ? 0x28 + (ix) * 2 \</span>
<span class="cp">						  : 0xa1 + (ix) * 2)</span>
<span class="cp">#define DME1737_REG_FAN_MIN(ix)		((ix) &lt; 4 ? 0x54 + (ix) * 2 \</span>
<span class="cp">						  : 0xa5 + (ix) * 2)</span>
<span class="cp">#define DME1737_REG_FAN_OPT(ix)		((ix) &lt; 4 ? 0x90 + (ix) \</span>
<span class="cp">						  : 0xb2 + (ix))</span>
<span class="cp">#define DME1737_REG_FAN_MAX(ix)		(0xb4 + (ix)) </span><span class="cm">/* only for fan[4-5] */</span><span class="cp"></span>

<span class="cm">/* PWMs numbered 0-2, 4-5 (ix) */</span>
<span class="cp">#define DME1737_REG_PWM(ix)		((ix) &lt; 3 ? 0x30 + (ix) \</span>
<span class="cp">						  : 0xa1 + (ix))</span>
<span class="cp">#define DME1737_REG_PWM_CONFIG(ix)	(0x5c + (ix)) </span><span class="cm">/* only for pwm[0-2] */</span><span class="cp"></span>
<span class="cp">#define DME1737_REG_PWM_MIN(ix)		(0x64 + (ix)) </span><span class="cm">/* only for pwm[0-2] */</span><span class="cp"></span>
<span class="cp">#define DME1737_REG_PWM_FREQ(ix)	((ix) &lt; 3 ? 0x5f + (ix) \</span>
<span class="cp">						  : 0xa3 + (ix))</span>
<span class="cm">/*</span>
<span class="cm"> * The layout of the ramp rate registers is different from the other pwm</span>
<span class="cm"> * registers. The bits for the 3 PWMs are stored in 2 registers:</span>
<span class="cm"> *    PWM_RR(0) = [OFF3, OFF2,  OFF1,  RES,   RR1E, RR1-2, RR1-1, RR1-0]</span>
<span class="cm"> *    PWM_RR(1) = [RR2E, RR2-2, RR2-1, RR2-0, RR3E, RR3-2, RR3-1, RR3-0]</span>
<span class="cm"> */</span>
<span class="cp">#define DME1737_REG_PWM_RR(ix)		(0x62 + (ix)) </span><span class="cm">/* only for pwm[0-2] */</span><span class="cp"></span>

<span class="cm">/* Thermal zones 0-2 */</span>
<span class="cp">#define DME1737_REG_ZONE_LOW(ix)	(0x67 + (ix))</span>
<span class="cp">#define DME1737_REG_ZONE_ABS(ix)	(0x6a + (ix))</span>
<span class="cm">/*</span>
<span class="cm"> * The layout of the hysteresis registers is different from the other zone</span>
<span class="cm"> * registers. The bits for the 3 zones are stored in 2 registers:</span>
<span class="cm"> *    ZONE_HYST(0) = [H1-3,  H1-2,  H1-1, H1-0, H2-3, H2-2, H2-1, H2-0]</span>
<span class="cm"> *    ZONE_HYST(1) = [H3-3,  H3-2,  H3-1, H3-0, RES,  RES,  RES,  RES]</span>
<span class="cm"> */</span>
<span class="cp">#define DME1737_REG_ZONE_HYST(ix)	(0x6d + (ix))</span>

<span class="cm">/*</span>
<span class="cm"> * Alarm registers and bit mapping</span>
<span class="cm"> * The 3 8-bit alarm registers will be concatenated to a single 32-bit</span>
<span class="cm"> * alarm value [0, ALARM3, ALARM2, ALARM1].</span>
<span class="cm"> */</span>
<span class="cp">#define DME1737_REG_ALARM1		0x41</span>
<span class="cp">#define DME1737_REG_ALARM2		0x42</span>
<span class="cp">#define DME1737_REG_ALARM3		0x83</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">DME1737_BIT_ALARM_IN</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">DME1737_BIT_ALARM_TEMP</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">DME1737_BIT_ALARM_FAN</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">};</span>

<span class="cm">/* Miscellaneous registers */</span>
<span class="cp">#define DME1737_REG_DEVICE		0x3d</span>
<span class="cp">#define DME1737_REG_COMPANY		0x3e</span>
<span class="cp">#define DME1737_REG_VERSTEP		0x3f</span>
<span class="cp">#define DME1737_REG_CONFIG		0x40</span>
<span class="cp">#define DME1737_REG_CONFIG2		0x7f</span>
<span class="cp">#define DME1737_REG_VID			0x43</span>
<span class="cp">#define DME1737_REG_TACH_PWM		0x81</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * Misc defines</span>
<span class="cm"> * --------------------------------------------------------------------- */</span>

<span class="cm">/* Chip identification */</span>
<span class="cp">#define DME1737_COMPANY_SMSC	0x5c</span>
<span class="cp">#define DME1737_VERSTEP		0x88</span>
<span class="cp">#define DME1737_VERSTEP_MASK	0xf8</span>
<span class="cp">#define SCH311X_DEVICE		0x8c</span>
<span class="cp">#define SCH5027_VERSTEP		0x69</span>
<span class="cp">#define SCH5127_DEVICE		0x8e</span>

<span class="cm">/* Device ID values (global configuration register index 0x20) */</span>
<span class="cp">#define DME1737_ID_1	0x77</span>
<span class="cp">#define DME1737_ID_2	0x78</span>
<span class="cp">#define SCH3112_ID	0x7c</span>
<span class="cp">#define SCH3114_ID	0x7d</span>
<span class="cp">#define SCH3116_ID	0x7f</span>
<span class="cp">#define SCH5027_ID	0x89</span>
<span class="cp">#define SCH5127_ID	0x86</span>

<span class="cm">/* Length of ISA address segment */</span>
<span class="cp">#define DME1737_EXTENT	2</span>

<span class="cm">/* chip-dependent features */</span>
<span class="cp">#define HAS_TEMP_OFFSET		(1 &lt;&lt; 0)		</span><span class="cm">/* bit 0 */</span><span class="cp"></span>
<span class="cp">#define HAS_VID			(1 &lt;&lt; 1)		</span><span class="cm">/* bit 1 */</span><span class="cp"></span>
<span class="cp">#define HAS_ZONE3		(1 &lt;&lt; 2)		</span><span class="cm">/* bit 2 */</span><span class="cp"></span>
<span class="cp">#define HAS_ZONE_HYST		(1 &lt;&lt; 3)		</span><span class="cm">/* bit 3 */</span><span class="cp"></span>
<span class="cp">#define HAS_PWM_MIN		(1 &lt;&lt; 4)		</span><span class="cm">/* bit 4 */</span><span class="cp"></span>
<span class="cp">#define HAS_FAN(ix)		(1 &lt;&lt; ((ix) + 5))	</span><span class="cm">/* bits 5-10 */</span><span class="cp"></span>
<span class="cp">#define HAS_PWM(ix)		(1 &lt;&lt; ((ix) + 11))	</span><span class="cm">/* bits 11-16 */</span><span class="cp"></span>
<span class="cp">#define HAS_IN7			(1 &lt;&lt; 17)		</span><span class="cm">/* bit 17 */</span><span class="cp"></span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * Data structures and manipulation thereof</span>
<span class="cm"> * --------------------------------------------------------------------- */</span>

<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>	<span class="cm">/* for I2C devices only */</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">hwmon_dev</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>		<span class="cm">/* for ISA devices only */</span>

	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">update_lock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">valid</span><span class="p">;</span>			<span class="cm">/* !=0 if following fields are valid */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_update</span><span class="p">;</span>	<span class="cm">/* in jiffies */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_vbat</span><span class="p">;</span>	<span class="cm">/* in jiffies */</span>
	<span class="k">enum</span> <span class="n">chips</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">in_nominal</span><span class="p">;</span>		<span class="cm">/* pointer to IN_NOMINAL array */</span>

	<span class="n">u8</span> <span class="n">vid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pwm_rr_en</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">has_features</span><span class="p">;</span>

	<span class="cm">/* Register values */</span>
	<span class="n">u16</span> <span class="n">in</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">in_min</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">in_max</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">s16</span> <span class="n">temp</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">s8</span>  <span class="n">temp_min</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">s8</span>  <span class="n">temp_max</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">s8</span>  <span class="n">temp_offset</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">config</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">config2</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">vrm</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fan</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">fan_min</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">fan_max</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">fan_opt</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">pwm</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">pwm_min</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">pwm_config</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">pwm_acz</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">pwm_freq</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">pwm_rr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">zone_low</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">zone_abs</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">zone_hyst</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">alarms</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Nominal voltage values */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">IN_NOMINAL_DME1737</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">2250</span><span class="p">,</span> <span class="mi">3300</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">12000</span><span class="p">,</span> <span class="mi">3300</span><span class="p">,</span>
					 <span class="mi">3300</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">IN_NOMINAL_SCH311x</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2500</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">3300</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">12000</span><span class="p">,</span> <span class="mi">3300</span><span class="p">,</span>
					 <span class="mi">3300</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">IN_NOMINAL_SCH5027</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">2250</span><span class="p">,</span> <span class="mi">3300</span><span class="p">,</span> <span class="mi">1125</span><span class="p">,</span> <span class="mi">1125</span><span class="p">,</span> <span class="mi">3300</span><span class="p">,</span>
					 <span class="mi">3300</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">IN_NOMINAL_SCH5127</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2500</span><span class="p">,</span> <span class="mi">2250</span><span class="p">,</span> <span class="mi">3300</span><span class="p">,</span> <span class="mi">1125</span><span class="p">,</span> <span class="mi">1125</span><span class="p">,</span> <span class="mi">3300</span><span class="p">,</span>
					 <span class="mi">3300</span><span class="p">,</span> <span class="mi">1500</span><span class="p">};</span>
<span class="cp">#define IN_NOMINAL(type)	((type) == sch311x ? IN_NOMINAL_SCH311x : \</span>
<span class="cp">				 (type) == sch5027 ? IN_NOMINAL_SCH5027 : \</span>
<span class="cp">				 (type) == sch5127 ? IN_NOMINAL_SCH5127 : \</span>
<span class="cp">				 IN_NOMINAL_DME1737)</span>

<span class="cm">/*</span>
<span class="cm"> * Voltage input</span>
<span class="cm"> * Voltage inputs have 16 bits resolution, limit values have 8 bits</span>
<span class="cm"> * resolution.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">IN_FROM_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nominal</span><span class="p">,</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">*</span> <span class="n">nominal</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">res</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">res</span> <span class="o">-</span> <span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">IN_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nominal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">SENSORS_LIMIT</span><span class="p">((</span><span class="n">val</span> <span class="o">*</span> <span class="mi">192</span> <span class="o">+</span> <span class="n">nominal</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">nominal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Temperature input</span>
<span class="cm"> * The register values represent temperatures in 2&#39;s complement notation from</span>
<span class="cm"> * -127 degrees C to +127 degrees C. Temp inputs have 16 bits resolution, limit</span>
<span class="cm"> * values have 8 bits resolution.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">TEMP_FROM_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">res</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">TEMP_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">SENSORS_LIMIT</span><span class="p">((</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">val</span> <span class="o">-</span> <span class="mi">500</span> <span class="o">:</span> <span class="n">val</span> <span class="o">+</span> <span class="mi">500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
			     <span class="o">-</span><span class="mi">128</span><span class="p">,</span> <span class="mi">127</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Temperature range */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">TEMP_RANGE</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2500</span><span class="p">,</span> <span class="mi">3333</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">6666</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span>
				 <span class="mi">10000</span><span class="p">,</span> <span class="mi">13333</span><span class="p">,</span> <span class="mi">16000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">,</span> <span class="mi">26666</span><span class="p">,</span> <span class="mi">32000</span><span class="p">,</span>
				 <span class="mi">40000</span><span class="p">,</span> <span class="mi">53333</span><span class="p">,</span> <span class="mi">80000</span><span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">TEMP_RANGE_FROM_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">TEMP_RANGE</span><span class="p">[(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">TEMP_RANGE_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">TEMP_RANGE</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">TEMP_RANGE</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Temperature hysteresis</span>
<span class="cm"> * Register layout:</span>
<span class="cm"> *    reg[0] = [H1-3, H1-2, H1-1, H1-0, H2-3, H2-2, H2-1, H2-0]</span>
<span class="cm"> *    reg[1] = [H3-3, H3-2, H3-1, H3-0, xxxx, xxxx, xxxx, xxxx]</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">TEMP_HYST_FROM_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(((</span><span class="n">ix</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">reg</span> <span class="o">:</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">TEMP_HYST_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hyst</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">((</span><span class="n">val</span> <span class="o">+</span> <span class="mi">500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ix</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="n">hyst</span> <span class="o">:</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">hyst</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Fan input RPM */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">FAN_FROM_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tpc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tpc</span> <span class="o">*</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">90000</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">/</span> <span class="n">reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">FAN_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tpc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">val</span> <span class="o">/</span> <span class="n">tpc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xffff</span> <span class="o">:</span>
			<span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="mi">90000</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">/</span> <span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xfffe</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fan TPC (tach pulse count)</span>
<span class="cm"> * Converts a register value to a TPC multiplier or returns 0 if the tachometer</span>
<span class="cm"> * is configured in legacy (non-tpc) mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">FAN_TPC_FROM_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">60</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fan type</span>
<span class="cm"> * The type of a fan is expressed in number of pulses-per-revolution that it</span>
<span class="cm"> * emits</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">FAN_TYPE_FROM_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">edge</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">edge</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">FAN_TYPE_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xf9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">edge</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Fan max RPM */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">FAN_MAX</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span>
			      <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">FAN_MAX_FROM_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">FAN_MAX</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1000</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">500</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">FAN_MAX_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">500</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">FAN_MAX</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PWM enable</span>
<span class="cm"> * Register to enable mapping:</span>
<span class="cm"> * 000:  2  fan on zone 1 auto</span>
<span class="cm"> * 001:  2  fan on zone 2 auto</span>
<span class="cm"> * 010:  2  fan on zone 3 auto</span>
<span class="cm"> * 011:  0  fan full on</span>
<span class="cm"> * 100: -1  fan disabled</span>
<span class="cm"> * 101:  2  fan on hottest of zones 2,3 auto</span>
<span class="cm"> * 110:  2  fan on hottest of zones 1,2,3 auto</span>
<span class="cm"> * 111:  1  fan in manual mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">PWM_EN_FROM_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">en</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">};</span>

	<span class="k">return</span> <span class="n">en</span><span class="p">[(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">PWM_EN_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">en</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">7</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">en</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PWM auto channels zone</span>
<span class="cm"> * Register to auto channels zone mapping (ACZ is a bitfield with bit x</span>
<span class="cm"> * corresponding to zone x+1):</span>
<span class="cm"> * 000: 001  fan on zone 1 auto</span>
<span class="cm"> * 001: 010  fan on zone 2 auto</span>
<span class="cm"> * 010: 100  fan on zone 3 auto</span>
<span class="cm"> * 011: 000  fan full on</span>
<span class="cm"> * 100: 000  fan disabled</span>
<span class="cm"> * 101: 110  fan on hottest of zones 2,3 auto</span>
<span class="cm"> * 110: 111  fan on hottest of zones 1,2,3 auto</span>
<span class="cm"> * 111: 000  fan in manual mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">PWM_ACZ_FROM_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">acz</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="k">return</span> <span class="n">acz</span><span class="p">[(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">PWM_ACZ_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">acz</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">val</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">acz</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* PWM frequency */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">PWM_FREQ</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span>
			       <span class="mi">15000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">,</span> <span class="mi">30000</span><span class="p">,</span> <span class="mi">25000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">PWM_FREQ_FROM_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PWM_FREQ</span><span class="p">[</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">PWM_FREQ_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* the first two cases are special - stupid chip design! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">27500</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">22500</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PWM_FREQ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">PWM_FREQ</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PWM ramp rate</span>
<span class="cm"> * Register layout:</span>
<span class="cm"> *    reg[0] = [OFF3,  OFF2,  OFF1,  RES,   RR1-E, RR1-2, RR1-1, RR1-0]</span>
<span class="cm"> *    reg[1] = [RR2-E, RR2-2, RR2-1, RR2-0, RR3-E, RR3-2, RR3-1, RR3-0]</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">PWM_RR</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">206</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">PWM_RR_FROM_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ix</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">:</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rr</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">?</span> <span class="n">PWM_RR</span><span class="p">[</span><span class="n">rr</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">PWM_RR_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PWM_RR</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">PWM_RR</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ix</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x8f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">|</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* PWM ramp rate enable */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">PWM_RR_EN_FROM_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PWM_RR_FROM_REG</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">PWM_RR_EN_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">en</span> <span class="o">=</span> <span class="p">(</span><span class="n">ix</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mh">0x08</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">val</span> <span class="o">?</span> <span class="n">reg</span> <span class="o">|</span> <span class="n">en</span> <span class="o">:</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">en</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PWM min/off</span>
<span class="cm"> * The PWM min/off bits are part of the PMW ramp rate register 0 (see above for</span>
<span class="cm"> * the register layout).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">PWM_OFF_FROM_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">5</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">PWM_OFF_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)))</span> <span class="o">|</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">5</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * Device I/O access</span>
<span class="cm"> *</span>
<span class="cm"> * ISA access is performed through an index/data register pair and needs to</span>
<span class="cm"> * be protected by a mutex during runtime (not required for initialization).</span>
<span class="cm"> * We use data-&gt;update_lock for this and need to ensure that we acquire it</span>
<span class="cm"> * before calling dme1737_read or dme1737_write.</span>
<span class="cm"> * --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">dme1737_read</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* I2C device */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Read from register &quot;</span>
				 <span class="s">&quot;0x%02x failed! Please report to the driver &quot;</span>
				 <span class="s">&quot;maintainer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* ISA device */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">dme1737_write</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* I2C device */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Write to register &quot;</span>
				 <span class="s">&quot;0x%02x failed! Please report to the driver &quot;</span>
				 <span class="s">&quot;maintainer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* ISA device */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="nf">dme1737_update_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ix</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lsb</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="cm">/* Enable a Vbat monitoring cycle every 10 mins */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">last_vbat</span> <span class="o">+</span> <span class="mi">600</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_CONFIG</span><span class="p">,</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_CONFIG</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">last_vbat</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Sample register contents every 1 sec */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">last_update</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_VID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">vid</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_VID</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="mh">0x3f</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* In (voltage) registers */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">);</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Voltage inputs are stored as 16 bit values even</span>
<span class="cm">			 * though they have only 12 bits resolution. This is</span>
<span class="cm">			 * to make it consistent with the temp inputs.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ix</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_IN7</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					<span class="n">DME1737_REG_IN</span><span class="p">(</span><span class="n">ix</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_min</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					<span class="n">DME1737_REG_IN_MIN</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_max</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					<span class="n">DME1737_REG_IN_MAX</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* Temp registers */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">);</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Temp inputs are stored as 16 bit values even</span>
<span class="cm">			 * though they have only 12 bits resolution. This is</span>
<span class="cm">			 * to take advantage of implicit conversions between</span>
<span class="cm">			 * register values (2&#39;s complement) and temp values</span>
<span class="cm">			 * (signed decimal).</span>
<span class="cm">			 */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					<span class="n">DME1737_REG_TEMP</span><span class="p">(</span><span class="n">ix</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_min</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					<span class="n">DME1737_REG_TEMP_MIN</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_max</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					<span class="n">DME1737_REG_TEMP_MAX</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_TEMP_OFFSET</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_offset</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_TEMP_OFFSET</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * In and temp LSB registers</span>
<span class="cm">		 * The LSBs are latched when the MSBs are read, so the order in</span>
<span class="cm">		 * which the registers are read (MSB first, then LSB) is</span>
<span class="cm">		 * important!</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lsb</span><span class="p">);</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ix</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_IN7</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">lsb</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					<span class="n">DME1737_REG_IN_TEMP_LSB</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">);</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ix</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_IN7</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">lsb</span><span class="p">[</span><span class="n">DME1737_REG_IN_LSB</span><span class="p">[</span><span class="n">ix</span><span class="p">]]</span> <span class="o">&lt;&lt;</span>
					<span class="n">DME1737_REG_IN_LSB_SHL</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">);</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">lsb</span><span class="p">[</span><span class="n">DME1737_REG_TEMP_LSB</span><span class="p">[</span><span class="n">ix</span><span class="p">]]</span> <span class="o">&lt;&lt;</span>
					<span class="n">DME1737_REG_TEMP_LSB_SHL</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Fan registers */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fan</span><span class="p">);</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Skip reading registers if optional fans are not</span>
<span class="cm">			 * present</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_FAN</span><span class="p">(</span><span class="n">ix</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					<span class="n">DME1737_REG_FAN</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">|=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					<span class="n">DME1737_REG_FAN</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_min</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					<span class="n">DME1737_REG_FAN_MIN</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_min</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">|=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					<span class="n">DME1737_REG_FAN_MIN</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_opt</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					<span class="n">DME1737_REG_FAN_OPT</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
			<span class="cm">/* fan_max exists only for fan[5-6] */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_max</span><span class="p">[</span><span class="n">ix</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					<span class="n">DME1737_REG_FAN_MAX</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* PWM registers */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm</span><span class="p">);</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Skip reading registers if optional PWMs are not</span>
<span class="cm">			 * present</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_PWM</span><span class="p">(</span><span class="n">ix</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					<span class="n">DME1737_REG_PWM</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_freq</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					<span class="n">DME1737_REG_PWM_FREQ</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
			<span class="cm">/* pwm_config and pwm_min exist only for pwm[1-3] */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ix</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_PWM_CONFIG</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_min</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_PWM_MIN</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">);</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_PWM_RR</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* Thermal zone registers */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_low</span><span class="p">);</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Skip reading registers if zone3 is not present */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ix</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_ZONE3</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* sch5127 zone2 registers are special */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ix</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">sch5127</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_low</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_ZONE_LOW</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_abs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_ZONE_ABS</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_low</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_ZONE_LOW</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_abs</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_ZONE_ABS</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_ZONE_HYST</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_hyst</span><span class="p">);</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_hyst</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_ZONE_HYST</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Alarm registers */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_ALARM1</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Bit 7 tells us if the other alarm registers are non-zero and</span>
<span class="cm">		 * therefore also need to be read</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span> <span class="o">|=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_ALARM2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span> <span class="o">|=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_ALARM3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * The ISA chips require explicit clearing of alarm bits.</span>
<span class="cm">		 * Don&#39;t worry, an alarm will come back if the condition</span>
<span class="cm">		 * that causes it still exists</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span> <span class="o">&amp;</span> <span class="mh">0xff0000</span><span class="p">)</span>
				<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_ALARM3</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span>
				<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_ALARM2</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
				<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_ALARM1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">last_update</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * Voltage sysfs attributes</span>
<span class="cm"> * ix = [0-7]</span>
<span class="cm"> * --------------------------------------------------------------------- */</span>

<span class="cp">#define SYS_IN_INPUT	0</span>
<span class="cp">#define SYS_IN_MIN	1</span>
<span class="cp">#define SYS_IN_MAX	2</span>
<span class="cp">#define SYS_IN_ALARM	3</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dme1737_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span>
		<span class="o">*</span><span class="n">sensor_attr_2</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_IN_INPUT</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">IN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">in_nominal</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_IN_MIN</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">IN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">in_min</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">in_nominal</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_IN_MAX</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">IN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">in_max</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">in_nominal</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_IN_ALARM</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span> <span class="o">&gt;&gt;</span> <span class="n">DME1737_BIT_ALARM_IN</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown function %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span>
		<span class="o">*</span><span class="n">sensor_attr_2</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_IN_MIN</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_min</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">IN_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">in_nominal</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_IN_MIN</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">in_min</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_IN_MAX</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_max</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">IN_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">in_nominal</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_IN_MAX</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">in_max</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown function %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * Temperature sysfs attributes</span>
<span class="cm"> * ix = [0-2]</span>
<span class="cm"> * --------------------------------------------------------------------- */</span>

<span class="cp">#define SYS_TEMP_INPUT			0</span>
<span class="cp">#define SYS_TEMP_MIN			1</span>
<span class="cp">#define SYS_TEMP_MAX			2</span>
<span class="cp">#define SYS_TEMP_OFFSET			3</span>
<span class="cp">#define SYS_TEMP_ALARM			4</span>
<span class="cp">#define SYS_TEMP_FAULT			5</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dme1737_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span>
		<span class="o">*</span><span class="n">sensor_attr_2</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_TEMP_INPUT</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_TEMP_MIN</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_min</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_TEMP_MAX</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_max</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_TEMP_OFFSET</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_offset</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_TEMP_ALARM</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span> <span class="o">&gt;&gt;</span> <span class="n">DME1737_BIT_ALARM_TEMP</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_TEMP_FAULT</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u16</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x8000</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown function %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span>
		<span class="o">*</span><span class="n">sensor_attr_2</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_TEMP_MIN</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_min</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_TEMP_MIN</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_min</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_TEMP_MAX</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_max</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_TEMP_MAX</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_max</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_TEMP_OFFSET</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_offset</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_TEMP_OFFSET</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_offset</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown function %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * Zone sysfs attributes</span>
<span class="cm"> * ix = [0-2]</span>
<span class="cm"> * --------------------------------------------------------------------- */</span>

<span class="cp">#define SYS_ZONE_AUTO_CHANNELS_TEMP	0</span>
<span class="cp">#define SYS_ZONE_AUTO_POINT1_TEMP_HYST	1</span>
<span class="cp">#define SYS_ZONE_AUTO_POINT1_TEMP	2</span>
<span class="cp">#define SYS_ZONE_AUTO_POINT2_TEMP	3</span>
<span class="cp">#define SYS_ZONE_AUTO_POINT3_TEMP	4</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_zone</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dme1737_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span>
		<span class="o">*</span><span class="n">sensor_attr_2</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_ZONE_AUTO_CHANNELS_TEMP</span>:
		<span class="cm">/* check config2 for non-standard temp-to-zone mapping */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ix</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">config2</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span>
			<span class="n">res</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">res</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ix</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_ZONE_AUTO_POINT1_TEMP_HYST</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_low</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span>
		      <span class="n">TEMP_HYST_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_hyst</span><span class="p">[</span><span class="n">ix</span> <span class="o">==</span> <span class="mi">2</span><span class="p">],</span> <span class="n">ix</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_ZONE_AUTO_POINT1_TEMP</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_low</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_ZONE_AUTO_POINT2_TEMP</span>:
		<span class="cm">/* pwm_freq holds the temp range bits in the upper nibble */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_low</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
		      <span class="n">TEMP_RANGE_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_freq</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_ZONE_AUTO_POINT3_TEMP</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_abs</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown function %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_zone</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span>
		<span class="o">*</span><span class="n">sensor_attr_2</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_ZONE_AUTO_POINT1_TEMP_HYST</span>:
		<span class="cm">/* Refresh the cache */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_low</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						  <span class="n">DME1737_REG_ZONE_LOW</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
		<span class="cm">/* Modify the temp hyst value */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_hyst</span><span class="p">[</span><span class="n">ix</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEMP_HYST_TO_REG</span><span class="p">(</span>
					<span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_low</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span>
					<span class="n">val</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					<span class="n">DME1737_REG_ZONE_HYST</span><span class="p">(</span><span class="n">ix</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)));</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_ZONE_HYST</span><span class="p">(</span><span class="n">ix</span> <span class="o">==</span> <span class="mi">2</span><span class="p">),</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_hyst</span><span class="p">[</span><span class="n">ix</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_ZONE_AUTO_POINT1_TEMP</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_low</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_ZONE_LOW</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_low</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_ZONE_AUTO_POINT2_TEMP</span>:
		<span class="cm">/* Refresh the cache */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_low</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						  <span class="n">DME1737_REG_ZONE_LOW</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
		<span class="cm">/*</span>
<span class="cm">		 * Modify the temp range value (which is stored in the upper</span>
<span class="cm">		 * nibble of the pwm_freq register)</span>
<span class="cm">		 */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_freq</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEMP_RANGE_TO_REG</span><span class="p">(</span><span class="n">val</span> <span class="o">-</span>
					<span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_low</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="mi">8</span><span class="p">),</span>
					<span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					<span class="n">DME1737_REG_PWM_FREQ</span><span class="p">(</span><span class="n">ix</span><span class="p">)));</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_PWM_FREQ</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_freq</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_ZONE_AUTO_POINT3_TEMP</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_abs</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_ZONE_ABS</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">zone_abs</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown function %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * Fan sysfs attributes</span>
<span class="cm"> * ix = [0-5]</span>
<span class="cm"> * --------------------------------------------------------------------- */</span>

<span class="cp">#define SYS_FAN_INPUT	0</span>
<span class="cp">#define SYS_FAN_MIN	1</span>
<span class="cp">#define SYS_FAN_MAX	2</span>
<span class="cp">#define SYS_FAN_ALARM	3</span>
<span class="cp">#define SYS_FAN_TYPE	4</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_fan</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dme1737_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span>
		<span class="o">*</span><span class="n">sensor_attr_2</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_FAN_INPUT</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">FAN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fan</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span>
				   <span class="n">ix</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
				   <span class="n">FAN_TPC_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_opt</span><span class="p">[</span><span class="n">ix</span><span class="p">]));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_FAN_MIN</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">FAN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_min</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span>
				   <span class="n">ix</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
				   <span class="n">FAN_TPC_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_opt</span><span class="p">[</span><span class="n">ix</span><span class="p">]));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_FAN_MAX</span>:
		<span class="cm">/* only valid for fan[5-6] */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">FAN_MAX_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_max</span><span class="p">[</span><span class="n">ix</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_FAN_ALARM</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span> <span class="o">&gt;&gt;</span> <span class="n">DME1737_BIT_ALARM_FAN</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_FAN_TYPE</span>:
		<span class="cm">/* only valid for fan[1-4] */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">FAN_TYPE_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_opt</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown function %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_fan</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span>
		<span class="o">*</span><span class="n">sensor_attr_2</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_FAN_MIN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ix</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_min</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAN_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Refresh the cache */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_opt</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_FAN_OPT</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
			<span class="cm">/* Modify the fan min value */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_min</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAN_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span>
					<span class="n">FAN_TPC_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_opt</span><span class="p">[</span><span class="n">ix</span><span class="p">]));</span>
		<span class="p">}</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_FAN_MIN</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_min</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_FAN_MIN</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_min</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_FAN_MAX</span>:
		<span class="cm">/* Only valid for fan[5-6] */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_max</span><span class="p">[</span><span class="n">ix</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAN_MAX_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_FAN_MAX</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_max</span><span class="p">[</span><span class="n">ix</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_FAN_TYPE</span>:
		<span class="cm">/* Only valid for fan[1-4] */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Fan type value %ld not &quot;</span>
				 <span class="s">&quot;supported. Choose one of 1, 2, or 4.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">val</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_opt</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAN_TYPE_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					<span class="n">DME1737_REG_FAN_OPT</span><span class="p">(</span><span class="n">ix</span><span class="p">)));</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_FAN_OPT</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_opt</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown function %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * PWM sysfs attributes</span>
<span class="cm"> * ix = [0-4]</span>
<span class="cm"> * --------------------------------------------------------------------- */</span>

<span class="cp">#define SYS_PWM				0</span>
<span class="cp">#define SYS_PWM_FREQ			1</span>
<span class="cp">#define SYS_PWM_ENABLE			2</span>
<span class="cp">#define SYS_PWM_RAMP_RATE		3</span>
<span class="cp">#define SYS_PWM_AUTO_CHANNELS_ZONE	4</span>
<span class="cp">#define SYS_PWM_AUTO_PWM_MIN		5</span>
<span class="cp">#define SYS_PWM_AUTO_POINT1_PWM		6</span>
<span class="cp">#define SYS_PWM_AUTO_POINT2_PWM		7</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dme1737_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span>
		<span class="o">*</span><span class="n">sensor_attr_2</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_PWM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">PWM_EN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm</span><span class="p">[</span><span class="n">ix</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_PWM_FREQ</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">PWM_FREQ_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_freq</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_PWM_ENABLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ix</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* pwm[5-6] hard-wired to manual mode */</span>
		<span class="k">else</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">PWM_EN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_PWM_RAMP_RATE</span>:
		<span class="cm">/* Only valid for pwm[1-3] */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">PWM_RR_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">[</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ix</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_PWM_AUTO_CHANNELS_ZONE</span>:
		<span class="cm">/* Only valid for pwm[1-3] */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PWM_EN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">PWM_ACZ_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_acz</span><span class="p">[</span><span class="n">ix</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_PWM_AUTO_PWM_MIN</span>:
		<span class="cm">/* Only valid for pwm[1-3] */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PWM_OFF_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ix</span><span class="p">))</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_min</span><span class="p">[</span><span class="n">ix</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_PWM_AUTO_POINT1_PWM</span>:
		<span class="cm">/* Only valid for pwm[1-3] */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_min</span><span class="p">[</span><span class="n">ix</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_PWM_AUTO_POINT2_PWM</span>:
		<span class="cm">/* Only valid for pwm[1-3] */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span> <span class="cm">/* hard-wired */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown function %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_pwm_chmod_attr</span><span class="p">[];</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dme1737_chmod_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span><span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span><span class="o">*</span><span class="p">,</span> <span class="n">umode_t</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_pwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span>
		<span class="o">*</span><span class="n">sensor_attr_2</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">sensor_attr_2</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_PWM</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_PWM</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_PWM_FREQ</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_freq</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">PWM_FREQ_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_PWM_FREQ</span><span class="p">(</span><span class="n">ix</span><span class="p">)));</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_PWM_FREQ</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_freq</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_PWM_ENABLE</span>:
		<span class="cm">/* Only valid for pwm[1-3] */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PWM enable %ld not &quot;</span>
				 <span class="s">&quot;supported. Choose one of 0, 1, or 2.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">val</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Refresh the cache */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_PWM_CONFIG</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">PWM_EN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]))</span> <span class="p">{</span>
			<span class="cm">/* Bail out if no change */</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Do some housekeeping if we are currently in auto mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PWM_EN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Save the current zone channel assignment */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_acz</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">PWM_ACZ_FROM_REG</span><span class="p">(</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
			<span class="cm">/* Save the current ramp rate state and disable it */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">[</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_PWM_RR</span><span class="p">(</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">));</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr_en</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ix</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">PWM_RR_EN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">[</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ix</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr_en</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ix</span><span class="p">);</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">[</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PWM_RR_EN_TO_REG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">[</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]);</span>
				<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					      <span class="n">DME1737_REG_PWM_RR</span><span class="p">(</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
					      <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">[</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* Set the new PWM mode */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="cm">/* Change permissions of pwm[ix] to read-only */</span>
			<span class="n">dme1737_chmod_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dme1737_pwm_chmod_attr</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span>
					   <span class="n">S_IRUGO</span><span class="p">);</span>
			<span class="cm">/* Turn fan fully on */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">PWM_EN_TO_REG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
			<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_PWM_CONFIG</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
				      <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="cm">/* Turn on manual mode */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">PWM_EN_TO_REG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
			<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_PWM_CONFIG</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
				      <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
			<span class="cm">/* Change permissions of pwm[ix] to read-writeable */</span>
			<span class="n">dme1737_chmod_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dme1737_pwm_chmod_attr</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span>
					   <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="cm">/* Change permissions of pwm[ix] to read-only */</span>
			<span class="n">dme1737_chmod_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dme1737_pwm_chmod_attr</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span>
					   <span class="n">S_IRUGO</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Turn on auto mode using the saved zone channel</span>
<span class="cm">			 * assignment</span>
<span class="cm">			 */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">PWM_ACZ_TO_REG</span><span class="p">(</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_acz</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
			<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_PWM_CONFIG</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
				      <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
			<span class="cm">/* Enable PWM ramp rate if previously enabled */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr_en</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ix</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">[</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PWM_RR_EN_TO_REG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span>
						<span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_PWM_RR</span><span class="p">(</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)));</span>
				<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					      <span class="n">DME1737_REG_PWM_RR</span><span class="p">(</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
					      <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">[</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_PWM_RAMP_RATE</span>:
		<span class="cm">/* Only valid for pwm[1-3] */</span>
		<span class="cm">/* Refresh the cache */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_PWM_CONFIG</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">[</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_PWM_RR</span><span class="p">(</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">));</span>
		<span class="cm">/* Set the ramp rate value */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">[</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PWM_RR_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">[</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Enable/disable the feature only if the associated PWM</span>
<span class="cm">		 * output is in automatic mode.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PWM_EN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">[</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PWM_RR_EN_TO_REG</span><span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">[</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_PWM_RR</span><span class="p">(</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">[</span><span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_PWM_AUTO_CHANNELS_ZONE</span>:
		<span class="cm">/* Only valid for pwm[1-3] */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">||</span>
		      <span class="n">val</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PWM auto channels zone %ld &quot;</span>
				 <span class="s">&quot;not supported. Choose one of 1, 2, 4, 6, &quot;</span>
				 <span class="s">&quot;or 7.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Refresh the cache */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_PWM_CONFIG</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PWM_EN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * PWM is already in auto mode so update the temp</span>
<span class="cm">			 * channel assignment</span>
<span class="cm">			 */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">PWM_ACZ_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span>
						<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
			<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_PWM_CONFIG</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
				      <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * PWM is not in auto mode so we save the temp</span>
<span class="cm">			 * channel assignment for later use</span>
<span class="cm">			 */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_acz</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_PWM_AUTO_PWM_MIN</span>:
		<span class="cm">/* Only valid for pwm[1-3] */</span>
		<span class="cm">/* Refresh the cache */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_min</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_PWM_MIN</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
		<span class="cm">/*</span>
<span class="cm">		 * There are only 2 values supported for the auto_pwm_min</span>
<span class="cm">		 * value: 0 or auto_point1_pwm. So if the temperature drops</span>
<span class="cm">		 * below the auto_point1_temp_hyst value, the fan either turns</span>
<span class="cm">		 * off or runs at auto_point1_pwm duty-cycle.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_min</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PWM_OFF_TO_REG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span>
						<span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_PWM_RR</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PWM_OFF_TO_REG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span>
						<span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_PWM_RR</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>
		<span class="p">}</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_PWM_RR</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_rr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_PWM_AUTO_POINT1_PWM</span>:
		<span class="cm">/* Only valid for pwm[1-3] */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_min</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_PWM_MIN</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
			      <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_min</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown function %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * Miscellaneous sysfs attributes</span>
<span class="cm"> * --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_vrm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">vrm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_vrm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">vrm</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dme1737_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vid_from_reg</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">vrm</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * Sysfs device attribute defines and structs</span>
<span class="cm"> * --------------------------------------------------------------------- */</span>

<span class="cm">/* Voltages 0-7 */</span>

<span class="cp">#define SENSOR_DEVICE_ATTR_IN(ix) \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(in##ix##_input, S_IRUGO, \</span>
<span class="cp">	show_in, NULL, SYS_IN_INPUT, ix); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(in##ix##_min, S_IRUGO | S_IWUSR, \</span>
<span class="cp">	show_in, set_in, SYS_IN_MIN, ix); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(in##ix##_max, S_IRUGO | S_IWUSR, \</span>
<span class="cp">	show_in, set_in, SYS_IN_MAX, ix); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(in##ix##_alarm, S_IRUGO, \</span>
<span class="cp">	show_in, NULL, SYS_IN_ALARM, ix)</span>

<span class="n">SENSOR_DEVICE_ATTR_IN</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">SENSOR_DEVICE_ATTR_IN</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">SENSOR_DEVICE_ATTR_IN</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">SENSOR_DEVICE_ATTR_IN</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="n">SENSOR_DEVICE_ATTR_IN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="n">SENSOR_DEVICE_ATTR_IN</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="n">SENSOR_DEVICE_ATTR_IN</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
<span class="n">SENSOR_DEVICE_ATTR_IN</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>

<span class="cm">/* Temperatures 1-3 */</span>

<span class="cp">#define SENSOR_DEVICE_ATTR_TEMP(ix) \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(temp##ix##_input, S_IRUGO, \</span>
<span class="cp">	show_temp, NULL, SYS_TEMP_INPUT, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(temp##ix##_min, S_IRUGO | S_IWUSR, \</span>
<span class="cp">	show_temp, set_temp, SYS_TEMP_MIN, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(temp##ix##_max, S_IRUGO | S_IWUSR, \</span>
<span class="cp">	show_temp, set_temp, SYS_TEMP_MAX, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(temp##ix##_offset, S_IRUGO, \</span>
<span class="cp">	show_temp, set_temp, SYS_TEMP_OFFSET, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(temp##ix##_alarm, S_IRUGO, \</span>
<span class="cp">	show_temp, NULL, SYS_TEMP_ALARM, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(temp##ix##_fault, S_IRUGO, \</span>
<span class="cp">	show_temp, NULL, SYS_TEMP_FAULT, ix-1)</span>

<span class="n">SENSOR_DEVICE_ATTR_TEMP</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">SENSOR_DEVICE_ATTR_TEMP</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">SENSOR_DEVICE_ATTR_TEMP</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

<span class="cm">/* Zones 1-3 */</span>

<span class="cp">#define SENSOR_DEVICE_ATTR_ZONE(ix) \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(zone##ix##_auto_channels_temp, S_IRUGO, \</span>
<span class="cp">	show_zone, NULL, SYS_ZONE_AUTO_CHANNELS_TEMP, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(zone##ix##_auto_point1_temp_hyst, S_IRUGO, \</span>
<span class="cp">	show_zone, set_zone, SYS_ZONE_AUTO_POINT1_TEMP_HYST, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(zone##ix##_auto_point1_temp, S_IRUGO, \</span>
<span class="cp">	show_zone, set_zone, SYS_ZONE_AUTO_POINT1_TEMP, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(zone##ix##_auto_point2_temp, S_IRUGO, \</span>
<span class="cp">	show_zone, set_zone, SYS_ZONE_AUTO_POINT2_TEMP, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(zone##ix##_auto_point3_temp, S_IRUGO, \</span>
<span class="cp">	show_zone, set_zone, SYS_ZONE_AUTO_POINT3_TEMP, ix-1)</span>

<span class="n">SENSOR_DEVICE_ATTR_ZONE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">SENSOR_DEVICE_ATTR_ZONE</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">SENSOR_DEVICE_ATTR_ZONE</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

<span class="cm">/* Fans 1-4 */</span>

<span class="cp">#define SENSOR_DEVICE_ATTR_FAN_1TO4(ix) \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(fan##ix##_input, S_IRUGO, \</span>
<span class="cp">	show_fan, NULL, SYS_FAN_INPUT, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(fan##ix##_min, S_IRUGO | S_IWUSR, \</span>
<span class="cp">	show_fan, set_fan, SYS_FAN_MIN, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(fan##ix##_alarm, S_IRUGO, \</span>
<span class="cp">	show_fan, NULL, SYS_FAN_ALARM, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(fan##ix##_type, S_IRUGO | S_IWUSR, \</span>
<span class="cp">	show_fan, set_fan, SYS_FAN_TYPE, ix-1)</span>

<span class="n">SENSOR_DEVICE_ATTR_FAN_1TO4</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">SENSOR_DEVICE_ATTR_FAN_1TO4</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">SENSOR_DEVICE_ATTR_FAN_1TO4</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="n">SENSOR_DEVICE_ATTR_FAN_1TO4</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

<span class="cm">/* Fans 5-6 */</span>

<span class="cp">#define SENSOR_DEVICE_ATTR_FAN_5TO6(ix) \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(fan##ix##_input, S_IRUGO, \</span>
<span class="cp">	show_fan, NULL, SYS_FAN_INPUT, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(fan##ix##_min, S_IRUGO | S_IWUSR, \</span>
<span class="cp">	show_fan, set_fan, SYS_FAN_MIN, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(fan##ix##_alarm, S_IRUGO, \</span>
<span class="cp">	show_fan, NULL, SYS_FAN_ALARM, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(fan##ix##_max, S_IRUGO | S_IWUSR, \</span>
<span class="cp">	show_fan, set_fan, SYS_FAN_MAX, ix-1)</span>

<span class="n">SENSOR_DEVICE_ATTR_FAN_5TO6</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="n">SENSOR_DEVICE_ATTR_FAN_5TO6</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>

<span class="cm">/* PWMs 1-3 */</span>

<span class="cp">#define SENSOR_DEVICE_ATTR_PWM_1TO3(ix) \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(pwm##ix, S_IRUGO, \</span>
<span class="cp">	show_pwm, set_pwm, SYS_PWM, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(pwm##ix##_freq, S_IRUGO, \</span>
<span class="cp">	show_pwm, set_pwm, SYS_PWM_FREQ, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(pwm##ix##_enable, S_IRUGO, \</span>
<span class="cp">	show_pwm, set_pwm, SYS_PWM_ENABLE, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(pwm##ix##_ramp_rate, S_IRUGO, \</span>
<span class="cp">	show_pwm, set_pwm, SYS_PWM_RAMP_RATE, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(pwm##ix##_auto_channels_zone, S_IRUGO, \</span>
<span class="cp">	show_pwm, set_pwm, SYS_PWM_AUTO_CHANNELS_ZONE, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(pwm##ix##_auto_pwm_min, S_IRUGO, \</span>
<span class="cp">	show_pwm, set_pwm, SYS_PWM_AUTO_PWM_MIN, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(pwm##ix##_auto_point1_pwm, S_IRUGO, \</span>
<span class="cp">	show_pwm, set_pwm, SYS_PWM_AUTO_POINT1_PWM, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(pwm##ix##_auto_point2_pwm, S_IRUGO, \</span>
<span class="cp">	show_pwm, NULL, SYS_PWM_AUTO_POINT2_PWM, ix-1)</span>

<span class="n">SENSOR_DEVICE_ATTR_PWM_1TO3</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">SENSOR_DEVICE_ATTR_PWM_1TO3</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">SENSOR_DEVICE_ATTR_PWM_1TO3</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

<span class="cm">/* PWMs 5-6 */</span>

<span class="cp">#define SENSOR_DEVICE_ATTR_PWM_5TO6(ix) \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(pwm##ix, S_IRUGO, \</span>
<span class="cp">	show_pwm, set_pwm, SYS_PWM, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(pwm##ix##_freq, S_IRUGO, \</span>
<span class="cp">	show_pwm, set_pwm, SYS_PWM_FREQ, ix-1); \</span>
<span class="cp">static SENSOR_DEVICE_ATTR_2(pwm##ix##_enable, S_IRUGO, \</span>
<span class="cp">	show_pwm, NULL, SYS_PWM_ENABLE, ix-1)</span>

<span class="n">SENSOR_DEVICE_ATTR_PWM_5TO6</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="n">SENSOR_DEVICE_ATTR_PWM_5TO6</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>

<span class="cm">/* Misc */</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">vrm</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_vrm</span><span class="p">,</span> <span class="n">set_vrm</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">cpu0_vid</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_vid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>   <span class="cm">/* for ISA devices */</span>

<span class="cm">/*</span>
<span class="cm"> * This struct holds all the attributes that are always present and need to be</span>
<span class="cm"> * created unconditionally. The attributes that need modification of their</span>
<span class="cm"> * permissions are created read-only and write permissions are added or removed</span>
<span class="cm"> * on the fly when required</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Voltages */</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in0_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in0_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in0_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in0_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in1_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in1_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in1_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in1_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in2_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in2_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in2_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in2_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in3_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in3_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in3_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in3_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in4_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in4_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in4_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in4_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in5_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in5_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in5_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in5_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in6_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in6_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in6_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in6_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="cm">/* Temperatures */</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_fault</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_fault</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_fault</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="cm">/* Zones */</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone1_auto_point1_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone1_auto_point2_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone1_auto_point3_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone1_auto_channels_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone2_auto_point1_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone2_auto_point2_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone2_auto_point3_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone2_auto_channels_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">dme1737_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_attr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The following struct holds temp offset attributes, which are not available</span>
<span class="cm"> * in all chips. The following chips support them:</span>
<span class="cm"> * DME1737, SCH311x</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_temp_offset_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_offset</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_offset</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_offset</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">dme1737_temp_offset_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_temp_offset_attr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The following struct holds VID related attributes, which are not available</span>
<span class="cm"> * in all chips. The following chips support them:</span>
<span class="cm"> * DME1737</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_vid_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_vrm</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_cpu0_vid</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">dme1737_vid_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_vid_attr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The following struct holds temp zone 3 related attributes, which are not</span>
<span class="cm"> * available in all chips. The following chips support them:</span>
<span class="cm"> * DME1737, SCH311x, SCH5027</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_zone3_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone3_auto_point1_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone3_auto_point2_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone3_auto_point3_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone3_auto_channels_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">dme1737_zone3_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_zone3_attr</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * The following struct holds temp zone hysteresis related attributes, which</span>
<span class="cm"> * are not available in all chips. The following chips support them:</span>
<span class="cm"> * DME1737, SCH311x</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_zone_hyst_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone1_auto_point1_temp_hyst</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone2_auto_point1_temp_hyst</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone3_auto_point1_temp_hyst</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">dme1737_zone_hyst_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_zone_hyst_attr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The following struct holds voltage in7 related attributes, which</span>
<span class="cm"> * are not available in all chips. The following chips support them:</span>
<span class="cm"> * SCH5127</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_in7_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in7_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in7_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in7_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in7_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">dme1737_in7_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_in7_attr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The following structs hold the PWM attributes, some of which are optional.</span>
<span class="cm"> * Their creation depends on the chip configuration which is determined during</span>
<span class="cm"> * module load.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_pwm1_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_freq</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_enable</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_ramp_rate</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_auto_channels_zone</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_auto_point1_pwm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_auto_point2_pwm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_pwm2_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_freq</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_enable</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_ramp_rate</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_auto_channels_zone</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_auto_point1_pwm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_auto_point2_pwm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_pwm3_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3_freq</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3_enable</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3_ramp_rate</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3_auto_channels_zone</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3_auto_point1_pwm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3_auto_point2_pwm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_pwm5_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm5</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm5_freq</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm5_enable</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_pwm6_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm6</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm6_freq</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm6_enable</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">dme1737_pwm_group</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_pwm1_attr</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_pwm2_attr</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_pwm3_attr</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="nb">NULL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_pwm5_attr</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_pwm6_attr</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The following struct holds auto PWM min attributes, which are not available</span>
<span class="cm"> * in all chips. Their creation depends on the chip type which is determined</span>
<span class="cm"> * during module load.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_auto_pwm_min_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_auto_pwm_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_auto_pwm_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3_auto_pwm_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The following structs hold the fan attributes, some of which are optional.</span>
<span class="cm"> * Their creation depends on the chip configuration which is determined during</span>
<span class="cm"> * module load.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_fan1_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan1_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan1_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan1_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan1_type</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_fan2_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan2_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan2_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan2_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan2_type</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_fan3_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan3_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan3_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan3_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan3_type</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_fan4_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan4_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan4_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan4_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan4_type</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_fan5_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan5_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan5_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan5_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan5_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_fan6_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan6_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan6_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan6_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan6_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">dme1737_fan_group</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_fan1_attr</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_fan2_attr</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_fan3_attr</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_fan4_attr</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_fan5_attr</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_fan6_attr</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The permissions of the following zone attributes are changed to read-</span>
<span class="cm"> * writeable if the chip is *not* locked. Otherwise they stay read-only.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_zone_chmod_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone1_auto_point1_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone1_auto_point2_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone1_auto_point3_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone2_auto_point1_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone2_auto_point2_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone2_auto_point3_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">dme1737_zone_chmod_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_zone_chmod_attr</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * The permissions of the following zone 3 attributes are changed to read-</span>
<span class="cm"> * writeable if the chip is *not* locked. Otherwise they stay read-only.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_zone3_chmod_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone3_auto_point1_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone3_auto_point2_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_zone3_auto_point3_temp</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">dme1737_zone3_chmod_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_zone3_chmod_attr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The permissions of the following PWM attributes are changed to read-</span>
<span class="cm"> * writeable if the chip is *not* locked and the respective PWM is available.</span>
<span class="cm"> * Otherwise they stay read-only.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_pwm1_chmod_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_freq</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_enable</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_ramp_rate</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_auto_channels_zone</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_auto_point1_pwm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_pwm2_chmod_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_freq</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_enable</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_ramp_rate</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_auto_channels_zone</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_auto_point1_pwm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_pwm3_chmod_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3_freq</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3_enable</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3_ramp_rate</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3_auto_channels_zone</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3_auto_point1_pwm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_pwm5_chmod_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm5</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm5_freq</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_pwm6_chmod_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm6</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm6_freq</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">dme1737_pwm_chmod_group</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_pwm1_chmod_attr</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_pwm2_chmod_attr</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_pwm3_chmod_attr</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="nb">NULL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_pwm5_chmod_attr</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dme1737_pwm6_chmod_attr</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Pwm[1-3] are read-writeable if the associated pwm is in manual mode and the</span>
<span class="cm"> * chip is not locked. Otherwise they are read-only.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">dme1737_pwm_chmod_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * Super-IO functions</span>
<span class="cm"> * --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dme1737_sio_enter</span><span class="p">(</span><span class="kt">int</span> <span class="n">sio_cip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x55</span><span class="p">,</span> <span class="n">sio_cip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dme1737_sio_exit</span><span class="p">(</span><span class="kt">int</span> <span class="n">sio_cip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xaa</span><span class="p">,</span> <span class="n">sio_cip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dme1737_sio_inb</span><span class="p">(</span><span class="kt">int</span> <span class="n">sio_cip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">sio_cip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">sio_cip</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dme1737_sio_outb</span><span class="p">(</span><span class="kt">int</span> <span class="n">sio_cip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">sio_cip</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">sio_cip</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * Device initialization</span>
<span class="cm"> * --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dme1737_i2c_get_features</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dme1737_data</span><span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dme1737_chmod_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_chmod_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to change permissions of %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dme1737_chmod_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span>
				<span class="n">umode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">attribute</span> <span class="o">**</span><span class="n">attr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">attr</span> <span class="o">=</span> <span class="n">group</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">;</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span> <span class="n">attr</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dme1737_chmod_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dme1737_remove_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ix</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dme1737_fan_group</span><span class="p">);</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_FAN</span><span class="p">(</span><span class="n">ix</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dme1737_fan_group</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dme1737_pwm_group</span><span class="p">);</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_PWM</span><span class="p">(</span><span class="n">ix</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dme1737_pwm_group</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_PWM_MIN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sysfs_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
						<span class="n">dme1737_auto_pwm_min_attr</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_TEMP_OFFSET</span><span class="p">)</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dme1737_temp_offset_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_VID</span><span class="p">)</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dme1737_vid_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_ZONE3</span><span class="p">)</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dme1737_zone3_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_ZONE_HYST</span><span class="p">)</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dme1737_zone_hyst_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_IN7</span><span class="p">)</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dme1737_in7_group</span><span class="p">);</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dme1737_group</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">)</span>
		<span class="n">sysfs_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_name</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dme1737_create_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">ix</span><span class="p">;</span>

	<span class="cm">/* Create a name attribute for ISA devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_name</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Create standard sysfs attributes */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dme1737_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_remove</span><span class="p">;</span>

	<span class="cm">/* Create chip-dependent sysfs attributes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_TEMP_OFFSET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">dme1737_temp_offset_group</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_VID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dme1737_vid_group</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_ZONE3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dme1737_zone3_group</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_ZONE_HYST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dme1737_zone_hyst_group</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_IN7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dme1737_in7_group</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Create fan sysfs attributes */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dme1737_fan_group</span><span class="p">);</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_FAN</span><span class="p">(</span><span class="n">ix</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">dme1737_fan_group</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit_remove</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Create PWM sysfs attributes */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dme1737_pwm_group</span><span class="p">);</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_PWM</span><span class="p">(</span><span class="n">ix</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">dme1737_pwm_group</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit_remove</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_PWM_MIN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ix</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
						<span class="n">dme1737_auto_pwm_min_attr</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">exit_remove</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Inform if the device is locked. Otherwise change the permissions of</span>
<span class="cm">	 * selected attributes from read-only to read-writeable.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device is locked. Some attributes &quot;</span>
			 <span class="s">&quot;will be read-only.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Change permissions of zone sysfs attributes */</span>
		<span class="n">dme1737_chmod_group</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dme1737_zone_chmod_group</span><span class="p">,</span>
				    <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

		<span class="cm">/* Change permissions of chip-dependent sysfs attributes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_TEMP_OFFSET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dme1737_chmod_group</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dme1737_temp_offset_group</span><span class="p">,</span>
					    <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_ZONE3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dme1737_chmod_group</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dme1737_zone3_chmod_group</span><span class="p">,</span>
					    <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_ZONE_HYST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dme1737_chmod_group</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dme1737_zone_hyst_group</span><span class="p">,</span>
					    <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Change permissions of PWM sysfs attributes */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dme1737_pwm_chmod_group</span><span class="p">);</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_PWM</span><span class="p">(</span><span class="n">ix</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dme1737_chmod_group</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">dme1737_pwm_chmod_group</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span>
						<span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_PWM_MIN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="n">ix</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dme1737_chmod_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">dme1737_auto_pwm_min_attr</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span>
						<span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Change permissions of pwm[1-3] if in manual mode */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_PWM</span><span class="p">(</span><span class="n">ix</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">PWM_EN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dme1737_chmod_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">dme1737_pwm_chmod_attr</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span>
						<span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_remove:</span>
	<span class="n">dme1737_remove_files</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dme1737_init_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ix</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* Point to the right nominal voltages array */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_nominal</span> <span class="o">=</span> <span class="n">IN_NOMINAL</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_CONFIG</span><span class="p">);</span>
	<span class="cm">/* Inform if part is not monitoring/started */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force_start</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device is not monitoring. &quot;</span>
				<span class="s">&quot;Use the force_start load parameter to &quot;</span>
				<span class="s">&quot;override.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Force monitoring */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_CONFIG</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Inform if part is not ready */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device is not ready.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine which optional fan and pwm features are enabled (only</span>
<span class="cm">	 * valid for I2C devices)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>   <span class="cm">/* I2C chip */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">config2</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_CONFIG2</span><span class="p">);</span>
		<span class="cm">/* Check if optional fan3 input is enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">config2</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">|=</span> <span class="n">HAS_FAN</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Fan4 and pwm3 are only available if the client&#39;s I2C address</span>
<span class="cm">		 * is the default 0x2e. Otherwise the I/Os associated with</span>
<span class="cm">		 * these functions are used for addr enable/select.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">==</span> <span class="mh">0x2e</span><span class="p">)</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">|=</span> <span class="n">HAS_FAN</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">HAS_PWM</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Determine which of the optional fan[5-6] and pwm[5-6]</span>
<span class="cm">		 * features are enabled. For this, we need to query the runtime</span>
<span class="cm">		 * registers through the Super-IO LPC interface. Try both</span>
<span class="cm">		 * config ports 0x2e and 0x4e.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dme1737_i2c_get_features</span><span class="p">(</span><span class="mh">0x2e</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">dme1737_i2c_get_features</span><span class="p">(</span><span class="mh">0x4e</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to query Super-IO for optional &quot;</span>
				 <span class="s">&quot;features.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Fan[1-2] and pwm[1-2] are present in all chips */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">|=</span> <span class="n">HAS_FAN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">HAS_FAN</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">HAS_PWM</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">HAS_PWM</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Chip-dependent features */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">dme1737</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">|=</span> <span class="n">HAS_TEMP_OFFSET</span> <span class="o">|</span> <span class="n">HAS_VID</span> <span class="o">|</span> <span class="n">HAS_ZONE3</span> <span class="o">|</span>
			<span class="n">HAS_ZONE_HYST</span> <span class="o">|</span> <span class="n">HAS_PWM_MIN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">sch311x</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">|=</span> <span class="n">HAS_TEMP_OFFSET</span> <span class="o">|</span> <span class="n">HAS_ZONE3</span> <span class="o">|</span>
			<span class="n">HAS_ZONE_HYST</span> <span class="o">|</span> <span class="n">HAS_PWM_MIN</span> <span class="o">|</span> <span class="n">HAS_FAN</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">HAS_PWM</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">sch5027</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">|=</span> <span class="n">HAS_ZONE3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">sch5127</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">|=</span> <span class="n">HAS_FAN</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">HAS_PWM</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">HAS_IN7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Optional features: pwm3=%s, pwm5=%s, pwm6=%s, &quot;</span>
		 <span class="s">&quot;fan3=%s, fan4=%s, fan5=%s, fan6=%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_PWM</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_PWM</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_PWM</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_FAN</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_FAN</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_FAN</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_FAN</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_TACH_PWM</span><span class="p">);</span>
	<span class="cm">/* Inform if fan-to-pwm mapping differs from the default */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0xa4</span><span class="p">)</span> <span class="p">{</span>   <span class="cm">/* I2C chip */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Non-standard fan to pwm mapping: &quot;</span>
			 <span class="s">&quot;fan1-&gt;pwm%d, fan2-&gt;pwm%d, fan3-&gt;pwm%d, &quot;</span>
			 <span class="s">&quot;fan4-&gt;pwm%d. Please report to the driver &quot;</span>
			 <span class="s">&quot;maintainer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			 <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x24</span><span class="p">)</span> <span class="p">{</span>   <span class="cm">/* ISA chip */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Non-standard fan to pwm mapping: &quot;</span>
			 <span class="s">&quot;fan1-&gt;pwm%d, fan2-&gt;pwm%d, fan3-&gt;pwm%d. &quot;</span>
			 <span class="s">&quot;Please report to the driver maintainer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			 <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Switch pwm[1-3] to manual mode if they are currently disabled and</span>
<span class="cm">	 * set the duty-cycles to 0% (which is identical to the PWMs being</span>
<span class="cm">	 * disabled).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
						<span class="n">DME1737_REG_PWM_CONFIG</span><span class="p">(</span><span class="n">ix</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_PWM</span><span class="p">(</span><span class="n">ix</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">PWM_EN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Switching pwm%d to &quot;</span>
					 <span class="s">&quot;manual mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">PWM_EN_TO_REG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
				<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_PWM</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">dme1737_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
					      <span class="n">DME1737_REG_PWM_CONFIG</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
					      <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_config</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize the default PWM auto channels zone (acz) assignments */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_acz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* pwm1 -&gt; zone1 */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_acz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* pwm2 -&gt; zone2 */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_acz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* pwm3 -&gt; zone3 */</span>

	<span class="cm">/* Set VRM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">&amp;</span> <span class="n">HAS_VID</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">vrm</span> <span class="o">=</span> <span class="n">vid_which_vrm</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * I2C device detection and registration</span>
<span class="cm"> * --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">dme1737_i2c_driver</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dme1737_i2c_get_features</span><span class="p">(</span><span class="kt">int</span> <span class="n">sio_cip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">dme1737_sio_enter</span><span class="p">(</span><span class="n">sio_cip</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check device ID</span>
<span class="cm">	 * We currently know about two kinds of DME1737 and SCH5027.</span>
<span class="cm">	 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">force_id</span> <span class="o">?</span> <span class="n">force_id</span> <span class="o">:</span> <span class="n">dme1737_sio_inb</span><span class="p">(</span><span class="n">sio_cip</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">DME1737_ID_1</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="n">DME1737_ID_2</span> <span class="o">||</span>
	      <span class="n">reg</span> <span class="o">==</span> <span class="n">SCH5027_ID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Select logical device A (runtime registers) */</span>
	<span class="n">dme1737_sio_outb</span><span class="p">(</span><span class="n">sio_cip</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">);</span>

	<span class="cm">/* Get the base address of the runtime registers */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">dme1737_sio_inb</span><span class="p">(</span><span class="n">sio_cip</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">dme1737_sio_inb</span><span class="p">(</span><span class="n">sio_cip</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read the runtime registers to determine which optional features</span>
<span class="cm">	 * are enabled and available. Bits [3:2] of registers 0x43-0x46 are set</span>
<span class="cm">	 * to &#39;10&#39; if the respective feature is enabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x43</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">)</span> <span class="cm">/* fan6 */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">|=</span> <span class="n">HAS_FAN</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x44</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">)</span> <span class="cm">/* pwm6 */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">|=</span> <span class="n">HAS_PWM</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x45</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">)</span> <span class="cm">/* fan5 */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">|=</span> <span class="n">HAS_FAN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x46</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">)</span> <span class="cm">/* pwm5 */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_features</span> <span class="o">|=</span> <span class="n">HAS_PWM</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="n">dme1737_sio_exit</span><span class="p">(</span><span class="n">sio_cip</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return 0 if detection is successful, -ENODEV otherwise */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dme1737_i2c_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">company</span><span class="p">,</span> <span class="n">verstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_BYTE_DATA</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">company</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DME1737_REG_COMPANY</span><span class="p">);</span>
	<span class="n">verstep</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DME1737_REG_VERSTEP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">company</span> <span class="o">==</span> <span class="n">DME1737_COMPANY_SMSC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">verstep</span> <span class="o">==</span> <span class="n">SCH5027_VERSTEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sch5027&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">company</span> <span class="o">==</span> <span class="n">DME1737_COMPANY_SMSC</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">verstep</span> <span class="o">&amp;</span> <span class="n">DME1737_VERSTEP_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">DME1737_VERSTEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dme1737&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Found a %s chip at 0x%02x (rev 0x%02x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">verstep</span> <span class="o">==</span> <span class="n">SCH5027_VERSTEP</span> <span class="o">?</span> <span class="s">&quot;SCH5027&quot;</span> <span class="o">:</span> <span class="s">&quot;DME1737&quot;</span><span class="p">,</span>
		 <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">verstep</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">I2C_NAME_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dme1737_i2c_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dme1737_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="cm">/* Initialize the DME1737 chip */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">dme1737_init_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_kfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Create sysfs files */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">dme1737_create_files</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to create sysfs files.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_kfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Register device */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span> <span class="o">=</span> <span class="n">hwmon_device_register</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to register device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_remove</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_remove:</span>
	<span class="n">dme1737_remove_files</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">exit_kfree:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dme1737_i2c_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
	<span class="n">dme1737_remove_files</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">dme1737_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;dme1737&quot;</span><span class="p">,</span> <span class="n">dme1737</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;sch5027&quot;</span><span class="p">,</span> <span class="n">sch5027</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">dme1737_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">dme1737_i2c_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">I2C_CLASS_HWMON</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dme1737&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">dme1737_i2c_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">dme1737_i2c_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">dme1737_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detect</span> <span class="o">=</span> <span class="n">dme1737_i2c_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">address_list</span> <span class="o">=</span> <span class="n">normal_i2c</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * ISA device detection and registration</span>
<span class="cm"> * --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dme1737_isa_detect</span><span class="p">(</span><span class="kt">int</span> <span class="n">sio_cip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">base_addr</span><span class="p">;</span>

	<span class="n">dme1737_sio_enter</span><span class="p">(</span><span class="n">sio_cip</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check device ID</span>
<span class="cm">	 * We currently know about SCH3112, SCH3114, SCH3116, and SCH5127</span>
<span class="cm">	 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">force_id</span> <span class="o">?</span> <span class="n">force_id</span> <span class="o">:</span> <span class="n">dme1737_sio_inb</span><span class="p">(</span><span class="n">sio_cip</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">SCH3112_ID</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="n">SCH3114_ID</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="n">SCH3116_ID</span> <span class="o">||</span>
	      <span class="n">reg</span> <span class="o">==</span> <span class="n">SCH5127_ID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Select logical device A (runtime registers) */</span>
	<span class="n">dme1737_sio_outb</span><span class="p">(</span><span class="n">sio_cip</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">);</span>

	<span class="cm">/* Get the base address of the runtime registers */</span>
	<span class="n">base_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">dme1737_sio_inb</span><span class="p">(</span><span class="n">sio_cip</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">dme1737_sio_inb</span><span class="p">(</span><span class="n">sio_cip</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Base address not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Access to the hwmon registers is through an index/data register</span>
<span class="cm">	 * pair located at offset 0x70/0x71.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="mh">0x70</span><span class="p">;</span>

<span class="nl">exit:</span>
	<span class="n">dme1737_sio_exit</span><span class="p">(</span><span class="n">sio_cip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dme1737_isa_device_add</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">addr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">DME1737_EXTENT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;dme1737&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IO</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">acpi_check_resource_conflict</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;dme1737&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to allocate device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to add device resource (err = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_device_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to add device (err = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_device_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_device_put:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">dme1737_isa_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">company</span><span class="p">,</span> <span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">DME1737_EXTENT</span><span class="p">,</span> <span class="s">&quot;dme1737&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to request region 0x%04x-0x%04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">DME1737_EXTENT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dme1737_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_release_region</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/* Skip chip detection if module is loaded with force_id parameter */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">force_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCH3112_ID</span>:
	<span class="k">case</span> <span class="n">SCH3114_ID</span>:
	<span class="k">case</span> <span class="n">SCH3116_ID</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">sch311x</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCH5127_ID</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">sch5127</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">company</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_COMPANY</span><span class="p">);</span>
		<span class="n">device</span> <span class="o">=</span> <span class="n">dme1737_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DME1737_REG_DEVICE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">company</span> <span class="o">==</span> <span class="n">DME1737_COMPANY_SMSC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">SCH311X_DEVICE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">sch311x</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">company</span> <span class="o">==</span> <span class="n">DME1737_COMPANY_SMSC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">SCH5127_DEVICE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">sch5127</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_kfree</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">sch5127</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sch5127&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sch311x&quot;</span><span class="p">;</span>

	<span class="cm">/* Initialize the mutex */</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Found a %s chip at 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">sch5127</span> <span class="o">?</span> <span class="s">&quot;SCH5127&quot;</span> <span class="o">:</span> <span class="s">&quot;SCH311x&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

	<span class="cm">/* Initialize the chip */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">dme1737_init_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_kfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Create sysfs files */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">dme1737_create_files</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to create sysfs files.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_kfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Register device */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span> <span class="o">=</span> <span class="n">hwmon_device_register</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to register device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_remove_files</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_remove_files:</span>
	<span class="n">dme1737_remove_files</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">exit_kfree:</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="nl">exit_release_region:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">DME1737_EXTENT</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">dme1737_isa_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dme1737_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
	<span class="n">dme1737_remove_files</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">DME1737_EXTENT</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">dme1737_isa_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dme1737&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">dme1737_isa_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">dme1737_isa_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * Module initialization and cleanup</span>
<span class="cm"> * --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dme1737_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_add_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dme1737_i2c_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dme1737_isa_detect</span><span class="p">(</span><span class="mh">0x2e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dme1737_isa_detect</span><span class="p">(</span><span class="mh">0x4e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">probe_all_addr</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">dme1737_isa_detect</span><span class="p">(</span><span class="mh">0x162e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="n">dme1737_isa_detect</span><span class="p">(</span><span class="mh">0x164e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">))))</span> <span class="p">{</span>
		<span class="cm">/* Return 0 if we didn&#39;t find an ISA device */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dme1737_isa_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_del_i2c_driver</span><span class="p">;</span>

	<span class="cm">/* Sets global pdev as a side effect */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">dme1737_isa_device_add</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_del_isa_driver</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_del_isa_driver:</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dme1737_isa_driver</span><span class="p">);</span>
<span class="nl">exit_del_i2c_driver:</span>
	<span class="n">i2c_del_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dme1737_i2c_driver</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">dme1737_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dme1737_isa_driver</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i2c_del_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dme1737_i2c_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Juerg Haefliger &lt;juergh@gmail.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;DME1737 sensors&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">dme1737_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">dme1737_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
