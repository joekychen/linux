<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › hwmon › fschmd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>fschmd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * fschmd.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 - 2009 Hans de Goede &lt;hdegoede@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  Merged Fujitsu Siemens hwmon driver, supporting the Poseidon, Hermes,</span>
<span class="cm"> *  Scylla, Heracles, Heimdall, Hades and Syleus chips</span>
<span class="cm"> *</span>
<span class="cm"> *  Based on the original 2.4 fscscy, 2.6 fscpos, 2.6 fscher and 2.6</span>
<span class="cm"> *  (candidate) fschmd drivers:</span>
<span class="cm"> *  Copyright (C) 2006 Thilo Cestonaro</span>
<span class="cm"> *			&lt;thilo.cestonaro.external@fujitsu-siemens.com&gt;</span>
<span class="cm"> *  Copyright (C) 2004, 2005 Stefan Ott &lt;stefan@desire.ch&gt;</span>
<span class="cm"> *  Copyright (C) 2003, 2004 Reinhard Nissl &lt;rnissl@gmx.de&gt;</span>
<span class="cm"> *  Copyright (c) 2001 Martin Knoblauch &lt;mkn@teraport.de, knobi@knobisoft.de&gt;</span>
<span class="cm"> *  Copyright (C) 2000 Hermann Jung &lt;hej@odn.de&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon-sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/watchdog.h&gt;</span>
<span class="cp">#include &lt;linux/miscdevice.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/kref.h&gt;</span>

<span class="cm">/* Addresses to scan */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">normal_i2c</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x73</span><span class="p">,</span> <span class="n">I2C_CLIENT_END</span> <span class="p">};</span>

<span class="cm">/* Insmod parameters */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">nowayout</span> <span class="o">=</span> <span class="n">WATCHDOG_NOWAYOUT</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nowayout</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nowayout</span><span class="p">,</span> <span class="s">&quot;Watchdog cannot be stopped once started (default=&quot;</span>
	<span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">WATCHDOG_NOWAYOUT</span><span class="p">)</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>

<span class="k">enum</span> <span class="n">chips</span> <span class="p">{</span> <span class="n">fscpos</span><span class="p">,</span> <span class="n">fscher</span><span class="p">,</span> <span class="n">fscscy</span><span class="p">,</span> <span class="n">fschrc</span><span class="p">,</span> <span class="n">fschmd</span><span class="p">,</span> <span class="n">fschds</span><span class="p">,</span> <span class="n">fscsyl</span> <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The FSCHMD registers and other defines</span>
<span class="cm"> */</span>

<span class="cm">/* chip identification */</span>
<span class="cp">#define FSCHMD_REG_IDENT_0		0x00</span>
<span class="cp">#define FSCHMD_REG_IDENT_1		0x01</span>
<span class="cp">#define FSCHMD_REG_IDENT_2		0x02</span>
<span class="cp">#define FSCHMD_REG_REVISION		0x03</span>

<span class="cm">/* global control and status */</span>
<span class="cp">#define FSCHMD_REG_EVENT_STATE		0x04</span>
<span class="cp">#define FSCHMD_REG_CONTROL		0x05</span>

<span class="cp">#define FSCHMD_CONTROL_ALERT_LED	0x01</span>

<span class="cm">/* watchdog */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">FSCHMD_REG_WDOG_CONTROL</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x28</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">FSCHMD_REG_WDOG_STATE</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x29</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">FSCHMD_REG_WDOG_PRESET</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x2a</span> <span class="p">};</span>

<span class="cp">#define FSCHMD_WDOG_CONTROL_TRIGGER	0x10</span>
<span class="cp">#define FSCHMD_WDOG_CONTROL_STARTED	0x10 </span><span class="cm">/* the same as trigger */</span><span class="cp"></span>
<span class="cp">#define FSCHMD_WDOG_CONTROL_STOP	0x20</span>
<span class="cp">#define FSCHMD_WDOG_CONTROL_RESOLUTION	0x40</span>

<span class="cp">#define FSCHMD_WDOG_STATE_CARDRESET	0x02</span>

<span class="cm">/* voltages, weird order is to keep the same order as the old drivers */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">FSCHMD_REG_VOLT</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x48</span> <span class="p">},</span>				<span class="cm">/* pos */</span>
	<span class="p">{</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x48</span> <span class="p">},</span>				<span class="cm">/* her */</span>
	<span class="p">{</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x48</span> <span class="p">},</span>				<span class="cm">/* scy */</span>
	<span class="p">{</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x48</span> <span class="p">},</span>				<span class="cm">/* hrc */</span>
	<span class="p">{</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x48</span> <span class="p">},</span>				<span class="cm">/* hmd */</span>
	<span class="p">{</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x22</span> <span class="p">},</span>				<span class="cm">/* hds */</span>
	<span class="p">{</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x25</span> <span class="p">},</span>		<span class="cm">/* syl */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">FSCHMD_NO_VOLT_SENSORS</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span> <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * minimum pwm at which the fan is driven (pwm can by increased depending on</span>
<span class="cm"> * the temp. Notice that for the scy some fans share there minimum speed.</span>
<span class="cm"> * Also notice that with the scy the sensor order is different than with the</span>
<span class="cm"> * other chips, this order was in the 2.4 driver and kept for consistency.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">FSCHMD_REG_FAN_MIN</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x65</span> <span class="p">},</span>					<span class="cm">/* pos */</span>
	<span class="p">{</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xb5</span> <span class="p">},</span>				<span class="cm">/* her */</span>
	<span class="p">{</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xa5</span> <span class="p">},</span>		<span class="cm">/* scy */</span>
	<span class="p">{</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xb5</span> <span class="p">},</span>			<span class="cm">/* hrc */</span>
	<span class="p">{</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0xc5</span> <span class="p">},</span>		<span class="cm">/* hmd */</span>
	<span class="p">{</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0xc5</span> <span class="p">},</span>		<span class="cm">/* hds */</span>
	<span class="p">{</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0xb4</span> <span class="p">},</span>	<span class="cm">/* syl */</span>
<span class="p">};</span>

<span class="cm">/* actual fan speed */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">FSCHMD_REG_FAN_ACT</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0xab</span> <span class="p">},</span>				<span class="cm">/* pos */</span>
	<span class="p">{</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0xbb</span> <span class="p">},</span>				<span class="cm">/* her */</span>
	<span class="p">{</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0xbb</span> <span class="p">},</span>		<span class="cm">/* scy */</span>
	<span class="p">{</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0xbb</span> <span class="p">},</span>			<span class="cm">/* hrc */</span>
	<span class="p">{</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0xcb</span> <span class="p">},</span>		<span class="cm">/* hmd */</span>
	<span class="p">{</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0xcb</span> <span class="p">},</span>		<span class="cm">/* hds */</span>
	<span class="p">{</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0xb7</span> <span class="p">},</span>	<span class="cm">/* syl */</span>
<span class="p">};</span>

<span class="cm">/* fan status registers */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">FSCHMD_REG_FAN_STATE</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xa2</span> <span class="p">},</span>				<span class="cm">/* pos */</span>
	<span class="p">{</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xb2</span> <span class="p">},</span>				<span class="cm">/* her */</span>
	<span class="p">{</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xb2</span> <span class="p">},</span>		<span class="cm">/* scy */</span>
	<span class="p">{</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0xb2</span> <span class="p">},</span>			<span class="cm">/* hrc */</span>
	<span class="p">{</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xc2</span> <span class="p">},</span>		<span class="cm">/* hmd */</span>
	<span class="p">{</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xc2</span> <span class="p">},</span>		<span class="cm">/* hds */</span>
	<span class="p">{</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xb0</span> <span class="p">},</span>	<span class="cm">/* syl */</span>
<span class="p">};</span>

<span class="cm">/* fan ripple / divider registers */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">FSCHMD_REG_FAN_RIPPLE</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xaf</span> <span class="p">},</span>				<span class="cm">/* pos */</span>
	<span class="p">{</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xbf</span> <span class="p">},</span>				<span class="cm">/* her */</span>
	<span class="p">{</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0xbf</span> <span class="p">},</span>		<span class="cm">/* scy */</span>
	<span class="p">{</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0xbf</span> <span class="p">},</span>			<span class="cm">/* hrc */</span>
	<span class="p">{</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xcf</span> <span class="p">},</span>		<span class="cm">/* hmd */</span>
	<span class="p">{</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xcf</span> <span class="p">},</span>		<span class="cm">/* hds */</span>
	<span class="p">{</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0xb6</span> <span class="p">},</span>	<span class="cm">/* syl */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">FSCHMD_NO_FAN_SENSORS</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span> <span class="p">};</span>

<span class="cm">/* Fan status register bitmasks */</span>
<span class="cp">#define FSCHMD_FAN_ALARM	0x04 </span><span class="cm">/* called fault by FSC! */</span><span class="cp"></span>
<span class="cp">#define FSCHMD_FAN_NOT_PRESENT	0x08</span>
<span class="cp">#define FSCHMD_FAN_DISABLED	0x80</span>


<span class="cm">/* actual temperature registers */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">FSCHMD_REG_TEMP_ACT</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x35</span> <span class="p">},</span>				<span class="cm">/* pos */</span>
	<span class="p">{</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x35</span> <span class="p">},</span>				<span class="cm">/* her */</span>
	<span class="p">{</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xD0</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x35</span> <span class="p">},</span>			<span class="cm">/* scy */</span>
	<span class="p">{</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x35</span> <span class="p">},</span>				<span class="cm">/* hrc */</span>
	<span class="p">{</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0xe0</span> <span class="p">},</span>		<span class="cm">/* hmd */</span>
	<span class="p">{</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0xe0</span> <span class="p">},</span>		<span class="cm">/* hds */</span>
	<span class="p">{</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span>		<span class="cm">/* syl */</span>
	  <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xf8</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* temperature state registers */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">FSCHMD_REG_TEMP_STATE</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x91</span> <span class="p">},</span>				<span class="cm">/* pos */</span>
	<span class="p">{</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x91</span> <span class="p">},</span>				<span class="cm">/* her */</span>
	<span class="p">{</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x91</span> <span class="p">},</span>			<span class="cm">/* scy */</span>
	<span class="p">{</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x91</span> <span class="p">},</span>				<span class="cm">/* hrc */</span>
	<span class="p">{</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0xe1</span> <span class="p">},</span>		<span class="cm">/* hmd */</span>
	<span class="p">{</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0xe1</span> <span class="p">},</span>		<span class="cm">/* hds */</span>
	<span class="p">{</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span>		<span class="cm">/* syl */</span>
	  <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0xf9</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * temperature high limit registers, FSC does not document these. Proven to be</span>
<span class="cm"> * there with field testing on the fscher and fschrc, already supported / used</span>
<span class="cm"> * in the fscscy 2.4 driver. FSC has confirmed that the fschmd has registers</span>
<span class="cm"> * at these addresses, but doesn&#39;t want to confirm they are the same as with</span>
<span class="cm"> * the fscher??</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">FSCHMD_REG_TEMP_LIMIT</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>					<span class="cm">/* pos */</span>
	<span class="p">{</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x96</span> <span class="p">},</span>				<span class="cm">/* her */</span>
	<span class="p">{</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x96</span> <span class="p">},</span>			<span class="cm">/* scy */</span>
	<span class="p">{</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x96</span> <span class="p">},</span>				<span class="cm">/* hrc */</span>
	<span class="p">{</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0xe6</span> <span class="p">},</span>		<span class="cm">/* hmd */</span>
	<span class="p">{</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0xe6</span> <span class="p">},</span>		<span class="cm">/* hds */</span>
	<span class="p">{</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span>		<span class="cm">/* syl */</span>
	  <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0xfa</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * These were found through experimenting with an fscher, currently they are</span>
<span class="cm"> * not used, but we keep them around for future reference.</span>
<span class="cm"> * On the fscsyl AUTOP1 lives at 0x#c (so 0x5c for fan1, 0x6c for fan2, etc),</span>
<span class="cm"> * AUTOP2 lives at 0x#e, and 0x#1 is a bitmask defining which temps influence</span>
<span class="cm"> * the fan speed.</span>
<span class="cm"> * static const u8 FSCHER_REG_TEMP_AUTOP1[] =	{ 0x73, 0x83, 0x93 };</span>
<span class="cm"> * static const u8 FSCHER_REG_TEMP_AUTOP2[] =	{ 0x75, 0x85, 0x95 };</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">FSCHMD_NO_TEMP_SENSORS</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">11</span> <span class="p">};</span>

<span class="cm">/* temp status register bitmasks */</span>
<span class="cp">#define FSCHMD_TEMP_WORKING	0x01</span>
<span class="cp">#define FSCHMD_TEMP_ALERT	0x02</span>
<span class="cp">#define FSCHMD_TEMP_DISABLED	0x80</span>
<span class="cm">/* there only really is an alarm if the sensor is working and alert == 1 */</span>
<span class="cp">#define FSCHMD_TEMP_ALARM_MASK \</span>
<span class="cp">	(FSCHMD_TEMP_WORKING | FSCHMD_TEMP_ALERT)</span>

<span class="cm">/*</span>
<span class="cm"> * Functions declarations</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fschmd_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fschmd_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fschmd_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">fschmd_update_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Driver data (common to all clients)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">fschmd_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;fscpos&quot;</span><span class="p">,</span> <span class="n">fscpos</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;fscher&quot;</span><span class="p">,</span> <span class="n">fscher</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;fscscy&quot;</span><span class="p">,</span> <span class="n">fscscy</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;fschrc&quot;</span><span class="p">,</span> <span class="n">fschrc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;fschmd&quot;</span><span class="p">,</span> <span class="n">fschmd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;fschds&quot;</span><span class="p">,</span> <span class="n">fschds</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;fscsyl&quot;</span><span class="p">,</span> <span class="n">fscsyl</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">fschmd_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">fschmd_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">class</span>		<span class="o">=</span> <span class="n">I2C_CLASS_HWMON</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;fschmd&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">fschmd_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">fschmd_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">fschmd_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">fschmd_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">address_list</span>	<span class="o">=</span> <span class="n">normal_i2c</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Client data (each client gets its own)</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">hwmon_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">update_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">watchdog_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span> <span class="cm">/* member of the watchdog_data_list */</span>
	<span class="k">struct</span> <span class="n">kref</span> <span class="n">kref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">watchdog_miscdev</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">chips</span> <span class="n">kind</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">watchdog_is_open</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">watchdog_expect_close</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">watchdog_name</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span> <span class="cm">/* must be unique to avoid sysfs conflict */</span>
	<span class="kt">char</span> <span class="n">valid</span><span class="p">;</span> <span class="cm">/* zero until following fields are valid */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_updated</span><span class="p">;</span> <span class="cm">/* in jiffies */</span>

	<span class="cm">/* register values */</span>
	<span class="n">u8</span> <span class="n">revision</span><span class="p">;</span>            <span class="cm">/* chip revision */</span>
	<span class="n">u8</span> <span class="n">global_control</span><span class="p">;</span>	<span class="cm">/* global control register */</span>
	<span class="n">u8</span> <span class="n">watchdog_control</span><span class="p">;</span>    <span class="cm">/* watchdog control register */</span>
	<span class="n">u8</span> <span class="n">watchdog_state</span><span class="p">;</span>      <span class="cm">/* watchdog status register */</span>
	<span class="n">u8</span> <span class="n">watchdog_preset</span><span class="p">;</span>     <span class="cm">/* watchdog counter preset on trigger val */</span>
	<span class="n">u8</span> <span class="n">volt</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>		<span class="cm">/* voltage */</span>
	<span class="n">u8</span> <span class="n">temp_act</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>	<span class="cm">/* temperature */</span>
	<span class="n">u8</span> <span class="n">temp_status</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>	<span class="cm">/* status of sensor */</span>
	<span class="n">u8</span> <span class="n">temp_max</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>	<span class="cm">/* high temp limit, notice: undocumented! */</span>
	<span class="n">u8</span> <span class="n">fan_act</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>		<span class="cm">/* fans revolutions per second */</span>
	<span class="n">u8</span> <span class="n">fan_status</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>	<span class="cm">/* fan status */</span>
	<span class="n">u8</span> <span class="n">fan_min</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>		<span class="cm">/* fan min value for rps */</span>
	<span class="n">u8</span> <span class="n">fan_ripple</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>	<span class="cm">/* divider for rps */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Global variables to hold information read from special DMI tables, which are</span>
<span class="cm"> * available on FSC machines with an fscher or later chip. There is no need to</span>
<span class="cm"> * protect these with a lock as they are only modified from our attach function</span>
<span class="cm"> * which always gets called with the i2c-core lock held and never accessed</span>
<span class="cm"> * before the attach function is done with them.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dmi_mult</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">490</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">100</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dmi_offset</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dmi_vref</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Somewhat ugly :( global data pointer list with all fschmd devices, so that</span>
<span class="cm"> * we can find our device data as when using misc_register there is no other</span>
<span class="cm"> * method to get to ones device data from the open fop.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">watchdog_data_list</span><span class="p">);</span>
<span class="cm">/* Note this lock not only protect list access, but also data.kref access */</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Release our data struct when we&#39;re detached from the i2c client *and* all</span>
<span class="cm"> * references to our watchdog device are released</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fschmd_release_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fschmd_data</span><span class="p">,</span> <span class="n">kref</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sysfs attr show / store functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_in_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">max_reading</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">14200</span><span class="p">,</span> <span class="mi">6600</span><span class="p">,</span> <span class="mi">3300</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fschmd_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">fscher</span> <span class="o">||</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">&gt;=</span> <span class="n">fschrc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">volt</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="n">dmi_vref</span> <span class="o">*</span>
			<span class="n">dmi_mult</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">/</span> <span class="mi">255</span> <span class="o">+</span> <span class="n">dmi_offset</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">volt</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span>
			<span class="n">max_reading</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#define TEMP_FROM_REG(val)	(((val) - 128) * 1000)</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fschmd_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_act</span><span class="p">[</span><span class="n">index</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fschmd_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_max</span><span class="p">[</span><span class="n">index</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_temp_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span>
	<span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">v</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="o">-</span><span class="mi">128</span><span class="p">,</span> <span class="mi">127</span><span class="p">)</span> <span class="o">+</span> <span class="mi">128</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
		<span class="n">FSCHMD_REG_TEMP_LIMIT</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">][</span><span class="n">index</span><span class="p">],</span> <span class="n">v</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_max</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fschmd_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* bit 0 set means sensor working ok, so no fault! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_status</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FSCHMD_TEMP_WORKING</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fschmd_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_status</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FSCHMD_TEMP_ALARM_MASK</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">FSCHMD_TEMP_ALARM_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#define RPM_FROM_REG(val)	((val) * 60)</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_fan_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fschmd_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RPM_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_act</span><span class="p">[</span><span class="n">index</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_fan_div</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fschmd_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* bits 2..7 reserved =&gt; mask with 3 */</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_ripple</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_fan_div</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span>
	<span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* supported values: 2, 4, 8 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">v</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">v</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">v</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fan_div value %lu not supported. &quot;</span>
			<span class="s">&quot;Choose one of 2, 4 or 8!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
		<span class="n">FSCHMD_REG_FAN_RIPPLE</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">][</span><span class="n">index</span><span class="p">]);</span>

	<span class="cm">/* bits 2..7 reserved =&gt; mask with 0x03 */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
		<span class="n">FSCHMD_REG_FAN_RIPPLE</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">][</span><span class="n">index</span><span class="p">],</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_ripple</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_fan_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fschmd_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_status</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FSCHMD_FAN_ALARM</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_fan_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fschmd_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_status</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FSCHMD_FAN_NOT_PRESENT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pwm_auto_point1_pwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fschmd_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_min</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="cm">/* 0 = allow turning off (except on the syl), 1-255 = 50-100% */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">||</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">fscsyl</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">128</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_pwm_auto_point1_pwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* reg: 0 = allow turning off (except on the syl), 1-255 = 50-100% */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">||</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">fscsyl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
		<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
		<span class="n">FSCHMD_REG_FAN_MIN</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">][</span><span class="n">index</span><span class="p">],</span> <span class="n">v</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_min</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * The FSC hwmon family has the ability to force an attached alert led to flash</span>
<span class="cm"> * from software, we export this as an alert_led sysfs attr</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_alert_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fschmd_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">global_control</span> <span class="o">&amp;</span> <span class="n">FSCHMD_CONTROL_ALERT_LED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_alert_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">FSCHMD_REG_CONTROL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">FSCHMD_CONTROL_ALERT_LED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FSCHMD_CONTROL_ALERT_LED</span><span class="p">;</span>

	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">FSCHMD_REG_CONTROL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">global_control</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">alert_led</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_alert_led</span><span class="p">,</span> <span class="n">store_alert_led</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="n">fschmd_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">in0_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_in_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">in1_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_in_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">in2_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_in_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">in3_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_in_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">in4_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_in_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">in5_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_in_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="n">fschmd_temp_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp1_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp1_max</span><span class="p">,</span>   <span class="mo">0644</span><span class="p">,</span> <span class="n">show_temp_max</span><span class="p">,</span> <span class="n">store_temp_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp1_fault</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_fault</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp1_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp2_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp2_max</span><span class="p">,</span>   <span class="mo">0644</span><span class="p">,</span> <span class="n">show_temp_max</span><span class="p">,</span> <span class="n">store_temp_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp2_fault</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_fault</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp2_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp3_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp3_max</span><span class="p">,</span>   <span class="mo">0644</span><span class="p">,</span> <span class="n">show_temp_max</span><span class="p">,</span> <span class="n">store_temp_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp3_fault</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_fault</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp3_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp4_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp4_max</span><span class="p">,</span>   <span class="mo">0644</span><span class="p">,</span> <span class="n">show_temp_max</span><span class="p">,</span> <span class="n">store_temp_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp4_fault</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_fault</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp4_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp5_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp5_max</span><span class="p">,</span>   <span class="mo">0644</span><span class="p">,</span> <span class="n">show_temp_max</span><span class="p">,</span> <span class="n">store_temp_max</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp5_fault</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_fault</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp5_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp6_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp6_max</span><span class="p">,</span>   <span class="mo">0644</span><span class="p">,</span> <span class="n">show_temp_max</span><span class="p">,</span> <span class="n">store_temp_max</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp6_fault</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_fault</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp6_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp7_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp7_max</span><span class="p">,</span>   <span class="mo">0644</span><span class="p">,</span> <span class="n">show_temp_max</span><span class="p">,</span> <span class="n">store_temp_max</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp7_fault</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_fault</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp7_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp8_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp8_max</span><span class="p">,</span>   <span class="mo">0644</span><span class="p">,</span> <span class="n">show_temp_max</span><span class="p">,</span> <span class="n">store_temp_max</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp8_fault</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_fault</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp8_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp9_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp9_max</span><span class="p">,</span>   <span class="mo">0644</span><span class="p">,</span> <span class="n">show_temp_max</span><span class="p">,</span> <span class="n">store_temp_max</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp9_fault</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_fault</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp9_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp10_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp10_max</span><span class="p">,</span>   <span class="mo">0644</span><span class="p">,</span> <span class="n">show_temp_max</span><span class="p">,</span> <span class="n">store_temp_max</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp10_fault</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_fault</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp10_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp11_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp11_max</span><span class="p">,</span>   <span class="mo">0644</span><span class="p">,</span> <span class="n">show_temp_max</span><span class="p">,</span> <span class="n">store_temp_max</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp11_fault</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_fault</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">temp11_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_temp_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="n">fschmd_fan_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan1_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan1_div</span><span class="p">,</span>   <span class="mo">0644</span><span class="p">,</span> <span class="n">show_fan_div</span><span class="p">,</span> <span class="n">store_fan_div</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan1_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan1_fault</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_fault</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">pwm1_auto_point1_pwm</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_pwm_auto_point1_pwm</span><span class="p">,</span>
		<span class="n">store_pwm_auto_point1_pwm</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan2_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan2_div</span><span class="p">,</span>   <span class="mo">0644</span><span class="p">,</span> <span class="n">show_fan_div</span><span class="p">,</span> <span class="n">store_fan_div</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan2_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan2_fault</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_fault</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">pwm2_auto_point1_pwm</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_pwm_auto_point1_pwm</span><span class="p">,</span>
		<span class="n">store_pwm_auto_point1_pwm</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan3_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan3_div</span><span class="p">,</span>   <span class="mo">0644</span><span class="p">,</span> <span class="n">show_fan_div</span><span class="p">,</span> <span class="n">store_fan_div</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan3_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan3_fault</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_fault</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">pwm3_auto_point1_pwm</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_pwm_auto_point1_pwm</span><span class="p">,</span>
		<span class="n">store_pwm_auto_point1_pwm</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan4_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan4_div</span><span class="p">,</span>   <span class="mo">0644</span><span class="p">,</span> <span class="n">show_fan_div</span><span class="p">,</span> <span class="n">store_fan_div</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan4_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan4_fault</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_fault</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">pwm4_auto_point1_pwm</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_pwm_auto_point1_pwm</span><span class="p">,</span>
		<span class="n">store_pwm_auto_point1_pwm</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan5_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan5_div</span><span class="p">,</span>   <span class="mo">0644</span><span class="p">,</span> <span class="n">show_fan_div</span><span class="p">,</span> <span class="n">store_fan_div</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan5_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan5_fault</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_fault</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">pwm5_auto_point1_pwm</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_pwm_auto_point1_pwm</span><span class="p">,</span>
		<span class="n">store_pwm_auto_point1_pwm</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan6_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan6_div</span><span class="p">,</span>   <span class="mo">0644</span><span class="p">,</span> <span class="n">show_fan_div</span><span class="p">,</span> <span class="n">store_fan_div</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan6_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan6_fault</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_fault</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">pwm6_auto_point1_pwm</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_pwm_auto_point1_pwm</span><span class="p">,</span>
		<span class="n">store_pwm_auto_point1_pwm</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan7_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan7_div</span><span class="p">,</span>   <span class="mo">0644</span><span class="p">,</span> <span class="n">show_fan_div</span><span class="p">,</span> <span class="n">store_fan_div</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan7_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">fan7_fault</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_fan_fault</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR</span><span class="p">(</span><span class="n">pwm7_auto_point1_pwm</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_pwm_auto_point1_pwm</span><span class="p">,</span>
		<span class="n">store_pwm_auto_point1_pwm</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Watchdog routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_set_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">resolution</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">kind</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 0-x array index -&gt; 1-x module param */</span>

	<span class="cm">/* 2 second or 60 second resolution? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">510</span> <span class="o">||</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">fscpos</span> <span class="o">||</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">fscscy</span><span class="p">)</span>
		<span class="n">resolution</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">resolution</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="n">resolution</span> <span class="o">||</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">resolution</span> <span class="o">*</span> <span class="mi">255</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resolution</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FSCHMD_WDOG_CONTROL_RESOLUTION</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_control</span> <span class="o">|=</span> <span class="n">FSCHMD_WDOG_CONTROL_RESOLUTION</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_preset</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">resolution</span><span class="p">);</span>

	<span class="cm">/* Write new timeout value */</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
		<span class="n">FSCHMD_REG_WDOG_PRESET</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">],</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_preset</span><span class="p">);</span>
	<span class="cm">/* Write new control register, do not trigger! */</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
		<span class="n">FSCHMD_REG_WDOG_CONTROL</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">],</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_control</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FSCHMD_WDOG_CONTROL_TRIGGER</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_preset</span> <span class="o">*</span> <span class="n">resolution</span><span class="p">;</span>

<span class="nl">leave:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_get_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_control</span> <span class="o">&amp;</span> <span class="n">FSCHMD_WDOG_CONTROL_RESOLUTION</span><span class="p">)</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_preset</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_preset</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">timeout</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_control</span> <span class="o">|=</span> <span class="n">FSCHMD_WDOG_CONTROL_TRIGGER</span><span class="p">;</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
				  <span class="n">FSCHMD_REG_WDOG_CONTROL</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">],</span>
				  <span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_control</span><span class="p">);</span>
<span class="nl">leave:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FSCHMD_WDOG_CONTROL_STARTED</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t store the stop flag in our watchdog control register copy, as</span>
<span class="cm">	 * its a write only bit (read always returns 0)</span>
<span class="cm">	 */</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
		<span class="n">FSCHMD_REG_WDOG_CONTROL</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">],</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_control</span> <span class="o">|</span> <span class="n">FSCHMD_WDOG_CONTROL_STOP</span><span class="p">);</span>
<span class="nl">leave:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">watchdog_is_open</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We get called from drivers/char/misc.c with misc_mtx hold, and we</span>
<span class="cm">	 * call misc_register() from fschmd_probe() with watchdog_data_mutex</span>
<span class="cm">	 * hold, as misc_register() takes the misc_mtx lock, this is a possible</span>
<span class="cm">	 * deadlock, so we use mutex_trylock here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">watchdog_data_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">watchdog_miscdev</span><span class="p">.</span><span class="n">minor</span> <span class="o">==</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Note we can never not have found data, so we don&#39;t check for this */</span>
	<span class="n">watchdog_is_open</span> <span class="o">=</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_is_open</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">watchdog_is_open</span><span class="p">)</span>
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">watchdog_is_open</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Start the watchdog */</span>
	<span class="n">watchdog_trigger</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_expect_close</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">watchdog_stop</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_expect_close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">watchdog_trigger</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">dev_crit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;unexpected close, not stopping watchdog!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_is_open</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">fschmd_release_resources</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">watchdog_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nowayout</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

			<span class="cm">/* Clear it in case it was set with a previous write */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_expect_close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;V&#39;</span><span class="p">)</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_expect_close</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">watchdog_trigger</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">watchdog_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">watchdog_info</span> <span class="n">ident</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">WDIOF_KEEPALIVEPING</span> <span class="o">|</span> <span class="n">WDIOF_SETTIMEOUT</span> <span class="o">|</span>
				<span class="n">WDIOF_CARDRESET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">identity</span> <span class="o">=</span> <span class="s">&quot;FSC watchdog&quot;</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WDIOC_GETSUPPORT</span>:
		<span class="n">ident</span><span class="p">.</span><span class="n">firmware_version</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nowayout</span><span class="p">)</span>
			<span class="n">ident</span><span class="p">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">WDIOF_MAGICCLOSE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ident</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ident</span><span class="p">)))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WDIOC_GETSTATUS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WDIOC_GETBOOTSTATUS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_state</span> <span class="o">&amp;</span> <span class="n">FSCHMD_WDOG_STATE_CARDRESET</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">WDIOF_CARDRESET</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WDIOC_KEEPALIVE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">watchdog_trigger</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WDIOC_GETTIMEOUT</span>:
		<span class="n">i</span> <span class="o">=</span> <span class="n">watchdog_get_timeout</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WDIOC_SETTIMEOUT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">watchdog_set_timeout</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WDIOC_SETOPTIONS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">WDIOS_DISABLECARD</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">watchdog_stop</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">WDIOS_ENABLECARD</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">watchdog_trigger</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">watchdog_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">watchdog_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">watchdog_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">watchdog_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">watchdog_ioctl</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Detect, register, unregister and update device functions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * DMI decode routine to read voltage scaling factors from special DMI tables,</span>
<span class="cm"> * which are available on FSC machines with an fscher or later chip.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fschmd_dmi_decode</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">mult</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">},</span> <span class="n">offset</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">},</span> <span class="n">vref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * dmi code ugliness, we get passed the address of the contents of</span>
<span class="cm">	 * a complete DMI record, but in the form of a dmi_header pointer, in</span>
<span class="cm">	 * reality this address holds header-&gt;length bytes of which the header</span>
<span class="cm">	 * are the first 4 bytes</span>
<span class="cm">	 */</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dmi_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">;</span>

	<span class="cm">/* We are looking for OEM-specific type 185 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="mi">185</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * we are looking for what Siemens calls &quot;subtype&quot; 19, the subtype</span>
<span class="cm">	 * is stored in byte 5 of the dmi block</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">||</span> <span class="n">dmi_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">19</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * After the subtype comes 1 unknown byte and then blocks of 5 bytes,</span>
<span class="cm">	 * consisting of what Siemens calls an &quot;Entity&quot; number, followed by</span>
<span class="cm">	 * 2 16-bit words in LSB first order</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* entity 1 - 3: voltage multiplier and offset */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmi_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">dmi_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Our in sensors order and the DMI order differ */</span>
			<span class="k">const</span> <span class="kt">int</span> <span class="n">shuffle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="p">};</span>
			<span class="kt">int</span> <span class="n">in</span> <span class="o">=</span> <span class="n">shuffle</span><span class="p">[</span><span class="n">dmi_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

			<span class="cm">/* Check for twice the same entity */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">in</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="n">mult</span><span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmi_data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">dmi_data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">offset</span><span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmi_data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">dmi_data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

			<span class="n">found</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">in</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* entity 7: reference voltage */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmi_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Check for twice the same entity */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="n">vref</span> <span class="o">=</span> <span class="n">dmi_data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">dmi_data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

			<span class="n">found</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">==</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dmi_mult</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mult</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">dmi_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * According to the docs there should be separate dmi entries</span>
<span class="cm">		 * for the mult&#39;s and offsets of in3-5 of the syl, but on</span>
<span class="cm">		 * my test machine these are not present</span>
<span class="cm">		 */</span>
		<span class="n">dmi_mult</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmi_mult</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">dmi_mult</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmi_mult</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">dmi_mult</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmi_mult</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">dmi_offset</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmi_offset</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">dmi_offset</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmi_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">dmi_offset</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmi_offset</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">dmi_vref</span> <span class="o">=</span> <span class="n">vref</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fschmd_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">chips</span> <span class="n">kind</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">id</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_BYTE_DATA</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Detect &amp; Identify the chip */</span>
	<span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">FSCHMD_REG_IDENT_0</span><span class="p">);</span>
	<span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">FSCHMD_REG_IDENT_1</span><span class="p">);</span>
	<span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">FSCHMD_REG_IDENT_2</span><span class="p">);</span>
	<span class="n">id</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;PEG&quot;</span><span class="p">))</span>
		<span class="n">kind</span> <span class="o">=</span> <span class="n">fscpos</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;HER&quot;</span><span class="p">))</span>
		<span class="n">kind</span> <span class="o">=</span> <span class="n">fscher</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;SCY&quot;</span><span class="p">))</span>
		<span class="n">kind</span> <span class="o">=</span> <span class="n">fscscy</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;HRC&quot;</span><span class="p">))</span>
		<span class="n">kind</span> <span class="o">=</span> <span class="n">fschrc</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;HMD&quot;</span><span class="p">))</span>
		<span class="n">kind</span> <span class="o">=</span> <span class="n">fschmd</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;HDS&quot;</span><span class="p">))</span>
		<span class="n">kind</span> <span class="o">=</span> <span class="n">fschds</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;SYL&quot;</span><span class="p">))</span>
		<span class="n">kind</span> <span class="o">=</span> <span class="n">fscsyl</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">fschmd_id</span><span class="p">[</span><span class="n">kind</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">I2C_NAME_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fschmd_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">names</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Poseidon&quot;</span><span class="p">,</span> <span class="s">&quot;Hermes&quot;</span><span class="p">,</span> <span class="s">&quot;Scylla&quot;</span><span class="p">,</span>
				<span class="s">&quot;Heracles&quot;</span><span class="p">,</span> <span class="s">&quot;Heimdall&quot;</span><span class="p">,</span> <span class="s">&quot;Hades&quot;</span><span class="p">,</span> <span class="s">&quot;Syleus&quot;</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">watchdog_minors</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">WATCHDOG_MINOR</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">213</span><span class="p">,</span> <span class="mi">214</span><span class="p">,</span> <span class="mi">215</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">chips</span> <span class="n">kind</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fschmd_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Store client pointer in our data struct for watchdog usage</span>
<span class="cm">	 * (where the client is found through a data ptr instead of the</span>
<span class="cm">	 * otherway around)</span>
<span class="cm">	 */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="n">fscpos</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The Poseidon has hardwired temp limits, fill these</span>
<span class="cm">		 * in for the alarm resetting code</span>
<span class="cm">		 */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">70</span> <span class="o">+</span> <span class="mi">128</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">+</span> <span class="mi">128</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_max</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">+</span> <span class="mi">128</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read the special DMI table for fscher and newer chips */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">kind</span> <span class="o">==</span> <span class="n">fscher</span> <span class="o">||</span> <span class="n">kind</span> <span class="o">&gt;=</span> <span class="n">fschrc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dmi_vref</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmi_walk</span><span class="p">(</span><span class="n">fschmd_dmi_decode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmi_vref</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Couldn&#39;t get voltage scaling factors from &quot;</span>
				<span class="s">&quot;BIOS DMI table, using builtin defaults</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dmi_vref</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Read in some never changing registers */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">FSCHMD_REG_REVISION</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">global_control</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
					<span class="n">FSCHMD_REG_CONTROL</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_control</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
					<span class="n">FSCHMD_REG_WDOG_CONTROL</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">]);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_state</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
					<span class="n">FSCHMD_REG_WDOG_STATE</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">]);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_preset</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
					<span class="n">FSCHMD_REG_WDOG_PRESET</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">]);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_alert_led</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_detach</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FSCHMD_NO_VOLT_SENSORS</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">fschmd_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_detach</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">FSCHMD_NO_TEMP_SENSORS</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Poseidon doesn&#39;t have TEMP_LIMIT registers */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="n">fscpos</span> <span class="o">&amp;&amp;</span> <span class="n">fschmd_temp_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">show</span> <span class="o">==</span>
				<span class="n">show_temp_max</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="n">fscsyl</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_status</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						<span class="n">FSCHMD_REG_TEMP_STATE</span>
						<span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">][</span><span class="n">i</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_status</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FSCHMD_TEMP_DISABLED</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">fschmd_temp_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_detach</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">FSCHMD_NO_FAN_SENSORS</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Poseidon doesn&#39;t have a FAN_MIN register for its 3rd fan */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="n">fscpos</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">fschmd_fan_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
					<span class="s">&quot;pwm3_auto_point1_pwm&quot;</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="n">fscsyl</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_status</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						<span class="n">FSCHMD_REG_FAN_STATE</span>
						<span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">][</span><span class="n">i</span> <span class="o">/</span> <span class="mi">5</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_status</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FSCHMD_FAN_DISABLED</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">fschmd_fan_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_detach</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span> <span class="o">=</span> <span class="n">hwmon_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_detach</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We take the data_mutex lock early so that watchdog_open() cannot</span>
<span class="cm">	 * run when misc_register() has completed, but we&#39;ve not yet added</span>
<span class="cm">	 * our data to the watchdog_data_list (and set the default timeout)</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">watchdog_minors</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Register our watchdog part */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_name</span><span class="p">),</span>
			<span class="s">&quot;watchdog%c&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;\0&#39;</span> <span class="o">:</span> <span class="p">(</span><span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_miscdev</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_name</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_miscdev</span><span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">watchdog_fops</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_miscdev</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">watchdog_minors</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_miscdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_miscdev</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Registering watchdog chardev: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">watchdog_data_list</span><span class="p">);</span>
		<span class="n">watchdog_set_timeout</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Registered watchdog chardev major 10, minor: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">watchdog_minors</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">watchdog_minors</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_miscdev</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t register watchdog chardev &quot;</span>
			<span class="s">&quot;(due to no free minor)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Detected FSC %s chip, revision: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">names</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">],</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_detach:</span>
	<span class="n">fschmd_remove</span><span class="p">(</span><span class="n">client</span><span class="p">);</span> <span class="cm">/* will also free data for us */</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fschmd_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Unregister the watchdog (if registered) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_miscdev</span><span class="p">.</span><span class="n">minor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_miscdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_is_open</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;i2c client detached with watchdog open! &quot;</span>
				<span class="s">&quot;Stopping watchdog.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">watchdog_stop</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>
		<span class="cm">/* Tell the watchdog code the client is gone */</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if registered in case we&#39;re called from fschmd_detect</span>
<span class="cm">	 * to cleanup after an error</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">)</span>
		<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>

	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_alert_led</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">FSCHMD_NO_VOLT_SENSORS</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">]);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fschmd_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">FSCHMD_NO_TEMP_SENSORS</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">fschmd_temp_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">FSCHMD_NO_FAN_SENSORS</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">fschmd_fan_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">fschmd_release_resources</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="nf">fschmd_update_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fschmd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">last_updated</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FSCHMD_NO_TEMP_SENSORS</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_act</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
					<span class="n">FSCHMD_REG_TEMP_ACT</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
					<span class="n">FSCHMD_REG_TEMP_STATE</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>

			<span class="cm">/* The fscpos doesn&#39;t have TEMP_LIMIT registers */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">FSCHMD_REG_TEMP_LIMIT</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span>
					<span class="n">client</span><span class="p">,</span>
					<span class="n">FSCHMD_REG_TEMP_LIMIT</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>

			<span class="cm">/*</span>
<span class="cm">			 * reset alarm if the alarm condition is gone,</span>
<span class="cm">			 * the chip doesn&#39;t do this itself</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FSCHMD_TEMP_ALARM_MASK</span><span class="p">)</span> <span class="o">==</span>
					<span class="n">FSCHMD_TEMP_ALARM_MASK</span> <span class="o">&amp;&amp;</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_act</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_max</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
					<span class="n">FSCHMD_REG_TEMP_STATE</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_status</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FSCHMD_NO_FAN_SENSORS</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_act</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
					<span class="n">FSCHMD_REG_FAN_ACT</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
					<span class="n">FSCHMD_REG_FAN_STATE</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_ripple</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
					<span class="n">FSCHMD_REG_FAN_RIPPLE</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>

			<span class="cm">/* The fscpos third fan doesn&#39;t have a fan_min */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">FSCHMD_REG_FAN_MIN</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span>
					<span class="n">client</span><span class="p">,</span>
					<span class="n">FSCHMD_REG_FAN_MIN</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>

			<span class="cm">/* reset fan status if speed is back to &gt; 0 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FSCHMD_FAN_ALARM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_act</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
					<span class="n">FSCHMD_REG_FAN_STATE</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_status</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FSCHMD_NO_VOLT_SENSORS</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">volt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
					       <span class="n">FSCHMD_REG_VOLT</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">last_updated</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">fschmd_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Hans de Goede &lt;hdegoede@redhat.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;FSC Poseidon, Hermes, Scylla, Heracles, Heimdall, Hades &quot;</span>
			<span class="s">&quot;and Syleus driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
