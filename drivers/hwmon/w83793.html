<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › hwmon › w83793.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>w83793.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * w83793.c - Linux kernel driver for hardware monitoring</span>
<span class="cm"> * Copyright (C) 2006 Winbond Electronics Corp.</span>
<span class="cm"> *	      Yuan Mu</span>
<span class="cm"> *	      Rudolf Marek &lt;r.marek@assembler.cz&gt;</span>
<span class="cm"> * Copyright (C) 2009-2010 Sven Anders &lt;anders@anduras.de&gt;, ANDURAS AG.</span>
<span class="cm"> *		Watchdog driver part</span>
<span class="cm"> *		(Based partially on fschmd driver,</span>
<span class="cm"> *		 Copyright 2007-2008 by Hans de Goede)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation - version 2.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301 USA.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Supports following chips:</span>
<span class="cm"> *</span>
<span class="cm"> * Chip	#vin	#fanin	#pwm	#temp	wchipid	vendid	i2c	ISA</span>
<span class="cm"> * w83793	10	12	8	6	0x7b	0x5ca3	yes	no</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon-vid.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon-sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/watchdog.h&gt;</span>
<span class="cp">#include &lt;linux/miscdevice.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/kref.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>

<span class="cm">/* Default values */</span>
<span class="cp">#define WATCHDOG_TIMEOUT 2	</span><span class="cm">/* 2 minute default timeout */</span><span class="cp"></span>

<span class="cm">/* Addresses to scan */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">normal_i2c</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span>
						<span class="n">I2C_CLIENT_END</span> <span class="p">};</span>

<span class="cm">/* Insmod parameters */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">force_subclients</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">force_subclients</span><span class="p">,</span> <span class="kt">short</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">force_subclients</span><span class="p">,</span> <span class="s">&quot;List of subclient addresses: &quot;</span>
		       <span class="s">&quot;{bus, clientaddr, subclientaddr1, subclientaddr2}&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">reset</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">reset</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">reset</span><span class="p">,</span> <span class="s">&quot;Set to 1 to reset chip, not recommended&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">WATCHDOG_TIMEOUT</span><span class="p">;</span>	<span class="cm">/* default timeout in minutes */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span>
	<span class="s">&quot;Watchdog timeout in minutes. 2&lt;= timeout &lt;=255 (default=&quot;</span>
				<span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">WATCHDOG_TIMEOUT</span><span class="p">)</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">nowayout</span> <span class="o">=</span> <span class="n">WATCHDOG_NOWAYOUT</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nowayout</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nowayout</span><span class="p">,</span>
	<span class="s">&quot;Watchdog cannot be stopped once started (default=&quot;</span>
				<span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">WATCHDOG_NOWAYOUT</span><span class="p">)</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Address 0x00, 0x0d, 0x0e, 0x0f in all three banks are reserved</span>
<span class="cm"> * as ID, Bank Select registers</span>
<span class="cm"> */</span>
<span class="cp">#define W83793_REG_BANKSEL		0x00</span>
<span class="cp">#define W83793_REG_VENDORID		0x0d</span>
<span class="cp">#define W83793_REG_CHIPID		0x0e</span>
<span class="cp">#define W83793_REG_DEVICEID		0x0f</span>

<span class="cp">#define W83793_REG_CONFIG		0x40</span>
<span class="cp">#define W83793_REG_MFC			0x58</span>
<span class="cp">#define W83793_REG_FANIN_CTRL		0x5c</span>
<span class="cp">#define W83793_REG_FANIN_SEL		0x5d</span>
<span class="cp">#define W83793_REG_I2C_ADDR		0x0b</span>
<span class="cp">#define W83793_REG_I2C_SUBADDR		0x0c</span>
<span class="cp">#define W83793_REG_VID_INA		0x05</span>
<span class="cp">#define W83793_REG_VID_INB		0x06</span>
<span class="cp">#define W83793_REG_VID_LATCHA		0x07</span>
<span class="cp">#define W83793_REG_VID_LATCHB		0x08</span>
<span class="cp">#define W83793_REG_VID_CTRL		0x59</span>

<span class="cp">#define W83793_REG_WDT_LOCK		0x01</span>
<span class="cp">#define W83793_REG_WDT_ENABLE		0x02</span>
<span class="cp">#define W83793_REG_WDT_STATUS		0x03</span>
<span class="cp">#define W83793_REG_WDT_TIMEOUT		0x04</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">W83793_REG_TEMP_MODE</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x5f</span> <span class="p">};</span>

<span class="cp">#define TEMP_READ	0</span>
<span class="cp">#define TEMP_CRIT	1</span>
<span class="cp">#define TEMP_CRIT_HYST	2</span>
<span class="cp">#define TEMP_WARN	3</span>
<span class="cp">#define TEMP_WARN_HYST	4</span>
<span class="cm">/*</span>
<span class="cm"> * only crit and crit_hyst affect real-time alarm status</span>
<span class="cm"> * current crit crit_hyst warn warn_hyst</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">W83793_REG_TEMP</span><span class="p">[][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define W83793_REG_TEMP_LOW_BITS	0x22</span>

<span class="cp">#define W83793_REG_BEEP(index)		(0x53 + (index))</span>
<span class="cp">#define W83793_REG_ALARM(index)		(0x4b + (index))</span>

<span class="cp">#define W83793_REG_CLR_CHASSIS		0x4a	</span><span class="cm">/* SMI MASK4 */</span><span class="cp"></span>
<span class="cp">#define W83793_REG_IRQ_CTRL		0x50</span>
<span class="cp">#define W83793_REG_OVT_CTRL		0x51</span>
<span class="cp">#define W83793_REG_OVT_BEEP		0x52</span>

<span class="cp">#define IN_READ				0</span>
<span class="cp">#define IN_MAX				1</span>
<span class="cp">#define IN_LOW				2</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">W83793_REG_IN</span><span class="p">[][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Current, High, Low */</span>
	<span class="p">{</span><span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">},</span>	<span class="cm">/* Vcore A	*/</span>
	<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">},</span>	<span class="cm">/* Vcore B	*/</span>
	<span class="p">{</span><span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">},</span>	<span class="cm">/* Vtt		*/</span>
	<span class="p">{</span><span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">},</span>	<span class="cm">/* VSEN1	*/</span>
	<span class="p">{</span><span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">},</span>	<span class="cm">/* VSEN2	*/</span>
	<span class="p">{</span><span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">},</span>	<span class="cm">/* +3VSEN	*/</span>
	<span class="p">{</span><span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">},</span>	<span class="cm">/* +12VSEN	*/</span>
	<span class="p">{</span><span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">},</span>	<span class="cm">/* 5VDD		*/</span>
	<span class="p">{</span><span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">},</span>	<span class="cm">/* 5VSB		*/</span>
	<span class="p">{</span><span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">},</span>	<span class="cm">/* VBAT		*/</span>
<span class="p">};</span>

<span class="cm">/* Low Bits of Vcore A/B Vtt Read/High/Low */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">W83793_REG_IN_LOW_BITS</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x69</span> <span class="p">};</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">scale_in</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">16</span> <span class="p">};</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">scale_in_add</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

<span class="cp">#define W83793_REG_FAN(index)		(0x23 + 2 * (index))	</span><span class="cm">/* High byte */</span><span class="cp"></span>
<span class="cp">#define W83793_REG_FAN_MIN(index)	(0x90 + 2 * (index))	</span><span class="cm">/* High byte */</span><span class="cp"></span>

<span class="cp">#define W83793_REG_PWM_DEFAULT		0xb2</span>
<span class="cp">#define W83793_REG_PWM_ENABLE		0x207</span>
<span class="cp">#define W83793_REG_PWM_UPTIME		0xc3	</span><span class="cm">/* Unit in 0.1 second */</span><span class="cp"></span>
<span class="cp">#define W83793_REG_PWM_DOWNTIME		0xc4	</span><span class="cm">/* Unit in 0.1 second */</span><span class="cp"></span>
<span class="cp">#define W83793_REG_TEMP_CRITICAL	0xc5</span>

<span class="cp">#define PWM_DUTY			0</span>
<span class="cp">#define PWM_START			1</span>
<span class="cp">#define PWM_NONSTOP			2</span>
<span class="cp">#define PWM_STOP_TIME			3</span>
<span class="cp">#define W83793_REG_PWM(index, nr)	(((nr) == 0 ? 0xb3 : \</span>
<span class="cp">					 (nr) == 1 ? 0x220 : 0x218) + (index))</span>

<span class="cm">/* bit field, fan1 is bit0, fan2 is bit1 ... */</span>
<span class="cp">#define W83793_REG_TEMP_FAN_MAP(index)	(0x201 + (index))</span>
<span class="cp">#define W83793_REG_TEMP_TOL(index)	(0x208 + (index))</span>
<span class="cp">#define W83793_REG_TEMP_CRUISE(index)	(0x210 + (index))</span>
<span class="cp">#define W83793_REG_PWM_STOP_TIME(index)	(0x228 + (index))</span>
<span class="cp">#define W83793_REG_SF2_TEMP(index, nr)	(0x230 + ((index) &lt;&lt; 4) + (nr))</span>
<span class="cp">#define W83793_REG_SF2_PWM(index, nr)	(0x238 + ((index) &lt;&lt; 4) + (nr))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">FAN_FROM_REG</span><span class="p">(</span><span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span>	<span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1350000UL</span> <span class="o">/</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">FAN_TO_REG</span><span class="p">(</span><span class="kt">long</span> <span class="n">rpm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rpm</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mh">0x0fff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">SENSORS_LIMIT</span><span class="p">((</span><span class="mi">1350000</span> <span class="o">+</span> <span class="p">(</span><span class="n">rpm</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">rpm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xffe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">TIME_FROM_REG</span><span class="p">(</span><span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">reg</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">TIME_TO_REG</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">SENSORS_LIMIT</span><span class="p">((</span><span class="n">val</span> <span class="o">+</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span> <span class="nf">TEMP_FROM_REG</span><span class="p">(</span><span class="n">s8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">reg</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">s8</span> <span class="nf">TEMP_TO_REG</span><span class="p">(</span><span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="n">s8</span> <span class="n">min</span><span class="p">,</span> <span class="n">s8</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">SENSORS_LIMIT</span><span class="p">((</span><span class="n">val</span> <span class="o">+</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">500</span> <span class="o">:</span> <span class="mi">500</span><span class="p">))</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">w83793_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">lm75</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">hwmon_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">update_lock</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">valid</span><span class="p">;</span>			<span class="cm">/* !=0 if following fields are valid */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_updated</span><span class="p">;</span>	<span class="cm">/* In jiffies */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_nonvolatile</span><span class="p">;</span>	<span class="cm">/* In jiffies, last time we update the</span>
<span class="cm">					 * nonvolatile registers</span>
<span class="cm">					 */</span>

	<span class="n">u8</span> <span class="n">bank</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vrm</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vid</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">in</span><span class="p">[</span><span class="mi">10</span><span class="p">][</span><span class="mi">3</span><span class="p">];</span>		<span class="cm">/* Register value, read/high/low */</span>
	<span class="n">u8</span> <span class="n">in_low_bits</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	<span class="cm">/* Additional resolution for VCore A/B Vtt */</span>

	<span class="n">u16</span> <span class="n">has_fan</span><span class="p">;</span>		<span class="cm">/* Only fan1- fan5 has own pins */</span>
	<span class="n">u16</span> <span class="n">fan</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>		<span class="cm">/* Register value combine */</span>
	<span class="n">u16</span> <span class="n">fan_min</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>	<span class="cm">/* Register value combine */</span>

	<span class="n">s8</span> <span class="n">temp</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">5</span><span class="p">];</span>		<span class="cm">/* current, crit, crit_hyst,warn, warn_hyst */</span>
	<span class="n">u8</span> <span class="n">temp_low_bits</span><span class="p">;</span>	<span class="cm">/* Additional resolution TD1-TD4 */</span>
	<span class="n">u8</span> <span class="n">temp_mode</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* byte 0: Temp D1-D4 mode each has 2 bits</span>
<span class="cm">				 * byte 1: Temp R1,R2 mode, each has 1 bit</span>
<span class="cm">				 */</span>
	<span class="n">u8</span> <span class="n">temp_critical</span><span class="p">;</span>	<span class="cm">/* If reached all fan will be at full speed */</span>
	<span class="n">u8</span> <span class="n">temp_fan_map</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>	<span class="cm">/* Temp controls which pwm fan, bit field */</span>

	<span class="n">u8</span> <span class="n">has_pwm</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">has_temp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">has_vid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pwm_enable</span><span class="p">;</span>		<span class="cm">/* Register value, each Temp has 1 bit */</span>
	<span class="n">u8</span> <span class="n">pwm_uptime</span><span class="p">;</span>		<span class="cm">/* Register value */</span>
	<span class="n">u8</span> <span class="n">pwm_downtime</span><span class="p">;</span>	<span class="cm">/* Register value */</span>
	<span class="n">u8</span> <span class="n">pwm_default</span><span class="p">;</span>		<span class="cm">/* All fan default pwm, next poweron valid */</span>
	<span class="n">u8</span> <span class="n">pwm</span><span class="p">[</span><span class="mi">8</span><span class="p">][</span><span class="mi">3</span><span class="p">];</span>		<span class="cm">/* Register value */</span>
	<span class="n">u8</span> <span class="n">pwm_stop_time</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">temp_cruise</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">u8</span> <span class="n">alarms</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>		<span class="cm">/* realtime status registers */</span>
	<span class="n">u8</span> <span class="n">beeps</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">beep_enable</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tolerance</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	<span class="cm">/* Temp tolerance(Smart Fan I/II) */</span>
	<span class="n">u8</span> <span class="n">sf2_pwm</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">7</span><span class="p">];</span>	<span class="cm">/* Smart FanII: Fan duty cycle */</span>
	<span class="n">u8</span> <span class="n">sf2_temp</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">7</span><span class="p">];</span>	<span class="cm">/* Smart FanII: Temp level point */</span>

	<span class="cm">/* watchdog */</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">watchdog_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span> <span class="cm">/* member of the watchdog_data_list */</span>
	<span class="k">struct</span> <span class="n">kref</span> <span class="n">kref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">watchdog_miscdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">watchdog_is_open</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">watchdog_expect_close</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">watchdog_name</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span> <span class="cm">/* must be unique to avoid sysfs conflict */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">watchdog_caused_reboot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">watchdog_timeout</span><span class="p">;</span> <span class="cm">/* watchdog timeout in minutes */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Somewhat ugly :( global data pointer list with all devices, so that</span>
<span class="cm"> * we can find our device data as when using misc_register. There is no</span>
<span class="cm"> * other method to get to one&#39;s device data from the open file-op and</span>
<span class="cm"> * for usage in the reboot notifier callback.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">watchdog_data_list</span><span class="p">);</span>

<span class="cm">/* Note this lock not only protect list access, but also data.kref access */</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Release our data struct when we&#39;re detached from the i2c client *and* all</span>
<span class="cm"> * references to our watchdog device are released</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">w83793_release_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">w83793_data</span><span class="p">,</span> <span class="n">kref</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">w83793_write_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">w83793_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">w83793_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">w83793_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">w83793_init_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">w83793_update_nonvolatile</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">w83793_update_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">w83793_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;w83793&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">w83793_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">w83793_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">class</span>		<span class="o">=</span> <span class="n">I2C_CLASS_HWMON</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		   <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;w83793&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">w83793_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">w83793_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">w83793_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">w83793_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">address_list</span>	<span class="o">=</span> <span class="n">normal_i2c</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_vrm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">vrm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">w83793_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vid_from_reg</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">vrm</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_vrm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">vrm</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ALARM_STATUS			0</span>
<span class="cp">#define BEEP_ENABLE			1</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_alarm_beep</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">w83793_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">ALARM_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">bit</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* BEEP_ENABLE */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">beeps</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">bit</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_beep</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">beep_bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">beeps</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_BEEP</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">beeps</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">beep_bit</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">beeps</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">|=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_BEEP</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">beeps</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_beep_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">w83793_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">beep_enable</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_beep_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">beep_enable</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_OVT_BEEP</span><span class="p">)</span>
			    <span class="o">&amp;</span> <span class="mh">0xfd</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">beep_enable</span> <span class="o">|=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_OVT_BEEP</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">beep_enable</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write any value to clear chassis alarm */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_chassis_clear_legacy</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Attribute chassis is deprecated, &quot;</span>
		 <span class="s">&quot;use intrusion0_alarm instead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_CLR_CHASSIS</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_CLR_CHASSIS</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write 0 to clear chassis alarm */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_chassis_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		    <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_CLR_CHASSIS</span><span class="p">);</span>
	<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_CLR_CHASSIS</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Force cache refresh */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define FAN_INPUT			0</span>
<span class="cp">#define FAN_MIN				1</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_fan</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">w83793_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">FAN_INPUT</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fan</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_min</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">FAN_FROM_REG</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_fan_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">FAN_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_min</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_FAN_MIN</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
			   <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_FAN_MIN</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_pwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">w83793_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">PWM_STOP_TIME</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">TIME_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_stop_time</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_pwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">PWM_STOP_TIME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">TIME_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_stop_time</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_PWM_STOP_TIME</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
				   <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_PWM</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">nr</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">|=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_PWM</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">nr</span><span class="p">),</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">w83793_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">TEMP_READ</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Only TD1-TD4 have low bits */</span>
		<span class="kt">int</span> <span class="n">low</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_low_bits</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">*</span> <span class="mi">250</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">+=</span> <span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">low</span> <span class="o">:</span> <span class="o">-</span><span class="n">low</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEMP_TO_REG</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">-</span><span class="mi">128</span><span class="p">,</span> <span class="mi">127</span><span class="p">);</span>
	<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">],</span>
			   <span class="n">data</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TD1-TD4</span>
<span class="cm"> * each has 4 mode:(2 bits)</span>
<span class="cm"> * 0:	Stop monitor</span>
<span class="cm"> * 1:	Use internal temp sensor(default)</span>
<span class="cm"> * 2:	Reserved</span>
<span class="cm"> * 3:	Use sensor in Intel CPU and get result by PECI</span>
<span class="cm"> *</span>
<span class="cm"> * TR1-TR2</span>
<span class="cm"> * each has 2 mode:(1 bit)</span>
<span class="cm"> * 0:	Disable temp sensor monitor</span>
<span class="cm"> * 1:	To enable temp sensors monitor</span>
<span class="cm"> */</span>

<span class="cm">/* 0 disable, 6 PECI */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">TO_TEMP_MODE</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_temp_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">w83793_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x03</span> <span class="o">:</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_mode</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* for the internal sensor, found out if diode or thermistor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">TO_TEMP_MODE</span><span class="p">[</span><span class="n">tmp</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_temp_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x03</span> <span class="o">:</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* transform the sysfs interface values into table above */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* transform diode or thermistor into internal enable */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">!!</span><span class="n">val</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_mode</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span>
	    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP_MODE</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_mode</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_mode</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">|=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP_MODE</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_mode</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SETUP_PWM_DEFAULT		0</span>
<span class="cp">#define SETUP_PWM_UPTIME		1	</span><span class="cm">/* Unit in 0.1s */</span><span class="cp"></span>
<span class="cp">#define SETUP_PWM_DOWNTIME		2	</span><span class="cm">/* Unit in 0.1s */</span><span class="cp"></span>
<span class="cp">#define SETUP_TEMP_CRITICAL		3</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_sf_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">w83793_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">SETUP_PWM_DEFAULT</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_default</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">SETUP_PWM_UPTIME</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">TIME_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_uptime</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">SETUP_PWM_DOWNTIME</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">TIME_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_downtime</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">SETUP_TEMP_CRITICAL</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_critical</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_sf_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">SETUP_PWM_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_default</span> <span class="o">=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_PWM_DEFAULT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_default</span> <span class="o">|=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_PWM_DEFAULT</span><span class="p">,</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_default</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">SETUP_PWM_UPTIME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_uptime</span> <span class="o">=</span> <span class="n">TIME_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_uptime</span> <span class="o">+=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_uptime</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_PWM_UPTIME</span><span class="p">,</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_uptime</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">SETUP_PWM_DOWNTIME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_downtime</span> <span class="o">=</span> <span class="n">TIME_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_downtime</span> <span class="o">+=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_downtime</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_PWM_DOWNTIME</span><span class="p">,</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_downtime</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* SETUP_TEMP_CRITICAL */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_critical</span> <span class="o">=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP_CRITICAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_critical</span> <span class="o">|=</span> <span class="n">TEMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">);</span>
		<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP_CRITICAL</span><span class="p">,</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_critical</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Temp SmartFan control</span>
<span class="cm"> * TEMP_FAN_MAP</span>
<span class="cm"> * Temp channel control which pwm fan, bitfield, bit 0 indicate pwm1...</span>
<span class="cm"> * It&#39;s possible two or more temp channels control the same fan, w83793</span>
<span class="cm"> * always prefers to pick the most critical request and applies it to</span>
<span class="cm"> * the related Fan.</span>
<span class="cm"> * It&#39;s possible one fan is not in any mapping of 6 temp channels, this</span>
<span class="cm"> * means the fan is manual mode</span>
<span class="cm"> *</span>
<span class="cm"> * TEMP_PWM_ENABLE</span>
<span class="cm"> * Each temp channel has its own SmartFan mode, and temp channel</span>
<span class="cm"> * control fans that are set by TEMP_FAN_MAP</span>
<span class="cm"> * 0:	SmartFanII mode</span>
<span class="cm"> * 1:	Thermal Cruise Mode</span>
<span class="cm"> *</span>
<span class="cm"> * TEMP_CRUISE</span>
<span class="cm"> * Target temperature in thermal cruise mode, w83793 will try to turn</span>
<span class="cm"> * fan speed to keep the temperature of target device around this</span>
<span class="cm"> * temperature.</span>
<span class="cm"> *</span>
<span class="cm"> * TEMP_TOLERANCE</span>
<span class="cm"> * If Temp higher or lower than target with this tolerance, w83793</span>
<span class="cm"> * will take actions to speed up or slow down the fan to keep the</span>
<span class="cm"> * temperature within the tolerance range.</span>
<span class="cm"> */</span>

<span class="cp">#define TEMP_FAN_MAP			0</span>
<span class="cp">#define TEMP_PWM_ENABLE			1</span>
<span class="cp">#define TEMP_CRUISE			2</span>
<span class="cp">#define TEMP_TOLERANCE			3</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_sf_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">w83793_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">TEMP_FAN_MAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_fan_map</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">TEMP_PWM_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* +2 to transfrom into 2 and 3 to conform with sysfs intf */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_enable</span> <span class="o">&gt;&gt;</span> <span class="n">index</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">TEMP_CRUISE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_cruise</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* TEMP_TOLERANCE */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">tolerance</span><span class="p">[</span><span class="n">index</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">index</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_sf_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">TEMP_FAN_MAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
		<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP_FAN_MAP</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_fan_map</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">TEMP_PWM_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_enable</span> <span class="o">=</span>
			    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_PWM_ENABLE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_enable</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_enable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">);</span>
			<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_PWM_ENABLE</span><span class="p">,</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_enable</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">TEMP_CRUISE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_cruise</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP_CRUISE</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_cruise</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_cruise</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TEMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">);</span>

		<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP_CRUISE</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
						<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_cruise</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* TEMP_TOLERANCE */</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">index</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">tolerance</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP_TOL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">tolerance</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0f</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">tolerance</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TEMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
		<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP_TOL</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">tolerance</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_sf2_pwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">w83793_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sf2_pwm</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_sf2_pwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sf2_pwm</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span>
	    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_SF2_PWM</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">nr</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sf2_pwm</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">|=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_SF2_PWM</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">nr</span><span class="p">),</span>
						<span class="n">data</span><span class="o">-&gt;</span><span class="n">sf2_pwm</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_sf2_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">w83793_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sf2_temp</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_sf2_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">TEMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sf2_temp</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span>
	    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_SF2_TEMP</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">nr</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sf2_temp</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">|=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_SF2_TEMP</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">nr</span><span class="p">),</span>
					     <span class="n">data</span><span class="o">-&gt;</span><span class="n">sf2_temp</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* only Vcore A/B and Vtt have additional 2 bits precision */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">w83793_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">+=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">in_low_bits</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* voltage inputs 5VDD and 5VSB needs 150mV offset */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="n">scale_in</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">scale_in_add</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
	    <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">+</span> <span class="n">scale_in</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale_in</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* fix the limit values of 5VDD and 5VSB to ALARM mechanism */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">-=</span> <span class="n">scale_in_add</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale_in</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3FF</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_low_bits</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_IN_LOW_BITS</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_low_bits</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span><span class="p">));</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_low_bits</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_IN_LOW_BITS</span><span class="p">[</span><span class="n">nr</span><span class="p">],</span>
						     <span class="n">data</span><span class="o">-&gt;</span><span class="n">in_low_bits</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
		<span class="n">val</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_IN</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">],</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">nr</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NOT_USED			-1</span>

<span class="cp">#define SENSOR_ATTR_IN(index)						\</span>
<span class="cp">	SENSOR_ATTR_2(in##index##_input, S_IRUGO, show_in, NULL,	\</span>
<span class="cp">		IN_READ, index),					\</span>
<span class="cp">	SENSOR_ATTR_2(in##index##_max, S_IRUGO | S_IWUSR, show_in,	\</span>
<span class="cp">		store_in, IN_MAX, index),				\</span>
<span class="cp">	SENSOR_ATTR_2(in##index##_min, S_IRUGO | S_IWUSR, show_in,	\</span>
<span class="cp">		store_in, IN_LOW, index),				\</span>
<span class="cp">	SENSOR_ATTR_2(in##index##_alarm, S_IRUGO, show_alarm_beep,	\</span>
<span class="cp">		NULL, ALARM_STATUS, index + ((index &gt; 2) ? 1 : 0)),	\</span>
<span class="cp">	SENSOR_ATTR_2(in##index##_beep, S_IWUSR | S_IRUGO,		\</span>
<span class="cp">		show_alarm_beep, store_beep, BEEP_ENABLE,		\</span>
<span class="cp">		index + ((index &gt; 2) ? 1 : 0))</span>

<span class="cp">#define SENSOR_ATTR_FAN(index)						\</span>
<span class="cp">	SENSOR_ATTR_2(fan##index##_alarm, S_IRUGO, show_alarm_beep,	\</span>
<span class="cp">		NULL, ALARM_STATUS, index + 17),			\</span>
<span class="cp">	SENSOR_ATTR_2(fan##index##_beep, S_IWUSR | S_IRUGO,		\</span>
<span class="cp">		show_alarm_beep, store_beep, BEEP_ENABLE, index + 17),	\</span>
<span class="cp">	SENSOR_ATTR_2(fan##index##_input, S_IRUGO, show_fan,		\</span>
<span class="cp">		NULL, FAN_INPUT, index - 1),				\</span>
<span class="cp">	SENSOR_ATTR_2(fan##index##_min, S_IWUSR | S_IRUGO,		\</span>
<span class="cp">		show_fan, store_fan_min, FAN_MIN, index - 1)</span>

<span class="cp">#define SENSOR_ATTR_PWM(index)						\</span>
<span class="cp">	SENSOR_ATTR_2(pwm##index, S_IWUSR | S_IRUGO, show_pwm,		\</span>
<span class="cp">		store_pwm, PWM_DUTY, index - 1),			\</span>
<span class="cp">	SENSOR_ATTR_2(pwm##index##_nonstop, S_IWUSR | S_IRUGO,		\</span>
<span class="cp">		show_pwm, store_pwm, PWM_NONSTOP, index - 1),		\</span>
<span class="cp">	SENSOR_ATTR_2(pwm##index##_start, S_IWUSR | S_IRUGO,		\</span>
<span class="cp">		show_pwm, store_pwm, PWM_START, index - 1),		\</span>
<span class="cp">	SENSOR_ATTR_2(pwm##index##_stop_time, S_IWUSR | S_IRUGO,	\</span>
<span class="cp">		show_pwm, store_pwm, PWM_STOP_TIME, index - 1)</span>

<span class="cp">#define SENSOR_ATTR_TEMP(index)						\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_type, S_IRUGO | S_IWUSR,		\</span>
<span class="cp">		show_temp_mode, store_temp_mode, NOT_USED, index - 1),	\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_input, S_IRUGO, show_temp,		\</span>
<span class="cp">		NULL, TEMP_READ, index - 1),				\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_max, S_IRUGO | S_IWUSR, show_temp,	\</span>
<span class="cp">		store_temp, TEMP_CRIT, index - 1),			\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_max_hyst, S_IRUGO | S_IWUSR,	\</span>
<span class="cp">		show_temp, store_temp, TEMP_CRIT_HYST, index - 1),	\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_warn, S_IRUGO | S_IWUSR, show_temp,	\</span>
<span class="cp">		store_temp, TEMP_WARN, index - 1),			\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_warn_hyst, S_IRUGO | S_IWUSR,	\</span>
<span class="cp">		show_temp, store_temp, TEMP_WARN_HYST, index - 1),	\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_alarm, S_IRUGO,			\</span>
<span class="cp">		show_alarm_beep, NULL, ALARM_STATUS, index + 11),	\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_beep, S_IWUSR | S_IRUGO,		\</span>
<span class="cp">		show_alarm_beep, store_beep, BEEP_ENABLE, index + 11),	\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_auto_channels_pwm,			\</span>
<span class="cp">		S_IRUGO | S_IWUSR, show_sf_ctrl, store_sf_ctrl,		\</span>
<span class="cp">		TEMP_FAN_MAP, index - 1),				\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_pwm_enable, S_IWUSR | S_IRUGO,	\</span>
<span class="cp">		show_sf_ctrl, store_sf_ctrl, TEMP_PWM_ENABLE,		\</span>
<span class="cp">		index - 1),						\</span>
<span class="cp">	SENSOR_ATTR_2(thermal_cruise##index, S_IRUGO | S_IWUSR,		\</span>
<span class="cp">		show_sf_ctrl, store_sf_ctrl, TEMP_CRUISE, index - 1),	\</span>
<span class="cp">	SENSOR_ATTR_2(tolerance##index, S_IRUGO | S_IWUSR, show_sf_ctrl,\</span>
<span class="cp">		store_sf_ctrl, TEMP_TOLERANCE, index - 1),		\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_auto_point1_pwm, S_IRUGO | S_IWUSR, \</span>
<span class="cp">		show_sf2_pwm, store_sf2_pwm, 0, index - 1),		\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_auto_point2_pwm, S_IRUGO | S_IWUSR, \</span>
<span class="cp">		show_sf2_pwm, store_sf2_pwm, 1, index - 1),		\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_auto_point3_pwm, S_IRUGO | S_IWUSR, \</span>
<span class="cp">		show_sf2_pwm, store_sf2_pwm, 2, index - 1),		\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_auto_point4_pwm, S_IRUGO | S_IWUSR, \</span>
<span class="cp">		show_sf2_pwm, store_sf2_pwm, 3, index - 1),		\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_auto_point5_pwm, S_IRUGO | S_IWUSR, \</span>
<span class="cp">		show_sf2_pwm, store_sf2_pwm, 4, index - 1),		\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_auto_point6_pwm, S_IRUGO | S_IWUSR, \</span>
<span class="cp">		show_sf2_pwm, store_sf2_pwm, 5, index - 1),		\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_auto_point7_pwm, S_IRUGO | S_IWUSR, \</span>
<span class="cp">		show_sf2_pwm, store_sf2_pwm, 6, index - 1),		\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_auto_point1_temp, S_IRUGO | S_IWUSR,\</span>
<span class="cp">		show_sf2_temp, store_sf2_temp, 0, index - 1),		\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_auto_point2_temp, S_IRUGO | S_IWUSR,\</span>
<span class="cp">		show_sf2_temp, store_sf2_temp, 1, index - 1),		\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_auto_point3_temp, S_IRUGO | S_IWUSR,\</span>
<span class="cp">		show_sf2_temp, store_sf2_temp, 2, index - 1),		\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_auto_point4_temp, S_IRUGO | S_IWUSR,\</span>
<span class="cp">		show_sf2_temp, store_sf2_temp, 3, index - 1),		\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_auto_point5_temp, S_IRUGO | S_IWUSR,\</span>
<span class="cp">		show_sf2_temp, store_sf2_temp, 4, index - 1),		\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_auto_point6_temp, S_IRUGO | S_IWUSR,\</span>
<span class="cp">		show_sf2_temp, store_sf2_temp, 5, index - 1),		\</span>
<span class="cp">	SENSOR_ATTR_2(temp##index##_auto_point7_temp, S_IRUGO | S_IWUSR,\</span>
<span class="cp">		show_sf2_temp, store_sf2_temp, 6, index - 1)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="n">w83793_sensor_attr_2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SENSOR_ATTR_IN</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_IN</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_IN</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_IN</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_IN</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_IN</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_IN</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_IN</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_IN</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_IN</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_FAN</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_FAN</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_FAN</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_FAN</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_FAN</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_PWM</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_PWM</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_PWM</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="n">w83793_temp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Fan6-Fan12 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="n">w83793_left_fan</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SENSOR_ATTR_FAN</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_FAN</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_FAN</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_FAN</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_FAN</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_FAN</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_FAN</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Pwm4-Pwm8 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="n">w83793_left_pwm</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SENSOR_ATTR_PWM</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_PWM</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_PWM</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_PWM</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_PWM</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="n">w83793_vid</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">cpu0_vid</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_vid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">NOT_USED</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">cpu1_vid</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_vid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">NOT_USED</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">vrm</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_vrm</span><span class="p">,</span> <span class="n">store_vrm</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="n">sda_single_files</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">chassis</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm_beep</span><span class="p">,</span>
		      <span class="n">store_chassis_clear_legacy</span><span class="p">,</span> <span class="n">ALARM_STATUS</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">intrusion0_alarm</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm_beep</span><span class="p">,</span>
		      <span class="n">store_chassis_clear</span><span class="p">,</span> <span class="n">ALARM_STATUS</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">beep_enable</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_beep_enable</span><span class="p">,</span>
		      <span class="n">store_beep_enable</span><span class="p">,</span> <span class="n">NOT_USED</span><span class="p">,</span> <span class="n">NOT_USED</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">pwm_default</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_sf_setup</span><span class="p">,</span>
		      <span class="n">store_sf_setup</span><span class="p">,</span> <span class="n">SETUP_PWM_DEFAULT</span><span class="p">,</span> <span class="n">NOT_USED</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">pwm_uptime</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_sf_setup</span><span class="p">,</span>
		      <span class="n">store_sf_setup</span><span class="p">,</span> <span class="n">SETUP_PWM_UPTIME</span><span class="p">,</span> <span class="n">NOT_USED</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">pwm_downtime</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_sf_setup</span><span class="p">,</span>
		      <span class="n">store_sf_setup</span><span class="p">,</span> <span class="n">SETUP_PWM_DOWNTIME</span><span class="p">,</span> <span class="n">NOT_USED</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">temp_critical</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_sf_setup</span><span class="p">,</span>
		      <span class="n">store_sf_setup</span><span class="p">,</span> <span class="n">SETUP_TEMP_CRITICAL</span><span class="p">,</span> <span class="n">NOT_USED</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">w83793_init_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
		<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_CONFIG</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="cm">/* Start monitoring */</span>
	<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_CONFIG</span><span class="p">,</span>
			   <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_CONFIG</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Watchdog routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_set_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">mtimeout</span><span class="p">;</span>

	<span class="n">mtimeout</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mtimeout</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_timeout</span> <span class="o">=</span> <span class="n">mtimeout</span><span class="p">;</span>

	<span class="cm">/* Set Timeout value (in Minutes) */</span>
	<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_WDT_TIMEOUT</span><span class="p">,</span>
			   <span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_timeout</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mtimeout</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>

<span class="nl">leave:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_get_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_timeout</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">timeout</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set Timeout value (in Minutes) */</span>
	<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_WDT_TIMEOUT</span><span class="p">,</span>
			   <span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_timeout</span><span class="p">);</span>

<span class="nl">leave:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set initial timeout */</span>
	<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_WDT_TIMEOUT</span><span class="p">,</span>
			   <span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_timeout</span><span class="p">);</span>

	<span class="cm">/* Enable Soft Watchdog */</span>
	<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_WDT_LOCK</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>

<span class="nl">leave:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable Soft Watchdog */</span>
	<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_WDT_LOCK</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">);</span>

<span class="nl">leave:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">watchdog_is_open</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We get called from drivers/char/misc.c with misc_mtx hold, and we</span>
<span class="cm">	 * call misc_register() from  w83793_probe() with watchdog_data_mutex</span>
<span class="cm">	 * hold, as misc_register() takes the misc_mtx lock, this is a possible</span>
<span class="cm">	 * deadlock, so we use mutex_trylock here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">watchdog_data_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">watchdog_miscdev</span><span class="p">.</span><span class="n">minor</span> <span class="o">==</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Check, if device is already open */</span>
	<span class="n">watchdog_is_open</span> <span class="o">=</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_is_open</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Increase data reference counter (if not already done).</span>
<span class="cm">	 * Note we can never not have found data, so we don&#39;t check for this</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">watchdog_is_open</span><span class="p">)</span>
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>

	<span class="cm">/* Check, if device is already open and possibly issue error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">watchdog_is_open</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Enable Soft Watchdog */</span>
	<span class="n">watchdog_enable</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="cm">/* Store pointer to data into filp&#39;s private data */</span>
	<span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_expect_close</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">watchdog_disable</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_expect_close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">watchdog_trigger</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">dev_crit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;unexpected close, not stopping watchdog!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_is_open</span><span class="p">);</span>

	<span class="cm">/* Decrease data reference counter */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">w83793_release_resources</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">watchdog_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nowayout</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

			<span class="cm">/* Clear it in case it was set with a previous write */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_expect_close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;V&#39;</span><span class="p">)</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_expect_close</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">watchdog_trigger</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">watchdog_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">watchdog_info</span> <span class="n">ident</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">WDIOF_KEEPALIVEPING</span> <span class="o">|</span>
			   <span class="n">WDIOF_SETTIMEOUT</span> <span class="o">|</span>
			   <span class="n">WDIOF_CARDRESET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">identity</span> <span class="o">=</span> <span class="s">&quot;w83793 watchdog&quot;</span>
	<span class="p">};</span>

	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WDIOC_GETSUPPORT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nowayout</span><span class="p">)</span>
			<span class="n">ident</span><span class="p">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">WDIOF_MAGICCLOSE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ident</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ident</span><span class="p">)))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WDIOC_GETSTATUS</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_caused_reboot</span> <span class="o">?</span> <span class="n">WDIOF_CARDRESET</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WDIOC_GETBOOTSTATUS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WDIOC_KEEPALIVE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">watchdog_trigger</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WDIOC_GETTIMEOUT</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">watchdog_get_timeout</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WDIOC_SETTIMEOUT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">watchdog_set_timeout</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WDIOC_SETOPTIONS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WDIOS_DISABLECARD</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">watchdog_disable</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WDIOS_ENABLECARD</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">watchdog_enable</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">watchdog_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">watchdog_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">watchdog_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">watchdog_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">watchdog_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	Notifier for system down</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_notify_sys</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">SYS_DOWN</span> <span class="o">||</span> <span class="n">code</span> <span class="o">==</span> <span class="n">SYS_HALT</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Disable each registered watchdog */</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">watchdog_data_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_miscdev</span><span class="p">.</span><span class="n">minor</span><span class="p">)</span>
				<span class="n">watchdog_disable</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	The WDT needs to learn about soft shutdowns in order to</span>
<span class="cm"> *	turn the timebomb registers off.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">watchdog_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">watchdog_notify_sys</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Init / remove routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w83793_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* Unregister the watchdog (if registered) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_miscdev</span><span class="p">.</span><span class="n">minor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_miscdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_is_open</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;i2c client detached with watchdog open! &quot;</span>
				<span class="s">&quot;Stopping watchdog.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">watchdog_disable</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>

		<span class="cm">/* Tell the watchdog code the client is gone */</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Reset Configuration Register to Disable Watch Dog Registers */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_CONFIG</span><span class="p">);</span>
	<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_CONFIG</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">);</span>

	<span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_notifier</span><span class="p">);</span>

	<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">w83793_sensor_attr_2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">w83793_sensor_attr_2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sda_single_files</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sda_single_files</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">w83793_vid</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w83793_vid</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_vrm</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">w83793_left_fan</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w83793_left_fan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">w83793_left_pwm</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w83793_left_pwm</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">w83793_temp</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w83793_temp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lm75</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lm75</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lm75</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lm75</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="cm">/* Decrease data reference counter */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">w83793_release_resources</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">w83793_detect_subclients</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">address</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">i2c_adapter_id</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">force_subclients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">id</span> <span class="o">&amp;&amp;</span> <span class="n">force_subclients</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">address</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">force_subclients</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mh">0x48</span>
			    <span class="o">||</span> <span class="n">force_subclients</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mh">0x4f</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;invalid subclient &quot;</span>
					<span class="s">&quot;address %d; must be 0x48-0x4f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">force_subclients</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">ERROR_SC_0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_I2C_SUBADDR</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">force_subclients</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">((</span><span class="n">force_subclients</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_I2C_SUBADDR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">))</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">lm75</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2c_new_dummy</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mh">0x48</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lm75</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">==</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;duplicate addresses 0x%x, &quot;</span>
				<span class="s">&quot;use force_subclients</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">lm75</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">ERROR_SC_1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">lm75</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2c_new_dummy</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					      <span class="mh">0x48</span> <span class="o">+</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Undo inits in case of errors */</span>

<span class="nl">ERROR_SC_1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lm75</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lm75</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="nl">ERROR_SC_0:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return 0 if detection is successful, -ENODEV otherwise */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w83793_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">chip_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">address</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_BYTE_DATA</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">bank</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_BANKSEL</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">bank</span> <span class="o">&amp;</span> <span class="mh">0x80</span> <span class="o">?</span> <span class="mh">0x5c</span> <span class="o">:</span> <span class="mh">0xa3</span><span class="p">;</span>
	<span class="cm">/* Check Winbond vendor ID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_VENDORID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;w83793: Detection failed at check vendor id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If Winbond chip, address of chip and W83793_REG_I2C_ADDR</span>
<span class="cm">	 * should match</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bank</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
	 <span class="o">&amp;&amp;</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_I2C_ADDR</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="p">(</span><span class="n">address</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;w83793: Detection failed at check i2c addr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Determine the chip type now */</span>
	<span class="n">chip_id</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_CHIPID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">!=</span> <span class="mh">0x7b</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;w83793&quot;</span><span class="p">,</span> <span class="n">I2C_NAME_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w83793_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">watchdog_minors</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">WATCHDOG_MINOR</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">213</span><span class="p">,</span> <span class="mi">214</span><span class="p">,</span> <span class="mi">215</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">files_fan</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">w83793_left_fan</span><span class="p">)</span> <span class="o">/</span> <span class="mi">7</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">files_pwm</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">w83793_left_pwm</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">files_temp</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">w83793_temp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83793_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_BANKSEL</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Store client pointer in our data struct for watchdog usage</span>
<span class="cm">	 * (where the client is found through a data ptr instead of the</span>
<span class="cm">	 * otherway around)</span>
<span class="cm">	 */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">w83793_detect_subclients</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_mem</span><span class="p">;</span>

	<span class="cm">/* Initialize the chip */</span>
	<span class="n">w83793_init_client</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only fan 1-5 has their own input pins,</span>
<span class="cm">	 * Pwm 1-3 has their own pins</span>
<span class="cm">	 */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_fan</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_pwm</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_MFC</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_FANIN_CTRL</span><span class="p">);</span>

	<span class="cm">/* check the function of pins 49-56 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_vid</span> <span class="o">|=</span> <span class="mh">0x2</span><span class="p">;</span>	<span class="cm">/* has VIDB */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_pwm</span> <span class="o">|=</span> <span class="mh">0x18</span><span class="p">;</span>	<span class="cm">/* pwm 4,5 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* fan 6 */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_fan</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_pwm</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* fan 7 */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_fan</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_pwm</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* fan 8 */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_fan</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_pwm</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* check the function of pins 37-40 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x29</span><span class="p">))</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_vid</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* has VIDA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mh">0x08</span> <span class="o">==</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>	<span class="cm">/* fan 9 */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_fan</span> <span class="o">|=</span> <span class="mh">0x100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>	<span class="cm">/* fan 10 */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_fan</span> <span class="o">|=</span> <span class="mh">0x200</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mh">0x20</span> <span class="o">==</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>	<span class="cm">/* fan 11 */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_fan</span> <span class="o">|=</span> <span class="mh">0x400</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>	<span class="cm">/* fan 12 */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_fan</span> <span class="o">|=</span> <span class="mh">0x800</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* fan 8, second location */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_fan</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_pwm</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_FANIN_SEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* fan 9, second location */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_fan</span> <span class="o">|=</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* fan 10, second location */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_fan</span> <span class="o">|=</span> <span class="mh">0x200</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* fan 11, second location */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_fan</span> <span class="o">|=</span> <span class="mh">0x400</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* fan 12, second location */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_fan</span> <span class="o">|=</span> <span class="mh">0x800</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check the temp1-6 mode, ignore former AMDSI selected inputs */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP_MODE</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_temp</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_temp</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_temp</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_temp</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP_MODE</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_temp</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_temp</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>

	<span class="cm">/* Register sysfs hooks */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">w83793_sensor_attr_2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">w83793_sensor_attr_2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">w83793_vid</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_vid</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w83793_vid</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_vid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">vrm</span> <span class="o">=</span> <span class="n">vid_which_vrm</span><span class="p">();</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_vrm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sda_single_files</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sda_single_files</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_temp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">files_temp</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">w83793_temp</span><span class="p">[(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">files_temp</span>
								<span class="o">+</span> <span class="n">j</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit_remove</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_fan</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">files_fan</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">w83793_left_fan</span><span class="p">[(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">files_fan</span>
								<span class="o">+</span> <span class="n">j</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit_remove</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_pwm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">files_pwm</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">w83793_left_pwm</span><span class="p">[(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">files_pwm</span>
								<span class="o">+</span> <span class="n">j</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit_remove</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span> <span class="o">=</span> <span class="n">hwmon_device_register</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_remove</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Watchdog initialization */</span>

	<span class="cm">/* Register boot notifier */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_notifier</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;cannot register reboot notifier (err=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_devunreg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable Watchdog registers.</span>
<span class="cm">	 * Set Configuration Register to Enable Watch Dog Registers</span>
<span class="cm">	 * (Bit 2) = XXXX, X1XX.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_CONFIG</span><span class="p">);</span>
	<span class="n">w83793_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_CONFIG</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">);</span>

	<span class="cm">/* Set the default watchdog timeout */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="cm">/* Check, if last reboot was caused by watchdog */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_caused_reboot</span> <span class="o">=</span>
	  <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_WDT_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="cm">/* Disable Soft Watchdog during initialiation */</span>
	<span class="n">watchdog_disable</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We take the data_mutex lock early so that watchdog_open() cannot</span>
<span class="cm">	 * run when misc_register() has completed, but we&#39;ve not yet added</span>
<span class="cm">	 * our data to the watchdog_data_list (and set the default timeout)</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">watchdog_minors</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Register our watchdog part */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_name</span><span class="p">),</span>
			<span class="s">&quot;watchdog%c&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;\0&#39;</span> <span class="o">:</span> <span class="p">(</span><span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_miscdev</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_name</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_miscdev</span><span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">watchdog_fops</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_miscdev</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">watchdog_minors</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_miscdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_miscdev</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Registering watchdog chardev: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">watchdog_data_list</span><span class="p">);</span>

		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Registered watchdog chardev major 10, minor: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">watchdog_minors</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">watchdog_minors</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">watchdog_miscdev</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t register watchdog chardev &quot;</span>
			<span class="s">&quot;(due to no free minor)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_data_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Unregister hwmon device */</span>

<span class="nl">exit_devunreg:</span>

	<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>

	<span class="cm">/* Unregister sysfs hooks */</span>

<span class="nl">exit_remove:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">w83793_sensor_attr_2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w83793_sensor_attr_2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sda_single_files</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sda_single_files</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">w83793_vid</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w83793_vid</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">w83793_left_fan</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w83793_left_fan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">w83793_left_pwm</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w83793_left_pwm</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">w83793_temp</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w83793_temp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lm75</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lm75</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lm75</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lm75</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="nl">free_mem:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">w83793_update_nonvolatile</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * They are somewhat &quot;stable&quot; registers, and to update them every time</span>
<span class="cm">	 * takes so much time, it&#39;s just not worthy. Update them in a long</span>
<span class="cm">	 * interval to avoid exception.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">last_nonvolatile</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">300</span><span class="p">)</span>
	      <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* update voltage limits */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_IN</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_low_bits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_IN_LOW_BITS</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_min</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Update the Fan measured value and limits */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_fan</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_FAN_MIN</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_FAN_MIN</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_fan_map</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_temp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_fan_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP_FAN_MAP</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_cruise</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP_CRUISE</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">sf2_pwm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_SF2_PWM</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">sf2_temp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
					      <span class="n">W83793_REG_SF2_TEMP</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_mode</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_mode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP_MODE</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tolerance</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">tolerance</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP_TOL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_pwm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">PWM_NONSTOP</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_PWM</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">PWM_NONSTOP</span><span class="p">));</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">PWM_START</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_PWM</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">PWM_START</span><span class="p">));</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_stop_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_PWM_STOP_TIME</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_default</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_PWM_DEFAULT</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_enable</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_PWM_ENABLE</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_uptime</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_PWM_UPTIME</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_downtime</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_PWM_DOWNTIME</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_critical</span> <span class="o">=</span>
	    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP_CRITICAL</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">beep_enable</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_OVT_BEEP</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">beeps</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">beeps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_BEEP</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">last_nonvolatile</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="nf">w83793_update_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">last_updated</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
	      <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">END</span><span class="p">;</span>

	<span class="cm">/* Update the voltages measured value and limits */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">IN_READ</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_IN</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">IN_READ</span><span class="p">]);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_low_bits</span><span class="p">[</span><span class="n">IN_READ</span><span class="p">]</span> <span class="o">=</span>
	    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_IN_LOW_BITS</span><span class="p">[</span><span class="n">IN_READ</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fan</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_fan</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_FAN</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_FAN</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_temp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">TEMP_READ</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">TEMP_READ</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_low_bits</span> <span class="o">=</span>
	    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_TEMP_LOW_BITS</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_pwm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">PWM_DUTY</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
					      <span class="n">W83793_REG_PWM</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">PWM_DUTY</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_ALARM</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_vid</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_VID_INA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_vid</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">w83793_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_VID_INB</span><span class="p">);</span>
	<span class="n">w83793_update_nonvolatile</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">last_updated</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">END:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Ignore the possibility that somebody change bank outside the driver</span>
<span class="cm"> * Must be called with data-&gt;update_lock held, except during initialization</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">w83793_read_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">res</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">new_bank</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">new_bank</span> <span class="o">|=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">!=</span> <span class="n">new_bank</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i2c_smbus_write_byte_data</span>
		    <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_BANKSEL</span><span class="p">,</span> <span class="n">new_bank</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">=</span> <span class="n">new_bank</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;set bank to %d failed, fall back &quot;</span>
				<span class="s">&quot;to bank %d, read reg 0x%x error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">new_bank</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>	<span class="cm">/* read 0x0 from the chip */</span>
			<span class="k">goto</span> <span class="n">END</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="nl">END:</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Must be called with data-&gt;update_lock held, except during initialization */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w83793_write_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w83793_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">new_bank</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">new_bank</span> <span class="o">|=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">!=</span> <span class="n">new_bank</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">W83793_REG_BANKSEL</span><span class="p">,</span>
						<span class="n">new_bank</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;set bank to %d failed, fall back &quot;</span>
				<span class="s">&quot;to bank %d, write reg 0x%x error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">new_bank</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">END</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">=</span> <span class="n">new_bank</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="nl">END:</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">w83793_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Yuan Mu, Sven Anders&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;w83793 driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
