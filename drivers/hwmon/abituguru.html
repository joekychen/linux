<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › hwmon › abituguru.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>abituguru.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * abituguru.c Copyright (c) 2005-2006 Hans de Goede &lt;hdegoede@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * This driver supports the sensor part of the first and second revision of</span>
<span class="cm"> * the custom Abit uGuru chip found on Abit uGuru motherboards. Note: because</span>
<span class="cm"> * of lack of specs the CPU/RAM voltage &amp; frequency control is not supported!</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon-sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cm">/* Banks */</span>
<span class="cp">#define ABIT_UGURU_ALARM_BANK			0x20 </span><span class="cm">/* 1x 3 bytes */</span><span class="cp"></span>
<span class="cp">#define ABIT_UGURU_SENSOR_BANK1			0x21 </span><span class="cm">/* 16x volt and temp */</span><span class="cp"></span>
<span class="cp">#define ABIT_UGURU_FAN_PWM			0x24 </span><span class="cm">/* 3x 5 bytes */</span><span class="cp"></span>
<span class="cp">#define ABIT_UGURU_SENSOR_BANK2			0x26 </span><span class="cm">/* fans */</span><span class="cp"></span>
<span class="cm">/* max nr of sensors in bank1, a bank1 sensor can be in, temp or nc */</span>
<span class="cp">#define ABIT_UGURU_MAX_BANK1_SENSORS		16</span>
<span class="cm">/*</span>
<span class="cm"> * Warning if you increase one of the 2 MAX defines below to 10 or higher you</span>
<span class="cm"> * should adjust the belonging _NAMES_LENGTH macro for the 2 digit number!</span>
<span class="cm"> */</span>
<span class="cm">/* max nr of sensors in bank2, currently mb&#39;s with max 6 fans are known */</span>
<span class="cp">#define ABIT_UGURU_MAX_BANK2_SENSORS		6</span>
<span class="cm">/* max nr of pwm outputs, currently mb&#39;s with max 5 pwm outputs are known */</span>
<span class="cp">#define ABIT_UGURU_MAX_PWMS			5</span>
<span class="cm">/* uGuru sensor bank 1 flags */</span>			     <span class="cm">/* Alarm if: */</span>
<span class="cp">#define ABIT_UGURU_TEMP_HIGH_ALARM_ENABLE	0x01 </span><span class="cm">/*  temp over warn */</span><span class="cp"></span>
<span class="cp">#define ABIT_UGURU_VOLT_HIGH_ALARM_ENABLE	0x02 </span><span class="cm">/*  volt over max */</span><span class="cp"></span>
<span class="cp">#define ABIT_UGURU_VOLT_LOW_ALARM_ENABLE	0x04 </span><span class="cm">/*  volt under min */</span><span class="cp"></span>
<span class="cp">#define ABIT_UGURU_TEMP_HIGH_ALARM_FLAG		0x10 </span><span class="cm">/* temp is over warn */</span><span class="cp"></span>
<span class="cp">#define ABIT_UGURU_VOLT_HIGH_ALARM_FLAG		0x20 </span><span class="cm">/* volt is over max */</span><span class="cp"></span>
<span class="cp">#define ABIT_UGURU_VOLT_LOW_ALARM_FLAG		0x40 </span><span class="cm">/* volt is under min */</span><span class="cp"></span>
<span class="cm">/* uGuru sensor bank 2 flags */</span>			     <span class="cm">/* Alarm if: */</span>
<span class="cp">#define ABIT_UGURU_FAN_LOW_ALARM_ENABLE		0x01 </span><span class="cm">/*   fan under min */</span><span class="cp"></span>
<span class="cm">/* uGuru sensor bank common flags */</span>
<span class="cp">#define ABIT_UGURU_BEEP_ENABLE			0x08 </span><span class="cm">/* beep if alarm */</span><span class="cp"></span>
<span class="cp">#define ABIT_UGURU_SHUTDOWN_ENABLE		0x80 </span><span class="cm">/* shutdown if alarm */</span><span class="cp"></span>
<span class="cm">/* uGuru fan PWM (speed control) flags */</span>
<span class="cp">#define ABIT_UGURU_FAN_PWM_ENABLE		0x80 </span><span class="cm">/* enable speed control */</span><span class="cp"></span>
<span class="cm">/* Values used for conversion */</span>
<span class="cp">#define ABIT_UGURU_FAN_MAX			15300 </span><span class="cm">/* RPM */</span><span class="cp"></span>
<span class="cm">/* Bank1 sensor types */</span>
<span class="cp">#define ABIT_UGURU_IN_SENSOR			0</span>
<span class="cp">#define ABIT_UGURU_TEMP_SENSOR			1</span>
<span class="cp">#define ABIT_UGURU_NC				2</span>
<span class="cm">/*</span>
<span class="cm"> * In many cases we need to wait for the uGuru to reach a certain status, most</span>
<span class="cm"> * of the time it will reach this status within 30 - 90 ISA reads, and thus we</span>
<span class="cm"> * can best busy wait. This define gives the total amount of reads to try.</span>
<span class="cm"> */</span>
<span class="cp">#define ABIT_UGURU_WAIT_TIMEOUT			125</span>
<span class="cm">/*</span>
<span class="cm"> * However sometimes older versions of the uGuru seem to be distracted and they</span>
<span class="cm"> * do not respond for a long time. To handle this we sleep before each of the</span>
<span class="cm"> * last ABIT_UGURU_WAIT_TIMEOUT_SLEEP tries.</span>
<span class="cm"> */</span>
<span class="cp">#define ABIT_UGURU_WAIT_TIMEOUT_SLEEP		5</span>
<span class="cm">/*</span>
<span class="cm"> * Normally all expected status in abituguru_ready, are reported after the</span>
<span class="cm"> * first read, but sometimes not and we need to poll.</span>
<span class="cm"> */</span>
<span class="cp">#define ABIT_UGURU_READY_TIMEOUT		5</span>
<span class="cm">/* Maximum 3 retries on timedout reads/writes, delay 200 ms before retrying */</span>
<span class="cp">#define ABIT_UGURU_MAX_RETRIES			3</span>
<span class="cp">#define ABIT_UGURU_RETRY_DELAY			(HZ/5)</span>
<span class="cm">/* Maximum 2 timeouts in abituguru_update_device, iow 3 in a row is an error */</span>
<span class="cp">#define ABIT_UGURU_MAX_TIMEOUTS			2</span>
<span class="cm">/* utility macros */</span>
<span class="cp">#define ABIT_UGURU_NAME				&quot;abituguru&quot;</span>
<span class="cp">#define ABIT_UGURU_DEBUG(level, format, arg...)				\</span>
<span class="cp">	if (level &lt;= verbose)						\</span>
<span class="cp">		printk(KERN_DEBUG ABIT_UGURU_NAME &quot;: &quot;	format , ## arg)</span>
<span class="cm">/* Macros to help calculate the sysfs_names array length */</span>
<span class="cm">/*</span>
<span class="cm"> * sum of strlen of: in??_input\0, in??_{min,max}\0, in??_{min,max}_alarm\0,</span>
<span class="cm"> * in??_{min,max}_alarm_enable\0, in??_beep\0, in??_shutdown\0</span>
<span class="cm"> */</span>
<span class="cp">#define ABITUGURU_IN_NAMES_LENGTH	(11 + 2 * 9 + 2 * 15 + 2 * 22 + 10 + 14)</span>
<span class="cm">/*</span>
<span class="cm"> * sum of strlen of: temp??_input\0, temp??_max\0, temp??_crit\0,</span>
<span class="cm"> * temp??_alarm\0, temp??_alarm_enable\0, temp??_beep\0, temp??_shutdown\0</span>
<span class="cm"> */</span>
<span class="cp">#define ABITUGURU_TEMP_NAMES_LENGTH	(13 + 11 + 12 + 13 + 20 + 12 + 16)</span>
<span class="cm">/*</span>
<span class="cm"> * sum of strlen of: fan?_input\0, fan?_min\0, fan?_alarm\0,</span>
<span class="cm"> * fan?_alarm_enable\0, fan?_beep\0, fan?_shutdown\0</span>
<span class="cm"> */</span>
<span class="cp">#define ABITUGURU_FAN_NAMES_LENGTH	(11 + 9 + 11 + 18 + 10 + 14)</span>
<span class="cm">/*</span>
<span class="cm"> * sum of strlen of: pwm?_enable\0, pwm?_auto_channels_temp\0,</span>
<span class="cm"> * pwm?_auto_point{1,2}_pwm\0, pwm?_auto_point{1,2}_temp\0</span>
<span class="cm"> */</span>
<span class="cp">#define ABITUGURU_PWM_NAMES_LENGTH	(12 + 24 + 2 * 21 + 2 * 22)</span>
<span class="cm">/* IN_NAMES_LENGTH &gt; TEMP_NAMES_LENGTH so assume all bank1 sensors are in */</span>
<span class="cp">#define ABITUGURU_SYSFS_NAMES_LENGTH	( \</span>
<span class="cp">	ABIT_UGURU_MAX_BANK1_SENSORS * ABITUGURU_IN_NAMES_LENGTH + \</span>
<span class="cp">	ABIT_UGURU_MAX_BANK2_SENSORS * ABITUGURU_FAN_NAMES_LENGTH + \</span>
<span class="cp">	ABIT_UGURU_MAX_PWMS * ABITUGURU_PWM_NAMES_LENGTH)</span>

<span class="cm">/*</span>
<span class="cm"> * All the macros below are named identical to the oguru and oguru2 programs</span>
<span class="cm"> * reverse engineered by Olle Sandberg, hence the names might not be 100%</span>
<span class="cm"> * logical. I could come up with better names, but I prefer keeping the names</span>
<span class="cm"> * identical so that this driver can be compared with his work more easily.</span>
<span class="cm"> */</span>
<span class="cm">/* Two i/o-ports are used by uGuru */</span>
<span class="cp">#define ABIT_UGURU_BASE				0x00E0</span>
<span class="cm">/* Used to tell uGuru what to read and to read the actual data */</span>
<span class="cp">#define ABIT_UGURU_CMD				0x00</span>
<span class="cm">/* Mostly used to check if uGuru is busy */</span>
<span class="cp">#define ABIT_UGURU_DATA				0x04</span>
<span class="cp">#define ABIT_UGURU_REGION_LENGTH		5</span>
<span class="cm">/* uGuru status&#39; */</span>
<span class="cp">#define ABIT_UGURU_STATUS_WRITE			0x00 </span><span class="cm">/* Ready to be written */</span><span class="cp"></span>
<span class="cp">#define ABIT_UGURU_STATUS_READ			0x01 </span><span class="cm">/* Ready to be read */</span><span class="cp"></span>
<span class="cp">#define ABIT_UGURU_STATUS_INPUT			0x08 </span><span class="cm">/* More input */</span><span class="cp"></span>
<span class="cp">#define ABIT_UGURU_STATUS_READY			0x09 </span><span class="cm">/* Ready to be written */</span><span class="cp"></span>

<span class="cm">/* Constants */</span>
<span class="cm">/* in (Volt) sensors go up to 3494 mV, temp to 255000 millidegrees Celsius */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">abituguru_bank1_max_value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3494</span><span class="p">,</span> <span class="mi">255000</span> <span class="p">};</span>
<span class="cm">/*</span>
<span class="cm"> * Min / Max allowed values for sensor2 (fan) alarm threshold, these values</span>
<span class="cm"> * correspond to 300-3000 RPM</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">abituguru_bank2_min_threshold</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">abituguru_bank2_max_threshold</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * Register 0 is a bitfield, 1 and 2 are pwm settings (255 = 100%), 3 and 4</span>
<span class="cm"> * are temperature trip points.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">abituguru_pwm_settings_multiplier</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span> <span class="p">};</span>
<span class="cm">/*</span>
<span class="cm"> * Min / Max allowed values for pwm_settings. Note: pwm1 (CPU fan) is a</span>
<span class="cm"> * special case the minium allowed pwm% setting for this is 30% (77) on</span>
<span class="cm"> * some MB&#39;s this special case is handled in the code!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">abituguru_pwm_min</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">25</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">abituguru_pwm_max</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">75</span> <span class="p">};</span>


<span class="cm">/* Insmod parameters */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">force</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s">&quot;Set to one to force detection.&quot;</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bank1_types</span><span class="p">[</span><span class="n">ABIT_UGURU_MAX_BANK1_SENSORS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">bank1_types</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bank1_types</span><span class="p">,</span> <span class="s">&quot;Bank1 sensortype autodetection override:</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;   -1 autodetect</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;    0 volt sensor</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;    1 temp sensor</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;    2 not connected&quot;</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fan_sensors</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fan_sensors</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fan_sensors</span><span class="p">,</span> <span class="s">&quot;Number of fan sensors on the uGuru &quot;</span>
	<span class="s">&quot;(0 = autodetect)&quot;</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pwms</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pwms</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pwms</span><span class="p">,</span> <span class="s">&quot;Number of PWMs on the uGuru &quot;</span>
	<span class="s">&quot;(0 = autodetect)&quot;</span><span class="p">);</span>

<span class="cm">/* Default verbose is 2, since this driver is still in the testing phase */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="s">&quot;How verbose should the driver be? (0-3):</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;   0 normal output</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;   1 + verbose error reporting</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;   2 + sensors type probing info</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;   3 + retryable error reporting&quot;</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * For the Abit uGuru, we need to keep some data in memory.</span>
<span class="cm"> * The structure is dynamically allocated, at the same time when a new</span>
<span class="cm"> * abituguru device is allocated.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">hwmon_dev</span><span class="p">;</span>	<span class="cm">/* hwmon registered device */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">update_lock</span><span class="p">;</span>	<span class="cm">/* protect access to data and uGuru */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_updated</span><span class="p">;</span>	<span class="cm">/* In jiffies */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">;</span>		<span class="cm">/* uguru base address */</span>
	<span class="kt">char</span> <span class="n">uguru_ready</span><span class="p">;</span>		<span class="cm">/* is the uguru in ready state? */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">update_timeouts</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">					 * number of update timeouts since last</span>
<span class="cm">					 * successful update</span>
<span class="cm">					 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * The sysfs attr and their names are generated automatically, for bank1</span>
<span class="cm">	 * we cannot use a predefined array because we don&#39;t know beforehand</span>
<span class="cm">	 * of a sensor is a volt or a temp sensor, for bank2 and the pwms its</span>
<span class="cm">	 * easier todo things the same way.  For in sensors we have 9 (temp 7)</span>
<span class="cm">	 * sysfs entries per sensor, for bank2 and pwms 6.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="n">sysfs_attr</span><span class="p">[</span>
		<span class="n">ABIT_UGURU_MAX_BANK1_SENSORS</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">+</span>
		<span class="n">ABIT_UGURU_MAX_BANK2_SENSORS</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">ABIT_UGURU_MAX_PWMS</span> <span class="o">*</span> <span class="mi">6</span><span class="p">];</span>
	<span class="cm">/* Buffer to store the dynamically generated sysfs names */</span>
	<span class="kt">char</span> <span class="n">sysfs_names</span><span class="p">[</span><span class="n">ABITUGURU_SYSFS_NAMES_LENGTH</span><span class="p">];</span>

	<span class="cm">/* Bank 1 data */</span>
	<span class="cm">/* number of and addresses of [0] in, [1] temp sensors */</span>
	<span class="n">u8</span> <span class="n">bank1_sensors</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">bank1_address</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ABIT_UGURU_MAX_BANK1_SENSORS</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">bank1_value</span><span class="p">[</span><span class="n">ABIT_UGURU_MAX_BANK1_SENSORS</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * This array holds 3 entries per sensor for the bank 1 sensor settings</span>
<span class="cm">	 * (flags, min, max for voltage / flags, warn, shutdown for temp).</span>
<span class="cm">	 */</span>
	<span class="n">u8</span> <span class="n">bank1_settings</span><span class="p">[</span><span class="n">ABIT_UGURU_MAX_BANK1_SENSORS</span><span class="p">][</span><span class="mi">3</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * Maximum value for each sensor used for scaling in mV/millidegrees</span>
<span class="cm">	 * Celsius.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">bank1_max_value</span><span class="p">[</span><span class="n">ABIT_UGURU_MAX_BANK1_SENSORS</span><span class="p">];</span>

	<span class="cm">/* Bank 2 data, ABIT_UGURU_MAX_BANK2_SENSORS entries for bank2 */</span>
	<span class="n">u8</span> <span class="n">bank2_sensors</span><span class="p">;</span> <span class="cm">/* actual number of bank2 sensors found */</span>
	<span class="n">u8</span> <span class="n">bank2_value</span><span class="p">[</span><span class="n">ABIT_UGURU_MAX_BANK2_SENSORS</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">bank2_settings</span><span class="p">[</span><span class="n">ABIT_UGURU_MAX_BANK2_SENSORS</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span> <span class="cm">/* flags, min */</span>

	<span class="cm">/* Alarms 2 bytes for bank1, 1 byte for bank2 */</span>
	<span class="n">u8</span> <span class="n">alarms</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="cm">/* Fan PWM (speed control) 5 bytes per PWM */</span>
	<span class="n">u8</span> <span class="n">pwms</span><span class="p">;</span> <span class="cm">/* actual number of pwms found */</span>
	<span class="n">u8</span> <span class="n">pwm_settings</span><span class="p">[</span><span class="n">ABIT_UGURU_MAX_PWMS</span><span class="p">][</span><span class="mi">5</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">never_happen</span> <span class="o">=</span> <span class="s">&quot;This should never happen.&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">report_this</span> <span class="o">=</span>
	<span class="s">&quot;Please report this to the abituguru maintainer (see MAINTAINERS)&quot;</span><span class="p">;</span>

<span class="cm">/* wait till the uguru is in the specified state */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">abituguru_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">ABIT_UGURU_WAIT_TIMEOUT</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">inb_p</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">ABIT_UGURU_DATA</span><span class="p">)</span> <span class="o">!=</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * sleep a bit before our last few tries, see the comment on</span>
<span class="cm">		 * this where ABIT_UGURU_WAIT_TIMEOUT_SLEEP is defined.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;=</span> <span class="n">ABIT_UGURU_WAIT_TIMEOUT_SLEEP</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Put the uguru in ready for input state */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">abituguru_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">ABIT_UGURU_READY_TIMEOUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">uguru_ready</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Reset? / Prepare for next read/write cycle */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">ABIT_UGURU_DATA</span><span class="p">);</span>

	<span class="cm">/* Wait till the uguru is ready */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_wait</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_STATUS_READY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			<span class="s">&quot;timeout exceeded waiting for ready state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Cmd port MUST be read now and should contain 0xAC */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">inb_p</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">ABIT_UGURU_CMD</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
			   <span class="s">&quot;CMD reg does not hold 0xAC after ready command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * After this the ABIT_UGURU_DATA port should contain</span>
<span class="cm">	 * ABIT_UGURU_STATUS_INPUT</span>
<span class="cm">	 */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">ABIT_UGURU_READY_TIMEOUT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">inb_p</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">ABIT_UGURU_DATA</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ABIT_UGURU_STATUS_INPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
				<span class="s">&quot;state != more input after ready command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">uguru_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send the bank and then sensor address to the uGuru for the next read/write</span>
<span class="cm"> * cycle. This function gets called as the first part of a read/write by</span>
<span class="cm"> * abituguru_read and abituguru_write. This function should never be</span>
<span class="cm"> * called by any other function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">abituguru_send_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">bank_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sensor_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">retries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * assume the caller does error handling itself if it has not requested</span>
<span class="cm">	 * any retries, and thus be quiet.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">report_errors</span> <span class="o">=</span> <span class="n">retries</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Make sure the uguru is ready and then send the bank address,</span>
<span class="cm">		 * after this the uguru is no longer &quot;ready&quot;.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_ready</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">bank_addr</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">ABIT_UGURU_DATA</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">uguru_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Wait till the uguru is ABIT_UGURU_STATUS_INPUT state again</span>
<span class="cm">		 * and send the sensor addr</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_wait</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_STATUS_INPUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retries</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;timeout exceeded &quot;</span>
					<span class="s">&quot;waiting for more input state, %d &quot;</span>
					<span class="s">&quot;tries remaining</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retries</span><span class="p">);</span>
				<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
				<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">ABIT_UGURU_RETRY_DELAY</span><span class="p">);</span>
				<span class="n">retries</span><span class="o">--</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">report_errors</span><span class="p">)</span>
				<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;timeout exceeded &quot;</span>
					<span class="s">&quot;waiting for more input state &quot;</span>
					<span class="s">&quot;(bank: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">bank_addr</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">sensor_addr</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">ABIT_UGURU_CMD</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read count bytes from sensor sensor_addr in bank bank_addr and store the</span>
<span class="cm"> * result in buf, retry the send address part of the read retries times.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">abituguru_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">bank_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sensor_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">retries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Send the address */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">abituguru_send_address</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bank_addr</span><span class="p">,</span> <span class="n">sensor_addr</span><span class="p">,</span> <span class="n">retries</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* And read the data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_wait</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_STATUS_READ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="n">retries</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
				<span class="s">&quot;timeout exceeded waiting for &quot;</span>
				<span class="s">&quot;read state (bank: %d, sensor: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">bank_addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sensor_addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">ABIT_UGURU_CMD</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Last put the chip back in ready state */</span>
	<span class="n">abituguru_ready</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write count bytes from buf to sensor sensor_addr in bank bank_addr, the send</span>
<span class="cm"> * address part of the write is always retried ABIT_UGURU_MAX_RETRIES times.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">abituguru_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">bank_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sensor_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We use the ready timeout as we have to wait for 0xAC just like the</span>
<span class="cm">	 * ready function</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">ABIT_UGURU_READY_TIMEOUT</span><span class="p">;</span>

	<span class="cm">/* Send the address */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">abituguru_send_address</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bank_addr</span><span class="p">,</span> <span class="n">sensor_addr</span><span class="p">,</span>
		<span class="n">ABIT_UGURU_MAX_RETRIES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* And write the data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_wait</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_STATUS_WRITE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;timeout exceeded waiting for &quot;</span>
				<span class="s">&quot;write state (bank: %d, sensor: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">bank_addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sensor_addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">ABIT_UGURU_CMD</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now we need to wait till the chip is ready to be read again,</span>
<span class="cm">	 * so that we can read 0xAC as confirmation that our write has</span>
<span class="cm">	 * succeeded.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_wait</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_STATUS_READ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;timeout exceeded waiting for read state &quot;</span>
			<span class="s">&quot;after write (bank: %d, sensor: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">bank_addr</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sensor_addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Cmd port MUST be read now and should contain 0xAC */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">inb_p</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">ABIT_UGURU_CMD</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;CMD reg does not hold 0xAC after &quot;</span>
				<span class="s">&quot;write (bank: %d, sensor: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">bank_addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sensor_addr</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Last put the chip back in ready state */</span>
	<span class="n">abituguru_ready</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Detect sensor type. Temp and Volt sensors are enabled with</span>
<span class="cm"> * different masks and will ignore enable masks not meant for them.</span>
<span class="cm"> * This enables us to test what kind of sensor we&#39;re dealing with.</span>
<span class="cm"> * By setting the alarm thresholds so that we will always get an</span>
<span class="cm"> * alarm for sensor type X and then enabling the sensor as sensor type</span>
<span class="cm"> * X, if we then get an alarm it is a sensor of type X.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">abituguru_detect_bank1_sensor_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">sensor_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">test_flag</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span> <span class="cm">/* error is the most common used retval :| */</span>

	<span class="cm">/* If overriden by the user return the user selected type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bank1_types</span><span class="p">[</span><span class="n">sensor_addr</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ABIT_UGURU_IN_SENSOR</span> <span class="o">&amp;&amp;</span>
			<span class="n">bank1_types</span><span class="p">[</span><span class="n">sensor_addr</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ABIT_UGURU_NC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;assuming sensor type %d for bank1 sensor &quot;</span>
			<span class="s">&quot;%d because of </span><span class="se">\&quot;</span><span class="s">bank1_types</span><span class="se">\&quot;</span><span class="s"> module param</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bank1_types</span><span class="p">[</span><span class="n">sensor_addr</span><span class="p">],</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sensor_addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">bank1_types</span><span class="p">[</span><span class="n">sensor_addr</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* First read the sensor and the current settings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_SENSOR_BANK1</span><span class="p">,</span> <span class="n">sensor_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span>
			<span class="mi">1</span><span class="p">,</span> <span class="n">ABIT_UGURU_MAX_RETRIES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Test val is sane / usable for sensor type detection. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">10u</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">250u</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;bank1-sensor: %d reading (%d) too close to limits, &quot;</span>
			<span class="s">&quot;unable to determine sensor type, skipping sensor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sensor_addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * assume no sensor is there for sensors for which we can&#39;t</span>
<span class="cm">		 * determine the sensor type because their reading is too close</span>
<span class="cm">		 * to their limits, this usually means no sensor is there.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">ABIT_UGURU_NC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;testing bank1 sensor %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sensor_addr</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Volt sensor test, enable volt low alarm, set min value ridicously</span>
<span class="cm">	 * high, or vica versa if the reading is very high. If its a volt</span>
<span class="cm">	 * sensor this should always give us an alarm.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="mi">240u</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ABIT_UGURU_VOLT_LOW_ALARM_ENABLE</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">245</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>
		<span class="n">test_flag</span> <span class="o">=</span> <span class="n">ABIT_UGURU_VOLT_LOW_ALARM_FLAG</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ABIT_UGURU_VOLT_HIGH_ALARM_ENABLE</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">test_flag</span> <span class="o">=</span> <span class="n">ABIT_UGURU_VOLT_HIGH_ALARM_FLAG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_SENSOR_BANK1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sensor_addr</span><span class="p">,</span>
			<span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abituguru_detect_bank1_sensor_type_exit</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Now we need 20 ms to give the uguru time to read the sensors</span>
<span class="cm">	 * and raise a voltage alarm</span>
<span class="cm">	 */</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
	<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">50</span><span class="p">);</span>
	<span class="cm">/* Check for alarm and check the alarm is a volt low alarm. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_ALARM_BANK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
			<span class="n">ABIT_UGURU_MAX_RETRIES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abituguru_detect_bank1_sensor_type_exit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">sensor_addr</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sensor_addr</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_SENSOR_BANK1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">sensor_addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
				<span class="n">ABIT_UGURU_MAX_RETRIES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">abituguru_detect_bank1_sensor_type_exit</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">test_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  found volt sensor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ABIT_UGURU_IN_SENSOR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">abituguru_detect_bank1_sensor_type_exit</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  alarm raised during volt &quot;</span>
				<span class="s">&quot;sensor test, but volt range flag not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  alarm not raised during volt sensor &quot;</span>
			<span class="s">&quot;test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Temp sensor test, enable sensor as a temp sensor, set beep value</span>
<span class="cm">	 * ridicously low (but not too low, otherwise uguru ignores it).</span>
<span class="cm">	 * If its a temp sensor this should always give us an alarm.</span>
<span class="cm">	 */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ABIT_UGURU_TEMP_HIGH_ALARM_ENABLE</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_SENSOR_BANK1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sensor_addr</span><span class="p">,</span>
			<span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abituguru_detect_bank1_sensor_type_exit</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Now we need 50 ms to give the uguru time to read the sensors</span>
<span class="cm">	 * and raise a temp alarm</span>
<span class="cm">	 */</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
	<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">20</span><span class="p">);</span>
	<span class="cm">/* Check for alarm and check the alarm is a temp high alarm. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_ALARM_BANK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
			<span class="n">ABIT_UGURU_MAX_RETRIES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abituguru_detect_bank1_sensor_type_exit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">sensor_addr</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sensor_addr</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_SENSOR_BANK1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">sensor_addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
				<span class="n">ABIT_UGURU_MAX_RETRIES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">abituguru_detect_bank1_sensor_type_exit</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ABIT_UGURU_TEMP_HIGH_ALARM_FLAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  found temp sensor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ABIT_UGURU_TEMP_SENSOR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">abituguru_detect_bank1_sensor_type_exit</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  alarm raised during temp &quot;</span>
				<span class="s">&quot;sensor test, but temp high flag not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  alarm not raised during temp sensor &quot;</span>
			<span class="s">&quot;test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ABIT_UGURU_NC</span><span class="p">;</span>
<span class="nl">abituguru_detect_bank1_sensor_type_exit:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Restore original settings, failing here is really BAD, it has been</span>
<span class="cm">	 * reported that some BIOS-es hang when entering the uGuru menu with</span>
<span class="cm">	 * invalid settings present in the uGuru, so we try this 3 times.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_SENSOR_BANK1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">sensor_addr</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_settings</span><span class="p">[</span><span class="n">sensor_addr</span><span class="p">],</span>
				<span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Fatal error could not restore original settings. %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">never_happen</span><span class="p">,</span> <span class="n">report_this</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * These functions try to find out how many sensors there are in bank2 and how</span>
<span class="cm"> * many pwms there are. The purpose of this is to make sure that we don&#39;t give</span>
<span class="cm"> * the user the possibility to change settings for non-existent sensors / pwm.</span>
<span class="cm"> * The uGuru will happily read / write whatever memory happens to be after the</span>
<span class="cm"> * memory storing the PWM settings when reading/writing to a PWM which is not</span>
<span class="cm"> * there. Notice even if we detect a PWM which doesn&#39;t exist we normally won&#39;t</span>
<span class="cm"> * write to it, unless the user tries to change the settings.</span>
<span class="cm"> *</span>
<span class="cm"> * Although the uGuru allows reading (settings) from non existing bank2</span>
<span class="cm"> * sensors, my version of the uGuru does seem to stop writing to them, the</span>
<span class="cm"> * write function above aborts in this case with:</span>
<span class="cm"> * &quot;CMD reg does not hold 0xAC after write&quot;</span>
<span class="cm"> *</span>
<span class="cm"> * Notice these 2 tests are non destructive iow read-only tests, otherwise</span>
<span class="cm"> * they would defeat their purpose. Although for the bank2_sensors detection a</span>
<span class="cm"> * read/write test would be feasible because of the reaction above, I&#39;ve</span>
<span class="cm"> * however opted to stay on the safe side.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">abituguru_detect_no_bank2_sensors</span><span class="p">(</span><span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fan_sensors</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">fan_sensors</span> <span class="o">&lt;=</span> <span class="n">ABIT_UGURU_MAX_BANK2_SENSORS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_sensors</span> <span class="o">=</span> <span class="n">fan_sensors</span><span class="p">;</span>
		<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;assuming %d fan sensors because of &quot;</span>
			<span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">fan_sensors</span><span class="se">\&quot;</span><span class="s"> module param</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_sensors</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;detecting number of fan sensors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ABIT_UGURU_MAX_BANK2_SENSORS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * 0x89 are the known used bits:</span>
<span class="cm">		 * -0x80 enable shutdown</span>
<span class="cm">		 * -0x08 enable beep</span>
<span class="cm">		 * -0x01 enable alarm</span>
<span class="cm">		 * All other bits should be 0, but on some motherboards</span>
<span class="cm">		 * 0x40 (bit 6) is also high for some of the fans??</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xC9</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  bank2 sensor %d does not seem &quot;</span>
				<span class="s">&quot;to be a fan sensor: settings[0] = %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check if the threshold is within the allowed range */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span>
				<span class="n">abituguru_bank2_min_threshold</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  bank2 sensor %d does not seem &quot;</span>
				<span class="s">&quot;to be a fan sensor: the threshold (%d) is &quot;</span>
				<span class="s">&quot;below the minimum (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">abituguru_bank2_min_threshold</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span>
				<span class="n">abituguru_bank2_max_threshold</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  bank2 sensor %d does not seem &quot;</span>
				<span class="s">&quot;to be a fan sensor: the threshold (%d) is &quot;</span>
				<span class="s">&quot;above the maximum (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">abituguru_bank2_max_threshold</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_sensors</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot; found: %d fan sensors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_sensors</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">abituguru_detect_no_pwms</span><span class="p">(</span><span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pwms</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pwms</span> <span class="o">&lt;=</span> <span class="n">ABIT_UGURU_MAX_PWMS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwms</span> <span class="o">=</span> <span class="n">pwms</span><span class="p">;</span>
		<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;assuming %d PWM outputs because of &quot;</span>
			<span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">pwms</span><span class="se">\&quot;</span><span class="s"> module param</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwms</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;detecting number of PWM outputs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ABIT_UGURU_MAX_PWMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * 0x80 is the enable bit and the low</span>
<span class="cm">		 * nibble is which temp sensor to use,</span>
<span class="cm">		 * the other bits should be 0</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x8F</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  pwm channel %d does not seem &quot;</span>
				<span class="s">&quot;to be a pwm channel: settings[0] = %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * the low nibble must correspond to one of the temp sensors</span>
<span class="cm">		 * we&#39;ve found</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_sensors</span><span class="p">[</span><span class="n">ABIT_UGURU_TEMP_SENSOR</span><span class="p">];</span>
				<span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_address</span><span class="p">[</span><span class="n">ABIT_UGURU_TEMP_SENSOR</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span>
					<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_sensors</span><span class="p">[</span><span class="n">ABIT_UGURU_TEMP_SENSOR</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  pwm channel %d does not seem &quot;</span>
				<span class="s">&quot;to be a pwm channel: %d is not a valid temp &quot;</span>
				<span class="s">&quot;sensor address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check if all other settings are within the allowed range */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">min</span><span class="p">;</span>
			<span class="cm">/* special case pwm1 min pwm% */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)))</span>
				<span class="n">min</span> <span class="o">=</span> <span class="mi">77</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">min</span> <span class="o">=</span> <span class="n">abituguru_pwm_min</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  pwm channel %d does &quot;</span>
					<span class="s">&quot;not seem to be a pwm channel: &quot;</span>
					<span class="s">&quot;setting %d (%d) is below the minimum &quot;</span>
					<span class="s">&quot;value (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
					<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">min</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">abituguru_detect_no_pwms_exit</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">abituguru_pwm_max</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  pwm channel %d does &quot;</span>
					<span class="s">&quot;not seem to be a pwm channel: &quot;</span>
					<span class="s">&quot;setting %d (%d) is above the maximum &quot;</span>
					<span class="s">&quot;value (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
					<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">abituguru_pwm_max</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
				<span class="k">goto</span> <span class="n">abituguru_detect_no_pwms_exit</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* check that min temp &lt; max temp and min pwm &lt; max pwm */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  pwm channel %d does not seem &quot;</span>
				<span class="s">&quot;to be a pwm channel: min pwm (%d) &gt;= &quot;</span>
				<span class="s">&quot;max pwm (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;  pwm channel %d does not seem &quot;</span>
				<span class="s">&quot;to be a pwm channel: min temp (%d) &gt;= &quot;</span>
				<span class="s">&quot;max temp (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">abituguru_detect_no_pwms_exit:</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwms</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot; found: %d PWM outputs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwms</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Following are the sysfs callback functions. These functions expect:</span>
<span class="cm"> * sensor_device_attribute_2-&gt;index:   sensor address/offset in the bank</span>
<span class="cm"> * sensor_device_attribute_2-&gt;nr:      register offset, bitmask or NA.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">abituguru_update_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_bank1_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">abituguru_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_value</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_max_value</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_bank1_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">*</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_max_value</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_bank2_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">abituguru_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_value</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span>
		<span class="n">ABIT_UGURU_FAN_MAX</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_bank2_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">*</span>
		<span class="n">ABIT_UGURU_FAN_MAX</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_bank1_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span>
	<span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">*</span> <span class="mi">255</span> <span class="o">+</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_max_value</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_max_value</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">orig_val</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">];</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_SENSOR_BANK1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">],</span>
				<span class="mi">3</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_val</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_bank2_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span>
	<span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">*</span> <span class="mi">255</span> <span class="o">+</span> <span class="n">ABIT_UGURU_FAN_MAX</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">ABIT_UGURU_FAN_MAX</span><span class="p">;</span>

	<span class="cm">/* this check can be done before taking the lock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">abituguru_bank2_min_threshold</span> <span class="o">||</span>
			<span class="n">val</span> <span class="o">&gt;</span> <span class="n">abituguru_bank2_max_threshold</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">orig_val</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">];</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_SENSOR_BANK2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">],</span>
				<span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_val</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_bank1_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">abituguru_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * See if the alarm bit for this sensor is set, and if the</span>
<span class="cm">	 * alarm matches the type of alarm we&#39;re looking for (for volt</span>
<span class="cm">	 * it can be either low or high). The type is stored in a few</span>
<span class="cm">	 * readonly bits in the settings part of the relevant sensor.</span>
<span class="cm">	 * The bitmask of the type is passed to us in attr-&gt;nr.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_bank2_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">abituguru_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_bank1_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_bank2_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_bank1_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">orig_val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">orig_val</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">orig_val</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">abituguru_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
			<span class="n">ABIT_UGURU_SENSOR_BANK1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_val</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_bank2_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">orig_val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">orig_val</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">orig_val</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">abituguru_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
			<span class="n">ABIT_UGURU_SENSOR_BANK2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_val</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Fan PWM (speed control) */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pwm_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">*</span>
		<span class="n">abituguru_pwm_settings_multiplier</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_pwm_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span>
	<span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">min</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">+</span> <span class="n">abituguru_pwm_settings_multiplier</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span>
				<span class="n">abituguru_pwm_settings_multiplier</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">];</span>

	<span class="cm">/* special case pwm1 min pwm% */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)))</span>
		<span class="n">min</span> <span class="o">=</span> <span class="mi">77</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">min</span> <span class="o">=</span> <span class="n">abituguru_pwm_min</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">];</span>

	<span class="cm">/* this check can be done before taking the lock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">min</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">abituguru_pwm_max</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="cm">/* this check needs to be done after taking the lock */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">orig_val</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">];</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_FAN_PWM</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">],</span>
				<span class="mi">5</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">orig_val</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pwm_sensor</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We need to walk to the temp sensor addresses to find what</span>
<span class="cm">	 * the userspace id of the configured temp sensor is.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_sensors</span><span class="p">[</span><span class="n">ABIT_UGURU_TEMP_SENSOR</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_address</span><span class="p">[</span><span class="n">ABIT_UGURU_TEMP_SENSOR</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span>
				<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_pwm_sensor</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span>
	<span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">orig_val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">address</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_sensors</span><span class="p">[</span><span class="n">ABIT_UGURU_TEMP_SENSOR</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">orig_val</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">address</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_address</span><span class="p">[</span><span class="n">ABIT_UGURU_TEMP_SENSOR</span><span class="p">][</span><span class="n">val</span><span class="p">];</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xF0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">address</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">orig_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_FAN_PWM</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
				    <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_val</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pwm_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ABIT_UGURU_FAN_PWM_ENABLE</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_pwm_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span>
	<span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">orig_val</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">user_val</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">orig_val</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">user_val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="n">ABIT_UGURU_FAN_PWM_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">ABIT_UGURU_FAN_PWM_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">orig_val</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">abituguru_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_FAN_PWM</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">],</span>
			<span class="mi">5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_val</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ABIT_UGURU_NAME</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Sysfs attr templates, the real entries are generated automatically. */</span>
<span class="k">static</span> <span class="k">const</span>
<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="n">abituguru_sysfs_bank1_templ</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">in</span><span class="o">%</span><span class="n">d_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_bank1_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">in</span><span class="o">%</span><span class="n">d_min</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_bank1_setting</span><span class="p">,</span>
		<span class="n">store_bank1_setting</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">in</span><span class="o">%</span><span class="n">d_min_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_bank1_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="n">ABIT_UGURU_VOLT_LOW_ALARM_FLAG</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">in</span><span class="o">%</span><span class="n">d_max</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_bank1_setting</span><span class="p">,</span>
		<span class="n">store_bank1_setting</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">in</span><span class="o">%</span><span class="n">d_max_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_bank1_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="n">ABIT_UGURU_VOLT_HIGH_ALARM_FLAG</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">in</span><span class="o">%</span><span class="n">d_beep</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_bank1_mask</span><span class="p">,</span>
		<span class="n">store_bank1_mask</span><span class="p">,</span> <span class="n">ABIT_UGURU_BEEP_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">in</span><span class="o">%</span><span class="n">d_shutdown</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_bank1_mask</span><span class="p">,</span>
		<span class="n">store_bank1_mask</span><span class="p">,</span> <span class="n">ABIT_UGURU_SHUTDOWN_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">in</span><span class="o">%</span><span class="n">d_min_alarm_enable</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_bank1_mask</span><span class="p">,</span>
		<span class="n">store_bank1_mask</span><span class="p">,</span> <span class="n">ABIT_UGURU_VOLT_LOW_ALARM_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">in</span><span class="o">%</span><span class="n">d_max_alarm_enable</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_bank1_mask</span><span class="p">,</span>
		<span class="n">store_bank1_mask</span><span class="p">,</span> <span class="n">ABIT_UGURU_VOLT_HIGH_ALARM_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="p">},</span> <span class="p">{</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">temp</span><span class="o">%</span><span class="n">d_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_bank1_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">temp</span><span class="o">%</span><span class="n">d_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_bank1_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="n">ABIT_UGURU_TEMP_HIGH_ALARM_FLAG</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">temp</span><span class="o">%</span><span class="n">d_max</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_bank1_setting</span><span class="p">,</span>
		<span class="n">store_bank1_setting</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">temp</span><span class="o">%</span><span class="n">d_crit</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_bank1_setting</span><span class="p">,</span>
		<span class="n">store_bank1_setting</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">temp</span><span class="o">%</span><span class="n">d_beep</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_bank1_mask</span><span class="p">,</span>
		<span class="n">store_bank1_mask</span><span class="p">,</span> <span class="n">ABIT_UGURU_BEEP_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">temp</span><span class="o">%</span><span class="n">d_shutdown</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_bank1_mask</span><span class="p">,</span>
		<span class="n">store_bank1_mask</span><span class="p">,</span> <span class="n">ABIT_UGURU_SHUTDOWN_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">temp</span><span class="o">%</span><span class="n">d_alarm_enable</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_bank1_mask</span><span class="p">,</span>
		<span class="n">store_bank1_mask</span><span class="p">,</span> <span class="n">ABIT_UGURU_TEMP_HIGH_ALARM_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="n">abituguru_sysfs_fan_templ</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">fan</span><span class="o">%</span><span class="n">d_input</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_bank2_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">fan</span><span class="o">%</span><span class="n">d_alarm</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_bank2_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">fan</span><span class="o">%</span><span class="n">d_min</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_bank2_setting</span><span class="p">,</span>
		<span class="n">store_bank2_setting</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">fan</span><span class="o">%</span><span class="n">d_beep</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_bank2_mask</span><span class="p">,</span>
		<span class="n">store_bank2_mask</span><span class="p">,</span> <span class="n">ABIT_UGURU_BEEP_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">fan</span><span class="o">%</span><span class="n">d_shutdown</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_bank2_mask</span><span class="p">,</span>
		<span class="n">store_bank2_mask</span><span class="p">,</span> <span class="n">ABIT_UGURU_SHUTDOWN_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">fan</span><span class="o">%</span><span class="n">d_alarm_enable</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_bank2_mask</span><span class="p">,</span>
		<span class="n">store_bank2_mask</span><span class="p">,</span> <span class="n">ABIT_UGURU_FAN_LOW_ALARM_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="n">abituguru_sysfs_pwm_templ</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">pwm</span><span class="o">%</span><span class="n">d_enable</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_pwm_enable</span><span class="p">,</span>
		<span class="n">store_pwm_enable</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">pwm</span><span class="o">%</span><span class="n">d_auto_channels_temp</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_pwm_sensor</span><span class="p">,</span>
		<span class="n">store_pwm_sensor</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">pwm</span><span class="o">%</span><span class="n">d_auto_point1_pwm</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_pwm_setting</span><span class="p">,</span>
		<span class="n">store_pwm_setting</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">pwm</span><span class="o">%</span><span class="n">d_auto_point2_pwm</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_pwm_setting</span><span class="p">,</span>
		<span class="n">store_pwm_setting</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">pwm</span><span class="o">%</span><span class="n">d_auto_point1_temp</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_pwm_setting</span><span class="p">,</span>
		<span class="n">store_pwm_setting</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">pwm</span><span class="o">%</span><span class="n">d_auto_point2_temp</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_pwm_setting</span><span class="p">,</span>
		<span class="n">store_pwm_setting</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="n">abituguru_sysfs_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SENSOR_ATTR_2</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">abituguru_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">used</span><span class="p">,</span> <span class="n">sysfs_names_free</span><span class="p">,</span> <span class="n">sysfs_attr_i</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sysfs_filename</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * El weirdo probe order, to keep the sysfs order identical to the</span>
<span class="cm">	 * BIOS and window-appliction listing order.</span>
<span class="cm">	 */</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">probe_order</span><span class="p">[</span><span class="n">ABIT_UGURU_MAX_BANK1_SENSORS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
		<span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x0C</span> <span class="p">};</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">abituguru_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IO</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/* See if the uGuru is ready */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb_p</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">ABIT_UGURU_DATA</span><span class="p">)</span> <span class="o">==</span> <span class="n">ABIT_UGURU_STATUS_INPUT</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">uguru_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Completely read the uGuru this has 2 purposes:</span>
<span class="cm">	 * - testread / see if one really is there.</span>
<span class="cm">	 * - make an in memory copy of all the uguru settings for future use.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_ALARM_BANK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ABIT_UGURU_MAX_RETRIES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">abituguru_probe_error</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ABIT_UGURU_MAX_BANK1_SENSORS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_SENSOR_BANK1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">ABIT_UGURU_MAX_RETRIES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">abituguru_probe_error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_SENSOR_BANK1</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_settings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span>
				<span class="n">ABIT_UGURU_MAX_RETRIES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">abituguru_probe_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Note: We don&#39;t know how many bank2 sensors / pwms there really are,</span>
<span class="cm">	 * but in order to &quot;detect&quot; this we need to read the maximum amount</span>
<span class="cm">	 * anyways. If we read sensors/pwms not there we&#39;ll just read crap</span>
<span class="cm">	 * this can&#39;t hurt. We need the detection because we don&#39;t want</span>
<span class="cm">	 * unwanted writes, which will hurt!</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ABIT_UGURU_MAX_BANK2_SENSORS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_SENSOR_BANK2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">ABIT_UGURU_MAX_RETRIES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">abituguru_probe_error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_SENSOR_BANK2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_settings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">ABIT_UGURU_MAX_RETRIES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">abituguru_probe_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ABIT_UGURU_MAX_PWMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abituguru_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_FAN_PWM</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_settings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span>
				<span class="n">ABIT_UGURU_MAX_RETRIES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">abituguru_probe_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">last_updated</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* Detect sensor types and fill the sysfs attr for bank1 */</span>
	<span class="n">sysfs_attr_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sysfs_filename</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sysfs_names</span><span class="p">;</span>
	<span class="n">sysfs_names_free</span> <span class="o">=</span> <span class="n">ABITUGURU_SYSFS_NAMES_LENGTH</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ABIT_UGURU_MAX_BANK1_SENSORS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">abituguru_detect_bank1_sensor_type</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">probe_order</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">abituguru_probe_error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">ABIT_UGURU_NC</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* res 1 (temp) sensors have 7 sysfs entries, 0 (in) 9 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">res</span> <span class="o">?</span> <span class="mi">7</span> <span class="o">:</span> <span class="mi">9</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">used</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">sysfs_filename</span><span class="p">,</span> <span class="n">sysfs_names_free</span><span class="p">,</span>
				<span class="n">abituguru_sysfs_bank1_templ</span><span class="p">[</span><span class="n">res</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">.</span>
				<span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_sensors</span><span class="p">[</span><span class="n">res</span><span class="p">]</span> <span class="o">+</span> <span class="n">res</span><span class="p">)</span>
				<span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">sysfs_attr</span><span class="p">[</span><span class="n">sysfs_attr_i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">abituguru_sysfs_bank1_templ</span><span class="p">[</span><span class="n">res</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">sysfs_attr</span><span class="p">[</span><span class="n">sysfs_attr_i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span>
				<span class="n">sysfs_filename</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">sysfs_attr</span><span class="p">[</span><span class="n">sysfs_attr_i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">probe_order</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">sysfs_filename</span> <span class="o">+=</span> <span class="n">used</span><span class="p">;</span>
			<span class="n">sysfs_names_free</span> <span class="o">-=</span> <span class="n">used</span><span class="p">;</span>
			<span class="n">sysfs_attr_i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_max_value</span><span class="p">[</span><span class="n">probe_order</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span>
			<span class="n">abituguru_bank1_max_value</span><span class="p">[</span><span class="n">res</span><span class="p">];</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_address</span><span class="p">[</span><span class="n">res</span><span class="p">][</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_sensors</span><span class="p">[</span><span class="n">res</span><span class="p">]]</span> <span class="o">=</span>
			<span class="n">probe_order</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_sensors</span><span class="p">[</span><span class="n">res</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Detect number of sensors and fill the sysfs attr for bank2 (fans) */</span>
	<span class="n">abituguru_detect_no_bank2_sensors</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_sensors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">abituguru_sysfs_fan_templ</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">used</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">sysfs_filename</span><span class="p">,</span> <span class="n">sysfs_names_free</span><span class="p">,</span>
				<span class="n">abituguru_sysfs_fan_templ</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
				<span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">sysfs_attr</span><span class="p">[</span><span class="n">sysfs_attr_i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">abituguru_sysfs_fan_templ</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">sysfs_attr</span><span class="p">[</span><span class="n">sysfs_attr_i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span>
				<span class="n">sysfs_filename</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">sysfs_attr</span><span class="p">[</span><span class="n">sysfs_attr_i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">sysfs_filename</span> <span class="o">+=</span> <span class="n">used</span><span class="p">;</span>
			<span class="n">sysfs_names_free</span> <span class="o">-=</span> <span class="n">used</span><span class="p">;</span>
			<span class="n">sysfs_attr_i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Detect number of sensors and fill the sysfs attr for pwms */</span>
	<span class="n">abituguru_detect_no_pwms</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwms</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">abituguru_sysfs_pwm_templ</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">used</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">sysfs_filename</span><span class="p">,</span> <span class="n">sysfs_names_free</span><span class="p">,</span>
				<span class="n">abituguru_sysfs_pwm_templ</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
				<span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">sysfs_attr</span><span class="p">[</span><span class="n">sysfs_attr_i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">abituguru_sysfs_pwm_templ</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">sysfs_attr</span><span class="p">[</span><span class="n">sysfs_attr_i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span>
				<span class="n">sysfs_filename</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">sysfs_attr</span><span class="p">[</span><span class="n">sysfs_attr_i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">sysfs_filename</span> <span class="o">+=</span> <span class="n">used</span><span class="p">;</span>
			<span class="n">sysfs_names_free</span> <span class="o">-=</span> <span class="n">used</span><span class="p">;</span>
			<span class="n">sysfs_attr_i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Fail safe check, this should never happen! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_names_free</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Fatal error ran out of space for sysfs attr names. %s %s&quot;</span><span class="p">,</span>
		       <span class="n">never_happen</span><span class="p">,</span> <span class="n">report_this</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENAMETOOLONG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">abituguru_probe_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;found Abit uGuru</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Register sysfs hooks */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sysfs_attr_i</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sysfs_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">abituguru_probe_error</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">abituguru_sysfs_attr</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">abituguru_sysfs_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">abituguru_probe_error</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span> <span class="o">=</span> <span class="n">hwmon_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* success */</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
<span class="nl">abituguru_probe_error:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sysfs_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sysfs_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">abituguru_sysfs_attr</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">abituguru_sysfs_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">abituguru_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sysfs_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sysfs_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">abituguru_sysfs_attr</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">abituguru_sysfs_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="nf">abituguru_update_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* fake a complete successful read if no update necessary. */</span>
	<span class="kt">char</span> <span class="n">success</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">last_updated</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">success</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">abituguru_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_ALARM_BANK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">LEAVE_UPDATE</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ABIT_UGURU_MAX_BANK1_SENSORS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">abituguru_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_SENSOR_BANK1</span><span class="p">,</span>
					     <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">LEAVE_UPDATE</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">abituguru_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_SENSOR_BANK1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
					     <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank1_settings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">LEAVE_UPDATE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_sensors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">abituguru_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ABIT_UGURU_SENSOR_BANK2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bank2_value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">LEAVE_UPDATE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* success! */</span>
		<span class="n">success</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">update_timeouts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">LEAVE_UPDATE:</span>
		<span class="cm">/* handle timeout condition */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span> <span class="o">||</span> <span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* No overflow please */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_timeouts</span> <span class="o">&lt;</span> <span class="mi">255u</span><span class="p">)</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">update_timeouts</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_timeouts</span> <span class="o">&lt;=</span> <span class="n">ABIT_UGURU_MAX_TIMEOUTS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;timeout exceeded, will &quot;</span>
					<span class="s">&quot;try again next update</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="cm">/* Just a timeout, fake a successful read */</span>
				<span class="n">success</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;timeout exceeded %d &quot;</span>
					<span class="s">&quot;times waiting for more input state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_timeouts</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* On success set last_updated */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">last_updated</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">abituguru_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * make sure all communications with the uguru are done and no new</span>
<span class="cm">	 * ones are started</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">abituguru_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">abituguru_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="cm">/* See if the uGuru is still ready */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb_p</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">ABIT_UGURU_DATA</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ABIT_UGURU_STATUS_INPUT</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">uguru_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define abituguru_suspend	NULL</span>
<span class="cp">#define abituguru_resume	NULL</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">abituguru_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">ABIT_UGURU_NAME</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">abituguru_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">abituguru_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">abituguru_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">abituguru_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">abituguru_detect</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * See if there is an uguru there. After a reboot uGuru will hold 0x00</span>
<span class="cm">	 * at DATA and 0xAC, when this driver has already been loaded once</span>
<span class="cm">	 * DATA will hold 0x08. For most uGuru&#39;s CMD will hold 0xAC in either</span>
<span class="cm">	 * scenario but some will hold 0x00.</span>
<span class="cm">	 * Some uGuru&#39;s initially hold 0x09 at DATA and will only hold 0x08</span>
<span class="cm">	 * after reading CMD first, so CMD must be read first!</span>
<span class="cm">	 */</span>
	<span class="n">u8</span> <span class="n">cmd_val</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">ABIT_UGURU_BASE</span> <span class="o">+</span> <span class="n">ABIT_UGURU_CMD</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">data_val</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">ABIT_UGURU_BASE</span> <span class="o">+</span> <span class="n">ABIT_UGURU_DATA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">data_val</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">data_val</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">cmd_val</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cmd_val</span> <span class="o">==</span> <span class="mh">0xAC</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ABIT_UGURU_BASE</span><span class="p">;</span>

	<span class="n">ABIT_UGURU_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;no Abit uGuru found, data = 0x%02X, cmd = &quot;</span>
		<span class="s">&quot;0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">data_val</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">cmd_val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">force</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Assuming Abit uGuru is present because of </span><span class="se">\&quot;</span><span class="s">force</span><span class="se">\&quot;</span><span class="s"> parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ABIT_UGURU_BASE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* No uGuru found */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">abituguru_pdev</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">abituguru_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">address</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IO</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">board_vendor</span> <span class="o">=</span> <span class="n">dmi_get_system_info</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">);</span>

	<span class="cm">/* safety check, refuse to load on non Abit motherboards */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">board_vendor</span> <span class="o">||</span>
			<span class="n">strcmp</span><span class="p">(</span><span class="n">board_vendor</span><span class="p">,</span> <span class="s">&quot;http://www.abit.com.tw/&quot;</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">address</span> <span class="o">=</span> <span class="n">abituguru_detect</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">address</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">abituguru_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">abituguru_pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="n">ABIT_UGURU_NAME</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">abituguru_pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Device allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_driver_unregister</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">res</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">address</span> <span class="o">+</span> <span class="n">ABIT_UGURU_REGION_LENGTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ABIT_UGURU_NAME</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">abituguru_pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Device resource addition failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_device_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">abituguru_pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Device addition failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_device_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_device_put:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">abituguru_pdev</span><span class="p">);</span>
<span class="nl">exit_driver_unregister:</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">abituguru_driver</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">abituguru_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">abituguru_pdev</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">abituguru_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Hans de Goede &lt;hdegoede@redhat.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Abit uGuru Sensor device&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">abituguru_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">abituguru_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
