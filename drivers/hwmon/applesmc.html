<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › hwmon › applesmc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>applesmc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/hwmon/applesmc.c - driver for Apple&#39;s SMC (accelerometer, temperature</span>
<span class="cm"> * sensors, fan control, keyboard backlight control) used in Intel-based Apple</span>
<span class="cm"> * computers.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Nicolas Boichat &lt;nicolas@boichat.ch&gt;</span>
<span class="cm"> * Copyright (C) 2010 Henrik Rydberg &lt;rydberg@euromail.se&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on hdaps.c driver:</span>
<span class="cm"> * Copyright (C) 2005 Robert Love &lt;rml@novell.com&gt;</span>
<span class="cm"> * Copyright (C) 2005 Jesper Juhl &lt;jj@chaosbits.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Fan control based on smcFanControl:</span>
<span class="cm"> * Copyright (C) 2006 Hendrik Holtmann &lt;holtmann@mac.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License v2 as published by the</span>
<span class="cm"> * Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/input-polldev.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon-sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>

<span class="cm">/* data port used by Apple SMC */</span>
<span class="cp">#define APPLESMC_DATA_PORT	0x300</span>
<span class="cm">/* command/status port used by Apple SMC */</span>
<span class="cp">#define APPLESMC_CMD_PORT	0x304</span>

<span class="cp">#define APPLESMC_NR_PORTS	32 </span><span class="cm">/* 0x300-0x31f */</span><span class="cp"></span>

<span class="cp">#define APPLESMC_MAX_DATA_LENGTH 32</span>

<span class="cm">/* wait up to 32 ms for a status change. */</span>
<span class="cp">#define APPLESMC_MIN_WAIT	0x0040</span>
<span class="cp">#define APPLESMC_MAX_WAIT	0x8000</span>

<span class="cp">#define APPLESMC_STATUS_MASK	0x0f</span>
<span class="cp">#define APPLESMC_READ_CMD	0x10</span>
<span class="cp">#define APPLESMC_WRITE_CMD	0x11</span>
<span class="cp">#define APPLESMC_GET_KEY_BY_INDEX_CMD	0x12</span>
<span class="cp">#define APPLESMC_GET_KEY_TYPE_CMD	0x13</span>

<span class="cp">#define KEY_COUNT_KEY		&quot;#KEY&quot; </span><span class="cm">/* r-o ui32 */</span><span class="cp"></span>

<span class="cp">#define LIGHT_SENSOR_LEFT_KEY	&quot;ALV0&quot; </span><span class="cm">/* r-o {alv (6-10 bytes) */</span><span class="cp"></span>
<span class="cp">#define LIGHT_SENSOR_RIGHT_KEY	&quot;ALV1&quot; </span><span class="cm">/* r-o {alv (6-10 bytes) */</span><span class="cp"></span>
<span class="cp">#define BACKLIGHT_KEY		&quot;LKSB&quot; </span><span class="cm">/* w-o {lkb (2 bytes) */</span><span class="cp"></span>

<span class="cp">#define CLAMSHELL_KEY		&quot;MSLD&quot; </span><span class="cm">/* r-o ui8 (unused) */</span><span class="cp"></span>

<span class="cp">#define MOTION_SENSOR_X_KEY	&quot;MO_X&quot; </span><span class="cm">/* r-o sp78 (2 bytes) */</span><span class="cp"></span>
<span class="cp">#define MOTION_SENSOR_Y_KEY	&quot;MO_Y&quot; </span><span class="cm">/* r-o sp78 (2 bytes) */</span><span class="cp"></span>
<span class="cp">#define MOTION_SENSOR_Z_KEY	&quot;MO_Z&quot; </span><span class="cm">/* r-o sp78 (2 bytes) */</span><span class="cp"></span>
<span class="cp">#define MOTION_SENSOR_KEY	&quot;MOCN&quot; </span><span class="cm">/* r/w ui16 */</span><span class="cp"></span>

<span class="cp">#define FANS_COUNT		&quot;FNum&quot; </span><span class="cm">/* r-o ui8 */</span><span class="cp"></span>
<span class="cp">#define FANS_MANUAL		&quot;FS! &quot; </span><span class="cm">/* r-w ui16 */</span><span class="cp"></span>
<span class="cp">#define FAN_ID_FMT		&quot;F%dID&quot; </span><span class="cm">/* r-o char[16] */</span><span class="cp"></span>

<span class="cm">/* List of keys used to read/write fan speeds */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">fan_speed_fmt</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;F%dAc&quot;</span><span class="p">,</span>		<span class="cm">/* actual speed */</span>
	<span class="s">&quot;F%dMn&quot;</span><span class="p">,</span>		<span class="cm">/* minimum speed (rw) */</span>
	<span class="s">&quot;F%dMx&quot;</span><span class="p">,</span>		<span class="cm">/* maximum speed */</span>
	<span class="s">&quot;F%dSf&quot;</span><span class="p">,</span>		<span class="cm">/* safe speed - not all models */</span>
	<span class="s">&quot;F%dTg&quot;</span><span class="p">,</span>		<span class="cm">/* target speed (manual: rw) */</span>
<span class="p">};</span>

<span class="cp">#define INIT_TIMEOUT_MSECS	5000	</span><span class="cm">/* wait up to 5s for device init ... */</span><span class="cp"></span>
<span class="cp">#define INIT_WAIT_MSECS		50	</span><span class="cm">/* ... in 50ms increments */</span><span class="cp"></span>

<span class="cp">#define APPLESMC_POLL_INTERVAL	50	</span><span class="cm">/* msecs */</span><span class="cp"></span>
<span class="cp">#define APPLESMC_INPUT_FUZZ	4	</span><span class="cm">/* input event threshold */</span><span class="cp"></span>
<span class="cp">#define APPLESMC_INPUT_FLAT	4</span>

<span class="cp">#define SENSOR_X 0</span>
<span class="cp">#define SENSOR_Y 1</span>
<span class="cp">#define SENSOR_Z 2</span>

<span class="cp">#define to_index(attr) (to_sensor_dev_attr(attr)-&gt;index &amp; 0xffff)</span>
<span class="cp">#define to_option(attr) (to_sensor_dev_attr(attr)-&gt;index &gt;&gt; 16)</span>

<span class="cm">/* Dynamic device node attributes */</span>
<span class="k">struct</span> <span class="n">applesmc_dev_attr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="n">sda</span><span class="p">;</span>	<span class="cm">/* hwmon attributes */</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>				<span class="cm">/* room for node file name */</span>
<span class="p">};</span>

<span class="cm">/* Dynamic device node group */</span>
<span class="k">struct</span> <span class="n">applesmc_node_group</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>				<span class="cm">/* format string */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">show</span><span class="p">;</span>				<span class="cm">/* show function */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">store</span><span class="p">;</span>				<span class="cm">/* store function */</span>
	<span class="kt">int</span> <span class="n">option</span><span class="p">;</span>				<span class="cm">/* function argument */</span>
	<span class="k">struct</span> <span class="n">applesmc_dev_attr</span> <span class="o">*</span><span class="n">nodes</span><span class="p">;</span>	<span class="cm">/* dynamic node array */</span>
<span class="p">};</span>

<span class="cm">/* AppleSMC entry - cached register information */</span>
<span class="k">struct</span> <span class="n">applesmc_entry</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>		<span class="cm">/* four-letter key code */</span>
	<span class="n">u8</span> <span class="n">valid</span><span class="p">;</span>		<span class="cm">/* set when entry is successfully read once */</span>
	<span class="n">u8</span> <span class="n">len</span><span class="p">;</span>			<span class="cm">/* bounded by APPLESMC_MAX_DATA_LENGTH */</span>
	<span class="kt">char</span> <span class="n">type</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>		<span class="cm">/* four-letter type code */</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>		<span class="cm">/* 0x10: func; 0x40: write; 0x80: read */</span>
<span class="p">};</span>

<span class="cm">/* Register lookup and registers common to all SMCs */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">applesmc_registers</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>		<span class="cm">/* register read/write mutex */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key_count</span><span class="p">;</span>		<span class="cm">/* number of SMC registers */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fan_count</span><span class="p">;</span>		<span class="cm">/* number of fans */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">temp_count</span><span class="p">;</span>	<span class="cm">/* number of temperature registers */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">temp_begin</span><span class="p">;</span>	<span class="cm">/* temperature lower index bound */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">temp_end</span><span class="p">;</span>		<span class="cm">/* temperature upper index bound */</span>
	<span class="kt">int</span> <span class="n">num_light_sensors</span><span class="p">;</span>		<span class="cm">/* number of light sensors */</span>
	<span class="n">bool</span> <span class="n">has_accelerometer</span><span class="p">;</span>		<span class="cm">/* has motion sensor */</span>
	<span class="n">bool</span> <span class="n">has_key_backlight</span><span class="p">;</span>		<span class="cm">/* has keyboard backlight */</span>
	<span class="n">bool</span> <span class="n">init_complete</span><span class="p">;</span>		<span class="cm">/* true when fully initialized */</span>
	<span class="k">struct</span> <span class="n">applesmc_entry</span> <span class="o">*</span><span class="n">cache</span><span class="p">;</span>	<span class="cm">/* cached key entries */</span>
<span class="p">}</span> <span class="n">smcreg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mutex</span> <span class="o">=</span> <span class="n">__MUTEX_INITIALIZER</span><span class="p">(</span><span class="n">smcreg</span><span class="p">.</span><span class="n">mutex</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
<span class="k">static</span> <span class="n">s16</span> <span class="n">rest_x</span><span class="p">;</span>
<span class="k">static</span> <span class="n">s16</span> <span class="n">rest_y</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">backlight_state</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">hwmon_dev</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">input_polled_dev</span> <span class="o">*</span><span class="n">applesmc_idev</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Last index written to key_at_index sysfs file, and value to use for all other</span>
<span class="cm"> * key_at_index_* sysfs files.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key_at_index</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">applesmc_led_wq</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * __wait_status - Wait up to 32ms for the status port to get a certain value</span>
<span class="cm"> * (masked with 0x0f), returning zero if the value is obtained.  Callers must</span>
<span class="cm"> * hold applesmc_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__wait_status</span><span class="p">(</span><span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">us</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">APPLESMC_STATUS_MASK</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">us</span> <span class="o">=</span> <span class="n">APPLESMC_MIN_WAIT</span><span class="p">;</span> <span class="n">us</span> <span class="o">&lt;</span> <span class="n">APPLESMC_MAX_WAIT</span><span class="p">;</span> <span class="n">us</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">APPLESMC_CMD_PORT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">APPLESMC_STATUS_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * special treatment of command port - on newer macbooks, it seems necessary</span>
<span class="cm"> * to resend the command byte before polling the status again. Callers must</span>
<span class="cm"> * hold applesmc_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_command</span><span class="p">(</span><span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">us</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">us</span> <span class="o">=</span> <span class="n">APPLESMC_MIN_WAIT</span><span class="p">;</span> <span class="n">us</span> <span class="o">&lt;</span> <span class="n">APPLESMC_MAX_WAIT</span><span class="p">;</span> <span class="n">us</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">APPLESMC_CMD_PORT</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">APPLESMC_CMD_PORT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">APPLESMC_STATUS_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0c</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_argument</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">APPLESMC_DATA_PORT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__wait_status</span><span class="p">(</span><span class="mh">0x04</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_smc</span><span class="p">(</span><span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">send_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">||</span> <span class="n">send_argument</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%.4s: read arg fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">APPLESMC_DATA_PORT</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__wait_status</span><span class="p">(</span><span class="mh">0x05</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%.4s: read data fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">APPLESMC_DATA_PORT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_smc</span><span class="p">(</span><span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">send_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">||</span> <span class="n">send_argument</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: write arg fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">APPLESMC_DATA_PORT</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__wait_status</span><span class="p">(</span><span class="mh">0x04</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: write data fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">APPLESMC_DATA_PORT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_register_count</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">be</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_smc</span><span class="p">(</span><span class="n">APPLESMC_READ_CMD</span><span class="p">,</span> <span class="n">KEY_COUNT_KEY</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">be</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">be</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Serialized I/O</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on success or a negative error on failure.</span>
<span class="cm"> * All functions below are concurrency safe - callers should NOT hold lock.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">applesmc_read_entry</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">applesmc_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smcreg</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_smc</span><span class="p">(</span><span class="n">APPLESMC_READ_CMD</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smcreg</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">applesmc_write_entry</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">applesmc_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smcreg</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">write_smc</span><span class="p">(</span><span class="n">APPLESMC_WRITE_CMD</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smcreg</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">applesmc_entry</span> <span class="o">*</span><span class="nf">applesmc_get_entry_by_index</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">applesmc_entry</span> <span class="o">*</span><span class="n">cache</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smcreg</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">__be32</span> <span class="n">be</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cache</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smcreg</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">be</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_smc</span><span class="p">(</span><span class="n">APPLESMC_GET_KEY_BY_INDEX_CMD</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">be</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_smc</span><span class="p">(</span><span class="n">APPLESMC_GET_KEY_TYPE_CMD</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cache</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cache</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">cache</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smcreg</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cache</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">applesmc_get_lower_bound</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">lo</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">begin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">smcreg</span><span class="p">.</span><span class="n">key_count</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">applesmc_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">begin</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">middle</span> <span class="o">=</span> <span class="n">begin</span> <span class="o">+</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">begin</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">applesmc_get_entry_by_index</span><span class="p">(</span><span class="n">middle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">begin</span> <span class="o">=</span> <span class="n">middle</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">end</span> <span class="o">=</span> <span class="n">middle</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">lo</span> <span class="o">=</span> <span class="n">begin</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">applesmc_get_upper_bound</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">hi</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">begin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">smcreg</span><span class="p">.</span><span class="n">key_count</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">applesmc_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">begin</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">middle</span> <span class="o">=</span> <span class="n">begin</span> <span class="o">+</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">begin</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">applesmc_get_entry_by_index</span><span class="p">(</span><span class="n">middle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">hi</span> <span class="o">=</span> <span class="n">smcreg</span><span class="p">.</span><span class="n">key_count</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">end</span> <span class="o">=</span> <span class="n">middle</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">begin</span> <span class="o">=</span> <span class="n">middle</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">hi</span> <span class="o">=</span> <span class="n">begin</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">applesmc_entry</span> <span class="o">*</span><span class="nf">applesmc_get_entry_by_key</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_get_lower_bound</span><span class="p">(</span><span class="o">&amp;</span><span class="n">begin</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_get_upper_bound</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">begin</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">applesmc_get_entry_by_index</span><span class="p">(</span><span class="n">begin</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">applesmc_read_key</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">applesmc_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">applesmc_get_entry_by_key</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">applesmc_read_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">applesmc_write_key</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">applesmc_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">applesmc_get_entry_by_key</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">applesmc_write_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">applesmc_has_key</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">applesmc_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">applesmc_get_entry_by_key</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * applesmc_read_motion_sensor - Read motion sensor (X, Y or Z).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">applesmc_read_motion_sensor</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">s16</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SENSOR_X</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_read_key</span><span class="p">(</span><span class="n">MOTION_SENSOR_X_KEY</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SENSOR_Y</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_read_key</span><span class="p">(</span><span class="n">MOTION_SENSOR_Y_KEY</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SENSOR_Z</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_read_key</span><span class="p">(</span><span class="n">MOTION_SENSOR_Z_KEY</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">((</span><span class="n">s16</span><span class="p">)</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * applesmc_device_init - initialize the accelerometer.  Can sleep.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">applesmc_device_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">total</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smcreg</span><span class="p">.</span><span class="n">has_accelerometer</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">total</span> <span class="o">=</span> <span class="n">INIT_TIMEOUT_MSECS</span><span class="p">;</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">total</span> <span class="o">-=</span> <span class="n">INIT_WAIT_MSECS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">applesmc_read_key</span><span class="p">(</span><span class="n">MOTION_SENSOR_KEY</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span> <span class="o">||</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xe0</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">applesmc_write_key</span><span class="p">(</span><span class="n">MOTION_SENSOR_KEY</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">INIT_WAIT_MSECS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;failed to init the device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * applesmc_init_smcreg_try - Try to initialize register cache. Idempotent.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">applesmc_init_smcreg_try</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">applesmc_registers</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smcreg</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">left_light_sensor</span><span class="p">,</span> <span class="n">right_light_sensor</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">init_complete</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_register_count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">key_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">cache</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">key_count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_read_key</span><span class="p">(</span><span class="n">FANS_COUNT</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">fan_count</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_get_lower_bound</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">temp_begin</span><span class="p">,</span> <span class="s">&quot;T&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_get_lower_bound</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">temp_end</span><span class="p">,</span> <span class="s">&quot;U&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">temp_count</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">temp_end</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">temp_begin</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_has_key</span><span class="p">(</span><span class="n">LIGHT_SENSOR_LEFT_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">left_light_sensor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_has_key</span><span class="p">(</span><span class="n">LIGHT_SENSOR_RIGHT_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right_light_sensor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_has_key</span><span class="p">(</span><span class="n">MOTION_SENSOR_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">has_accelerometer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_has_key</span><span class="p">(</span><span class="n">BACKLIGHT_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">has_key_backlight</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">num_light_sensors</span> <span class="o">=</span> <span class="n">left_light_sensor</span> <span class="o">+</span> <span class="n">right_light_sensor</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">init_complete</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;key=%d fan=%d temp=%d acc=%d lux=%d kbd=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">s</span><span class="o">-&gt;</span><span class="n">key_count</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">fan_count</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">temp_count</span><span class="p">,</span>
	       <span class="n">s</span><span class="o">-&gt;</span><span class="n">has_accelerometer</span><span class="p">,</span>
	       <span class="n">s</span><span class="o">-&gt;</span><span class="n">num_light_sensors</span><span class="p">,</span>
	       <span class="n">s</span><span class="o">-&gt;</span><span class="n">has_key_backlight</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * applesmc_init_smcreg - Initialize register cache.</span>
<span class="cm"> *</span>
<span class="cm"> * Retries until initialization is successful, or the operation times out.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">applesmc_init_smcreg</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ms</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ms</span> <span class="o">&lt;</span> <span class="n">INIT_TIMEOUT_MSECS</span><span class="p">;</span> <span class="n">ms</span> <span class="o">+=</span> <span class="n">INIT_WAIT_MSECS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_init_smcreg_try</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ms</span><span class="p">)</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;init_smcreg() took %d ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">INIT_WAIT_MSECS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">smcreg</span><span class="p">.</span><span class="n">cache</span><span class="p">);</span>
	<span class="n">smcreg</span><span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">applesmc_destroy_smcreg</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">smcreg</span><span class="p">.</span><span class="n">cache</span><span class="p">);</span>
	<span class="n">smcreg</span><span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">smcreg</span><span class="p">.</span><span class="n">init_complete</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Device model stuff */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">applesmc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_init_smcreg</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">applesmc_device_init</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Synchronize device with memorized backlight state */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">applesmc_pm_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smcreg</span><span class="p">.</span><span class="n">has_key_backlight</span><span class="p">)</span>
		<span class="n">applesmc_write_key</span><span class="p">(</span><span class="n">BACKLIGHT_KEY</span><span class="p">,</span> <span class="n">backlight_state</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Reinitialize device on resume from hibernation */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">applesmc_pm_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">applesmc_device_init</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">applesmc_pm_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">applesmc_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">applesmc_pm_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span> <span class="o">=</span> <span class="n">applesmc_pm_restore</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">applesmc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">applesmc_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;applesmc&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">applesmc_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * applesmc_calibrate - Set our &quot;resting&quot; values.  Callers must</span>
<span class="cm"> * hold applesmc_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">applesmc_calibrate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">applesmc_read_motion_sensor</span><span class="p">(</span><span class="n">SENSOR_X</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rest_x</span><span class="p">);</span>
	<span class="n">applesmc_read_motion_sensor</span><span class="p">(</span><span class="n">SENSOR_Y</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rest_y</span><span class="p">);</span>
	<span class="n">rest_x</span> <span class="o">=</span> <span class="o">-</span><span class="n">rest_x</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">applesmc_idev_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_polled_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">applesmc_read_motion_sensor</span><span class="p">(</span><span class="n">SENSOR_X</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">applesmc_read_motion_sensor</span><span class="p">(</span><span class="n">SENSOR_Y</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span><span class="p">;</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">rest_x</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">rest_y</span><span class="p">);</span>
	<span class="n">input_sync</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Sysfs Files */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">applesmc_name_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;applesmc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">applesmc_position_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_read_motion_sensor</span><span class="p">(</span><span class="n">SENSOR_X</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_read_motion_sensor</span><span class="p">(</span><span class="n">SENSOR_Y</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_read_motion_sensor</span><span class="p">(</span><span class="n">SENSOR_Z</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">z</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;(%d,%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">applesmc_light_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sysfsbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">applesmc_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">data_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data_length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">applesmc_get_entry_by_key</span><span class="p">(</span><span class="n">LIGHT_SENSOR_LEFT_KEY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="n">data_length</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;light sensor data length set to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data_length</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_read_key</span><span class="p">(</span><span class="n">LIGHT_SENSOR_LEFT_KEY</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">data_length</span><span class="p">);</span>
	<span class="cm">/* newer macbooks report a single 10-bit bigendian value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_length</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)(</span><span class="n">buffer</span> <span class="o">+</span> <span class="mi">6</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_read_key</span><span class="p">(</span><span class="n">LIGHT_SENSOR_RIGHT_KEY</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">data_length</span><span class="p">);</span>
	<span class="n">right</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">sysfsbuf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;(%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Displays sensor key as label */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">applesmc_show_sensor_label</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sysfsbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">smcreg</span><span class="p">.</span><span class="n">temp_begin</span> <span class="o">+</span> <span class="n">to_index</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">applesmc_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">applesmc_get_entry_by_index</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">sysfsbuf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Displays degree Celsius * 1000 */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">applesmc_show_temperature</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sysfsbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">smcreg</span><span class="p">.</span><span class="n">temp_begin</span> <span class="o">+</span> <span class="n">to_index</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">applesmc_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">applesmc_get_entry_by_index</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_read_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">+=</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">250</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">sysfsbuf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">applesmc_show_fan_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sysfsbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">newkey</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">newkey</span><span class="p">,</span> <span class="n">fan_speed_fmt</span><span class="p">[</span><span class="n">to_option</span><span class="p">(</span><span class="n">attr</span><span class="p">)],</span> <span class="n">to_index</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_read_key</span><span class="p">(</span><span class="n">newkey</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">speed</span> <span class="o">=</span> <span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">sysfsbuf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">applesmc_store_fan_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sysfsbuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">speed</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">newkey</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoul</span><span class="p">(</span><span class="n">sysfsbuf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">speed</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">speed</span> <span class="o">&gt;=</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>		<span class="cm">/* Bigger than a 14-bit value */</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">newkey</span><span class="p">,</span> <span class="n">fan_speed_fmt</span><span class="p">[</span><span class="n">to_option</span><span class="p">(</span><span class="n">attr</span><span class="p">)],</span> <span class="n">to_index</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_write_key</span><span class="p">(</span><span class="n">newkey</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">applesmc_show_fan_manual</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sysfsbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">manual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_read_key</span><span class="p">(</span><span class="n">FANS_MANUAL</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">manual</span> <span class="o">=</span> <span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="n">to_index</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">sysfsbuf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">manual</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">applesmc_store_fan_manual</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sysfsbuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">input</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoul</span><span class="p">(</span><span class="n">sysfsbuf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_read_key</span><span class="p">(</span><span class="n">FANS_MANUAL</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">input</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">to_index</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">to_index</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_write_key</span><span class="p">(</span><span class="n">FANS_MANUAL</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">applesmc_show_fan_position</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sysfsbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">newkey</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">newkey</span><span class="p">,</span> <span class="n">FAN_ID_FMT</span><span class="p">,</span> <span class="n">to_index</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_read_key</span><span class="p">(</span><span class="n">newkey</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">sysfsbuf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">applesmc_calibrate_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sysfsbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">sysfsbuf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;(%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rest_x</span><span class="p">,</span> <span class="n">rest_y</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">applesmc_calibrate_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sysfsbuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">applesmc_calibrate</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">applesmc_backlight_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">applesmc_write_key</span><span class="p">(</span><span class="n">BACKLIGHT_KEY</span><span class="p">,</span> <span class="n">backlight_state</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DECLARE_WORK</span><span class="p">(</span><span class="n">backlight_work</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">applesmc_backlight_set</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">applesmc_brightness_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">backlight_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">queue_work</span><span class="p">(</span><span class="n">applesmc_led_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">backlight_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;applesmc: work was already on the queue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">applesmc_key_count_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sysfsbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_read_key</span><span class="p">(</span><span class="n">KEY_COUNT_KEY</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">+</span>
						<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">sysfsbuf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">applesmc_key_at_index_read_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sysfsbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">applesmc_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">applesmc_get_entry_by_index</span><span class="p">(</span><span class="n">key_at_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_read_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">sysfsbuf</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">applesmc_key_at_index_data_length_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sysfsbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">applesmc_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">applesmc_get_entry_by_index</span><span class="p">(</span><span class="n">key_at_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">sysfsbuf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">applesmc_key_at_index_type_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sysfsbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">applesmc_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">applesmc_get_entry_by_index</span><span class="p">(</span><span class="n">key_at_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">sysfsbuf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">applesmc_key_at_index_name_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sysfsbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">applesmc_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">applesmc_get_entry_by_index</span><span class="p">(</span><span class="n">key_at_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">sysfsbuf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">applesmc_key_at_index_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sysfsbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">sysfsbuf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key_at_index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">applesmc_key_at_index_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sysfsbuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">newkey</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoul</span><span class="p">(</span><span class="n">sysfsbuf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newkey</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
	    <span class="o">||</span> <span class="n">newkey</span> <span class="o">&gt;=</span> <span class="n">smcreg</span><span class="p">.</span><span class="n">key_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">key_at_index</span> <span class="o">=</span> <span class="n">newkey</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">led_classdev</span> <span class="n">applesmc_backlight</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;smc::kbd_backlight&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_trigger</span>	<span class="o">=</span> <span class="s">&quot;nand-disk&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">brightness_set</span>		<span class="o">=</span> <span class="n">applesmc_brightness_set</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">applesmc_node_group</span> <span class="n">info_group</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">applesmc_name_show</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;key_count&quot;</span><span class="p">,</span> <span class="n">applesmc_key_count_show</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;key_at_index&quot;</span><span class="p">,</span> <span class="n">applesmc_key_at_index_show</span><span class="p">,</span> <span class="n">applesmc_key_at_index_store</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;key_at_index_name&quot;</span><span class="p">,</span> <span class="n">applesmc_key_at_index_name_show</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;key_at_index_type&quot;</span><span class="p">,</span> <span class="n">applesmc_key_at_index_type_show</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;key_at_index_data_length&quot;</span><span class="p">,</span> <span class="n">applesmc_key_at_index_data_length_show</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;key_at_index_data&quot;</span><span class="p">,</span> <span class="n">applesmc_key_at_index_read_show</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">applesmc_node_group</span> <span class="n">accelerometer_group</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;position&quot;</span><span class="p">,</span> <span class="n">applesmc_position_show</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;calibrate&quot;</span><span class="p">,</span> <span class="n">applesmc_calibrate_show</span><span class="p">,</span> <span class="n">applesmc_calibrate_store</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">applesmc_node_group</span> <span class="n">light_sensor_group</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;light&quot;</span><span class="p">,</span> <span class="n">applesmc_light_show</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">applesmc_node_group</span> <span class="n">fan_group</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;fan%d_label&quot;</span><span class="p">,</span> <span class="n">applesmc_show_fan_position</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;fan%d_input&quot;</span><span class="p">,</span> <span class="n">applesmc_show_fan_speed</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;fan%d_min&quot;</span><span class="p">,</span> <span class="n">applesmc_show_fan_speed</span><span class="p">,</span> <span class="n">applesmc_store_fan_speed</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;fan%d_max&quot;</span><span class="p">,</span> <span class="n">applesmc_show_fan_speed</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;fan%d_safe&quot;</span><span class="p">,</span> <span class="n">applesmc_show_fan_speed</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;fan%d_output&quot;</span><span class="p">,</span> <span class="n">applesmc_show_fan_speed</span><span class="p">,</span> <span class="n">applesmc_store_fan_speed</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;fan%d_manual&quot;</span><span class="p">,</span> <span class="n">applesmc_show_fan_manual</span><span class="p">,</span> <span class="n">applesmc_store_fan_manual</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">applesmc_node_group</span> <span class="n">temp_group</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;temp%d_label&quot;</span><span class="p">,</span> <span class="n">applesmc_show_sensor_label</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;temp%d_input&quot;</span><span class="p">,</span> <span class="n">applesmc_show_temperature</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Module stuff */</span>

<span class="cm">/*</span>
<span class="cm"> * applesmc_destroy_nodes - remove files and free associated memory</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">applesmc_destroy_nodes</span><span class="p">(</span><span class="k">struct</span> <span class="n">applesmc_node_group</span> <span class="o">*</span><span class="n">groups</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">applesmc_node_group</span> <span class="o">*</span><span class="n">grp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">applesmc_dev_attr</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">grp</span> <span class="o">=</span> <span class="n">groups</span><span class="p">;</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">;</span> <span class="n">grp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">node</span> <span class="o">=</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">;</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">sda</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">;</span> <span class="n">node</span><span class="o">++</span><span class="p">)</span>
			<span class="n">sysfs_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">sda</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">);</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">nodes</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * applesmc_create_nodes - create a two-dimensional group of sysfs files</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">applesmc_create_nodes</span><span class="p">(</span><span class="k">struct</span> <span class="n">applesmc_node_group</span> <span class="o">*</span><span class="n">groups</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">applesmc_node_group</span> <span class="o">*</span><span class="n">grp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">applesmc_dev_attr</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">grp</span> <span class="o">=</span> <span class="n">groups</span><span class="p">;</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span> <span class="n">grp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">node</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">sda</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">option</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">sda</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">;</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">sda</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">grp</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">;</span>
			<span class="n">attr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">sda</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">;</span>
			<span class="n">sysfs_attr_init</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">store</span> <span class="o">?</span> <span class="n">S_IWUSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">applesmc_destroy_nodes</span><span class="p">(</span><span class="n">groups</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Create accelerometer ressources */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">applesmc_create_accelerometer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smcreg</span><span class="p">.</span><span class="n">has_accelerometer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_create_nodes</span><span class="p">(</span><span class="n">accelerometer_group</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">applesmc_idev</span> <span class="o">=</span> <span class="n">input_allocate_polled_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">applesmc_idev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_sysfs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">applesmc_idev</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">=</span> <span class="n">applesmc_idev_poll</span><span class="p">;</span>
	<span class="n">applesmc_idev</span><span class="o">-&gt;</span><span class="n">poll_interval</span> <span class="o">=</span> <span class="n">APPLESMC_POLL_INTERVAL</span><span class="p">;</span>

	<span class="cm">/* initial calibrate for the input device */</span>
	<span class="n">applesmc_calibrate</span><span class="p">();</span>

	<span class="cm">/* initialize the input device */</span>
	<span class="n">idev</span> <span class="o">=</span> <span class="n">applesmc_idev</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;applesmc&quot;</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_HOST</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span>
			<span class="o">-</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">APPLESMC_INPUT_FUZZ</span><span class="p">,</span> <span class="n">APPLESMC_INPUT_FLAT</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span>
			<span class="o">-</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">APPLESMC_INPUT_FUZZ</span><span class="p">,</span> <span class="n">APPLESMC_INPUT_FLAT</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">input_register_polled_device</span><span class="p">(</span><span class="n">applesmc_idev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_idev</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_idev:</span>
	<span class="n">input_free_polled_device</span><span class="p">(</span><span class="n">applesmc_idev</span><span class="p">);</span>

<span class="nl">out_sysfs:</span>
	<span class="n">applesmc_destroy_nodes</span><span class="p">(</span><span class="n">accelerometer_group</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;driver init failed (ret=%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Release all ressources used by the accelerometer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">applesmc_release_accelerometer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smcreg</span><span class="p">.</span><span class="n">has_accelerometer</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">input_unregister_polled_device</span><span class="p">(</span><span class="n">applesmc_idev</span><span class="p">);</span>
	<span class="n">input_free_polled_device</span><span class="p">(</span><span class="n">applesmc_idev</span><span class="p">);</span>
	<span class="n">applesmc_destroy_nodes</span><span class="p">(</span><span class="n">accelerometer_group</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">applesmc_create_light_sensor</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smcreg</span><span class="p">.</span><span class="n">num_light_sensors</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">applesmc_create_nodes</span><span class="p">(</span><span class="n">light_sensor_group</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">applesmc_release_light_sensor</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smcreg</span><span class="p">.</span><span class="n">num_light_sensors</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">applesmc_destroy_nodes</span><span class="p">(</span><span class="n">light_sensor_group</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">applesmc_create_key_backlight</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smcreg</span><span class="p">.</span><span class="n">has_key_backlight</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">applesmc_led_wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;applesmc-led&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">applesmc_led_wq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">applesmc_backlight</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">applesmc_release_key_backlight</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smcreg</span><span class="p">.</span><span class="n">has_key_backlight</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">applesmc_backlight</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">applesmc_led_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">applesmc_dmi_match</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Note that DMI_MATCH(...,&quot;MacBook&quot;) will match &quot;MacBookPro1,1&quot;.</span>
<span class="cm"> * So we need to put &quot;Apple MacBook Pro&quot; before &quot;Apple MacBook&quot;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__initdata</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">applesmc_whitelist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">applesmc_dmi_match</span><span class="p">,</span> <span class="s">&quot;Apple MacBook Air&quot;</span><span class="p">,</span> <span class="p">{</span>
	  <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;Apple&quot;</span><span class="p">),</span>
	  <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;MacBookAir&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">applesmc_dmi_match</span><span class="p">,</span> <span class="s">&quot;Apple MacBook Pro&quot;</span><span class="p">,</span> <span class="p">{</span>
	  <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;Apple&quot;</span><span class="p">),</span>
	  <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;MacBookPro&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">applesmc_dmi_match</span><span class="p">,</span> <span class="s">&quot;Apple MacBook&quot;</span><span class="p">,</span> <span class="p">{</span>
	  <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;Apple&quot;</span><span class="p">),</span>
	  <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;MacBook&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">applesmc_dmi_match</span><span class="p">,</span> <span class="s">&quot;Apple Macmini&quot;</span><span class="p">,</span> <span class="p">{</span>
	  <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;Apple&quot;</span><span class="p">),</span>
	  <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Macmini&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">applesmc_dmi_match</span><span class="p">,</span> <span class="s">&quot;Apple MacPro&quot;</span><span class="p">,</span> <span class="p">{</span>
	  <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;Apple&quot;</span><span class="p">),</span>
	  <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;MacPro&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="n">applesmc_dmi_match</span><span class="p">,</span> <span class="s">&quot;Apple iMac&quot;</span><span class="p">,</span> <span class="p">{</span>
	  <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;Apple&quot;</span><span class="p">),</span>
	  <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;iMac&quot;</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">applesmc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmi_check_system</span><span class="p">(</span><span class="n">applesmc_whitelist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;supported laptop not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">APPLESMC_DATA_PORT</span><span class="p">,</span> <span class="n">APPLESMC_NR_PORTS</span><span class="p">,</span>
								<span class="s">&quot;applesmc&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">applesmc_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_region</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_register_simple</span><span class="p">(</span><span class="s">&quot;applesmc&quot;</span><span class="p">,</span> <span class="n">APPLESMC_DATA_PORT</span><span class="p">,</span>
					       <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_driver</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* create register cache */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_init_smcreg</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_device</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_create_nodes</span><span class="p">(</span><span class="n">info_group</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_smcreg</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_create_nodes</span><span class="p">(</span><span class="n">fan_group</span><span class="p">,</span> <span class="n">smcreg</span><span class="p">.</span><span class="n">fan_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_info</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_create_nodes</span><span class="p">(</span><span class="n">temp_group</span><span class="p">,</span> <span class="n">smcreg</span><span class="p">.</span><span class="n">temp_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_fans</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_create_accelerometer</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_temperature</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_create_light_sensor</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_accelerometer</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">applesmc_create_key_backlight</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_light_sysfs</span><span class="p">;</span>

	<span class="n">hwmon_dev</span> <span class="o">=</span> <span class="n">hwmon_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hwmon_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hwmon_dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_light_ledclass</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_light_ledclass:</span>
	<span class="n">applesmc_release_key_backlight</span><span class="p">();</span>
<span class="nl">out_light_sysfs:</span>
	<span class="n">applesmc_release_light_sensor</span><span class="p">();</span>
<span class="nl">out_accelerometer:</span>
	<span class="n">applesmc_release_accelerometer</span><span class="p">();</span>
<span class="nl">out_temperature:</span>
	<span class="n">applesmc_destroy_nodes</span><span class="p">(</span><span class="n">temp_group</span><span class="p">);</span>
<span class="nl">out_fans:</span>
	<span class="n">applesmc_destroy_nodes</span><span class="p">(</span><span class="n">fan_group</span><span class="p">);</span>
<span class="nl">out_info:</span>
	<span class="n">applesmc_destroy_nodes</span><span class="p">(</span><span class="n">info_group</span><span class="p">);</span>
<span class="nl">out_smcreg:</span>
	<span class="n">applesmc_destroy_smcreg</span><span class="p">();</span>
<span class="nl">out_device:</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">out_driver:</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">applesmc_driver</span><span class="p">);</span>
<span class="nl">out_region:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">APPLESMC_DATA_PORT</span><span class="p">,</span> <span class="n">APPLESMC_NR_PORTS</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;driver init failed (ret=%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">applesmc_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">hwmon_dev</span><span class="p">);</span>
	<span class="n">applesmc_release_key_backlight</span><span class="p">();</span>
	<span class="n">applesmc_release_light_sensor</span><span class="p">();</span>
	<span class="n">applesmc_release_accelerometer</span><span class="p">();</span>
	<span class="n">applesmc_destroy_nodes</span><span class="p">(</span><span class="n">temp_group</span><span class="p">);</span>
	<span class="n">applesmc_destroy_nodes</span><span class="p">(</span><span class="n">fan_group</span><span class="p">);</span>
	<span class="n">applesmc_destroy_nodes</span><span class="p">(</span><span class="n">info_group</span><span class="p">);</span>
	<span class="n">applesmc_destroy_smcreg</span><span class="p">();</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">applesmc_driver</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">APPLESMC_DATA_PORT</span><span class="p">,</span> <span class="n">APPLESMC_NR_PORTS</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">applesmc_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">applesmc_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Nicolas Boichat&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Apple SMC&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">dmi</span><span class="p">,</span> <span class="n">applesmc_whitelist</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
