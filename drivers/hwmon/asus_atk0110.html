<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › hwmon › asus_atk0110.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>asus_atk0110.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2007-2009 Luca Tettamanti &lt;kronos.it@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is released under the GPLv2</span>
<span class="cm"> * See COPYING in the top level directory of the kernel tree.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>

<span class="cp">#include &lt;acpi/acpi.h&gt;</span>
<span class="cp">#include &lt;acpi/acpixf.h&gt;</span>
<span class="cp">#include &lt;acpi/acpi_drivers.h&gt;</span>
<span class="cp">#include &lt;acpi/acpi_bus.h&gt;</span>


<span class="cp">#define ATK_HID &quot;ATK0110&quot;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">new_if</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">new_if</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">new_if</span><span class="p">,</span> <span class="s">&quot;Override detection heuristic and force the use of the new ATK0110 interface&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">__initconst</span> <span class="n">atk_force_new_if</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="cm">/* Old interface has broken MCH temp monitoring */</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Asus Sabertooth X58&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;SABERTOOTH X58&quot;</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Minimum time between readings, enforced in order to avoid</span>
<span class="cm"> * hogging the CPU.</span>
<span class="cm"> */</span>
<span class="cp">#define CACHE_TIME		HZ</span>

<span class="cp">#define BOARD_ID		&quot;MBIF&quot;</span>
<span class="cp">#define METHOD_ENUMERATE	&quot;GGRP&quot;</span>
<span class="cp">#define METHOD_READ		&quot;GITM&quot;</span>
<span class="cp">#define METHOD_WRITE		&quot;SITM&quot;</span>
<span class="cp">#define METHOD_OLD_READ_TMP	&quot;RTMP&quot;</span>
<span class="cp">#define METHOD_OLD_READ_VLT	&quot;RVLT&quot;</span>
<span class="cp">#define METHOD_OLD_READ_FAN	&quot;RFAN&quot;</span>
<span class="cp">#define METHOD_OLD_ENUM_TMP	&quot;TSIF&quot;</span>
<span class="cp">#define METHOD_OLD_ENUM_VLT	&quot;VSIF&quot;</span>
<span class="cp">#define METHOD_OLD_ENUM_FAN	&quot;FSIF&quot;</span>

<span class="cp">#define ATK_MUX_HWMON		0x00000006ULL</span>
<span class="cp">#define ATK_MUX_MGMT		0x00000011ULL</span>

<span class="cp">#define ATK_CLASS_MASK		0xff000000ULL</span>
<span class="cp">#define ATK_CLASS_FREQ_CTL	0x03000000ULL</span>
<span class="cp">#define ATK_CLASS_FAN_CTL	0x04000000ULL</span>
<span class="cp">#define ATK_CLASS_HWMON		0x06000000ULL</span>
<span class="cp">#define ATK_CLASS_MGMT		0x11000000ULL</span>

<span class="cp">#define ATK_TYPE_MASK		0x00ff0000ULL</span>
<span class="cp">#define HWMON_TYPE_VOLT		0x00020000ULL</span>
<span class="cp">#define HWMON_TYPE_TEMP		0x00030000ULL</span>
<span class="cp">#define HWMON_TYPE_FAN		0x00040000ULL</span>

<span class="cp">#define ATK_ELEMENT_ID_MASK	0x0000ffffULL</span>

<span class="cp">#define ATK_EC_ID		0x11060004ULL</span>

<span class="k">enum</span> <span class="n">atk_pack_member</span> <span class="p">{</span>
	<span class="n">HWMON_PACK_FLAGS</span><span class="p">,</span>
	<span class="n">HWMON_PACK_NAME</span><span class="p">,</span>
	<span class="n">HWMON_PACK_LIMIT1</span><span class="p">,</span>
	<span class="n">HWMON_PACK_LIMIT2</span><span class="p">,</span>
	<span class="n">HWMON_PACK_ENABLE</span>
<span class="p">};</span>

<span class="cm">/* New package format */</span>
<span class="cp">#define _HWMON_NEW_PACK_SIZE	7</span>
<span class="cp">#define _HWMON_NEW_PACK_FLAGS	0</span>
<span class="cp">#define _HWMON_NEW_PACK_NAME	1</span>
<span class="cp">#define _HWMON_NEW_PACK_UNK1	2</span>
<span class="cp">#define _HWMON_NEW_PACK_UNK2	3</span>
<span class="cp">#define _HWMON_NEW_PACK_LIMIT1	4</span>
<span class="cp">#define _HWMON_NEW_PACK_LIMIT2	5</span>
<span class="cp">#define _HWMON_NEW_PACK_ENABLE	6</span>

<span class="cm">/* Old package format */</span>
<span class="cp">#define _HWMON_OLD_PACK_SIZE	5</span>
<span class="cp">#define _HWMON_OLD_PACK_FLAGS	0</span>
<span class="cp">#define _HWMON_OLD_PACK_NAME	1</span>
<span class="cp">#define _HWMON_OLD_PACK_LIMIT1	2</span>
<span class="cp">#define _HWMON_OLD_PACK_LIMIT2	3</span>
<span class="cp">#define _HWMON_OLD_PACK_ENABLE	4</span>


<span class="k">struct</span> <span class="n">atk_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">hwmon_dev</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">atk_handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">acpi_dev</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">old_interface</span><span class="p">;</span>

	<span class="cm">/* old interface */</span>
	<span class="n">acpi_handle</span> <span class="n">rtmp_handle</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">rvlt_handle</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">rfan_handle</span><span class="p">;</span>
	<span class="cm">/* new inteface */</span>
	<span class="n">acpi_handle</span> <span class="n">enumerate_handle</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">read_handle</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">write_handle</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">disable_ec</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">voltage_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">temperature_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fan_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">sensor_list</span><span class="p">;</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">debugfs</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">typedef</span> <span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">sysfs_show_func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">acpi_device_id</span> <span class="n">atk_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">ATK_HID</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">acpi</span><span class="p">,</span> <span class="n">atk_ids</span><span class="p">);</span>

<span class="cp">#define ATTR_NAME_SIZE 16 </span><span class="cm">/* Worst case is &quot;tempN_input&quot; */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">atk_sensor_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">label_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">input_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">limit1_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">limit2_attr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">label_attr_name</span><span class="p">[</span><span class="n">ATTR_NAME_SIZE</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">input_attr_name</span><span class="p">[</span><span class="n">ATTR_NAME_SIZE</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">limit1_attr_name</span><span class="p">[</span><span class="n">ATTR_NAME_SIZE</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">limit2_attr_name</span><span class="p">[</span><span class="n">ATTR_NAME_SIZE</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">limit1</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">limit2</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">cached_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_updated</span><span class="p">;</span> <span class="cm">/* in jiffies */</span>
	<span class="n">bool</span> <span class="n">is_valid</span><span class="p">;</span>
	<span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">acpi_name</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Return buffer format:</span>
<span class="cm"> * [0-3] &quot;value&quot; is valid flag</span>
<span class="cm"> * [4-7] value</span>
<span class="cm"> * [8- ] unknown stuff on newer mobos</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">atk_acpi_ret_buffer</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[];</span>
<span class="p">};</span>

<span class="cm">/* Input buffer used for GITM and SITM methods */</span>
<span class="k">struct</span> <span class="n">atk_acpi_input_buf</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">param1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">param2</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">atk_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atk_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atk_print_sensor</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atk_read_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_sensor_data</span> <span class="o">*</span><span class="n">sensor</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atk_free_sensors</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">acpi_driver</span> <span class="n">atk_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">ATK_HID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">class</span>	<span class="o">=</span> <span class="s">&quot;hwmon&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ids</span>	<span class="o">=</span> <span class="n">atk_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">add</span>	<span class="o">=</span> <span class="n">atk_add</span><span class="p">,</span>
		<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">atk_remove</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define input_to_atk_sensor(attr) \</span>
<span class="cp">	container_of(attr, struct atk_sensor_data, input_attr)</span>

<span class="cp">#define label_to_atk_sensor(attr) \</span>
<span class="cp">	container_of(attr, struct atk_sensor_data, label_attr)</span>

<span class="cp">#define limit1_to_atk_sensor(attr) \</span>
<span class="cp">	container_of(attr, struct atk_sensor_data, limit1_attr)</span>

<span class="cp">#define limit2_to_atk_sensor(attr) \</span>
<span class="cp">	container_of(attr, struct atk_sensor_data, limit2_attr)</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atk_input_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atk_sensor_data</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">input_to_atk_sensor</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">atk_read_value</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">HWMON_TYPE_TEMP</span><span class="p">)</span>
		<span class="cm">/* ACPI returns decidegree */</span>
		<span class="n">value</span> <span class="o">*=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atk_label_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atk_sensor_data</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">label_to_atk_sensor</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">acpi_name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atk_limit1_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atk_sensor_data</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">limit1_to_atk_sensor</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">value</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">limit1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">HWMON_TYPE_TEMP</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">*=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atk_limit2_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atk_sensor_data</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">limit2_to_atk_sensor</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">value</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">limit2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">HWMON_TYPE_TEMP</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">*=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atk_name_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;atk0110</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">atk_name_attr</span> <span class="o">=</span>
		<span class="n">__ATTR</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">atk_name_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atk_init_attribute</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		<span class="n">sysfs_show_func</span> <span class="n">show</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysfs_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">);</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mo">0444</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">show</span> <span class="o">=</span> <span class="n">show</span><span class="p">;</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">store</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="nf">atk_get_pack_member</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
						<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">pack</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">atk_pack_member</span> <span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">old_if</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">old_interface</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HWMON_PACK_FLAGS</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">old_if</span> <span class="o">?</span> <span class="n">_HWMON_OLD_PACK_FLAGS</span> <span class="o">:</span> <span class="n">_HWMON_NEW_PACK_FLAGS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWMON_PACK_NAME</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">old_if</span> <span class="o">?</span> <span class="n">_HWMON_OLD_PACK_NAME</span> <span class="o">:</span> <span class="n">_HWMON_NEW_PACK_NAME</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWMON_PACK_LIMIT1</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">old_if</span> <span class="o">?</span> <span class="n">_HWMON_OLD_PACK_LIMIT1</span> <span class="o">:</span>
				  <span class="n">_HWMON_NEW_PACK_LIMIT1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWMON_PACK_LIMIT2</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">old_if</span> <span class="o">?</span> <span class="n">_HWMON_OLD_PACK_LIMIT2</span> <span class="o">:</span>
				  <span class="n">_HWMON_NEW_PACK_LIMIT2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWMON_PACK_ENABLE</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">old_if</span> <span class="o">?</span> <span class="n">_HWMON_OLD_PACK_ENABLE</span> <span class="o">:</span>
				  <span class="n">_HWMON_NEW_PACK_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">pack</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="n">offset</span><span class="p">];</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * New package format is:</span>
<span class="cm"> * - flag (int)</span>
<span class="cm"> *	class - used for de-muxing the request to the correct GITn</span>
<span class="cm"> *	type (volt, temp, fan)</span>
<span class="cm"> *	sensor id |</span>
<span class="cm"> *	sensor id - used for de-muxing the request _inside_ the GITn</span>
<span class="cm"> * - name (str)</span>
<span class="cm"> * - unknown (int)</span>
<span class="cm"> * - unknown (int)</span>
<span class="cm"> * - limit1 (int)</span>
<span class="cm"> * - limit2 (int)</span>
<span class="cm"> * - enable (int)</span>
<span class="cm"> *</span>
<span class="cm"> * The old package has the same format but it&#39;s missing the two unknown fields.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_hwmon_pack</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">old_if</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">old_interface</span><span class="p">;</span>
	<span class="kt">int</span> <span class="k">const</span> <span class="n">expected_size</span> <span class="o">=</span> <span class="n">old_if</span> <span class="o">?</span> <span class="n">_HWMON_OLD_PACK_SIZE</span> <span class="o">:</span>
					   <span class="n">_HWMON_NEW_PACK_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_PACKAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid type: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span> <span class="o">!=</span> <span class="n">expected_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid package size: %d, expected: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">obj</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="n">expected_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">atk_get_pack_member</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">HWMON_PACK_FLAGS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid type (flag): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">atk_get_pack_member</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">HWMON_PACK_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_STRING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid type (name): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Don&#39;t check... we don&#39;t know what they&#39;re useful for anyway */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	tmp = &amp;obj-&gt;package.elements[HWMON_PACK_UNK1];</span>
<span class="c">	if (tmp-&gt;type != ACPI_TYPE_INTEGER) {</span>
<span class="c">		dev_warn(dev, &quot;Invalid type (unk1): %d\n&quot;, tmp-&gt;type);</span>
<span class="c">		return -EINVAL;</span>
<span class="c">	}</span>

<span class="c">	tmp = &amp;obj-&gt;package.elements[HWMON_PACK_UNK2];</span>
<span class="c">	if (tmp-&gt;type != ACPI_TYPE_INTEGER) {</span>
<span class="c">		dev_warn(dev, &quot;Invalid type (unk2): %d\n&quot;, tmp-&gt;type);</span>
<span class="c">		return -EINVAL;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">atk_get_pack_member</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">HWMON_PACK_LIMIT1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid type (limit1): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">atk_get_pack_member</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">HWMON_PACK_LIMIT2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid type (limit2): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">atk_get_pack_member</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">HWMON_PACK_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid type (enable): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atk_print_sensor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="nf">atk_sensor_type</span><span class="p">(</span><span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">type</span> <span class="o">=</span> <span class="n">flags</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">ATK_TYPE_MASK</span><span class="p">;</span>
	<span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">what</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HWMON_TYPE_VOLT</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="s">&quot;voltage&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWMON_TYPE_TEMP</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="s">&quot;temperature&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWMON_TYPE_FAN</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="s">&quot;fan&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">what</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">what</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atk_print_sensor</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">flags</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">limit1</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">limit2</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">enable</span><span class="p">;</span>
	<span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">what</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">atk_get_pack_member</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">HWMON_PACK_FLAGS</span><span class="p">);</span>
	<span class="n">name</span> <span class="o">=</span> <span class="n">atk_get_pack_member</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">HWMON_PACK_NAME</span><span class="p">);</span>
	<span class="n">limit1</span> <span class="o">=</span> <span class="n">atk_get_pack_member</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">HWMON_PACK_LIMIT1</span><span class="p">);</span>
	<span class="n">limit2</span> <span class="o">=</span> <span class="n">atk_get_pack_member</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">HWMON_PACK_LIMIT2</span><span class="p">);</span>
	<span class="n">enable</span> <span class="o">=</span> <span class="n">atk_get_pack_member</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">HWMON_PACK_ENABLE</span><span class="p">);</span>

	<span class="n">what</span> <span class="o">=</span> <span class="n">atk_sensor_type</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %#llx %s [%llu-%llu] %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span>
			<span class="n">flags</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
			<span class="n">name</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span>
			<span class="n">limit1</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">limit2</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
			<span class="n">enable</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atk_read_value_old</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_sensor_data</span> <span class="o">*</span><span class="n">sensor</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_object_list</span> <span class="n">params</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">method</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HWMON_TYPE_VOLT</span>:
		<span class="n">method</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rvlt_handle</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWMON_TYPE_TEMP</span>:
		<span class="n">method</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rtmp_handle</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWMON_TYPE_FAN</span>:
		<span class="n">method</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rfan_handle</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">id</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">id</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">params</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_integer</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">AE_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: ACPI exception: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">acpi_format_exception</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="nf">atk_ggrp</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mux</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_object_list</span> <span class="n">params</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">pack</span><span class="p">;</span>

	<span class="n">id</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">id</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">mux</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">enumerate_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">AE_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GGRP[%#x] ACPI exception: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mux</span><span class="p">,</span>
				<span class="n">acpi_format_exception</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pack</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pack</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_PACKAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Execution was successful, but the id was not found */</span>
		<span class="n">ACPI_FREE</span><span class="p">(</span><span class="n">pack</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOENT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pack</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GGRP[%#x] package is too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mux</span><span class="p">);</span>
		<span class="n">ACPI_FREE</span><span class="p">(</span><span class="n">pack</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pack</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="nf">atk_gitm</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u64</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atk_acpi_input_buf</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_object_list</span> <span class="n">params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">.</span><span class="n">param2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tmp</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_TYPE_BUFFER</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">params</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">ret</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object_typed</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">read_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span> <span class="n">ACPI_TYPE_BUFFER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">AE_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GITM[%#llx] ACPI exception: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span>
				<span class="n">acpi_format_exception</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">ret</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>

	<span class="cm">/* Sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unexpected ASBF length: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">ACPI_FREE</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">obj</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="nf">atk_sitm</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">atk_acpi_input_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_object_list</span> <span class="n">params</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">tmp</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_TYPE_BUFFER</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">params</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">ret</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object_typed</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">write_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span> <span class="n">ACPI_TYPE_BUFFER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">AE_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SITM[%#x] ACPI exception: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
				<span class="n">acpi_format_exception</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">ret</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>

	<span class="cm">/* Sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unexpected ASBF length: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">ACPI_FREE</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">obj</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atk_read_value_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_sensor_data</span> <span class="o">*</span><span class="n">sensor</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atk_acpi_ret_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">atk_gitm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atk_acpi_ret_buffer</span> <span class="o">*</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The reading is not valid, possible causes:</span>
<span class="cm">		 * - sensor failure</span>
<span class="cm">		 * - enumeration was FUBAR (and we didn&#39;t notice)</span>
<span class="cm">		 */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Read failed, sensor = %#llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">ACPI_FREE</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atk_read_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_sensor_data</span> <span class="o">*</span><span class="n">sensor</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">is_valid</span> <span class="o">||</span>
	    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">last_updated</span> <span class="o">+</span> <span class="n">CACHE_TIME</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">old_interface</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">atk_read_value_old</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">atk_read_value_new</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">is_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">last_updated</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">cached_value</span> <span class="o">=</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">cached_value</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atk_debugfs_gitm_get</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atk_acpi_ret_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">read_handle</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">atk_gitm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atk_acpi_ret_buffer</span> <span class="o">*</span><span class="p">)</span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">ACPI_FREE</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DEFINE_SIMPLE_ATTRIBUTE</span><span class="p">(</span><span class="n">atk_debugfs_gitm</span><span class="p">,</span>
			<span class="n">atk_debugfs_gitm_get</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span>
			<span class="s">&quot;0x%08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">atk_acpi_print</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">sz</span><span class="p">,</span> <span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACPI_TYPE_INTEGER</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="s">&quot;0x%08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_TYPE_STRING</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">atk_pack_print</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">sz</span><span class="p">,</span> <span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">pack</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pack</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pack</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">atk_acpi_print</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="n">sz</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">sz</span> <span class="o">-=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">atk_debugfs_ggrp_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cls</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">enumerate_handle</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cls</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">atk_ggrp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cls</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">pack</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pack</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_PACKAGE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pack</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">id</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pack</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Print the package */</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ACPI_FREE</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">atk_pack_print</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">pack</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ACPI_FREE</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">atk_debugfs_ggrp_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">atk_debugfs_ggrp_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">atk_debugfs_ggrp_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">atk_debugfs_ggrp_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">atk_debugfs_ggrp_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">atk_debugfs_ggrp_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atk_debugfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;asus_atk0110&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="n">debugfs_create_x32</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;gitm&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">atk_debugfs_gitm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;ggrp&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">atk_debugfs_ggrp_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="nl">cleanup:</span>
	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atk_debugfs_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">.</span><span class="n">root</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_DEBUG_FS */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atk_debugfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atk_debugfs_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atk_add_sensor</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">flags</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">limit1</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">limit2</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">enable</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atk_sensor_data</span> <span class="o">*</span><span class="n">sensor</span><span class="p">;</span>
	<span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">base_name</span><span class="p">;</span>
	<span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">limit1_name</span><span class="p">;</span>
	<span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">limit2_name</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_PACKAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wft is this? */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown type for ACPI object: (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">validate_hwmon_pack</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Ok, we have a valid hwmon package */</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">atk_get_pack_member</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">HWMON_PACK_FLAGS</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span>
	       <span class="o">&amp;</span> <span class="n">ATK_TYPE_MASK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HWMON_TYPE_VOLT</span>:
		<span class="n">base_name</span> <span class="o">=</span> <span class="s">&quot;in&quot;</span><span class="p">;</span>
		<span class="n">limit1_name</span> <span class="o">=</span> <span class="s">&quot;min&quot;</span><span class="p">;</span>
		<span class="n">limit2_name</span> <span class="o">=</span> <span class="s">&quot;max&quot;</span><span class="p">;</span>
		<span class="n">num</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">voltage_count</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWMON_TYPE_TEMP</span>:
		<span class="n">base_name</span> <span class="o">=</span> <span class="s">&quot;temp&quot;</span><span class="p">;</span>
		<span class="n">limit1_name</span> <span class="o">=</span> <span class="s">&quot;max&quot;</span><span class="p">;</span>
		<span class="n">limit2_name</span> <span class="o">=</span> <span class="s">&quot;crit&quot;</span><span class="p">;</span>
		<span class="n">num</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temperature_count</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWMON_TYPE_FAN</span>:
		<span class="n">base_name</span> <span class="o">=</span> <span class="s">&quot;fan&quot;</span><span class="p">;</span>
		<span class="n">limit1_name</span> <span class="o">=</span> <span class="s">&quot;min&quot;</span><span class="p">;</span>
		<span class="n">limit2_name</span> <span class="o">=</span> <span class="s">&quot;max&quot;</span><span class="p">;</span>
		<span class="n">num</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_count</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown sensor type: %#llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">enable</span> <span class="o">=</span> <span class="n">atk_get_pack_member</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">HWMON_PACK_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
		<span class="cm">/* sensor is disabled */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">atk_get_pack_member</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">HWMON_PACK_FLAGS</span><span class="p">);</span>
	<span class="n">name</span> <span class="o">=</span> <span class="n">atk_get_pack_member</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">HWMON_PACK_NAME</span><span class="p">);</span>
	<span class="n">limit1</span> <span class="o">=</span> <span class="n">atk_get_pack_member</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">HWMON_PACK_LIMIT1</span><span class="p">);</span>
	<span class="n">limit2</span> <span class="o">=</span> <span class="n">atk_get_pack_member</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">HWMON_PACK_LIMIT2</span><span class="p">);</span>

	<span class="n">sensor</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sensor</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">acpi_name</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">acpi_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">flags</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limit1</span> <span class="o">=</span> <span class="n">limit1</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">old_interface</span><span class="p">)</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limit2</span> <span class="o">=</span> <span class="n">limit2</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* The upper limit is expressed as delta from lower limit */</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limit2</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limit1</span> <span class="o">+</span> <span class="n">limit2</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">input_attr_name</span><span class="p">,</span> <span class="n">ATTR_NAME_SIZE</span><span class="p">,</span>
			<span class="s">&quot;%s%d_input&quot;</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="o">*</span><span class="n">num</span><span class="p">);</span>
	<span class="n">atk_init_attribute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">input_attr</span><span class="p">,</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">input_attr_name</span><span class="p">,</span>
			<span class="n">atk_input_show</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">label_attr_name</span><span class="p">,</span> <span class="n">ATTR_NAME_SIZE</span><span class="p">,</span>
			<span class="s">&quot;%s%d_label&quot;</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="o">*</span><span class="n">num</span><span class="p">);</span>
	<span class="n">atk_init_attribute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">label_attr</span><span class="p">,</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">label_attr_name</span><span class="p">,</span>
			<span class="n">atk_label_show</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limit1_attr_name</span><span class="p">,</span> <span class="n">ATTR_NAME_SIZE</span><span class="p">,</span>
			<span class="s">&quot;%s%d_%s&quot;</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="o">*</span><span class="n">num</span><span class="p">,</span> <span class="n">limit1_name</span><span class="p">);</span>
	<span class="n">atk_init_attribute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limit1_attr</span><span class="p">,</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limit1_attr_name</span><span class="p">,</span>
			<span class="n">atk_limit1_show</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limit2_attr_name</span><span class="p">,</span> <span class="n">ATTR_NAME_SIZE</span><span class="p">,</span>
			<span class="s">&quot;%s%d_%s&quot;</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="o">*</span><span class="n">num</span><span class="p">,</span> <span class="n">limit2_name</span><span class="p">);</span>
	<span class="n">atk_init_attribute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limit2_attr</span><span class="p">,</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limit2_attr_name</span><span class="p">,</span>
			<span class="n">atk_limit2_show</span><span class="p">);</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sensor_list</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">num</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">acpi_name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atk_enumerate_old_hwmon</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">pack</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Voltages */</span>
	<span class="n">buf</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object_typed</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">atk_handle</span><span class="p">,</span>
			<span class="n">METHOD_OLD_ENUM_VLT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">ACPI_TYPE_PACKAGE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">AE_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">METHOD_OLD_ENUM_VLT</span> <span class="s">&quot;: ACPI exception: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">acpi_format_exception</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pack</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pack</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pack</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">atk_add_sensor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ACPI_FREE</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>

	<span class="cm">/* Temperatures */</span>
	<span class="n">buf</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object_typed</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">atk_handle</span><span class="p">,</span>
			<span class="n">METHOD_OLD_ENUM_TMP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">ACPI_TYPE_PACKAGE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">AE_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">METHOD_OLD_ENUM_TMP</span> <span class="s">&quot;: ACPI exception: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">acpi_format_exception</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pack</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pack</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pack</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">atk_add_sensor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ACPI_FREE</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>

	<span class="cm">/* Fans */</span>
	<span class="n">buf</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object_typed</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">atk_handle</span><span class="p">,</span>
			<span class="n">METHOD_OLD_ENUM_FAN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">ACPI_TYPE_PACKAGE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">AE_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">METHOD_OLD_ENUM_FAN</span> <span class="s">&quot;: ACPI exception: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">acpi_format_exception</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pack</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pack</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pack</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">atk_add_sensor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ACPI_FREE</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="nl">cleanup:</span>
	<span class="n">atk_free_sensors</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atk_ec_present</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">pack</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">ec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pack</span> <span class="o">=</span> <span class="n">atk_ggrp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ATK_MUX_MGMT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pack</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pack</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The MGMT class does not exists - that&#39;s ok */</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Class %#llx not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ATK_MUX_MGMT</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pack</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Search the EC */</span>
	<span class="n">ec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pack</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pack</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_PACKAGE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">id</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">ATK_EC_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ec</span> <span class="o">=</span> <span class="n">obj</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">ec</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="cm">/* The system has no EC */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;EC not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ACPI_FREE</span><span class="p">(</span><span class="n">pack</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atk_ec_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atk_acpi_ret_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">atk_gitm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ATK_EC_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to query EC status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atk_acpi_ret_buffer</span> <span class="o">*</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to query EC status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;EC is %sabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">err</span> <span class="o">?</span> <span class="s">&quot;en&quot;</span> <span class="o">:</span> <span class="s">&quot;dis&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ACPI_FREE</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atk_ec_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atk_acpi_input_buf</span> <span class="n">sitm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atk_acpi_ret_buffer</span> <span class="o">*</span><span class="n">ec_ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sitm</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">ATK_EC_ID</span><span class="p">;</span>
	<span class="n">sitm</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="n">sitm</span><span class="p">.</span><span class="n">param2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">atk_sitm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sitm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to %sable the EC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">enable</span> <span class="o">?</span> <span class="s">&quot;en&quot;</span> <span class="o">:</span> <span class="s">&quot;dis&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ec_ret</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atk_acpi_ret_buffer</span> <span class="o">*</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ec_ret</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to %sable the EC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">enable</span> <span class="o">?</span> <span class="s">&quot;en&quot;</span> <span class="o">:</span> <span class="s">&quot;dis&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;EC %sabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">enable</span> <span class="o">?</span> <span class="s">&quot;en&quot;</span> <span class="o">:</span> <span class="s">&quot;dis&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ACPI_FREE</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atk_enumerate_new_hwmon</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">pack</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">atk_ec_present</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">atk_ec_enabled</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="cm">/* If the EC was disabled we will disable it again on unload */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">disable_ec</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">atk_ec_ctl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">disable_ec</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Enumerating hwmon sensors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pack</span> <span class="o">=</span> <span class="n">atk_ggrp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ATK_MUX_HWMON</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pack</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pack</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pack</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pack</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">atk_add_sensor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">voltage_count</span> <span class="o">+</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">temperature_count</span> <span class="o">+</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_count</span><span class="p">;</span>

	<span class="n">ACPI_FREE</span><span class="p">(</span><span class="n">pack</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atk_create_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atk_sensor_data</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sensor_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">input_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">label_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">limit1_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">limit2_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atk_name_attr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atk_remove_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atk_sensor_data</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sensor_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">input_attr</span><span class="p">);</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">label_attr</span><span class="p">);</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">limit1_attr</span><span class="p">);</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">limit2_attr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atk_name_attr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atk_free_sensors</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sensor_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atk_sensor_data</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">acpi_name</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atk_register_hwmon</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;registering hwmon device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span> <span class="o">=</span> <span class="n">hwmon_device_register</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;populating sysfs directory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">atk_create_files</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">remove</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">remove:</span>
	<span class="cm">/* Cleanup the registered files */</span>
	<span class="n">atk_remove_files</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atk_probe_if</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* RTMP: read temperature */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">atk_handle</span><span class="p">,</span> <span class="n">METHOD_OLD_READ_TMP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rtmp_handle</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;method &quot;</span> <span class="n">METHOD_OLD_READ_TMP</span> <span class="s">&quot; not found: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">acpi_format_exception</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>

	<span class="cm">/* RVLT: read voltage */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">atk_handle</span><span class="p">,</span> <span class="n">METHOD_OLD_READ_VLT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rvlt_handle</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;method &quot;</span> <span class="n">METHOD_OLD_READ_VLT</span> <span class="s">&quot; not found: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">acpi_format_exception</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>

	<span class="cm">/* RFAN: read fan status */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">atk_handle</span><span class="p">,</span> <span class="n">METHOD_OLD_READ_FAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rfan_handle</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;method &quot;</span> <span class="n">METHOD_OLD_READ_FAN</span> <span class="s">&quot; not found: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">acpi_format_exception</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>

	<span class="cm">/* Enumeration */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">atk_handle</span><span class="p">,</span> <span class="n">METHOD_ENUMERATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">enumerate_handle</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;method &quot;</span> <span class="n">METHOD_ENUMERATE</span> <span class="s">&quot; not found: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">acpi_format_exception</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>

	<span class="cm">/* De-multiplexer (read) */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">atk_handle</span><span class="p">,</span> <span class="n">METHOD_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">read_handle</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;method &quot;</span> <span class="n">METHOD_READ</span> <span class="s">&quot; not found: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">acpi_format_exception</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>

	<span class="cm">/* De-multiplexer (write) */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">atk_handle</span><span class="p">,</span> <span class="n">METHOD_WRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">write_handle</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;method &quot;</span> <span class="n">METHOD_WRITE</span> <span class="s">&quot; not found: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">acpi_format_exception</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for hwmon methods: first check &quot;old&quot; style methods; note that</span>
<span class="cm">	 * both may be present: in this case we stick to the old interface;</span>
<span class="cm">	 * analysis of multiple DSDTs indicates that when both interfaces</span>
<span class="cm">	 * are present the new one (GGRP/GITM) is not functional.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_if</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Overriding interface detection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rtmp_handle</span> <span class="o">&amp;&amp;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">rvlt_handle</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rfan_handle</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">new_if</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">old_interface</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">enumerate_handle</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">read_handle</span> <span class="o">&amp;&amp;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">write_handle</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">old_interface</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atk_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;adding...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">acpi_dev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">atk_handle</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sensor_list</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">disable_ec</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">acpi_evaluate_object_typed</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">atk_handle</span><span class="p">,</span> <span class="n">BOARD_ID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">ACPI_TYPE_PACKAGE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">AE_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;atk: method MBIF not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">obj</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACPI_TYPE_STRING</span><span class="p">)</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;board ID = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">id</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ACPI_FREE</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">atk_probe_if</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No usable hwmon interface detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">old_interface</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Using old hwmon interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">atk_enumerate_old_hwmon</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Using new hwmon interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">atk_enumerate_new_hwmon</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;No usable sensor detected, bailing out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">atk_register_hwmon</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="n">atk_debugfs_init</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">cleanup:</span>
	<span class="n">atk_free_sensors</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">disable_ec</span><span class="p">)</span>
		<span class="n">atk_ec_ctl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atk_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atk_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;removing...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">atk_debugfs_cleanup</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="n">atk_remove_files</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">atk_free_sensors</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">disable_ec</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atk_ec_ctl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to disable EC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">atk0110_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Make sure it&#39;s safe to access the device through ACPI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_resources_are_enforced</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Resources not safely usable due to acpi_enforce_resources kernel parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmi_check_system</span><span class="p">(</span><span class="n">atk_force_new_if</span><span class="p">))</span>
		<span class="n">new_if</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">acpi_bus_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atk_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;acpi_bus_register_driver failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">atk0110_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_bus_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atk_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">atk0110_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">atk0110_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
