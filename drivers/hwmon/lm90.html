<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › hwmon › lm90.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>lm90.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * lm90.c - Part of lm_sensors, Linux kernel modules for hardware</span>
<span class="cm"> *          monitoring</span>
<span class="cm"> * Copyright (C) 2003-2010  Jean Delvare &lt;khali@linux-fr.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on the lm83 driver. The LM90 is a sensor chip made by National</span>
<span class="cm"> * Semiconductor. It reports up to two temperatures (its own plus up to</span>
<span class="cm"> * one external one) with a 0.125 deg resolution (1 deg for local</span>
<span class="cm"> * temperature) and a 3-4 deg accuracy.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver also supports the LM89 and LM99, two other sensor chips</span>
<span class="cm"> * made by National Semiconductor. Both have an increased remote</span>
<span class="cm"> * temperature measurement accuracy (1 degree), and the LM99</span>
<span class="cm"> * additionally shifts remote temperatures (measured and limits) by 16</span>
<span class="cm"> * degrees, which allows for higher temperatures measurement.</span>
<span class="cm"> * Note that there is no way to differentiate between both chips.</span>
<span class="cm"> * When device is auto-detected, the driver will assume an LM99.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver also supports the LM86, another sensor chip made by</span>
<span class="cm"> * National Semiconductor. It is exactly similar to the LM90 except it</span>
<span class="cm"> * has a higher accuracy.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver also supports the ADM1032, a sensor chip made by Analog</span>
<span class="cm"> * Devices. That chip is similar to the LM90, with a few differences</span>
<span class="cm"> * that are not handled by this driver. Among others, it has a higher</span>
<span class="cm"> * accuracy than the LM90, much like the LM86 does.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver also supports the MAX6657, MAX6658 and MAX6659 sensor</span>
<span class="cm"> * chips made by Maxim. These chips are similar to the LM86.</span>
<span class="cm"> * Note that there is no easy way to differentiate between the three</span>
<span class="cm"> * variants. We use the device address to detect MAX6659, which will result</span>
<span class="cm"> * in a detection as max6657 if it is on address 0x4c. The extra address</span>
<span class="cm"> * and features of the MAX6659 are only supported if the chip is configured</span>
<span class="cm"> * explicitly as max6659, or if its address is not 0x4c.</span>
<span class="cm"> * These chips lack the remote temperature offset feature.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver also supports the MAX6646, MAX6647, MAX6648, MAX6649 and</span>
<span class="cm"> * MAX6692 chips made by Maxim.  These are again similar to the LM86,</span>
<span class="cm"> * but they use unsigned temperature values and can report temperatures</span>
<span class="cm"> * from 0 to 145 degrees.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver also supports the MAX6680 and MAX6681, two other sensor</span>
<span class="cm"> * chips made by Maxim. These are quite similar to the other Maxim</span>
<span class="cm"> * chips. The MAX6680 and MAX6681 only differ in the pinout so they can</span>
<span class="cm"> * be treated identically.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver also supports the MAX6695 and MAX6696, two other sensor</span>
<span class="cm"> * chips made by Maxim. These are also quite similar to other Maxim</span>
<span class="cm"> * chips, but support three temperature sensors instead of two. MAX6695</span>
<span class="cm"> * and MAX6696 only differ in the pinout so they can be treated identically.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver also supports ADT7461 and ADT7461A from Analog Devices as well as</span>
<span class="cm"> * NCT1008 from ON Semiconductor. The chips are supported in both compatibility</span>
<span class="cm"> * and extended mode. They are mostly compatible with LM90 except for a data</span>
<span class="cm"> * format difference for the temperature value registers.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver also supports the SA56004 from Philips. This device is</span>
<span class="cm"> * pin-compatible with the LM86, the ED/EDP parts are also address-compatible.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver also supports the G781 from GMT. This device is compatible</span>
<span class="cm"> * with the ADM1032.</span>
<span class="cm"> *</span>
<span class="cm"> * Since the LM90 was the first chipset supported by this driver, most</span>
<span class="cm"> * comments will refer to this chipset, but are actually general and</span>
<span class="cm"> * concern all supported chipsets, unless mentioned otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon-sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/sysfs.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Addresses to scan</span>
<span class="cm"> * Address is fully defined internally and cannot be changed except for</span>
<span class="cm"> * MAX6659, MAX6680 and MAX6681.</span>
<span class="cm"> * LM86, LM89, LM90, LM99, ADM1032, ADM1032-1, ADT7461, ADT7461A, MAX6649,</span>
<span class="cm"> * MAX6657, MAX6658, NCT1008 and W83L771 have address 0x4c.</span>
<span class="cm"> * ADM1032-2, ADT7461-2, ADT7461A-2, LM89-1, LM99-1, MAX6646, and NCT1008D</span>
<span class="cm"> * have address 0x4d.</span>
<span class="cm"> * MAX6647 has address 0x4e.</span>
<span class="cm"> * MAX6659 can have address 0x4c, 0x4d or 0x4e.</span>
<span class="cm"> * MAX6680 and MAX6681 can have address 0x18, 0x19, 0x1a, 0x29, 0x2a, 0x2b,</span>
<span class="cm"> * 0x4c, 0x4d or 0x4e.</span>
<span class="cm"> * SA56004 can have address 0x48 through 0x4F.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">normal_i2c</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span>
	<span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="n">I2C_CLIENT_END</span> <span class="p">};</span>

<span class="k">enum</span> <span class="n">chips</span> <span class="p">{</span> <span class="n">lm90</span><span class="p">,</span> <span class="n">adm1032</span><span class="p">,</span> <span class="n">lm99</span><span class="p">,</span> <span class="n">lm86</span><span class="p">,</span> <span class="n">max6657</span><span class="p">,</span> <span class="n">max6659</span><span class="p">,</span> <span class="n">adt7461</span><span class="p">,</span> <span class="n">max6680</span><span class="p">,</span>
	<span class="n">max6646</span><span class="p">,</span> <span class="n">w83l771</span><span class="p">,</span> <span class="n">max6696</span><span class="p">,</span> <span class="n">sa56004</span><span class="p">,</span> <span class="n">g781</span> <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The LM90 registers</span>
<span class="cm"> */</span>

<span class="cp">#define LM90_REG_R_MAN_ID		0xFE</span>
<span class="cp">#define LM90_REG_R_CHIP_ID		0xFF</span>
<span class="cp">#define LM90_REG_R_CONFIG1		0x03</span>
<span class="cp">#define LM90_REG_W_CONFIG1		0x09</span>
<span class="cp">#define LM90_REG_R_CONFIG2		0xBF</span>
<span class="cp">#define LM90_REG_W_CONFIG2		0xBF</span>
<span class="cp">#define LM90_REG_R_CONVRATE		0x04</span>
<span class="cp">#define LM90_REG_W_CONVRATE		0x0A</span>
<span class="cp">#define LM90_REG_R_STATUS		0x02</span>
<span class="cp">#define LM90_REG_R_LOCAL_TEMP		0x00</span>
<span class="cp">#define LM90_REG_R_LOCAL_HIGH		0x05</span>
<span class="cp">#define LM90_REG_W_LOCAL_HIGH		0x0B</span>
<span class="cp">#define LM90_REG_R_LOCAL_LOW		0x06</span>
<span class="cp">#define LM90_REG_W_LOCAL_LOW		0x0C</span>
<span class="cp">#define LM90_REG_R_LOCAL_CRIT		0x20</span>
<span class="cp">#define LM90_REG_W_LOCAL_CRIT		0x20</span>
<span class="cp">#define LM90_REG_R_REMOTE_TEMPH		0x01</span>
<span class="cp">#define LM90_REG_R_REMOTE_TEMPL		0x10</span>
<span class="cp">#define LM90_REG_R_REMOTE_OFFSH		0x11</span>
<span class="cp">#define LM90_REG_W_REMOTE_OFFSH		0x11</span>
<span class="cp">#define LM90_REG_R_REMOTE_OFFSL		0x12</span>
<span class="cp">#define LM90_REG_W_REMOTE_OFFSL		0x12</span>
<span class="cp">#define LM90_REG_R_REMOTE_HIGHH		0x07</span>
<span class="cp">#define LM90_REG_W_REMOTE_HIGHH		0x0D</span>
<span class="cp">#define LM90_REG_R_REMOTE_HIGHL		0x13</span>
<span class="cp">#define LM90_REG_W_REMOTE_HIGHL		0x13</span>
<span class="cp">#define LM90_REG_R_REMOTE_LOWH		0x08</span>
<span class="cp">#define LM90_REG_W_REMOTE_LOWH		0x0E</span>
<span class="cp">#define LM90_REG_R_REMOTE_LOWL		0x14</span>
<span class="cp">#define LM90_REG_W_REMOTE_LOWL		0x14</span>
<span class="cp">#define LM90_REG_R_REMOTE_CRIT		0x19</span>
<span class="cp">#define LM90_REG_W_REMOTE_CRIT		0x19</span>
<span class="cp">#define LM90_REG_R_TCRIT_HYST		0x21</span>
<span class="cp">#define LM90_REG_W_TCRIT_HYST		0x21</span>

<span class="cm">/* MAX6646/6647/6649/6657/6658/6659/6695/6696 registers */</span>

<span class="cp">#define MAX6657_REG_R_LOCAL_TEMPL	0x11</span>
<span class="cp">#define MAX6696_REG_R_STATUS2		0x12</span>
<span class="cp">#define MAX6659_REG_R_REMOTE_EMERG	0x16</span>
<span class="cp">#define MAX6659_REG_W_REMOTE_EMERG	0x16</span>
<span class="cp">#define MAX6659_REG_R_LOCAL_EMERG	0x17</span>
<span class="cp">#define MAX6659_REG_W_LOCAL_EMERG	0x17</span>

<span class="cm">/*  SA56004 registers */</span>

<span class="cp">#define SA56004_REG_R_LOCAL_TEMPL 0x22</span>

<span class="cp">#define LM90_DEF_CONVRATE_RVAL	6	</span><span class="cm">/* Def conversion rate register value */</span><span class="cp"></span>
<span class="cp">#define LM90_MAX_CONVRATE_MS	16000	</span><span class="cm">/* Maximum conversion rate in ms */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Device flags</span>
<span class="cm"> */</span>
<span class="cp">#define LM90_FLAG_ADT7461_EXT	(1 &lt;&lt; 0) </span><span class="cm">/* ADT7461 extended mode	*/</span><span class="cp"></span>
<span class="cm">/* Device features */</span>
<span class="cp">#define LM90_HAVE_OFFSET	(1 &lt;&lt; 1) </span><span class="cm">/* temperature offset register	*/</span><span class="cp"></span>
<span class="cp">#define LM90_HAVE_REM_LIMIT_EXT	(1 &lt;&lt; 3) </span><span class="cm">/* extended remote limit	*/</span><span class="cp"></span>
<span class="cp">#define LM90_HAVE_EMERGENCY	(1 &lt;&lt; 4) </span><span class="cm">/* 3rd upper (emergency) limit	*/</span><span class="cp"></span>
<span class="cp">#define LM90_HAVE_EMERGENCY_ALARM (1 &lt;&lt; 5)</span><span class="cm">/* emergency alarm		*/</span><span class="cp"></span>
<span class="cp">#define LM90_HAVE_TEMP3		(1 &lt;&lt; 6) </span><span class="cm">/* 3rd temperature sensor	*/</span><span class="cp"></span>
<span class="cp">#define LM90_HAVE_BROKEN_ALERT	(1 &lt;&lt; 7) </span><span class="cm">/* Broken alert		*/</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Driver data (common to all clients)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">lm90_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;adm1032&quot;</span><span class="p">,</span> <span class="n">adm1032</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;adt7461&quot;</span><span class="p">,</span> <span class="n">adt7461</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;adt7461a&quot;</span><span class="p">,</span> <span class="n">adt7461</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;g781&quot;</span><span class="p">,</span> <span class="n">g781</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;lm90&quot;</span><span class="p">,</span> <span class="n">lm90</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;lm86&quot;</span><span class="p">,</span> <span class="n">lm86</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;lm89&quot;</span><span class="p">,</span> <span class="n">lm86</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;lm99&quot;</span><span class="p">,</span> <span class="n">lm99</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max6646&quot;</span><span class="p">,</span> <span class="n">max6646</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max6647&quot;</span><span class="p">,</span> <span class="n">max6646</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max6649&quot;</span><span class="p">,</span> <span class="n">max6646</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max6657&quot;</span><span class="p">,</span> <span class="n">max6657</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max6658&quot;</span><span class="p">,</span> <span class="n">max6657</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max6659&quot;</span><span class="p">,</span> <span class="n">max6659</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max6680&quot;</span><span class="p">,</span> <span class="n">max6680</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max6681&quot;</span><span class="p">,</span> <span class="n">max6680</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max6695&quot;</span><span class="p">,</span> <span class="n">max6696</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max6696&quot;</span><span class="p">,</span> <span class="n">max6696</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;nct1008&quot;</span><span class="p">,</span> <span class="n">adt7461</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;w83l771&quot;</span><span class="p">,</span> <span class="n">w83l771</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;sa56004&quot;</span><span class="p">,</span> <span class="n">sa56004</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">lm90_id</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * chip type specific parameters</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">lm90_params</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>		<span class="cm">/* Capabilities */</span>
	<span class="n">u16</span> <span class="n">alert_alarms</span><span class="p">;</span>	<span class="cm">/* Which alarm bits trigger ALERT# */</span>
				<span class="cm">/* Upper 8 bits for max6695/96 */</span>
	<span class="n">u8</span> <span class="n">max_convrate</span><span class="p">;</span>	<span class="cm">/* Maximum conversion rate register value */</span>
	<span class="n">u8</span> <span class="n">reg_local_ext</span><span class="p">;</span>	<span class="cm">/* Extended local temp register (optional) */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">lm90_params</span> <span class="n">lm90_params</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">adm1032</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">LM90_HAVE_OFFSET</span> <span class="o">|</span> <span class="n">LM90_HAVE_REM_LIMIT_EXT</span>
		  <span class="o">|</span> <span class="n">LM90_HAVE_BROKEN_ALERT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alert_alarms</span> <span class="o">=</span> <span class="mh">0x7c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_convrate</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">adt7461</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">LM90_HAVE_OFFSET</span> <span class="o">|</span> <span class="n">LM90_HAVE_REM_LIMIT_EXT</span>
		  <span class="o">|</span> <span class="n">LM90_HAVE_BROKEN_ALERT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alert_alarms</span> <span class="o">=</span> <span class="mh">0x7c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_convrate</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">g781</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">LM90_HAVE_OFFSET</span> <span class="o">|</span> <span class="n">LM90_HAVE_REM_LIMIT_EXT</span>
		  <span class="o">|</span> <span class="n">LM90_HAVE_BROKEN_ALERT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alert_alarms</span> <span class="o">=</span> <span class="mh">0x7c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_convrate</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">lm86</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">LM90_HAVE_OFFSET</span> <span class="o">|</span> <span class="n">LM90_HAVE_REM_LIMIT_EXT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alert_alarms</span> <span class="o">=</span> <span class="mh">0x7b</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_convrate</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">lm90</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">LM90_HAVE_OFFSET</span> <span class="o">|</span> <span class="n">LM90_HAVE_REM_LIMIT_EXT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alert_alarms</span> <span class="o">=</span> <span class="mh">0x7b</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_convrate</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">lm99</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">LM90_HAVE_OFFSET</span> <span class="o">|</span> <span class="n">LM90_HAVE_REM_LIMIT_EXT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alert_alarms</span> <span class="o">=</span> <span class="mh">0x7b</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_convrate</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">max6646</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">alert_alarms</span> <span class="o">=</span> <span class="mh">0x7c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_convrate</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_local_ext</span> <span class="o">=</span> <span class="n">MAX6657_REG_R_LOCAL_TEMPL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">max6657</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">alert_alarms</span> <span class="o">=</span> <span class="mh">0x7c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_convrate</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_local_ext</span> <span class="o">=</span> <span class="n">MAX6657_REG_R_LOCAL_TEMPL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">max6659</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">LM90_HAVE_EMERGENCY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alert_alarms</span> <span class="o">=</span> <span class="mh">0x7c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_convrate</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_local_ext</span> <span class="o">=</span> <span class="n">MAX6657_REG_R_LOCAL_TEMPL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">max6680</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">LM90_HAVE_OFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alert_alarms</span> <span class="o">=</span> <span class="mh">0x7c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_convrate</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">max6696</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">LM90_HAVE_EMERGENCY</span>
		  <span class="o">|</span> <span class="n">LM90_HAVE_EMERGENCY_ALARM</span> <span class="o">|</span> <span class="n">LM90_HAVE_TEMP3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alert_alarms</span> <span class="o">=</span> <span class="mh">0x187c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_convrate</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_local_ext</span> <span class="o">=</span> <span class="n">MAX6657_REG_R_LOCAL_TEMPL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">w83l771</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">LM90_HAVE_OFFSET</span> <span class="o">|</span> <span class="n">LM90_HAVE_REM_LIMIT_EXT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alert_alarms</span> <span class="o">=</span> <span class="mh">0x7c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_convrate</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">sa56004</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">LM90_HAVE_OFFSET</span> <span class="o">|</span> <span class="n">LM90_HAVE_REM_LIMIT_EXT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alert_alarms</span> <span class="o">=</span> <span class="mh">0x7b</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_convrate</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg_local_ext</span> <span class="o">=</span> <span class="n">SA56004_REG_R_LOCAL_TEMPL</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Client data (each client gets its own)</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">lm90_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">hwmon_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">update_lock</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">valid</span><span class="p">;</span> <span class="cm">/* zero until following fields are valid */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_updated</span><span class="p">;</span> <span class="cm">/* in jiffies */</span>
	<span class="kt">int</span> <span class="n">kind</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">update_interval</span><span class="p">;</span>	<span class="cm">/* in milliseconds */</span>

	<span class="n">u8</span> <span class="n">config_orig</span><span class="p">;</span>		<span class="cm">/* Original configuration register value */</span>
	<span class="n">u8</span> <span class="n">convrate_orig</span><span class="p">;</span>	<span class="cm">/* Original conversion rate register value */</span>
	<span class="n">u16</span> <span class="n">alert_alarms</span><span class="p">;</span>	<span class="cm">/* Which alarm bits trigger ALERT# */</span>
				<span class="cm">/* Upper 8 bits for max6695/96 */</span>
	<span class="n">u8</span> <span class="n">max_convrate</span><span class="p">;</span>	<span class="cm">/* Maximum conversion rate */</span>
	<span class="n">u8</span> <span class="n">reg_local_ext</span><span class="p">;</span>	<span class="cm">/* local extension register offset */</span>

	<span class="cm">/* registers values */</span>
	<span class="n">s8</span> <span class="n">temp8</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>	<span class="cm">/* 0: local low limit</span>
<span class="cm">			 * 1: local high limit</span>
<span class="cm">			 * 2: local critical limit</span>
<span class="cm">			 * 3: remote critical limit</span>
<span class="cm">			 * 4: local emergency limit (max6659 and max6695/96)</span>
<span class="cm">			 * 5: remote emergency limit (max6659 and max6695/96)</span>
<span class="cm">			 * 6: remote 2 critical limit (max6695/96 only)</span>
<span class="cm">			 * 7: remote 2 emergency limit (max6695/96 only)</span>
<span class="cm">			 */</span>
	<span class="n">s16</span> <span class="n">temp11</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>	<span class="cm">/* 0: remote input</span>
<span class="cm">			 * 1: remote low limit</span>
<span class="cm">			 * 2: remote high limit</span>
<span class="cm">			 * 3: remote offset (except max6646, max6657/58/59,</span>
<span class="cm">			 *		     and max6695/96)</span>
<span class="cm">			 * 4: local input</span>
<span class="cm">			 * 5: remote 2 input (max6695/96 only)</span>
<span class="cm">			 * 6: remote 2 low limit (max6695/96 only)</span>
<span class="cm">			 * 7: remote 2 high limit (max6695/96 only)</span>
<span class="cm">			 */</span>
	<span class="n">u8</span> <span class="n">temp_hyst</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">alarms</span><span class="p">;</span> <span class="cm">/* bitvector (upper 8 bits for max6695/96) */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Support functions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The ADM1032 supports PEC but not on write byte transactions, so we need</span>
<span class="cm"> * to explicitly ask for a transaction without PEC.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">s32</span> <span class="nf">adm1032_write_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i2c_smbus_xfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			      <span class="n">client</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">I2C_CLIENT_PEC</span><span class="p">,</span>
			      <span class="n">I2C_SMBUS_WRITE</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">I2C_SMBUS_BYTE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * It is assumed that client-&gt;update_lock is held (unless we are in</span>
<span class="cm"> * detection or initialization steps). This matters when PEC is enabled,</span>
<span class="cm"> * because we don&#39;t want the address pointer to change between the write</span>
<span class="cm"> * byte and the read byte transactions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lm90_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_CLIENT_PEC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">adm1032_write_byte</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Register %#02x read failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">reg</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lm90_read16</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">regh</span><span class="p">,</span> <span class="n">u8</span> <span class="n">regl</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">oldh</span><span class="p">,</span> <span class="n">newh</span><span class="p">,</span> <span class="n">l</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * There is a trick here. We have to read two registers to have the</span>
<span class="cm">	 * sensor temperature, but we have to beware a conversion could occur</span>
<span class="cm">	 * between the readings. The datasheet says we should either use</span>
<span class="cm">	 * the one-shot conversion register, which we don&#39;t want to do</span>
<span class="cm">	 * (disables hardware monitoring) or monitor the busy bit, which is</span>
<span class="cm">	 * impossible (we can&#39;t read the values and monitor that bit at the</span>
<span class="cm">	 * exact same time). So the solution used here is to read the high</span>
<span class="cm">	 * byte once, then the low byte, then the high byte again. If the new</span>
<span class="cm">	 * high byte matches the old one, then we have a valid reading. Else</span>
<span class="cm">	 * we have to read the low byte again, and now we believe we have a</span>
<span class="cm">	 * correct reading.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">regh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldh</span><span class="p">))</span>
	 <span class="o">||</span> <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">regl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">))</span>
	 <span class="o">||</span> <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">regh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newh</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oldh</span> <span class="o">!=</span> <span class="n">newh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">regl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">newh</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">l</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * client-&gt;update_lock must be held when calling this function (unless we are</span>
<span class="cm"> * in detection or initialization steps), and while a remote channel other</span>
<span class="cm"> * than channel 0 is selected. Also, calling code must make sure to re-select</span>
<span class="cm"> * external channel 0 before releasing the lock. This is necessary because</span>
<span class="cm"> * various registers have different meanings as a result of selecting a</span>
<span class="cm"> * non-default remote channel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">lm90_select_remote_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
					      <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">config</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">max6696</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_CONFIG1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="p">);</span>
		<span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x08</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span>
			<span class="n">config</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_W_CONFIG1</span><span class="p">,</span>
					  <span class="n">config</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set conversion rate.</span>
<span class="cm"> * client-&gt;update_lock must be held when calling this function (unless we are</span>
<span class="cm"> * in detection or initialization steps).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lm90_set_convrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">interval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">update_interval</span><span class="p">;</span>

	<span class="cm">/* Shift calculations to avoid rounding errors */</span>
	<span class="n">interval</span> <span class="o">&lt;&lt;=</span> <span class="mi">6</span><span class="p">;</span>

	<span class="cm">/* find the nearest update rate */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">update_interval</span> <span class="o">=</span> <span class="n">LM90_MAX_CONVRATE_MS</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">max_convrate</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">update_interval</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">interval</span> <span class="o">&gt;=</span> <span class="n">update_interval</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_W_CONVRATE</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">update_interval</span> <span class="o">=</span> <span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span><span class="n">update_interval</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="nf">lm90_update_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_update</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="n">next_update</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">last_updated</span>
	  <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_interval</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">next_update</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">alarms</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Updating lm90 data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_LOCAL_LOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_LOCAL_HIGH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_LOCAL_CRIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_REMOTE_CRIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_TCRIT_HYST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_hyst</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_local_ext</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lm90_read16</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_LOCAL_TEMP</span><span class="p">,</span>
				    <span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_local_ext</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_LOCAL_TEMP</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">h</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lm90_read16</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_REMOTE_TEMPH</span><span class="p">,</span>
			    <span class="n">LM90_REG_R_REMOTE_TEMPL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_REMOTE_LOWH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM90_HAVE_REM_LIMIT_EXT</span><span class="p">)</span>
			 <span class="o">&amp;&amp;</span> <span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_REMOTE_LOWL</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">l</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_REMOTE_HIGHH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM90_HAVE_REM_LIMIT_EXT</span><span class="p">)</span>
			 <span class="o">&amp;&amp;</span> <span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_REMOTE_HIGHL</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">l</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM90_HAVE_OFFSET</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_REMOTE_OFFSH</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">h</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			 <span class="o">&amp;&amp;</span> <span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_REMOTE_OFFSL</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">l</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM90_HAVE_EMERGENCY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX6659_REG_R_LOCAL_EMERG</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX6659_REG_R_REMOTE_EMERG</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alarms</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span> <span class="o">=</span> <span class="n">alarms</span><span class="p">;</span>	<span class="cm">/* save as 16 bit value */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">max6696</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lm90_select_remote_channel</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_REMOTE_CRIT</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
			<span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX6659_REG_R_REMOTE_EMERG</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
			<span class="n">lm90_read16</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_REMOTE_TEMPH</span><span class="p">,</span>
				    <span class="n">LM90_REG_R_REMOTE_TEMPL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_REMOTE_LOWH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">))</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_REMOTE_HIGHH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">))</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">lm90_select_remote_channel</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX6696_REG_R_STATUS2</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">alarms</span><span class="p">))</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span> <span class="o">|=</span> <span class="n">alarms</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Re-enable ALERT# output if it was originally enabled and</span>
<span class="cm">		 * relevant alarms are all clear</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">config_orig</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span> <span class="o">&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">alert_alarms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">config</span><span class="p">;</span>

			<span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_CONFIG1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Re-enabling ALERT#</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
							  <span class="n">LM90_REG_W_CONFIG1</span><span class="p">,</span>
							  <span class="n">config</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">last_updated</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Conversions</span>
<span class="cm"> * For local temperatures and limits, critical limits and the hysteresis</span>
<span class="cm"> * value, the LM90 uses signed 8-bit values with LSB = 1 degree Celsius.</span>
<span class="cm"> * For remote temperatures and limits, it uses signed 11-bit values with</span>
<span class="cm"> * LSB = 0.125 degree Celsius, left-justified in 16-bit registers.  Some</span>
<span class="cm"> * Maxim chips use unsigned values.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">temp_from_s8</span><span class="p">(</span><span class="n">s8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">val</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">temp_from_u8</span><span class="p">(</span><span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">val</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">temp_from_s16</span><span class="p">(</span><span class="n">s16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">val</span> <span class="o">/</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">125</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">temp_from_u16</span><span class="p">(</span><span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">val</span> <span class="o">/</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">125</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s8</span> <span class="nf">temp_to_s8</span><span class="p">(</span><span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">128000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">128</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">127000</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">127</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="mi">500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">+</span> <span class="mi">500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">temp_to_u8</span><span class="p">(</span><span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">255000</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">255</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">+</span> <span class="mi">500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s16</span> <span class="nf">temp_to_s16</span><span class="p">(</span><span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">128000</span><span class="p">)</span>
		<span class="k">return</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">127875</span><span class="p">)</span>
		<span class="k">return</span> <span class="mh">0x7FE0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="mi">62</span><span class="p">)</span> <span class="o">/</span> <span class="mi">125</span> <span class="o">*</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">+</span> <span class="mi">62</span><span class="p">)</span> <span class="o">/</span> <span class="mi">125</span> <span class="o">*</span> <span class="mi">32</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">hyst_to_reg</span><span class="p">(</span><span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">30500</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">31</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">+</span> <span class="mi">500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ADT7461 in compatibility mode is almost identical to LM90 except that</span>
<span class="cm"> * attempts to write values that are outside the range 0 &lt; temp &lt; 127 are</span>
<span class="cm"> * treated as the boundary value.</span>
<span class="cm"> *</span>
<span class="cm"> * ADT7461 in &quot;extended mode&quot; operation uses unsigned integers offset by</span>
<span class="cm"> * 64 (e.g., 0 -&gt; -64 degC).  The range is restricted to -64..191 degC.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">temp_from_u8_adt7461</span><span class="p">(</span><span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM90_FLAG_ADT7461_EXT</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="mi">64</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">temp_from_s8</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">temp_from_u16_adt7461</span><span class="p">(</span><span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM90_FLAG_ADT7461_EXT</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">250</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">temp_from_s16</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">temp_to_u8_adt7461</span><span class="p">(</span><span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM90_FLAG_ADT7461_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">64000</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">191000</span><span class="p">)</span>
			<span class="k">return</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">+</span> <span class="mi">500</span> <span class="o">+</span> <span class="mi">64000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">127000</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">127</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">+</span> <span class="mi">500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">temp_to_u16_adt7461</span><span class="p">(</span><span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM90_FLAG_ADT7461_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">64000</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">191750</span><span class="p">)</span>
			<span class="k">return</span> <span class="mh">0xFFC0</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">+</span> <span class="mi">64000</span> <span class="o">+</span> <span class="mi">125</span><span class="p">)</span> <span class="o">/</span> <span class="mi">250</span> <span class="o">*</span> <span class="mi">64</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">127750</span><span class="p">)</span>
			<span class="k">return</span> <span class="mh">0x7FC0</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">+</span> <span class="mi">125</span><span class="p">)</span> <span class="o">/</span> <span class="mi">250</span> <span class="o">*</span> <span class="mi">64</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sysfs stuff</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp8</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm90_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">adt7461</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">temp_from_u8_adt7461</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">max6646</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">temp_from_u8</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">temp_from_s8</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]);</span>

	<span class="cm">/* +16 degrees offset for temp2 for the LM99 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">lm99</span> <span class="o">&amp;&amp;</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">+=</span> <span class="mi">16000</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_temp8</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">LM90_REG_W_LOCAL_LOW</span><span class="p">,</span>
		<span class="n">LM90_REG_W_LOCAL_HIGH</span><span class="p">,</span>
		<span class="n">LM90_REG_W_LOCAL_CRIT</span><span class="p">,</span>
		<span class="n">LM90_REG_W_REMOTE_CRIT</span><span class="p">,</span>
		<span class="n">MAX6659_REG_W_LOCAL_EMERG</span><span class="p">,</span>
		<span class="n">MAX6659_REG_W_REMOTE_EMERG</span><span class="p">,</span>
		<span class="n">LM90_REG_W_REMOTE_CRIT</span><span class="p">,</span>
		<span class="n">MAX6659_REG_W_REMOTE_EMERG</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* +16 degrees offset for temp2 for the LM99 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">lm99</span> <span class="o">&amp;&amp;</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">-=</span> <span class="mi">16000</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">adt7461</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_to_u8_adt7461</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">max6646</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_to_u8</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_to_s8</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="n">lm90_select_remote_channel</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nr</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">[</span><span class="n">nr</span><span class="p">],</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
	<span class="n">lm90_select_remote_channel</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp11</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm90_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">adt7461</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">temp_from_u16_adt7461</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">max6646</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">temp_from_u16</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">temp_from_s16</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]);</span>

	<span class="cm">/* +16 degrees offset for temp2 for the LM99 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">lm99</span> <span class="o">&amp;&amp;</span>  <span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">+=</span> <span class="mi">16000</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_temp11</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">high</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">low</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">reg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">LM90_REG_W_REMOTE_LOWH</span><span class="p">,</span> <span class="n">LM90_REG_W_REMOTE_LOWL</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">LM90_REG_W_REMOTE_HIGHH</span><span class="p">,</span> <span class="n">LM90_REG_W_REMOTE_HIGHL</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">LM90_REG_W_REMOTE_OFFSH</span><span class="p">,</span> <span class="n">LM90_REG_W_REMOTE_OFFSL</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">LM90_REG_W_REMOTE_LOWH</span><span class="p">,</span> <span class="n">LM90_REG_W_REMOTE_LOWL</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">LM90_REG_W_REMOTE_HIGHH</span><span class="p">,</span> <span class="n">LM90_REG_W_REMOTE_HIGHL</span><span class="p">,</span> <span class="mi">1</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="k">struct</span> <span class="n">sensor_device_attribute_2</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr_2</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* +16 degrees offset for temp2 for the LM99 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">lm99</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">-=</span> <span class="mi">16000</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">adt7461</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_to_u16_adt7461</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">max6646</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_to_u8</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM90_HAVE_REM_LIMIT_EXT</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_to_s16</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_to_s8</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">lm90_select_remote_channel</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">reg</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">high</span><span class="p">,</span>
				  <span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM90_HAVE_REM_LIMIT_EXT</span><span class="p">)</span>
		<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">low</span><span class="p">,</span>
					  <span class="n">data</span><span class="o">-&gt;</span><span class="n">temp11</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">lm90_select_remote_channel</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temphyst</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm90_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">adt7461</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">temp_from_u8_adt7461</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">max6646</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">temp_from_u8</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">temp_from_s8</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]);</span>

	<span class="cm">/* +16 degrees offset for temp2 for the LM99 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">lm99</span> <span class="o">&amp;&amp;</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">+=</span> <span class="mi">16000</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span> <span class="o">-</span> <span class="n">temp_from_s8</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_hyst</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_temphyst</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">dummy</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">adt7461</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">temp_from_u8_adt7461</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">max6646</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">temp_from_u8</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">temp_from_s8</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp8</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_hyst</span> <span class="o">=</span> <span class="n">hyst_to_reg</span><span class="p">(</span><span class="n">temp</span> <span class="o">-</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_W_TCRIT_HYST</span><span class="p">,</span>
				  <span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_hyst</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_alarms</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">dummy</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm90_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span>
			  <span class="o">*</span><span class="n">devattr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm90_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">bitnr</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span> <span class="o">&gt;&gt;</span> <span class="n">bitnr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_update_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">update_interval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_update_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">lm90_set_convrate</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100000</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp1_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temp11</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp2_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temp11</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temp8</span><span class="p">,</span>
	<span class="n">set_temp8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp2_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temp11</span><span class="p">,</span>
	<span class="n">set_temp11</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temp8</span><span class="p">,</span>
	<span class="n">set_temp8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp2_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temp11</span><span class="p">,</span>
	<span class="n">set_temp11</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_crit</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temp8</span><span class="p">,</span>
	<span class="n">set_temp8</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_crit</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temp8</span><span class="p">,</span>
	<span class="n">set_temp8</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_crit_hyst</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temphyst</span><span class="p">,</span>
	<span class="n">set_temphyst</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_crit_hyst</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temphyst</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp2_offset</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temp11</span><span class="p">,</span>
	<span class="n">set_temp11</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

<span class="cm">/* Individual alarm files */</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_crit_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_crit_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_fault</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_min_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_max_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_min_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_max_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="cm">/* Raw alarm file for compatibility */</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">alarms</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarms</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">update_interval</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_update_interval</span><span class="p">,</span>
		   <span class="n">set_update_interval</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">lm90_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_crit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_crit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_crit_hyst</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_crit_hyst</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_crit_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_crit_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_fault</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_min_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_max_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_min_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_max_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_alarms</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_update_interval</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">lm90_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">lm90_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Additional attributes for devices with emergency sensors</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_emergency</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temp8</span><span class="p">,</span>
	<span class="n">set_temp8</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_emergency</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temp8</span><span class="p">,</span>
	<span class="n">set_temp8</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_emergency_hyst</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temphyst</span><span class="p">,</span>
			  <span class="nb">NULL</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_emergency_hyst</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temphyst</span><span class="p">,</span>
			  <span class="nb">NULL</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">lm90_emergency_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_emergency</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_emergency</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_emergency_hyst</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_emergency_hyst</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">lm90_emergency_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">lm90_emergency_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_emergency_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_emergency_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">lm90_emergency_alarm_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_emergency_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_emergency_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">lm90_emergency_alarm_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">lm90_emergency_alarm_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Additional attributes for devices with 3 temperature sensors</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp3_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temp11</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp3_min</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temp11</span><span class="p">,</span>
	<span class="n">set_temp11</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR_2</span><span class="p">(</span><span class="n">temp3_max</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temp11</span><span class="p">,</span>
	<span class="n">set_temp11</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_crit</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temp8</span><span class="p">,</span>
	<span class="n">set_temp8</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_crit_hyst</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temphyst</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_emergency</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temp8</span><span class="p">,</span>
	<span class="n">set_temp8</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_emergency_hyst</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_temphyst</span><span class="p">,</span>
			  <span class="nb">NULL</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_crit_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_fault</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_min_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_max_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_emergency_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">lm90_temp3_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_crit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_crit_hyst</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_emergency</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_emergency_hyst</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_fault</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_min_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_max_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_crit_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_emergency_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">lm90_temp3_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">lm90_temp3_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* pec used for ADM1032 only */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pec</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">dummy</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">!!</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_CLIENT_PEC</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_pec</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">dummy</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I2C_CLIENT_PEC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">I2C_CLIENT_PEC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">pec</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_pec</span><span class="p">,</span> <span class="n">set_pec</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Real code</span>
<span class="cm"> */</span>

<span class="cm">/* Return 0 if detection is successful, -ENODEV otherwise */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lm90_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">address</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">man_id</span><span class="p">,</span> <span class="n">chip_id</span><span class="p">,</span> <span class="n">config1</span><span class="p">,</span> <span class="n">config2</span><span class="p">,</span> <span class="n">convrate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_BYTE_DATA</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* detection and identification */</span>
	<span class="n">man_id</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_MAN_ID</span><span class="p">);</span>
	<span class="n">chip_id</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_CHIP_ID</span><span class="p">);</span>
	<span class="n">config1</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_CONFIG1</span><span class="p">);</span>
	<span class="n">convrate</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_CONVRATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">man_id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">chip_id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">config1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">convrate</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">man_id</span> <span class="o">==</span> <span class="mh">0x01</span> <span class="o">||</span> <span class="n">man_id</span> <span class="o">==</span> <span class="mh">0x5C</span> <span class="o">||</span> <span class="n">man_id</span> <span class="o">==</span> <span class="mh">0x41</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">config2</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_CONFIG2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">config2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">config2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Make compiler happy */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x4C</span> <span class="o">||</span> <span class="n">address</span> <span class="o">==</span> <span class="mh">0x4D</span><span class="p">)</span>
	 <span class="o">&amp;&amp;</span> <span class="n">man_id</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* National Semiconductor */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="mh">0x2A</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">config2</span> <span class="o">&amp;</span> <span class="mh">0xF8</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span>
		 <span class="o">&amp;&amp;</span> <span class="n">convrate</span> <span class="o">&lt;=</span> <span class="mh">0x09</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x4C</span>
			 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* LM90 */</span>
				<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;lm90&quot;</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">chip_id</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* LM89/LM99 */</span>
				<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;lm99&quot;</span><span class="p">;</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;Assuming LM99 chip at 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">address</span><span class="p">);</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;If it is an LM89, instantiate it &quot;</span>
					 <span class="s">&quot;with the new_device sysfs &quot;</span>
					 <span class="s">&quot;interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x4C</span>
			 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* LM86 */</span>
				<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;lm86&quot;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x4C</span> <span class="o">||</span> <span class="n">address</span> <span class="o">==</span> <span class="mh">0x4D</span><span class="p">)</span>
	 <span class="o">&amp;&amp;</span> <span class="n">man_id</span> <span class="o">==</span> <span class="mh">0x41</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Analog Devices */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">chip_id</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="cm">/* ADM1032 */</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span>
		 <span class="o">&amp;&amp;</span> <span class="n">convrate</span> <span class="o">&lt;=</span> <span class="mh">0x0A</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;adm1032&quot;</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * The ADM1032 supports PEC, but only if combined</span>
<span class="cm">			 * transactions are not used.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
						    <span class="n">I2C_FUNC_SMBUS_BYTE</span><span class="p">))</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">I2C_CLIENT_PEC</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x51</span> <span class="cm">/* ADT7461 */</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="mh">0x1B</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span>
		 <span class="o">&amp;&amp;</span> <span class="n">convrate</span> <span class="o">&lt;=</span> <span class="mh">0x0A</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;adt7461&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x57</span> <span class="cm">/* ADT7461A, NCT1008 */</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="mh">0x1B</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span>
		 <span class="o">&amp;&amp;</span> <span class="n">convrate</span> <span class="o">&lt;=</span> <span class="mh">0x0A</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;adt7461a&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">man_id</span> <span class="o">==</span> <span class="mh">0x4D</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Maxim */</span>
		<span class="kt">int</span> <span class="n">emerg</span><span class="p">,</span> <span class="n">emerg2</span><span class="p">,</span> <span class="n">status2</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * We read MAX6659_REG_R_REMOTE_EMERG twice, and re-read</span>
<span class="cm">		 * LM90_REG_R_MAN_ID in between. If MAX6659_REG_R_REMOTE_EMERG</span>
<span class="cm">		 * exists, both readings will reflect the same value. Otherwise,</span>
<span class="cm">		 * the readings will be different.</span>
<span class="cm">		 */</span>
		<span class="n">emerg</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						 <span class="n">MAX6659_REG_R_REMOTE_EMERG</span><span class="p">);</span>
		<span class="n">man_id</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						  <span class="n">LM90_REG_R_MAN_ID</span><span class="p">);</span>
		<span class="n">emerg2</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						  <span class="n">MAX6659_REG_R_REMOTE_EMERG</span><span class="p">);</span>
		<span class="n">status2</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						   <span class="n">MAX6696_REG_R_STATUS2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emerg</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">man_id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">emerg2</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">status2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * The MAX6657, MAX6658 and MAX6659 do NOT have a chip_id</span>
<span class="cm">		 * register. Reading from that address will return the last</span>
<span class="cm">		 * read value, which in our case is those of the man_id</span>
<span class="cm">		 * register. Likewise, the config1 register seems to lack a</span>
<span class="cm">		 * low nibble, so the value will be those of the previous</span>
<span class="cm">		 * read, so in our case those of the man_id register.</span>
<span class="cm">		 * MAX6659 has a third set of upper temperature limit registers.</span>
<span class="cm">		 * Those registers also return values on MAX6657 and MAX6658,</span>
<span class="cm">		 * thus the only way to detect MAX6659 is by its address.</span>
<span class="cm">		 * For this reason it will be mis-detected as MAX6657 if its</span>
<span class="cm">		 * address is 0x4C.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">man_id</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x4C</span> <span class="o">||</span> <span class="n">address</span> <span class="o">==</span> <span class="mh">0x4D</span> <span class="o">||</span> <span class="n">address</span> <span class="o">==</span> <span class="mh">0x4E</span><span class="p">)</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">man_id</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>
		 <span class="o">&amp;&amp;</span> <span class="n">convrate</span> <span class="o">&lt;=</span> <span class="mh">0x09</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x4C</span><span class="p">)</span>
				<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;max6657&quot;</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;max6659&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/*</span>
<span class="cm">		 * Even though MAX6695 and MAX6696 do not have a chip ID</span>
<span class="cm">		 * register, reading it returns 0x01. Bit 4 of the config1</span>
<span class="cm">		 * register is unused and should return zero when read. Bit 0 of</span>
<span class="cm">		 * the status2 register is unused and should return zero when</span>
<span class="cm">		 * read.</span>
<span class="cm">		 *</span>
<span class="cm">		 * MAX6695 and MAX6696 have an additional set of temperature</span>
<span class="cm">		 * limit registers. We can detect those chips by checking if</span>
<span class="cm">		 * one of those registers exists.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x01</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span>
		 <span class="o">&amp;&amp;</span> <span class="n">emerg</span> <span class="o">==</span> <span class="n">emerg2</span>
		 <span class="o">&amp;&amp;</span> <span class="n">convrate</span> <span class="o">&lt;=</span> <span class="mh">0x07</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;max6696&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/*</span>
<span class="cm">		 * The chip_id register of the MAX6680 and MAX6681 holds the</span>
<span class="cm">		 * revision of the chip. The lowest bit of the config1 register</span>
<span class="cm">		 * is unused and should return zero when read, so should the</span>
<span class="cm">		 * second to last bit of config1 (software reset).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x01</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span>
		 <span class="o">&amp;&amp;</span> <span class="n">convrate</span> <span class="o">&lt;=</span> <span class="mh">0x07</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;max6680&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/*</span>
<span class="cm">		 * The chip_id register of the MAX6646/6647/6649 holds the</span>
<span class="cm">		 * revision of the chip. The lowest 6 bits of the config1</span>
<span class="cm">		 * register are unused and should return zero when read.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x59</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span>
		 <span class="o">&amp;&amp;</span> <span class="n">convrate</span> <span class="o">&lt;=</span> <span class="mh">0x07</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;max6646&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x4C</span>
	 <span class="o">&amp;&amp;</span> <span class="n">man_id</span> <span class="o">==</span> <span class="mh">0x5C</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Winbond/Nuvoton */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="mh">0x2A</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">config2</span> <span class="o">&amp;</span> <span class="mh">0xF8</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x01</span> <span class="cm">/* W83L771W/G */</span>
			 <span class="o">&amp;&amp;</span> <span class="n">convrate</span> <span class="o">&lt;=</span> <span class="mh">0x09</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;w83l771&quot;</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">chip_id</span> <span class="o">&amp;</span> <span class="mh">0xFE</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x10</span> <span class="cm">/* W83L771AWG/ASG */</span>
			 <span class="o">&amp;&amp;</span> <span class="n">convrate</span> <span class="o">&lt;=</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;w83l771&quot;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="mh">0x48</span> <span class="o">&amp;&amp;</span> <span class="n">address</span> <span class="o">&lt;=</span> <span class="mh">0x4F</span>
	 <span class="o">&amp;&amp;</span> <span class="n">man_id</span> <span class="o">==</span> <span class="mh">0xA1</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/*  NXP Semiconductor/Philips */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x00</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="mh">0x2A</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">config2</span> <span class="o">&amp;</span> <span class="mh">0xFE</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span>
		 <span class="o">&amp;&amp;</span> <span class="n">convrate</span> <span class="o">&lt;=</span> <span class="mh">0x09</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sa56004&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x4C</span> <span class="o">||</span> <span class="n">address</span> <span class="o">==</span> <span class="mh">0x4D</span><span class="p">)</span>
	 <span class="o">&amp;&amp;</span> <span class="n">man_id</span> <span class="o">==</span> <span class="mh">0x47</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* GMT */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x01</span> <span class="cm">/* G781 */</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span>
		 <span class="o">&amp;&amp;</span> <span class="n">convrate</span> <span class="o">&lt;=</span> <span class="mh">0x08</span><span class="p">)</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;g781&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* identification failed */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Unsupported chip at 0x%02x (man_id=0x%02X, &quot;</span>
			<span class="s">&quot;chip_id=0x%02X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">man_id</span><span class="p">,</span> <span class="n">chip_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">I2C_NAME_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lm90_remove_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM90_HAVE_TEMP3</span><span class="p">)</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm90_temp3_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM90_HAVE_EMERGENCY_ALARM</span><span class="p">)</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm90_emergency_alarm_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM90_HAVE_EMERGENCY</span><span class="p">)</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm90_emergency_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM90_HAVE_OFFSET</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_offset</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_pec</span><span class="p">);</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm90_group</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lm90_restore_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Restore initial configuration */</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_W_CONVRATE</span><span class="p">,</span>
				  <span class="n">data</span><span class="o">-&gt;</span><span class="n">convrate_orig</span><span class="p">);</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_W_CONFIG1</span><span class="p">,</span>
				  <span class="n">data</span><span class="o">-&gt;</span><span class="n">config_orig</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lm90_init_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">config</span><span class="p">,</span> <span class="n">convrate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_CONVRATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">convrate</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to read convrate register!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">convrate</span> <span class="o">=</span> <span class="n">LM90_DEF_CONVRATE_RVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">convrate_orig</span> <span class="o">=</span> <span class="n">convrate</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start the conversions.</span>
<span class="cm">	 */</span>
	<span class="n">lm90_set_convrate</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>	<span class="cm">/* 500ms; 2Hz conversion rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_CONFIG1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Initialization failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">config_orig</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>

	<span class="cm">/* Check Temperature Range Select */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">adt7461</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">LM90_FLAG_ADT7461_EXT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Put MAX6680/MAX8881 into extended resolution (bit 0x10,</span>
<span class="cm">	 * 0.125 degree resolution) and range (0x08, extend range</span>
<span class="cm">	 * to -64 degree) mode for the remote temperature sensor.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">max6680</span><span class="p">)</span>
		<span class="n">config</span> <span class="o">|=</span> <span class="mh">0x18</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Select external channel 0 for max6695/96</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">max6696</span><span class="p">)</span>
		<span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x08</span><span class="p">;</span>

	<span class="n">config</span> <span class="o">&amp;=</span> <span class="mh">0xBF</span><span class="p">;</span>	<span class="cm">/* run */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">config_orig</span><span class="p">)</span> <span class="cm">/* Only write if changed */</span>
		<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_W_CONFIG1</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lm90_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">to_i2c_adapter</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lm90_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="cm">/* Set the device type */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">adm1032</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_BYTE</span><span class="p">))</span>
			<span class="n">client</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I2C_CLIENT_PEC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Different devices have different alarm bits triggering the</span>
<span class="cm">	 * ALERT# output</span>
<span class="cm">	 */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">alert_alarms</span> <span class="o">=</span> <span class="n">lm90_params</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">].</span><span class="n">alert_alarms</span><span class="p">;</span>

	<span class="cm">/* Set chip capabilities */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">lm90_params</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_local_ext</span> <span class="o">=</span> <span class="n">lm90_params</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">].</span><span class="n">reg_local_ext</span><span class="p">;</span>

	<span class="cm">/* Set maximum conversion rate */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">max_convrate</span> <span class="o">=</span> <span class="n">lm90_params</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">].</span><span class="n">max_convrate</span><span class="p">;</span>

	<span class="cm">/* Initialize the LM90 chip */</span>
	<span class="n">lm90_init_client</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="cm">/* Register sysfs hooks */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm90_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_restore</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_CLIENT_PEC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_pec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove_files</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM90_HAVE_OFFSET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_offset</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove_files</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM90_HAVE_EMERGENCY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm90_emergency_group</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove_files</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM90_HAVE_EMERGENCY_ALARM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">lm90_emergency_alarm_group</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove_files</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM90_HAVE_TEMP3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm90_temp3_group</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_remove_files</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span> <span class="o">=</span> <span class="n">hwmon_device_register</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_remove_files</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_remove_files:</span>
	<span class="n">lm90_remove_files</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="nl">exit_restore:</span>
	<span class="n">lm90_restore_conf</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lm90_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
	<span class="n">lm90_remove_files</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">lm90_restore_conf</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lm90_alert</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm90_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">config</span><span class="p">,</span> <span class="n">alarms</span><span class="p">,</span> <span class="n">alarms2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alarms</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">kind</span> <span class="o">==</span> <span class="n">max6696</span><span class="p">)</span>
		<span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX6696_REG_R_STATUS2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alarms2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">alarms</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">alarms2</span> <span class="o">&amp;</span> <span class="mh">0xfe</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Everything OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alarms</span> <span class="o">&amp;</span> <span class="mh">0x61</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;temp%d out of range, please check!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alarms</span> <span class="o">&amp;</span> <span class="mh">0x1a</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;temp%d out of range, please check!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alarms</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;temp%d diode open, please check!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">alarms2</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;temp%d out of range, please check!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Disable ALERT# output, because these chips don&#39;t implement</span>
<span class="cm">		 * SMBus alert correctly; they should only hold the alert line</span>
<span class="cm">		 * low briefly.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LM90_HAVE_BROKEN_ALERT</span><span class="p">)</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">alarms</span> <span class="o">&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">alert_alarms</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Disabling ALERT#</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">lm90_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_R_CONFIG1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="p">);</span>
			<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM90_REG_W_CONFIG1</span><span class="p">,</span>
						  <span class="n">config</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">lm90_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">class</span>		<span class="o">=</span> <span class="n">I2C_CLASS_HWMON</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;lm90&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">lm90_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">lm90_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alert</span>		<span class="o">=</span> <span class="n">lm90_alert</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">lm90_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">lm90_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">address_list</span>	<span class="o">=</span> <span class="n">normal_i2c</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">lm90_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jean Delvare &lt;khali@linux-fr.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;LM90/ADM1032 driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
