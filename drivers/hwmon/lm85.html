<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › hwmon › lm85.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>lm85.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * lm85.c - Part of lm_sensors, Linux kernel modules for hardware</span>
<span class="cm"> *	    monitoring</span>
<span class="cm"> * Copyright (c) 1998, 1999  Frodo Looijaard &lt;frodol@dds.nl&gt;</span>
<span class="cm"> * Copyright (c) 2002, 2003  Philip Pokorny &lt;ppokorny@penguincomputing.com&gt;</span>
<span class="cm"> * Copyright (c) 2003        Margit Schubert-While &lt;margitsw@t-online.de&gt;</span>
<span class="cm"> * Copyright (c) 2004        Justin Thiessen &lt;jthiessen@penguincomputing.com&gt;</span>
<span class="cm"> * Copyright (C) 2007--2009  Jean Delvare &lt;khali@linux-fr.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Chip details at	      &lt;http://www.national.com/ds/LM/LM85.pdf&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon-vid.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon-sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cm">/* Addresses to scan */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">normal_i2c</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="n">I2C_CLIENT_END</span> <span class="p">};</span>

<span class="k">enum</span> <span class="n">chips</span> <span class="p">{</span>
	<span class="n">any_chip</span><span class="p">,</span> <span class="n">lm85b</span><span class="p">,</span> <span class="n">lm85c</span><span class="p">,</span>
	<span class="n">adm1027</span><span class="p">,</span> <span class="n">adt7463</span><span class="p">,</span> <span class="n">adt7468</span><span class="p">,</span>
	<span class="n">emc6d100</span><span class="p">,</span> <span class="n">emc6d102</span><span class="p">,</span> <span class="n">emc6d103</span><span class="p">,</span> <span class="n">emc6d103s</span>
<span class="p">};</span>

<span class="cm">/* The LM85 registers */</span>

<span class="cp">#define LM85_REG_IN(nr)			(0x20 + (nr))</span>
<span class="cp">#define LM85_REG_IN_MIN(nr)		(0x44 + (nr) * 2)</span>
<span class="cp">#define LM85_REG_IN_MAX(nr)		(0x45 + (nr) * 2)</span>

<span class="cp">#define LM85_REG_TEMP(nr)		(0x25 + (nr))</span>
<span class="cp">#define LM85_REG_TEMP_MIN(nr)		(0x4e + (nr) * 2)</span>
<span class="cp">#define LM85_REG_TEMP_MAX(nr)		(0x4f + (nr) * 2)</span>

<span class="cm">/* Fan speeds are LSB, MSB (2 bytes) */</span>
<span class="cp">#define LM85_REG_FAN(nr)		(0x28 + (nr) * 2)</span>
<span class="cp">#define LM85_REG_FAN_MIN(nr)		(0x54 + (nr) * 2)</span>

<span class="cp">#define LM85_REG_PWM(nr)		(0x30 + (nr))</span>

<span class="cp">#define LM85_REG_COMPANY		0x3e</span>
<span class="cp">#define LM85_REG_VERSTEP		0x3f</span>

<span class="cp">#define ADT7468_REG_CFG5		0x7c</span>
<span class="cp">#define ADT7468_OFF64			(1 &lt;&lt; 0)</span>
<span class="cp">#define ADT7468_HFPWM			(1 &lt;&lt; 1)</span>
<span class="cp">#define IS_ADT7468_OFF64(data)		\</span>
<span class="cp">	((data)-&gt;type == adt7468 &amp;&amp; !((data)-&gt;cfg5 &amp; ADT7468_OFF64))</span>
<span class="cp">#define IS_ADT7468_HFPWM(data)		\</span>
<span class="cp">	((data)-&gt;type == adt7468 &amp;&amp; !((data)-&gt;cfg5 &amp; ADT7468_HFPWM))</span>

<span class="cm">/* These are the recognized values for the above regs */</span>
<span class="cp">#define LM85_COMPANY_NATIONAL		0x01</span>
<span class="cp">#define LM85_COMPANY_ANALOG_DEV		0x41</span>
<span class="cp">#define LM85_COMPANY_SMSC		0x5c</span>
<span class="cp">#define LM85_VERSTEP_VMASK              0xf0</span>
<span class="cp">#define LM85_VERSTEP_GENERIC		0x60</span>
<span class="cp">#define LM85_VERSTEP_GENERIC2		0x70</span>
<span class="cp">#define LM85_VERSTEP_LM85C		0x60</span>
<span class="cp">#define LM85_VERSTEP_LM85B		0x62</span>
<span class="cp">#define LM85_VERSTEP_LM96000_1		0x68</span>
<span class="cp">#define LM85_VERSTEP_LM96000_2		0x69</span>
<span class="cp">#define LM85_VERSTEP_ADM1027		0x60</span>
<span class="cp">#define LM85_VERSTEP_ADT7463		0x62</span>
<span class="cp">#define LM85_VERSTEP_ADT7463C		0x6A</span>
<span class="cp">#define LM85_VERSTEP_ADT7468_1		0x71</span>
<span class="cp">#define LM85_VERSTEP_ADT7468_2		0x72</span>
<span class="cp">#define LM85_VERSTEP_EMC6D100_A0        0x60</span>
<span class="cp">#define LM85_VERSTEP_EMC6D100_A1        0x61</span>
<span class="cp">#define LM85_VERSTEP_EMC6D102		0x65</span>
<span class="cp">#define LM85_VERSTEP_EMC6D103_A0	0x68</span>
<span class="cp">#define LM85_VERSTEP_EMC6D103_A1	0x69</span>
<span class="cp">#define LM85_VERSTEP_EMC6D103S		0x6A	</span><span class="cm">/* Also known as EMC6D103:A2 */</span><span class="cp"></span>

<span class="cp">#define LM85_REG_CONFIG			0x40</span>

<span class="cp">#define LM85_REG_ALARM1			0x41</span>
<span class="cp">#define LM85_REG_ALARM2			0x42</span>

<span class="cp">#define LM85_REG_VID			0x43</span>

<span class="cm">/* Automated FAN control */</span>
<span class="cp">#define LM85_REG_AFAN_CONFIG(nr)	(0x5c + (nr))</span>
<span class="cp">#define LM85_REG_AFAN_RANGE(nr)		(0x5f + (nr))</span>
<span class="cp">#define LM85_REG_AFAN_SPIKE1		0x62</span>
<span class="cp">#define LM85_REG_AFAN_MINPWM(nr)	(0x64 + (nr))</span>
<span class="cp">#define LM85_REG_AFAN_LIMIT(nr)		(0x67 + (nr))</span>
<span class="cp">#define LM85_REG_AFAN_CRITICAL(nr)	(0x6a + (nr))</span>
<span class="cp">#define LM85_REG_AFAN_HYST1		0x6d</span>
<span class="cp">#define LM85_REG_AFAN_HYST2		0x6e</span>

<span class="cp">#define ADM1027_REG_EXTEND_ADC1		0x76</span>
<span class="cp">#define ADM1027_REG_EXTEND_ADC2		0x77</span>

<span class="cp">#define EMC6D100_REG_ALARM3             0x7d</span>
<span class="cm">/* IN5, IN6 and IN7 */</span>
<span class="cp">#define EMC6D100_REG_IN(nr)             (0x70 + ((nr) - 5))</span>
<span class="cp">#define EMC6D100_REG_IN_MIN(nr)         (0x73 + ((nr) - 5) * 2)</span>
<span class="cp">#define EMC6D100_REG_IN_MAX(nr)         (0x74 + ((nr) - 5) * 2)</span>
<span class="cp">#define EMC6D102_REG_EXTEND_ADC1	0x85</span>
<span class="cp">#define EMC6D102_REG_EXTEND_ADC2	0x86</span>
<span class="cp">#define EMC6D102_REG_EXTEND_ADC3	0x87</span>
<span class="cp">#define EMC6D102_REG_EXTEND_ADC4	0x88</span>


<span class="cm">/*</span>
<span class="cm"> * Conversions. Rounding and limit checking is only done on the TO_REG</span>
<span class="cm"> * variants. Note that you should be a bit careful with which arguments</span>
<span class="cm"> * these macros are called: arguments may be evaluated more than once.</span>
<span class="cm"> */</span>

<span class="cm">/* IN are scaled according to built-in resistors */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">lm85_scaling</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>  <span class="cm">/* .001 Volts */</span>
	<span class="mi">2500</span><span class="p">,</span> <span class="mi">2250</span><span class="p">,</span> <span class="mi">3300</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">12000</span><span class="p">,</span>
	<span class="mi">3300</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">1800</span> <span class="cm">/*EMC6D100*/</span>
<span class="p">};</span>
<span class="cp">#define SCALE(val, from, to)	(((val) * (to) + ((from) / 2)) / (from))</span>

<span class="cp">#define INS_TO_REG(n, val)	\</span>
<span class="cp">		SENSORS_LIMIT(SCALE(val, lm85_scaling[n], 192), 0, 255)</span>

<span class="cp">#define INSEXT_FROM_REG(n, val, ext)	\</span>
<span class="cp">		SCALE(((val) &lt;&lt; 4) + (ext), 192 &lt;&lt; 4, lm85_scaling[n])</span>

<span class="cp">#define INS_FROM_REG(n, val)	SCALE((val), 192, lm85_scaling[n])</span>

<span class="cm">/* FAN speed is measured using 90kHz clock */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">FAN_TO_REG</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span><span class="p">)</span>
		<span class="k">return</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">SENSORS_LIMIT</span><span class="p">(</span><span class="mi">5400000</span> <span class="o">/</span> <span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xfffe</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#define FAN_FROM_REG(val)	((val) == 0 ? -1 : (val) == 0xffff ? 0 : \</span>
<span class="cp">				 5400000 / (val))</span>

<span class="cm">/* Temperature is reported in .001 degC increments */</span>
<span class="cp">#define TEMP_TO_REG(val)	\</span>
<span class="cp">		SENSORS_LIMIT(SCALE(val, 1000, 1), -127, 127)</span>
<span class="cp">#define TEMPEXT_FROM_REG(val, ext)	\</span>
<span class="cp">		SCALE(((val) &lt;&lt; 4) + (ext), 16, 1000)</span>
<span class="cp">#define TEMP_FROM_REG(val)	((val) * 1000)</span>

<span class="cp">#define PWM_TO_REG(val)			SENSORS_LIMIT(val, 0, 255)</span>
<span class="cp">#define PWM_FROM_REG(val)		(val)</span>


<span class="cm">/*</span>
<span class="cm"> * ZONEs have the following parameters:</span>
<span class="cm"> *    Limit (low) temp,           1. degC</span>
<span class="cm"> *    Hysteresis (below limit),   1. degC (0-15)</span>
<span class="cm"> *    Range of speed control,     .1 degC (2-80)</span>
<span class="cm"> *    Critical (high) temp,       1. degC</span>
<span class="cm"> *</span>
<span class="cm"> * FAN PWMs have the following parameters:</span>
<span class="cm"> *    Reference Zone,                 1, 2, 3, etc.</span>
<span class="cm"> *    Spinup time,                    .05 sec</span>
<span class="cm"> *    PWM value at limit/low temp,    1 count</span>
<span class="cm"> *    PWM Frequency,                  1. Hz</span>
<span class="cm"> *    PWM is Min or OFF below limit,  flag</span>
<span class="cm"> *    Invert PWM output,              flag</span>
<span class="cm"> *</span>
<span class="cm"> * Some chips filter the temp, others the fan.</span>
<span class="cm"> *    Filter constant (or disabled)   .1 seconds</span>
<span class="cm"> */</span>

<span class="cm">/* These are the zone temperature range encodings in .001 degree C */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">lm85_range_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2000</span><span class="p">,</span> <span class="mi">2500</span><span class="p">,</span> <span class="mi">3300</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">6600</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span>
	<span class="mi">13300</span><span class="p">,</span> <span class="mi">16000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">,</span> <span class="mi">26600</span><span class="p">,</span> <span class="mi">32000</span><span class="p">,</span> <span class="mi">40000</span><span class="p">,</span> <span class="mi">53300</span><span class="p">,</span> <span class="mi">80000</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">RANGE_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">range</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Find the closest match */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">range</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">lm85_range_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">lm85_range_map</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#define RANGE_FROM_REG(val)	lm85_range_map[(val) &amp; 0x0f]</span>

<span class="cm">/* These are the PWM frequency encodings */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">lm85_freq_map</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="cm">/* 1 Hz */</span>
	<span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">94</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">adm1027_freq_map</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="cm">/* 1 Hz */</span>
	<span class="mi">11</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">88</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">FREQ_TO_REG</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Find the closest match */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">map</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">FREQ_FROM_REG</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">map</span><span class="p">[</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Since we can&#39;t use strings, I&#39;m abusing these numbers</span>
<span class="cm"> *   to stand in for the following meanings:</span>
<span class="cm"> *      1 -- PWM responds to Zone 1</span>
<span class="cm"> *      2 -- PWM responds to Zone 2</span>
<span class="cm"> *      3 -- PWM responds to Zone 3</span>
<span class="cm"> *     23 -- PWM responds to the higher temp of Zone 2 or 3</span>
<span class="cm"> *    123 -- PWM responds to highest of Zone 1, 2, or 3</span>
<span class="cm"> *      0 -- PWM is always at 0% (ie, off)</span>
<span class="cm"> *     -1 -- PWM is always at 100%</span>
<span class="cm"> *     -2 -- PWM responds to manual control</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">lm85_zone_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="p">};</span>
<span class="cp">#define ZONE_FROM_REG(val)	lm85_zone_map[(val) &gt;&gt; 5]</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ZONE_TO_REG</span><span class="p">(</span><span class="kt">int</span> <span class="n">zone</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zone</span> <span class="o">==</span> <span class="n">lm85_zone_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>   <span class="cm">/* Not found. */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>  <span class="cm">/* Always 100% */</span>
	<span class="k">return</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HYST_TO_REG(val)	SENSORS_LIMIT(((val) + 500) / 1000, 0, 15)</span>
<span class="cp">#define HYST_FROM_REG(val)	((val) * 1000)</span>

<span class="cm">/*</span>
<span class="cm"> * Chip sampling rates</span>
<span class="cm"> *</span>
<span class="cm"> * Some sensors are not updated more frequently than once per second</span>
<span class="cm"> *    so it doesn&#39;t make sense to read them more often than that.</span>
<span class="cm"> *    We cache the results and return the saved data if the driver</span>
<span class="cm"> *    is called again before a second has elapsed.</span>
<span class="cm"> *</span>
<span class="cm"> * Also, there is significant configuration data for this chip</span>
<span class="cm"> *    given the automatic PWM fan control that is possible.  There</span>
<span class="cm"> *    are about 47 bytes of config data to only 22 bytes of actual</span>
<span class="cm"> *    readings.  So, we keep the config data up to date in the cache</span>
<span class="cm"> *    when it is written and only sample it once every 1 *minute*</span>
<span class="cm"> */</span>
<span class="cp">#define LM85_DATA_INTERVAL  (HZ + HZ / 2)</span>
<span class="cp">#define LM85_CONFIG_INTERVAL  (1 * 60 * HZ)</span>

<span class="cm">/*</span>
<span class="cm"> * LM85 can automatically adjust fan speeds based on temperature</span>
<span class="cm"> * This structure encapsulates an entire Zone config.  There are</span>
<span class="cm"> * three zones (one for each temperature input) on the lm85</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">lm85_zone</span> <span class="p">{</span>
	<span class="n">s8</span> <span class="n">limit</span><span class="p">;</span>	<span class="cm">/* Low temp limit */</span>
	<span class="n">u8</span> <span class="n">hyst</span><span class="p">;</span>	<span class="cm">/* Low limit hysteresis. (0-15) */</span>
	<span class="n">u8</span> <span class="n">range</span><span class="p">;</span>	<span class="cm">/* Temp range, encoded */</span>
	<span class="n">s8</span> <span class="n">critical</span><span class="p">;</span>	<span class="cm">/* &quot;All fans ON&quot; temp limit */</span>
	<span class="n">u8</span> <span class="n">max_desired</span><span class="p">;</span> <span class="cm">/*</span>
<span class="cm">			 * Actual &quot;max&quot; temperature specified.  Preserved</span>
<span class="cm">			 * to prevent &quot;drift&quot; as other autofan control</span>
<span class="cm">			 * values change.</span>
<span class="cm">			 */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">lm85_autofan</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">config</span><span class="p">;</span>	<span class="cm">/* Register value */</span>
	<span class="n">u8</span> <span class="n">min_pwm</span><span class="p">;</span>	<span class="cm">/* Minimum PWM value, encoded */</span>
	<span class="n">u8</span> <span class="n">min_off</span><span class="p">;</span>	<span class="cm">/* Min PWM or OFF below &quot;limit&quot;, flag */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * For each registered chip, we need to keep some data in memory.</span>
<span class="cm"> * The structure is dynamically allocated.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">lm85_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">hwmon_dev</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">freq_map</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">chips</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">has_vid5</span><span class="p">;</span>	<span class="cm">/* true if VID5 is configured for ADT7463 or ADT7468 */</span>

	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">update_lock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">valid</span><span class="p">;</span>		<span class="cm">/* !=0 if following fields are valid */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_reading</span><span class="p">;</span>	<span class="cm">/* In jiffies */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_config</span><span class="p">;</span>	<span class="cm">/* In jiffies */</span>

	<span class="n">u8</span> <span class="n">in</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>		<span class="cm">/* Register value */</span>
	<span class="n">u8</span> <span class="n">in_max</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>		<span class="cm">/* Register value */</span>
	<span class="n">u8</span> <span class="n">in_min</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>		<span class="cm">/* Register value */</span>
	<span class="n">s8</span> <span class="n">temp</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>		<span class="cm">/* Register value */</span>
	<span class="n">s8</span> <span class="n">temp_min</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>		<span class="cm">/* Register value */</span>
	<span class="n">s8</span> <span class="n">temp_max</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>		<span class="cm">/* Register value */</span>
	<span class="n">u16</span> <span class="n">fan</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>		<span class="cm">/* Register value */</span>
	<span class="n">u16</span> <span class="n">fan_min</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>		<span class="cm">/* Register value */</span>
	<span class="n">u8</span> <span class="n">pwm</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>		<span class="cm">/* Register value */</span>
	<span class="n">u8</span> <span class="n">pwm_freq</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>		<span class="cm">/* Register encoding */</span>
	<span class="n">u8</span> <span class="n">temp_ext</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>		<span class="cm">/* Decoded values */</span>
	<span class="n">u8</span> <span class="n">in_ext</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>		<span class="cm">/* Decoded values */</span>
	<span class="n">u8</span> <span class="n">vid</span><span class="p">;</span>			<span class="cm">/* Register value */</span>
	<span class="n">u8</span> <span class="n">vrm</span><span class="p">;</span>			<span class="cm">/* VRM version */</span>
	<span class="n">u32</span> <span class="n">alarms</span><span class="p">;</span>		<span class="cm">/* Register encoding, combined */</span>
	<span class="n">u8</span> <span class="n">cfg5</span><span class="p">;</span>		<span class="cm">/* Config Register 5 on ADT7468 */</span>
	<span class="k">struct</span> <span class="n">lm85_autofan</span> <span class="n">autofan</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">lm85_zone</span> <span class="n">zone</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">lm85_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lm85_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lm85_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">lm85_write_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">lm85_update_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">lm85_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;adm1027&quot;</span><span class="p">,</span> <span class="n">adm1027</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;adt7463&quot;</span><span class="p">,</span> <span class="n">adt7463</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;adt7468&quot;</span><span class="p">,</span> <span class="n">adt7468</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;lm85&quot;</span><span class="p">,</span> <span class="n">any_chip</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;lm85b&quot;</span><span class="p">,</span> <span class="n">lm85b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;lm85c&quot;</span><span class="p">,</span> <span class="n">lm85c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;emc6d100&quot;</span><span class="p">,</span> <span class="n">emc6d100</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;emc6d101&quot;</span><span class="p">,</span> <span class="n">emc6d100</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;emc6d102&quot;</span><span class="p">,</span> <span class="n">emc6d102</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;emc6d103&quot;</span><span class="p">,</span> <span class="n">emc6d103</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;emc6d103s&quot;</span><span class="p">,</span> <span class="n">emc6d103s</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">lm85_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">lm85_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">class</span>		<span class="o">=</span> <span class="n">I2C_CLASS_HWMON</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;lm85&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">lm85_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">lm85_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">lm85_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">lm85_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">address_list</span>	<span class="o">=</span> <span class="n">normal_i2c</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/* 4 Fans */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_fan</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">FAN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fan</span><span class="p">[</span><span class="n">nr</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_fan_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">FAN_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_min</span><span class="p">[</span><span class="n">nr</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_fan_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_min</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAN_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_FAN_MIN</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_min</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define show_fan_offset(offset)						\</span>
<span class="cp">static SENSOR_DEVICE_ATTR(fan##offset##_input, S_IRUGO,			\</span>
<span class="cp">		show_fan, NULL, offset - 1);				\</span>
<span class="cp">static SENSOR_DEVICE_ATTR(fan##offset##_min, S_IRUGO | S_IWUSR,		\</span>
<span class="cp">		show_fan_min, set_fan_min, offset - 1)</span>

<span class="n">show_fan_offset</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">show_fan_offset</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">show_fan_offset</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="n">show_fan_offset</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

<span class="cm">/* vid, vrm, alarms */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_vid_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">vid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_vid5</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 6-pin VID (VRM 10) */</span>
		<span class="n">vid</span> <span class="o">=</span> <span class="n">vid_from_reg</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vid</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">vrm</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* 5-pin VID (VRM 9) */</span>
		<span class="n">vid</span> <span class="o">=</span> <span class="n">vid_from_reg</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vid</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">vrm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">cpu0_vid</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_vid_reg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_vrm_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">vrm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_vrm_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">vrm</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">vrm</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_vrm_reg</span><span class="p">,</span> <span class="n">store_vrm_reg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_alarms_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span>
		<span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">alarms</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarms_reg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span> <span class="o">&gt;&gt;</span> <span class="n">nr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in0_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in1_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in2_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in3_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in4_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in5_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">18</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in6_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">in7_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_fault</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_fault</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan1_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan2_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan3_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan4_alarm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_alarm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>

<span class="cm">/* pwm */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PWM_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm</span><span class="p">[</span><span class="n">nr</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_pwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">PWM_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_PWM</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pwm_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span>
		<span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pwm_zone</span><span class="p">,</span> <span class="n">enable</span><span class="p">;</span>

	<span class="n">pwm_zone</span> <span class="o">=</span> <span class="n">ZONE_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">config</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pwm_zone</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:	<span class="cm">/* PWM is always at 100% */</span>
		<span class="n">enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:		<span class="cm">/* PWM is always at 0% */</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">2</span>:	<span class="cm">/* PWM responds to manual control */</span>
		<span class="n">enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="cm">/* PWM in automatic mode */</span>
		<span class="n">enable</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_pwm_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span>
		<span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">config</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">config</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">config</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Here we have to choose arbitrarily one of the 5 possible</span>
<span class="cm">		 * configurations; I go for the safest</span>
<span class="cm">		 */</span>
		<span class="n">config</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">config</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
		<span class="n">LM85_REG_AFAN_CONFIG</span><span class="p">(</span><span class="n">nr</span><span class="p">));</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">config</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">config</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xe0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">config</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_CONFIG</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">config</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pwm_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">freq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ADT7468_HFPWM</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">22500</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="n">FREQ_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">freq_map</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_freq</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_pwm_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * The ADT7468 has a special high-frequency PWM output mode,</span>
<span class="cm">	 * where all PWM outputs are driven by a 22.5 kHz clock.</span>
<span class="cm">	 * This might confuse the user, but there&#39;s not much we can do.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">adt7468</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">11300</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* High freq. mode */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">cfg5</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADT7468_HFPWM</span><span class="p">;</span>
		<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ADT7468_REG_CFG5</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cfg5</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>					<span class="cm">/* Low freq. mode */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_freq</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">FREQ_TO_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">freq_map</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_RANGE</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span>
				 <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">range</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
				 <span class="o">|</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_freq</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">adt7468</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">cfg5</span> <span class="o">|=</span> <span class="n">ADT7468_HFPWM</span><span class="p">;</span>
			<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ADT7468_REG_CFG5</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cfg5</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define show_pwm_reg(offset)						\</span>
<span class="cp">static SENSOR_DEVICE_ATTR(pwm##offset, S_IRUGO | S_IWUSR,		\</span>
<span class="cp">		show_pwm, set_pwm, offset - 1);				\</span>
<span class="cp">static SENSOR_DEVICE_ATTR(pwm##offset##_enable, S_IRUGO | S_IWUSR,	\</span>
<span class="cp">		show_pwm_enable, set_pwm_enable, offset - 1);		\</span>
<span class="cp">static SENSOR_DEVICE_ATTR(pwm##offset##_freq, S_IRUGO | S_IWUSR,	\</span>
<span class="cp">		show_pwm_freq, set_pwm_freq, offset - 1)</span>

<span class="n">show_pwm_reg</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">show_pwm_reg</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">show_pwm_reg</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

<span class="cm">/* Voltages */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">INSEXT_FROM_REG</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">[</span><span class="n">nr</span><span class="p">],</span>
						    <span class="n">data</span><span class="o">-&gt;</span><span class="n">in_ext</span><span class="p">[</span><span class="n">nr</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_in_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">INS_FROM_REG</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">in_min</span><span class="p">[</span><span class="n">nr</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_in_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_min</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">INS_TO_REG</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_IN_MIN</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">in_min</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_in_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">INS_FROM_REG</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">in_max</span><span class="p">[</span><span class="n">nr</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_in_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_max</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">INS_TO_REG</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_IN_MAX</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">in_max</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define show_in_reg(offset)						\</span>
<span class="cp">static SENSOR_DEVICE_ATTR(in##offset##_input, S_IRUGO,			\</span>
<span class="cp">		show_in, NULL, offset);					\</span>
<span class="cp">static SENSOR_DEVICE_ATTR(in##offset##_min, S_IRUGO | S_IWUSR,		\</span>
<span class="cp">		show_in_min, set_in_min, offset);			\</span>
<span class="cp">static SENSOR_DEVICE_ATTR(in##offset##_max, S_IRUGO | S_IWUSR,		\</span>
<span class="cp">		show_in_max, set_in_max, offset)</span>

<span class="n">show_in_reg</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">show_in_reg</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">show_in_reg</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">show_in_reg</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="n">show_in_reg</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="n">show_in_reg</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="n">show_in_reg</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
<span class="n">show_in_reg</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>

<span class="cm">/* Temps */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TEMPEXT_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">[</span><span class="n">nr</span><span class="p">],</span>
						     <span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_ext</span><span class="p">[</span><span class="n">nr</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_min</span><span class="p">[</span><span class="n">nr</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_temp_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ADT7468_OFF64</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_min</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_TEMP_MIN</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_min</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_max</span><span class="p">[</span><span class="n">nr</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_temp_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ADT7468_OFF64</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_max</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_TEMP_MAX</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_max</span><span class="p">[</span><span class="n">nr</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define show_temp_reg(offset)						\</span>
<span class="cp">static SENSOR_DEVICE_ATTR(temp##offset##_input, S_IRUGO,		\</span>
<span class="cp">		show_temp, NULL, offset - 1);				\</span>
<span class="cp">static SENSOR_DEVICE_ATTR(temp##offset##_min, S_IRUGO | S_IWUSR,	\</span>
<span class="cp">		show_temp_min, set_temp_min, offset - 1);		\</span>
<span class="cp">static SENSOR_DEVICE_ATTR(temp##offset##_max, S_IRUGO | S_IWUSR,	\</span>
<span class="cp">		show_temp_max, set_temp_max, offset - 1);</span>

<span class="n">show_temp_reg</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">show_temp_reg</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">show_temp_reg</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>


<span class="cm">/* Automatic PWM control */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pwm_auto_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ZONE_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">config</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_pwm_auto_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">config</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">config</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xe0</span><span class="p">))</span>
		<span class="o">|</span> <span class="n">ZONE_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_CONFIG</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">config</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pwm_auto_pwm_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PWM_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">min_pwm</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_pwm_auto_pwm_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">min_pwm</span> <span class="o">=</span> <span class="n">PWM_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_MINPWM</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">min_pwm</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pwm_auto_pwm_minctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">min_off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_pwm_auto_pwm_minctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">min_off</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_SPIKE1</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x20</span> <span class="o">&lt;&lt;</span> <span class="n">nr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">min_off</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x20</span> <span class="o">&lt;&lt;</span> <span class="n">nr</span><span class="p">;</span>
	<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_SPIKE1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define pwm_auto(offset)						\</span>
<span class="cp">static SENSOR_DEVICE_ATTR(pwm##offset##_auto_channels,			\</span>
<span class="cp">		S_IRUGO | S_IWUSR, show_pwm_auto_channels,		\</span>
<span class="cp">		set_pwm_auto_channels, offset - 1);			\</span>
<span class="cp">static SENSOR_DEVICE_ATTR(pwm##offset##_auto_pwm_min,			\</span>
<span class="cp">		S_IRUGO | S_IWUSR, show_pwm_auto_pwm_min,		\</span>
<span class="cp">		set_pwm_auto_pwm_min, offset - 1);			\</span>
<span class="cp">static SENSOR_DEVICE_ATTR(pwm##offset##_auto_pwm_minctl,		\</span>
<span class="cp">		S_IRUGO | S_IWUSR, show_pwm_auto_pwm_minctl,		\</span>
<span class="cp">		set_pwm_auto_pwm_minctl, offset - 1)</span>

<span class="n">pwm_auto</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">pwm_auto</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">pwm_auto</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

<span class="cm">/* Temperature settings for automatic PWM control */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp_auto_temp_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">limit</span><span class="p">)</span> <span class="o">-</span>
		<span class="n">HYST_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">hyst</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_temp_auto_temp_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">min</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">min</span> <span class="o">=</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">limit</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">hyst</span> <span class="o">=</span> <span class="n">HYST_TO_REG</span><span class="p">(</span><span class="n">min</span> <span class="o">-</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_HYST1</span><span class="p">,</span>
			<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hyst</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">hyst</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_HYST2</span><span class="p">,</span>
			<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">hyst</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp_auto_temp_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">limit</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_temp_auto_temp_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">limit</span> <span class="o">=</span> <span class="n">TEMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_LIMIT</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">limit</span><span class="p">);</span>

<span class="cm">/* Update temp_auto_max and temp_auto_range */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">range</span> <span class="o">=</span> <span class="n">RANGE_TO_REG</span><span class="p">(</span>
		<span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">max_desired</span><span class="p">)</span> <span class="o">-</span>
		<span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">limit</span><span class="p">));</span>
	<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_RANGE</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span>
		<span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">range</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_freq</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">));</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp_auto_temp_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">limit</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">RANGE_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">range</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_temp_auto_temp_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">min</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">min</span> <span class="o">=</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">limit</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">max_desired</span> <span class="o">=</span> <span class="n">TEMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">range</span> <span class="o">=</span> <span class="n">RANGE_TO_REG</span><span class="p">(</span>
		<span class="n">val</span> <span class="o">-</span> <span class="n">min</span><span class="p">);</span>
	<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_RANGE</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span>
		<span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">range</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_freq</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_temp_auto_temp_crit</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lm85_update_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TEMP_FROM_REG</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">critical</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_temp_auto_temp_crit</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">critical</span> <span class="o">=</span> <span class="n">TEMP_TO_REG</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_CRITICAL</span><span class="p">(</span><span class="n">nr</span><span class="p">),</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">nr</span><span class="p">].</span><span class="n">critical</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define temp_auto(offset)						\</span>
<span class="cp">static SENSOR_DEVICE_ATTR(temp##offset##_auto_temp_off,			\</span>
<span class="cp">		S_IRUGO | S_IWUSR, show_temp_auto_temp_off,		\</span>
<span class="cp">		set_temp_auto_temp_off, offset - 1);			\</span>
<span class="cp">static SENSOR_DEVICE_ATTR(temp##offset##_auto_temp_min,			\</span>
<span class="cp">		S_IRUGO | S_IWUSR, show_temp_auto_temp_min,		\</span>
<span class="cp">		set_temp_auto_temp_min, offset - 1);			\</span>
<span class="cp">static SENSOR_DEVICE_ATTR(temp##offset##_auto_temp_max,			\</span>
<span class="cp">		S_IRUGO | S_IWUSR, show_temp_auto_temp_max,		\</span>
<span class="cp">		set_temp_auto_temp_max, offset - 1);			\</span>
<span class="cp">static SENSOR_DEVICE_ATTR(temp##offset##_auto_temp_crit,		\</span>
<span class="cp">		S_IRUGO | S_IWUSR, show_temp_auto_temp_crit,		\</span>
<span class="cp">		set_temp_auto_temp_crit, offset - 1);</span>

<span class="n">temp_auto</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">temp_auto</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">temp_auto</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">lm85_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan1_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan2_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan3_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan4_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan1_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan2_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan3_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan4_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan1_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan2_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan3_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan4_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_enable</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_enable</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3_enable</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_freq</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_freq</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3_freq</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in0_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in1_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in2_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in3_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in0_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in1_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in2_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in3_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in0_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in1_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in2_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in3_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in0_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in1_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in2_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in3_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_fault</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_fault</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_auto_channels</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_auto_channels</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3_auto_channels</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_auto_pwm_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_auto_pwm_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3_auto_pwm_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_temp_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_temp_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_temp_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_temp_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_temp_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_temp_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_temp_crit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_temp_crit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_temp_crit</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>

	<span class="o">&amp;</span><span class="n">dev_attr_vrm</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_cpu0_vid</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_alarms</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">lm85_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">lm85_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">lm85_attributes_minctl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_auto_pwm_minctl</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm2_auto_pwm_minctl</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm3_auto_pwm_minctl</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">lm85_group_minctl</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">lm85_attributes_minctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">lm85_attributes_temp_off</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_auto_temp_off</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_auto_temp_off</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_auto_temp_off</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">lm85_group_temp_off</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">lm85_attributes_temp_off</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">lm85_attributes_in4</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in4_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in4_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in4_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in4_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">lm85_group_in4</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">lm85_attributes_in4</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">lm85_attributes_in567</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in5_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in6_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in7_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in5_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in6_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in7_min</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in5_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in6_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in7_max</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in5_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in6_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_in7_alarm</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">lm85_group_in567</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">lm85_attributes_in567</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lm85_init_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

	<span class="cm">/* Start monitoring if needed */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_CONFIG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Starting monitoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lm85_write_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_CONFIG</span><span class="p">,</span> <span class="n">value</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Warn about unusual configuration bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device configuration is locked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device is not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lm85_is_fake</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Differenciate between real LM96000 and Winbond WPCD377I. The latter</span>
<span class="cm">	 * emulate the former except that it has no hardware monitoring function</span>
<span class="cm">	 * so the readings are always 0.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">in_temp</span><span class="p">,</span> <span class="n">fan</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">in_temp</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x20</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">fan</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x28</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_temp</span> <span class="o">!=</span> <span class="mh">0x00</span> <span class="o">||</span> <span class="n">fan</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return 0 if detection is successful, -ENODEV otherwise */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lm85_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">address</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">company</span><span class="p">,</span> <span class="n">verstep</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_BYTE_DATA</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We need to be able to do byte I/O */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Determine the chip type */</span>
	<span class="n">company</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_COMPANY</span><span class="p">);</span>
	<span class="n">verstep</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_VERSTEP</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Detecting device at 0x%02x with &quot;</span>
		<span class="s">&quot;COMPANY: 0x%02x and VERSTEP: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">address</span><span class="p">,</span> <span class="n">company</span><span class="p">,</span> <span class="n">verstep</span><span class="p">);</span>

	<span class="cm">/* All supported chips have the version in common */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">verstep</span> <span class="o">&amp;</span> <span class="n">LM85_VERSTEP_VMASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LM85_VERSTEP_GENERIC</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">verstep</span> <span class="o">&amp;</span> <span class="n">LM85_VERSTEP_VMASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LM85_VERSTEP_GENERIC2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Autodetection failed: unsupported version</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">type_name</span> <span class="o">=</span> <span class="s">&quot;lm85&quot;</span><span class="p">;</span>

	<span class="cm">/* Now, refine the detection */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">company</span> <span class="o">==</span> <span class="n">LM85_COMPANY_NATIONAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">verstep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LM85_VERSTEP_LM85C</span>:
			<span class="n">type_name</span> <span class="o">=</span> <span class="s">&quot;lm85c&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LM85_VERSTEP_LM85B</span>:
			<span class="n">type_name</span> <span class="o">=</span> <span class="s">&quot;lm85b&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LM85_VERSTEP_LM96000_1</span>:
		<span class="k">case</span> <span class="n">LM85_VERSTEP_LM96000_2</span>:
			<span class="cm">/* Check for Winbond WPCD377I */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lm85_is_fake</span><span class="p">(</span><span class="n">client</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Found Winbond WPCD377I, ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">company</span> <span class="o">==</span> <span class="n">LM85_COMPANY_ANALOG_DEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">verstep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LM85_VERSTEP_ADM1027</span>:
			<span class="n">type_name</span> <span class="o">=</span> <span class="s">&quot;adm1027&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LM85_VERSTEP_ADT7463</span>:
		<span class="k">case</span> <span class="n">LM85_VERSTEP_ADT7463C</span>:
			<span class="n">type_name</span> <span class="o">=</span> <span class="s">&quot;adt7463&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LM85_VERSTEP_ADT7468_1</span>:
		<span class="k">case</span> <span class="n">LM85_VERSTEP_ADT7468_2</span>:
			<span class="n">type_name</span> <span class="o">=</span> <span class="s">&quot;adt7468&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">company</span> <span class="o">==</span> <span class="n">LM85_COMPANY_SMSC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">verstep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LM85_VERSTEP_EMC6D100_A0</span>:
		<span class="k">case</span> <span class="n">LM85_VERSTEP_EMC6D100_A1</span>:
			<span class="cm">/* Note: we can&#39;t tell a &#39;100 from a &#39;101 */</span>
			<span class="n">type_name</span> <span class="o">=</span> <span class="s">&quot;emc6d100&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LM85_VERSTEP_EMC6D102</span>:
			<span class="n">type_name</span> <span class="o">=</span> <span class="s">&quot;emc6d102&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LM85_VERSTEP_EMC6D103_A0</span>:
		<span class="k">case</span> <span class="n">LM85_VERSTEP_EMC6D103_A1</span>:
			<span class="n">type_name</span> <span class="o">=</span> <span class="s">&quot;emc6d103&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LM85_VERSTEP_EMC6D103S</span>:
			<span class="n">type_name</span> <span class="o">=</span> <span class="s">&quot;emc6d103s&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Autodetection failed: unknown vendor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">type_name</span><span class="p">,</span> <span class="n">I2C_NAME_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lm85_remove_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm85_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">emc6d103s</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm85_group_minctl</span><span class="p">);</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm85_group_temp_off</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_vid5</span><span class="p">)</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm85_group_in4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">emc6d100</span><span class="p">)</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm85_group_in567</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lm85_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lm85_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="cm">/* Fill in the chip specific driver values */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">adm1027</span>:
	<span class="k">case</span> <span class="n">adt7463</span>:
	<span class="k">case</span> <span class="n">adt7468</span>:
	<span class="k">case</span> <span class="n">emc6d100</span>:
	<span class="k">case</span> <span class="n">emc6d102</span>:
	<span class="k">case</span> <span class="n">emc6d103</span>:
	<span class="k">case</span> <span class="n">emc6d103s</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">freq_map</span> <span class="o">=</span> <span class="n">adm1027_freq_map</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">freq_map</span> <span class="o">=</span> <span class="n">lm85_freq_map</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the VRM version */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">vrm</span> <span class="o">=</span> <span class="n">vid_which_vrm</span><span class="p">();</span>

	<span class="cm">/* Initialize the LM85 chip */</span>
	<span class="n">lm85_init_client</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="cm">/* Register sysfs hooks */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm85_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_kfree</span><span class="p">;</span>

	<span class="cm">/* minctl and temp_off exist on all chips except emc6d103s */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">emc6d103s</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm85_group_minctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_remove_files</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">lm85_group_temp_off</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_remove_files</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The ADT7463/68 have an optional VRM 10 mode where pin 21 is used</span>
<span class="cm">	 * as a sixth digital VID input rather than an analog input.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">adt7463</span> <span class="o">||</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">adt7468</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">vid</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_VID</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vid</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">has_vid5</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_vid5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm85_group_in4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_remove_files</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The EMC6D100 has 3 additional voltage inputs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">emc6d100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm85_group_in567</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_remove_files</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span> <span class="o">=</span> <span class="n">hwmon_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_remove_files</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Error out and cleanup code */</span>
 <span class="nl">err_remove_files:</span>
	<span class="n">lm85_remove_files</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
 <span class="nl">err_kfree:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lm85_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
	<span class="n">lm85_remove_files</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">lm85_read_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="cm">/* What size location is it? */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LM85_REG_FAN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:  <span class="cm">/* Read WORD data */</span>
	<span class="k">case</span> <span class="n">LM85_REG_FAN</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">LM85_REG_FAN</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">LM85_REG_FAN</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">LM85_REG_FAN_MIN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">LM85_REG_FAN_MIN</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">LM85_REG_FAN_MIN</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">LM85_REG_FAN_MIN</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">LM85_REG_ALARM1</span>:	<span class="cm">/* Read both bytes at once */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">|=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="cm">/* Read BYTE data */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lm85_write_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LM85_REG_FAN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:  <span class="cm">/* Write WORD data */</span>
	<span class="k">case</span> <span class="n">LM85_REG_FAN</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">LM85_REG_FAN</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">LM85_REG_FAN</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">LM85_REG_FAN_MIN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">LM85_REG_FAN_MIN</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">LM85_REG_FAN_MIN</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">LM85_REG_FAN_MIN</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>:
	<span class="cm">/* NOTE: ALARM is read only, so not included here */</span>
		<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="cm">/* Write BYTE data */</span>
		<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="nf">lm85_update_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lm85_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">||</span>
	     <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">last_reading</span> <span class="o">+</span> <span class="n">LM85_DATA_INTERVAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Things that change quickly */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Reading sensor values</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Have to read extended bits first to &quot;freeze&quot; the</span>
<span class="cm">		 * more significant bits that are read later.</span>
<span class="cm">		 * There are 2 additional resolution bits per channel and we</span>
<span class="cm">		 * have room for 4, so we shift them to the left.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">adm1027</span> <span class="o">||</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">adt7463</span> <span class="o">||</span>
		    <span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">adt7468</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ext1</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						   <span class="n">ADM1027_REG_EXTEND_ADC1</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">ext2</span> <span class="o">=</span>  <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						    <span class="n">ADM1027_REG_EXTEND_ADC2</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ext1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">ext2</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_ext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_ext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">vid</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_VID</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_IN</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_FAN</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_vid5</span><span class="p">)</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_IN</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">adt7468</span><span class="p">)</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">cfg5</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ADT7468_REG_CFG5</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_TEMP</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_PWM</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ADT7468_OFF64</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_ALARM1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">emc6d100</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Three more voltage sensors */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
							<span class="n">EMC6D100_REG_IN</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="cm">/* More alarm bits */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">alarms</span> <span class="o">|=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						<span class="n">EMC6D100_REG_ALARM3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">emc6d102</span> <span class="o">||</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">emc6d103</span> <span class="o">||</span>
			   <span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">emc6d103s</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Have to read LSB bits after the MSB ones because</span>
<span class="cm">			 * the reading of the MSB bits has frozen the</span>
<span class="cm">			 * LSBs (backward from the ADM1027).</span>
<span class="cm">			 */</span>
			<span class="kt">int</span> <span class="n">ext1</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						   <span class="n">EMC6D102_REG_EXTEND_ADC1</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">ext2</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						   <span class="n">EMC6D102_REG_EXTEND_ADC2</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">ext3</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						   <span class="n">EMC6D102_REG_EXTEND_ADC3</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">ext4</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						   <span class="n">EMC6D102_REG_EXTEND_ADC4</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_ext</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ext3</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_ext</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ext4</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_ext</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ext4</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_ext</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ext3</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_ext</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ext2</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

			<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_ext</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ext1</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_ext</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ext2</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_ext</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ext1</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">last_reading</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>  <span class="cm">/* last_reading */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">||</span>
	     <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">last_config</span> <span class="o">+</span> <span class="n">LM85_CONFIG_INTERVAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Things that don&#39;t change often */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Reading config values</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_IN_MIN</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_IN_MAX</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">fan_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_FAN_MIN</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">has_vid5</span><span class="p">)</span>  <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_min</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
					  <span class="n">LM85_REG_IN_MIN</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_max</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
					  <span class="n">LM85_REG_IN_MAX</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">emc6d100</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						<span class="n">EMC6D100_REG_IN_MIN</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">in_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						<span class="n">EMC6D100_REG_IN_MAX</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

			<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_TEMP_MIN</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_TEMP_MAX</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

			<span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">config</span> <span class="o">=</span>
			    <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_CONFIG</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_RANGE</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_freq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">range</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">min_pwm</span> <span class="o">=</span>
			    <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_MINPWM</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">limit</span> <span class="o">=</span>
			    <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_LIMIT</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">critical</span> <span class="o">=</span>
			    <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_CRITICAL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ADT7468_OFF64</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">64</span><span class="p">;</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">temp_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">64</span><span class="p">;</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">limit</span> <span class="o">-=</span> <span class="mi">64</span><span class="p">;</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">critical</span> <span class="o">-=</span> <span class="mi">64</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">emc6d103s</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_SPIKE1</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">min_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">min_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">autofan</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">min_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">i</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_HYST1</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hyst</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">hyst</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

			<span class="n">i</span> <span class="o">=</span> <span class="n">lm85_read_value</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LM85_REG_AFAN_HYST2</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">hyst</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">last_config</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>  <span class="cm">/* last_config */</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">lm85_driver</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Philip Pokorny &lt;ppokorny@penguincomputing.com&gt;, &quot;</span>
	<span class="s">&quot;Margit Schubert-While &lt;margitsw@t-online.de&gt;, &quot;</span>
	<span class="s">&quot;Justin Thiessen &lt;jthiessen@penguincomputing.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;LM85-B, LM85-C driver&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
