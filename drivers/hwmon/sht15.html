<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › hwmon › sht15.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sht15.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * sht15.c - support for the SHT15 Temperature and Humidity Sensor</span>
<span class="cm"> *</span>
<span class="cm"> * Portions Copyright (c) 2010-2011 Savoir-faire Linux Inc.</span>
<span class="cm"> *          Jerome Oufella &lt;jerome.oufella@savoirfairelinux.com&gt;</span>
<span class="cm"> *          Vivien Didelot &lt;vivien.didelot@savoirfairelinux.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2009 Jonathan Cameron</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2007 Wouter Horre</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * For further information, see the Documentation/hwmon/sht15 file.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon-sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/sht15.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>

<span class="cm">/* Commands */</span>
<span class="cp">#define SHT15_MEASURE_TEMP		0x03</span>
<span class="cp">#define SHT15_MEASURE_RH		0x05</span>
<span class="cp">#define SHT15_WRITE_STATUS		0x06</span>
<span class="cp">#define SHT15_READ_STATUS		0x07</span>
<span class="cp">#define SHT15_SOFT_RESET		0x1E</span>

<span class="cm">/* Min timings */</span>
<span class="cp">#define SHT15_TSCKL			100	</span><span class="cm">/* (nsecs) clock low */</span><span class="cp"></span>
<span class="cp">#define SHT15_TSCKH			100	</span><span class="cm">/* (nsecs) clock high */</span><span class="cp"></span>
<span class="cp">#define SHT15_TSU			150	</span><span class="cm">/* (nsecs) data setup time */</span><span class="cp"></span>
<span class="cp">#define SHT15_TSRST			11	</span><span class="cm">/* (msecs) soft reset time */</span><span class="cp"></span>

<span class="cm">/* Status Register Bits */</span>
<span class="cp">#define SHT15_STATUS_LOW_RESOLUTION	0x01</span>
<span class="cp">#define SHT15_STATUS_NO_OTP_RELOAD	0x02</span>
<span class="cp">#define SHT15_STATUS_HEATER		0x04</span>
<span class="cp">#define SHT15_STATUS_LOW_BATTERY	0x40</span>

<span class="cm">/* Actions the driver may be doing */</span>
<span class="k">enum</span> <span class="n">sht15_state</span> <span class="p">{</span>
	<span class="n">SHT15_READING_NOTHING</span><span class="p">,</span>
	<span class="n">SHT15_READING_TEMP</span><span class="p">,</span>
	<span class="n">SHT15_READING_HUMID</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct sht15_temppair - elements of voltage dependent temp calc</span>
<span class="cm"> * @vdd:	supply voltage in microvolts</span>
<span class="cm"> * @d1:		see data sheet</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sht15_temppair</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">vdd</span><span class="p">;</span> <span class="cm">/* microvolts */</span>
	<span class="kt">int</span> <span class="n">d1</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Table 9 from datasheet - relates temperature calculation to supply voltage */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sht15_temppair</span> <span class="n">temppoints</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">2500000</span><span class="p">,</span> <span class="o">-</span><span class="mi">39400</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3000000</span><span class="p">,</span> <span class="o">-</span><span class="mi">39600</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3500000</span><span class="p">,</span> <span class="o">-</span><span class="mi">39700</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4000000</span><span class="p">,</span> <span class="o">-</span><span class="mi">39800</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">5000000</span><span class="p">,</span> <span class="o">-</span><span class="mi">40100</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Table from CRC datasheet, section 2.4 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">sht15_crc8_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>	<span class="mi">49</span><span class="p">,</span>	<span class="mi">98</span><span class="p">,</span>	<span class="mi">83</span><span class="p">,</span>	<span class="mi">196</span><span class="p">,</span>	<span class="mi">245</span><span class="p">,</span>	<span class="mi">166</span><span class="p">,</span>	<span class="mi">151</span><span class="p">,</span>
	<span class="mi">185</span><span class="p">,</span>	<span class="mi">136</span><span class="p">,</span>	<span class="mi">219</span><span class="p">,</span>	<span class="mi">234</span><span class="p">,</span>	<span class="mi">125</span><span class="p">,</span>	<span class="mi">76</span><span class="p">,</span>	<span class="mi">31</span><span class="p">,</span>	<span class="mi">46</span><span class="p">,</span>
	<span class="mi">67</span><span class="p">,</span>	<span class="mi">114</span><span class="p">,</span>	<span class="mi">33</span><span class="p">,</span>	<span class="mi">16</span><span class="p">,</span>	<span class="mi">135</span><span class="p">,</span>	<span class="mi">182</span><span class="p">,</span>	<span class="mi">229</span><span class="p">,</span>	<span class="mi">212</span><span class="p">,</span>
	<span class="mi">250</span><span class="p">,</span>	<span class="mi">203</span><span class="p">,</span>	<span class="mi">152</span><span class="p">,</span>	<span class="mi">169</span><span class="p">,</span>	<span class="mi">62</span><span class="p">,</span>	<span class="mi">15</span><span class="p">,</span>	<span class="mi">92</span><span class="p">,</span>	<span class="mi">109</span><span class="p">,</span>
	<span class="mi">134</span><span class="p">,</span>	<span class="mi">183</span><span class="p">,</span>	<span class="mi">228</span><span class="p">,</span>	<span class="mi">213</span><span class="p">,</span>	<span class="mi">66</span><span class="p">,</span>	<span class="mi">115</span><span class="p">,</span>	<span class="mi">32</span><span class="p">,</span>	<span class="mi">17</span><span class="p">,</span>
	<span class="mi">63</span><span class="p">,</span>	<span class="mi">14</span><span class="p">,</span>	<span class="mi">93</span><span class="p">,</span>	<span class="mi">108</span><span class="p">,</span>	<span class="mi">251</span><span class="p">,</span>	<span class="mi">202</span><span class="p">,</span>	<span class="mi">153</span><span class="p">,</span>	<span class="mi">168</span><span class="p">,</span>
	<span class="mi">197</span><span class="p">,</span>	<span class="mi">244</span><span class="p">,</span>	<span class="mi">167</span><span class="p">,</span>	<span class="mi">150</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">48</span><span class="p">,</span>	<span class="mi">99</span><span class="p">,</span>	<span class="mi">82</span><span class="p">,</span>
	<span class="mi">124</span><span class="p">,</span>	<span class="mi">77</span><span class="p">,</span>	<span class="mi">30</span><span class="p">,</span>	<span class="mi">47</span><span class="p">,</span>	<span class="mi">184</span><span class="p">,</span>	<span class="mi">137</span><span class="p">,</span>	<span class="mi">218</span><span class="p">,</span>	<span class="mi">235</span><span class="p">,</span>
	<span class="mi">61</span><span class="p">,</span>	<span class="mi">12</span><span class="p">,</span>	<span class="mi">95</span><span class="p">,</span>	<span class="mi">110</span><span class="p">,</span>	<span class="mi">249</span><span class="p">,</span>	<span class="mi">200</span><span class="p">,</span>	<span class="mi">155</span><span class="p">,</span>	<span class="mi">170</span><span class="p">,</span>
	<span class="mi">132</span><span class="p">,</span>	<span class="mi">181</span><span class="p">,</span>	<span class="mi">230</span><span class="p">,</span>	<span class="mi">215</span><span class="p">,</span>	<span class="mi">64</span><span class="p">,</span>	<span class="mi">113</span><span class="p">,</span>	<span class="mi">34</span><span class="p">,</span>	<span class="mi">19</span><span class="p">,</span>
	<span class="mi">126</span><span class="p">,</span>	<span class="mi">79</span><span class="p">,</span>	<span class="mi">28</span><span class="p">,</span>	<span class="mi">45</span><span class="p">,</span>	<span class="mi">186</span><span class="p">,</span>	<span class="mi">139</span><span class="p">,</span>	<span class="mi">216</span><span class="p">,</span>	<span class="mi">233</span><span class="p">,</span>
	<span class="mi">199</span><span class="p">,</span>	<span class="mi">246</span><span class="p">,</span>	<span class="mi">165</span><span class="p">,</span>	<span class="mi">148</span><span class="p">,</span>	<span class="mi">3</span><span class="p">,</span>	<span class="mi">50</span><span class="p">,</span>	<span class="mi">97</span><span class="p">,</span>	<span class="mi">80</span><span class="p">,</span>
	<span class="mi">187</span><span class="p">,</span>	<span class="mi">138</span><span class="p">,</span>	<span class="mi">217</span><span class="p">,</span>	<span class="mi">232</span><span class="p">,</span>	<span class="mi">127</span><span class="p">,</span>	<span class="mi">78</span><span class="p">,</span>	<span class="mi">29</span><span class="p">,</span>	<span class="mi">44</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>	<span class="mi">51</span><span class="p">,</span>	<span class="mi">96</span><span class="p">,</span>	<span class="mi">81</span><span class="p">,</span>	<span class="mi">198</span><span class="p">,</span>	<span class="mi">247</span><span class="p">,</span>	<span class="mi">164</span><span class="p">,</span>	<span class="mi">149</span><span class="p">,</span>
	<span class="mi">248</span><span class="p">,</span>	<span class="mi">201</span><span class="p">,</span>	<span class="mi">154</span><span class="p">,</span>	<span class="mi">171</span><span class="p">,</span>	<span class="mi">60</span><span class="p">,</span>	<span class="mi">13</span><span class="p">,</span>	<span class="mi">94</span><span class="p">,</span>	<span class="mi">111</span><span class="p">,</span>
	<span class="mi">65</span><span class="p">,</span>	<span class="mi">112</span><span class="p">,</span>	<span class="mi">35</span><span class="p">,</span>	<span class="mi">18</span><span class="p">,</span>	<span class="mi">133</span><span class="p">,</span>	<span class="mi">180</span><span class="p">,</span>	<span class="mi">231</span><span class="p">,</span>	<span class="mi">214</span><span class="p">,</span>
	<span class="mi">122</span><span class="p">,</span>	<span class="mi">75</span><span class="p">,</span>	<span class="mi">24</span><span class="p">,</span>	<span class="mi">41</span><span class="p">,</span>	<span class="mi">190</span><span class="p">,</span>	<span class="mi">143</span><span class="p">,</span>	<span class="mi">220</span><span class="p">,</span>	<span class="mi">237</span><span class="p">,</span>
	<span class="mi">195</span><span class="p">,</span>	<span class="mi">242</span><span class="p">,</span>	<span class="mi">161</span><span class="p">,</span>	<span class="mi">144</span><span class="p">,</span>	<span class="mi">7</span><span class="p">,</span>	<span class="mi">54</span><span class="p">,</span>	<span class="mi">101</span><span class="p">,</span>	<span class="mi">84</span><span class="p">,</span>
	<span class="mi">57</span><span class="p">,</span>	<span class="mi">8</span><span class="p">,</span>	<span class="mi">91</span><span class="p">,</span>	<span class="mi">106</span><span class="p">,</span>	<span class="mi">253</span><span class="p">,</span>	<span class="mi">204</span><span class="p">,</span>	<span class="mi">159</span><span class="p">,</span>	<span class="mi">174</span><span class="p">,</span>
	<span class="mi">128</span><span class="p">,</span>	<span class="mi">177</span><span class="p">,</span>	<span class="mi">226</span><span class="p">,</span>	<span class="mi">211</span><span class="p">,</span>	<span class="mi">68</span><span class="p">,</span>	<span class="mi">117</span><span class="p">,</span>	<span class="mi">38</span><span class="p">,</span>	<span class="mi">23</span><span class="p">,</span>
	<span class="mi">252</span><span class="p">,</span>	<span class="mi">205</span><span class="p">,</span>	<span class="mi">158</span><span class="p">,</span>	<span class="mi">175</span><span class="p">,</span>	<span class="mi">56</span><span class="p">,</span>	<span class="mi">9</span><span class="p">,</span>	<span class="mi">90</span><span class="p">,</span>	<span class="mi">107</span><span class="p">,</span>
	<span class="mi">69</span><span class="p">,</span>	<span class="mi">116</span><span class="p">,</span>	<span class="mi">39</span><span class="p">,</span>	<span class="mi">22</span><span class="p">,</span>	<span class="mi">129</span><span class="p">,</span>	<span class="mi">176</span><span class="p">,</span>	<span class="mi">227</span><span class="p">,</span>	<span class="mi">210</span><span class="p">,</span>
	<span class="mi">191</span><span class="p">,</span>	<span class="mi">142</span><span class="p">,</span>	<span class="mi">221</span><span class="p">,</span>	<span class="mi">236</span><span class="p">,</span>	<span class="mi">123</span><span class="p">,</span>	<span class="mi">74</span><span class="p">,</span>	<span class="mi">25</span><span class="p">,</span>	<span class="mi">40</span><span class="p">,</span>
	<span class="mi">6</span><span class="p">,</span>	<span class="mi">55</span><span class="p">,</span>	<span class="mi">100</span><span class="p">,</span>	<span class="mi">85</span><span class="p">,</span>	<span class="mi">194</span><span class="p">,</span>	<span class="mi">243</span><span class="p">,</span>	<span class="mi">160</span><span class="p">,</span>	<span class="mi">145</span><span class="p">,</span>
	<span class="mi">71</span><span class="p">,</span>	<span class="mi">118</span><span class="p">,</span>	<span class="mi">37</span><span class="p">,</span>	<span class="mi">20</span><span class="p">,</span>	<span class="mi">131</span><span class="p">,</span>	<span class="mi">178</span><span class="p">,</span>	<span class="mi">225</span><span class="p">,</span>	<span class="mi">208</span><span class="p">,</span>
	<span class="mi">254</span><span class="p">,</span>	<span class="mi">207</span><span class="p">,</span>	<span class="mi">156</span><span class="p">,</span>	<span class="mi">173</span><span class="p">,</span>	<span class="mi">58</span><span class="p">,</span>	<span class="mi">11</span><span class="p">,</span>	<span class="mi">88</span><span class="p">,</span>	<span class="mi">105</span><span class="p">,</span>
	<span class="mi">4</span><span class="p">,</span>	<span class="mi">53</span><span class="p">,</span>	<span class="mi">102</span><span class="p">,</span>	<span class="mi">87</span><span class="p">,</span>	<span class="mi">192</span><span class="p">,</span>	<span class="mi">241</span><span class="p">,</span>	<span class="mi">162</span><span class="p">,</span>	<span class="mi">147</span><span class="p">,</span>
	<span class="mi">189</span><span class="p">,</span>	<span class="mi">140</span><span class="p">,</span>	<span class="mi">223</span><span class="p">,</span>	<span class="mi">238</span><span class="p">,</span>	<span class="mi">121</span><span class="p">,</span>	<span class="mi">72</span><span class="p">,</span>	<span class="mi">27</span><span class="p">,</span>	<span class="mi">42</span><span class="p">,</span>
	<span class="mi">193</span><span class="p">,</span>	<span class="mi">240</span><span class="p">,</span>	<span class="mi">163</span><span class="p">,</span>	<span class="mi">146</span><span class="p">,</span>	<span class="mi">5</span><span class="p">,</span>	<span class="mi">52</span><span class="p">,</span>	<span class="mi">103</span><span class="p">,</span>	<span class="mi">86</span><span class="p">,</span>
	<span class="mi">120</span><span class="p">,</span>	<span class="mi">73</span><span class="p">,</span>	<span class="mi">26</span><span class="p">,</span>	<span class="mi">43</span><span class="p">,</span>	<span class="mi">188</span><span class="p">,</span>	<span class="mi">141</span><span class="p">,</span>	<span class="mi">222</span><span class="p">,</span>	<span class="mi">239</span><span class="p">,</span>
	<span class="mi">130</span><span class="p">,</span>	<span class="mi">179</span><span class="p">,</span>	<span class="mi">224</span><span class="p">,</span>	<span class="mi">209</span><span class="p">,</span>	<span class="mi">70</span><span class="p">,</span>	<span class="mi">119</span><span class="p">,</span>	<span class="mi">36</span><span class="p">,</span>	<span class="mi">21</span><span class="p">,</span>
	<span class="mi">59</span><span class="p">,</span>	<span class="mi">10</span><span class="p">,</span>	<span class="mi">89</span><span class="p">,</span>	<span class="mi">104</span><span class="p">,</span>	<span class="mi">255</span><span class="p">,</span>	<span class="mi">206</span><span class="p">,</span>	<span class="mi">157</span><span class="p">,</span>	<span class="mi">172</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct sht15_data - device instance specific data</span>
<span class="cm"> * @pdata:		platform data (gpio&#39;s etc).</span>
<span class="cm"> * @read_work:		bh of interrupt handler.</span>
<span class="cm"> * @wait_queue:		wait queue for getting values from device.</span>
<span class="cm"> * @val_temp:		last temperature value read from device.</span>
<span class="cm"> * @val_humid:		last humidity value read from device.</span>
<span class="cm"> * @val_status:		last status register value read from device.</span>
<span class="cm"> * @checksum_ok:	last value read from the device passed CRC validation.</span>
<span class="cm"> * @checksumming:	flag used to enable the data validation with CRC.</span>
<span class="cm"> * @state:		state identifying the action the driver is doing.</span>
<span class="cm"> * @measurements_valid:	are the current stored measures valid (start condition).</span>
<span class="cm"> * @status_valid:	is the current stored status valid (start condition).</span>
<span class="cm"> * @last_measurement:	time of last measure.</span>
<span class="cm"> * @last_status:	time of last status reading.</span>
<span class="cm"> * @read_lock:		mutex to ensure only one read in progress at a time.</span>
<span class="cm"> * @dev:		associate device structure.</span>
<span class="cm"> * @hwmon_dev:		device associated with hwmon subsystem.</span>
<span class="cm"> * @reg:		associated regulator (if specified).</span>
<span class="cm"> * @nb:			notifier block to handle notifications of voltage</span>
<span class="cm"> *                      changes.</span>
<span class="cm"> * @supply_uV:		local copy of supply voltage used to allow use of</span>
<span class="cm"> *                      regulator consumer if available.</span>
<span class="cm"> * @supply_uV_valid:	indicates that an updated value has not yet been</span>
<span class="cm"> *			obtained from the regulator and so any calculations</span>
<span class="cm"> *			based upon it will be invalid.</span>
<span class="cm"> * @update_supply_work:	work struct that is used to update the supply_uV.</span>
<span class="cm"> * @interrupt_handled:	flag used to indicate a handler has been scheduled.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sht15_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sht15_platform_data</span>	<span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span>		<span class="n">read_work</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>		<span class="n">wait_queue</span><span class="p">;</span>
	<span class="kt">uint16_t</span>			<span class="n">val_temp</span><span class="p">;</span>
	<span class="kt">uint16_t</span>			<span class="n">val_humid</span><span class="p">;</span>
	<span class="n">u8</span>				<span class="n">val_status</span><span class="p">;</span>
	<span class="n">bool</span>				<span class="n">checksum_ok</span><span class="p">;</span>
	<span class="n">bool</span>				<span class="n">checksumming</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sht15_state</span>		<span class="n">state</span><span class="p">;</span>
	<span class="n">bool</span>				<span class="n">measurements_valid</span><span class="p">;</span>
	<span class="n">bool</span>				<span class="n">status_valid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">last_measurement</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">last_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>			<span class="n">read_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span>			<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span>			<span class="o">*</span><span class="n">hwmon_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator</span>		<span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">notifier_block</span>		<span class="n">nb</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">supply_uV</span><span class="p">;</span>
	<span class="n">bool</span>				<span class="n">supply_uV_valid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span>		<span class="n">update_supply_work</span><span class="p">;</span>
	<span class="n">atomic_t</span>			<span class="n">interrupt_handled</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_reverse() - reverse a byte</span>
<span class="cm"> * @byte:    byte to reverse.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">sht15_reverse</span><span class="p">(</span><span class="n">u8</span> <span class="n">byte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">c</span> <span class="o">|=</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_crc8() - compute crc8</span>
<span class="cm"> * @data:	sht15 specific data.</span>
<span class="cm"> * @value:	sht15 retrieved data.</span>
<span class="cm"> *</span>
<span class="cm"> * This implements section 2 of the CRC datasheet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">sht15_crc8</span><span class="p">(</span><span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">crc</span> <span class="o">=</span> <span class="n">sht15_reverse</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">val_status</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="n">sht15_crc8_table</span><span class="p">[</span><span class="o">*</span><span class="n">value</span> <span class="o">^</span> <span class="n">crc</span><span class="p">];</span>
		<span class="n">value</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">crc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_connection_reset() - reset the comms interface</span>
<span class="cm"> * @data:	sht15 specific data</span>
<span class="cm"> *</span>
<span class="cm"> * This implements section 3.4 of the data sheet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sht15_connection_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSCKL</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSCKL</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSCKH</span><span class="p">);</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSCKL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_send_bit() - send an individual bit to the device</span>
<span class="cm"> * @data:	device state data</span>
<span class="cm"> * @val:	value of bit to be sent</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sht15_send_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSU</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSCKH</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSCKL</span><span class="p">);</span> <span class="cm">/* clock low time */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_transmission_start() - specific sequence for new transmission</span>
<span class="cm"> * @data:	device state data</span>
<span class="cm"> *</span>
<span class="cm"> * Timings for this are not documented on the data sheet, so very</span>
<span class="cm"> * conservative ones used in implementation. This implements</span>
<span class="cm"> * figure 12 on the data sheet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sht15_transmission_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ensure data is high and output */</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSU</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSCKL</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSCKH</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSU</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSCKL</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSCKH</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSU</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSCKL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_send_byte() - send a single byte to the device</span>
<span class="cm"> * @data:	device state</span>
<span class="cm"> * @byte:	value to be sent</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sht15_send_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">byte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sht15_send_bit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">!!</span><span class="p">(</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">));</span>
		<span class="n">byte</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_wait_for_response() - checks for ack from device</span>
<span class="cm"> * @data:	device state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sht15_wait_for_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gpio_direction_input</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSCKH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Command not acknowledged</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sht15_connection_reset</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSCKL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_send_cmd() - Sends a command to the device.</span>
<span class="cm"> * @data:	device state</span>
<span class="cm"> * @cmd:	command byte to be sent</span>
<span class="cm"> *</span>
<span class="cm"> * On entry, sck is output low, data is output pull high</span>
<span class="cm"> * and the interrupt disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sht15_send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sht15_transmission_start</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">sht15_send_byte</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sht15_wait_for_response</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_soft_reset() - send a soft reset command</span>
<span class="cm"> * @data:	sht15 specific data.</span>
<span class="cm"> *</span>
<span class="cm"> * As described in section 3.2 of the datasheet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sht15_soft_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sht15_send_cmd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">SHT15_SOFT_RESET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">SHT15_TSRST</span><span class="p">);</span>
	<span class="cm">/* device resets default hardware status register value */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">val_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_ack() - send a ack</span>
<span class="cm"> * @data:	sht15 specific data.</span>
<span class="cm"> *</span>
<span class="cm"> * Each byte of data is acknowledged by pulling the data line</span>
<span class="cm"> * low for one clock pulse.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sht15_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSU</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSU</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSU</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">gpio_direction_input</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_end_transmission() - notify device of end of transmission</span>
<span class="cm"> * @data:	device state.</span>
<span class="cm"> *</span>
<span class="cm"> * This is basically a NAK (single clock pulse, data high).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sht15_end_transmission</span><span class="p">(</span><span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSU</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSCKH</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSCKL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_read_byte() - Read a byte back from the device</span>
<span class="cm"> * @data:	device state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">sht15_read_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">byte</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSCKH</span><span class="p">);</span>
		<span class="n">byte</span> <span class="o">|=</span> <span class="o">!!</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">);</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSCKL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">byte</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_send_status() - write the status register byte</span>
<span class="cm"> * @data:	sht15 specific data.</span>
<span class="cm"> * @status:	the byte to set the status register with.</span>
<span class="cm"> *</span>
<span class="cm"> * As described in figure 14 and table 5 of the datasheet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sht15_send_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sht15_send_cmd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">SHT15_WRITE_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="n">SHT15_TSU</span><span class="p">);</span>
	<span class="n">sht15_send_byte</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sht15_wait_for_response</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">val_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_update_status() - get updated status register from device if too old</span>
<span class="cm"> * @data:	device instance specific data.</span>
<span class="cm"> *</span>
<span class="cm"> * As described in figure 15 and table 5 of the datasheet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sht15_update_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">previous_config</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dev_checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">checksum_vals</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">last_status</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">)</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">status_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sht15_send_cmd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">SHT15_READ_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_ret</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">sht15_read_byte</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">checksumming</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sht15_ack</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
			<span class="n">dev_checksum</span> <span class="o">=</span> <span class="n">sht15_reverse</span><span class="p">(</span><span class="n">sht15_read_byte</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
			<span class="n">checksum_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SHT15_READ_STATUS</span><span class="p">;</span>
			<span class="n">checksum_vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">checksum_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">sht15_crc8</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">checksum_vals</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
					<span class="o">==</span> <span class="n">dev_checksum</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">sht15_end_transmission</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Perform checksum validation on the received data.</span>
<span class="cm">		 * Specification mentions that in case a checksum verification</span>
<span class="cm">		 * fails, a soft reset command must be sent to the device.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">checksumming</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">checksum_ok</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">previous_config</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">val_status</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sht15_soft_reset</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error_ret</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">previous_config</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">sht15_send_status</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">previous_config</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="s">&quot;CRC validation failed, unable &quot;</span>
						<span class="s">&quot;to restore device settings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">error_ret</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">val_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">status_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">last_status</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">error_ret:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_measurement() - get a new value from device</span>
<span class="cm"> * @data:		device instance specific data</span>
<span class="cm"> * @command:		command sent to request value</span>
<span class="cm"> * @timeout_msecs:	timeout after which comms are assumed</span>
<span class="cm"> *			to have failed are reset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sht15_measurement</span><span class="p">(</span><span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">command</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">timeout_msecs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">previous_config</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sht15_send_cmd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">gpio_direction_input</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">interrupt_handled</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">enable_irq</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">));</span>
		<span class="cm">/* Only relevant if the interrupt hasn&#39;t occurred. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">interrupt_handled</span><span class="p">))</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">read_work</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SHT15_READING_NOTHING</span><span class="p">),</span>
				 <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">timeout_msecs</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="cm">/* timeout occurred */</span>
		<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">));</span>
		<span class="n">sht15_connection_reset</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Perform checksum validation on the received data.</span>
<span class="cm">	 *  Specification mentions that in case a checksum verification fails,</span>
<span class="cm">	 *  a soft reset command must be sent to the device.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">checksumming</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">checksum_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">previous_config</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">val_status</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sht15_soft_reset</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">previous_config</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sht15_send_status</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">previous_config</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;CRC validation failed, unable &quot;</span>
					<span class="s">&quot;to restore device settings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_update_measurements() - get updated measures from device if too old</span>
<span class="cm"> * @data:	device state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sht15_update_measurements</span><span class="p">(</span><span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">last_measurement</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">)</span>
	    <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">measurements_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SHT15_READING_HUMID</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sht15_measurement</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">SHT15_MEASURE_RH</span><span class="p">,</span> <span class="mi">160</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_ret</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SHT15_READING_TEMP</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sht15_measurement</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">SHT15_MEASURE_TEMP</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_ret</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">measurements_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">last_measurement</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">error_ret:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_calc_temp() - convert the raw reading to a temperature</span>
<span class="cm"> * @data:	device state</span>
<span class="cm"> *</span>
<span class="cm"> * As per section 4.3 of the data sheet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sht15_calc_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">d1</span> <span class="o">=</span> <span class="n">temppoints</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">d2</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">val_status</span> <span class="o">&amp;</span> <span class="n">SHT15_STATUS_LOW_RESOLUTION</span><span class="p">)</span> <span class="o">?</span> <span class="mi">40</span> <span class="o">:</span> <span class="mi">10</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">temppoints</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="cm">/* Find pointer to interpolate */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">supply_uV</span> <span class="o">&gt;</span> <span class="n">temppoints</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">vdd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d1</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">supply_uV</span> <span class="o">-</span> <span class="n">temppoints</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">vdd</span><span class="p">)</span>
				<span class="o">*</span> <span class="p">(</span><span class="n">temppoints</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d1</span> <span class="o">-</span> <span class="n">temppoints</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">d1</span><span class="p">)</span>
				<span class="o">/</span> <span class="p">(</span><span class="n">temppoints</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vdd</span> <span class="o">-</span> <span class="n">temppoints</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">vdd</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">temppoints</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">d1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">return</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">val_temp</span> <span class="o">*</span> <span class="n">d2</span> <span class="o">+</span> <span class="n">d1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_calc_humid() - using last temperature convert raw to humid</span>
<span class="cm"> * @data:	device state</span>
<span class="cm"> *</span>
<span class="cm"> * This is the temperature compensated version as per section 4.2 of</span>
<span class="cm"> * the data sheet.</span>
<span class="cm"> *</span>
<span class="cm"> * The sensor is assumed to be V3, which is compatible with V4.</span>
<span class="cm"> * Humidity conversion coefficients are shown in table 7 of the datasheet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sht15_calc_humid</span><span class="p">(</span><span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rh_linear</span><span class="p">;</span> <span class="cm">/* milli percent */</span>
	<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">sht15_calc_temp</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">t2</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">c1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">val_status</span> <span class="o">&amp;</span> <span class="n">SHT15_STATUS_LOW_RESOLUTION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c2</span> <span class="o">=</span> <span class="mi">648000</span><span class="p">;</span> <span class="cm">/* x 10 ^ -6 */</span>
		<span class="n">c3</span> <span class="o">=</span> <span class="o">-</span><span class="mi">7200</span><span class="p">;</span>  <span class="cm">/* x 10 ^ -7 */</span>
		<span class="n">t2</span> <span class="o">=</span> <span class="mi">1280</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">c2</span> <span class="o">=</span> <span class="mi">40500</span><span class="p">;</span>  <span class="cm">/* x 10 ^ -6 */</span>
		<span class="n">c3</span> <span class="o">=</span> <span class="o">-</span><span class="mi">28</span><span class="p">;</span>    <span class="cm">/* x 10 ^ -7 */</span>
		<span class="n">t2</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rh_linear</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">*</span> <span class="mi">1000</span>
		<span class="o">+</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">val_humid</span> <span class="o">/</span> <span class="mi">1000</span>
		<span class="o">+</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">val_humid</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">val_humid</span> <span class="o">*</span> <span class="n">c3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">temp</span> <span class="o">-</span> <span class="mi">25000</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10000</span> <span class="o">+</span> <span class="n">t2</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">val_humid</span><span class="p">)</span>
		<span class="o">/</span> <span class="mi">1000000</span> <span class="o">+</span> <span class="n">rh_linear</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_show_status() - show status information in sysfs</span>
<span class="cm"> * @dev:	device.</span>
<span class="cm"> * @attr:	device attribute.</span>
<span class="cm"> * @buf:	sysfs buffer where information is written to.</span>
<span class="cm"> *</span>
<span class="cm"> * Will be called on read access to temp1_fault, humidity1_fault</span>
<span class="cm"> * and heater_enable sysfs attributes.</span>
<span class="cm"> * Returns number of bytes written into buffer, negative errno on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sht15_show_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sht15_update_status</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">!!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">val_status</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_store_heater() - change heater state via sysfs</span>
<span class="cm"> * @dev:	device.</span>
<span class="cm"> * @attr:	device attribute.</span>
<span class="cm"> * @buf:	sysfs buffer to read the new heater state from.</span>
<span class="cm"> * @count:	length of the data.</span>
<span class="cm"> *</span>
<span class="cm"> * Will be called on write access to heater_enable sysfs attribute.</span>
<span class="cm"> * Returns number of bytes actually decoded, negative errno on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sht15_store_heater</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">val_status</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="n">value</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">SHT15_STATUS_HEATER</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SHT15_STATUS_HEATER</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sht15_send_status</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_show_temp() - show temperature measurement value in sysfs</span>
<span class="cm"> * @dev:	device.</span>
<span class="cm"> * @attr:	device attribute.</span>
<span class="cm"> * @buf:	sysfs buffer where measurement values are written to.</span>
<span class="cm"> *</span>
<span class="cm"> * Will be called on read access to temp1_input sysfs attribute.</span>
<span class="cm"> * Returns number of bytes written into buffer, negative errno on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sht15_show_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Technically no need to read humidity as well */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sht15_update_measurements</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">sht15_calc_temp</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_show_humidity() - show humidity measurement value in sysfs</span>
<span class="cm"> * @dev:	device.</span>
<span class="cm"> * @attr:	device attribute.</span>
<span class="cm"> * @buf:	sysfs buffer where measurement values are written to.</span>
<span class="cm"> *</span>
<span class="cm"> * Will be called on read access to humidity1_input sysfs attribute.</span>
<span class="cm"> * Returns number of bytes written into buffer, negative errno on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sht15_show_humidity</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sht15_update_measurements</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sht15_calc_humid</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">sht15_show_temp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">humidity1_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			  <span class="n">sht15_show_humidity</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_fault</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">sht15_show_status</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			  <span class="n">SHT15_STATUS_LOW_BATTERY</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">humidity1_fault</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">sht15_show_status</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			  <span class="n">SHT15_STATUS_LOW_BATTERY</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">heater_enable</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">sht15_show_status</span><span class="p">,</span>
			  <span class="n">sht15_store_heater</span><span class="p">,</span> <span class="n">SHT15_STATUS_HEATER</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">sht15_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_humidity1_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_fault</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_humidity1_fault</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_heater_enable</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_name</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">sht15_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">sht15_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sht15_interrupt_fired</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>

	<span class="cm">/* First disable the interrupt */</span>
	<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">interrupt_handled</span><span class="p">);</span>
	<span class="cm">/* Then schedule a reading work struct */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SHT15_READING_NOTHING</span><span class="p">)</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">read_work</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sht15_bh_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work_s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dev_checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">checksum_vals</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span>
		<span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work_s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sht15_data</span><span class="p">,</span>
			       <span class="n">read_work</span><span class="p">);</span>

	<span class="cm">/* Firstly, verify the line is low */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If not, then start the interrupt again - care here as could</span>
<span class="cm">		 * have gone low in meantime so verify it hasn&#39;t!</span>
<span class="cm">		 */</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">interrupt_handled</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">));</span>
		<span class="cm">/* If still not occurred or another handler was scheduled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">)</span>
		    <span class="o">||</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">interrupt_handled</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read the data back from the device */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">sht15_read_byte</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">sht15_ack</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">sht15_read_byte</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">checksumming</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Ask the device for a checksum and read it back.</span>
<span class="cm">		 * Note: the device sends the checksum byte reversed.</span>
<span class="cm">		 */</span>
		<span class="n">sht15_ack</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">dev_checksum</span> <span class="o">=</span> <span class="n">sht15_reverse</span><span class="p">(</span><span class="n">sht15_read_byte</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
		<span class="n">checksum_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">SHT15_READING_TEMP</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">SHT15_MEASURE_TEMP</span> <span class="o">:</span> <span class="n">SHT15_MEASURE_RH</span><span class="p">;</span>
		<span class="n">checksum_vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">checksum_vals</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">checksum_ok</span>
			<span class="o">=</span> <span class="p">(</span><span class="n">sht15_crc8</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">checksum_vals</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="n">dev_checksum</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Tell the device we are done */</span>
	<span class="n">sht15_end_transmission</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SHT15_READING_TEMP</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">val_temp</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SHT15_READING_HUMID</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">val_humid</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SHT15_READING_NOTHING</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sht15_update_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work_s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span>
		<span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work_s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sht15_data</span><span class="p">,</span>
			       <span class="n">update_supply_work</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">supply_uV</span> <span class="o">=</span> <span class="n">regulator_get_voltage</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sht15_invalidate_voltage() - mark supply voltage invalid when notified by reg</span>
<span class="cm"> * @nb:		associated notification structure</span>
<span class="cm"> * @event:	voltage regulator state change event code</span>
<span class="cm"> * @ignored:	function parameter - ignored here</span>
<span class="cm"> *</span>
<span class="cm"> * Note that as the notification code holds the regulator lock, we have</span>
<span class="cm"> * to schedule an update of the supply voltage rather than getting it directly.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sht15_invalidate_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span>
				    <span class="kt">void</span> <span class="o">*</span><span class="n">ignored</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sht15_data</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">REGULATOR_EVENT_VOLTAGE_CHANGE</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">supply_uV_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_supply_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sht15_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;kzalloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">read_work</span><span class="p">,</span> <span class="n">sht15_bh_read_data</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">update_supply_work</span><span class="p">,</span> <span class="n">sht15_update_voltage</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no platform data supplied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_data</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">supply_uV</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">supply_mv</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">checksum</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">checksumming</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">no_otp_reload</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">SHT15_STATUS_NO_OTP_RELOAD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">low_resolution</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">SHT15_STATUS_LOW_RESOLUTION</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If a regulator is available,</span>
<span class="cm">	 * query what the supply voltage actually is!</span>
<span class="cm">	 */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">=</span> <span class="n">regulator_get</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vcc&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">voltage</span><span class="p">;</span>

		<span class="n">voltage</span> <span class="o">=</span> <span class="n">regulator_get_voltage</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">voltage</span><span class="p">)</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">supply_uV</span> <span class="o">=</span> <span class="n">voltage</span><span class="p">;</span>

		<span class="n">regulator_enable</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Setup a notifier block to update this if another device</span>
<span class="cm">		 * causes the voltage to change</span>
<span class="cm">		 */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sht15_invalidate_voltage</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_register_notifier</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;regulator notifier request failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">regulator_disable</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
			<span class="n">regulator_put</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_free_data</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Try requesting the GPIOs */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="s">&quot;SHT15 sck&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gpio request failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_release_reg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">,</span> <span class="s">&quot;SHT15 data&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gpio request failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_release_gpio_sck</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">),</span>
			  <span class="n">sht15_interrupt_fired</span><span class="p">,</span>
			  <span class="n">IRQF_TRIGGER_FALLING</span><span class="p">,</span>
			  <span class="s">&quot;sht15 data&quot;</span><span class="p">,</span>
			  <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get irq for data line</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_release_gpio_data</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">));</span>
	<span class="n">sht15_connection_reset</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sht15_soft_reset</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_release_irq</span><span class="p">;</span>

	<span class="cm">/* write status with platform data options */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sht15_send_status</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_release_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sht15_attr_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;sysfs create failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_release_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span> <span class="o">=</span> <span class="n">hwmon_device_register</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_release_sysfs_group</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_release_sysfs_group:</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sht15_attr_group</span><span class="p">);</span>
<span class="nl">err_release_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">),</span> <span class="n">data</span><span class="p">);</span>
<span class="nl">err_release_gpio_data:</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">);</span>
<span class="nl">err_release_gpio_sck:</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">);</span>
<span class="nl">err_release_reg:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">regulator_unregister_notifier</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">);</span>
		<span class="n">regulator_disable</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">regulator_put</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">err_free_data:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="nl">error_ret:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">sht15_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sht15_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure any reads from the device are done and</span>
<span class="cm">	 * prevent new ones beginning</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sht15_soft_reset</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sht15_attr_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">regulator_unregister_notifier</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">);</span>
		<span class="n">regulator_disable</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">regulator_put</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">),</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">);</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_sck</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sht_drivers simultaneously refers to __devinit and __devexit function</span>
<span class="cm"> * which causes spurious section mismatch warning. So use __refdata to</span>
<span class="cm"> * get rid from this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">__refdata</span> <span class="n">sht_drivers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sht10&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">sht15_probe</span><span class="p">,</span>
		<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">sht15_remove</span><span class="p">),</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sht11&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">sht15_probe</span><span class="p">,</span>
		<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">sht15_remove</span><span class="p">),</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sht15&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">sht15_probe</span><span class="p">,</span>
		<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">sht15_remove</span><span class="p">),</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sht71&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">sht15_probe</span><span class="p">,</span>
		<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">sht15_remove</span><span class="p">),</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sht75&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">sht15_probe</span><span class="p">,</span>
		<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">sht15_remove</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sht15_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sht_drivers</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sht_drivers</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_unreg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_unreg:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sht_drivers</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">sht15_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sht15_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sht_drivers</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sht_drivers</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sht15_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
