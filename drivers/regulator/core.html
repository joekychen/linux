<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › regulator › core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * core.c  --  Voltage/Current Regulator framework.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2007, 2008 Wolfson Microelectronics PLC.</span>
<span class="cm"> * Copyright 2008 SlimLogic Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Liam Girdwood &lt;lrg@slimlogic.co.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> *  under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> *  Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> *  option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/async.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/suspend.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/regmap.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/of_regulator.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/driver.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/machine.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#define CREATE_TRACE_POINTS</span>
<span class="cp">#include &lt;trace/events/regulator.h&gt;</span>

<span class="cp">#include &quot;dummy.h&quot;</span>

<span class="cp">#define rdev_crit(rdev, fmt, ...)					\</span>
<span class="cp">	pr_crit(&quot;%s: &quot; fmt, rdev_get_name(rdev), ##__VA_ARGS__)</span>
<span class="cp">#define rdev_err(rdev, fmt, ...)					\</span>
<span class="cp">	pr_err(&quot;%s: &quot; fmt, rdev_get_name(rdev), ##__VA_ARGS__)</span>
<span class="cp">#define rdev_warn(rdev, fmt, ...)					\</span>
<span class="cp">	pr_warn(&quot;%s: &quot; fmt, rdev_get_name(rdev), ##__VA_ARGS__)</span>
<span class="cp">#define rdev_info(rdev, fmt, ...)					\</span>
<span class="cp">	pr_info(&quot;%s: &quot; fmt, rdev_get_name(rdev), ##__VA_ARGS__)</span>
<span class="cp">#define rdev_dbg(rdev, fmt, ...)					\</span>
<span class="cp">	pr_debug(&quot;%s: &quot; fmt, rdev_get_name(rdev), ##__VA_ARGS__)</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">regulator_list_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">regulator_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">regulator_map_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">has_full_constraints</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">board_wants_dummy_regulator</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">debugfs_root</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * struct regulator_map</span>
<span class="cm"> *</span>
<span class="cm"> * Used to provide symbolic supply names to devices.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">regulator_map</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">;</span>   <span class="cm">/* The dev_name() for the consumer */</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">supply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">regulator</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * struct regulator</span>
<span class="cm"> *</span>
<span class="cm"> * One for each consumer device.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">regulator</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">always_on</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">uA_load</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min_uV</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_uV</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">supply_name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">debugfs</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">_regulator_is_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">_regulator_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">_regulator_get_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">_regulator_get_current_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">_regulator_get_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">_notifier_call_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">_regulator_do_set_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">min_uV</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_uV</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">create_regulator</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">supply_name</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">rdev_get_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* gets the regulator for a given consumer device */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="nf">get_device_regulator</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_list_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regulator_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">regulator</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">consumer_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_list_mutex</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">regulator</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_list_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * of_get_regulator - get a regulator device node based on supply name</span>
<span class="cm"> * @dev: Device pointer for the consumer (of regulator) device</span>
<span class="cm"> * @supply: regulator supply name</span>
<span class="cm"> *</span>
<span class="cm"> * Extract the regulator device node corresponding to the supply name.</span>
<span class="cm"> * retruns the device node corresponding to the regulator if found, else</span>
<span class="cm"> * returns NULL.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="nf">of_get_regulator</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">supply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">regnode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">prop_name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span> <span class="cm">/* 32 is max size of property name */</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Looking up %s-supply from device tree</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">supply</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">prop_name</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;%s-supply&quot;</span><span class="p">,</span> <span class="n">supply</span><span class="p">);</span>
	<span class="n">regnode</span> <span class="o">=</span> <span class="n">of_parse_phandle</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regnode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Looking up %s property in node %s failed&quot;</span><span class="p">,</span>
				<span class="n">prop_name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">regnode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_regulator_can_change_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">valid_ops_mask</span> <span class="o">&amp;</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Platform voltage constraint check */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">regulator_check_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="o">*</span><span class="n">min_uV</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">max_uV</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">*</span><span class="n">min_uV</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">max_uV</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;no constraints</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">valid_ops_mask</span> <span class="o">&amp;</span> <span class="n">REGULATOR_CHANGE_VOLTAGE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;operation not allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">max_uV</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uV</span><span class="p">)</span>
		<span class="o">*</span><span class="n">max_uV</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">min_uV</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uV</span><span class="p">)</span>
		<span class="o">*</span><span class="n">min_uV</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">min_uV</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">max_uV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;unsupportable voltage range: %d-%duV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="o">*</span><span class="n">min_uV</span><span class="p">,</span> <span class="o">*</span><span class="n">max_uV</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Make sure we select a voltage that suits the needs of all</span>
<span class="cm"> * regulator consumers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">regulator_check_consumers</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="o">*</span><span class="n">min_uV</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">max_uV</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">regulator</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">consumer_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Assume consumers that didn&#39;t say anything are OK</span>
<span class="cm">		 * with anything in the constraint range.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">min_uV</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">max_uV</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">max_uV</span> <span class="o">&gt;</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">max_uV</span><span class="p">)</span>
			<span class="o">*</span><span class="n">max_uV</span> <span class="o">=</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">max_uV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">min_uV</span> <span class="o">&lt;</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">min_uV</span><span class="p">)</span>
			<span class="o">*</span><span class="n">min_uV</span> <span class="o">=</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">min_uV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">min_uV</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">max_uV</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* current constraint check */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">regulator_check_current_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
					<span class="kt">int</span> <span class="o">*</span><span class="n">min_uA</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">max_uA</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">*</span><span class="n">min_uA</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">max_uA</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;no constraints</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">valid_ops_mask</span> <span class="o">&amp;</span> <span class="n">REGULATOR_CHANGE_CURRENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;operation not allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">max_uA</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uA</span><span class="p">)</span>
		<span class="o">*</span><span class="n">max_uA</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">min_uA</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uA</span><span class="p">)</span>
		<span class="o">*</span><span class="n">min_uA</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">min_uA</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">max_uA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;unsupportable current range: %d-%duA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="o">*</span><span class="n">min_uA</span><span class="p">,</span> <span class="o">*</span><span class="n">max_uA</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* operating mode constraint check */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">regulator_mode_constrain</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">REGULATOR_MODE_FAST</span>:
	<span class="k">case</span> <span class="n">REGULATOR_MODE_NORMAL</span>:
	<span class="k">case</span> <span class="n">REGULATOR_MODE_IDLE</span>:
	<span class="k">case</span> <span class="n">REGULATOR_MODE_STANDBY</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;invalid mode %x specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;no constraints</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">valid_ops_mask</span> <span class="o">&amp;</span> <span class="n">REGULATOR_CHANGE_MODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;operation not allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The modes are bitmasks, the most power hungry modes having</span>
<span class="cm">	 * the lowest values. If the requested mode isn&#39;t supported</span>
<span class="cm">	 * try higher modes. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">valid_modes_mask</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">mode</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* dynamic regulator mode switching constraint check */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">regulator_check_drms</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;no constraints</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">valid_ops_mask</span> <span class="o">&amp;</span> <span class="n">REGULATOR_CHANGE_DRMS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;operation not allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">device_requested_uA_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">;</span>

	<span class="n">regulator</span> <span class="o">=</span> <span class="n">get_device_regulator</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regulator</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">uA_load</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_uV_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_regulator_get_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">microvolts</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">regulator_uV_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_uA_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_regulator_get_current_limit</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">microamps</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">regulator_uA_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_name_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdev_get_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_print_opmode</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">REGULATOR_MODE_FAST</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;fast</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">REGULATOR_MODE_NORMAL</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;normal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">REGULATOR_MODE_IDLE</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;idle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">REGULATOR_MODE_STANDBY</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;standby</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_opmode_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">regulator_print_opmode</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">_regulator_get_mode</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">opmode</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">regulator_opmode_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_print_state</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_state_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_print_state</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">_regulator_is_enabled</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">regulator_state_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_status_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_status</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">REGULATOR_STATUS_OFF</span>:
		<span class="n">label</span> <span class="o">=</span> <span class="s">&quot;off&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REGULATOR_STATUS_ON</span>:
		<span class="n">label</span> <span class="o">=</span> <span class="s">&quot;on&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REGULATOR_STATUS_ERROR</span>:
		<span class="n">label</span> <span class="o">=</span> <span class="s">&quot;error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REGULATOR_STATUS_FAST</span>:
		<span class="n">label</span> <span class="o">=</span> <span class="s">&quot;fast&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REGULATOR_STATUS_NORMAL</span>:
		<span class="n">label</span> <span class="o">=</span> <span class="s">&quot;normal&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REGULATOR_STATUS_IDLE</span>:
		<span class="n">label</span> <span class="o">=</span> <span class="s">&quot;idle&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REGULATOR_STATUS_STANDBY</span>:
		<span class="n">label</span> <span class="o">=</span> <span class="s">&quot;standby&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">regulator_status_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_min_uA_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;constraint not defined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uA</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">min_microamps</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">regulator_min_uA_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_max_uA_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;constraint not defined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uA</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">max_microamps</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">regulator_max_uA_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_min_uV_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;constraint not defined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uV</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">min_microvolts</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">regulator_min_uV_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_max_uV_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;constraint not defined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uV</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">max_microvolts</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">regulator_max_uV_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_total_uA_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">uA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">regulator</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">consumer_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">uA</span> <span class="o">+=</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">uA_load</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uA</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">requested_microamps</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">regulator_total_uA_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_num_users_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">use_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_type_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">REGULATOR_VOLTAGE</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;voltage</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">REGULATOR_CURRENT</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;current</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_suspend_mem_uV_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">state_mem</span><span class="p">.</span><span class="n">uV</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">suspend_mem_microvolts</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span>
		<span class="n">regulator_suspend_mem_uV_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_suspend_disk_uV_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">state_disk</span><span class="p">.</span><span class="n">uV</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">suspend_disk_microvolts</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span>
		<span class="n">regulator_suspend_disk_uV_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_suspend_standby_uV_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">state_standby</span><span class="p">.</span><span class="n">uV</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">suspend_standby_microvolts</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span>
		<span class="n">regulator_suspend_standby_uV_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_suspend_mem_mode_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">regulator_print_opmode</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">state_mem</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">suspend_mem_mode</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span>
		<span class="n">regulator_suspend_mem_mode_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_suspend_disk_mode_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">regulator_print_opmode</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">state_disk</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">suspend_disk_mode</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span>
		<span class="n">regulator_suspend_disk_mode_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_suspend_standby_mode_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">regulator_print_opmode</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">state_standby</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">suspend_standby_mode</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span>
		<span class="n">regulator_suspend_standby_mode_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_suspend_mem_state_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">regulator_print_state</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">state_mem</span><span class="p">.</span><span class="n">enabled</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">suspend_mem_state</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span>
		<span class="n">regulator_suspend_mem_state_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_suspend_disk_state_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">regulator_print_state</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">state_disk</span><span class="p">.</span><span class="n">enabled</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">suspend_disk_state</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span>
		<span class="n">regulator_suspend_disk_state_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">regulator_suspend_standby_state_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">regulator_print_state</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">state_standby</span><span class="p">.</span><span class="n">enabled</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">suspend_standby_state</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span>
		<span class="n">regulator_suspend_standby_state_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * These are the only attributes are present for all regulators.</span>
<span class="cm"> * Other attributes are a function of regulator functionality.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">regulator_dev_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">regulator_name_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">num_users</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">regulator_num_users_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">regulator_type_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR_NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">regulator_dev_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="n">regulator_class</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;regulator&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_release</span> <span class="o">=</span> <span class="n">regulator_dev_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_attrs</span> <span class="o">=</span> <span class="n">regulator_dev_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Calculate the new optimum regulator operating mode based on the new total</span>
<span class="cm"> * consumer load. All locks held by caller */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">drms_uA_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">sibling</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">current_uA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">output_uV</span><span class="p">,</span> <span class="n">input_uV</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">regulator_check_drms</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_optimum_mode</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_voltage</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_voltage_sel</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_mode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* get output voltage */</span>
	<span class="n">output_uV</span> <span class="o">=</span> <span class="n">_regulator_get_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">output_uV</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* get input voltage */</span>
	<span class="n">input_uV</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">)</span>
		<span class="n">input_uV</span> <span class="o">=</span> <span class="n">regulator_get_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input_uV</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">input_uV</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">input_uV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input_uV</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* calc total requested load */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sibling</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">consumer_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">current_uA</span> <span class="o">+=</span> <span class="n">sibling</span><span class="o">-&gt;</span><span class="n">uA_load</span><span class="p">;</span>

	<span class="cm">/* now get the optimum mode for our new total regulator load */</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_optimum_mode</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">input_uV</span><span class="p">,</span>
						  <span class="n">output_uV</span><span class="p">,</span> <span class="n">current_uA</span><span class="p">);</span>

	<span class="cm">/* check the new mode is allowed */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">regulator_mode_constrain</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_mode</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">suspend_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">regulator_state</span> <span class="o">*</span><span class="n">rstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If we have no suspend mode configration don&#39;t set anything;</span>
<span class="cm">	 * only warn if the driver implements set_suspend_voltage or</span>
<span class="cm">	 * set_suspend_mode callback.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rstate</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rstate</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_suspend_voltage</span> <span class="o">||</span>
		    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_suspend_mode</span><span class="p">)</span>
			<span class="n">rdev_warn</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;No configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rstate</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="n">rstate</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;invalid configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rstate</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_suspend_enable</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_suspend_enable</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rstate</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_suspend_disable</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_suspend_disable</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">else</span> <span class="cm">/* OK if set_suspend_enable or set_suspend_disable is NULL */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;failed to enabled/disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_suspend_voltage</span> <span class="o">&amp;&amp;</span> <span class="n">rstate</span><span class="o">-&gt;</span><span class="n">uV</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_suspend_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rstate</span><span class="o">-&gt;</span><span class="n">uV</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;failed to set voltage</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_suspend_mode</span> <span class="o">&amp;&amp;</span> <span class="n">rstate</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_suspend_mode</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rstate</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;failed to set mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* locks held by caller */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">suspend_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">suspend_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PM_SUSPEND_STANDBY</span>:
		<span class="k">return</span> <span class="n">suspend_set_state</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">state_standby</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PM_SUSPEND_MEM</span>:
		<span class="k">return</span> <span class="n">suspend_set_state</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">state_mem</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PM_SUSPEND_MAX</span>:
		<span class="k">return</span> <span class="n">suspend_set_state</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">state_disk</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_constraints</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulation_constraints</span> <span class="o">*</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">80</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uV</span> <span class="o">&amp;&amp;</span> <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uV</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uV</span> <span class="o">==</span> <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uV</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="s">&quot;%d mV &quot;</span><span class="p">,</span>
					 <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uV</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="s">&quot;%d &lt;--&gt; %d mV &quot;</span><span class="p">,</span>
					 <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uV</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
					 <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uV</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uV</span> <span class="o">||</span>
	    <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uV</span> <span class="o">!=</span> <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">_regulator_get_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="s">&quot;at %d mV &quot;</span><span class="p">,</span> <span class="n">ret</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">uV_offset</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%dmV offset &quot;</span><span class="p">,</span>
				 <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">uV_offset</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uA</span> <span class="o">&amp;&amp;</span> <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uA</span> <span class="o">==</span> <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uA</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="s">&quot;%d mA &quot;</span><span class="p">,</span>
					 <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uA</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="s">&quot;%d &lt;--&gt; %d mA &quot;</span><span class="p">,</span>
					 <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uA</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
					 <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uA</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uA</span> <span class="o">||</span>
	    <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uA</span> <span class="o">!=</span> <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">_regulator_get_current_limit</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="s">&quot;at %d mA &quot;</span><span class="p">,</span> <span class="n">ret</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">valid_modes_mask</span> <span class="o">&amp;</span> <span class="n">REGULATOR_MODE_FAST</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="s">&quot;fast &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">valid_modes_mask</span> <span class="o">&amp;</span> <span class="n">REGULATOR_MODE_NORMAL</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="s">&quot;normal &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">valid_modes_mask</span> <span class="o">&amp;</span> <span class="n">REGULATOR_MODE_IDLE</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="s">&quot;idle &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">valid_modes_mask</span> <span class="o">&amp;</span> <span class="n">REGULATOR_MODE_STANDBY</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="s">&quot;standby&quot;</span><span class="p">);</span>

	<span class="n">rdev_info</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uV</span> <span class="o">!=</span> <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uV</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">valid_ops_mask</span> <span class="o">&amp;</span> <span class="n">REGULATOR_CHANGE_VOLTAGE</span><span class="p">))</span>
		<span class="n">rdev_warn</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
			  <span class="s">&quot;Voltage range but no REGULATOR_CHANGE_VOLTAGE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">machine_constraints_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">regulation_constraints</span> <span class="o">*</span><span class="n">constraints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* do we need to apply the constraint voltage */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">apply_uV</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uV</span> <span class="o">==</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">_regulator_do_set_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
						<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uV</span><span class="p">,</span>
						<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uV</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;failed to apply %duV constraint</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uV</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* constrain machine-level voltage specs to fit</span>
<span class="cm">	 * the actual range supported by this regulator.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">list_voltage</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">n_voltages</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">count</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">n_voltages</span><span class="p">;</span>
		<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>
		<span class="kt">int</span>	<span class="n">min_uV</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>
		<span class="kt">int</span>	<span class="n">max_uV</span> <span class="o">=</span> <span class="n">INT_MIN</span><span class="p">;</span>
		<span class="kt">int</span>	<span class="n">cmin</span> <span class="o">=</span> <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uV</span><span class="p">;</span>
		<span class="kt">int</span>	<span class="n">cmax</span> <span class="o">=</span> <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uV</span><span class="p">;</span>

		<span class="cm">/* it&#39;s safe to autoconfigure fixed-voltage supplies</span>
<span class="cm">		   and the constraints are used by list_voltage. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cmin</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cmax</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>
			<span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uV</span> <span class="o">=</span> <span class="n">cmin</span><span class="p">;</span>
			<span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uV</span> <span class="o">=</span> <span class="n">cmax</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* voltage constraints are optional */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmax</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* else require explicit machine-level constraints */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmin</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">cmax</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">cmax</span> <span class="o">&lt;</span> <span class="n">cmin</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;invalid voltage constraints</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* initial: [cmin..cmax] valid, [min_uV..max_uV] not */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span>	<span class="n">value</span><span class="p">;</span>

			<span class="n">value</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">list_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* maybe adjust [min_uV..max_uV] */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">cmin</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">min_uV</span><span class="p">)</span>
				<span class="n">min_uV</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="n">cmax</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">max_uV</span><span class="p">)</span>
				<span class="n">max_uV</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* final: [min_uV..max_uV] valid iff constraints valid */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_uV</span> <span class="o">&lt;</span> <span class="n">min_uV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;unsupportable voltage constraints</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* use regulator&#39;s subset of machine constraints */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uV</span> <span class="o">&lt;</span> <span class="n">min_uV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev_dbg</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;override min_uV, %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uV</span><span class="p">,</span> <span class="n">min_uV</span><span class="p">);</span>
			<span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uV</span> <span class="o">=</span> <span class="n">min_uV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uV</span> <span class="o">&gt;</span> <span class="n">max_uV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev_dbg</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;override max_uV, %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uV</span><span class="p">,</span> <span class="n">max_uV</span><span class="p">);</span>
			<span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uV</span> <span class="o">=</span> <span class="n">max_uV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * set_machine_constraints - sets regulator constraints</span>
<span class="cm"> * @rdev: regulator source</span>
<span class="cm"> * @constraints: constraints to apply</span>
<span class="cm"> *</span>
<span class="cm"> * Allows platform initialisation code to define and constrain</span>
<span class="cm"> * regulator circuits e.g. valid voltage/current ranges, etc.  NOTE:</span>
<span class="cm"> * Constraints *must* be set by platform code in order for some</span>
<span class="cm"> * regulator operations to proceed i.e. set_voltage, set_current_limit,</span>
<span class="cm"> * set_mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_machine_constraints</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">regulation_constraints</span> <span class="o">*</span><span class="n">constraints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">constraints</span><span class="p">),</span>
					    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">constraints</span><span class="p">),</span>
					    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">machine_constraints_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* do we need to setup our suspend state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">initial_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">suspend_prepare</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">initial_state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;failed to set suspend state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">initial_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;no set_mode operation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_mode</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">initial_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;failed to set initial mode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If the constraints say the regulator should be on at this point</span>
<span class="cm">	 * and we have control then make sure it is enabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">always_on</span> <span class="o">||</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">boot_on</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;failed to enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">print_constraints</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * set_supply - set regulator supply regulator</span>
<span class="cm"> * @rdev: regulator name</span>
<span class="cm"> * @supply_rdev: supply regulator name</span>
<span class="cm"> *</span>
<span class="cm"> * Called by platform initialisation code to set the supply regulator for this</span>
<span class="cm"> * regulator. This ensures that a regulators supply will also be enabled by the</span>
<span class="cm"> * core if it&#39;s child is enabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_supply</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">supply_rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rdev_info</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;supplied by %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdev_get_name</span><span class="p">(</span><span class="n">supply_rdev</span><span class="p">));</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span> <span class="o">=</span> <span class="n">create_regulator</span><span class="p">(</span><span class="n">supply_rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SUPPLY&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * set_consumer_device_supply - Bind a regulator to a symbolic supply</span>
<span class="cm"> * @rdev:         regulator source</span>
<span class="cm"> * @consumer_dev_name: dev_name() string for device supply applies to</span>
<span class="cm"> * @supply:       symbolic name for supply</span>
<span class="cm"> *</span>
<span class="cm"> * Allows platform initialisation code to map physical regulator</span>
<span class="cm"> * sources to symbolic names for supplies for use by devices.  Devices</span>
<span class="cm"> * should use these symbolic names to request regulators, avoiding the</span>
<span class="cm"> * need to provide board-specific regulator names as platform data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_consumer_device_supply</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">consumer_dev_name</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">supply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_map</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">has_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">supply</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">consumer_dev_name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">has_dev</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">has_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regulator_map_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">dev_name</span> <span class="o">&amp;&amp;</span> <span class="n">consumer_dev_name</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">consumer_dev_name</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">dev_name</span> <span class="o">||</span> <span class="n">consumer_dev_name</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">,</span> <span class="n">supply</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %s/%s is &#39;%s&#39; supply; fail %s/%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">consumer_dev_name</span><span class="p">,</span>
			 <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			 <span class="n">node</span><span class="o">-&gt;</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="n">supply</span><span class="p">,</span>
			 <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">rdev_get_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_map</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">node</span><span class="o">-&gt;</span><span class="n">regulator</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="n">node</span><span class="o">-&gt;</span><span class="n">supply</span> <span class="o">=</span> <span class="n">supply</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">node</span><span class="o">-&gt;</span><span class="n">dev_name</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">consumer_dev_name</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">dev_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regulator_map_list</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unset_regulator_supplies</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_map</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regulator_map_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">regulator</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define REG_STR_SIZE	64</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="nf">create_regulator</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">supply_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">REG_STR_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">regulator</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">regulator</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regulator</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">consumer_list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* create a &#39;requested_microamps_name&#39; sysfs entry */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">REG_STR_SIZE</span><span class="p">,</span>
				 <span class="s">&quot;microamps_requested_%s-%s&quot;</span><span class="p">,</span>
				 <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">supply_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">REG_STR_SIZE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">overflow_err</span><span class="p">;</span>

		<span class="n">regulator</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">sysfs_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
		<span class="n">regulator</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">attr_name_err</span><span class="p">;</span>

		<span class="n">regulator</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mo">0444</span><span class="p">;</span>
		<span class="n">regulator</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">device_requested_uA_show</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev_warn</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;could not add regulator_dev requested microamps sysfs entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">attr_name_err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* also add a link to the device sysfs entry */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">REG_STR_SIZE</span><span class="p">,</span> <span class="s">&quot;%s-%s&quot;</span><span class="p">,</span>
				 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">supply_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">REG_STR_SIZE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">attr_err</span><span class="p">;</span>

		<span class="n">regulator</span><span class="o">-&gt;</span><span class="n">supply_name</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">supply_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">attr_err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
					<span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev_warn</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;could not add device link %s err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">link_name_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">regulator</span><span class="o">-&gt;</span><span class="n">supply_name</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">supply_name</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">supply_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">attr_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">regulator</span><span class="o">-&gt;</span><span class="n">debugfs</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">supply_name</span><span class="p">,</span>
						<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev_warn</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;Failed to create debugfs directory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">debugfs_create_u32</span><span class="p">(</span><span class="s">&quot;uA_load&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">uA_load</span><span class="p">);</span>
		<span class="n">debugfs_create_u32</span><span class="p">(</span><span class="s">&quot;min_uV&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">min_uV</span><span class="p">);</span>
		<span class="n">debugfs_create_u32</span><span class="p">(</span><span class="s">&quot;max_uV&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">max_uV</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check now if the regulator is an always on regulator - if</span>
<span class="cm">	 * it is then we don&#39;t need to do nearly so much work for</span>
<span class="cm">	 * enable/disable calls.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_regulator_can_change_status</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">_regulator_is_enabled</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
		<span class="n">regulator</span><span class="o">-&gt;</span><span class="n">always_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">regulator</span><span class="p">;</span>
<span class="nl">link_name_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">supply_name</span><span class="p">);</span>
<span class="nl">attr_err:</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">);</span>
<span class="nl">attr_name_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
<span class="nl">overflow_err:</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">regulator</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_regulator_get_enable_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable_time</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable_time</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="nf">regulator_dev_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">supply</span><span class="p">,</span>
						  <span class="kt">int</span> <span class="o">*</span><span class="n">ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator_map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">devname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* first do a dt based lookup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">of_get_regulator</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">supply</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regulator_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">&amp;&amp;</span>
					<span class="n">node</span> <span class="o">==</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If we couldn&#39;t even get the node then it&#39;s</span>
<span class="cm">			 * not just that the device didn&#39;t register</span>
<span class="cm">			 * yet, there&#39;s no node and we&#39;ll never</span>
<span class="cm">			 * succeed.</span>
<span class="cm">			 */</span>
			<span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* if not found, try doing it non-dt way */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">devname</span> <span class="o">=</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regulator_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">rdev_get_name</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">supply</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regulator_map_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If the mapping has a device set up it must match */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dev_name</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">devname</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">devname</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">,</span> <span class="n">supply</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">regulator</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Internal regulator request function */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="nf">_regulator_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">exclusive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">devname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;get() with no identifier</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">regulator</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">devname</span> <span class="o">=</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_list_mutex</span><span class="p">);</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">regulator_dev_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">board_wants_dummy_regulator</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">dummy_regulator_rdev</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_REGULATOR_DUMMY</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devname</span><span class="p">)</span>
		<span class="n">devname</span> <span class="o">=</span> <span class="s">&quot;deviceless&quot;</span><span class="p">;</span>

	<span class="cm">/* If the board didn&#39;t flag that it was fully constrained then</span>
<span class="cm">	 * substitute in a dummy regulator so consumers can continue.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_full_constraints</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s supply %s not found, using dummy regulator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">devname</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="n">rdev</span> <span class="o">=</span> <span class="n">dummy_regulator_rdev</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_list_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">regulator</span><span class="p">;</span>

<span class="nl">found:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">exclusive</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regulator</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EPERM</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">exclusive</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">open_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regulator</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">regulator</span> <span class="o">=</span> <span class="n">create_regulator</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regulator</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regulator</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">open_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exclusive</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">exclusive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">_regulator_is_enabled</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_list_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">regulator</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_get - lookup and obtain a reference to a regulator.</span>
<span class="cm"> * @dev: device for regulator &quot;consumer&quot;</span>
<span class="cm"> * @id: Supply name or regulator ID.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a struct regulator corresponding to the regulator producer,</span>
<span class="cm"> * or IS_ERR() condition containing errno.</span>
<span class="cm"> *</span>
<span class="cm"> * Use of supply names configured via regulator_set_device_supply() is</span>
<span class="cm"> * strongly encouraged.  It is recommended that the supply name used</span>
<span class="cm"> * should match the name used for the supply and/or the relevant</span>
<span class="cm"> * device pins in the datasheet.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="nf">regulator_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_regulator_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_get</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">devm_regulator_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">regulator_put</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">**</span><span class="p">)</span><span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * devm_regulator_get - Resource managed regulator_get()</span>
<span class="cm"> * @dev: device for regulator &quot;consumer&quot;</span>
<span class="cm"> * @id: Supply name or regulator ID.</span>
<span class="cm"> *</span>
<span class="cm"> * Managed regulator_get(). Regulators returned from this function are</span>
<span class="cm"> * automatically regulator_put() on driver detach. See regulator_get() for more</span>
<span class="cm"> * information.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="nf">devm_regulator_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator</span> <span class="o">**</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">regulator</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">devres_alloc</span><span class="p">(</span><span class="n">devm_regulator_release</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">regulator</span> <span class="o">=</span> <span class="n">regulator_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">regulator</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">regulator</span><span class="p">;</span>
		<span class="n">devres_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devres_free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">regulator</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">devm_regulator_get</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_get_exclusive - obtain exclusive access to a regulator.</span>
<span class="cm"> * @dev: device for regulator &quot;consumer&quot;</span>
<span class="cm"> * @id: Supply name or regulator ID.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a struct regulator corresponding to the regulator producer,</span>
<span class="cm"> * or IS_ERR() condition containing errno.  Other consumers will be</span>
<span class="cm"> * unable to obtain this reference is held and the use count for the</span>
<span class="cm"> * regulator will be initialised to reflect the current state of the</span>
<span class="cm"> * regulator.</span>
<span class="cm"> *</span>
<span class="cm"> * This is intended for use by consumers which cannot tolerate shared</span>
<span class="cm"> * use of the regulator such as those which need to force the</span>
<span class="cm"> * regulator off for correct operation of the hardware they are</span>
<span class="cm"> * controlling.</span>
<span class="cm"> *</span>
<span class="cm"> * Use of supply names configured via regulator_set_device_supply() is</span>
<span class="cm"> * strongly encouraged.  It is recommended that the supply name used</span>
<span class="cm"> * should match the name used for the supply and/or the relevant</span>
<span class="cm"> * device pins in the datasheet.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="nf">regulator_get_exclusive</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_regulator_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_get_exclusive</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_put - &quot;free&quot; the regulator source</span>
<span class="cm"> * @regulator: regulator source</span>
<span class="cm"> *</span>
<span class="cm"> * Note: drivers must ensure that all regulator_enable calls made on this</span>
<span class="cm"> * regulator source are balanced by regulator_disable calls prior to calling</span>
<span class="cm"> * this function.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">regulator_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regulator</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">regulator</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_list_mutex</span><span class="p">);</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">);</span>

	<span class="cm">/* remove any sysfs entries */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">supply_name</span><span class="p">);</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">supply_name</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">regulator</span><span class="p">);</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">open_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">exclusive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">module_put</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_list_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_put</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">devm_regulator_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator</span> <span class="o">**</span><span class="n">r</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span> <span class="o">||</span> <span class="o">!*</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">r</span> <span class="o">||</span> <span class="o">!*</span><span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">r</span> <span class="o">==</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * devm_regulator_put - Resource managed regulator_put()</span>
<span class="cm"> * @regulator: regulator to free</span>
<span class="cm"> *</span>
<span class="cm"> * Deallocate a regulator allocated with devm_regulator_get(). Normally</span>
<span class="cm"> * this function will not need to be called and the resource management</span>
<span class="cm"> * code will ensure that the resource is freed.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">devm_regulator_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">devres_destroy</span><span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">devm_regulator_release</span><span class="p">,</span>
			    <span class="n">devm_regulator_match</span><span class="p">,</span> <span class="n">regulator</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">regulator_put</span><span class="p">(</span><span class="n">regulator</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">devm_regulator_put</span><span class="p">);</span>

<span class="cm">/* locks held by regulator_enable() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_regulator_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">delay</span><span class="p">;</span>

	<span class="cm">/* check voltage and requested load before enabling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">valid_ops_mask</span> <span class="o">&amp;</span> <span class="n">REGULATOR_CHANGE_DRMS</span><span class="p">))</span>
		<span class="n">drms_uA_update</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The regulator may on if it&#39;s not switchable or left on */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">_regulator_is_enabled</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_regulator_can_change_status</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="cm">/* Query before enabling in case configuration</span>
<span class="cm">			 * dependent.  */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">_regulator_get_enable_time</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">delay</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rdev_warn</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;enable_time() failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">ret</span><span class="p">);</span>
				<span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">trace_regulator_enable</span><span class="p">(</span><span class="n">rdev_get_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>

			<span class="cm">/* Allow the regulator to ramp; it would be useful</span>
<span class="cm">			 * to extend this for bulk operations so that the</span>
<span class="cm">			 * regulators can ramp together.  */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">trace_regulator_enable_delay</span><span class="p">(</span><span class="n">rdev_get_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="n">delay</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
				<span class="n">udelay</span><span class="p">(</span><span class="n">delay</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">udelay</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">trace_regulator_enable_complete</span><span class="p">(</span><span class="n">rdev_get_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;is_enabled() failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Fallthrough on positive return values - already enabled */</span>
	<span class="p">}</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">use_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_enable - enable regulator output</span>
<span class="cm"> * @regulator: regulator source</span>
<span class="cm"> *</span>
<span class="cm"> * Request that the regulator be enabled with the regulator output at</span>
<span class="cm"> * the predefined voltage or current value.  Calls to regulator_enable()</span>
<span class="cm"> * must be balanced with calls to regulator_disable().</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: the output value can be set by other drivers, boot loader or may be</span>
<span class="cm"> * hardwired in the regulator.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">always_on</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_enable</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">_regulator_enable</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">)</span>
		<span class="n">regulator_disable</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_enable</span><span class="p">);</span>

<span class="cm">/* locks held by regulator_disable() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_regulator_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span>
		 <span class="s">&quot;unbalanced disables for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdev_get_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* are we the last user and permitted to disable ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">always_on</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* we are last user */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_regulator_can_change_status</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">trace_regulator_disable</span><span class="p">(</span><span class="n">rdev_get_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;failed to disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">trace_regulator_disable_complete</span><span class="p">(</span><span class="n">rdev_get_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>

			<span class="n">_notifier_call_chain</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">REGULATOR_EVENT_DISABLE</span><span class="p">,</span>
					     <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">valid_ops_mask</span> <span class="o">&amp;</span>
			<span class="n">REGULATOR_CHANGE_DRMS</span><span class="p">))</span>
			<span class="n">drms_uA_update</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">use_count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_disable - disable regulator output</span>
<span class="cm"> * @regulator: regulator source</span>
<span class="cm"> *</span>
<span class="cm"> * Disable the regulator output voltage or current.  Calls to</span>
<span class="cm"> * regulator_enable() must be balanced with calls to</span>
<span class="cm"> * regulator_disable().</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: this will only disable the regulator output if no other consumer</span>
<span class="cm"> * devices have it enabled, the regulator device supports disabling and</span>
<span class="cm"> * machine constraints permit this operation.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">always_on</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">_regulator_disable</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">)</span>
		<span class="n">regulator_disable</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_disable</span><span class="p">);</span>

<span class="cm">/* locks held by regulator_force_disable() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_regulator_force_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* force disable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ah well, who wants to live forever... */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;failed to force disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* notify other consumers that power has been forced off */</span>
		<span class="n">_notifier_call_chain</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">REGULATOR_EVENT_FORCE_DISABLE</span> <span class="o">|</span>
			<span class="n">REGULATOR_EVENT_DISABLE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_force_disable - force disable regulator output</span>
<span class="cm"> * @regulator: regulator source</span>
<span class="cm"> *</span>
<span class="cm"> * Forcibly disable the regulator output voltage or current.</span>
<span class="cm"> * NOTE: this *will* disable the regulator output even if other consumer</span>
<span class="cm"> * devices have it enabled. This should be used for situations when device</span>
<span class="cm"> * damage will likely occur if the regulator is not disabled (e.g. over temp).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_force_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">regulator</span><span class="o">-&gt;</span><span class="n">uA_load</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">_regulator_force_disable</span><span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">)</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">open_count</span><span class="o">--</span><span class="p">)</span>
			<span class="n">regulator_disable</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_force_disable</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">regulator_disable_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">regulator_dev</span><span class="p">,</span>
						  <span class="n">disable_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">deferred_disables</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">deferred_disables</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">deferred_disables</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">_regulator_disable</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;Deferred disable failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_disable</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
					 <span class="s">&quot;Supply disable failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_disable_deferred - disable regulator output with delay</span>
<span class="cm"> * @regulator: regulator source</span>
<span class="cm"> * @ms: miliseconds until the regulator is disabled</span>
<span class="cm"> *</span>
<span class="cm"> * Execute regulator_disable() on the regulator after a delay.  This</span>
<span class="cm"> * is intended for use with devices that require some time to quiesce.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: this will only disable the regulator output if no other consumer</span>
<span class="cm"> * devices have it enabled, the regulator device supports disabling and</span>
<span class="cm"> * machine constraints permit this operation.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_disable_deferred</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">always_on</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">deferred_disables</span><span class="o">++</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">disable_work</span><span class="p">,</span>
				    <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ms</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_disable_deferred</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_is_enabled_regmap - standard is_enabled() for regmap users</span>
<span class="cm"> *</span>
<span class="cm"> * @rdev: regulator to operate on</span>
<span class="cm"> *</span>
<span class="cm"> * Regulators that use regmap for their register I/O can set the</span>
<span class="cm"> * enable_reg and enable_mask fields in their descriptor and then use</span>
<span class="cm"> * this as their is_enabled operation, saving some code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_is_enabled_regmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regmap_read</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">enable_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">enable_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_is_enabled_regmap</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_enable_regmap - standard enable() for regmap users</span>
<span class="cm"> *</span>
<span class="cm"> * @rdev: regulator to operate on</span>
<span class="cm"> *</span>
<span class="cm"> * Regulators that use regmap for their register I/O can set the</span>
<span class="cm"> * enable_reg and enable_mask fields in their descriptor and then use</span>
<span class="cm"> * this as their enable() operation, saving some code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_enable_regmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">regmap_update_bits</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">enable_reg</span><span class="p">,</span>
				  <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">enable_mask</span><span class="p">,</span>
				  <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">enable_mask</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_enable_regmap</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_disable_regmap - standard disable() for regmap users</span>
<span class="cm"> *</span>
<span class="cm"> * @rdev: regulator to operate on</span>
<span class="cm"> *</span>
<span class="cm"> * Regulators that use regmap for their register I/O can set the</span>
<span class="cm"> * enable_reg and enable_mask fields in their descriptor and then use</span>
<span class="cm"> * this as their disable() operation, saving some code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_disable_regmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">regmap_update_bits</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">enable_reg</span><span class="p">,</span>
				  <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">enable_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_disable_regmap</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_regulator_is_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If we don&#39;t know then assume that the regulator is always on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">is_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">is_enabled</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_is_enabled - is the regulator output enabled</span>
<span class="cm"> * @regulator: regulator source</span>
<span class="cm"> *</span>
<span class="cm"> * Returns positive if the regulator driver backing the source/client</span>
<span class="cm"> * has requested that the device be enabled, zero if it hasn&#39;t, else a</span>
<span class="cm"> * negative errno code.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that the device backing this regulator handle can have multiple</span>
<span class="cm"> * users, so it might be enabled even if regulator_enable() was never</span>
<span class="cm"> * called for this particular source.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_is_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">always_on</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">_regulator_is_enabled</span><span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_is_enabled</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_count_voltages - count regulator_list_voltage() selectors</span>
<span class="cm"> * @regulator: regulator source</span>
<span class="cm"> *</span>
<span class="cm"> * Returns number of selectors, or negative errno.  Selectors are</span>
<span class="cm"> * numbered starting at zero, and typically correspond to bitfields</span>
<span class="cm"> * in hardware registers.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_count_voltages</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span>	<span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">n_voltages</span> <span class="o">?</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_count_voltages</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_list_voltage_linear - List voltages with simple calculation</span>
<span class="cm"> *</span>
<span class="cm"> * @rdev: Regulator device</span>
<span class="cm"> * @selector: Selector to convert into a voltage</span>
<span class="cm"> *</span>
<span class="cm"> * Regulators with a simple linear mapping between voltages and</span>
<span class="cm"> * selectors can set min_uV and uV_step in the regulator descriptor</span>
<span class="cm"> * and then use this function as their list_voltage() operation,</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_list_voltage_linear</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">selector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">selector</span> <span class="o">&gt;=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">n_voltages</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">min_uV</span> <span class="o">+</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">uV_step</span> <span class="o">*</span> <span class="n">selector</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_list_voltage_linear</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_list_voltage - enumerate supported voltages</span>
<span class="cm"> * @regulator: regulator source</span>
<span class="cm"> * @selector: identify voltage to list</span>
<span class="cm"> * Context: can sleep</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a voltage that can be passed to @regulator_set_voltage(),</span>
<span class="cm"> * zero if this selector code can&#39;t be used on this system, or a</span>
<span class="cm"> * negative errno.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_list_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">selector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span>	<span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator_ops</span>	<span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">list_voltage</span> <span class="o">||</span> <span class="n">selector</span> <span class="o">&gt;=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">n_voltages</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">list_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">selector</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">min_uV</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">max_uV</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_list_voltage</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_is_supported_voltage - check if a voltage range can be supported</span>
<span class="cm"> *</span>
<span class="cm"> * @regulator: Regulator to check.</span>
<span class="cm"> * @min_uV: Minimum required voltage in uV.</span>
<span class="cm"> * @max_uV: Maximum required voltage in uV.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a boolean or a negative error code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_is_supported_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">min_uV</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_uV</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">voltages</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_count_voltages</span><span class="p">(</span><span class="n">regulator</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">voltages</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">voltages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_list_voltage</span><span class="p">(</span><span class="n">regulator</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="n">min_uV</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">&lt;=</span> <span class="n">max_uV</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_is_supported_voltage</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_get_voltage_sel_regmap - standard get_voltage_sel for regmap users</span>
<span class="cm"> *</span>
<span class="cm"> * @rdev: regulator to operate on</span>
<span class="cm"> *</span>
<span class="cm"> * Regulators that use regmap for their register I/O can set the</span>
<span class="cm"> * vsel_reg and vsel_mask fields in their descriptor and then use this</span>
<span class="cm"> * as their get_voltage_vsel operation, saving some code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_get_voltage_sel_regmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regmap_read</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">vsel_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">vsel_mask</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">&gt;&gt;=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">vsel_mask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_get_voltage_sel_regmap</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_set_voltage_sel_regmap - standard set_voltage_sel for regmap users</span>
<span class="cm"> *</span>
<span class="cm"> * @rdev: regulator to operate on</span>
<span class="cm"> * @sel: Selector to set</span>
<span class="cm"> *</span>
<span class="cm"> * Regulators that use regmap for their register I/O can set the</span>
<span class="cm"> * vsel_reg and vsel_mask fields in their descriptor and then use this</span>
<span class="cm"> * as their set_voltage_vsel operation, saving some code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_set_voltage_sel_regmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sel</span> <span class="o">&lt;&lt;=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">vsel_mask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">regmap_update_bits</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">vsel_reg</span><span class="p">,</span>
				  <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">vsel_mask</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_set_voltage_sel_regmap</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_map_voltage_iterate - map_voltage() based on list_voltage()</span>
<span class="cm"> *</span>
<span class="cm"> * @rdev: Regulator to operate on</span>
<span class="cm"> * @min_uV: Lower bound for voltage</span>
<span class="cm"> * @max_uV: Upper bound for voltage</span>
<span class="cm"> *</span>
<span class="cm"> * Drivers implementing set_voltage_sel() and list_voltage() can use</span>
<span class="cm"> * this as their map_voltage() operation.  It will find a suitable</span>
<span class="cm"> * voltage by calling list_voltage() until it gets something in bounds</span>
<span class="cm"> * for the requested voltages.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_map_voltage_iterate</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">min_uV</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_uV</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">best_val</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">selector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Find the smallest voltage that falls within the specified</span>
<span class="cm">	 * range.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">n_voltages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">list_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="n">best_val</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">&gt;=</span> <span class="n">min_uV</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">&lt;=</span> <span class="n">max_uV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">best_val</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">selector</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">best_val</span> <span class="o">!=</span> <span class="n">INT_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">selector</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_map_voltage_iterate</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_map_voltage_linear - map_voltage() for simple linear mappings</span>
<span class="cm"> *</span>
<span class="cm"> * @rdev: Regulator to operate on</span>
<span class="cm"> * @min_uV: Lower bound for voltage</span>
<span class="cm"> * @max_uV: Upper bound for voltage</span>
<span class="cm"> *</span>
<span class="cm"> * Drivers providing min_uV and uV_step in their regulator_desc can</span>
<span class="cm"> * use this as their map_voltage() operation.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_map_voltage_linear</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">min_uV</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_uV</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">voltage</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">uV_step</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">uV_step</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">min_uV</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">min_uV</span><span class="p">)</span>
		<span class="n">min_uV</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">min_uV</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">min_uV</span> <span class="o">-</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">min_uV</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">uV_step</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Map back into a voltage to verify we&#39;re still in bounds */</span>
	<span class="n">voltage</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">list_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voltage</span> <span class="o">&lt;</span> <span class="n">min_uV</span> <span class="o">||</span> <span class="n">voltage</span> <span class="o">&gt;</span> <span class="n">max_uV</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_map_voltage_linear</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_regulator_do_set_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">min_uV</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_uV</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">best_val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">selector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_selector</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">trace_regulator_set_voltage</span><span class="p">(</span><span class="n">rdev_get_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span> <span class="n">min_uV</span><span class="p">,</span> <span class="n">max_uV</span><span class="p">);</span>

	<span class="n">min_uV</span> <span class="o">+=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">uV_offset</span><span class="p">;</span>
	<span class="n">max_uV</span> <span class="o">+=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">uV_offset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we can&#39;t obtain the old selector there is not enough</span>
<span class="cm">	 * info to call set_voltage_time_sel().</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage_time_sel</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_voltage_sel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">old_selector</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_voltage_sel</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_selector</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">old_selector</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">min_uV</span><span class="p">,</span> <span class="n">max_uV</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">selector</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage_sel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">map_voltage</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">map_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">min_uV</span><span class="p">,</span>
							   <span class="n">max_uV</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_map_voltage_iterate</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">min_uV</span><span class="p">,</span>
							    <span class="n">max_uV</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">selector</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage_sel</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">list_voltage</span><span class="p">)</span>
		<span class="n">best_val</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">list_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">selector</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">best_val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Call set_voltage_time_sel if successfully obtained old_selector */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">old_selector</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage_time_sel</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">delay</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage_time_sel</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
						<span class="n">old_selector</span><span class="p">,</span> <span class="n">selector</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev_warn</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;set_voltage_time_sel() failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">delay</span><span class="p">);</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Insert any necessary delays */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="n">delay</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">delay</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">_notifier_call_chain</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">REGULATOR_EVENT_VOLTAGE_CHANGE</span><span class="p">,</span>
				     <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">trace_regulator_set_voltage_complete</span><span class="p">(</span><span class="n">rdev_get_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span> <span class="n">best_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_set_voltage - set regulator output voltage</span>
<span class="cm"> * @regulator: regulator source</span>
<span class="cm"> * @min_uV: Minimum required voltage in uV</span>
<span class="cm"> * @max_uV: Maximum acceptable voltage in uV</span>
<span class="cm"> *</span>
<span class="cm"> * Sets a voltage regulator to the desired output voltage. This can be set</span>
<span class="cm"> * during any regulator state. IOW, regulator can be disabled or enabled.</span>
<span class="cm"> *</span>
<span class="cm"> * If the regulator is enabled then the voltage will change to the new value</span>
<span class="cm"> * immediately otherwise if the regulator is disabled the regulator will</span>
<span class="cm"> * output at the new voltage when enabled.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: If the regulator is shared between several devices then the lowest</span>
<span class="cm"> * request voltage that meets the system constraints will be used.</span>
<span class="cm"> * Regulator system constraints must be set for this regulator before</span>
<span class="cm"> * calling this function otherwise this call will fail.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_set_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">,</span> <span class="kt">int</span> <span class="n">min_uV</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_uV</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* If we&#39;re setting the same range as last time the change</span>
<span class="cm">	 * should be a noop (some cpufreq implementations use the same</span>
<span class="cm">	 * voltage for multiple frequencies, for example).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">min_uV</span> <span class="o">==</span> <span class="n">min_uV</span> <span class="o">&amp;&amp;</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">max_uV</span> <span class="o">==</span> <span class="n">max_uV</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage_sel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* constraints check */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_check_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min_uV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_uV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">regulator</span><span class="o">-&gt;</span><span class="n">min_uV</span> <span class="o">=</span> <span class="n">min_uV</span><span class="p">;</span>
	<span class="n">regulator</span><span class="o">-&gt;</span><span class="n">max_uV</span> <span class="o">=</span> <span class="n">max_uV</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_check_consumers</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min_uV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_uV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_regulator_do_set_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">min_uV</span><span class="p">,</span> <span class="n">max_uV</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_set_voltage</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_set_voltage_time - get raise/fall time</span>
<span class="cm"> * @regulator: regulator source</span>
<span class="cm"> * @old_uV: starting voltage in microvolts</span>
<span class="cm"> * @new_uV: target voltage in microvolts</span>
<span class="cm"> *</span>
<span class="cm"> * Provided with the starting and ending voltage, this function attempts to</span>
<span class="cm"> * calculate the time in microseconds required to rise or fall to this new</span>
<span class="cm"> * voltage.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_set_voltage_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">old_uV</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_uV</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span>	<span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator_ops</span>	<span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_sel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_sel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">voltage</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Currently requires operations to do this */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">list_voltage</span> <span class="o">||</span> <span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage_time_sel</span>
	    <span class="o">||</span> <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">n_voltages</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">n_voltages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We only look for exact voltage matches here */</span>
		<span class="n">voltage</span> <span class="o">=</span> <span class="n">regulator_list_voltage</span><span class="p">(</span><span class="n">regulator</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">voltage</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">voltage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">voltage</span> <span class="o">==</span> <span class="n">old_uV</span><span class="p">)</span>
			<span class="n">old_sel</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">voltage</span> <span class="o">==</span> <span class="n">new_uV</span><span class="p">)</span>
			<span class="n">new_sel</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_sel</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">new_sel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage_time_sel</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">old_sel</span><span class="p">,</span> <span class="n">new_sel</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_set_voltage_time</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_sync_voltage - re-apply last regulator output voltage</span>
<span class="cm"> * @regulator: regulator source</span>
<span class="cm"> *</span>
<span class="cm"> * Re-apply the last configured voltage.  This is intended to be used</span>
<span class="cm"> * where some external control source the consumer is cooperating with</span>
<span class="cm"> * has caused the configured voltage to change.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_sync_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">min_uV</span><span class="p">,</span> <span class="n">max_uV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage_sel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This is only going to work if we&#39;ve had a voltage configured. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">min_uV</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">max_uV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">min_uV</span> <span class="o">=</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">min_uV</span><span class="p">;</span>
	<span class="n">max_uV</span> <span class="o">=</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">max_uV</span><span class="p">;</span>

	<span class="cm">/* This should be a paranoia check... */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_check_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min_uV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_uV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_check_consumers</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min_uV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_uV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_regulator_do_set_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">min_uV</span><span class="p">,</span> <span class="n">max_uV</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_sync_voltage</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_regulator_get_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sel</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_voltage_sel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sel</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_voltage_sel</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">sel</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">list_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_voltage</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">-</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">uV_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_get_voltage - get regulator output voltage</span>
<span class="cm"> * @regulator: regulator source</span>
<span class="cm"> *</span>
<span class="cm"> * This returns the current regulator voltage in uV.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: If the regulator is disabled it will return the voltage value. This</span>
<span class="cm"> * function should not be used to determine regulator state.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_get_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_regulator_get_voltage</span><span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_get_voltage</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_set_current_limit - set regulator output current limit</span>
<span class="cm"> * @regulator: regulator source</span>
<span class="cm"> * @min_uA: Minimuum supported current in uA</span>
<span class="cm"> * @max_uA: Maximum supported current in uA</span>
<span class="cm"> *</span>
<span class="cm"> * Sets current sink to the desired output current. This can be set during</span>
<span class="cm"> * any regulator state. IOW, regulator can be disabled or enabled.</span>
<span class="cm"> *</span>
<span class="cm"> * If the regulator is enabled then the current will change to the new value</span>
<span class="cm"> * immediately otherwise if the regulator is disabled the regulator will</span>
<span class="cm"> * output at the new current when enabled.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: Regulator system constraints must be set for this regulator before</span>
<span class="cm"> * calling this function otherwise this call will fail.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_set_current_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">min_uA</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_uA</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_current_limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* constraints check */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_check_current_limit</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min_uA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_uA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_current_limit</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">min_uA</span><span class="p">,</span> <span class="n">max_uA</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_set_current_limit</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_regulator_get_current_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_current_limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_current_limit</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_get_current_limit - get regulator output current</span>
<span class="cm"> * @regulator: regulator source</span>
<span class="cm"> *</span>
<span class="cm"> * This returns the current supplied by the specified current sink in uA.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: If the regulator is disabled it will return the current value. This</span>
<span class="cm"> * function should not be used to determine regulator state.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_get_current_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_regulator_get_current_limit</span><span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_get_current_limit</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_set_mode - set regulator operating mode</span>
<span class="cm"> * @regulator: regulator source</span>
<span class="cm"> * @mode: operating mode - one of the REGULATOR_MODE constants</span>
<span class="cm"> *</span>
<span class="cm"> * Set regulator operating mode to increase regulator efficiency or improve</span>
<span class="cm"> * regulation performance.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: Regulator system constraints must be set for this regulator before</span>
<span class="cm"> * calling this function otherwise this call will fail.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">regulator_curr_mode</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* return if the same mode is requested */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regulator_curr_mode</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_mode</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regulator_curr_mode</span> <span class="o">==</span> <span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* constraints check */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_mode_constrain</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_mode</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_set_mode</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">_regulator_get_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_mode</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_get_mode - get regulator operating mode</span>
<span class="cm"> * @regulator: regulator source</span>
<span class="cm"> *</span>
<span class="cm"> * Get the current regulator operating mode.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">regulator_get_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_regulator_get_mode</span><span class="p">(</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_get_mode</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_set_optimum_mode - set regulator optimum operating mode</span>
<span class="cm"> * @regulator: regulator source</span>
<span class="cm"> * @uA_load: load current</span>
<span class="cm"> *</span>
<span class="cm"> * Notifies the regulator core of a new device load. This is then used by</span>
<span class="cm"> * DRMS (if enabled by constraints) to set the most efficient regulator</span>
<span class="cm"> * operating mode for the new regulator loading.</span>
<span class="cm"> *</span>
<span class="cm"> * Consumer devices notify their supply regulator of the maximum power</span>
<span class="cm"> * they will require (can be taken from device datasheet in the power</span>
<span class="cm"> * consumption tables) when they change operational status and hence power</span>
<span class="cm"> * state. Examples of operational state changes that can affect power</span>
<span class="cm"> * consumption are :-</span>
<span class="cm"> *</span>
<span class="cm"> *    o Device is opened / closed.</span>
<span class="cm"> *    o Device I/O is about to begin or has just finished.</span>
<span class="cm"> *    o Device is idling in between work.</span>
<span class="cm"> *</span>
<span class="cm"> * This information is also exported via sysfs to userspace.</span>
<span class="cm"> *</span>
<span class="cm"> * DRMS will sum the total requested load on the regulator and change</span>
<span class="cm"> * to the most efficient operating mode if platform constraints allow.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the new regulator mode or error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_set_optimum_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">,</span> <span class="kt">int</span> <span class="n">uA_load</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">consumer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">output_uV</span><span class="p">,</span> <span class="n">input_uV</span><span class="p">,</span> <span class="n">total_uA_load</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * first check to see if we can set modes at all, otherwise just</span>
<span class="cm">	 * tell the consumer everything is OK.</span>
<span class="cm">	 */</span>
	<span class="n">regulator</span><span class="o">-&gt;</span><span class="n">uA_load</span> <span class="o">=</span> <span class="n">uA_load</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_check_drms</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_optimum_mode</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * we can actually do this so any errors are indicators of</span>
<span class="cm">	 * potential real failure.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_mode</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* get output voltage */</span>
	<span class="n">output_uV</span> <span class="o">=</span> <span class="n">_regulator_get_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">output_uV</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;invalid output voltage found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get input voltage */</span>
	<span class="n">input_uV</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">)</span>
		<span class="n">input_uV</span> <span class="o">=</span> <span class="n">regulator_get_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input_uV</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">input_uV</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">input_uV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input_uV</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;invalid input voltage found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* calc total requested load for this regulator */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">consumer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">consumer_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">total_uA_load</span> <span class="o">+=</span> <span class="n">consumer</span><span class="o">-&gt;</span><span class="n">uA_load</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_optimum_mode</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
						 <span class="n">input_uV</span><span class="p">,</span> <span class="n">output_uV</span><span class="p">,</span>
						 <span class="n">total_uA_load</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_mode_constrain</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;failed to get optimum mode @ %d uA %d -&gt; %d uV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">total_uA_load</span><span class="p">,</span> <span class="n">input_uV</span><span class="p">,</span> <span class="n">output_uV</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_mode</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;failed to set optimum mode %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_set_optimum_mode</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_register_notifier - register regulator event notifier</span>
<span class="cm"> * @regulator: regulator source</span>
<span class="cm"> * @nb: notifier block</span>
<span class="cm"> *</span>
<span class="cm"> * Register notifier block to receive regulator events.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_register_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">blocking_notifier_chain_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">notifier</span><span class="p">,</span>
						<span class="n">nb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_register_notifier</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_unregister_notifier - unregister regulator event notifier</span>
<span class="cm"> * @regulator: regulator source</span>
<span class="cm"> * @nb: notifier block</span>
<span class="cm"> *</span>
<span class="cm"> * Unregister regulator event notifier block.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_unregister_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">blocking_notifier_chain_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">notifier</span><span class="p">,</span>
						  <span class="n">nb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_unregister_notifier</span><span class="p">);</span>

<span class="cm">/* notify regulator consumers and downstream regulator consumers.</span>
<span class="cm"> * Note mutex must be held by caller.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_notifier_call_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* call rdev chain first */</span>
	<span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">notifier</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_bulk_get - get multiple regulator consumers</span>
<span class="cm"> *</span>
<span class="cm"> * @dev:           Device to supply</span>
<span class="cm"> * @num_consumers: Number of consumers to register</span>
<span class="cm"> * @consumers:     Configuration of consumers; clients are stored here.</span>
<span class="cm"> *</span>
<span class="cm"> * @return 0 on success, an errno on failure.</span>
<span class="cm"> *</span>
<span class="cm"> * This helper function allows drivers to get several regulator</span>
<span class="cm"> * consumers in one operation.  If any of the regulators cannot be</span>
<span class="cm"> * acquired then any regulators that were allocated will be freed</span>
<span class="cm"> * before returning to the caller.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_bulk_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_consumers</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">regulator_bulk_data</span> <span class="o">*</span><span class="n">consumers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_consumers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_consumers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span> <span class="o">=</span> <span class="n">regulator_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						      <span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">supply</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span><span class="p">);</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to get supply &#39;%s&#39;: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">supply</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">regulator_put</span><span class="p">(</span><span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_bulk_get</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * devm_regulator_bulk_get - managed get multiple regulator consumers</span>
<span class="cm"> *</span>
<span class="cm"> * @dev:           Device to supply</span>
<span class="cm"> * @num_consumers: Number of consumers to register</span>
<span class="cm"> * @consumers:     Configuration of consumers; clients are stored here.</span>
<span class="cm"> *</span>
<span class="cm"> * @return 0 on success, an errno on failure.</span>
<span class="cm"> *</span>
<span class="cm"> * This helper function allows drivers to get several regulator</span>
<span class="cm"> * consumers in one operation with management, the regulators will</span>
<span class="cm"> * automatically be freed when the device is unbound.  If any of the</span>
<span class="cm"> * regulators cannot be acquired then any regulators that were</span>
<span class="cm"> * allocated will be freed before returning to the caller.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">devm_regulator_bulk_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_consumers</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">regulator_bulk_data</span> <span class="o">*</span><span class="n">consumers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_consumers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_consumers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span> <span class="o">=</span> <span class="n">devm_regulator_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							   <span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">supply</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span><span class="p">);</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to get supply &#39;%s&#39;: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">supply</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_consumers</span> <span class="o">&amp;&amp;</span> <span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">devm_regulator_put</span><span class="p">(</span><span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">devm_regulator_bulk_get</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">regulator_bulk_enable_async</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">async_cookie_t</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_bulk_data</span> <span class="o">*</span><span class="n">bulk</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">bulk</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_enable</span><span class="p">(</span><span class="n">bulk</span><span class="o">-&gt;</span><span class="n">consumer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_bulk_enable - enable multiple regulator consumers</span>
<span class="cm"> *</span>
<span class="cm"> * @num_consumers: Number of consumers</span>
<span class="cm"> * @consumers:     Consumer data; clients are stored here.</span>
<span class="cm"> * @return         0 on success, an errno on failure</span>
<span class="cm"> *</span>
<span class="cm"> * This convenience API allows consumers to enable multiple regulator</span>
<span class="cm"> * clients in a single API call.  If any consumers cannot be enabled</span>
<span class="cm"> * then any others that were enabled will be disabled again prior to</span>
<span class="cm"> * return.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_bulk_enable</span><span class="p">(</span><span class="kt">int</span> <span class="n">num_consumers</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">regulator_bulk_data</span> <span class="o">*</span><span class="n">consumers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">async_domain</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_consumers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span><span class="o">-&gt;</span><span class="n">always_on</span><span class="p">)</span>
			<span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">async_schedule_domain</span><span class="p">(</span><span class="n">regulator_bulk_enable_async</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">async_domain</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">async_synchronize_full_domain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">async_domain</span><span class="p">);</span>

	<span class="cm">/* If any consumer failed we need to unwind any that succeeded */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_consumers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ret</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to enable %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">supply</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">regulator_disable</span><span class="p">(</span><span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_bulk_enable</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_bulk_disable - disable multiple regulator consumers</span>
<span class="cm"> *</span>
<span class="cm"> * @num_consumers: Number of consumers</span>
<span class="cm"> * @consumers:     Consumer data; clients are stored here.</span>
<span class="cm"> * @return         0 on success, an errno on failure</span>
<span class="cm"> *</span>
<span class="cm"> * This convenience API allows consumers to disable multiple regulator</span>
<span class="cm"> * clients in a single API call.  If any consumers cannot be disabled</span>
<span class="cm"> * then any others that were disabled will be enabled again prior to</span>
<span class="cm"> * return.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_bulk_disable</span><span class="p">(</span><span class="kt">int</span> <span class="n">num_consumers</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">regulator_bulk_data</span> <span class="o">*</span><span class="n">consumers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">num_consumers</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_disable</span><span class="p">(</span><span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to disable %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">supply</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_consumers</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">regulator_enable</span><span class="p">(</span><span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to reename %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">supply</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_bulk_disable</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_bulk_force_disable - force disable multiple regulator consumers</span>
<span class="cm"> *</span>
<span class="cm"> * @num_consumers: Number of consumers</span>
<span class="cm"> * @consumers:     Consumer data; clients are stored here.</span>
<span class="cm"> * @return         0 on success, an errno on failure</span>
<span class="cm"> *</span>
<span class="cm"> * This convenience API allows consumers to forcibly disable multiple regulator</span>
<span class="cm"> * clients in a single API call.</span>
<span class="cm"> * NOTE: This should be used for situations when device damage will</span>
<span class="cm"> * likely occur if the regulators are not disabled (e.g. over temp).</span>
<span class="cm"> * Although regulator_force_disable function call for some consumers can</span>
<span class="cm"> * return error numbers, the function is called for all consumers.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_bulk_force_disable</span><span class="p">(</span><span class="kt">int</span> <span class="n">num_consumers</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">regulator_bulk_data</span> <span class="o">*</span><span class="n">consumers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_consumers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ret</span> <span class="o">=</span>
			    <span class="n">regulator_force_disable</span><span class="p">(</span><span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_consumers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ret</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_bulk_force_disable</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_bulk_free - free multiple regulator consumers</span>
<span class="cm"> *</span>
<span class="cm"> * @num_consumers: Number of consumers</span>
<span class="cm"> * @consumers:     Consumer data; clients are stored here.</span>
<span class="cm"> *</span>
<span class="cm"> * This convenience API allows consumers to free multiple regulator</span>
<span class="cm"> * clients in a single API call.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">regulator_bulk_free</span><span class="p">(</span><span class="kt">int</span> <span class="n">num_consumers</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">regulator_bulk_data</span> <span class="o">*</span><span class="n">consumers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_consumers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regulator_put</span><span class="p">(</span><span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span><span class="p">);</span>
		<span class="n">consumers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_bulk_free</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_notifier_call_chain - call regulator event notifier</span>
<span class="cm"> * @rdev: regulator source</span>
<span class="cm"> * @event: notifier block</span>
<span class="cm"> * @data: callback-specific data.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by regulator drivers to notify clients a regulator event has</span>
<span class="cm"> * occurred. We also notify regulator clients downstream.</span>
<span class="cm"> * Note lock must be held by caller.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_notifier_call_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_notifier_call_chain</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_notifier_call_chain</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_mode_to_status - convert a regulator mode into a status</span>
<span class="cm"> *</span>
<span class="cm"> * @mode: Mode to convert</span>
<span class="cm"> *</span>
<span class="cm"> * Convert a regulator mode into a status.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_mode_to_status</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">REGULATOR_MODE_FAST</span>:
		<span class="k">return</span> <span class="n">REGULATOR_STATUS_FAST</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REGULATOR_MODE_NORMAL</span>:
		<span class="k">return</span> <span class="n">REGULATOR_STATUS_NORMAL</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REGULATOR_MODE_IDLE</span>:
		<span class="k">return</span> <span class="n">REGULATOR_STATUS_IDLE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REGULATOR_STATUS_STANDBY</span>:
		<span class="k">return</span> <span class="n">REGULATOR_STATUS_STANDBY</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_mode_to_status</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * To avoid cluttering sysfs (and memory) with useless state, only</span>
<span class="cm"> * create attributes that can be meaningfully displayed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_regulator_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator_ops</span>	<span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* some attributes need specific methods to be displayed */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_voltage</span> <span class="o">&amp;&amp;</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_voltage</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_voltage_sel</span> <span class="o">&amp;&amp;</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_voltage_sel</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_microvolts</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_current_limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_microamps</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_opmode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">is_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* some attributes are type-specific */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">REGULATOR_CURRENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_requested_microamps</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* all the other attributes exist to support constraints;</span>
<span class="cm">	 * don&#39;t show them if there are no constraints, or if the</span>
<span class="cm">	 * relevant supporting methods are missing.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* constraints need specific supporting methods */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage</span> <span class="o">||</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage_sel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_min_microvolts</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_max_microvolts</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_current_limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_min_microamps</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_max_microamps</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_suspend_standby_state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_suspend_mem_state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_suspend_disk_state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_suspend_voltage</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev_attr_suspend_standby_microvolts</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev_attr_suspend_mem_microvolts</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev_attr_suspend_disk_microvolts</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_suspend_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev_attr_suspend_standby_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev_attr_suspend_mem_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev_attr_suspend_disk_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rdev_init_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">debugfs</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">rdev_get_name</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span> <span class="n">debugfs_root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdev_warn</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;Failed to create debugfs directory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">debugfs_create_u32</span><span class="p">(</span><span class="s">&quot;use_count&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">use_count</span><span class="p">);</span>
	<span class="n">debugfs_create_u32</span><span class="p">(</span><span class="s">&quot;open_count&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">open_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_register - register regulator</span>
<span class="cm"> * @regulator_desc: regulator to register</span>
<span class="cm"> * @config: runtime configuration for regulator</span>
<span class="cm"> *</span>
<span class="cm"> * Called by regulator drivers to register a regulator.</span>
<span class="cm"> * Returns 0 on success.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span>
<span class="nf">regulator_register</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">regulator_desc</span> <span class="o">*</span><span class="n">regulator_desc</span><span class="p">,</span>
		   <span class="k">const</span> <span class="k">struct</span> <span class="n">regulator_config</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">regulation_constraints</span> <span class="o">*</span><span class="n">constraints</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">regulator_init_data</span> <span class="o">*</span><span class="n">init_data</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">regulator_no</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">supply</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regulator_desc</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">config</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regulator_desc</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">regulator_desc</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regulator_desc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">REGULATOR_VOLTAGE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">regulator_desc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">REGULATOR_CURRENT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="cm">/* Only one of each should be implemented */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">regulator_desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_voltage</span> <span class="o">&amp;&amp;</span>
		<span class="n">regulator_desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_voltage_sel</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">regulator_desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage</span> <span class="o">&amp;&amp;</span>
		<span class="n">regulator_desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage_sel</span><span class="p">);</span>

	<span class="cm">/* If we&#39;re using selectors we must implement list_voltage. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regulator_desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_voltage_sel</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">regulator_desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">list_voltage</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regulator_desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage_sel</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">regulator_desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">list_voltage</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">init_data</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_list_mutex</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">reg_data</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">regulator_desc</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">regulator_desc</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">regmap</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">consumer_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">BLOCKING_INIT_NOTIFIER_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">notifier</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">disable_work</span><span class="p">,</span> <span class="n">regulator_disable_work</span><span class="p">);</span>

	<span class="cm">/* preform any regulator specific init */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_data</span> <span class="o">&amp;&amp;</span> <span class="n">init_data</span><span class="o">-&gt;</span><span class="n">regulator_init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">init_data</span><span class="o">-&gt;</span><span class="n">regulator_init</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">reg_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">clean</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* register with sysfs */</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regulator_class</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">;</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;regulator.%d&quot;</span><span class="p">,</span>
		     <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_no</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clean</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>

	<span class="cm">/* set regulator constraints */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_data</span><span class="p">)</span>
		<span class="n">constraints</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">init_data</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_machine_constraints</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">constraints</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">scrub</span><span class="p">;</span>

	<span class="cm">/* add attributes supported by this regulator */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">add_regulator_attributes</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">scrub</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">init_data</span> <span class="o">&amp;&amp;</span> <span class="n">init_data</span><span class="o">-&gt;</span><span class="n">supply_regulator</span><span class="p">)</span>
		<span class="n">supply</span> <span class="o">=</span> <span class="n">init_data</span><span class="o">-&gt;</span><span class="n">supply_regulator</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">regulator_desc</span><span class="o">-&gt;</span><span class="n">supply_name</span><span class="p">)</span>
		<span class="n">supply</span> <span class="o">=</span> <span class="n">regulator_desc</span><span class="o">-&gt;</span><span class="n">supply_name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">supply</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">regulator_dev_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">supply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to find supply %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">supply</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">scrub</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_supply</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">scrub</span><span class="p">;</span>

		<span class="cm">/* Enable supply if rail is enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_regulator_is_enabled</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_enable</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">scrub</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* add consumers devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">init_data</span><span class="o">-&gt;</span><span class="n">num_consumer_supplies</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">set_consumer_device_supply</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span>
				<span class="n">init_data</span><span class="o">-&gt;</span><span class="n">consumer_supplies</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_name</span><span class="p">,</span>
				<span class="n">init_data</span><span class="o">-&gt;</span><span class="n">consumer_supplies</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">supply</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to set supply %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">init_data</span><span class="o">-&gt;</span><span class="n">consumer_supplies</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">supply</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">unset_supplies</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regulator_list</span><span class="p">);</span>

	<span class="n">rdev_init_debugfs</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_list_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rdev</span><span class="p">;</span>

<span class="nl">unset_supplies:</span>
	<span class="n">unset_regulator_supplies</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

<span class="nl">scrub:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">)</span>
		<span class="n">regulator_put</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">);</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* device core frees rdev */</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">clean:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_register</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_unregister - unregister regulator</span>
<span class="cm"> * @rdev: regulator to unregister</span>
<span class="cm"> *</span>
<span class="cm"> * Called by regulator drivers to unregister a regulator.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">regulator_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">)</span>
		<span class="n">regulator_put</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_list_mutex</span><span class="p">);</span>
	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">debugfs</span><span class="p">);</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">disable_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">open_count</span><span class="p">);</span>
	<span class="n">unset_regulator_supplies</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">);</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_list_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_unregister</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_suspend_prepare - prepare regulators for system wide suspend</span>
<span class="cm"> * @state: system suspend state</span>
<span class="cm"> *</span>
<span class="cm"> * Configure each regulator with it&#39;s suspend operating parameters for state.</span>
<span class="cm"> * This will usually be called by machine suspend code prior to supending.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_suspend_prepare</span><span class="p">(</span><span class="n">suspend_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* ON is handled by regulator active state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">PM_SUSPEND_ON</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_list_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regulator_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">suspend_prepare</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;failed to prepare</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_list_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_suspend_prepare</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_suspend_finish - resume regulators from system wide suspend</span>
<span class="cm"> *</span>
<span class="cm"> * Turn on regulators that might be turned off by regulator_suspend_prepare</span>
<span class="cm"> * and that should be turned on according to the regulators properties.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">regulator_suspend_finish</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_list_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regulator_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">regulator_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="o">||</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">always_on</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_full_constraints</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_regulator_is_enabled</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
<span class="nl">unlock:</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_list_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_suspend_finish</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_has_full_constraints - the system has fully specified constraints</span>
<span class="cm"> *</span>
<span class="cm"> * Calling this function will cause the regulator API to disable all</span>
<span class="cm"> * regulators which have a zero use count and don&#39;t have an always_on</span>
<span class="cm"> * constraint in a late_initcall.</span>
<span class="cm"> *</span>
<span class="cm"> * The intention is that this will become the default behaviour in a</span>
<span class="cm"> * future kernel release so users are encouraged to use this facility</span>
<span class="cm"> * now.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">regulator_has_full_constraints</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">has_full_constraints</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_has_full_constraints</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_use_dummy_regulator - Provide a dummy regulator when none is found</span>
<span class="cm"> *</span>
<span class="cm"> * Calling this function will cause the regulator API to provide a</span>
<span class="cm"> * dummy regulator to consumers if no physical regulator is found,</span>
<span class="cm"> * allowing most consumers to proceed as though a regulator were</span>
<span class="cm"> * configured.  This allows systems such as those with software</span>
<span class="cm"> * controllable regulators for the CPU core only to be brought up more</span>
<span class="cm"> * readily.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">regulator_use_dummy_regulator</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">board_wants_dummy_regulator</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_use_dummy_regulator</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * rdev_get_drvdata - get rdev regulator driver data</span>
<span class="cm"> * @rdev: regulator</span>
<span class="cm"> *</span>
<span class="cm"> * Get rdev regulator driver private data. This call can be used in the</span>
<span class="cm"> * regulator driver context.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">rdev_get_drvdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">reg_data</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rdev_get_drvdata</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_get_drvdata - get regulator driver data</span>
<span class="cm"> * @regulator: regulator</span>
<span class="cm"> *</span>
<span class="cm"> * Get regulator driver private data. This call can be used in the consumer</span>
<span class="cm"> * driver context when non API regulator specific functions need to be called.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">regulator_get_drvdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">reg_data</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_get_drvdata</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_set_drvdata - set regulator driver data</span>
<span class="cm"> * @regulator: regulator</span>
<span class="cm"> * @data: data</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">regulator_set_drvdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regulator</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">regulator</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">reg_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_set_drvdata</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * regulator_get_id - get regulator ID</span>
<span class="cm"> * @rdev: regulator</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rdev_get_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rdev_get_id</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="nf">rdev_get_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rdev_get_dev</span><span class="p">);</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">regulator_get_init_drvdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_init_data</span> <span class="o">*</span><span class="n">reg_init_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">reg_init_data</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">regulator_get_init_drvdata</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">supply_map_read_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator_map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regulator_map_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">ret</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">ret</span><span class="p">,</span>
			       <span class="s">&quot;%s -&gt; %s.%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">rdev_get_name</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">regulator</span><span class="p">),</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span>
			       <span class="n">map</span><span class="o">-&gt;</span><span class="n">supply</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">supply_map_fops</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">supply_map_read_file</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">regulator_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">class_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_class</span><span class="p">);</span>

	<span class="n">debugfs_root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;regulator&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debugfs_root</span><span class="p">)</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;regulator: Failed to create debugfs directory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;supply_map&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">debugfs_root</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">supply_map_fops</span><span class="p">);</span>

	<span class="n">regulator_dummy_init</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* init early to allow our consumers to complete system booting */</span>
<span class="n">core_initcall</span><span class="p">(</span><span class="n">regulator_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">regulator_init_complete</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulation_constraints</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_list_mutex</span><span class="p">);</span>

	<span class="cm">/* If we have a full configuration then disable any regulators</span>
<span class="cm">	 * which are not in use or always_on.  This will become the</span>
<span class="cm">	 * default behaviour in the future.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regulator_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ops</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">disable</span> <span class="o">||</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">always_on</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">use_count</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="cm">/* If we can&#39;t read the status assume it&#39;s on. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">is_enabled</span><span class="p">)</span>
			<span class="n">enabled</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">is_enabled</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enabled</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">has_full_constraints</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We log since this may kill the system if it</span>
<span class="cm">			 * goes wrong. */</span>
			<span class="n">rdev_info</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;disabling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdev_err</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t disable: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* The intention is that in future we will</span>
<span class="cm">			 * assume that full constraints are provided</span>
<span class="cm">			 * so warn even if we aren&#39;t going to do</span>
<span class="cm">			 * anything here.</span>
<span class="cm">			 */</span>
			<span class="n">rdev_warn</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="s">&quot;incomplete constraints, leaving on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

<span class="nl">unlock:</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regulator_list_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">late_initcall</span><span class="p">(</span><span class="n">regulator_init_complete</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
