<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › regulator › tps6586x-regulator.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>tps6586x-regulator.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Regulator driver for TI TPS6586x</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Compulab Ltd.</span>
<span class="cm"> * Author: Mike Rapoport &lt;mike@compulab.co.il&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on da903x</span>
<span class="cm"> * Copyright (C) 2006-2008 Marvell International Ltd.</span>
<span class="cm"> * Copyright (C) 2008 Compulab Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/driver.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/machine.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/tps6586x.h&gt;</span>

<span class="cm">/* supply control and voltage setting  */</span>
<span class="cp">#define TPS6586X_SUPPLYENA	0x10</span>
<span class="cp">#define TPS6586X_SUPPLYENB	0x11</span>
<span class="cp">#define TPS6586X_SUPPLYENC	0x12</span>
<span class="cp">#define TPS6586X_SUPPLYEND	0x13</span>
<span class="cp">#define TPS6586X_SUPPLYENE	0x14</span>
<span class="cp">#define TPS6586X_VCC1		0x20</span>
<span class="cp">#define TPS6586X_VCC2		0x21</span>
<span class="cp">#define TPS6586X_SM1V1		0x23</span>
<span class="cp">#define TPS6586X_SM1V2		0x24</span>
<span class="cp">#define TPS6586X_SM1SL		0x25</span>
<span class="cp">#define TPS6586X_SM0V1		0x26</span>
<span class="cp">#define TPS6586X_SM0V2		0x27</span>
<span class="cp">#define TPS6586X_SM0SL		0x28</span>
<span class="cp">#define TPS6586X_LDO2AV1	0x29</span>
<span class="cp">#define TPS6586X_LDO2AV2	0x2A</span>
<span class="cp">#define TPS6586X_LDO2BV1	0x2F</span>
<span class="cp">#define TPS6586X_LDO2BV2	0x30</span>
<span class="cp">#define TPS6586X_LDO4V1		0x32</span>
<span class="cp">#define TPS6586X_LDO4V2		0x33</span>

<span class="cm">/* converter settings  */</span>
<span class="cp">#define TPS6586X_SUPPLYV1	0x41</span>
<span class="cp">#define TPS6586X_SUPPLYV2	0x42</span>
<span class="cp">#define TPS6586X_SUPPLYV3	0x43</span>
<span class="cp">#define TPS6586X_SUPPLYV4	0x44</span>
<span class="cp">#define TPS6586X_SUPPLYV5	0x45</span>
<span class="cp">#define TPS6586X_SUPPLYV6	0x46</span>
<span class="cp">#define TPS6586X_SMODE1		0x47</span>
<span class="cp">#define TPS6586X_SMODE2		0x48</span>

<span class="k">struct</span> <span class="n">tps6586x_regulator</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_desc</span> <span class="n">desc</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">volt_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">volt_shift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">volt_nbits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enable_bit</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">enable_reg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="kt">int</span> <span class="o">*</span><span class="n">voltages</span><span class="p">;</span>

	<span class="cm">/* for DVM regulators */</span>
	<span class="kt">int</span> <span class="n">go_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">go_bit</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="nf">to_tps6586x_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rdev_get_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tps6586x_list_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">selector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tps6586x_regulator</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">rdev_get_drvdata</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rid</span> <span class="o">=</span> <span class="n">rdev_get_id</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="cm">/* LDO0 has minimal voltage 1.2V rather than 1.25V */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rid</span> <span class="o">==</span> <span class="n">TPS6586X_ID_LDO_0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">selector</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">voltages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">voltages</span><span class="p">[</span><span class="n">selector</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">tps6586x_set_voltage_sel</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="n">selector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tps6586x_regulator</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">rdev_get_drvdata</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">to_tps6586x_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">rid</span> <span class="o">=</span> <span class="n">rdev_get_id</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="kt">uint8_t</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">selector</span> <span class="o">&lt;&lt;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">volt_shift</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">volt_nbits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">volt_shift</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tps6586x_update</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">volt_reg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Update go bit for DVM regulators */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPS6586X_ID_LDO_2</span>:
	<span class="k">case</span> <span class="n">TPS6586X_ID_LDO_4</span>:
	<span class="k">case</span> <span class="n">TPS6586X_ID_SM_0</span>:
	<span class="k">case</span> <span class="n">TPS6586X_ID_SM_1</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tps6586x_set_bits</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">go_reg</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">go_bit</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tps6586x_get_voltage_sel</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tps6586x_regulator</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">rdev_get_drvdata</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">to_tps6586x_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="kt">uint8_t</span> <span class="n">val</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tps6586x_read</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">volt_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">volt_nbits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">volt_shift</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">volt_shift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">n_voltages</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tps6586x_regulator_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tps6586x_regulator</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">rdev_get_drvdata</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">to_tps6586x_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tps6586x_set_bits</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">enable_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">enable_bit</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tps6586x_regulator_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tps6586x_regulator</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">rdev_get_drvdata</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">to_tps6586x_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tps6586x_clr_bits</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">enable_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">enable_bit</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tps6586x_regulator_is_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tps6586x_regulator</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="n">rdev_get_drvdata</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">to_tps6586x_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="kt">uint8_t</span> <span class="n">reg_val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tps6586x_read</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">enable_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">!!</span><span class="p">(</span><span class="n">reg_val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">enable_bit</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_ops</span> <span class="n">tps6586x_regulator_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">list_voltage</span> <span class="o">=</span> <span class="n">tps6586x_list_voltage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_voltage_sel</span> <span class="o">=</span> <span class="n">tps6586x_get_voltage_sel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_voltage_sel</span> <span class="o">=</span> <span class="n">tps6586x_set_voltage_sel</span><span class="p">,</span>

	<span class="p">.</span><span class="n">is_enabled</span> <span class="o">=</span> <span class="n">tps6586x_regulator_is_enabled</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="n">tps6586x_regulator_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span> <span class="o">=</span> <span class="n">tps6586x_regulator_disable</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">tps6586x_ldo_voltages</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1250</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span> <span class="mi">2500</span><span class="p">,</span> <span class="mi">2700</span><span class="p">,</span> <span class="mi">2850</span><span class="p">,</span> <span class="mi">3100</span><span class="p">,</span> <span class="mi">3300</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">tps6586x_ldo4_voltages</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1700</span><span class="p">,</span> <span class="mi">1725</span><span class="p">,</span> <span class="mi">1750</span><span class="p">,</span> <span class="mi">1775</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span> <span class="mi">1825</span><span class="p">,</span> <span class="mi">1850</span><span class="p">,</span> <span class="mi">1875</span><span class="p">,</span>
	<span class="mi">1900</span><span class="p">,</span> <span class="mi">1925</span><span class="p">,</span> <span class="mi">1950</span><span class="p">,</span> <span class="mi">1975</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">2025</span><span class="p">,</span> <span class="mi">2050</span><span class="p">,</span> <span class="mi">2075</span><span class="p">,</span>
	<span class="mi">2100</span><span class="p">,</span> <span class="mi">2125</span><span class="p">,</span> <span class="mi">2150</span><span class="p">,</span> <span class="mi">2175</span><span class="p">,</span> <span class="mi">2200</span><span class="p">,</span> <span class="mi">2225</span><span class="p">,</span> <span class="mi">2250</span><span class="p">,</span> <span class="mi">2275</span><span class="p">,</span>
	<span class="mi">2300</span><span class="p">,</span> <span class="mi">2325</span><span class="p">,</span> <span class="mi">2350</span><span class="p">,</span> <span class="mi">2375</span><span class="p">,</span> <span class="mi">2400</span><span class="p">,</span> <span class="mi">2425</span><span class="p">,</span> <span class="mi">2450</span><span class="p">,</span> <span class="mi">2475</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">tps6586x_sm2_voltages</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">3000</span><span class="p">,</span> <span class="mi">3050</span><span class="p">,</span> <span class="mi">3100</span><span class="p">,</span> <span class="mi">3150</span><span class="p">,</span> <span class="mi">3200</span><span class="p">,</span> <span class="mi">3250</span><span class="p">,</span> <span class="mi">3300</span><span class="p">,</span> <span class="mi">3350</span><span class="p">,</span>
	<span class="mi">3400</span><span class="p">,</span> <span class="mi">3450</span><span class="p">,</span> <span class="mi">3500</span><span class="p">,</span> <span class="mi">3550</span><span class="p">,</span> <span class="mi">3600</span><span class="p">,</span> <span class="mi">3650</span><span class="p">,</span> <span class="mi">3700</span><span class="p">,</span> <span class="mi">3750</span><span class="p">,</span>
	<span class="mi">3800</span><span class="p">,</span> <span class="mi">3850</span><span class="p">,</span> <span class="mi">3900</span><span class="p">,</span> <span class="mi">3950</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">4050</span><span class="p">,</span> <span class="mi">4100</span><span class="p">,</span> <span class="mi">4150</span><span class="p">,</span>
	<span class="mi">4200</span><span class="p">,</span> <span class="mi">4250</span><span class="p">,</span> <span class="mi">4300</span><span class="p">,</span> <span class="mi">4350</span><span class="p">,</span> <span class="mi">4400</span><span class="p">,</span> <span class="mi">4450</span><span class="p">,</span> <span class="mi">4500</span><span class="p">,</span> <span class="mi">4550</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">tps6586x_dvm_voltages</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	 <span class="mi">725</span><span class="p">,</span>  <span class="mi">750</span><span class="p">,</span>  <span class="mi">775</span><span class="p">,</span>  <span class="mi">800</span><span class="p">,</span>  <span class="mi">825</span><span class="p">,</span>  <span class="mi">850</span><span class="p">,</span>  <span class="mi">875</span><span class="p">,</span>  <span class="mi">900</span><span class="p">,</span>
	 <span class="mi">925</span><span class="p">,</span>  <span class="mi">950</span><span class="p">,</span>  <span class="mi">975</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1025</span><span class="p">,</span> <span class="mi">1050</span><span class="p">,</span> <span class="mi">1075</span><span class="p">,</span> <span class="mi">1100</span><span class="p">,</span>
	<span class="mi">1125</span><span class="p">,</span> <span class="mi">1150</span><span class="p">,</span> <span class="mi">1175</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="mi">1225</span><span class="p">,</span> <span class="mi">1250</span><span class="p">,</span> <span class="mi">1275</span><span class="p">,</span> <span class="mi">1300</span><span class="p">,</span>
	<span class="mi">1325</span><span class="p">,</span> <span class="mi">1350</span><span class="p">,</span> <span class="mi">1375</span><span class="p">,</span> <span class="mi">1400</span><span class="p">,</span> <span class="mi">1425</span><span class="p">,</span> <span class="mi">1450</span><span class="p">,</span> <span class="mi">1475</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define TPS6586X_REGULATOR(_id, vdata, vreg, shift, nbits,		\</span>
<span class="cp">			   ereg0, ebit0, ereg1, ebit1)			\</span>
<span class="cp">	.desc	= {							\</span>
<span class="cp">		.name	= &quot;REG-&quot; #_id,					\</span>
<span class="cp">		.ops	= &amp;tps6586x_regulator_ops,			\</span>
<span class="cp">		.type	= REGULATOR_VOLTAGE,				\</span>
<span class="cp">		.id	= TPS6586X_ID_##_id,				\</span>
<span class="cp">		.n_voltages = ARRAY_SIZE(tps6586x_##vdata##_voltages),	\</span>
<span class="cp">		.owner	= THIS_MODULE,					\</span>
<span class="cp">	},								\</span>
<span class="cp">	.volt_reg	= TPS6586X_##vreg,				\</span>
<span class="cp">	.volt_shift	= (shift),					\</span>
<span class="cp">	.volt_nbits	= (nbits),					\</span>
<span class="cp">	.enable_reg[0]	= TPS6586X_SUPPLY##ereg0,			\</span>
<span class="cp">	.enable_bit[0]	= (ebit0),					\</span>
<span class="cp">	.enable_reg[1]	= TPS6586X_SUPPLY##ereg1,			\</span>
<span class="cp">	.enable_bit[1]	= (ebit1),					\</span>
<span class="cp">	.voltages	= tps6586x_##vdata##_voltages,</span>

<span class="cp">#define TPS6586X_REGULATOR_DVM_GOREG(goreg, gobit)			\</span>
<span class="cp">	.go_reg = TPS6586X_##goreg,					\</span>
<span class="cp">	.go_bit = (gobit),</span>

<span class="cp">#define TPS6586X_LDO(_id, vdata, vreg, shift, nbits,			\</span>
<span class="cp">		     ereg0, ebit0, ereg1, ebit1)			\</span>
<span class="cp">{									\</span>
<span class="cp">	TPS6586X_REGULATOR(_id, vdata, vreg, shift, nbits,		\</span>
<span class="cp">			   ereg0, ebit0, ereg1, ebit1)			\</span>
<span class="cp">}</span>

<span class="cp">#define TPS6586X_DVM(_id, vdata, vreg, shift, nbits,			\</span>
<span class="cp">		     ereg0, ebit0, ereg1, ebit1, goreg, gobit)		\</span>
<span class="cp">{									\</span>
<span class="cp">	TPS6586X_REGULATOR(_id, vdata, vreg, shift, nbits,		\</span>
<span class="cp">			   ereg0, ebit0, ereg1, ebit1)			\</span>
<span class="cp">	TPS6586X_REGULATOR_DVM_GOREG(goreg, gobit)			\</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tps6586x_regulator</span> <span class="n">tps6586x_regulator</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TPS6586X_LDO</span><span class="p">(</span><span class="n">LDO_0</span><span class="p">,</span> <span class="n">ldo</span><span class="p">,</span> <span class="n">SUPPLYV1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ENC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">END</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">TPS6586X_LDO</span><span class="p">(</span><span class="n">LDO_3</span><span class="p">,</span> <span class="n">ldo</span><span class="p">,</span> <span class="n">SUPPLYV4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ENC</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">END</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">TPS6586X_LDO</span><span class="p">(</span><span class="n">LDO_5</span><span class="p">,</span> <span class="n">ldo</span><span class="p">,</span> <span class="n">SUPPLYV6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ENE</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">ENE</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">TPS6586X_LDO</span><span class="p">(</span><span class="n">LDO_6</span><span class="p">,</span> <span class="n">ldo</span><span class="p">,</span> <span class="n">SUPPLYV3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ENC</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">END</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">TPS6586X_LDO</span><span class="p">(</span><span class="n">LDO_7</span><span class="p">,</span> <span class="n">ldo</span><span class="p">,</span> <span class="n">SUPPLYV3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ENC</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">END</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">TPS6586X_LDO</span><span class="p">(</span><span class="n">LDO_8</span><span class="p">,</span> <span class="n">ldo</span><span class="p">,</span> <span class="n">SUPPLYV2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ENC</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">END</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">TPS6586X_LDO</span><span class="p">(</span><span class="n">LDO_9</span><span class="p">,</span> <span class="n">ldo</span><span class="p">,</span> <span class="n">SUPPLYV6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ENE</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">ENE</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">TPS6586X_LDO</span><span class="p">(</span><span class="n">LDO_RTC</span><span class="p">,</span> <span class="n">ldo</span><span class="p">,</span> <span class="n">SUPPLYV4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">V4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">V4</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">TPS6586X_LDO</span><span class="p">(</span><span class="n">LDO_1</span><span class="p">,</span> <span class="n">dvm</span><span class="p">,</span> <span class="n">SUPPLYV1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">ENC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">END</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">TPS6586X_LDO</span><span class="p">(</span><span class="n">SM_2</span><span class="p">,</span> <span class="n">sm2</span><span class="p">,</span> <span class="n">SUPPLYV2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">ENC</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">END</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>

	<span class="n">TPS6586X_DVM</span><span class="p">(</span><span class="n">LDO_2</span><span class="p">,</span> <span class="n">dvm</span><span class="p">,</span> <span class="n">LDO2BV1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">ENA</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ENB</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">VCC2</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">TPS6586X_DVM</span><span class="p">(</span><span class="n">LDO_4</span><span class="p">,</span> <span class="n">ldo4</span><span class="p">,</span> <span class="n">LDO4V1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">ENC</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">END</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">VCC1</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">TPS6586X_DVM</span><span class="p">(</span><span class="n">SM_0</span><span class="p">,</span> <span class="n">dvm</span><span class="p">,</span> <span class="n">SM0V1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">ENA</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ENB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">VCC1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">TPS6586X_DVM</span><span class="p">(</span><span class="n">SM_1</span><span class="p">,</span> <span class="n">dvm</span><span class="p">,</span> <span class="n">SM1V1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">ENA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENB</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VCC1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * TPS6586X has 2 enable bits that are OR&#39;ed to determine the actual</span>
<span class="cm"> * regulator state. Clearing one of this bits allows switching</span>
<span class="cm"> * regulator on and of with single register write.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">tps6586x_regulator_preinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">tps6586x_regulator</span> <span class="o">*</span><span class="n">ri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">enable_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">enable_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ri</span><span class="o">-&gt;</span><span class="n">enable_bit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">enable_bit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tps6586x_read</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">enable_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tps6586x_read</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">enable_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">val2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">enable_bit</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The regulator is on, but it&#39;s enabled with the bit we don&#39;t</span>
<span class="cm">	 * want to use, so we switch the enable bits</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">enable_bit</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tps6586x_set_bits</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">enable_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">enable_bit</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">tps6586x_clr_bits</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">enable_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				 <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">enable_bit</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tps6586x_regulator_set_slew_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator_init_data</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tps6586x_settings</span> <span class="o">*</span><span class="n">setting</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setting</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">setting</span><span class="o">-&gt;</span><span class="n">slew_rate</span> <span class="o">&amp;</span> <span class="n">TPS6586X_SLEW_RATE_SET</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* only SM0 and SM1 can have the slew rate settings */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPS6586X_ID_SM_0</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">TPS6586X_SM0SL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPS6586X_ID_SM_1</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">TPS6586X_SM1SL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Only SM0/SM1 can set slew rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">tps6586x_write</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
			<span class="n">setting</span><span class="o">-&gt;</span><span class="n">slew_rate</span> <span class="o">&amp;</span> <span class="n">TPS6586X_SLEW_RATE_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">tps6586x_regulator</span> <span class="o">*</span><span class="nf">find_regulator_info</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tps6586x_regulator</span> <span class="o">*</span><span class="n">ri</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tps6586x_regulator</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ri</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tps6586x_regulator</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ri</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tps6586x_regulator_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tps6586x_regulator</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator_config</span> <span class="n">config</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Probing regulator %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

	<span class="n">ri</span> <span class="o">=</span> <span class="n">find_regulator_info</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ri</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid regulator ID specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tps6586x_regulator_preinit</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">ri</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">config</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">config</span><span class="p">.</span><span class="n">of_node</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="n">config</span><span class="p">.</span><span class="n">init_data</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">config</span><span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">ri</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">regulator_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register regulator %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ri</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tps6586x_regulator_set_slew_rate</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">tps6586x_regulator_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">regulator_unregister</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">tps6586x_regulator_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;tps6586x-regulator&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">tps6586x_regulator_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">tps6586x_regulator_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tps6586x_regulator_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tps6586x_regulator_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">tps6586x_regulator_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">tps6586x_regulator_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tps6586x_regulator_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">tps6586x_regulator_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mike Rapoport &lt;mike@compulab.co.il&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Regulator Driver for TI TPS6586X PMIC&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:tps6586x-regulator&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
