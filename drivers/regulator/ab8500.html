<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › regulator › ab8500.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ab8500.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) ST-Ericsson SA 2010</span>
<span class="cm"> *</span>
<span class="cm"> * License Terms: GNU General Public License v2</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Sundar Iyer &lt;sundar.iyer@stericsson.com&gt; for ST-Ericsson</span>
<span class="cm"> *          Bengt Jonsson &lt;bengt.g.jonsson@stericsson.com&gt; for ST-Ericsson</span>
<span class="cm"> *</span>
<span class="cm"> * AB8500 peripheral regulators</span>
<span class="cm"> *</span>
<span class="cm"> * AB8500 supports the following regulators:</span>
<span class="cm"> *   VAUX1/2/3, VINTCORE, VTVOUT, VUSB, VAUDIO, VAMIC1/2, VDMIC, VANA</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500/ab8500.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/of_regulator.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/driver.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/machine.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/ab8500.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cm">/**</span>
<span class="cm"> * struct ab8500_regulator_info - ab8500 regulator information</span>
<span class="cm"> * @dev: device pointer</span>
<span class="cm"> * @desc: regulator description</span>
<span class="cm"> * @regulator_dev: regulator device</span>
<span class="cm"> * @max_uV: maximum voltage (for variable voltage supplies)</span>
<span class="cm"> * @min_uV: minimum voltage (for variable voltage supplies)</span>
<span class="cm"> * @fixed_uV: typical voltage (for fixed voltage supplies)</span>
<span class="cm"> * @update_bank: bank to control on/off</span>
<span class="cm"> * @update_reg: register to control on/off</span>
<span class="cm"> * @update_mask: mask to enable/disable regulator</span>
<span class="cm"> * @update_val_enable: bits to enable the regulator in normal (high power) mode</span>
<span class="cm"> * @voltage_bank: bank to control regulator voltage</span>
<span class="cm"> * @voltage_reg: register to control regulator voltage</span>
<span class="cm"> * @voltage_mask: mask to control regulator voltage</span>
<span class="cm"> * @voltages: supported voltage table</span>
<span class="cm"> * @voltages_len: number of supported voltages for the regulator</span>
<span class="cm"> * @delay: startup/set voltage delay in us</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ab8500_regulator_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator_desc</span>	<span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator_dev</span>	<span class="o">*</span><span class="n">regulator</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_uV</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min_uV</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fixed_uV</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">update_bank</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">update_reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">update_mask</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">update_val_enable</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">voltage_bank</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">voltage_reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">voltage_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="k">const</span> <span class="o">*</span><span class="n">voltages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">voltages_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* voltage tables for the vauxn/vintcore supplies */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ldo_vauxn_voltages</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1100000</span><span class="p">,</span>
	<span class="mi">1200000</span><span class="p">,</span>
	<span class="mi">1300000</span><span class="p">,</span>
	<span class="mi">1400000</span><span class="p">,</span>
	<span class="mi">1500000</span><span class="p">,</span>
	<span class="mi">1800000</span><span class="p">,</span>
	<span class="mi">1850000</span><span class="p">,</span>
	<span class="mi">1900000</span><span class="p">,</span>
	<span class="mi">2500000</span><span class="p">,</span>
	<span class="mi">2650000</span><span class="p">,</span>
	<span class="mi">2700000</span><span class="p">,</span>
	<span class="mi">2750000</span><span class="p">,</span>
	<span class="mi">2800000</span><span class="p">,</span>
	<span class="mi">2900000</span><span class="p">,</span>
	<span class="mi">3000000</span><span class="p">,</span>
	<span class="mi">3300000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ldo_vaux3_voltages</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1200000</span><span class="p">,</span>
	<span class="mi">1500000</span><span class="p">,</span>
	<span class="mi">1800000</span><span class="p">,</span>
	<span class="mi">2100000</span><span class="p">,</span>
	<span class="mi">2500000</span><span class="p">,</span>
	<span class="mi">2750000</span><span class="p">,</span>
	<span class="mi">2790000</span><span class="p">,</span>
	<span class="mi">2910000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ldo_vintcore_voltages</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1200000</span><span class="p">,</span>
	<span class="mi">1225000</span><span class="p">,</span>
	<span class="mi">1250000</span><span class="p">,</span>
	<span class="mi">1275000</span><span class="p">,</span>
	<span class="mi">1300000</span><span class="p">,</span>
	<span class="mi">1325000</span><span class="p">,</span>
	<span class="mi">1350000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_regulator_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_regulator_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">rdev_get_drvdata</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev_get_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span> <span class="s">&quot;regulator info null pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">update_bank</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">update_reg</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">update_mask</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">update_val_enable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev_get_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span>
			<span class="s">&quot;couldn&#39;t set enable bits for regulator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">rdev_get_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span>
		<span class="s">&quot;%s-enable (bank, reg, mask, value): 0x%x, 0x%x, 0x%x, 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">update_bank</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">update_reg</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">update_mask</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">update_val_enable</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_regulator_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_regulator_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">rdev_get_drvdata</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev_get_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span> <span class="s">&quot;regulator info null pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">update_bank</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">update_reg</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">update_mask</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev_get_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span>
			<span class="s">&quot;couldn&#39;t set disable bits for regulator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">rdev_get_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span>
		<span class="s">&quot;%s-disable (bank, reg, mask, value): 0x%x, 0x%x, 0x%x, 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">update_bank</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">update_reg</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">update_mask</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_regulator_is_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_regulator_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">rdev_get_drvdata</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">regval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev_get_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span> <span class="s">&quot;regulator info null pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">update_bank</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">update_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev_get_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span>
			<span class="s">&quot;couldn&#39;t read 0x%x register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">update_reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">rdev_get_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span>
		<span class="s">&quot;%s-is_enabled (bank, reg, mask, value): 0x%x, 0x%x, 0x%x,&quot;</span>
		<span class="s">&quot; 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">update_bank</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">update_reg</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">update_mask</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">update_mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_list_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">selector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_regulator_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">rdev_get_drvdata</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev_get_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span> <span class="s">&quot;regulator info null pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* return the uV for the fixed regulators */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fixed_uV</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fixed_uV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">selector</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">voltages_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">voltages</span><span class="p">[</span><span class="n">selector</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_regulator_get_voltage_sel</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_regulator_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">rdev_get_drvdata</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">regval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev_get_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span> <span class="s">&quot;regulator info null pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">voltage_bank</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">voltage_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev_get_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span>
			<span class="s">&quot;couldn&#39;t read voltage reg for regulator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">rdev_get_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span>
		<span class="s">&quot;%s-get_voltage (bank, reg, mask, value): 0x%x, 0x%x, 0x%x,&quot;</span>
		<span class="s">&quot; 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">voltage_bank</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">voltage_reg</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">voltage_mask</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>

	<span class="cm">/* vintcore has a different layout */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">regval</span> <span class="o">&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">voltage_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">AB8500_LDO_INTCORE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_regulator_set_voltage_sel</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="n">selector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_regulator_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">rdev_get_drvdata</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">regval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev_get_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span> <span class="s">&quot;regulator info null pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set the registers for the request */</span>
	<span class="n">regval</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">selector</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">voltage_bank</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">voltage_reg</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">voltage_mask</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev_get_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span>
		<span class="s">&quot;couldn&#39;t set voltage reg for regulator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">rdev_get_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span>
		<span class="s">&quot;%s-set_voltage (bank, reg, mask, value): 0x%x, 0x%x, 0x%x,&quot;</span>
		<span class="s">&quot; 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">voltage_bank</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">voltage_reg</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">voltage_mask</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_regulator_enable_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_regulator_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">rdev_get_drvdata</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_regulator_set_voltage_time_sel</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
					     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old_sel</span><span class="p">,</span>
					     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_regulator_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">rdev_get_drvdata</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* If the regulator isn&#39;t on, it won&#39;t take time here */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_regulator_is_enabled</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_ops</span> <span class="n">ab8500_regulator_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">ab8500_regulator_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">ab8500_regulator_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_enabled</span>	<span class="o">=</span> <span class="n">ab8500_regulator_is_enabled</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_voltage_sel</span> <span class="o">=</span> <span class="n">ab8500_regulator_get_voltage_sel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_voltage_sel</span> <span class="o">=</span> <span class="n">ab8500_regulator_set_voltage_sel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">list_voltage</span>	<span class="o">=</span> <span class="n">ab8500_list_voltage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_time</span>	<span class="o">=</span> <span class="n">ab8500_regulator_enable_time</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_voltage_time_sel</span> <span class="o">=</span> <span class="n">ab8500_regulator_set_voltage_time_sel</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fixed_get_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">regulator_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_regulator_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">rdev_get_drvdata</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev_get_dev</span><span class="p">(</span><span class="n">rdev</span><span class="p">),</span> <span class="s">&quot;regulator info null pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fixed_uV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_ops</span> <span class="n">ab8500_regulator_fixed_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">ab8500_regulator_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">ab8500_regulator_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_enabled</span>	<span class="o">=</span> <span class="n">ab8500_regulator_is_enabled</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_voltage</span>	<span class="o">=</span> <span class="n">ab8500_fixed_get_voltage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">list_voltage</span>	<span class="o">=</span> <span class="n">ab8500_list_voltage</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_time</span>	<span class="o">=</span> <span class="n">ab8500_regulator_enable_time</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_voltage_time_sel</span> <span class="o">=</span> <span class="n">ab8500_regulator_set_voltage_time_sel</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ab8500_regulator_info</span>
		<span class="n">ab8500_regulator_info</span><span class="p">[</span><span class="n">AB8500_NUM_REGULATORS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Variable Voltage Regulators</span>
<span class="cm">	 *   name, min mV, max mV,</span>
<span class="cm">	 *   update bank, reg, mask, enable val</span>
<span class="cm">	 *   volt bank, reg, mask, table, table length</span>
<span class="cm">	 */</span>
	<span class="p">[</span><span class="n">AB8500_LDO_AUX1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;LDO-AUX1&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_regulator_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">REGULATOR_VOLTAGE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">AB8500_LDO_AUX1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">n_voltages</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ldo_vauxn_voltages</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">min_uV</span>			<span class="o">=</span> <span class="mi">1100000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_uV</span>			<span class="o">=</span> <span class="mi">3300000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_bank</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_reg</span>		<span class="o">=</span> <span class="mh">0x09</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_mask</span>		<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_val_enable</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltage_bank</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltage_reg</span>		<span class="o">=</span> <span class="mh">0x1f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltage_mask</span>		<span class="o">=</span> <span class="mh">0x0f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltages</span>		<span class="o">=</span> <span class="n">ldo_vauxn_voltages</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltages_len</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ldo_vauxn_voltages</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">AB8500_LDO_AUX2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;LDO-AUX2&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_regulator_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">REGULATOR_VOLTAGE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">AB8500_LDO_AUX2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">n_voltages</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ldo_vauxn_voltages</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">min_uV</span>			<span class="o">=</span> <span class="mi">1100000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_uV</span>			<span class="o">=</span> <span class="mi">3300000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_bank</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_reg</span>		<span class="o">=</span> <span class="mh">0x09</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_mask</span>		<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_val_enable</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltage_bank</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltage_reg</span>		<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltage_mask</span>		<span class="o">=</span> <span class="mh">0x0f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltages</span>		<span class="o">=</span> <span class="n">ldo_vauxn_voltages</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltages_len</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ldo_vauxn_voltages</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">AB8500_LDO_AUX3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;LDO-AUX3&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_regulator_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">REGULATOR_VOLTAGE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">AB8500_LDO_AUX3</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">n_voltages</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ldo_vaux3_voltages</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">min_uV</span>			<span class="o">=</span> <span class="mi">1100000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_uV</span>			<span class="o">=</span> <span class="mi">3300000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_bank</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_reg</span>		<span class="o">=</span> <span class="mh">0x0a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_mask</span>		<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_val_enable</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltage_bank</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltage_reg</span>		<span class="o">=</span> <span class="mh">0x21</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltage_mask</span>		<span class="o">=</span> <span class="mh">0x07</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltages</span>		<span class="o">=</span> <span class="n">ldo_vaux3_voltages</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltages_len</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ldo_vaux3_voltages</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">AB8500_LDO_INTCORE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;LDO-INTCORE&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_regulator_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">REGULATOR_VOLTAGE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">AB8500_LDO_INTCORE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">n_voltages</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ldo_vintcore_voltages</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">min_uV</span>			<span class="o">=</span> <span class="mi">1100000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_uV</span>			<span class="o">=</span> <span class="mi">3300000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_bank</span>		<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_reg</span>		<span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_mask</span>		<span class="o">=</span> <span class="mh">0x44</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_val_enable</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltage_bank</span>		<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltage_reg</span>		<span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltage_mask</span>		<span class="o">=</span> <span class="mh">0x38</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltages</span>		<span class="o">=</span> <span class="n">ldo_vintcore_voltages</span><span class="p">,</span>
		<span class="p">.</span><span class="n">voltages_len</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ldo_vintcore_voltages</span><span class="p">),</span>
	<span class="p">},</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fixed Voltage Regulators</span>
<span class="cm">	 *   name, fixed mV,</span>
<span class="cm">	 *   update bank, reg, mask, enable val</span>
<span class="cm">	 */</span>
	<span class="p">[</span><span class="n">AB8500_LDO_TVOUT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;LDO-TVOUT&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_regulator_fixed_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">REGULATOR_VOLTAGE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">AB8500_LDO_TVOUT</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">n_voltages</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">delay</span>			<span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fixed_uV</span>		<span class="o">=</span> <span class="mi">2000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_bank</span>		<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_reg</span>		<span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_mask</span>		<span class="o">=</span> <span class="mh">0x82</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_val_enable</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">AB8500_LDO_USB</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;LDO-USB&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>            <span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_regulator_fixed_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">type</span>           <span class="o">=</span> <span class="n">REGULATOR_VOLTAGE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">id</span>             <span class="o">=</span> <span class="n">AB8500_LDO_USB</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span>          <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">n_voltages</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">fixed_uV</span>               <span class="o">=</span> <span class="mi">3300000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_bank</span>            <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_reg</span>             <span class="o">=</span> <span class="mh">0x82</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_mask</span>            <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_val_enable</span>      <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">AB8500_LDO_AUDIO</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;LDO-AUDIO&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_regulator_fixed_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">REGULATOR_VOLTAGE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">AB8500_LDO_AUDIO</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">n_voltages</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">fixed_uV</span>		<span class="o">=</span> <span class="mi">2000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_bank</span>		<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_reg</span>		<span class="o">=</span> <span class="mh">0x83</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_mask</span>		<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_val_enable</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">AB8500_LDO_ANAMIC1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;LDO-ANAMIC1&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_regulator_fixed_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">REGULATOR_VOLTAGE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">AB8500_LDO_ANAMIC1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">n_voltages</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">fixed_uV</span>		<span class="o">=</span> <span class="mi">2050000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_bank</span>		<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_reg</span>		<span class="o">=</span> <span class="mh">0x83</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_mask</span>		<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_val_enable</span>	<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">AB8500_LDO_ANAMIC2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;LDO-ANAMIC2&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_regulator_fixed_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">REGULATOR_VOLTAGE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">AB8500_LDO_ANAMIC2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">n_voltages</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">fixed_uV</span>		<span class="o">=</span> <span class="mi">2050000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_bank</span>		<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_reg</span>		<span class="o">=</span> <span class="mh">0x83</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_mask</span>		<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_val_enable</span>	<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">AB8500_LDO_DMIC</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;LDO-DMIC&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_regulator_fixed_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">REGULATOR_VOLTAGE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">AB8500_LDO_DMIC</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">n_voltages</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">fixed_uV</span>		<span class="o">=</span> <span class="mi">1800000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_bank</span>		<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_reg</span>		<span class="o">=</span> <span class="mh">0x83</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_mask</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_val_enable</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">AB8500_LDO_ANA</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;LDO-ANA&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_regulator_fixed_ops</span><span class="p">,</span>
			<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">REGULATOR_VOLTAGE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">AB8500_LDO_ANA</span><span class="p">,</span>
			<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">n_voltages</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">fixed_uV</span>		<span class="o">=</span> <span class="mi">1200000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_bank</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_reg</span>		<span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_mask</span>		<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">update_val_enable</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="p">},</span>


<span class="p">};</span>

<span class="k">struct</span> <span class="n">ab8500_reg_init</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">bank</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define REG_INIT(_id, _bank, _addr, _mask)	\</span>
<span class="cp">	[_id] = {				\</span>
<span class="cp">		.bank = _bank,			\</span>
<span class="cp">		.addr = _addr,			\</span>
<span class="cp">		.mask = _mask,			\</span>
<span class="cp">	}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ab8500_reg_init</span> <span class="n">ab8500_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x30, VanaRequestCtrl</span>
<span class="cm">	 * 0x0C, VpllRequestCtrl</span>
<span class="cm">	 * 0xc0, VextSupply1RequestCtrl</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_REGUREQUESTCTRL2</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x03, VextSupply2RequestCtrl</span>
<span class="cm">	 * 0x0c, VextSupply3RequestCtrl</span>
<span class="cm">	 * 0x30, Vaux1RequestCtrl</span>
<span class="cm">	 * 0xc0, Vaux2RequestCtrl</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_REGUREQUESTCTRL3</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x03, Vaux3RequestCtrl</span>
<span class="cm">	 * 0x04, SwHPReq</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_REGUREQUESTCTRL4</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x08, VanaSysClkReq1HPValid</span>
<span class="cm">	 * 0x20, Vaux1SysClkReq1HPValid</span>
<span class="cm">	 * 0x40, Vaux2SysClkReq1HPValid</span>
<span class="cm">	 * 0x80, Vaux3SysClkReq1HPValid</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_REGUSYSCLKREQ1HPVALID1</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x10, VextSupply1SysClkReq1HPValid</span>
<span class="cm">	 * 0x20, VextSupply2SysClkReq1HPValid</span>
<span class="cm">	 * 0x40, VextSupply3SysClkReq1HPValid</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_REGUSYSCLKREQ1HPVALID2</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x08, VanaHwHPReq1Valid</span>
<span class="cm">	 * 0x20, Vaux1HwHPReq1Valid</span>
<span class="cm">	 * 0x40, Vaux2HwHPReq1Valid</span>
<span class="cm">	 * 0x80, Vaux3HwHPReq1Valid</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_REGUHWHPREQ1VALID1</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x01, VextSupply1HwHPReq1Valid</span>
<span class="cm">	 * 0x02, VextSupply2HwHPReq1Valid</span>
<span class="cm">	 * 0x04, VextSupply3HwHPReq1Valid</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_REGUHWHPREQ1VALID2</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x08, VanaHwHPReq2Valid</span>
<span class="cm">	 * 0x20, Vaux1HwHPReq2Valid</span>
<span class="cm">	 * 0x40, Vaux2HwHPReq2Valid</span>
<span class="cm">	 * 0x80, Vaux3HwHPReq2Valid</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_REGUHWHPREQ2VALID1</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x01, VextSupply1HwHPReq2Valid</span>
<span class="cm">	 * 0x02, VextSupply2HwHPReq2Valid</span>
<span class="cm">	 * 0x04, VextSupply3HwHPReq2Valid</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_REGUHWHPREQ2VALID2</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x20, VanaSwHPReqValid</span>
<span class="cm">	 * 0x80, Vaux1SwHPReqValid</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_REGUSWHPREQVALID1</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x01, Vaux2SwHPReqValid</span>
<span class="cm">	 * 0x02, Vaux3SwHPReqValid</span>
<span class="cm">	 * 0x04, VextSupply1SwHPReqValid</span>
<span class="cm">	 * 0x08, VextSupply2SwHPReqValid</span>
<span class="cm">	 * 0x10, VextSupply3SwHPReqValid</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_REGUSWHPREQVALID2</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x02, SysClkReq2Valid1</span>
<span class="cm">	 * ...</span>
<span class="cm">	 * 0x80, SysClkReq8Valid1</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_REGUSYSCLKREQVALID1</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x02, SysClkReq2Valid2</span>
<span class="cm">	 * ...</span>
<span class="cm">	 * 0x80, SysClkReq8Valid2</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_REGUSYSCLKREQVALID2</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x02, VTVoutEna</span>
<span class="cm">	 * 0x04, Vintcore12Ena</span>
<span class="cm">	 * 0x38, Vintcore12Sel</span>
<span class="cm">	 * 0x40, Vintcore12LP</span>
<span class="cm">	 * 0x80, VTVoutLP</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_REGUMISC1</span><span class="p">,</span>		<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x02, VaudioEna</span>
<span class="cm">	 * 0x04, VdmicEna</span>
<span class="cm">	 * 0x08, Vamic1Ena</span>
<span class="cm">	 * 0x10, Vamic2Ena</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_VAUDIOSUPPLY</span><span class="p">,</span>		<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x01, Vamic1_dzout</span>
<span class="cm">	 * 0x02, Vamic2_dzout</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_REGUCTRL1VAMIC</span><span class="p">,</span>		<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x0c, VanaRegu</span>
<span class="cm">	 * 0x03, VpllRegu</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_VPLLVANAREGU</span><span class="p">,</span>		<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x01, VrefDDREna</span>
<span class="cm">	 * 0x02, VrefDDRSleepMode</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_VREFDDR</span><span class="p">,</span>		<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x03, VextSupply1Regu</span>
<span class="cm">	 * 0x0c, VextSupply2Regu</span>
<span class="cm">	 * 0x30, VextSupply3Regu</span>
<span class="cm">	 * 0x40, ExtSupply2Bypass</span>
<span class="cm">	 * 0x80, ExtSupply3Bypass</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_EXTSUPPLYREGU</span><span class="p">,</span>		<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x03, Vaux1Regu</span>
<span class="cm">	 * 0x0c, Vaux2Regu</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_VAUX12REGU</span><span class="p">,</span>		<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x03, Vaux3Regu</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_VRF1VAUX3REGU</span><span class="p">,</span>		<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x3f, Vsmps1Sel1</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_VSMPS1SEL1</span><span class="p">,</span>		<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x0f, Vaux1Sel</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_VAUX1SEL</span><span class="p">,</span>		<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x0f, Vaux2Sel</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_VAUX2SEL</span><span class="p">,</span>		<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x07, Vaux3Sel</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_VRF1VAUX3SEL</span><span class="p">,</span>		<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x01, VextSupply12LP</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_REGUCTRL2SPARE</span><span class="p">,</span>		<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x04, Vaux1Disch</span>
<span class="cm">	 * 0x08, Vaux2Disch</span>
<span class="cm">	 * 0x10, Vaux3Disch</span>
<span class="cm">	 * 0x20, Vintcore12Disch</span>
<span class="cm">	 * 0x40, VTVoutDisch</span>
<span class="cm">	 * 0x80, VaudioDisch</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_REGUCTRLDISCH</span><span class="p">,</span>		<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">),</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x02, VanaDisch</span>
<span class="cm">	 * 0x04, VdmicPullDownEna</span>
<span class="cm">	 * 0x10, VdmicDisch</span>
<span class="cm">	 */</span>
	<span class="n">REG_INIT</span><span class="p">(</span><span class="n">AB8500_REGUCTRLDISCH2</span><span class="p">,</span>		<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span>
<span class="nf">ab8500_regulator_init_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ab8500_reg_init</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Configuration error: value outside mask.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">abx500_mask_and_set_register_interruptible</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">ab8500_reg_init</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">bank</span><span class="p">,</span>
		<span class="n">ab8500_reg_init</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
		<span class="n">ab8500_reg_init</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">mask</span><span class="p">,</span>
		<span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to initialize 0x%02x, 0x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ab8500_reg_init</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">bank</span><span class="p">,</span>
			<span class="n">ab8500_reg_init</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;init: 0x%02x, 0x%02x, 0x%02x, 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ab8500_reg_init</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">bank</span><span class="p">,</span>
		<span class="n">ab8500_reg_init</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
		<span class="n">ab8500_reg_init</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">mask</span><span class="p">,</span>
		<span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="nf">ab8500_regulator_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">regulator_init_data</span> <span class="o">*</span><span class="n">init_data</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">id</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_regulator_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator_config</span> <span class="n">config</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* assign per-regulator data */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_regulator_info</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">config</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">config</span><span class="p">.</span><span class="n">init_data</span> <span class="o">=</span> <span class="n">init_data</span><span class="p">;</span>
	<span class="n">config</span><span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">config</span><span class="p">.</span><span class="n">of_node</span> <span class="o">=</span> <span class="n">np</span><span class="p">;</span>

	<span class="cm">/* fix for hardware before ab8500v2.0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abx500_get_chip_id</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">AB8500_LDO_AUX3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">n_voltages</span> <span class="o">=</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ldo_vauxn_voltages</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">voltages</span> <span class="o">=</span> <span class="n">ldo_vauxn_voltages</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">voltages_len</span> <span class="o">=</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ldo_vauxn_voltages</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">voltage_mask</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* register regulator with framework */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">regulator</span> <span class="o">=</span> <span class="n">regulator_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regulator</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regulator</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register regulator %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="cm">/* when we fail, un-register all earlier regulators */</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_regulator_info</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
			<span class="n">regulator_unregister</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regulator</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">of_regulator_match</span> <span class="n">ab8500_regulator_matches</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ab8500_ldo_aux1&quot;</span><span class="p">,</span>    <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">AB8500_LDO_AUX1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ab8500_ldo_aux2&quot;</span><span class="p">,</span>    <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">AB8500_LDO_AUX2</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ab8500_ldo_aux3&quot;</span><span class="p">,</span>    <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">AB8500_LDO_AUX3</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ab8500_ldo_intcore&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">AB8500_LDO_INTCORE</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ab8500_ldo_tvout&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">AB8500_LDO_TVOUT</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500_ldo_usb&quot;</span><span class="p">,</span>     <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">AB8500_LDO_USB</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500_ldo_audio&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">AB8500_LDO_AUDIO</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ab8500_ldo_anamic1&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">AB8500_LDO_ANAMIC1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ab8500_ldo_amamic2&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">AB8500_LDO_ANAMIC2</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ab8500_ldo_dmic&quot;</span><span class="p">,</span>    <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">AB8500_LDO_DMIC</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ab8500_ldo_ana&quot;</span><span class="p">,</span>     <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">AB8500_LDO_ANA</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span>
<span class="nf">ab8500_regulator_of_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_regulator_info</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ab8500_regulator_register</span><span class="p">(</span>
			<span class="n">pdev</span><span class="p">,</span> <span class="n">ab8500_regulator_matches</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">init_data</span><span class="p">,</span>
			<span class="n">i</span><span class="p">,</span> <span class="n">ab8500_regulator_matches</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">of_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="nf">ab8500_regulator_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ab8500_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">of_regulator_match</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span>
					<span class="n">ab8500_regulator_matches</span><span class="p">,</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_regulator_matches</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Error parsing regulator init data: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">ab8500_regulator_of_probe</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">np</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab8500</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;null mfd parent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pdata</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;null pdata</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* make sure the platform data has the correct size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_regulator</span> <span class="o">!=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_regulator_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Configuration error: size mismatch.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_regulator_reg_init</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>

		<span class="n">id</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">regulator_reg_init</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">regulator_reg_init</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>

		<span class="cm">/* check for configuration errors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">AB8500_NUM_REGULATOR_REGISTERS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Configuration error: id outside range.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">ab8500_regulator_init_registers</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* register all regulators */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_regulator_info</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ab8500_regulator_register</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">regulator</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__devexit</span> <span class="kt">int</span> <span class="nf">ab8500_regulator_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_regulator_info</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ab8500_regulator_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_regulator_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">rdev_get_dev</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regulator</span><span class="p">),</span>
			<span class="s">&quot;%s-remove</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

		<span class="n">regulator_unregister</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">regulator</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">ab8500_regulator_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;stericsson,ab8500-regulator&quot;</span><span class="p">,</span> <span class="p">},</span>
        <span class="p">{}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">ab8500_regulator_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ab8500_regulator_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ab8500_regulator_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>         <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;ab8500-regulator&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">ab8500_regulator_match</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ab8500_regulator_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500_regulator_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to register ab8500 regulator: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">ab8500_regulator_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ab8500_regulator_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500_regulator_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ab8500_regulator_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Sundar Iyer &lt;sundar.iyer@stericsson.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Regulator Driver for ST-Ericsson AB8500 Mixed-Sig PMIC&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:ab8500-regulator&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
