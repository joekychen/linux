<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › dma › txx9dmac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>txx9dmac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for the TXx9 SoC DMA Controller</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Atsushi Nemoto</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>

<span class="cp">#include &quot;dmaengine.h&quot;</span>
<span class="cp">#include &quot;txx9dmac.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="nf">to_txx9dmac_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">txx9dmac_chan</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">txx9dmac_cregs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">__dma_regs</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">ch_regs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">txx9dmac_cregs32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">__dma_regs32</span><span class="p">(</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">ch_regs</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define channel64_readq(dc, name) \</span>
<span class="cp">	__raw_readq(&amp;(__dma_regs(dc)-&gt;name))</span>
<span class="cp">#define channel64_writeq(dc, name, val) \</span>
<span class="cp">	__raw_writeq((val), &amp;(__dma_regs(dc)-&gt;name))</span>
<span class="cp">#define channel64_readl(dc, name) \</span>
<span class="cp">	__raw_readl(&amp;(__dma_regs(dc)-&gt;name))</span>
<span class="cp">#define channel64_writel(dc, name, val) \</span>
<span class="cp">	__raw_writel((val), &amp;(__dma_regs(dc)-&gt;name))</span>

<span class="cp">#define channel32_readl(dc, name) \</span>
<span class="cp">	__raw_readl(&amp;(__dma_regs32(dc)-&gt;name))</span>
<span class="cp">#define channel32_writel(dc, name, val) \</span>
<span class="cp">	__raw_writel((val), &amp;(__dma_regs32(dc)-&gt;name))</span>

<span class="cp">#define channel_readq(dc, name) channel64_readq(dc, name)</span>
<span class="cp">#define channel_writeq(dc, name, val) channel64_writeq(dc, name, val)</span>
<span class="cp">#define channel_readl(dc, name) \</span>
<span class="cp">	(is_dmac64(dc) ? \</span>
<span class="cp">	 channel64_readl(dc, name) : channel32_readl(dc, name))</span>
<span class="cp">#define channel_writel(dc, name, val) \</span>
<span class="cp">	(is_dmac64(dc) ? \</span>
<span class="cp">	 channel64_writel(dc, name, val) : channel32_writel(dc, name, val))</span>

<span class="k">static</span> <span class="n">dma_addr_t</span> <span class="nf">channel64_read_CHAR</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">__dma_regs</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">CHAR</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">channel64_readq</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CHAR</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">channel64_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CHAR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">channel64_write_CHAR</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">__dma_regs</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">CHAR</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span>
		<span class="n">channel64_writeq</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CHAR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">channel64_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CHAR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">channel64_clear_CHAR</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_32BIT) &amp;&amp; !defined(CONFIG_64BIT_PHYS_ADDR)</span>
	<span class="n">channel64_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CHAR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">channel64_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">__pad_CHAR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">channel64_writeq</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CHAR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">dma_addr_t</span> <span class="nf">channel_read_CHAR</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_dmac64</span><span class="p">(</span><span class="n">dc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">channel64_read_CHAR</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">channel32_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CHAR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">channel_write_CHAR</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_dmac64</span><span class="p">(</span><span class="n">dc</span><span class="p">))</span>
		<span class="n">channel64_write_CHAR</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">channel32_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CHAR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">txx9dmac_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">__txx9dmac_regs</span><span class="p">(</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">txx9dmac_dev</span> <span class="o">*</span><span class="n">ddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ddev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">txx9dmac_regs32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">__txx9dmac_regs32</span><span class="p">(</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">txx9dmac_dev</span> <span class="o">*</span><span class="n">ddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ddev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define dma64_readl(ddev, name) \</span>
<span class="cp">	__raw_readl(&amp;(__txx9dmac_regs(ddev)-&gt;name))</span>
<span class="cp">#define dma64_writel(ddev, name, val) \</span>
<span class="cp">	__raw_writel((val), &amp;(__txx9dmac_regs(ddev)-&gt;name))</span>

<span class="cp">#define dma32_readl(ddev, name) \</span>
<span class="cp">	__raw_readl(&amp;(__txx9dmac_regs32(ddev)-&gt;name))</span>
<span class="cp">#define dma32_writel(ddev, name, val) \</span>
<span class="cp">	__raw_writel((val), &amp;(__txx9dmac_regs32(ddev)-&gt;name))</span>

<span class="cp">#define dma_readl(ddev, name) \</span>
<span class="cp">	(__is_dmac64(ddev) ? \</span>
<span class="cp">	dma64_readl(ddev, name) : dma32_readl(ddev, name))</span>
<span class="cp">#define dma_writel(ddev, name, val) \</span>
<span class="cp">	(__is_dmac64(ddev) ? \</span>
<span class="cp">	dma64_writel(ddev, name, val) : dma32_writel(ddev, name, val))</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="nf">chan2dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="nf">chan2parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span>
<span class="nf">txd_to_txx9dmac_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">txd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">txd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">txx9dmac_desc</span><span class="p">,</span> <span class="n">txd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">dma_addr_t</span> <span class="nf">desc_read_CHAR</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">is_dmac64</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span> <span class="o">?</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">CHAR</span> <span class="o">:</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc32</span><span class="p">.</span><span class="n">CHAR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">desc_write_CHAR</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_dmac64</span><span class="p">(</span><span class="n">dc</span><span class="p">))</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">CHAR</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc32</span><span class="p">.</span><span class="n">CHAR</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define TXX9_DMA_MAX_COUNT	0x04000000</span>

<span class="cp">#define TXX9_DMA_INITIAL_DESC_COUNT	64</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="nf">txx9dmac_first_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">txx9dmac_desc</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="nf">txx9dmac_last_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">txx9dmac_desc</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="nf">txx9dmac_first_queued</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">txx9dmac_desc</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="nf">txx9dmac_last_child</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">))</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">),</span> <span class="n">desc_node</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">dma_cookie_t</span> <span class="n">txx9dmac_tx_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="nf">txx9dmac_desc_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">,</span>
						 <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_dev</span> <span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">);</span>
	<span class="n">dma_async_tx_descriptor_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">tx_submit</span> <span class="o">=</span> <span class="n">txx9dmac_tx_submit</span><span class="p">;</span>
	<span class="cm">/* txd.flags will be overwritten in prep funcs */</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DMA_CTRL_ACK</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">chan2parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">,</span>
					<span class="n">ddev</span><span class="o">-&gt;</span><span class="n">descsize</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="nf">txx9dmac_desc_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">async_tx_test_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc_node</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;desc %p not ACKed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;scanned %u descriptors on freelist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">txx9dmac_desc_alloc</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">dc</span><span class="o">-&gt;</span><span class="n">descs_allocated</span><span class="o">++</span><span class="p">;</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
				<span class="s">&quot;not enough descriptors available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txx9dmac_sync_desc_for_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_dev</span> <span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">)</span>
		<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">chan2parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
				<span class="n">child</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">,</span> <span class="n">ddev</span><span class="o">-&gt;</span><span class="n">descsize</span><span class="p">,</span>
				<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">chan2parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">,</span> <span class="n">ddev</span><span class="o">-&gt;</span><span class="n">descsize</span><span class="p">,</span>
			<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Move a descriptor, including any children, to the free list.</span>
<span class="cm"> * `desc&#39; must not be on any lists.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">txx9dmac_desc_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>

		<span class="n">txx9dmac_sync_desc_for_cpu</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">)</span>
			<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
				 <span class="s">&quot;moving child desc %p to freelist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">child</span><span class="p">);</span>
		<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;moving desc %p to freelist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">desc</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txx9dmac_dump_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_dmac64</span><span class="p">(</span><span class="n">dc</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
			<span class="s">&quot;  CHAR: %#llx SAR: %#llx DAR: %#llx CNTR: %#x&quot;</span>
			<span class="s">&quot; SAIR: %#x DAIR: %#x CCR: %#x CSR: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">channel64_read_CHAR</span><span class="p">(</span><span class="n">dc</span><span class="p">),</span>
			<span class="n">channel64_readq</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">SAR</span><span class="p">),</span>
			<span class="n">channel64_readq</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">DAR</span><span class="p">),</span>
			<span class="n">channel64_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CNTR</span><span class="p">),</span>
			<span class="n">channel64_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">SAIR</span><span class="p">),</span>
			<span class="n">channel64_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">DAIR</span><span class="p">),</span>
			<span class="n">channel64_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CCR</span><span class="p">),</span>
			<span class="n">channel64_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CSR</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
			<span class="s">&quot;  CHAR: %#x SAR: %#x DAR: %#x CNTR: %#x&quot;</span>
			<span class="s">&quot; SAIR: %#x DAIR: %#x CCR: %#x CSR: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">channel32_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CHAR</span><span class="p">),</span>
			<span class="n">channel32_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">SAR</span><span class="p">),</span>
			<span class="n">channel32_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">DAR</span><span class="p">),</span>
			<span class="n">channel32_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CNTR</span><span class="p">),</span>
			<span class="n">channel32_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">SAIR</span><span class="p">),</span>
			<span class="n">channel32_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">DAIR</span><span class="p">),</span>
			<span class="n">channel32_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CCR</span><span class="p">),</span>
			<span class="n">channel32_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CSR</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txx9dmac_reset_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">channel_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">TXX9_DMA_CCR_CHRST</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_dmac64</span><span class="p">(</span><span class="n">dc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">channel64_clear_CHAR</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>
		<span class="n">channel_writeq</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">SAR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">channel_writeq</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">DAR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">channel_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CHAR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">channel_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">SAR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">channel_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">DAR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">channel_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CNTR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">channel_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">SAIR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">channel_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">DAIR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">channel_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* Called with dc-&gt;lock held and bh disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">txx9dmac_dostart</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">first</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_slave</span> <span class="o">*</span><span class="n">ds</span> <span class="o">=</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sai</span><span class="p">,</span> <span class="n">dai</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;dostart %u %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
	<span class="cm">/* ASSERT:  channel is idle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXX9_DMA_CSR_XFACT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
			<span class="s">&quot;BUG: Attempted to start non-idle channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">txx9dmac_dump_regs</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>
		<span class="cm">/* The tasklet will hopefully advance the queue... */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_dmac64</span><span class="p">(</span><span class="n">dc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">channel64_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CNTR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">channel64_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CSR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">tx_reg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sai</span> <span class="o">=</span> <span class="n">ds</span><span class="o">-&gt;</span><span class="n">reg_width</span><span class="p">;</span>
				<span class="n">dai</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sai</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">dai</span> <span class="o">=</span> <span class="n">ds</span><span class="o">-&gt;</span><span class="n">reg_width</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sai</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">dai</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">channel64_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">SAIR</span><span class="p">,</span> <span class="n">sai</span><span class="p">);</span>
		<span class="n">channel64_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">DAIR</span><span class="p">,</span> <span class="n">dai</span><span class="p">);</span>
		<span class="cm">/* All 64-bit DMAC supports SMPCHN */</span>
		<span class="n">channel64_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">ccr</span><span class="p">);</span>
		<span class="cm">/* Writing a non zero value to CHAR will assert XFACT */</span>
		<span class="n">channel64_write_CHAR</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">channel32_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CNTR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">channel32_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CSR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">tx_reg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sai</span> <span class="o">=</span> <span class="n">ds</span><span class="o">-&gt;</span><span class="n">reg_width</span><span class="p">;</span>
				<span class="n">dai</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sai</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">dai</span> <span class="o">=</span> <span class="n">ds</span><span class="o">-&gt;</span><span class="n">reg_width</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sai</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">dai</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">channel32_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">SAIR</span><span class="p">,</span> <span class="n">sai</span><span class="p">);</span>
		<span class="n">channel32_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">DAIR</span><span class="p">,</span> <span class="n">dai</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txx9_dma_have_SMPCHN</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">channel32_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">ccr</span><span class="p">);</span>
			<span class="cm">/* Writing a non zero value to CHAR will assert XFACT */</span>
			<span class="n">channel32_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CHAR</span><span class="p">,</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">channel32_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CHAR</span><span class="p">,</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">channel32_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">ccr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">txx9dmac_descriptor_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_async_tx_callback</span> <span class="n">callback</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">txd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_slave</span> <span class="o">*</span><span class="n">ds</span> <span class="o">=</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">private</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;descriptor %u %p complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">txd</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

	<span class="n">dma_cookie_complete</span><span class="p">(</span><span class="n">txd</span><span class="p">);</span>
	<span class="n">callback</span> <span class="o">=</span> <span class="n">txd</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">;</span>
	<span class="n">param</span> <span class="o">=</span> <span class="n">txd</span><span class="o">-&gt;</span><span class="n">callback_param</span><span class="p">;</span>

	<span class="n">txx9dmac_sync_desc_for_cpu</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>
	<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ds</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">dmaaddr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_SKIP_DEST_UNMAP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dmaaddr</span> <span class="o">=</span> <span class="n">is_dmac64</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">DAR</span> <span class="o">:</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc32</span><span class="p">.</span><span class="n">DAR</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_DEST_UNMAP_SINGLE</span><span class="p">)</span>
				<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">chan2parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
					<span class="n">dmaaddr</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">chan2parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
					<span class="n">dmaaddr</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_SKIP_SRC_UNMAP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dmaaddr</span> <span class="o">=</span> <span class="n">is_dmac64</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">SAR</span> <span class="o">:</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc32</span><span class="p">.</span><span class="n">SAR</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_SRC_UNMAP_SINGLE</span><span class="p">)</span>
				<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">chan2parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
					<span class="n">dmaaddr</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">chan2parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
					<span class="n">dmaaddr</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The API requires that no submissions are done from a</span>
<span class="cm">	 * callback, so we don&#39;t need to drop the lock here</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span>
		<span class="n">callback</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="n">dma_run_dependencies</span><span class="p">(</span><span class="n">txd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txx9dmac_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_dev</span> <span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">list</span><span class="p">));</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">txx9dmac_first_queued</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">desc_write_CHAR</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">chan2parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
				<span class="n">prev</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">,</span> <span class="n">ddev</span><span class="o">-&gt;</span><span class="n">descsize</span><span class="p">,</span>
				<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">txx9dmac_last_child</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc_node</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="cm">/* Make chain-completion interrupt happen */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_INTERRUPT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">txx9dmac_chan_INTENT</span><span class="p">(</span><span class="n">dc</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txx9dmac_complete_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">_desc</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Submit queued descriptors ASAP, i.e. before we go through</span>
<span class="cm">	 * the completed ones.</span>
<span class="cm">	 */</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">txx9dmac_dequeue</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">);</span>
		<span class="n">txx9dmac_dostart</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">txx9dmac_first_active</span><span class="p">(</span><span class="n">dc</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">)</span>
		<span class="n">txx9dmac_descriptor_complete</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txx9dmac_dump_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">txx9dmac_hwdesc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_dmac64</span><span class="p">(</span><span class="n">dc</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef TXX9_DMA_USE_SIMPLE_CHAIN</span>
		<span class="n">dev_crit</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
			 <span class="s">&quot;  desc: ch%#llx s%#llx d%#llx c%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">CHAR</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">SAR</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">DAR</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">CNTR</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">dev_crit</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
			 <span class="s">&quot;  desc: ch%#llx s%#llx d%#llx c%#x&quot;</span>
			 <span class="s">&quot; si%#x di%#x cc%#x cs%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">CHAR</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">SAR</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">DAR</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">CNTR</span><span class="p">,</span>
			 <span class="n">desc</span><span class="o">-&gt;</span><span class="n">SAIR</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">DAIR</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">CCR</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">CSR</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">txx9dmac_hwdesc32</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_hwdesc32</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">;</span>
<span class="cp">#ifdef TXX9_DMA_USE_SIMPLE_CHAIN</span>
		<span class="n">dev_crit</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
			 <span class="s">&quot;  desc: ch%#x s%#x d%#x c%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">d</span><span class="o">-&gt;</span><span class="n">CHAR</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">SAR</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">DAR</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">CNTR</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">dev_crit</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
			 <span class="s">&quot;  desc: ch%#x s%#x d%#x c%#x&quot;</span>
			 <span class="s">&quot; si%#x di%#x cc%#x cs%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">d</span><span class="o">-&gt;</span><span class="n">CHAR</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">SAR</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">DAR</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">CNTR</span><span class="p">,</span>
			 <span class="n">d</span><span class="o">-&gt;</span><span class="n">SAIR</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">DAIR</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">CCR</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">CSR</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txx9dmac_handle_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">csr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">bad_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">errors</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The descriptor currently at the head of the active list is</span>
<span class="cm">	 * borked. Since we don&#39;t have any way to report errors, we&#39;ll</span>
<span class="cm">	 * just have to scream loudly and try to carry on.</span>
<span class="cm">	 */</span>
	<span class="n">dev_crit</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;Abnormal Chain Completion</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">txx9dmac_dump_regs</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>

	<span class="n">bad_desc</span> <span class="o">=</span> <span class="n">txx9dmac_first_active</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bad_desc</span><span class="o">-&gt;</span><span class="n">desc_node</span><span class="p">);</span>

	<span class="cm">/* Clear all error flags and try to restart the controller */</span>
	<span class="n">errors</span> <span class="o">=</span> <span class="n">csr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TXX9_DMA_CSR_ABCHC</span> <span class="o">|</span>
			<span class="n">TXX9_DMA_CSR_CFERR</span> <span class="o">|</span> <span class="n">TXX9_DMA_CSR_CHERR</span> <span class="o">|</span>
			<span class="n">TXX9_DMA_CSR_DESERR</span> <span class="o">|</span> <span class="n">TXX9_DMA_CSR_SORERR</span><span class="p">);</span>
	<span class="n">channel_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CSR</span><span class="p">,</span> <span class="n">errors</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">txx9dmac_dequeue</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">))</span>
		<span class="n">txx9dmac_dostart</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">txx9dmac_first_active</span><span class="p">(</span><span class="n">dc</span><span class="p">));</span>

	<span class="n">dev_crit</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
		 <span class="s">&quot;Bad descriptor submitted for DMA! (cookie: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">bad_desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span><span class="p">);</span>
	<span class="n">txx9dmac_dump_desc</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_desc</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bad_desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">)</span>
		<span class="n">txx9dmac_dump_desc</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">);</span>
	<span class="cm">/* Pretend the descriptor completed successfully */</span>
	<span class="n">txx9dmac_descriptor_complete</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">bad_desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txx9dmac_scan_descriptors</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">chain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">csr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_dmac64</span><span class="p">(</span><span class="n">dc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chain</span> <span class="o">=</span> <span class="n">channel64_read_CHAR</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>
		<span class="n">csr</span> <span class="o">=</span> <span class="n">channel64_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CSR</span><span class="p">);</span>
		<span class="n">channel64_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CSR</span><span class="p">,</span> <span class="n">csr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chain</span> <span class="o">=</span> <span class="n">channel32_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CHAR</span><span class="p">);</span>
		<span class="n">csr</span> <span class="o">=</span> <span class="n">channel32_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CSR</span><span class="p">);</span>
		<span class="n">channel32_writel</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CSR</span><span class="p">,</span> <span class="n">csr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* For dynamic chain, we should look at XFACT instead of NCHNC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TXX9_DMA_CSR_XFACT</span> <span class="o">|</span> <span class="n">TXX9_DMA_CSR_ABCHC</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Everything we&#39;ve submitted is done */</span>
		<span class="n">txx9dmac_complete_all</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">TXX9_DMA_CSR_CHNEN</span><span class="p">))</span>
		<span class="n">chain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* last descriptor of this chain */</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;scan_descriptors: char=%#llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">chain</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc_read_CHAR</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span> <span class="o">==</span> <span class="n">chain</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This one is currently in progress */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">TXX9_DMA_CSR_ABCHC</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">scan_done</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">desc_read_CHAR</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span> <span class="o">==</span> <span class="n">chain</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Currently in progress */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">TXX9_DMA_CSR_ABCHC</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">scan_done</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * No descriptors so far seem to be in progress, i.e.</span>
<span class="cm">		 * this one must be done.</span>
<span class="cm">		 */</span>
		<span class="n">txx9dmac_descriptor_complete</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">scan_done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">TXX9_DMA_CSR_ABCHC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txx9dmac_handle_error</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">csr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
		<span class="s">&quot;BUG: All descriptors done, but channel not idle!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Try to continue after resetting the channel... */</span>
	<span class="n">txx9dmac_reset_chan</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">txx9dmac_dequeue</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">);</span>
		<span class="n">txx9dmac_dostart</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">txx9dmac_first_active</span><span class="p">(</span><span class="n">dc</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txx9dmac_chan_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">csr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">;</span>

	<span class="n">dc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">csr</span> <span class="o">=</span> <span class="n">channel_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CSR</span><span class="p">);</span>
	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;tasklet: status=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csr</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TXX9_DMA_CSR_ABCHC</span> <span class="o">|</span> <span class="n">TXX9_DMA_CSR_NCHNC</span> <span class="o">|</span>
		   <span class="n">TXX9_DMA_CSR_NTRNFC</span><span class="p">))</span>
		<span class="n">txx9dmac_scan_descriptors</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">enable_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">txx9dmac_chan_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;interrupt: status=%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">channel_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CSR</span><span class="p">));</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Just disable the interrupts. We&#39;ll turn them back on in the</span>
<span class="cm">	 * softirq handler.</span>
<span class="cm">	 */</span>
	<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txx9dmac_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">csr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">txx9dmac_dev</span> <span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mcr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mcr</span> <span class="o">=</span> <span class="n">dma_readl</span><span class="p">(</span><span class="n">ddev</span><span class="p">,</span> <span class="n">MCR</span><span class="p">);</span>
	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tasklet: mcr=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mcr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TXX9_DMA_MAX_NR_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mcr</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">24</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x11</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dc</span> <span class="o">=</span> <span class="n">ddev</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">csr</span> <span class="o">=</span> <span class="n">channel_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CSR</span><span class="p">);</span>
			<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;tasklet: status=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">csr</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TXX9_DMA_CSR_ABCHC</span> <span class="o">|</span> <span class="n">TXX9_DMA_CSR_NCHNC</span> <span class="o">|</span>
				   <span class="n">TXX9_DMA_CSR_NTRNFC</span><span class="p">))</span>
				<span class="n">txx9dmac_scan_descriptors</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">ddev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">enable_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">txx9dmac_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_dev</span> <span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;interrupt: status=%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dma_readl</span><span class="p">(</span><span class="n">ddev</span><span class="p">,</span> <span class="n">MCR</span><span class="p">));</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Just disable the interrupts. We&#39;ll turn them back on in the</span>
<span class="cm">	 * softirq handler.</span>
<span class="cm">	 */</span>
	<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">dma_cookie_t</span> <span class="nf">txx9dmac_tx_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">txd_to_txx9dmac_desc</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span> <span class="o">=</span> <span class="n">to_txx9dmac_chan</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cookie</span> <span class="o">=</span> <span class="n">dma_cookie_assign</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;tx_submit: queued %u %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">cookie</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cookie</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">txx9dmac_prep_dma_memcpy</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">src</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span> <span class="o">=</span> <span class="n">to_txx9dmac_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">txx9dmac_dev</span> <span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">first</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">xfer_count</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;prep_dma_memcpy d%#llx s%#llx l%#zx f%#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">dest</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;prep_dma_memcpy: length is zero!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prev</span> <span class="o">=</span> <span class="n">first</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">offset</span> <span class="o">+=</span> <span class="n">xfer_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfer_count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">TXX9_DMA_MAX_COUNT</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Workaround for ERT-TX49H2-033, ERT-TX49H3-020,</span>
<span class="cm">		 * ERT-TX49H4-016 (slightly conservative)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__is_dmac64</span><span class="p">(</span><span class="n">ddev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xfer_count</span> <span class="o">&gt;</span> <span class="mh">0x100</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">xfer_count</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0xfa</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">xfer_count</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mh">0xff</span><span class="p">)</span>
				<span class="n">xfer_count</span> <span class="o">-=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xfer_count</span> <span class="o">&gt;</span> <span class="mh">0x80</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">xfer_count</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x7e</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">xfer_count</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mh">0x7f</span><span class="p">)</span>
				<span class="n">xfer_count</span> <span class="o">-=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">desc</span> <span class="o">=</span> <span class="n">txx9dmac_desc_get</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txx9dmac_desc_put</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__is_dmac64</span><span class="p">(</span><span class="n">ddev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">SAR</span> <span class="o">=</span> <span class="n">src</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">DAR</span> <span class="o">=</span> <span class="n">dest</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">CNTR</span> <span class="o">=</span> <span class="n">xfer_count</span><span class="p">;</span>
			<span class="n">txx9dmac_desc_set_nosimple</span><span class="p">(</span><span class="n">ddev</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
					<span class="n">dc</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">|</span> <span class="n">TXX9_DMA_CCR_XFACT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc32</span><span class="p">.</span><span class="n">SAR</span> <span class="o">=</span> <span class="n">src</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc32</span><span class="p">.</span><span class="n">DAR</span> <span class="o">=</span> <span class="n">dest</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc32</span><span class="p">.</span><span class="n">CNTR</span> <span class="o">=</span> <span class="n">xfer_count</span><span class="p">;</span>
			<span class="n">txx9dmac_desc_set_nosimple</span><span class="p">(</span><span class="n">ddev</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
					<span class="n">dc</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">|</span> <span class="n">TXX9_DMA_CCR_XFACT</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * The descriptors on tx_list are not reachable from</span>
<span class="cm">		 * the dc-&gt;queue list or dc-&gt;active_list after a</span>
<span class="cm">		 * submit.  If we put all descriptors on active_list,</span>
<span class="cm">		 * calling of callback on the completion will be more</span>
<span class="cm">		 * complex.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">first</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">desc_write_CHAR</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">chan2parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
					<span class="n">prev</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">,</span> <span class="n">ddev</span><span class="o">-&gt;</span><span class="n">descsize</span><span class="p">,</span>
					<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Trigger interrupt after last block */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_INTERRUPT</span><span class="p">)</span>
		<span class="n">txx9dmac_desc_set_INTENT</span><span class="p">(</span><span class="n">ddev</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>

	<span class="n">desc_write_CHAR</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">chan2parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
			<span class="n">prev</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">,</span> <span class="n">ddev</span><span class="o">-&gt;</span><span class="n">descsize</span><span class="p">,</span>
			<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">txx9dmac_prep_slave_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sgl</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">direction</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span> <span class="o">=</span> <span class="n">to_txx9dmac_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">txx9dmac_dev</span> <span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_slave</span> <span class="o">*</span><span class="n">ds</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">first</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;prep_dma_slave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ds</span> <span class="o">||</span> <span class="o">!</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">reg_width</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">tx_reg</span><span class="p">)</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">direction</span> <span class="o">!=</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">direction</span> <span class="o">!=</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">sg_len</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">prev</span> <span class="o">=</span> <span class="n">first</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">mem</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">sai</span><span class="p">,</span> <span class="n">dai</span><span class="p">;</span>

		<span class="n">desc</span> <span class="o">=</span> <span class="n">txx9dmac_desc_get</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txx9dmac_desc_put</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mem</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__is_dmac64</span><span class="p">(</span><span class="n">ddev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">SAR</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">DAR</span> <span class="o">=</span> <span class="n">ds</span><span class="o">-&gt;</span><span class="n">tx_reg</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">SAR</span> <span class="o">=</span> <span class="n">ds</span><span class="o">-&gt;</span><span class="n">rx_reg</span><span class="p">;</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">DAR</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">CNTR</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc32</span><span class="p">.</span><span class="n">SAR</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc32</span><span class="p">.</span><span class="n">DAR</span> <span class="o">=</span> <span class="n">ds</span><span class="o">-&gt;</span><span class="n">tx_reg</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc32</span><span class="p">.</span><span class="n">SAR</span> <span class="o">=</span> <span class="n">ds</span><span class="o">-&gt;</span><span class="n">rx_reg</span><span class="p">;</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc32</span><span class="p">.</span><span class="n">DAR</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hwdesc32</span><span class="p">.</span><span class="n">CNTR</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sai</span> <span class="o">=</span> <span class="n">ds</span><span class="o">-&gt;</span><span class="n">reg_width</span><span class="p">;</span>
			<span class="n">dai</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sai</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dai</span> <span class="o">=</span> <span class="n">ds</span><span class="o">-&gt;</span><span class="n">reg_width</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">txx9dmac_desc_set_nosimple</span><span class="p">(</span><span class="n">ddev</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">sai</span><span class="p">,</span> <span class="n">dai</span><span class="p">,</span>
					<span class="n">dc</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">|</span> <span class="n">TXX9_DMA_CCR_XFACT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">first</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">desc_write_CHAR</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">chan2parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
					<span class="n">prev</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">,</span>
					<span class="n">ddev</span><span class="o">-&gt;</span><span class="n">descsize</span><span class="p">,</span>
					<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Trigger interrupt after last block */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_INTERRUPT</span><span class="p">)</span>
		<span class="n">txx9dmac_desc_set_INTENT</span><span class="p">(</span><span class="n">ddev</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>

	<span class="n">desc_write_CHAR</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">chan2parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
			<span class="n">prev</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">,</span> <span class="n">ddev</span><span class="o">-&gt;</span><span class="n">descsize</span><span class="p">,</span>
			<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">txx9dmac_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_ctrl_cmd</span> <span class="n">cmd</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span> <span class="o">=</span> <span class="n">to_txx9dmac_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">_desc</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="cm">/* Only supports DMA_TERMINATE_ALL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">DMA_TERMINATE_ALL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;terminate_all</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">txx9dmac_reset_chan</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>

	<span class="cm">/* active_list entries will end up before queued entries */</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Flush all pending and queued descriptors */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">)</span>
		<span class="n">txx9dmac_descriptor_complete</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">dma_status</span>
<span class="nf">txx9dmac_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">dma_tx_state</span> <span class="o">*</span><span class="n">txstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span> <span class="o">=</span> <span class="n">to_txx9dmac_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">dma_status</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_cookie_status</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">txstate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">DMA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">txx9dmac_scan_descriptors</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_cookie_status</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">txstate</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txx9dmac_chain_dynamic</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">prev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_dev</span> <span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="n">prev</span> <span class="o">=</span> <span class="n">txx9dmac_last_child</span><span class="p">(</span><span class="n">prev</span><span class="p">);</span>
	<span class="n">txx9dmac_dequeue</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">txx9dmac_desc</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">);</span>
	<span class="n">desc_write_CHAR</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">chan2parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">),</span>
				   <span class="n">prev</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">,</span> <span class="n">ddev</span><span class="o">-&gt;</span><span class="n">descsize</span><span class="p">,</span>
				   <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">channel_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXX9_DMA_CSR_CHNEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">channel_read_CHAR</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span> <span class="o">==</span> <span class="n">prev</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">)</span>
		<span class="cm">/* Restart chain DMA */</span>
		<span class="n">channel_write_CHAR</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">list_splice_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txx9dmac_issue_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span> <span class="o">=</span> <span class="n">to_txx9dmac_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">))</span>
		<span class="n">txx9dmac_scan_descriptors</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">txx9dmac_dequeue</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">);</span>
			<span class="n">txx9dmac_dostart</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">txx9dmac_first_active</span><span class="p">(</span><span class="n">dc</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">txx9_dma_have_SMPCHN</span><span class="p">())</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="n">txx9dmac_last_active</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_INTERRUPT</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">txx9dmac_chan_INTENT</span><span class="p">(</span><span class="n">dc</span><span class="p">))</span>
				<span class="n">txx9dmac_chain_dynamic</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">txx9dmac_alloc_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span> <span class="o">=</span> <span class="n">to_txx9dmac_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">txx9dmac_slave</span> <span class="o">*</span><span class="n">ds</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;alloc_chan_resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* ASSERT:  channel is idle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXX9_DMA_CSR_XFACT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;DMA channel not idle?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_cookie_init</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">dc</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">=</span> <span class="n">TXX9_DMA_CCR_IMMCHN</span> <span class="o">|</span> <span class="n">TXX9_DMA_CCR_INTENE</span> <span class="o">|</span> <span class="n">CCR_LE</span><span class="p">;</span>
	<span class="n">txx9dmac_chan_set_SMPCHN</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txx9_dma_have_SMPCHN</span><span class="p">()</span> <span class="o">||</span> <span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">&amp;</span> <span class="n">TXX9_DMA_CCR_SMPCHN</span><span class="p">))</span>
		<span class="n">dc</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">|=</span> <span class="n">TXX9_DMA_CCR_INTENC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_prep_dma_memcpy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ds</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">dc</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">|=</span> <span class="n">TXX9_DMA_CCR_XFSZ_X8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ds</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">tx_reg</span> <span class="o">&amp;&amp;</span> <span class="n">ds</span><span class="o">-&gt;</span><span class="n">rx_reg</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">tx_reg</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">rx_reg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">dc</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">|=</span> <span class="n">TXX9_DMA_CCR_EXTRQ</span> <span class="o">|</span>
			<span class="n">TXX9_DMA_CCR_XFSZ</span><span class="p">(</span><span class="n">__ffs</span><span class="p">(</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">reg_width</span><span class="p">));</span>
		<span class="n">txx9dmac_chan_set_INTENT</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">descs_allocated</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">descs_allocated</span> <span class="o">&lt;</span> <span class="n">TXX9_DMA_INITIAL_DESC_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">desc</span> <span class="o">=</span> <span class="n">txx9dmac_desc_alloc</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span>
				<span class="s">&quot;only allocated %d descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">txx9dmac_desc_put</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="o">++</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">descs_allocated</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span>
		<span class="s">&quot;alloc_chan_resources allocated %d descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txx9dmac_free_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span> <span class="o">=</span> <span class="n">to_txx9dmac_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">txx9dmac_dev</span> <span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">_desc</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;free_chan_resources (descs allocated=%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dc</span><span class="o">-&gt;</span><span class="n">descs_allocated</span><span class="p">);</span>

	<span class="cm">/* ASSERT:  channel is idle */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">channel_readl</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">CSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXX9_DMA_CSR_XFACT</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">dc</span><span class="o">-&gt;</span><span class="n">descs_allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="n">desc_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;  freeing descriptor %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">chan2parent</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">,</span>
				 <span class="n">ddev</span><span class="o">-&gt;</span><span class="n">descsize</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;free_chan_resources done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txx9dmac_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_dev</span> <span class="o">*</span><span class="n">ddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_writel</span><span class="p">(</span><span class="n">ddev</span><span class="p">,</span> <span class="n">MCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">txx9dmac_chan_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_chan_platform_data</span> <span class="o">*</span><span class="n">cpdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dmac_dev</span> <span class="o">=</span> <span class="n">cpdata</span><span class="o">-&gt;</span><span class="n">dmac_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">dmac_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">%</span> <span class="n">TXX9_DMA_MAX_NR_CHANNELS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">dc</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">device_alloc_chan_resources</span> <span class="o">=</span> <span class="n">txx9dmac_alloc_chan_resources</span><span class="p">;</span>
	<span class="n">dc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">device_free_chan_resources</span> <span class="o">=</span> <span class="n">txx9dmac_free_chan_resources</span><span class="p">;</span>
	<span class="n">dc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">device_control</span> <span class="o">=</span> <span class="n">txx9dmac_control</span><span class="p">;</span>
	<span class="n">dc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">device_tx_status</span> <span class="o">=</span> <span class="n">txx9dmac_tx_status</span><span class="p">;</span>
	<span class="n">dc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">device_issue_pending</span> <span class="o">=</span> <span class="n">txx9dmac_issue_pending</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">memcpy_chan</span> <span class="o">==</span> <span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">device_prep_dma_memcpy</span> <span class="o">=</span> <span class="n">txx9dmac_prep_dma_memcpy</span><span class="p">;</span>
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">device_prep_slave_sg</span> <span class="o">=</span> <span class="n">txx9dmac_prep_slave_sg</span><span class="p">;</span>
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_PRIVATE</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">channels</span><span class="p">);</span>
	<span class="n">dc</span><span class="o">-&gt;</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dmac_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">irq</span><span class="p">;</span>
		<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">,</span> <span class="n">txx9dmac_chan_tasklet</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dc</span><span class="p">);</span>
		<span class="n">dc</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">devm_request_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
			<span class="n">txx9dmac_chan_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">dc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dc</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">dc</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="n">dc</span><span class="p">;</span>
	<span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>
	<span class="n">dma_cookie_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_dmac64</span><span class="p">(</span><span class="n">dc</span><span class="p">))</span>
		<span class="n">dc</span><span class="o">-&gt;</span><span class="n">ch_regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__txx9dmac_regs</span><span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">CHAN</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">dc</span><span class="o">-&gt;</span><span class="n">ch_regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__txx9dmac_regs32</span><span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">CHAN</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>

	<span class="n">txx9dmac_reset_chan</span><span class="p">(</span><span class="n">dc</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dc</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">dma_async_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TXx9 DMA Channel (dma%d%s%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">dev_id</span><span class="p">,</span>
		<span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; memcpy&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; slave&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">txx9dmac_chan_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_chan</span> <span class="o">*</span><span class="n">dc</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">dma_async_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
	<span class="n">dc</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">%</span> <span class="n">TXX9_DMA_MAX_NR_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">txx9dmac_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">io</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txx9dmac_dev</span> <span class="o">*</span><span class="n">ddev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mcr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">io</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ddev</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ddev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ddev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devm_request_mem_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">io</span><span class="p">),</span>
				     <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">ddev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">devm_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">io</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ddev</span><span class="o">-&gt;</span><span class="n">have_64bit_regs</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">have_64bit_regs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__is_dmac64</span><span class="p">(</span><span class="n">ddev</span><span class="p">))</span>
		<span class="n">ddev</span><span class="o">-&gt;</span><span class="n">descsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_hwdesc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ddev</span><span class="o">-&gt;</span><span class="n">descsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">txx9dmac_hwdesc32</span><span class="p">);</span>

	<span class="cm">/* force dma off, just in case */</span>
	<span class="n">txx9dmac_off</span><span class="p">(</span><span class="n">ddev</span><span class="p">);</span>

	<span class="n">ddev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">,</span> <span class="n">txx9dmac_tasklet</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ddev</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">devm_request_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ddev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
			<span class="n">txx9dmac_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">ddev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mcr</span> <span class="o">=</span> <span class="n">TXX9_DMA_MCR_MSTEN</span> <span class="o">|</span> <span class="n">MCR_LE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">memcpy_chan</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">TXX9_DMA_MCR_FIFUM</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">memcpy_chan</span><span class="p">);</span>
	<span class="n">dma_writel</span><span class="p">(</span><span class="n">ddev</span><span class="p">,</span> <span class="n">MCR</span><span class="p">,</span> <span class="n">mcr</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ddev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">txx9dmac_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_dev</span> <span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">txx9dmac_off</span><span class="p">(</span><span class="n">ddev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">txx9dmac_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txx9dmac_dev</span> <span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">txx9dmac_off</span><span class="p">(</span><span class="n">ddev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">txx9dmac_suspend_noirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">txx9dmac_dev</span> <span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">txx9dmac_off</span><span class="p">(</span><span class="n">ddev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">txx9dmac_resume_noirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">txx9dmac_dev</span> <span class="o">*</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">txx9dmac_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mcr</span><span class="p">;</span>

	<span class="n">mcr</span> <span class="o">=</span> <span class="n">TXX9_DMA_MCR_MSTEN</span> <span class="o">|</span> <span class="n">MCR_LE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">memcpy_chan</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">TXX9_DMA_MCR_FIFUM</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">memcpy_chan</span><span class="p">);</span>
	<span class="n">dma_writel</span><span class="p">(</span><span class="n">ddev</span><span class="p">,</span> <span class="n">MCR</span><span class="p">,</span> <span class="n">mcr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">txx9dmac_dev_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend_noirq</span> <span class="o">=</span> <span class="n">txx9dmac_suspend_noirq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume_noirq</span> <span class="o">=</span> <span class="n">txx9dmac_resume_noirq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">txx9dmac_chan_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">txx9dmac_chan_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;txx9dmac-chan&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">txx9dmac_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">txx9dmac_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">txx9dmac_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;txx9dmac&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">txx9dmac_dev_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">txx9dmac_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txx9dmac_driver</span><span class="p">,</span> <span class="n">txx9dmac_probe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txx9dmac_chan_driver</span><span class="p">,</span>
					   <span class="n">txx9dmac_chan_probe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txx9dmac_driver</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">txx9dmac_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">txx9dmac_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txx9dmac_chan_driver</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txx9dmac_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">txx9dmac_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;TXx9 DMA Controller driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Atsushi Nemoto &lt;anemo@mba.ocn.ne.jp&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:txx9dmac&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:txx9dmac-chan&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
