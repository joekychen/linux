<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › dma › imx-sdma.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>imx-sdma.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/dma/imx-sdma.c</span>
<span class="cm"> *</span>
<span class="cm"> * This file contains a driver for the Freescale Smart DMA engine</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2010 Sascha Hauer, Pengutronix &lt;s.hauer@pengutronix.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on code from Freescale:</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2004-2009 Freescale Semiconductor, Inc. All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * The code contained herein is licensed under the GNU General Public</span>
<span class="cm"> * License. You may obtain a copy of the GNU General Public License</span>
<span class="cm"> * Version 2 or later at the following locations:</span>
<span class="cm"> *</span>
<span class="cm"> * http://www.opensource.org/licenses/gpl-license.html</span>
<span class="cm"> * http://www.gnu.org/copyleft/gpl.html</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/semaphore.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>

<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;mach/sdma.h&gt;</span>
<span class="cp">#include &lt;mach/dma.h&gt;</span>
<span class="cp">#include &lt;mach/hardware.h&gt;</span>

<span class="cp">#include &quot;dmaengine.h&quot;</span>

<span class="cm">/* SDMA registers */</span>
<span class="cp">#define SDMA_H_C0PTR		0x000</span>
<span class="cp">#define SDMA_H_INTR		0x004</span>
<span class="cp">#define SDMA_H_STATSTOP		0x008</span>
<span class="cp">#define SDMA_H_START		0x00c</span>
<span class="cp">#define SDMA_H_EVTOVR		0x010</span>
<span class="cp">#define SDMA_H_DSPOVR		0x014</span>
<span class="cp">#define SDMA_H_HOSTOVR		0x018</span>
<span class="cp">#define SDMA_H_EVTPEND		0x01c</span>
<span class="cp">#define SDMA_H_DSPENBL		0x020</span>
<span class="cp">#define SDMA_H_RESET		0x024</span>
<span class="cp">#define SDMA_H_EVTERR		0x028</span>
<span class="cp">#define SDMA_H_INTRMSK		0x02c</span>
<span class="cp">#define SDMA_H_PSW		0x030</span>
<span class="cp">#define SDMA_H_EVTERRDBG	0x034</span>
<span class="cp">#define SDMA_H_CONFIG		0x038</span>
<span class="cp">#define SDMA_ONCE_ENB		0x040</span>
<span class="cp">#define SDMA_ONCE_DATA		0x044</span>
<span class="cp">#define SDMA_ONCE_INSTR		0x048</span>
<span class="cp">#define SDMA_ONCE_STAT		0x04c</span>
<span class="cp">#define SDMA_ONCE_CMD		0x050</span>
<span class="cp">#define SDMA_EVT_MIRROR		0x054</span>
<span class="cp">#define SDMA_ILLINSTADDR	0x058</span>
<span class="cp">#define SDMA_CHN0ADDR		0x05c</span>
<span class="cp">#define SDMA_ONCE_RTB		0x060</span>
<span class="cp">#define SDMA_XTRIG_CONF1	0x070</span>
<span class="cp">#define SDMA_XTRIG_CONF2	0x074</span>
<span class="cp">#define SDMA_CHNENBL0_IMX35	0x200</span>
<span class="cp">#define SDMA_CHNENBL0_IMX31	0x080</span>
<span class="cp">#define SDMA_CHNPRI_0		0x100</span>

<span class="cm">/*</span>
<span class="cm"> * Buffer descriptor status values.</span>
<span class="cm"> */</span>
<span class="cp">#define BD_DONE  0x01</span>
<span class="cp">#define BD_WRAP  0x02</span>
<span class="cp">#define BD_CONT  0x04</span>
<span class="cp">#define BD_INTR  0x08</span>
<span class="cp">#define BD_RROR  0x10</span>
<span class="cp">#define BD_LAST  0x20</span>
<span class="cp">#define BD_EXTD  0x80</span>

<span class="cm">/*</span>
<span class="cm"> * Data Node descriptor status values.</span>
<span class="cm"> */</span>
<span class="cp">#define DND_END_OF_FRAME  0x80</span>
<span class="cp">#define DND_END_OF_XFER   0x40</span>
<span class="cp">#define DND_DONE          0x20</span>
<span class="cp">#define DND_UNUSED        0x01</span>

<span class="cm">/*</span>
<span class="cm"> * IPCV2 descriptor status values.</span>
<span class="cm"> */</span>
<span class="cp">#define BD_IPCV2_END_OF_FRAME  0x40</span>

<span class="cp">#define IPCV2_MAX_NODES        50</span>
<span class="cm">/*</span>
<span class="cm"> * Error bit set in the CCB status field by the SDMA,</span>
<span class="cm"> * in setbd routine, in case of a transfer error</span>
<span class="cm"> */</span>
<span class="cp">#define DATA_ERROR  0x10000000</span>

<span class="cm">/*</span>
<span class="cm"> * Buffer descriptor commands.</span>
<span class="cm"> */</span>
<span class="cp">#define C0_ADDR             0x01</span>
<span class="cp">#define C0_LOAD             0x02</span>
<span class="cp">#define C0_DUMP             0x03</span>
<span class="cp">#define C0_SETCTX           0x07</span>
<span class="cp">#define C0_GETCTX           0x03</span>
<span class="cp">#define C0_SETDM            0x01</span>
<span class="cp">#define C0_SETPM            0x04</span>
<span class="cp">#define C0_GETDM            0x02</span>
<span class="cp">#define C0_GETPM            0x08</span>
<span class="cm">/*</span>
<span class="cm"> * Change endianness indicator in the BD command field</span>
<span class="cm"> */</span>
<span class="cp">#define CHANGE_ENDIANNESS   0x80</span>

<span class="cm">/*</span>
<span class="cm"> * Mode/Count of data node descriptors - IPCv2</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sdma_mode_count</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">count</span>   <span class="o">:</span> <span class="mi">16</span><span class="p">;</span> <span class="cm">/* size of the buffer pointed by this BD */</span>
	<span class="n">u32</span> <span class="n">status</span>  <span class="o">:</span>  <span class="mi">8</span><span class="p">;</span> <span class="cm">/* E,R,I,C,W,D status bits stored here */</span>
	<span class="n">u32</span> <span class="n">command</span> <span class="o">:</span>  <span class="mi">8</span><span class="p">;</span> <span class="cm">/* command mostlky used for channel 0 */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Buffer descriptor</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sdma_buffer_descriptor</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_mode_count</span>  <span class="n">mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buffer_addr</span><span class="p">;</span>	<span class="cm">/* address of the buffer described */</span>
	<span class="n">u32</span> <span class="n">ext_buffer_addr</span><span class="p">;</span>	<span class="cm">/* extended buffer address */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/**</span>
<span class="cm"> * struct sdma_channel_control - Channel control Block</span>
<span class="cm"> *</span>
<span class="cm"> * @current_bd_ptr	current buffer descriptor processed</span>
<span class="cm"> * @base_bd_ptr		first element of buffer descriptor array</span>
<span class="cm"> * @unused		padding. The SDMA engine expects an array of 128 byte</span>
<span class="cm"> *			control blocks</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sdma_channel_control</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">current_bd_ptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">base_bd_ptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">unused</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/**</span>
<span class="cm"> * struct sdma_state_registers - SDMA context for a channel</span>
<span class="cm"> *</span>
<span class="cm"> * @pc:		program counter</span>
<span class="cm"> * @t:		test bit: status of arithmetic &amp; test instruction</span>
<span class="cm"> * @rpc:	return program counter</span>
<span class="cm"> * @sf:		source fault while loading data</span>
<span class="cm"> * @spc:	loop start program counter</span>
<span class="cm"> * @df:		destination fault while storing data</span>
<span class="cm"> * @epc:	loop end program counter</span>
<span class="cm"> * @lm:		loop mode</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sdma_state_registers</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">pc</span>     <span class="o">:</span><span class="mi">14</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">unused1</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">t</span>      <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rpc</span>    <span class="o">:</span><span class="mi">14</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">unused0</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sf</span>     <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">spc</span>    <span class="o">:</span><span class="mi">14</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">unused2</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">df</span>     <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">epc</span>    <span class="o">:</span><span class="mi">14</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lm</span>     <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/**</span>
<span class="cm"> * struct sdma_context_data - sdma context specific to a channel</span>
<span class="cm"> *</span>
<span class="cm"> * @channel_state:	channel state bits</span>
<span class="cm"> * @gReg:		general registers</span>
<span class="cm"> * @mda:		burst dma destination address register</span>
<span class="cm"> * @msa:		burst dma source address register</span>
<span class="cm"> * @ms:			burst dma status register</span>
<span class="cm"> * @md:			burst dma data register</span>
<span class="cm"> * @pda:		peripheral dma destination address register</span>
<span class="cm"> * @psa:		peripheral dma source address register</span>
<span class="cm"> * @ps:			peripheral dma status register</span>
<span class="cm"> * @pd:			peripheral dma data register</span>
<span class="cm"> * @ca:			CRC polynomial register</span>
<span class="cm"> * @cs:			CRC accumulator register</span>
<span class="cm"> * @dda:		dedicated core destination address register</span>
<span class="cm"> * @dsa:		dedicated core source address register</span>
<span class="cm"> * @ds:			dedicated core status register</span>
<span class="cm"> * @dd:			dedicated core data register</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sdma_context_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_state_registers</span>  <span class="n">channel_state</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">gReg</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u32</span>  <span class="n">mda</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">msa</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">ms</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">md</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">pda</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">psa</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">ps</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">pd</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">ca</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">cs</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">dda</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">dsa</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">ds</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">dd</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">scratch0</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">scratch1</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">scratch2</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">scratch3</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">scratch4</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">scratch5</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">scratch6</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">scratch7</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cp">#define NUM_BD (int)(PAGE_SIZE / sizeof(struct sdma_buffer_descriptor))</span>

<span class="k">struct</span> <span class="n">sdma_engine</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * struct sdma_channel - housekeeping for a SDMA channel</span>
<span class="cm"> *</span>
<span class="cm"> * @sdma		pointer to the SDMA engine for this channel</span>
<span class="cm"> * @channel		the channel number, matches dmaengine chan_id + 1</span>
<span class="cm"> * @direction		transfer type. Needed for setting SDMA script</span>
<span class="cm"> * @peripheral_type	Peripheral type. Needed for setting SDMA script</span>
<span class="cm"> * @event_id0		aka dma request line</span>
<span class="cm"> * @event_id1		for channels that use 2 events</span>
<span class="cm"> * @word_size		peripheral access size</span>
<span class="cm"> * @buf_tail		ID of the buffer that was processed</span>
<span class="cm"> * @done		channel completion</span>
<span class="cm"> * @num_bd		max NUM_BD. number of descriptors currently handling</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sdma_channel</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_engine</span>		<span class="o">*</span><span class="n">sdma</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">channel</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_transfer_direction</span>		<span class="n">direction</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sdma_peripheral_type</span>	<span class="n">peripheral_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">event_id0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">event_id1</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_slave_buswidth</span>		<span class="n">word_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">buf_tail</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>		<span class="n">done</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">num_bd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdma_buffer_descriptor</span>	<span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>			<span class="n">bd_phys</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">pc_from_device</span><span class="p">,</span> <span class="n">pc_to_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">flags</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>			<span class="n">per_address</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">event_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">watermark_level</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">shp_addr</span><span class="p">,</span> <span class="n">per_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span>			<span class="n">chan</span><span class="p">;</span>
	<span class="n">spinlock_t</span>			<span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span>	<span class="n">desc</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_status</span>			<span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">chn_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">chn_real_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span>		<span class="n">tasklet</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define IMX_DMA_SG_LOOP		BIT(0)</span>

<span class="cp">#define MAX_DMA_CHANNELS 32</span>
<span class="cp">#define MXC_SDMA_DEFAULT_PRIORITY 1</span>
<span class="cp">#define MXC_SDMA_MIN_PRIORITY 1</span>
<span class="cp">#define MXC_SDMA_MAX_PRIORITY 7</span>

<span class="cp">#define SDMA_FIRMWARE_MAGIC 0x414d4453</span>

<span class="cm">/**</span>
<span class="cm"> * struct sdma_firmware_header - Layout of the firmware image</span>
<span class="cm"> *</span>
<span class="cm"> * @magic		&quot;SDMA&quot;</span>
<span class="cm"> * @version_major	increased whenever layout of struct sdma_script_start_addrs</span>
<span class="cm"> *			changes.</span>
<span class="cm"> * @version_minor	firmware minor version (for binary compatible changes)</span>
<span class="cm"> * @script_addrs_start	offset of struct sdma_script_start_addrs in this image</span>
<span class="cm"> * @num_script_addrs	Number of script addresses in this image</span>
<span class="cm"> * @ram_code_start	offset of SDMA ram image in this firmware image</span>
<span class="cm"> * @ram_code_size	size of SDMA ram image</span>
<span class="cm"> * @script_addrs	Stores the start address of the SDMA scripts</span>
<span class="cm"> *			(in SDMA memory space)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sdma_firmware_header</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">magic</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">version_major</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">version_minor</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">script_addrs_start</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">num_script_addrs</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">ram_code_start</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">ram_code_size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">sdma_devtype</span> <span class="p">{</span>
	<span class="n">IMX31_SDMA</span><span class="p">,</span>	<span class="cm">/* runs on i.mx31 */</span>
	<span class="n">IMX35_SDMA</span><span class="p">,</span>	<span class="cm">/* runs on i.mx35 and later */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sdma_engine</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span>			<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_dma_parameters</span>	<span class="n">dma_parms</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdma_channel</span>		<span class="n">channel</span><span class="p">[</span><span class="n">MAX_DMA_CHANNELS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sdma_channel_control</span>	<span class="o">*</span><span class="n">channel_control</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>			<span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sdma_devtype</span>		<span class="n">devtype</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">num_events</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdma_context_data</span>	<span class="o">*</span><span class="n">context</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>			<span class="n">context_phys</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_device</span>		<span class="n">dma_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>			<span class="o">*</span><span class="n">clk_ipg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>			<span class="o">*</span><span class="n">clk_ahb</span><span class="p">;</span>
	<span class="n">spinlock_t</span>			<span class="n">channel_0_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdma_script_start_addrs</span>	<span class="o">*</span><span class="n">script_addrs</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device_id</span> <span class="n">sdma_devtypes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;imx31-sdma&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">IMX31_SDMA</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;imx35-sdma&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">IMX35_SDMA</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* sentinel */</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">sdma_devtypes</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">sdma_dt_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,imx31-sdma&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdma_devtypes</span><span class="p">[</span><span class="n">IMX31_SDMA</span><span class="p">],</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,imx35-sdma&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdma_devtypes</span><span class="p">[</span><span class="n">IMX35_SDMA</span><span class="p">],</span> <span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* sentinel */</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">sdma_dt_ids</span><span class="p">);</span>

<span class="cp">#define SDMA_H_CONFIG_DSPDMA	BIT(12) </span><span class="cm">/* indicates if the DSPDMA is used */</span><span class="cp"></span>
<span class="cp">#define SDMA_H_CONFIG_RTD_PINS	BIT(11) </span><span class="cm">/* indicates if Real-Time Debug pins are enabled */</span><span class="cp"></span>
<span class="cp">#define SDMA_H_CONFIG_ACR	BIT(4)  </span><span class="cm">/* indicates if AHB freq /core freq = 2 or 1 */</span><span class="cp"></span>
<span class="cp">#define SDMA_H_CONFIG_CSM	(3)       </span><span class="cm">/* indicates which context switch mode is selected*/</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">chnenbl_ofs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">chnenbl0</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">devtype</span> <span class="o">==</span> <span class="n">IMX31_SDMA</span> <span class="o">?</span> <span class="n">SDMA_CHNENBL0_IMX31</span> <span class="o">:</span>
						      <span class="n">SDMA_CHNENBL0_IMX35</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">chnenbl0</span> <span class="o">+</span> <span class="n">event</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdma_config_ownership</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">event_override</span><span class="p">,</span> <span class="n">bool</span> <span class="n">mcu_override</span><span class="p">,</span> <span class="n">bool</span> <span class="n">dsp_override</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">sdma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">evt</span><span class="p">,</span> <span class="n">mcu</span><span class="p">,</span> <span class="n">dsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_override</span> <span class="o">&amp;&amp;</span> <span class="n">mcu_override</span> <span class="o">&amp;&amp;</span> <span class="n">dsp_override</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">evt</span> <span class="o">=</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SDMA_H_EVTOVR</span><span class="p">);</span>
	<span class="n">mcu</span> <span class="o">=</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SDMA_H_HOSTOVR</span><span class="p">);</span>
	<span class="n">dsp</span> <span class="o">=</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SDMA_H_DSPOVR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_override</span><span class="p">)</span>
		<span class="n">__clear_bit</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_override</span><span class="p">)</span>
		<span class="n">__clear_bit</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evt</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mcu_override</span><span class="p">)</span>
		<span class="n">__clear_bit</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcu</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcu</span><span class="p">);</span>

	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SDMA_H_EVTOVR</span><span class="p">);</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">mcu</span><span class="p">,</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SDMA_H_HOSTOVR</span><span class="p">);</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SDMA_H_DSPOVR</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdma_enable_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SDMA_H_START</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sdma_run_channel0 - run a channel and wait till it&#39;s done</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdma_run_channel0</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>

	<span class="n">sdma_enable_channel</span><span class="p">(</span><span class="n">sdma</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SDMA_H_INTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear the interrupt status */</span>
		<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SDMA_H_INTR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Timeout waiting for CH0 ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdma_load_script</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_buffer_descriptor</span> <span class="o">*</span><span class="n">bd0</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bd</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf_virt</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">buf_phys</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">buf_virt</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
			<span class="n">size</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">buf_phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel_0_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">bd0</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">C0_SETPM</span><span class="p">;</span>
	<span class="n">bd0</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">BD_DONE</span> <span class="o">|</span> <span class="n">BD_INTR</span> <span class="o">|</span> <span class="n">BD_WRAP</span> <span class="o">|</span> <span class="n">BD_EXTD</span><span class="p">;</span>
	<span class="n">bd0</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">bd0</span><span class="o">-&gt;</span><span class="n">buffer_addr</span> <span class="o">=</span> <span class="n">buf_phys</span><span class="p">;</span>
	<span class="n">bd0</span><span class="o">-&gt;</span><span class="n">ext_buffer_addr</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf_virt</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdma_run_channel0</span><span class="p">(</span><span class="n">sdma</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel_0_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">buf_virt</span><span class="p">,</span> <span class="n">buf_phys</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdma_event_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">sdma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chnenbl</span> <span class="o">=</span> <span class="n">chnenbl_ofs</span><span class="p">(</span><span class="n">sdma</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">chnenbl</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">chnenbl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdma_event_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">sdma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chnenbl</span> <span class="o">=</span> <span class="n">chnenbl_ofs</span><span class="p">(</span><span class="n">sdma</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">chnenbl</span><span class="p">);</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">chnenbl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdma_handle_channel_loop</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_buffer_descriptor</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * loop mode. Iterate over descriptors, re-setup them and</span>
<span class="cm">	 * call callback function.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">buf_tail</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BD_DONE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BD_RROR</span><span class="p">)</span>
			<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DMA_ERROR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DMA_IN_PROGRESS</span><span class="p">;</span>

		<span class="n">bd</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">BD_DONE</span><span class="p">;</span>
		<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">buf_tail</span><span class="o">++</span><span class="p">;</span>
		<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">buf_tail</span> <span class="o">%=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">num_bd</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">callback</span><span class="p">)</span>
			<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">callback</span><span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">callback_param</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mxc_sdma_handle_channel_normal</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_buffer_descriptor</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">chn_real_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * non loop mode. Iterate over all descriptors, collect</span>
<span class="cm">	 * errors and call callback function</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">num_bd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		 <span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BD_DONE</span> <span class="o">|</span> <span class="n">BD_RROR</span><span class="p">))</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		 <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">chn_real_count</span> <span class="o">+=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DMA_ERROR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DMA_SUCCESS</span><span class="p">;</span>

	<span class="n">dma_cookie_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">callback</span><span class="p">)</span>
		<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">callback</span><span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">callback_param</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdma_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IMX_DMA_SG_LOOP</span><span class="p">)</span>
		<span class="n">sdma_handle_channel_loop</span><span class="p">(</span><span class="n">sdmac</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mxc_sdma_handle_channel_normal</span><span class="p">(</span><span class="n">sdmac</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sdma_int_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SDMA_H_INTR</span><span class="p">);</span>
	<span class="cm">/* not interested in channel 0 interrupts */</span>
	<span class="n">stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SDMA_H_INTR</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>

		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>

		<span class="n">__clear_bit</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sets the pc of SDMA script according to the peripheral type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdma_get_pc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">sdma_peripheral_type</span> <span class="n">peripheral_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">sdma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">per_2_emi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emi_2_per</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * These are needed once we start to support transfers between</span>
<span class="cm">	 * two peripherals or memory-to-memory transfers</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">per_2_per</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">emi_2_emi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">pc_from_device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">pc_to_device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">peripheral_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IMX_DMATYPE_MEMORY</span>:
		<span class="n">emi_2_emi</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">ap_2_ap_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IMX_DMATYPE_DSP</span>:
		<span class="n">emi_2_per</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">bp_2_ap_addr</span><span class="p">;</span>
		<span class="n">per_2_emi</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">ap_2_bp_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IMX_DMATYPE_FIRI</span>:
		<span class="n">per_2_emi</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">firi_2_mcu_addr</span><span class="p">;</span>
		<span class="n">emi_2_per</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">mcu_2_firi_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IMX_DMATYPE_UART</span>:
		<span class="n">per_2_emi</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">uart_2_mcu_addr</span><span class="p">;</span>
		<span class="n">emi_2_per</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">mcu_2_app_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IMX_DMATYPE_UART_SP</span>:
		<span class="n">per_2_emi</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">uartsh_2_mcu_addr</span><span class="p">;</span>
		<span class="n">emi_2_per</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">mcu_2_shp_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IMX_DMATYPE_ATA</span>:
		<span class="n">per_2_emi</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">ata_2_mcu_addr</span><span class="p">;</span>
		<span class="n">emi_2_per</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">mcu_2_ata_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IMX_DMATYPE_CSPI</span>:
	<span class="k">case</span> <span class="n">IMX_DMATYPE_EXT</span>:
	<span class="k">case</span> <span class="n">IMX_DMATYPE_SSI</span>:
		<span class="n">per_2_emi</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">app_2_mcu_addr</span><span class="p">;</span>
		<span class="n">emi_2_per</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">mcu_2_app_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IMX_DMATYPE_SSI_SP</span>:
	<span class="k">case</span> <span class="n">IMX_DMATYPE_MMC</span>:
	<span class="k">case</span> <span class="n">IMX_DMATYPE_SDHC</span>:
	<span class="k">case</span> <span class="n">IMX_DMATYPE_CSPI_SP</span>:
	<span class="k">case</span> <span class="n">IMX_DMATYPE_ESAI</span>:
	<span class="k">case</span> <span class="n">IMX_DMATYPE_MSHC_SP</span>:
		<span class="n">per_2_emi</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">shp_2_mcu_addr</span><span class="p">;</span>
		<span class="n">emi_2_per</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">mcu_2_shp_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IMX_DMATYPE_ASRC</span>:
		<span class="n">per_2_emi</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">asrc_2_mcu_addr</span><span class="p">;</span>
		<span class="n">emi_2_per</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">asrc_2_mcu_addr</span><span class="p">;</span>
		<span class="n">per_2_per</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">per_2_per_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IMX_DMATYPE_MSHC</span>:
		<span class="n">per_2_emi</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">mshc_2_mcu_addr</span><span class="p">;</span>
		<span class="n">emi_2_per</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">mcu_2_mshc_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IMX_DMATYPE_CCM</span>:
		<span class="n">per_2_emi</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">dptc_dvfs_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IMX_DMATYPE_SPDIF</span>:
		<span class="n">per_2_emi</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">spdif_2_mcu_addr</span><span class="p">;</span>
		<span class="n">emi_2_per</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">mcu_2_spdif_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IMX_DMATYPE_IPU_MEMORY</span>:
		<span class="n">emi_2_per</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="o">-&gt;</span><span class="n">ext_mem_2_ipu_addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">pc_from_device</span> <span class="o">=</span> <span class="n">per_2_emi</span><span class="p">;</span>
	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">pc_to_device</span> <span class="o">=</span> <span class="n">emi_2_per</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdma_load_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">sdma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">load_address</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdma_context_data</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdma_buffer_descriptor</span> <span class="o">*</span><span class="n">bd0</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">load_address</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">pc_from_device</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">load_address</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">pc_to_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">load_address</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">load_address</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;load_address = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">load_address</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wml = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">watermark_level</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;shp_addr = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">shp_addr</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;per_addr = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">per_addr</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;event_mask0 = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;event_mask1 = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel_0_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">context</span><span class="p">));</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">channel_state</span><span class="p">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">load_address</span><span class="p">;</span>

	<span class="cm">/* Send by context the event mask,base address for peripheral</span>
<span class="cm">	 * and watermark level</span>
<span class="cm">	 */</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">gReg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">gReg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">gReg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">per_addr</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">gReg</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">shp_addr</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">gReg</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">watermark_level</span><span class="p">;</span>

	<span class="n">bd0</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">C0_SETDM</span><span class="p">;</span>
	<span class="n">bd0</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">BD_DONE</span> <span class="o">|</span> <span class="n">BD_INTR</span> <span class="o">|</span> <span class="n">BD_WRAP</span> <span class="o">|</span> <span class="n">BD_EXTD</span><span class="p">;</span>
	<span class="n">bd0</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">context</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">bd0</span><span class="o">-&gt;</span><span class="n">buffer_addr</span> <span class="o">=</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">context_phys</span><span class="p">;</span>
	<span class="n">bd0</span><span class="o">-&gt;</span><span class="n">ext_buffer_addr</span> <span class="o">=</span> <span class="mi">2048</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">context</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdma_run_channel0</span><span class="p">(</span><span class="n">sdma</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel_0_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdma_disable_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">sdma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SDMA_H_STATSTOP</span><span class="p">);</span>
	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DMA_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdma_config_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sdma_disable_channel</span><span class="p">(</span><span class="n">sdmac</span><span class="p">);</span>

	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">shp_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">per_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_id0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_id0</span> <span class="o">&gt;=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">num_events</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">sdma_event_enable</span><span class="p">(</span><span class="n">sdmac</span><span class="p">,</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_id0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">peripheral_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IMX_DMATYPE_DSP</span>:
		<span class="n">sdma_config_ownership</span><span class="p">(</span><span class="n">sdmac</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IMX_DMATYPE_MEMORY</span>:
		<span class="n">sdma_config_ownership</span><span class="p">(</span><span class="n">sdmac</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">sdma_config_ownership</span><span class="p">(</span><span class="n">sdmac</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdma_get_pc</span><span class="p">(</span><span class="n">sdmac</span><span class="p">,</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">peripheral_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">peripheral_type</span> <span class="o">!=</span> <span class="n">IMX_DMATYPE_MEMORY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">peripheral_type</span> <span class="o">!=</span> <span class="n">IMX_DMATYPE_DSP</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Handle multiple event channels differently */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_id1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_id1</span> <span class="o">%</span> <span class="mi">32</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_id1</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span>
				<span class="n">__set_bit</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">watermark_level</span><span class="p">);</span>
			<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_id0</span> <span class="o">%</span> <span class="mi">32</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_id0</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span>
				<span class="n">__set_bit</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">watermark_level</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_id0</span><span class="p">,</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_mask</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Watermark Level */</span>
		<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">watermark_level</span> <span class="o">|=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">watermark_level</span><span class="p">;</span>
		<span class="cm">/* Address */</span>
		<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">shp_addr</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">per_address</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">watermark_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* FIXME: M3_BASE_ADDRESS */</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdma_load_context</span><span class="p">(</span><span class="n">sdmac</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdma_set_channel_priority</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">sdma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priority</span> <span class="o">&lt;</span> <span class="n">MXC_SDMA_MIN_PRIORITY</span>
	    <span class="o">||</span> <span class="n">priority</span> <span class="o">&gt;</span> <span class="n">MXC_SDMA_MAX_PRIORITY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SDMA_CHNPRI_0</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">channel</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdma_request_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">sdma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">bd</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">bd_phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel_control</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">base_bd_ptr</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">bd_phys</span><span class="p">;</span>
	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel_control</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">current_bd_ptr</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">bd_phys</span><span class="p">;</span>

	<span class="n">sdma_set_channel_priority</span><span class="p">(</span><span class="n">sdmac</span><span class="p">,</span> <span class="n">MXC_SDMA_DEFAULT_PRIORITY</span><span class="p">);</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="nf">to_sdma_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sdma_channel</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">dma_cookie_t</span> <span class="nf">sdma_tx_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span> <span class="o">=</span> <span class="n">to_sdma_chan</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">cookie</span> <span class="o">=</span> <span class="n">dma_cookie_assign</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cookie</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdma_alloc_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span> <span class="o">=</span> <span class="n">to_sdma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">imx_dma_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prio</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMA_PRIO_HIGH</span>:
		<span class="n">prio</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_PRIO_MEDIUM</span>:
		<span class="n">prio</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_PRIO_LOW</span>:
	<span class="nl">default:</span>
		<span class="n">prio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">peripheral_type</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">peripheral_type</span><span class="p">;</span>
	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_id0</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dma_request</span><span class="p">;</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ipg</span><span class="p">);</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ahb</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdma_request_channel</span><span class="p">(</span><span class="n">sdmac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdma_set_channel_priority</span><span class="p">(</span><span class="n">sdmac</span><span class="p">,</span> <span class="n">prio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dma_async_tx_descriptor_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">tx_submit</span> <span class="o">=</span> <span class="n">sdma_tx_submit</span><span class="p">;</span>
	<span class="cm">/* txd.flags will be overwritten in prep funcs */</span>
	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DMA_CTRL_ACK</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdma_free_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span> <span class="o">=</span> <span class="n">to_sdma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">sdma</span><span class="p">;</span>

	<span class="n">sdma_disable_channel</span><span class="p">(</span><span class="n">sdmac</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_id0</span><span class="p">)</span>
		<span class="n">sdma_event_disable</span><span class="p">(</span><span class="n">sdmac</span><span class="p">,</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_id0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_id1</span><span class="p">)</span>
		<span class="n">sdma_event_disable</span><span class="p">(</span><span class="n">sdmac</span><span class="p">,</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_id1</span><span class="p">);</span>

	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_id0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">event_id1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sdma_set_channel_priority</span><span class="p">(</span><span class="n">sdmac</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">,</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">bd_phys</span><span class="p">);</span>

	<span class="n">clk_disable</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ipg</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ahb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">sdma_prep_slave_sg</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sgl</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">direction</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span> <span class="o">=</span> <span class="n">to_sdma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">sdma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">DMA_IN_PROGRESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DMA_IN_PROGRESS</span><span class="p">;</span>

	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">buf_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setting up %d entries for channel %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sg_len</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdma_load_context</span><span class="p">(</span><span class="n">sdmac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sg_len</span> <span class="o">&gt;</span> <span class="n">NUM_BD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SDMA channel %d: maximum number of sg exceeded: %d &gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">channel</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">NUM_BD</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">chn_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sdma_buffer_descriptor</span> <span class="o">*</span><span class="n">bd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">param</span><span class="p">;</span>

		<span class="n">bd</span><span class="o">-&gt;</span><span class="n">buffer_addr</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">dma_address</span><span class="p">;</span>

		<span class="n">count</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SDMA channel %d: maximum bytes for sg entry exceeded: %d &gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">channel</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bd</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">chn_count</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">word_size</span> <span class="o">&gt;</span> <span class="n">DMA_SLAVE_BUSWIDTH_4_BYTES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span>  <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">word_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DMA_SLAVE_BUSWIDTH_4_BYTES</span>:
			<span class="n">bd</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">dma_address</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMA_SLAVE_BUSWIDTH_2_BYTES</span>:
			<span class="n">bd</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">dma_address</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMA_SLAVE_BUSWIDTH_1_BYTE</span>:
			<span class="n">bd</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">param</span> <span class="o">=</span> <span class="n">BD_DONE</span> <span class="o">|</span> <span class="n">BD_EXTD</span> <span class="o">|</span> <span class="n">BD_CONT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">sg_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">param</span> <span class="o">|=</span> <span class="n">BD_INTR</span><span class="p">;</span>
			<span class="n">param</span> <span class="o">|=</span> <span class="n">BD_LAST</span><span class="p">;</span>
			<span class="n">param</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BD_CONT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;entry %d: count: %d dma: 0x%08x %s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">dma_address</span><span class="p">,</span>
				<span class="n">param</span> <span class="o">&amp;</span> <span class="n">BD_WRAP</span> <span class="o">?</span> <span class="s">&quot;wrap&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">param</span> <span class="o">&amp;</span> <span class="n">BD_INTR</span> <span class="o">?</span> <span class="s">&quot; intr&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

		<span class="n">bd</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">num_bd</span> <span class="o">=</span> <span class="n">sg_len</span><span class="p">;</span>
	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel_control</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">current_bd_ptr</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">bd_phys</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
<span class="nl">err_out:</span>
	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DMA_ERROR</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">sdma_prep_dma_cyclic</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buf_len</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">period_len</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">direction</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span> <span class="o">=</span> <span class="n">to_sdma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">sdma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_periods</span> <span class="o">=</span> <span class="n">buf_len</span> <span class="o">/</span> <span class="n">period_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s channel: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">DMA_IN_PROGRESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DMA_IN_PROGRESS</span><span class="p">;</span>

	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">buf_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IMX_DMA_SG_LOOP</span><span class="p">;</span>
	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdma_load_context</span><span class="p">(</span><span class="n">sdmac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_periods</span> <span class="o">&gt;</span> <span class="n">NUM_BD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SDMA channel %d: maximum number of sg exceeded: %d &gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">channel</span><span class="p">,</span> <span class="n">num_periods</span><span class="p">,</span> <span class="n">NUM_BD</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">period_len</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SDMA channel %d: maximum period size exceeded: %d &gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">channel</span><span class="p">,</span> <span class="n">period_len</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&lt;</span> <span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sdma_buffer_descriptor</span> <span class="o">*</span><span class="n">bd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">param</span><span class="p">;</span>

		<span class="n">bd</span><span class="o">-&gt;</span><span class="n">buffer_addr</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>

		<span class="n">bd</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">period_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">word_size</span> <span class="o">&gt;</span> <span class="n">DMA_SLAVE_BUSWIDTH_4_BYTES</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">word_size</span> <span class="o">==</span> <span class="n">DMA_SLAVE_BUSWIDTH_4_BYTES</span><span class="p">)</span>
			<span class="n">bd</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bd</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">word_size</span><span class="p">;</span>

		<span class="n">param</span> <span class="o">=</span> <span class="n">BD_DONE</span> <span class="o">|</span> <span class="n">BD_EXTD</span> <span class="o">|</span> <span class="n">BD_CONT</span> <span class="o">|</span> <span class="n">BD_INTR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">num_periods</span><span class="p">)</span>
			<span class="n">param</span> <span class="o">|=</span> <span class="n">BD_WRAP</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;entry %d: count: %d dma: 0x%08x %s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="n">period_len</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span>
				<span class="n">param</span> <span class="o">&amp;</span> <span class="n">BD_WRAP</span> <span class="o">?</span> <span class="s">&quot;wrap&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">param</span> <span class="o">&amp;</span> <span class="n">BD_INTR</span> <span class="o">?</span> <span class="s">&quot; intr&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

		<span class="n">bd</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>

		<span class="n">dma_addr</span> <span class="o">+=</span> <span class="n">period_len</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">period_len</span><span class="p">;</span>

		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">num_bd</span> <span class="o">=</span> <span class="n">num_periods</span><span class="p">;</span>
	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel_control</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">current_bd_ptr</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">bd_phys</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
<span class="nl">err_out:</span>
	<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DMA_ERROR</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdma_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_ctrl_cmd</span> <span class="n">cmd</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span> <span class="o">=</span> <span class="n">to_sdma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dma_slave_config</span> <span class="o">*</span><span class="n">dmaengine_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMA_TERMINATE_ALL</span>:
		<span class="n">sdma_disable_channel</span><span class="p">(</span><span class="n">sdmac</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_SLAVE_CONFIG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dmaengine_cfg</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">per_address</span> <span class="o">=</span> <span class="n">dmaengine_cfg</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">;</span>
			<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">watermark_level</span> <span class="o">=</span> <span class="n">dmaengine_cfg</span><span class="o">-&gt;</span><span class="n">src_maxburst</span> <span class="o">*</span>
						<span class="n">dmaengine_cfg</span><span class="o">-&gt;</span><span class="n">src_addr_width</span><span class="p">;</span>
			<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">word_size</span> <span class="o">=</span> <span class="n">dmaengine_cfg</span><span class="o">-&gt;</span><span class="n">src_addr_width</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">per_address</span> <span class="o">=</span> <span class="n">dmaengine_cfg</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">;</span>
			<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">watermark_level</span> <span class="o">=</span> <span class="n">dmaengine_cfg</span><span class="o">-&gt;</span><span class="n">dst_maxburst</span> <span class="o">*</span>
						<span class="n">dmaengine_cfg</span><span class="o">-&gt;</span><span class="n">dst_addr_width</span><span class="p">;</span>
			<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">word_size</span> <span class="o">=</span> <span class="n">dmaengine_cfg</span><span class="o">-&gt;</span><span class="n">dst_addr_width</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="n">dmaengine_cfg</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">sdma_config_channel</span><span class="p">(</span><span class="n">sdmac</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">dma_status</span> <span class="nf">sdma_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
					    <span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">dma_tx_state</span> <span class="o">*</span><span class="n">txstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span> <span class="o">=</span> <span class="n">to_sdma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">dma_cookie_t</span> <span class="n">last_used</span><span class="p">;</span>

	<span class="n">last_used</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">;</span>

	<span class="n">dma_set_tx_state</span><span class="p">(</span><span class="n">txstate</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">completed_cookie</span><span class="p">,</span> <span class="n">last_used</span><span class="p">,</span>
			<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">chn_count</span> <span class="o">-</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">chn_real_count</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdma_issue_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span> <span class="o">=</span> <span class="n">to_sdma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span> <span class="o">=</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">sdma</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">DMA_IN_PROGRESS</span><span class="p">)</span>
		<span class="n">sdma_enable_channel</span><span class="p">(</span><span class="n">sdma</span><span class="p">,</span> <span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SDMA_SCRIPT_ADDRS_ARRAY_SIZE_V1	34</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdma_add_scripts</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">sdma_script_start_addrs</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="o">*</span><span class="n">addr_arr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">s32</span> <span class="o">*</span><span class="n">saddr_arr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SDMA_SCRIPT_ADDRS_ARRAY_SIZE_V1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">saddr_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr_arr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdma_load_firmware</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sdma_firmware_header</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sdma_script_start_addrs</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">ram_code</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;firmware not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">header</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_firmware</span><span class="p">;</span>

	<span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sdma_firmware_header</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">SDMA_FIRMWARE_MAGIC</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_firmware</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">ram_code_start</span> <span class="o">+</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">ram_code_size</span> <span class="o">&gt;</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_firmware</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span> <span class="o">+</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">script_addrs_start</span><span class="p">;</span>
	<span class="n">ram_code</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span> <span class="o">+</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">ram_code_start</span><span class="p">;</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ipg</span><span class="p">);</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ahb</span><span class="p">);</span>
	<span class="cm">/* download the RAM image for SDMA */</span>
	<span class="n">sdma_load_script</span><span class="p">(</span><span class="n">sdma</span><span class="p">,</span> <span class="n">ram_code</span><span class="p">,</span>
			<span class="n">header</span><span class="o">-&gt;</span><span class="n">ram_code_size</span><span class="p">,</span>
			<span class="n">addr</span><span class="o">-&gt;</span><span class="n">ram_code_start_addr</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ipg</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ahb</span><span class="p">);</span>

	<span class="n">sdma_add_scripts</span><span class="p">(</span><span class="n">sdma</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;loaded firmware %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">header</span><span class="o">-&gt;</span><span class="n">version_major</span><span class="p">,</span>
			<span class="n">header</span><span class="o">-&gt;</span><span class="n">version_minor</span><span class="p">);</span>

<span class="nl">err_firmware:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sdma_get_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware_nowait</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span>
			<span class="n">FW_ACTION_HOTPLUG</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">sdma</span><span class="p">,</span> <span class="n">sdma_load_firmware</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sdma_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">ccb_phys</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">devtype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IMX31_SDMA</span>:
		<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">num_events</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IMX35_SDMA</span>:
		<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">num_events</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown sdma type %d. aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">devtype</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ipg</span><span class="p">);</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ahb</span><span class="p">);</span>

	<span class="cm">/* Be sure SDMA has not started yet */</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SDMA_H_C0PTR</span><span class="p">);</span>

	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel_control</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
			<span class="n">MAX_DMA_CHANNELS</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sdma_channel_control</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdma_context_data</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">ccb_phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel_control</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_dma_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel_control</span> <span class="o">+</span>
		<span class="n">MAX_DMA_CHANNELS</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sdma_channel_control</span><span class="p">);</span>
	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">context_phys</span> <span class="o">=</span> <span class="n">ccb_phys</span> <span class="o">+</span>
		<span class="n">MAX_DMA_CHANNELS</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sdma_channel_control</span><span class="p">);</span>

	<span class="cm">/* Zero-out the CCB structures array just allocated */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel_control</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">MAX_DMA_CHANNELS</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sdma_channel_control</span><span class="p">));</span>

	<span class="cm">/* disable all channels */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">num_events</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writel_relaxed</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">chnenbl_ofs</span><span class="p">(</span><span class="n">sdma</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>

	<span class="cm">/* All channels have priority 0 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_DMA_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writel_relaxed</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SDMA_CHNPRI_0</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdma_request_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_dma_alloc</span><span class="p">;</span>

	<span class="n">sdma_config_ownership</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* Set Command Channel (Channel Zero) */</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="mh">0x4050</span><span class="p">,</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SDMA_CHN0ADDR</span><span class="p">);</span>

	<span class="cm">/* Set bits of CONFIG register but with static context switching */</span>
	<span class="cm">/* FIXME: Check whether to set ACR bit depending on clock ratios */</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SDMA_H_CONFIG</span><span class="p">);</span>

	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">ccb_phys</span><span class="p">,</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SDMA_H_C0PTR</span><span class="p">);</span>

	<span class="cm">/* Set bits of CONFIG register with given context switching mode */</span>
	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">SDMA_H_CONFIG_CSM</span><span class="p">,</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SDMA_H_CONFIG</span><span class="p">);</span>

	<span class="cm">/* Initializes channel&#39;s priorities */</span>
	<span class="n">sdma_set_channel_priority</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">7</span><span class="p">);</span>

	<span class="n">clk_disable</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ipg</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ahb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_dma_alloc:</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ipg</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ahb</span><span class="p">);</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;initialisation failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sdma_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="o">*</span><span class="n">of_id</span> <span class="o">=</span>
			<span class="n">of_match_device</span><span class="p">(</span><span class="n">sdma_dt_ids</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">iores</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdma_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdma_engine</span> <span class="o">*</span><span class="n">sdma</span><span class="p">;</span>
	<span class="n">s32</span> <span class="o">*</span><span class="n">saddr_arr</span><span class="p">;</span>

	<span class="n">sdma</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sdma</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdma</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel_0_lock</span><span class="p">);</span>

	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">iores</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iores</span> <span class="o">||</span> <span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">iores</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">iores</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_request_region</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ipg</span> <span class="o">=</span> <span class="n">devm_clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ipg&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ipg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ipg</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_clk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ahb</span> <span class="o">=</span> <span class="n">devm_clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ahb&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ahb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ahb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_clk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clk_prepare</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ipg</span><span class="p">);</span>
	<span class="n">clk_prepare</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">clk_ahb</span><span class="p">);</span>

	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">iores</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">iores</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_ioremap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">sdma_int_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;sdma&quot;</span><span class="p">,</span> <span class="n">sdma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_request_irq</span><span class="p">;</span>

	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initially no scripts available */</span>
	<span class="n">saddr_arr</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span> <span class="o">*</span><span class="p">)</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SDMA_SCRIPT_ADDRS_ARRAY_SIZE_V1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">saddr_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">of_id</span><span class="p">)</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id_entry</span> <span class="o">=</span> <span class="n">of_id</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">devtype</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id_entry</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_CYCLIC</span><span class="p">,</span> <span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">channels</span><span class="p">);</span>
	<span class="cm">/* Initialize channel parameters */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_DMA_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sdma_channel</span> <span class="o">*</span><span class="n">sdmac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">sdma</span> <span class="o">=</span> <span class="n">sdma</span><span class="p">;</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">;</span>
		<span class="n">dma_cookie_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">,</span> <span class="n">sdma_tasklet</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sdmac</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Add the channel to the DMAC list. Do not add channel 0 though</span>
<span class="cm">		 * because we need it internally in the SDMA driver. This also means</span>
<span class="cm">		 * that channel 0 in dmaengine counting matches sdma channel 1.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdmac</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device_node</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">channels</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdma_init</span><span class="p">(</span><span class="n">sdma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_init</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="p">)</span>
		<span class="n">sdma_add_scripts</span><span class="p">(</span><span class="n">sdma</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sdma_get_firmware</span><span class="p">(</span><span class="n">sdma</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">fw_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get firmware from platform data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Because that device tree does not encode ROM script address,</span>
<span class="cm">		 * the RAM script in firmware is mandatory for device tree</span>
<span class="cm">		 * probe, otherwise it fails.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">of_property_read_string</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;fsl,sdma-ram-script-name&quot;</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">fw_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get firmware name</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sdma_get_firmware</span><span class="p">(</span><span class="n">sdma</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get firmware from device tree</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">device_alloc_chan_resources</span> <span class="o">=</span> <span class="n">sdma_alloc_chan_resources</span><span class="p">;</span>
	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">device_free_chan_resources</span> <span class="o">=</span> <span class="n">sdma_free_chan_resources</span><span class="p">;</span>
	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">device_tx_status</span> <span class="o">=</span> <span class="n">sdma_tx_status</span><span class="p">;</span>
	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">device_prep_slave_sg</span> <span class="o">=</span> <span class="n">sdma_prep_slave_sg</span><span class="p">;</span>
	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">device_prep_dma_cyclic</span> <span class="o">=</span> <span class="n">sdma_prep_dma_cyclic</span><span class="p">;</span>
	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">device_control</span> <span class="o">=</span> <span class="n">sdma_control</span><span class="p">;</span>
	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">device_issue_pending</span> <span class="o">=</span> <span class="n">sdma_issue_pending</span><span class="p">;</span>
	<span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_parms</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dma_parms</span><span class="p">;</span>
	<span class="n">dma_set_max_seg_size</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="mi">65535</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_async_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_init</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_init:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">script_addrs</span><span class="p">);</span>
<span class="nl">err_alloc:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">sdma</span><span class="p">);</span>
<span class="nl">err_request_irq:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
<span class="nl">err_ioremap:</span>
<span class="nl">err_clk:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">iores</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">iores</span><span class="p">));</span>
<span class="nl">err_request_region:</span>
<span class="nl">err_irq:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sdma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">sdma_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">sdma_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;imx-sdma&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">sdma_dt_ids</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">sdma_devtypes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">sdma_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sdma_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdma_driver</span><span class="p">,</span> <span class="n">sdma_probe</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">sdma_module_init</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Sascha Hauer, Pengutronix &lt;s.hauer@pengutronix.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;i.MX SDMA driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
