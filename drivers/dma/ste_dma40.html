<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › dma › ste_dma40.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ste_dma40.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) Ericsson AB 2007-2008</span>
<span class="cm"> * Copyright (C) ST-Ericsson SA 2008-2010</span>
<span class="cm"> * Author: Per Forlin &lt;per.forlin@stericsson.com&gt; for ST-Ericsson</span>
<span class="cm"> * Author: Jonas Aaberg &lt;jonas.aberg@stericsson.com&gt; for ST-Ericsson</span>
<span class="cm"> * License terms: GNU General Public License (GPL) version 2</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/amba/bus.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>

<span class="cp">#include &lt;plat/ste_dma40.h&gt;</span>

<span class="cp">#include &quot;dmaengine.h&quot;</span>
<span class="cp">#include &quot;ste_dma40_ll.h&quot;</span>

<span class="cp">#define D40_NAME &quot;dma40&quot;</span>

<span class="cp">#define D40_PHY_CHAN -1</span>

<span class="cm">/* For masking out/in 2 bit channel positions */</span>
<span class="cp">#define D40_CHAN_POS(chan)  (2 * (chan / 2))</span>
<span class="cp">#define D40_CHAN_POS_MASK(chan) (0x3 &lt;&lt; D40_CHAN_POS(chan))</span>

<span class="cm">/* Maximum iterations taken before giving up suspending a channel */</span>
<span class="cp">#define D40_SUSPEND_MAX_IT 500</span>

<span class="cm">/* Milliseconds */</span>
<span class="cp">#define DMA40_AUTOSUSPEND_DELAY	100</span>

<span class="cm">/* Hardware requirement on LCLA alignment */</span>
<span class="cp">#define LCLA_ALIGNMENT 0x40000</span>

<span class="cm">/* Max number of links per event group */</span>
<span class="cp">#define D40_LCLA_LINK_PER_EVENT_GRP 128</span>
<span class="cp">#define D40_LCLA_END D40_LCLA_LINK_PER_EVENT_GRP</span>

<span class="cm">/* Attempts before giving up to trying to get pages that are aligned */</span>
<span class="cp">#define MAX_LCLA_ALLOC_ATTEMPTS 256</span>

<span class="cm">/* Bit markings for allocation map */</span>
<span class="cp">#define D40_ALLOC_FREE		(1 &lt;&lt; 31)</span>
<span class="cp">#define D40_ALLOC_PHY		(1 &lt;&lt; 30)</span>
<span class="cp">#define D40_ALLOC_LOG_FREE	0</span>

<span class="cm">/**</span>
<span class="cm"> * enum 40_command - The different commands and/or statuses.</span>
<span class="cm"> *</span>
<span class="cm"> * @D40_DMA_STOP: DMA channel command STOP or status STOPPED,</span>
<span class="cm"> * @D40_DMA_RUN: The DMA channel is RUNNING of the command RUN.</span>
<span class="cm"> * @D40_DMA_SUSPEND_REQ: Request the DMA to SUSPEND as soon as possible.</span>
<span class="cm"> * @D40_DMA_SUSPENDED: The DMA channel is SUSPENDED.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">d40_command</span> <span class="p">{</span>
	<span class="n">D40_DMA_STOP</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">D40_DMA_RUN</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">D40_DMA_SUSPEND_REQ</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">D40_DMA_SUSPENDED</span>	<span class="o">=</span> <span class="mi">3</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * enum d40_events - The different Event Enables for the event lines.</span>
<span class="cm"> *</span>
<span class="cm"> * @D40_DEACTIVATE_EVENTLINE: De-activate Event line, stopping the logical chan.</span>
<span class="cm"> * @D40_ACTIVATE_EVENTLINE: Activate the Event line, to start a logical chan.</span>
<span class="cm"> * @D40_SUSPEND_REQ_EVENTLINE: Requesting for suspending a event line.</span>
<span class="cm"> * @D40_ROUND_EVENTLINE: Status check for event line.</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="n">d40_events</span> <span class="p">{</span>
	<span class="n">D40_DEACTIVATE_EVENTLINE</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">D40_ACTIVATE_EVENTLINE</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">D40_SUSPEND_REQ_EVENTLINE</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">D40_ROUND_EVENTLINE</span>		<span class="o">=</span> <span class="mi">3</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * These are the registers that has to be saved and later restored</span>
<span class="cm"> * when the DMA hw is powered off.</span>
<span class="cm"> * TODO: Add save/restore of D40_DREG_GCC on dma40 v3 or later, if that works.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">d40_backup_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">D40_DREG_LCPA</span><span class="p">,</span>
	<span class="n">D40_DREG_LCLA</span><span class="p">,</span>
	<span class="n">D40_DREG_PRMSE</span><span class="p">,</span>
	<span class="n">D40_DREG_PRMSO</span><span class="p">,</span>
	<span class="n">D40_DREG_PRMOE</span><span class="p">,</span>
	<span class="n">D40_DREG_PRMOO</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define BACKUP_REGS_SZ ARRAY_SIZE(d40_backup_regs)</span>

<span class="cm">/* TODO: Check if all these registers have to be saved/restored on dma40 v3 */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">d40_backup_regs_v3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">D40_DREG_PSEG1</span><span class="p">,</span>
	<span class="n">D40_DREG_PSEG2</span><span class="p">,</span>
	<span class="n">D40_DREG_PSEG3</span><span class="p">,</span>
	<span class="n">D40_DREG_PSEG4</span><span class="p">,</span>
	<span class="n">D40_DREG_PCEG1</span><span class="p">,</span>
	<span class="n">D40_DREG_PCEG2</span><span class="p">,</span>
	<span class="n">D40_DREG_PCEG3</span><span class="p">,</span>
	<span class="n">D40_DREG_PCEG4</span><span class="p">,</span>
	<span class="n">D40_DREG_RSEG1</span><span class="p">,</span>
	<span class="n">D40_DREG_RSEG2</span><span class="p">,</span>
	<span class="n">D40_DREG_RSEG3</span><span class="p">,</span>
	<span class="n">D40_DREG_RSEG4</span><span class="p">,</span>
	<span class="n">D40_DREG_RCEG1</span><span class="p">,</span>
	<span class="n">D40_DREG_RCEG2</span><span class="p">,</span>
	<span class="n">D40_DREG_RCEG3</span><span class="p">,</span>
	<span class="n">D40_DREG_RCEG4</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define BACKUP_REGS_SZ_V3 ARRAY_SIZE(d40_backup_regs_v3)</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">d40_backup_regs_chan</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">D40_CHAN_REG_SSCFG</span><span class="p">,</span>
	<span class="n">D40_CHAN_REG_SSELT</span><span class="p">,</span>
	<span class="n">D40_CHAN_REG_SSPTR</span><span class="p">,</span>
	<span class="n">D40_CHAN_REG_SSLNK</span><span class="p">,</span>
	<span class="n">D40_CHAN_REG_SDCFG</span><span class="p">,</span>
	<span class="n">D40_CHAN_REG_SDELT</span><span class="p">,</span>
	<span class="n">D40_CHAN_REG_SDPTR</span><span class="p">,</span>
	<span class="n">D40_CHAN_REG_SDLNK</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct d40_lli_pool - Structure for keeping LLIs in memory</span>
<span class="cm"> *</span>
<span class="cm"> * @base: Pointer to memory area when the pre_alloc_lli&#39;s are not large</span>
<span class="cm"> * enough, IE bigger than the most common case, 1 dst and 1 src. NULL if</span>
<span class="cm"> * pre_alloc_lli is used.</span>
<span class="cm"> * @dma_addr: DMA address, if mapped</span>
<span class="cm"> * @size: The size in bytes of the memory at base or the size of pre_alloc_lli.</span>
<span class="cm"> * @pre_alloc_lli: Pre allocated area for the most common case of transfers,</span>
<span class="cm"> * one buffer to one buffer.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">d40_lli_pool</span> <span class="p">{</span>
	<span class="kt">void</span>	<span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">size</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">dma_addr</span><span class="p">;</span>
	<span class="cm">/* Space for dst and src, plus an extra for padding */</span>
	<span class="n">u8</span>	 <span class="n">pre_alloc_lli</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_phy_lli</span><span class="p">)];</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct d40_desc - A descriptor is one DMA job.</span>
<span class="cm"> *</span>
<span class="cm"> * @lli_phy: LLI settings for physical channel. Both src and dst=</span>
<span class="cm"> * points into the lli_pool, to base if lli_len &gt; 1 or to pre_alloc_lli if</span>
<span class="cm"> * lli_len equals one.</span>
<span class="cm"> * @lli_log: Same as above but for logical channels.</span>
<span class="cm"> * @lli_pool: The pool with two entries pre-allocated.</span>
<span class="cm"> * @lli_len: Number of llis of current descriptor.</span>
<span class="cm"> * @lli_current: Number of transferred llis.</span>
<span class="cm"> * @lcla_alloc: Number of LCLA entries allocated.</span>
<span class="cm"> * @txd: DMA engine struct. Used for among other things for communication</span>
<span class="cm"> * during a transfer.</span>
<span class="cm"> * @node: List entry.</span>
<span class="cm"> * @is_in_client_list: true if the client owns this descriptor.</span>
<span class="cm"> * @cyclic: true if this is a cyclic job</span>
<span class="cm"> *</span>
<span class="cm"> * This descriptor is used for both logical and physical transfers.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">d40_desc</span> <span class="p">{</span>
	<span class="cm">/* LLI physical */</span>
	<span class="k">struct</span> <span class="n">d40_phy_lli_bidir</span>	 <span class="n">lli_phy</span><span class="p">;</span>
	<span class="cm">/* LLI logical */</span>
	<span class="k">struct</span> <span class="n">d40_log_lli_bidir</span>	 <span class="n">lli_log</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">d40_lli_pool</span>		 <span class="n">lli_pool</span><span class="p">;</span>
	<span class="kt">int</span>				 <span class="n">lli_len</span><span class="p">;</span>
	<span class="kt">int</span>				 <span class="n">lli_current</span><span class="p">;</span>
	<span class="kt">int</span>				 <span class="n">lcla_alloc</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span>	 <span class="n">txd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		 <span class="n">node</span><span class="p">;</span>

	<span class="n">bool</span>				 <span class="n">is_in_client_list</span><span class="p">;</span>
	<span class="n">bool</span>				 <span class="n">cyclic</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct d40_lcla_pool - LCLA pool settings and data.</span>
<span class="cm"> *</span>
<span class="cm"> * @base: The virtual address of LCLA. 18 bit aligned.</span>
<span class="cm"> * @base_unaligned: The orignal kmalloc pointer, if kmalloc is used.</span>
<span class="cm"> * This pointer is only there for clean-up on error.</span>
<span class="cm"> * @pages: The number of pages needed for all physical channels.</span>
<span class="cm"> * Only used later for clean-up on error</span>
<span class="cm"> * @lock: Lock to protect the content in this struct.</span>
<span class="cm"> * @alloc_map: big map over which LCLA entry is own by which job.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">d40_lcla_pool</span> <span class="p">{</span>
	<span class="kt">void</span>		<span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">dma_addr</span><span class="p">;</span>
	<span class="kt">void</span>		<span class="o">*</span><span class="n">base_unaligned</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">pages</span><span class="p">;</span>
	<span class="n">spinlock_t</span>	 <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_desc</span>	<span class="o">**</span><span class="n">alloc_map</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct d40_phy_res - struct for handling eventlines mapped to physical</span>
<span class="cm"> * channels.</span>
<span class="cm"> *</span>
<span class="cm"> * @lock: A lock protection this entity.</span>
<span class="cm"> * @reserved: True if used by secure world or otherwise.</span>
<span class="cm"> * @num: The physical channel number of this entity.</span>
<span class="cm"> * @allocated_src: Bit mapped to show which src event line&#39;s are mapped to</span>
<span class="cm"> * this physical channel. Can also be free or physically allocated.</span>
<span class="cm"> * @allocated_dst: Same as for src but is dst.</span>
<span class="cm"> * allocated_dst and allocated_src uses the D40_ALLOC* defines as well as</span>
<span class="cm"> * event line number.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">d40_phy_res</span> <span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="n">bool</span>	   <span class="n">reserved</span><span class="p">;</span>
	<span class="kt">int</span>	   <span class="n">num</span><span class="p">;</span>
	<span class="n">u32</span>	   <span class="n">allocated_src</span><span class="p">;</span>
	<span class="n">u32</span>	   <span class="n">allocated_dst</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">d40_base</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * struct d40_chan - Struct that describes a channel.</span>
<span class="cm"> *</span>
<span class="cm"> * @lock: A spinlock to protect this struct.</span>
<span class="cm"> * @log_num: The logical number, if any of this channel.</span>
<span class="cm"> * @pending_tx: The number of pending transfers. Used between interrupt handler</span>
<span class="cm"> * and tasklet.</span>
<span class="cm"> * @busy: Set to true when transfer is ongoing on this channel.</span>
<span class="cm"> * @phy_chan: Pointer to physical channel which this instance runs on. If this</span>
<span class="cm"> * point is NULL, then the channel is not allocated.</span>
<span class="cm"> * @chan: DMA engine handle.</span>
<span class="cm"> * @tasklet: Tasklet that gets scheduled from interrupt context to complete a</span>
<span class="cm"> * transfer and call client callback.</span>
<span class="cm"> * @client: Cliented owned descriptor list.</span>
<span class="cm"> * @pending_queue: Submitted jobs, to be issued by issue_pending()</span>
<span class="cm"> * @active: Active descriptor.</span>
<span class="cm"> * @queue: Queued jobs.</span>
<span class="cm"> * @prepare_queue: Prepared jobs.</span>
<span class="cm"> * @dma_cfg: The client configuration of this dma channel.</span>
<span class="cm"> * @configured: whether the dma_cfg configuration is valid</span>
<span class="cm"> * @base: Pointer to the device instance struct.</span>
<span class="cm"> * @src_def_cfg: Default cfg register setting for src.</span>
<span class="cm"> * @dst_def_cfg: Default cfg register setting for dst.</span>
<span class="cm"> * @log_def: Default logical channel settings.</span>
<span class="cm"> * @lcpa: Pointer to dst and src lcpa settings.</span>
<span class="cm"> * @runtime_addr: runtime configured address.</span>
<span class="cm"> * @runtime_direction: runtime configured direction.</span>
<span class="cm"> *</span>
<span class="cm"> * This struct can either &quot;be&quot; a logical or a physical channel.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">d40_chan</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>			 <span class="n">lock</span><span class="p">;</span>
	<span class="kt">int</span>				 <span class="n">log_num</span><span class="p">;</span>
	<span class="kt">int</span>				 <span class="n">pending_tx</span><span class="p">;</span>
	<span class="n">bool</span>				 <span class="n">busy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_phy_res</span>		<span class="o">*</span><span class="n">phy_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span>			 <span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span>		 <span class="n">tasklet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		 <span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		 <span class="n">pending_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		 <span class="n">active</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		 <span class="n">queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		 <span class="n">prepare_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stedma40_chan_cfg</span>	 <span class="n">dma_cfg</span><span class="p">;</span>
	<span class="n">bool</span>				 <span class="n">configured</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_base</span>			<span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="cm">/* Default register configurations */</span>
	<span class="n">u32</span>				 <span class="n">src_def_cfg</span><span class="p">;</span>
	<span class="n">u32</span>				 <span class="n">dst_def_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_def_lcsp</span>		 <span class="n">log_def</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_log_lli_full</span>		<span class="o">*</span><span class="n">lcpa</span><span class="p">;</span>
	<span class="cm">/* Runtime reconfiguration */</span>
	<span class="n">dma_addr_t</span>			<span class="n">runtime_addr</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_transfer_direction</span>	<span class="n">runtime_direction</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct d40_base - The big global struct, one for each probe&#39;d instance.</span>
<span class="cm"> *</span>
<span class="cm"> * @interrupt_lock: Lock used to make sure one interrupt is handle a time.</span>
<span class="cm"> * @execmd_lock: Lock for execute command usage since several channels share</span>
<span class="cm"> * the same physical register.</span>
<span class="cm"> * @dev: The device structure.</span>
<span class="cm"> * @virtbase: The virtual base address of the DMA&#39;s register.</span>
<span class="cm"> * @rev: silicon revision detected.</span>
<span class="cm"> * @clk: Pointer to the DMA clock structure.</span>
<span class="cm"> * @phy_start: Physical memory start of the DMA registers.</span>
<span class="cm"> * @phy_size: Size of the DMA register map.</span>
<span class="cm"> * @irq: The IRQ number.</span>
<span class="cm"> * @num_phy_chans: The number of physical channels. Read from HW. This</span>
<span class="cm"> * is the number of available channels for this driver, not counting &quot;Secure</span>
<span class="cm"> * mode&quot; allocated physical channels.</span>
<span class="cm"> * @num_log_chans: The number of logical channels. Calculated from</span>
<span class="cm"> * num_phy_chans.</span>
<span class="cm"> * @dma_both: dma_device channels that can do both memcpy and slave transfers.</span>
<span class="cm"> * @dma_slave: dma_device channels that can do only do slave transfers.</span>
<span class="cm"> * @dma_memcpy: dma_device channels that can do only do memcpy transfers.</span>
<span class="cm"> * @phy_chans: Room for all possible physical channels in system.</span>
<span class="cm"> * @log_chans: Room for all possible logical channels in system.</span>
<span class="cm"> * @lookup_log_chans: Used to map interrupt number to logical channel. Points</span>
<span class="cm"> * to log_chans entries.</span>
<span class="cm"> * @lookup_phy_chans: Used to map interrupt number to physical channel. Points</span>
<span class="cm"> * to phy_chans entries.</span>
<span class="cm"> * @plat_data: Pointer to provided platform_data which is the driver</span>
<span class="cm"> * configuration.</span>
<span class="cm"> * @lcpa_regulator: Pointer to hold the regulator for the esram bank for lcla.</span>
<span class="cm"> * @phy_res: Vector containing all physical channels.</span>
<span class="cm"> * @lcla_pool: lcla pool settings and data.</span>
<span class="cm"> * @lcpa_base: The virtual mapped address of LCPA.</span>
<span class="cm"> * @phy_lcpa: The physical address of the LCPA.</span>
<span class="cm"> * @lcpa_size: The size of the LCPA area.</span>
<span class="cm"> * @desc_slab: cache for descriptors.</span>
<span class="cm"> * @reg_val_backup: Here the values of some hardware registers are stored</span>
<span class="cm"> * before the DMA is powered off. They are restored when the power is back on.</span>
<span class="cm"> * @reg_val_backup_v3: Backup of registers that only exits on dma40 v3 and</span>
<span class="cm"> * later.</span>
<span class="cm"> * @reg_val_backup_chan: Backup data for standard channel parameter registers.</span>
<span class="cm"> * @gcc_pwr_off_mask: Mask to maintain the channels that can be turned off.</span>
<span class="cm"> * @initialized: true if the dma has been initialized</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">d40_base</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>			 <span class="n">interrupt_lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span>			 <span class="n">execmd_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span>			 <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>			 <span class="o">*</span><span class="n">virtbase</span><span class="p">;</span>
	<span class="n">u8</span>				  <span class="n">rev</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>			 <span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="n">phys_addr_t</span>			  <span class="n">phy_start</span><span class="p">;</span>
	<span class="n">resource_size_t</span>			  <span class="n">phy_size</span><span class="p">;</span>
	<span class="kt">int</span>				  <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span>				  <span class="n">num_phy_chans</span><span class="p">;</span>
	<span class="kt">int</span>				  <span class="n">num_log_chans</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_device</span>		  <span class="n">dma_both</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_device</span>		  <span class="n">dma_slave</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_device</span>		  <span class="n">dma_memcpy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_chan</span>			 <span class="o">*</span><span class="n">phy_chans</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_chan</span>			 <span class="o">*</span><span class="n">log_chans</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_chan</span>			<span class="o">**</span><span class="n">lookup_log_chans</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_chan</span>			<span class="o">**</span><span class="n">lookup_phy_chans</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stedma40_platform_data</span>	 <span class="o">*</span><span class="n">plat_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator</span>		 <span class="o">*</span><span class="n">lcpa_regulator</span><span class="p">;</span>
	<span class="cm">/* Physical half channels */</span>
	<span class="k">struct</span> <span class="n">d40_phy_res</span>		 <span class="o">*</span><span class="n">phy_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_lcla_pool</span>		  <span class="n">lcla_pool</span><span class="p">;</span>
	<span class="kt">void</span>				 <span class="o">*</span><span class="n">lcpa_base</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>			  <span class="n">phy_lcpa</span><span class="p">;</span>
	<span class="n">resource_size_t</span>			  <span class="n">lcpa_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kmem_cache</span>		 <span class="o">*</span><span class="n">desc_slab</span><span class="p">;</span>
	<span class="n">u32</span>				  <span class="n">reg_val_backup</span><span class="p">[</span><span class="n">BACKUP_REGS_SZ</span><span class="p">];</span>
	<span class="n">u32</span>				  <span class="n">reg_val_backup_v3</span><span class="p">[</span><span class="n">BACKUP_REGS_SZ_V3</span><span class="p">];</span>
	<span class="n">u32</span>				 <span class="o">*</span><span class="n">reg_val_backup_chan</span><span class="p">;</span>
	<span class="n">u16</span>				  <span class="n">gcc_pwr_off_mask</span><span class="p">;</span>
	<span class="n">bool</span>				  <span class="n">initialized</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct d40_interrupt_lookup - lookup table for interrupt handler</span>
<span class="cm"> *</span>
<span class="cm"> * @src: Interrupt mask register.</span>
<span class="cm"> * @clr: Interrupt clear register.</span>
<span class="cm"> * @is_error: true if this is an error interrupt.</span>
<span class="cm"> * @offset: start delta in the lookup_log_chans in d40_base. If equals to</span>
<span class="cm"> * D40_PHY_CHAN, the lookup_phy_chans shall be used instead.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">d40_interrupt_lookup</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">src</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">clr</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct d40_reg_val - simple lookup struct</span>
<span class="cm"> *</span>
<span class="cm"> * @reg: The register.</span>
<span class="cm"> * @val: The value that belongs to the register in reg.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">d40_reg_val</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="nf">chan2dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">chan_is_physical</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">log_num</span> <span class="o">==</span> <span class="n">D40_PHY_CHAN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">chan_is_logical</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">chan_is_physical</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">chan_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_PCBASE</span> <span class="o">+</span>
	       <span class="n">chan</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">*</span> <span class="n">D40_DREG_PCDELTA</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define d40_err(dev, format, arg...)		\</span>
<span class="cp">	dev_err(dev, &quot;[%s] &quot; format, __func__, ## arg)</span>

<span class="cp">#define chan_err(d40c, format, arg...)		\</span>
<span class="cp">	d40_err(chan2dev(d40c), format, ## arg)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">d40_pool_lli_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">d40d</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">lli_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">is_log</span> <span class="o">=</span> <span class="n">chan_is_logical</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">align</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_log</span><span class="p">)</span>
		<span class="n">align</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_log_lli</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">align</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_phy_lli</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lli_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">pre_alloc_lli</span><span class="p">;</span>
		<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">pre_alloc_lli</span><span class="p">);</span>
		<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">lli_len</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">align</span><span class="p">;</span>

		<span class="n">base</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">align</span><span class="p">,</span> <span class="n">GFP_NOWAIT</span><span class="p">);</span>
		<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_log</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_log</span><span class="p">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">PTR_ALIGN</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">align</span><span class="p">);</span>
		<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_log</span><span class="p">.</span><span class="n">dst</span> <span class="o">=</span> <span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_log</span><span class="p">.</span><span class="n">src</span> <span class="o">+</span> <span class="n">lli_len</span><span class="p">;</span>

		<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_phy</span><span class="p">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">PTR_ALIGN</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">align</span><span class="p">);</span>
		<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_phy</span><span class="p">.</span><span class="n">dst</span> <span class="o">=</span> <span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_phy</span><span class="p">.</span><span class="n">src</span> <span class="o">+</span> <span class="n">lli_len</span><span class="p">;</span>

		<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							 <span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_phy</span><span class="p">.</span><span class="n">src</span><span class="p">,</span>
							 <span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
							 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				      <span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
			<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">d40_pool_lli_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">d40d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">)</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">,</span>
				 <span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
	<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_log</span><span class="p">.</span><span class="n">src</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_log</span><span class="p">.</span><span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_phy</span><span class="p">.</span><span class="n">src</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_phy</span><span class="p">.</span><span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">d40_lcla_alloc_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">d40d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">*</span> <span class="n">D40_LCLA_LINK_PER_EVENT_GRP</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate both src and dst at the same time, therefore the half</span>
<span class="cm">	 * start on 1 since 0 can&#39;t be used since zero is used as end marker.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">D40_LCLA_LINK_PER_EVENT_GRP</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">alloc_map</span><span class="p">[</span><span class="n">p</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">alloc_map</span><span class="p">[</span><span class="n">p</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">d40d</span><span class="p">;</span>
			<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lcla_alloc</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">d40_lcla_free_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">d40d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan_is_physical</span><span class="p">(</span><span class="n">d40c</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">D40_LCLA_LINK_PER_EVENT_GRP</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">alloc_map</span><span class="p">[</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">*</span>
						    <span class="n">D40_LCLA_LINK_PER_EVENT_GRP</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">d40d</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">alloc_map</span><span class="p">[</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">*</span>
							<span class="n">D40_LCLA_LINK_PER_EVENT_GRP</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lcla_alloc</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lcla_alloc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">d40_desc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">d40d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40d</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="nf">d40_desc_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">_d</span><span class="p">;</span>

		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">_d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">async_tx_test_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">d40_desc_remove</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
				<span class="n">desc</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">desc_slab</span><span class="p">,</span> <span class="n">GFP_NOWAIT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="p">)</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">d40_desc_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">d40d</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">d40_pool_lli_free</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40d</span><span class="p">);</span>
	<span class="n">d40_lcla_free_all</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40d</span><span class="p">);</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">desc_slab</span><span class="p">,</span> <span class="n">d40d</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">d40_desc_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">d40_phy_lli_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d40_phy_lli</span> <span class="o">*</span><span class="n">lli_dst</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli_phy</span><span class="p">.</span><span class="n">dst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_phy_lli</span> <span class="o">*</span><span class="n">lli_src</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli_phy</span><span class="p">.</span><span class="n">src</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">chan_base</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">lli_src</span><span class="o">-&gt;</span><span class="n">reg_cfg</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SSCFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">lli_src</span><span class="o">-&gt;</span><span class="n">reg_elt</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SSELT</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">lli_src</span><span class="o">-&gt;</span><span class="n">reg_ptr</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SSPTR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">lli_src</span><span class="o">-&gt;</span><span class="n">reg_lnk</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SSLNK</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">lli_dst</span><span class="o">-&gt;</span><span class="n">reg_cfg</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SDCFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">lli_dst</span><span class="o">-&gt;</span><span class="n">reg_elt</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SDELT</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">lli_dst</span><span class="o">-&gt;</span><span class="n">reg_ptr</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SDPTR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">lli_dst</span><span class="o">-&gt;</span><span class="n">reg_lnk</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SDLNK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">d40_log_lli_to_lcxa</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d40_lcla_pool</span> <span class="o">*</span><span class="n">pool</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_log_lli_bidir</span> <span class="o">*</span><span class="n">lli</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli_log</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lli_current</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli_current</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lli_len</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli_len</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cyclic</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">cyclic</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">curr_lcla</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first_lcla</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">use_esram_lcla</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">use_esram_lcla</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">linkback</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We may have partially running cyclic transfers, in case we did&#39;t get</span>
<span class="cm">	 * enough LCLA entries.</span>
<span class="cm">	 */</span>
	<span class="n">linkback</span> <span class="o">=</span> <span class="n">cyclic</span> <span class="o">&amp;&amp;</span> <span class="n">lli_current</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For linkback, we need one LCLA even with only one link, because we</span>
<span class="cm">	 * can&#39;t link back to the one in LCPA space</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">linkback</span> <span class="o">||</span> <span class="p">(</span><span class="n">lli_len</span> <span class="o">-</span> <span class="n">lli_current</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">curr_lcla</span> <span class="o">=</span> <span class="n">d40_lcla_alloc_one</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
		<span class="n">first_lcla</span> <span class="o">=</span> <span class="n">curr_lcla</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For linkback, we normally load the LCPA in the loop since we need to</span>
<span class="cm">	 * link it to the second LCLA and not the first.  However, if we</span>
<span class="cm">	 * couldn&#39;t even get a first LCLA, then we have to run in LCPA and</span>
<span class="cm">	 * reload manually.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">linkback</span> <span class="o">||</span> <span class="n">curr_lcla</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">curr_lcla</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">LLI_TERM_INT</span><span class="p">;</span>

		<span class="n">d40_log_lli_lcpa_write</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lcpa</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">lli</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">[</span><span class="n">lli_current</span><span class="p">],</span>
				       <span class="o">&amp;</span><span class="n">lli</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">[</span><span class="n">lli_current</span><span class="p">],</span>
				       <span class="n">curr_lcla</span><span class="p">,</span>
				       <span class="n">flags</span><span class="p">);</span>
		<span class="n">lli_current</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">curr_lcla</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">lli_current</span> <span class="o">&lt;</span> <span class="n">lli_len</span><span class="p">;</span> <span class="n">lli_current</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lcla_offset</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">+</span>
					   <span class="mi">8</span> <span class="o">*</span> <span class="n">curr_lcla</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">d40_log_lli</span> <span class="o">*</span><span class="n">lcla</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">lcla_offset</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">next_lcla</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lli_current</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">lli_len</span><span class="p">)</span>
			<span class="n">next_lcla</span> <span class="o">=</span> <span class="n">d40_lcla_alloc_one</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">next_lcla</span> <span class="o">=</span> <span class="n">linkback</span> <span class="o">?</span> <span class="n">first_lcla</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cyclic</span> <span class="o">||</span> <span class="n">next_lcla</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">LLI_TERM_INT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">linkback</span> <span class="o">&amp;&amp;</span> <span class="n">curr_lcla</span> <span class="o">==</span> <span class="n">first_lcla</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* First link goes in both LCPA and LCLA */</span>
			<span class="n">d40_log_lli_lcpa_write</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lcpa</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">lli</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">[</span><span class="n">lli_current</span><span class="p">],</span>
					       <span class="o">&amp;</span><span class="n">lli</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">[</span><span class="n">lli_current</span><span class="p">],</span>
					       <span class="n">next_lcla</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * One unused LCLA in the cyclic case if the very first</span>
<span class="cm">		 * next_lcla fails...</span>
<span class="cm">		 */</span>
		<span class="n">d40_log_lli_lcla_write</span><span class="p">(</span><span class="n">lcla</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">lli</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">[</span><span class="n">lli_current</span><span class="p">],</span>
				       <span class="o">&amp;</span><span class="n">lli</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">[</span><span class="n">lli_current</span><span class="p">],</span>
				       <span class="n">next_lcla</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Cache maintenance is not needed if lcla is</span>
<span class="cm">		 * mapped in esram</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_esram_lcla</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_sync_single_range_for_device</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">pool</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">lcla_offset</span><span class="p">,</span>
						<span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_log_lli</span><span class="p">),</span>
						<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">curr_lcla</span> <span class="o">=</span> <span class="n">next_lcla</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">curr_lcla</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">||</span> <span class="n">curr_lcla</span> <span class="o">==</span> <span class="n">first_lcla</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lli_current</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli_current</span> <span class="o">=</span> <span class="n">lli_current</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">d40_desc_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">d40d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan_is_physical</span><span class="p">(</span><span class="n">d40c</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">d40_phy_lli_load</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40d</span><span class="p">);</span>
		<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_current</span> <span class="o">=</span> <span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">d40_log_lli_to_lcxa</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40d</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="nf">d40_first_active_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">d40_desc</span><span class="p">,</span>
			     <span class="n">node</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">d</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* remove desc from current queue and add it to the pending_queue */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">d40_desc_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">d40_desc_remove</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">is_in_client_list</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">pending_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="nf">d40_first_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">pending_queue</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">pending_queue</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">d40_desc</span><span class="p">,</span>
			     <span class="n">node</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">d</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="nf">d40_first_queued</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">d40_desc</span><span class="p">,</span>
			     <span class="n">node</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">d</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">d40_psize_2_burst_size</span><span class="p">(</span><span class="n">bool</span> <span class="n">is_log</span><span class="p">,</span> <span class="kt">int</span> <span class="n">psize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_log</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psize</span> <span class="o">==</span> <span class="n">STEDMA40_PSIZE_LOG_1</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psize</span> <span class="o">==</span> <span class="n">STEDMA40_PSIZE_PHY_1</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">psize</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The dma only supports transmitting packages up to</span>
<span class="cm"> * STEDMA40_MAX_SEG_SIZE &lt;&lt; data_width. Calculate the total number of</span>
<span class="cm"> * dma elements required to send the entire sg list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">d40_size_2_dmalen</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data_width1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data_width2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dmalen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_w</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">data_width1</span><span class="p">,</span> <span class="n">data_width2</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">min_w</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">data_width1</span><span class="p">,</span> <span class="n">data_width2</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">seg_max</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">STEDMA40_MAX_SEG_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">min_w</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">max_w</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seg_max</span> <span class="o">&gt;</span> <span class="n">STEDMA40_MAX_SEG_SIZE</span><span class="p">)</span>
		<span class="n">seg_max</span> <span class="o">-=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">max_w</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">max_w</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">seg_max</span><span class="p">)</span>
		<span class="n">dmalen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dmalen</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="n">seg_max</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmalen</span> <span class="o">*</span> <span class="n">seg_max</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="n">dmalen</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">dmalen</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">d40_sg_2_dmalen</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sgl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">data_width1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data_width2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">d40_size_2_dmalen</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span>
					<span class="n">data_width1</span><span class="p">,</span> <span class="n">data_width2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma40_backup</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">baseaddr</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">backup</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="o">*</span><span class="n">regaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="n">bool</span> <span class="n">save</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">baseaddr</span> <span class="o">+</span> <span class="n">regaddr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">save</span><span class="p">)</span>
			<span class="n">backup</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">backup</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">d40_save_restore_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_base</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="n">bool</span> <span class="n">save</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Save/Restore channel specific registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">num_phy_chans</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reserved</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_PCBASE</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">D40_DREG_PCDELTA</span><span class="p">;</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">d40_backup_regs_chan</span><span class="p">);</span>

		<span class="n">dma40_backup</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">reg_val_backup_chan</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
			     <span class="n">d40_backup_regs_chan</span><span class="p">,</span>
			     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">d40_backup_regs_chan</span><span class="p">),</span>
			     <span class="n">save</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Save/Restore global registers */</span>
	<span class="n">dma40_backup</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">reg_val_backup</span><span class="p">,</span>
		     <span class="n">d40_backup_regs</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">d40_backup_regs</span><span class="p">),</span>
		     <span class="n">save</span><span class="p">);</span>

	<span class="cm">/* Save/Restore registers only existing on dma40 v3 and later */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">dma40_backup</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">reg_val_backup_v3</span><span class="p">,</span>
			     <span class="n">d40_backup_regs_v3</span><span class="p">,</span>
			     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">d40_backup_regs_v3</span><span class="p">),</span>
			     <span class="n">save</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">d40_save_restore_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_base</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="n">bool</span> <span class="n">save</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__d40_execute_command_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">d40_command</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">active_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wmask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">D40_DMA_STOP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__d40_execute_command_phy</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">D40_DMA_SUSPEND_REQ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">execmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">active_reg</span> <span class="o">=</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_ACTIVE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">active_reg</span> <span class="o">=</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_ACTIVO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">D40_DMA_SUSPEND_REQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">active_reg</span><span class="p">)</span> <span class="o">&amp;</span>
			  <span class="n">D40_CHAN_POS_MASK</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">))</span> <span class="o">&gt;&gt;</span>
			<span class="n">D40_CHAN_POS</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">D40_DMA_SUSPENDED</span> <span class="o">||</span> <span class="n">status</span> <span class="o">==</span> <span class="n">D40_DMA_STOP</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wmask</span> <span class="o">=</span> <span class="mh">0xffffffff</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">D40_CHAN_POS_MASK</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">wmask</span> <span class="o">|</span> <span class="p">(</span><span class="n">command</span> <span class="o">&lt;&lt;</span> <span class="n">D40_CHAN_POS</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)),</span>
	       <span class="n">active_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">D40_DMA_SUSPEND_REQ</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">D40_SUSPEND_MAX_IT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">active_reg</span><span class="p">)</span> <span class="o">&amp;</span>
				  <span class="n">D40_CHAN_POS_MASK</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">))</span> <span class="o">&gt;&gt;</span>
				<span class="n">D40_CHAN_POS</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>

			<span class="n">cpu_relax</span><span class="p">();</span>
			<span class="cm">/*</span>
<span class="cm">			 * Reduce the number of bus accesses while</span>
<span class="cm">			 * waiting for the DMA to suspend.</span>
<span class="cm">			 */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">D40_DMA_STOP</span> <span class="o">||</span>
			    <span class="n">status</span> <span class="o">==</span> <span class="n">D40_DMA_SUSPENDED</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">D40_SUSPEND_MAX_IT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span>
				<span class="s">&quot;unable to suspend the chl %d (log: %d) status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">log_num</span><span class="p">,</span>
				<span class="n">status</span><span class="p">);</span>
			<span class="n">dump_stack</span><span class="p">();</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">execmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">d40_term_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">d40d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">_d</span><span class="p">;</span>

	<span class="cm">/* Release active descriptors */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">d40d</span> <span class="o">=</span> <span class="n">d40_first_active_get</span><span class="p">(</span><span class="n">d40c</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">d40_desc_remove</span><span class="p">(</span><span class="n">d40d</span><span class="p">);</span>
		<span class="n">d40_desc_free</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40d</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Release queued descriptors waiting for transfer */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">d40d</span> <span class="o">=</span> <span class="n">d40_first_queued</span><span class="p">(</span><span class="n">d40c</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">d40_desc_remove</span><span class="p">(</span><span class="n">d40d</span><span class="p">);</span>
		<span class="n">d40_desc_free</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40d</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Release pending descriptors */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">d40d</span> <span class="o">=</span> <span class="n">d40_first_pending</span><span class="p">(</span><span class="n">d40c</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">d40_desc_remove</span><span class="p">(</span><span class="n">d40d</span><span class="p">);</span>
		<span class="n">d40_desc_free</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40d</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Release client owned descriptors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">))</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">d40d</span><span class="p">,</span> <span class="n">_d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d40_desc_remove</span><span class="p">(</span><span class="n">d40d</span><span class="p">);</span>
			<span class="n">d40_desc_free</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40d</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="cm">/* Release descriptors in prepare queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">prepare_queue</span><span class="p">))</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">d40d</span><span class="p">,</span> <span class="n">_d</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">prepare_queue</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d40_desc_remove</span><span class="p">(</span><span class="n">d40d</span><span class="p">);</span>
			<span class="n">d40_desc_free</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40d</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">pending_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__d40_config_set_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">d40_events</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">chan_base</span><span class="p">(</span><span class="n">d40c</span><span class="p">)</span> <span class="o">+</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tries</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event_type</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">D40_DEACTIVATE_EVENTLINE</span>:

		<span class="n">writel</span><span class="p">((</span><span class="n">D40_DEACTIVATE_EVENTLINE</span> <span class="o">&lt;&lt;</span> <span class="n">D40_EVENTLINE_POS</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
		       <span class="o">|</span> <span class="o">~</span><span class="n">D40_EVENTLINE_MASK</span><span class="p">(</span><span class="n">event</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">D40_SUSPEND_REQ_EVENTLINE</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">D40_EVENTLINE_MASK</span><span class="p">(</span><span class="n">event</span><span class="p">))</span> <span class="o">&gt;&gt;</span>
			  <span class="n">D40_EVENTLINE_POS</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">D40_DEACTIVATE_EVENTLINE</span> <span class="o">||</span>
		    <span class="n">status</span> <span class="o">==</span> <span class="n">D40_SUSPEND_REQ_EVENTLINE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">((</span><span class="n">D40_SUSPEND_REQ_EVENTLINE</span> <span class="o">&lt;&lt;</span> <span class="n">D40_EVENTLINE_POS</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
		       <span class="o">|</span> <span class="o">~</span><span class="n">D40_EVENTLINE_MASK</span><span class="p">(</span><span class="n">event</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">tries</span> <span class="o">&lt;</span> <span class="n">D40_SUSPEND_MAX_IT</span><span class="p">;</span> <span class="n">tries</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">D40_EVENTLINE_MASK</span><span class="p">(</span><span class="n">event</span><span class="p">))</span> <span class="o">&gt;&gt;</span>
				  <span class="n">D40_EVENTLINE_POS</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

			<span class="n">cpu_relax</span><span class="p">();</span>
			<span class="cm">/*</span>
<span class="cm">			 * Reduce the number of bus accesses while</span>
<span class="cm">			 * waiting for the DMA to suspend.</span>
<span class="cm">			 */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">D40_DEACTIVATE_EVENTLINE</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tries</span> <span class="o">==</span> <span class="n">D40_SUSPEND_MAX_IT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span>
				<span class="s">&quot;unable to stop the event_line chl %d (log: %d)&quot;</span>
				<span class="s">&quot;status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span>
				 <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">log_num</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">D40_ACTIVATE_EVENTLINE</span>:
	<span class="cm">/*</span>
<span class="cm">	 * The hardware sometimes doesn&#39;t register the enable when src and dst</span>
<span class="cm">	 * event lines are active on the same logical channel.  Retry to ensure</span>
<span class="cm">	 * it does.  Usually only one retry is sufficient.</span>
<span class="cm">	 */</span>
		<span class="n">tries</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">tries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">((</span><span class="n">D40_ACTIVATE_EVENTLINE</span> <span class="o">&lt;&lt;</span>
				<span class="n">D40_EVENTLINE_POS</span><span class="p">(</span><span class="n">event</span><span class="p">))</span> <span class="o">|</span>
				<span class="o">~</span><span class="n">D40_EVENTLINE_MASK</span><span class="p">(</span><span class="n">event</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">D40_EVENTLINE_MASK</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tries</span> <span class="o">!=</span> <span class="mi">99</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">d40c</span><span class="p">),</span>
				<span class="s">&quot;[%s] workaround enable S%cLNK (%d tries)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span> <span class="o">==</span> <span class="n">D40_CHAN_REG_SSLNK</span> <span class="o">?</span> <span class="sc">&#39;S&#39;</span> <span class="o">:</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span>
				<span class="mi">100</span> <span class="o">-</span> <span class="n">tries</span><span class="p">);</span>

		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">tries</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">D40_ROUND_EVENTLINE</span>:
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">d40_config_set_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">d40_events</span> <span class="n">event_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Enable event line connected to device (or memcpy) */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">==</span>  <span class="n">STEDMA40_PERIPH_TO_MEM</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">==</span> <span class="n">STEDMA40_PERIPH_TO_PERIPH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">event</span> <span class="o">=</span> <span class="n">D40_TYPE_TO_EVENT</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">src_dev_type</span><span class="p">);</span>

		<span class="n">__d40_config_set_event</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span>
				       <span class="n">D40_CHAN_REG_SSLNK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">!=</span>  <span class="n">STEDMA40_PERIPH_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">event</span> <span class="o">=</span> <span class="n">D40_TYPE_TO_EVENT</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dst_dev_type</span><span class="p">);</span>

		<span class="n">__d40_config_set_event</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span>
				       <span class="n">D40_CHAN_REG_SDLNK</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">d40_chan_has_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">chanbase</span> <span class="o">=</span> <span class="n">chan_base</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">chanbase</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SSLNK</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">readl</span><span class="p">(</span><span class="n">chanbase</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SDLNK</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__d40_execute_command_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">,</span> <span class="k">enum</span> <span class="n">d40_command</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">active_status</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">active_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">active_reg</span> <span class="o">=</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_ACTIVE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">active_reg</span> <span class="o">=</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_ACTIVO</span><span class="p">;</span>


	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">D40_DMA_STOP</span>:
	<span class="k">case</span> <span class="n">D40_DMA_SUSPEND_REQ</span>:

		<span class="n">active_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">active_reg</span><span class="p">)</span> <span class="o">&amp;</span>
				 <span class="n">D40_CHAN_POS_MASK</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">))</span> <span class="o">&gt;&gt;</span>
				 <span class="n">D40_CHAN_POS</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">active_status</span> <span class="o">==</span> <span class="n">D40_DMA_RUN</span><span class="p">)</span>
			<span class="n">d40_config_set_event</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">D40_SUSPEND_REQ_EVENTLINE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">d40_config_set_event</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">D40_DEACTIVATE_EVENTLINE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d40_chan_has_events</span><span class="p">(</span><span class="n">d40c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">D40_DMA_STOP</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__d40_execute_command_phy</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">D40_DMA_RUN</span>:

		<span class="n">d40_config_set_event</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">D40_ACTIVATE_EVENTLINE</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__d40_execute_command_phy</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">D40_DMA_SUSPENDED</span>:
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">d40_channel_execute_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">,</span>
				       <span class="k">enum</span> <span class="n">d40_command</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan_is_logical</span><span class="p">(</span><span class="n">d40c</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">__d40_execute_command_log</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">__d40_execute_command_phy</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">d40_get_prmo</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phy_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">STEDMA40_PCHAN_BASIC_MODE</span><span class="p">]</span>
			<span class="o">=</span> <span class="n">D40_DREG_PRMO_PCHAN_BASIC</span><span class="p">,</span>
		<span class="p">[</span><span class="n">STEDMA40_PCHAN_MODULO_MODE</span><span class="p">]</span>
			<span class="o">=</span> <span class="n">D40_DREG_PRMO_PCHAN_MODULO</span><span class="p">,</span>
		<span class="p">[</span><span class="n">STEDMA40_PCHAN_DOUBLE_DST_MODE</span><span class="p">]</span>
			<span class="o">=</span> <span class="n">D40_DREG_PRMO_PCHAN_DOUBLE_DST</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">log_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">STEDMA40_LCHAN_SRC_PHY_DST_LOG</span><span class="p">]</span>
			<span class="o">=</span> <span class="n">D40_DREG_PRMO_LCHAN_SRC_PHY_DST_LOG</span><span class="p">,</span>
		<span class="p">[</span><span class="n">STEDMA40_LCHAN_SRC_LOG_DST_PHY</span><span class="p">]</span>
			<span class="o">=</span> <span class="n">D40_DREG_PRMO_LCHAN_SRC_LOG_DST_PHY</span><span class="p">,</span>
		<span class="p">[</span><span class="n">STEDMA40_LCHAN_SRC_LOG_DST_LOG</span><span class="p">]</span>
			<span class="o">=</span> <span class="n">D40_DREG_PRMO_LCHAN_SRC_LOG_DST_LOG</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan_is_physical</span><span class="p">(</span><span class="n">d40c</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">phy_map</span><span class="p">[</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">mode_opt</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">log_map</span><span class="p">[</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">mode_opt</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">d40_config_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr_base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">var</span><span class="p">;</span>

	<span class="cm">/* Odd addresses are even addresses + 4 */</span>
	<span class="n">addr_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="cm">/* Setup channel mode to logical or physical */</span>
	<span class="n">var</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">chan_is_logical</span><span class="p">(</span><span class="n">d40c</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">D40_CHAN_POS</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_PRMSE</span> <span class="o">+</span> <span class="n">addr_base</span><span class="p">);</span>

	<span class="cm">/* Setup operational mode option register */</span>
	<span class="n">var</span> <span class="o">=</span> <span class="n">d40_get_prmo</span><span class="p">(</span><span class="n">d40c</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">D40_CHAN_POS</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_PRMOE</span> <span class="o">+</span> <span class="n">addr_base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan_is_logical</span><span class="p">(</span><span class="n">d40c</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">lidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&lt;&lt;</span> <span class="n">D40_SREG_ELEM_LOG_LIDX_POS</span><span class="p">)</span>
			   <span class="o">&amp;</span> <span class="n">D40_SREG_ELEM_LOG_LIDX_MASK</span><span class="p">;</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">chanbase</span> <span class="o">=</span> <span class="n">chan_base</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>

		<span class="cm">/* Set default config for CFG reg */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">src_def_cfg</span><span class="p">,</span> <span class="n">chanbase</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SSCFG</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dst_def_cfg</span><span class="p">,</span> <span class="n">chanbase</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SDCFG</span><span class="p">);</span>

		<span class="cm">/* Set LIDX for lcla */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">lidx</span><span class="p">,</span> <span class="n">chanbase</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SSELT</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">lidx</span><span class="p">,</span> <span class="n">chanbase</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SDELT</span><span class="p">);</span>

		<span class="cm">/* Clear LNK which will be used by d40_chan_has_events() */</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">chanbase</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SSLNK</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">chanbase</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SDLNK</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">d40_residue</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">num_elt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan_is_logical</span><span class="p">(</span><span class="n">d40c</span><span class="p">))</span>
		<span class="n">num_elt</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lcpa</span><span class="o">-&gt;</span><span class="n">lcsp2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">D40_MEM_LCSP2_ECNT_MASK</span><span class="p">)</span>
			<span class="o">&gt;&gt;</span> <span class="n">D40_MEM_LCSP2_ECNT_POS</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">chan_base</span><span class="p">(</span><span class="n">d40c</span><span class="p">)</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SDELT</span><span class="p">);</span>
		<span class="n">num_elt</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">D40_SREG_ELEM_PHY_ECNT_MASK</span><span class="p">)</span>
			  <span class="o">&gt;&gt;</span> <span class="n">D40_SREG_ELEM_PHY_ECNT_POS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">num_elt</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dst_info</span><span class="p">.</span><span class="n">data_width</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">d40_tx_is_linked</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">is_link</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan_is_logical</span><span class="p">(</span><span class="n">d40c</span><span class="p">))</span>
		<span class="n">is_link</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lcpa</span><span class="o">-&gt;</span><span class="n">lcsp3</span><span class="p">)</span> <span class="o">&amp;</span>  <span class="n">D40_MEM_LCSP3_DLOS_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">is_link</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">chan_base</span><span class="p">(</span><span class="n">d40c</span><span class="p">)</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SDLNK</span><span class="p">)</span>
			  <span class="o">&amp;</span> <span class="n">D40_SREG_LNK_PHYS_LNK_MASK</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">is_link</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">d40_pause</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">d40_channel_execute_command</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">D40_DMA_SUSPEND_REQ</span><span class="p">);</span>

	<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">d40_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* If bytes left to transfer or linked tx resume job */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d40_residue</span><span class="p">(</span><span class="n">d40c</span><span class="p">)</span> <span class="o">||</span> <span class="n">d40_tx_is_linked</span><span class="p">(</span><span class="n">d40c</span><span class="p">))</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">d40_channel_execute_command</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">D40_DMA_RUN</span><span class="p">);</span>

	<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">dma_cookie_t</span> <span class="nf">d40_tx_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">d40_chan</span><span class="p">,</span>
					     <span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">d40d</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_desc</span><span class="p">,</span> <span class="n">txd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cookie</span> <span class="o">=</span> <span class="n">dma_cookie_assign</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
	<span class="n">d40_desc_queue</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40d</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cookie</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">d40_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">d40_channel_execute_command</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">D40_DMA_RUN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="nf">d40_queue_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">d40d</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Start queued jobs, if any */</span>
	<span class="n">d40d</span> <span class="o">=</span> <span class="n">d40_first_queued</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d40d</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Remove from queue */</span>
		<span class="n">d40_desc_remove</span><span class="p">(</span><span class="n">d40d</span><span class="p">);</span>

		<span class="cm">/* Add to active queue */</span>
		<span class="n">d40_desc_submit</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40d</span><span class="p">);</span>

		<span class="cm">/* Initiate DMA job */</span>
		<span class="n">d40_desc_load</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40d</span><span class="p">);</span>

		<span class="cm">/* Start dma job */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">d40_start</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">d40d</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* called from interrupt context */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_tc_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">d40d</span><span class="p">;</span>

	<span class="cm">/* Get first active entry from list */</span>
	<span class="n">d40d</span> <span class="o">=</span> <span class="n">d40_first_active_get</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d40d</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d40d</span><span class="o">-&gt;</span><span class="n">cyclic</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If this was a paritially loaded list, we need to reloaded</span>
<span class="cm">		 * it, and only when the list is completed.  We need to check</span>
<span class="cm">		 * for done because the interrupt will hit for every link, and</span>
<span class="cm">		 * not just the last one.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_current</span> <span class="o">&lt;</span> <span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_len</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">d40_tx_is_linked</span><span class="p">(</span><span class="n">d40c</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">d40_residue</span><span class="p">(</span><span class="n">d40c</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">d40_lcla_free_all</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40d</span><span class="p">);</span>
			<span class="n">d40_desc_load</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40d</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">d40_start</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_current</span> <span class="o">==</span> <span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_len</span><span class="p">)</span>
				<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_current</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">d40_lcla_free_all</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40d</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_current</span> <span class="o">&lt;</span> <span class="n">d40d</span><span class="o">-&gt;</span><span class="n">lli_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d40_desc_load</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40d</span><span class="p">);</span>
			<span class="cm">/* Start dma job */</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">d40_start</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">d40_queue_start</span><span class="p">(</span><span class="n">d40c</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">pending_tx</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">d40d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">dma_async_tx_callback</span> <span class="n">callback</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">callback_param</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Get first active entry from list */</span>
	<span class="n">d40d</span> <span class="o">=</span> <span class="n">d40_first_active_get</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d40d</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d40d</span><span class="o">-&gt;</span><span class="n">cyclic</span><span class="p">)</span>
		<span class="n">dma_cookie_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40d</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If terminating a channel pending_tx is set to zero.</span>
<span class="cm">	 * This prevents any finished active jobs to return to the client.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">pending_tx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Callback to client */</span>
	<span class="n">callback</span> <span class="o">=</span> <span class="n">d40d</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">callback</span><span class="p">;</span>
	<span class="n">callback_param</span> <span class="o">=</span> <span class="n">d40d</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">callback_param</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d40d</span><span class="o">-&gt;</span><span class="n">cyclic</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">async_tx_test_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40d</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">d40_desc_remove</span><span class="p">(</span><span class="n">d40d</span><span class="p">);</span>
			<span class="n">d40_desc_free</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40d</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d40d</span><span class="o">-&gt;</span><span class="n">is_in_client_list</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">d40_desc_remove</span><span class="p">(</span><span class="n">d40d</span><span class="p">);</span>
				<span class="n">d40_lcla_free_all</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40d</span><span class="p">);</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40d</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>
				<span class="n">d40d</span><span class="o">-&gt;</span><span class="n">is_in_client_list</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">pending_tx</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">pending_tx</span><span class="p">)</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">callback</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">d40d</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_INTERRUPT</span><span class="p">))</span>
		<span class="n">callback</span><span class="p">(</span><span class="n">callback_param</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="cm">/* Rescue manouver if receiving double interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">pending_tx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">pending_tx</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">d40_handle_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">d40_interrupt_lookup</span> <span class="n">il</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">D40_DREG_LCTIS0</span><span class="p">,</span> <span class="n">D40_DREG_LCICR0</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>  <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="n">D40_DREG_LCTIS1</span><span class="p">,</span> <span class="n">D40_DREG_LCICR1</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">32</span><span class="p">},</span>
		<span class="p">{</span><span class="n">D40_DREG_LCTIS2</span><span class="p">,</span> <span class="n">D40_DREG_LCICR2</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">64</span><span class="p">},</span>
		<span class="p">{</span><span class="n">D40_DREG_LCTIS3</span><span class="p">,</span> <span class="n">D40_DREG_LCICR3</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">96</span><span class="p">},</span>
		<span class="p">{</span><span class="n">D40_DREG_LCEIS0</span><span class="p">,</span> <span class="n">D40_DREG_LCICR0</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>   <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="n">D40_DREG_LCEIS1</span><span class="p">,</span> <span class="n">D40_DREG_LCICR1</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>  <span class="mi">32</span><span class="p">},</span>
		<span class="p">{</span><span class="n">D40_DREG_LCEIS2</span><span class="p">,</span> <span class="n">D40_DREG_LCICR2</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>  <span class="mi">64</span><span class="p">},</span>
		<span class="p">{</span><span class="n">D40_DREG_LCEIS3</span><span class="p">,</span> <span class="n">D40_DREG_LCICR3</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>  <span class="mi">96</span><span class="p">},</span>
		<span class="p">{</span><span class="n">D40_DREG_PCTIS</span><span class="p">,</span>  <span class="n">D40_DREG_PCICR</span><span class="p">,</span>  <span class="nb">false</span><span class="p">,</span> <span class="n">D40_PHY_CHAN</span><span class="p">},</span>
		<span class="p">{</span><span class="n">D40_DREG_PCEIS</span><span class="p">,</span>  <span class="n">D40_DREG_PCICR</span><span class="p">,</span>  <span class="nb">true</span><span class="p">,</span>  <span class="n">D40_PHY_CHAN</span><span class="p">},</span>
	<span class="p">};</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">regs</span><span class="p">[</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">il</span><span class="p">)];</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">row</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">chan</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_base</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">interrupt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Read interrupt status of both logical and physical channels */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">il</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">il</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>

		<span class="n">chan</span> <span class="o">=</span> <span class="n">find_next_bit</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="p">,</span>
				     <span class="n">BITS_PER_LONG</span> <span class="o">*</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">il</span><span class="p">),</span> <span class="n">chan</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* No more set bits found? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="n">BITS_PER_LONG</span> <span class="o">*</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">il</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">row</span> <span class="o">=</span> <span class="n">chan</span> <span class="o">/</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">chan</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* ACK interrupt */</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">il</span><span class="p">[</span><span class="n">row</span><span class="p">].</span><span class="n">clr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="p">[</span><span class="n">row</span><span class="p">].</span><span class="n">offset</span> <span class="o">==</span> <span class="n">D40_PHY_CHAN</span><span class="p">)</span>
			<span class="n">d40c</span> <span class="o">=</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">lookup_phy_chans</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">d40c</span> <span class="o">=</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">lookup_log_chans</span><span class="p">[</span><span class="n">il</span><span class="p">[</span><span class="n">row</span><span class="p">].</span><span class="n">offset</span> <span class="o">+</span> <span class="n">idx</span><span class="p">];</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="p">[</span><span class="n">row</span><span class="p">].</span><span class="n">is_error</span><span class="p">)</span>
			<span class="n">dma_tc_handle</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">d40_err</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ chan: %ld offset %d idx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">chan</span><span class="p">,</span> <span class="n">il</span><span class="p">[</span><span class="n">row</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">interrupt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">d40_validate_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dst_event_group</span> <span class="o">=</span> <span class="n">D40_TYPE_TO_GROUP</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">dst_dev_type</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">src_event_group</span> <span class="o">=</span> <span class="n">D40_TYPE_TO_GROUP</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">src_dev_type</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">is_log</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">STEDMA40_MODE_LOGICAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;Invalid direction.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">dst_dev_type</span> <span class="o">!=</span> <span class="n">STEDMA40_DEV_DST_MEMORY</span> <span class="o">&amp;&amp;</span>
	    <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">dev_tx</span><span class="p">[</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">dst_dev_type</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">runtime_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;Invalid TX channel address (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">conf</span><span class="o">-&gt;</span><span class="n">dst_dev_type</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">src_dev_type</span> <span class="o">!=</span> <span class="n">STEDMA40_DEV_SRC_MEMORY</span> <span class="o">&amp;&amp;</span>
	    <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">dev_rx</span><span class="p">[</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">src_dev_type</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">runtime_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;Invalid RX channel address (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">src_dev_type</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">STEDMA40_MEM_TO_PERIPH</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dst_event_group</span> <span class="o">==</span> <span class="n">STEDMA40_DEV_DST_MEMORY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;Invalid dst</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">STEDMA40_PERIPH_TO_MEM</span> <span class="o">&amp;&amp;</span>
	    <span class="n">src_event_group</span> <span class="o">==</span> <span class="n">STEDMA40_DEV_SRC_MEMORY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;Invalid src</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">src_event_group</span> <span class="o">==</span> <span class="n">STEDMA40_DEV_SRC_MEMORY</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dst_event_group</span> <span class="o">==</span> <span class="n">STEDMA40_DEV_DST_MEMORY</span> <span class="o">&amp;&amp;</span> <span class="n">is_log</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;No event line</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">STEDMA40_PERIPH_TO_PERIPH</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">src_event_group</span> <span class="o">!=</span> <span class="n">dst_event_group</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;Invalid event group</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">STEDMA40_PERIPH_TO_PERIPH</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * DMAC HW supports it. Will be added to this driver,</span>
<span class="cm">		 * in case any dma client requires it.</span>
<span class="cm">		 */</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;periph to periph not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d40_psize_2_burst_size</span><span class="p">(</span><span class="n">is_log</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">src_info</span><span class="p">.</span><span class="n">psize</span><span class="p">)</span> <span class="o">*</span>
	    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">src_info</span><span class="p">.</span><span class="n">data_width</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">d40_psize_2_burst_size</span><span class="p">(</span><span class="n">is_log</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">dst_info</span><span class="p">.</span><span class="n">psize</span><span class="p">)</span> <span class="o">*</span>
	    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">dst_info</span><span class="p">.</span><span class="n">data_width</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The DMAC hardware only supports</span>
<span class="cm">		 * src (burst x width) == dst (burst x width)</span>
<span class="cm">		 */</span>

		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;src (burst x width) != dst (burst x width)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">d40_alloc_mask_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_phy_res</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
			       <span class="n">bool</span> <span class="n">is_src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">log_event_line</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_log</span><span class="p">,</span>
			       <span class="n">bool</span> <span class="o">*</span><span class="n">first_user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="o">*</span><span class="n">first_user</span> <span class="o">=</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_src</span> <span class="o">|</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_dst</span><span class="p">)</span>
			<span class="o">==</span> <span class="n">D40_ALLOC_FREE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_log</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Physical interrupts are masked per physical full channel */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_src</span> <span class="o">==</span> <span class="n">D40_ALLOC_FREE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_dst</span> <span class="o">==</span> <span class="n">D40_ALLOC_FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_dst</span> <span class="o">=</span> <span class="n">D40_ALLOC_PHY</span><span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_src</span> <span class="o">=</span> <span class="n">D40_ALLOC_PHY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Logical channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_src</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_src</span> <span class="o">==</span> <span class="n">D40_ALLOC_PHY</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_src</span> <span class="o">==</span> <span class="n">D40_ALLOC_FREE</span><span class="p">)</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_src</span> <span class="o">=</span> <span class="n">D40_ALLOC_LOG_FREE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_src</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">log_event_line</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_src</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">log_event_line</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_dst</span> <span class="o">==</span> <span class="n">D40_ALLOC_PHY</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_dst</span> <span class="o">==</span> <span class="n">D40_ALLOC_FREE</span><span class="p">)</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_dst</span> <span class="o">=</span> <span class="n">D40_ALLOC_LOG_FREE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_dst</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">log_event_line</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_dst</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">log_event_line</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">not_found:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="nl">found:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">d40_alloc_mask_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_phy_res</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_src</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">log_event_line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_free</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">log_event_line</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_dst</span> <span class="o">=</span> <span class="n">D40_ALLOC_FREE</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_src</span> <span class="o">=</span> <span class="n">D40_ALLOC_FREE</span><span class="p">;</span>
		<span class="n">is_free</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Logical channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_src</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_src</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">log_event_line</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_src</span> <span class="o">==</span> <span class="n">D40_ALLOC_LOG_FREE</span><span class="p">)</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_src</span> <span class="o">=</span> <span class="n">D40_ALLOC_FREE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_dst</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">log_event_line</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_dst</span> <span class="o">==</span> <span class="n">D40_ALLOC_LOG_FREE</span><span class="p">)</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_dst</span> <span class="o">=</span> <span class="n">D40_ALLOC_FREE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">is_free</span> <span class="o">=</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_src</span> <span class="o">|</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_dst</span><span class="p">)</span> <span class="o">==</span>
		   <span class="n">D40_ALLOC_FREE</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">is_free</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">d40_allocate_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">first_phy_user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dev_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">event_group</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">event_line</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_phy_res</span> <span class="o">*</span><span class="n">phys</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">log_num</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_src</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_log</span> <span class="o">=</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">STEDMA40_MODE_LOGICAL</span><span class="p">;</span>

	<span class="n">phys</span> <span class="o">=</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">==</span> <span class="n">STEDMA40_PERIPH_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_type</span> <span class="o">=</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">src_dev_type</span><span class="p">;</span>
		<span class="n">log_num</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dev_type</span><span class="p">;</span>
		<span class="n">is_src</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">==</span> <span class="n">STEDMA40_MEM_TO_PERIPH</span> <span class="o">||</span>
		   <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">==</span> <span class="n">STEDMA40_MEM_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* dst event lines are used for logical memcpy */</span>
		<span class="n">dev_type</span> <span class="o">=</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dst_dev_type</span><span class="p">;</span>
		<span class="n">log_num</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dev_type</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">is_src</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">event_group</span> <span class="o">=</span> <span class="n">D40_TYPE_TO_GROUP</span><span class="p">(</span><span class="n">dev_type</span><span class="p">);</span>
	<span class="n">event_line</span> <span class="o">=</span> <span class="n">D40_TYPE_TO_EVENT</span><span class="p">(</span><span class="n">dev_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_log</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">==</span> <span class="n">STEDMA40_MEM_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Find physical half channel */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">num_phy_chans</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">d40_alloc_mask_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">is_src</span><span class="p">,</span>
						       <span class="mi">0</span><span class="p">,</span> <span class="n">is_log</span><span class="p">,</span>
						       <span class="n">first_phy_user</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">found_phy</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">num_phy_chans</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">phy_num</span> <span class="o">=</span> <span class="n">j</span>  <span class="o">+</span> <span class="n">event_group</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">phy_num</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">phy_num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">d40_alloc_mask_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
							       <span class="n">is_src</span><span class="p">,</span>
							       <span class="mi">0</span><span class="p">,</span>
							       <span class="n">is_log</span><span class="p">,</span>
							       <span class="n">first_phy_user</span><span class="p">))</span>
						<span class="k">goto</span> <span class="n">found_phy</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="nl">found_phy:</span>
		<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">log_num</span> <span class="o">=</span> <span class="n">D40_PHY_CHAN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Find logical channel */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">num_phy_chans</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">phy_num</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="n">event_group</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">use_fixed_channel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">phy_channel</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">!=</span> <span class="n">phy_num</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">phy_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">d40c</span><span class="p">),</span>
					<span class="s">&quot;invalid fixed phy channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">d40_alloc_mask_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">is_src</span><span class="p">,</span> <span class="n">event_line</span><span class="p">,</span>
					       <span class="n">is_log</span><span class="p">,</span> <span class="n">first_phy_user</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">found_log</span><span class="p">;</span>

			<span class="n">dev_err</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">d40c</span><span class="p">),</span>
				<span class="s">&quot;could not allocate fixed phy channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Spread logical channels across all available physical rather</span>
<span class="cm">		 * than pack every logical channel at the first available phy</span>
<span class="cm">		 * channels.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_src</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">phy_num</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">phy_num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">d40_alloc_mask_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">is_src</span><span class="p">,</span>
						       <span class="n">event_line</span><span class="p">,</span> <span class="n">is_log</span><span class="p">,</span>
						       <span class="n">first_phy_user</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">found_log</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">phy_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">phy_num</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">d40_alloc_mask_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">is_src</span><span class="p">,</span>
						       <span class="n">event_line</span><span class="p">,</span> <span class="n">is_log</span><span class="p">,</span>
						       <span class="n">first_phy_user</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">found_log</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="nl">found_log:</span>
	<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">log_num</span> <span class="o">=</span> <span class="n">log_num</span><span class="p">;</span>
<span class="nl">out:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_log</span><span class="p">)</span>
		<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lookup_log_chans</span><span class="p">[</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">log_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">d40c</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lookup_phy_chans</span><span class="p">[</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">d40c</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">d40_config_memcpy</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_cap_mask_t</span> <span class="n">cap</span> <span class="o">=</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">cap</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">cap</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span> <span class="o">=</span> <span class="o">*</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">memcpy_conf_log</span><span class="p">;</span>
		<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">src_dev_type</span> <span class="o">=</span> <span class="n">STEDMA40_DEV_SRC_MEMORY</span><span class="p">;</span>
		<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dst_dev_type</span> <span class="o">=</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">plat_data</span><span class="o">-&gt;</span>
			<span class="n">memcpy</span><span class="p">[</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">chan_id</span><span class="p">];</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">cap</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">cap</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span> <span class="o">=</span> <span class="o">*</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">memcpy_conf_phy</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;No memcpy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">d40_free_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_phy_res</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_src</span><span class="p">;</span>

	<span class="cm">/* Terminate all queued and active transfers */</span>
	<span class="n">d40_term_all</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;phy == null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_src</span> <span class="o">==</span> <span class="n">D40_ALLOC_FREE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">allocated_dst</span> <span class="o">==</span> <span class="n">D40_ALLOC_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;channel already free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">==</span> <span class="n">STEDMA40_MEM_TO_PERIPH</span> <span class="o">||</span>
	    <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">==</span> <span class="n">STEDMA40_MEM_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">D40_TYPE_TO_EVENT</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dst_dev_type</span><span class="p">);</span>
		<span class="n">is_src</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">==</span> <span class="n">STEDMA40_PERIPH_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">D40_TYPE_TO_EVENT</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">src_dev_type</span><span class="p">);</span>
		<span class="n">is_src</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;Unknown direction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">d40_channel_execute_command</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">D40_DMA_STOP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;stop failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">d40_alloc_mask_free</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">is_src</span><span class="p">,</span> <span class="n">chan_is_logical</span><span class="p">(</span><span class="n">d40c</span><span class="p">)</span> <span class="o">?</span> <span class="n">event</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan_is_logical</span><span class="p">(</span><span class="n">d40c</span><span class="p">))</span>
		<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lookup_log_chans</span><span class="p">[</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">log_num</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lookup_phy_chans</span><span class="p">[</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">configured</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="nl">out:</span>

	<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">d40_is_paused</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">chanbase</span> <span class="o">=</span> <span class="n">chan_base</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">is_paused</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">active_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan_is_physical</span><span class="p">(</span><span class="n">d40c</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">active_reg</span> <span class="o">=</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_ACTIVE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">active_reg</span> <span class="o">=</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_ACTIVO</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">active_reg</span><span class="p">)</span> <span class="o">&amp;</span>
			  <span class="n">D40_CHAN_POS_MASK</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">))</span> <span class="o">&gt;&gt;</span>
			<span class="n">D40_CHAN_POS</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">D40_DMA_SUSPENDED</span> <span class="o">||</span> <span class="n">status</span> <span class="o">==</span> <span class="n">D40_DMA_STOP</span><span class="p">)</span>
			<span class="n">is_paused</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">goto</span> <span class="n">_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">==</span> <span class="n">STEDMA40_MEM_TO_PERIPH</span> <span class="o">||</span>
	    <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">==</span> <span class="n">STEDMA40_MEM_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">D40_TYPE_TO_EVENT</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dst_dev_type</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">chanbase</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SDLNK</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">==</span> <span class="n">STEDMA40_PERIPH_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">D40_TYPE_TO_EVENT</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">src_dev_type</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">chanbase</span> <span class="o">+</span> <span class="n">D40_CHAN_REG_SSLNK</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;Unknown direction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">D40_EVENTLINE_MASK</span><span class="p">(</span><span class="n">event</span><span class="p">))</span> <span class="o">&gt;&gt;</span>
		<span class="n">D40_EVENTLINE_POS</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">D40_DMA_RUN</span><span class="p">)</span>
		<span class="n">is_paused</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="nl">_exit:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">is_paused</span><span class="p">;</span>

<span class="p">}</span>


<span class="k">static</span> <span class="n">u32</span> <span class="nf">stedma40_residue</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_chan</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">bytes_left</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">bytes_left</span> <span class="o">=</span> <span class="n">d40_residue</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bytes_left</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">d40_prep_sg_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg_src</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg_dst</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">src_dev_addr</span><span class="p">,</span>
		<span class="n">dma_addr_t</span> <span class="n">dst_dev_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stedma40_half_channel_info</span> <span class="o">*</span><span class="n">src_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">src_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stedma40_half_channel_info</span> <span class="o">*</span><span class="n">dst_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dst_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">d40_log_sg_to_lli</span><span class="p">(</span><span class="n">sg_src</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span>
				<span class="n">src_dev_addr</span><span class="p">,</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli_log</span><span class="p">.</span><span class="n">src</span><span class="p">,</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">log_def</span><span class="p">.</span><span class="n">lcsp1</span><span class="p">,</span>
				<span class="n">src_info</span><span class="o">-&gt;</span><span class="n">data_width</span><span class="p">,</span>
				<span class="n">dst_info</span><span class="o">-&gt;</span><span class="n">data_width</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">d40_log_sg_to_lli</span><span class="p">(</span><span class="n">sg_dst</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span>
				<span class="n">dst_dev_addr</span><span class="p">,</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli_log</span><span class="p">.</span><span class="n">dst</span><span class="p">,</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">log_def</span><span class="p">.</span><span class="n">lcsp3</span><span class="p">,</span>
				<span class="n">dst_info</span><span class="o">-&gt;</span><span class="n">data_width</span><span class="p">,</span>
				<span class="n">src_info</span><span class="o">-&gt;</span><span class="n">data_width</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">d40_prep_sg_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg_src</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg_dst</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">src_dev_addr</span><span class="p">,</span>
		<span class="n">dma_addr_t</span> <span class="n">dst_dev_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stedma40_half_channel_info</span> <span class="o">*</span><span class="n">src_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">src_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stedma40_half_channel_info</span> <span class="o">*</span><span class="n">dst_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dst_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">cyclic</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">LLI_CYCLIC</span> <span class="o">|</span> <span class="n">LLI_TERM_INT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">d40_phy_sg_to_lli</span><span class="p">(</span><span class="n">sg_src</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">src_dev_addr</span><span class="p">,</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli_phy</span><span class="p">.</span><span class="n">src</span><span class="p">,</span>
				<span class="n">virt_to_phys</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli_phy</span><span class="p">.</span><span class="n">src</span><span class="p">),</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">src_def_cfg</span><span class="p">,</span>
				<span class="n">src_info</span><span class="p">,</span> <span class="n">dst_info</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">d40_phy_sg_to_lli</span><span class="p">(</span><span class="n">sg_dst</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">dst_dev_addr</span><span class="p">,</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli_phy</span><span class="p">.</span><span class="n">dst</span><span class="p">,</span>
				<span class="n">virt_to_phys</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli_phy</span><span class="p">.</span><span class="n">dst</span><span class="p">),</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">dst_def_cfg</span><span class="p">,</span>
				<span class="n">dst_info</span><span class="p">,</span> <span class="n">src_info</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">,</span>
				   <span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli_pool</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span>
<span class="nf">d40_prep_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span>
	      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dma_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">d40_desc_get</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli_len</span> <span class="o">=</span> <span class="n">d40_sg_2_dmalen</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">src_info</span><span class="p">.</span><span class="n">data_width</span><span class="p">,</span>
					<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dst_info</span><span class="p">.</span><span class="n">data_width</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="s">&quot;Unaligned size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">d40_pool_lli_alloc</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="s">&quot;Could not allocate lli</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">lli_current</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">dma_flags</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">tx_submit</span> <span class="o">=</span> <span class="n">d40_tx_submit</span><span class="p">;</span>

	<span class="n">dma_async_tx_descriptor_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">desc</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">d40_desc_free</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">dma_addr_t</span>
<span class="nf">d40_get_dev_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stedma40_platform_data</span> <span class="o">*</span><span class="n">plat</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">plat_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">runtime_addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">runtime_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">dev_rx</span><span class="p">[</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">src_dev_type</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">dev_tx</span><span class="p">[</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dst_dev_type</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">d40_prep_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">dchan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg_src</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg_dst</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">,</span>
	    <span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">direction</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dma_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dchan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_chan</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="n">dma_addr_t</span> <span class="n">src_dev_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dst_dev_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="s">&quot;Cannot prepare unallocated channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">d40_prep_desc</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">sg_src</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">dma_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sg_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg_src</span><span class="p">[</span><span class="n">sg_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">sg_src</span><span class="p">)</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">cyclic</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">!=</span> <span class="n">DMA_TRANS_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">dev_addr</span> <span class="o">=</span> <span class="n">d40_get_dev_addr</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">)</span>
			<span class="n">src_dev_addr</span> <span class="o">=</span> <span class="n">dev_addr</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span>
			<span class="n">dst_dev_addr</span> <span class="o">=</span> <span class="n">dev_addr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan_is_logical</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">d40_prep_sg_log</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">sg_src</span><span class="p">,</span> <span class="n">sg_dst</span><span class="p">,</span>
				      <span class="n">sg_len</span><span class="p">,</span> <span class="n">src_dev_addr</span><span class="p">,</span> <span class="n">dst_dev_addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">d40_prep_sg_phy</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">sg_src</span><span class="p">,</span> <span class="n">sg_dst</span><span class="p">,</span>
				      <span class="n">sg_len</span><span class="p">,</span> <span class="n">src_dev_addr</span><span class="p">,</span> <span class="n">dst_dev_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="s">&quot;Failed to prepare %s sg job: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">chan_is_logical</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;log&quot;</span> <span class="o">:</span> <span class="s">&quot;phy&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * add descriptor to the prepare queue in order to be able</span>
<span class="cm">	 * to free them later in terminate_all</span>
<span class="cm">	 */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">prepare_queue</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="p">)</span>
		<span class="n">d40_desc_free</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">stedma40_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_chan</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">d40_validate_conf</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span> <span class="o">=</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">d40_config_memcpy</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">configured</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">stedma40_filter</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__d40_set_prio_rt</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev_type</span><span class="p">,</span> <span class="n">bool</span> <span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">realtime</span> <span class="o">=</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">realtime</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">highprio</span> <span class="o">=</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">high_priority</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prioreg</span> <span class="o">=</span> <span class="n">highprio</span> <span class="o">?</span> <span class="n">D40_DREG_PSEG1</span> <span class="o">:</span> <span class="n">D40_DREG_PCEG1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rtreg</span> <span class="o">=</span> <span class="n">realtime</span> <span class="o">?</span> <span class="n">D40_DREG_RSEG1</span> <span class="o">:</span> <span class="n">D40_DREG_RCEG1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">event</span> <span class="o">=</span> <span class="n">D40_TYPE_TO_EVENT</span><span class="p">(</span><span class="n">dev_type</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">group</span> <span class="o">=</span> <span class="n">D40_TYPE_TO_GROUP</span><span class="p">(</span><span class="n">dev_type</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">event</span><span class="p">;</span>

	<span class="cm">/* Destination event lines are stored in the upper halfword */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src</span><span class="p">)</span>
		<span class="n">bit</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">prioreg</span> <span class="o">+</span> <span class="n">group</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">rtreg</span> <span class="o">+</span> <span class="n">group</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">d40_set_prio_realtime</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">==</span>  <span class="n">STEDMA40_PERIPH_TO_MEM</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">==</span> <span class="n">STEDMA40_PERIPH_TO_PERIPH</span><span class="p">))</span>
		<span class="n">__d40_set_prio_rt</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">src_dev_type</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">==</span>  <span class="n">STEDMA40_MEM_TO_PERIPH</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">==</span> <span class="n">STEDMA40_PERIPH_TO_PERIPH</span><span class="p">))</span>
		<span class="n">__d40_set_prio_rt</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dst_dev_type</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* DMA ENGINE functions */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">d40_alloc_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_chan</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">is_free_phy</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dma_cookie_init</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="cm">/* If no dma configuration is set use default configuration (memcpy) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">configured</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">d40_config_memcpy</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;Failed to configure memcpy channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">d40_allocate_channel</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is_free_phy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;Failed to allocate channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">configured</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* Fill in basic CFG register values */</span>
	<span class="n">d40_phy_cfg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">src_def_cfg</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dst_def_cfg</span><span class="p">,</span> <span class="n">chan_is_logical</span><span class="p">(</span><span class="n">d40c</span><span class="p">));</span>

	<span class="n">d40_set_prio_realtime</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan_is_logical</span><span class="p">(</span><span class="n">d40c</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">d40_log_cfg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">log_def</span><span class="p">.</span><span class="n">lcsp1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">log_def</span><span class="p">.</span><span class="n">lcsp3</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">==</span> <span class="n">STEDMA40_PERIPH_TO_MEM</span><span class="p">)</span>
			<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lcpa</span> <span class="o">=</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcpa_base</span> <span class="o">+</span>
			  <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">src_dev_type</span> <span class="o">*</span> <span class="n">D40_LCPA_CHAN_SIZE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lcpa</span> <span class="o">=</span> <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcpa_base</span> <span class="o">+</span>
			  <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">dst_dev_type</span> <span class="o">*</span>
			  <span class="n">D40_LCPA_CHAN_SIZE</span> <span class="o">+</span> <span class="n">D40_LCPA_CHAN_DST_DELTA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan2dev</span><span class="p">(</span><span class="n">d40c</span><span class="p">),</span> <span class="s">&quot;allocated %s channel (phy %d%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">chan_is_logical</span><span class="p">(</span><span class="n">d40c</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;logical&quot;</span> <span class="o">:</span> <span class="s">&quot;physical&quot;</span><span class="p">,</span>
		 <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span>
		 <span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">use_fixed_channel</span> <span class="o">?</span> <span class="s">&quot;, fixed&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>


	<span class="cm">/*</span>
<span class="cm">	 * Only write channel configuration to the DMA if the physical</span>
<span class="cm">	 * resource is free. In case of multiple logical channels</span>
<span class="cm">	 * on the same physical resource, only the first write is necessary.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_free_phy</span><span class="p">)</span>
		<span class="n">d40_config_write</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">d40_free_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_chan</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;Cannot free unallocated channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">d40_free_dma</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;Failed to free channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">d40_prep_memcpy</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
						       <span class="n">dma_addr_t</span> <span class="n">dst</span><span class="p">,</span>
						       <span class="n">dma_addr_t</span> <span class="n">src</span><span class="p">,</span>
						       <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
						       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dma_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">dst_sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">src_sg</span><span class="p">;</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst_sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sg_init_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src_sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">sg_dma_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst_sg</span><span class="p">)</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>
	<span class="n">sg_dma_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src_sg</span><span class="p">)</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>

	<span class="n">sg_dma_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst_sg</span><span class="p">)</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">sg_dma_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src_sg</span><span class="p">)</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">d40_prep_sg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src_sg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst_sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="n">dma_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">d40_prep_memcpy_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">dst_sg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dst_nents</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">src_sg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src_nents</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dma_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst_nents</span> <span class="o">!=</span> <span class="n">src_nents</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">d40_prep_sg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">src_sg</span><span class="p">,</span> <span class="n">dst_sg</span><span class="p">,</span> <span class="n">src_nents</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="n">dma_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">d40_prep_slave_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
							 <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sgl</span><span class="p">,</span>
							 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">,</span>
							 <span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">direction</span><span class="p">,</span>
							 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dma_flags</span><span class="p">,</span>
							 <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">!=</span> <span class="n">DMA_DEV_TO_MEM</span> <span class="o">&amp;&amp;</span> <span class="n">direction</span> <span class="o">!=</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">d40_prep_sg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">sgl</span><span class="p">,</span> <span class="n">sgl</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">dma_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">dma40_prep_dma_cyclic</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">,</span>
		     <span class="kt">size_t</span> <span class="n">buf_len</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">period_len</span><span class="p">,</span>
		     <span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">direction</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">periods</span> <span class="o">=</span> <span class="n">buf_len</span> <span class="o">/</span> <span class="n">period_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">txd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sg</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">periods</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span><span class="p">),</span> <span class="n">GFP_NOWAIT</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">periods</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg_dma_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
		<span class="n">sg_dma_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">=</span> <span class="n">period_len</span><span class="p">;</span>
		<span class="n">dma_addr</span> <span class="o">+=</span> <span class="n">period_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sg</span><span class="p">[</span><span class="n">periods</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sg_dma_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">[</span><span class="n">periods</span><span class="p">])</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sg</span><span class="p">[</span><span class="n">periods</span><span class="p">].</span><span class="n">page_link</span> <span class="o">=</span>
		<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sg</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x02</span><span class="p">;</span>

	<span class="n">txd</span> <span class="o">=</span> <span class="n">d40_prep_sg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">periods</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span>
			  <span class="n">DMA_PREP_INTERRUPT</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">txd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">dma_status</span> <span class="nf">d40_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				     <span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">dma_tx_state</span> <span class="o">*</span><span class="n">txstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_chan</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">dma_status</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;Cannot read status of unallocated channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_cookie_status</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">txstate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">DMA_SUCCESS</span><span class="p">)</span>
		<span class="n">dma_set_residue</span><span class="p">(</span><span class="n">txstate</span><span class="p">,</span> <span class="n">stedma40_residue</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d40_is_paused</span><span class="p">(</span><span class="n">d40c</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">DMA_PAUSED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">d40_issue_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_chan</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;Channel is not allocated!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">pending_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="cm">/* Busy means that queued jobs are already being processed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">d40_queue_start</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">d40_terminate_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_chan</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">d40_channel_execute_command</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="n">D40_DMA_STOP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;Failed to stop channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">d40_term_all</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>
	<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dma40_config_to_halfchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">stedma40_half_channel_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">dma_slave_buswidth</span> <span class="n">width</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">maxburst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">stedma40_periph_data_width</span> <span class="n">addr_width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">psize</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">width</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMA_SLAVE_BUSWIDTH_1_BYTE</span>:
		<span class="n">addr_width</span> <span class="o">=</span> <span class="n">STEDMA40_BYTE_WIDTH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_SLAVE_BUSWIDTH_2_BYTES</span>:
		<span class="n">addr_width</span> <span class="o">=</span> <span class="n">STEDMA40_HALFWORD_WIDTH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_SLAVE_BUSWIDTH_4_BYTES</span>:
		<span class="n">addr_width</span> <span class="o">=</span> <span class="n">STEDMA40_WORD_WIDTH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_SLAVE_BUSWIDTH_8_BYTES</span>:
		<span class="n">addr_width</span> <span class="o">=</span> <span class="n">STEDMA40_DOUBLEWORD_WIDTH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;illegal peripheral address width &quot;</span>
			<span class="s">&quot;requested (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">width</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan_is_logical</span><span class="p">(</span><span class="n">d40c</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">maxburst</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">psize</span> <span class="o">=</span> <span class="n">STEDMA40_PSIZE_LOG_16</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">maxburst</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">psize</span> <span class="o">=</span> <span class="n">STEDMA40_PSIZE_LOG_8</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">maxburst</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">psize</span> <span class="o">=</span> <span class="n">STEDMA40_PSIZE_LOG_4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">psize</span> <span class="o">=</span> <span class="n">STEDMA40_PSIZE_LOG_1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">maxburst</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">psize</span> <span class="o">=</span> <span class="n">STEDMA40_PSIZE_PHY_16</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">maxburst</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">psize</span> <span class="o">=</span> <span class="n">STEDMA40_PSIZE_PHY_8</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">maxburst</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">psize</span> <span class="o">=</span> <span class="n">STEDMA40_PSIZE_PHY_4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">psize</span> <span class="o">=</span> <span class="n">STEDMA40_PSIZE_PHY_1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">data_width</span> <span class="o">=</span> <span class="n">addr_width</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">psize</span> <span class="o">=</span> <span class="n">psize</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">STEDMA40_NO_FLOW_CTRL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Runtime reconfiguration extension */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">d40_set_runtime_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">dma_slave_config</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_chan</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dma_cfg</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_slave_buswidth</span> <span class="n">src_addr_width</span><span class="p">,</span> <span class="n">dst_addr_width</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">config_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">src_maxburst</span><span class="p">,</span> <span class="n">dst_maxburst</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">src_addr_width</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">src_addr_width</span><span class="p">;</span>
	<span class="n">src_maxburst</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">src_maxburst</span><span class="p">;</span>
	<span class="n">dst_addr_width</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">dst_addr_width</span><span class="p">;</span>
	<span class="n">dst_maxburst</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">dst_maxburst</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">dev_addr_rx</span> <span class="o">=</span>
			<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">dev_rx</span><span class="p">[</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">src_dev_type</span><span class="p">];</span>

		<span class="n">config_addr</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_addr_rx</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;channel has a pre-wired RX address %08x &quot;</span>
				<span class="s">&quot;overriding with %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev_addr_rx</span><span class="p">,</span> <span class="n">config_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">!=</span> <span class="n">STEDMA40_PERIPH_TO_MEM</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;channel was not configured for peripheral &quot;</span>
				<span class="s">&quot;to memory transfer (%d) overriding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">STEDMA40_PERIPH_TO_MEM</span><span class="p">;</span>

		<span class="cm">/* Configure the memory side */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst_addr_width</span> <span class="o">==</span> <span class="n">DMA_SLAVE_BUSWIDTH_UNDEFINED</span><span class="p">)</span>
			<span class="n">dst_addr_width</span> <span class="o">=</span> <span class="n">src_addr_width</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst_maxburst</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dst_maxburst</span> <span class="o">=</span> <span class="n">src_maxburst</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">dev_addr_tx</span> <span class="o">=</span>
			<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">dev_tx</span><span class="p">[</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dst_dev_type</span><span class="p">];</span>

		<span class="n">config_addr</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_addr_tx</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;channel has a pre-wired TX address %08x &quot;</span>
				<span class="s">&quot;overriding with %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev_addr_tx</span><span class="p">,</span> <span class="n">config_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">!=</span> <span class="n">STEDMA40_MEM_TO_PERIPH</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;channel was not configured for memory &quot;</span>
				<span class="s">&quot;to peripheral transfer (%d) overriding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">STEDMA40_MEM_TO_PERIPH</span><span class="p">;</span>

		<span class="cm">/* Configure the memory side */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">src_addr_width</span> <span class="o">==</span> <span class="n">DMA_SLAVE_BUSWIDTH_UNDEFINED</span><span class="p">)</span>
			<span class="n">src_addr_width</span> <span class="o">=</span> <span class="n">dst_addr_width</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">src_maxburst</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">src_maxburst</span> <span class="o">=</span> <span class="n">dst_maxburst</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;unrecognized channel direction %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">src_maxburst</span> <span class="o">*</span> <span class="n">src_addr_width</span> <span class="o">!=</span> <span class="n">dst_maxburst</span> <span class="o">*</span> <span class="n">dst_addr_width</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;src/dst width/maxburst mismatch: %d*%d != %d*%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">src_maxburst</span><span class="p">,</span>
			<span class="n">src_addr_width</span><span class="p">,</span>
			<span class="n">dst_maxburst</span><span class="p">,</span>
			<span class="n">dst_addr_width</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma40_config_to_halfchannel</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">src_info</span><span class="p">,</span>
					  <span class="n">src_addr_width</span><span class="p">,</span>
					  <span class="n">src_maxburst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma40_config_to_halfchannel</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dst_info</span><span class="p">,</span>
					  <span class="n">dst_addr_width</span><span class="p">,</span>
					  <span class="n">dst_maxburst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Fill in register values */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan_is_logical</span><span class="p">(</span><span class="n">d40c</span><span class="p">))</span>
		<span class="n">d40_log_cfg</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">log_def</span><span class="p">.</span><span class="n">lcsp1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">log_def</span><span class="p">.</span><span class="n">lcsp3</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">d40_phy_cfg</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">src_def_cfg</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">dst_def_cfg</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* These settings will take precedence later */</span>
	<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">runtime_addr</span> <span class="o">=</span> <span class="n">config_addr</span><span class="p">;</span>
	<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">runtime_direction</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;configured channel %s for %s, data width %d/%d, &quot;</span>
		<span class="s">&quot;maxburst %d/%d elements, LE, no flow control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dma_chan_name</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span>
		<span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RX&quot;</span> <span class="o">:</span> <span class="s">&quot;TX&quot;</span><span class="p">,</span>
		<span class="n">src_addr_width</span><span class="p">,</span> <span class="n">dst_addr_width</span><span class="p">,</span>
		<span class="n">src_maxburst</span><span class="p">,</span> <span class="n">dst_maxburst</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">d40_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_ctrl_cmd</span> <span class="n">cmd</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">d40_chan</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">phy_chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan_err</span><span class="p">(</span><span class="n">d40c</span><span class="p">,</span> <span class="s">&quot;Channel is not allocated!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMA_TERMINATE_ALL</span>:
		<span class="n">d40_terminate_all</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_PAUSE</span>:
		<span class="k">return</span> <span class="n">d40_pause</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">DMA_RESUME</span>:
		<span class="k">return</span> <span class="n">d40_resume</span><span class="p">(</span><span class="n">d40c</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">DMA_SLAVE_CONFIG</span>:
		<span class="k">return</span> <span class="n">d40_set_runtime_config</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">dma_slave_config</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Other commands are unimplemented */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialization functions */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">d40_chan_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_base</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_device</span> <span class="o">*</span><span class="n">dma</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">chans</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">num_chans</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="n">d40c</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">num_chans</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d40c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chans</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
		<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>

		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">d40c</span><span class="o">-&gt;</span><span class="n">log_num</span> <span class="o">=</span> <span class="n">D40_PHY_CHAN</span><span class="p">;</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">pending_queue</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">prepare_queue</span><span class="p">);</span>

		<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">,</span> <span class="n">dma_tasklet</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">d40c</span><span class="p">);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40c</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device_node</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">d40_ops_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_base</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">device_prep_slave_sg</span> <span class="o">=</span> <span class="n">d40_prep_slave_sg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">device_prep_dma_memcpy</span> <span class="o">=</span> <span class="n">d40_prep_memcpy</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * This controller can only access address at even</span>
<span class="cm">		 * 32bit boundaries, i.e. 2^2</span>
<span class="cm">		 */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">copy_align</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_SG</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">device_prep_dma_sg</span> <span class="o">=</span> <span class="n">d40_prep_memcpy_sg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_CYCLIC</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">device_prep_dma_cyclic</span> <span class="o">=</span> <span class="n">dma40_prep_dma_cyclic</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">device_alloc_chan_resources</span> <span class="o">=</span> <span class="n">d40_alloc_chan_resources</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">device_free_chan_resources</span> <span class="o">=</span> <span class="n">d40_free_chan_resources</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">device_issue_pending</span> <span class="o">=</span> <span class="n">d40_issue_pending</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">device_tx_status</span> <span class="o">=</span> <span class="n">d40_tx_status</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">device_control</span> <span class="o">=</span> <span class="n">d40_control</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">d40_dmaengine_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_base</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">num_reserved_chans</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="p">;</span>

	<span class="n">d40_chan_init</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_slave</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">log_chans</span><span class="p">,</span>
		      <span class="mi">0</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">num_log_chans</span><span class="p">);</span>

	<span class="n">dma_cap_zero</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_slave</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_slave</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_CYCLIC</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_slave</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>

	<span class="n">d40_ops_init</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_slave</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">dma_async_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_slave</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d40_err</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to register slave channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failure1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">d40_chan_init</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_memcpy</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">log_chans</span><span class="p">,</span>
		      <span class="n">base</span><span class="o">-&gt;</span><span class="n">num_log_chans</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">memcpy_len</span><span class="p">);</span>

	<span class="n">dma_cap_zero</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_memcpy</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_memcpy</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SG</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_memcpy</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>

	<span class="n">d40_ops_init</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_memcpy</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">dma_async_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_memcpy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d40_err</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to regsiter memcpy only channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failure2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">d40_chan_init</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_both</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_chans</span><span class="p">,</span>
		      <span class="mi">0</span><span class="p">,</span> <span class="n">num_reserved_chans</span><span class="p">);</span>

	<span class="n">dma_cap_zero</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_both</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_both</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_both</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SG</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_both</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_CYCLIC</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_slave</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>

	<span class="n">d40_ops_init</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_both</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">dma_async_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_both</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d40_err</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to register logical and physical capable channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failure3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">failure3:</span>
	<span class="n">dma_async_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_memcpy</span><span class="p">);</span>
<span class="nl">failure2:</span>
	<span class="n">dma_async_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dma_slave</span><span class="p">);</span>
<span class="nl">failure1:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Suspend resume functionality */</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma40_pm_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">d40_base</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pm_runtime_suspended</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcpa_regulator</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_disable</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcpa_regulator</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma40_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">d40_base</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">d40_save_restore_registers</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t disable/enable clocks for v1 due to HW bugs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">gcc_pwr_off_mask</span><span class="p">,</span>
			       <span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_GCC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma40_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">d40_base</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span>
		<span class="n">d40_save_restore_registers</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">writel_relaxed</span><span class="p">(</span><span class="n">D40_DREG_GCC_ENABLE_ALL</span><span class="p">,</span>
		       <span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_GCC</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma40_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">d40_base</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcpa_regulator</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_enable</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcpa_regulator</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">dma40_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>		<span class="o">=</span> <span class="n">dma40_pm_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_suspend</span>	<span class="o">=</span> <span class="n">dma40_runtime_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_resume</span>		<span class="o">=</span> <span class="n">dma40_runtime_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>			<span class="o">=</span> <span class="n">dma40_resume</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#define DMA40_PM_OPS	(&amp;dma40_pm_ops)</span>
<span class="cp">#else</span>
<span class="cp">#define DMA40_PM_OPS	NULL</span>
<span class="cp">#endif</span>

<span class="cm">/* Initialization functions. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">d40_phy_res_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_base</span> <span class="o">*</span><span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_phy_chans_avail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">odd_even_bit</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gcc</span> <span class="o">=</span> <span class="n">D40_DREG_GCC_ENA</span><span class="p">;</span>

	<span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_PRSME</span><span class="p">);</span>
	<span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_PRSMO</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">num_phy_chans</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">odd_even_bit</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">val</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">odd_even_bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Mark security only channels as occupied */</span>
			<span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">allocated_src</span> <span class="o">=</span> <span class="n">D40_ALLOC_PHY</span><span class="p">;</span>
			<span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">allocated_dst</span> <span class="o">=</span> <span class="n">D40_ALLOC_PHY</span><span class="p">;</span>
			<span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reserved</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">gcc</span> <span class="o">|=</span> <span class="n">D40_DREG_GCC_EVTGRP_ENA</span><span class="p">(</span><span class="n">D40_PHYS_TO_GROUP</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
						       <span class="n">D40_DREG_GCC_SRC</span><span class="p">);</span>
			<span class="n">gcc</span> <span class="o">|=</span> <span class="n">D40_DREG_GCC_EVTGRP_ENA</span><span class="p">(</span><span class="n">D40_PHYS_TO_GROUP</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
						       <span class="n">D40_DREG_GCC_DST</span><span class="p">);</span>


		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">allocated_src</span> <span class="o">=</span> <span class="n">D40_ALLOC_FREE</span><span class="p">;</span>
			<span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">allocated_dst</span> <span class="o">=</span> <span class="n">D40_ALLOC_FREE</span><span class="p">;</span>
			<span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reserved</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">num_phy_chans_avail</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Mark disabled channels as occupied */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">disabled_channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">disabled_channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_res</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">allocated_src</span> <span class="o">=</span> <span class="n">D40_ALLOC_PHY</span><span class="p">;</span>
		<span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_res</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">allocated_dst</span> <span class="o">=</span> <span class="n">D40_ALLOC_PHY</span><span class="p">;</span>
		<span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_res</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">reserved</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">gcc</span> <span class="o">|=</span> <span class="n">D40_DREG_GCC_EVTGRP_ENA</span><span class="p">(</span><span class="n">D40_PHYS_TO_GROUP</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span>
					       <span class="n">D40_DREG_GCC_SRC</span><span class="p">);</span>
		<span class="n">gcc</span> <span class="o">|=</span> <span class="n">D40_DREG_GCC_EVTGRP_ENA</span><span class="p">(</span><span class="n">D40_PHYS_TO_GROUP</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span>
					       <span class="n">D40_DREG_GCC_DST</span><span class="p">);</span>
		<span class="n">num_phy_chans_avail</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d of %d physical DMA channels available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">num_phy_chans_avail</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">num_phy_chans</span><span class="p">);</span>

	<span class="cm">/* Verify settings extended vs standard */</span>
	<span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_PRTYP</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">num_phy_chans</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">allocated_src</span> <span class="o">==</span> <span class="n">D40_ALLOC_FREE</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;[%s] INFO: channel %d is misconfigured (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>

		<span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * To keep things simple, Enable all clocks initially.</span>
<span class="cm">	 * The clocks will get managed later post channel allocation.</span>
<span class="cm">	 * The clocks for the event lines on which reserved channels exists</span>
<span class="cm">	 * are not managed here.</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">D40_DREG_GCC_ENABLE_ALL</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_GCC</span><span class="p">);</span>
	<span class="n">base</span><span class="o">-&gt;</span><span class="n">gcc_pwr_off_mask</span> <span class="o">=</span> <span class="n">gcc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">num_phy_chans_avail</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">d40_base</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">d40_hw_detect_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stedma40_platform_data</span> <span class="o">*</span><span class="n">plat_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">virtbase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_base</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_log_chans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_phy_chans</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rev</span><span class="p">;</span>

	<span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">d40_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No matching clock found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>

	<span class="cm">/* Get IO for DMAC base address */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="s">&quot;base&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
			       <span class="n">D40_NAME</span> <span class="s">&quot; I/O base&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="n">virtbase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">virtbase</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="cm">/* This is just a regular AMBA PrimeCell ID actually */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pid</span> <span class="o">|=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x20</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cid</span> <span class="o">|=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x10</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cid</span> <span class="o">!=</span> <span class="n">AMBA_CID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d40_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown hardware! No PrimeCell ID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AMBA_MANF_BITS</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="o">!=</span> <span class="n">AMBA_VENDOR_ST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d40_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown designer! Got %x wanted %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">AMBA_MANF_BITS</span><span class="p">(</span><span class="n">pid</span><span class="p">),</span>
			<span class="n">AMBA_VENDOR_ST</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * HW revision:</span>
<span class="cm">	 * DB8500ed has revision 0</span>
<span class="cm">	 * ? has revision 1</span>
<span class="cm">	 * DB8500v1 has revision 2</span>
<span class="cm">	 * DB8500v2 has revision 3</span>
<span class="cm">	 */</span>
	<span class="n">rev</span> <span class="o">=</span> <span class="n">AMBA_REV_BITS</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>

	<span class="cm">/* The number of physical channels on this HW */</span>
	<span class="n">num_phy_chans</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_ICFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;hardware revision: %d @ 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">rev</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d40_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;hardware revision: %d is not supported&quot;</span><span class="p">,</span>
			<span class="n">rev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">plat_data</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="cm">/* Count the number of logical channels in use */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">dev_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">dev_rx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">num_log_chans</span><span class="o">++</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">dev_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">dev_tx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">num_log_chans</span><span class="o">++</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_base</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
		       <span class="p">(</span><span class="n">num_phy_chans</span> <span class="o">+</span> <span class="n">num_log_chans</span> <span class="o">+</span> <span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">memcpy_len</span><span class="p">)</span> <span class="o">*</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d40_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">base</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="n">rev</span><span class="p">;</span>
	<span class="n">base</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk</span><span class="p">;</span>
	<span class="n">base</span><span class="o">-&gt;</span><span class="n">num_phy_chans</span> <span class="o">=</span> <span class="n">num_phy_chans</span><span class="p">;</span>
	<span class="n">base</span><span class="o">-&gt;</span><span class="n">num_log_chans</span> <span class="o">=</span> <span class="n">num_log_chans</span><span class="p">;</span>
	<span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_start</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">=</span> <span class="n">virtbase</span><span class="p">;</span>
	<span class="n">base</span><span class="o">-&gt;</span><span class="n">plat_data</span> <span class="o">=</span> <span class="n">plat_data</span><span class="p">;</span>
	<span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_chans</span> <span class="o">=</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">base</span><span class="p">)</span> <span class="o">+</span> <span class="n">ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_base</span><span class="p">),</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">base</span><span class="o">-&gt;</span><span class="n">log_chans</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_chans</span><span class="p">[</span><span class="n">num_phy_chans</span><span class="p">];</span>

	<span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_res</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">num_phy_chans</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_phy_res</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="n">base</span><span class="o">-&gt;</span><span class="n">lookup_phy_chans</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">num_phy_chans</span> <span class="o">*</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="p">),</span>
					 <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lookup_phy_chans</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_log_chans</span> <span class="o">+</span> <span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">memcpy_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The max number of logical channels are event lines for all</span>
<span class="cm">		 * src devices and dst devices</span>
<span class="cm">		 */</span>
		<span class="n">base</span><span class="o">-&gt;</span><span class="n">lookup_log_chans</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">dev_len</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span>
						 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_chan</span> <span class="o">*</span><span class="p">),</span>
						 <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lookup_log_chans</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">base</span><span class="o">-&gt;</span><span class="n">reg_val_backup_chan</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">num_phy_chans</span> <span class="o">*</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="n">d40_backup_regs_chan</span><span class="p">),</span>
					    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">reg_val_backup_chan</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">alloc_map</span> <span class="o">=</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="n">num_phy_chans</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_desc</span> <span class="o">*</span><span class="p">)</span>
			<span class="o">*</span> <span class="n">D40_LCLA_LINK_PER_EVENT_GRP</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">alloc_map</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="n">base</span><span class="o">-&gt;</span><span class="n">desc_slab</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="n">D40_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_desc</span><span class="p">),</span>
					    <span class="mi">0</span><span class="p">,</span> <span class="n">SLAB_HWCACHE_ALIGN</span><span class="p">,</span>
					    <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">desc_slab</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">base</span><span class="p">;</span>

<span class="nl">failure:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">virtbase</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">virtbase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
				   <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">virtbase</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">virtbase</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">alloc_map</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">reg_val_backup_chan</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lookup_log_chans</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lookup_phy_chans</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_res</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">d40_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_base</span> <span class="o">*</span><span class="n">base</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">static</span> <span class="k">struct</span> <span class="n">d40_reg_val</span> <span class="n">dma_init_reg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Clock every part of the DMA block from start */</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">D40_DREG_GCC</span><span class="p">,</span>    <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">D40_DREG_GCC_ENABLE_ALL</span><span class="p">},</span>

		<span class="cm">/* Interrupts on all logical channels */</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">D40_DREG_LCMIS0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">D40_DREG_LCMIS1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">D40_DREG_LCMIS2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">D40_DREG_LCMIS3</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">D40_DREG_LCICR0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">D40_DREG_LCICR1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">D40_DREG_LCICR2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">D40_DREG_LCICR3</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">D40_DREG_LCTIS0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">D40_DREG_LCTIS1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">D40_DREG_LCTIS2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">D40_DREG_LCTIS3</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prmseo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="n">u32</span> <span class="n">activeo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">};</span>
	<span class="n">u32</span> <span class="n">pcmis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pcicr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dma_init_reg</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">dma_init_reg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span><span class="p">,</span>
		       <span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">dma_init_reg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Configure all our dma channels to default settings */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">num_phy_chans</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">activeo</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">activeo</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_res</span><span class="p">[</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">num_phy_chans</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">allocated_src</span>
		    <span class="o">==</span> <span class="n">D40_ALLOC_PHY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">activeo</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Enable interrupt # */</span>
		<span class="n">pcmis</span> <span class="o">=</span> <span class="p">(</span><span class="n">pcmis</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Clear interrupt # */</span>
		<span class="n">pcicr</span> <span class="o">=</span> <span class="p">(</span><span class="n">pcicr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Set channel to physical mode */</span>
		<span class="n">prmseo</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">prmseo</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">prmseo</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">prmseo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_PRMSE</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">prmseo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_PRMSO</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">activeo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_ACTIVE</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">activeo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_ACTIVO</span><span class="p">);</span>

	<span class="cm">/* Write which interrupt to enable */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pcmis</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_PCMIS</span><span class="p">);</span>

	<span class="cm">/* Write which interrupt to clear */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pcicr</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_PCICR</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">d40_lcla_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">d40_base</span> <span class="o">*</span><span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">d40_lcla_pool</span> <span class="o">*</span><span class="n">pool</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">page_list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is somewhat ugly. We need 8192 bytes that are 18 bit aligned,</span>
<span class="cm">	 * To full fill this hardware requirement without wasting 256 kb</span>
<span class="cm">	 * we allocate pages until we get an aligned one.</span>
<span class="cm">	 */</span>
	<span class="n">page_list</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_LCLA_ALLOC_ATTEMPTS</span><span class="p">,</span>
			    <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Calculating how many pages that are required */</span>
	<span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">pages</span> <span class="o">=</span> <span class="n">SZ_1K</span> <span class="o">*</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">num_phy_chans</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LCLA_ALLOC_ATTEMPTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">__get_free_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span>
						<span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">pages</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>

			<span class="n">d40_err</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate %d pages.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">pages</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">free_pages</span><span class="p">(</span><span class="n">page_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">pages</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">virt_to_phys</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">page_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span>
		     <span class="p">(</span><span class="n">LCLA_ALIGNMENT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">free_pages</span><span class="p">(</span><span class="n">page_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">pages</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LCLA_ALLOC_ATTEMPTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">page_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * After many attempts and no succees with finding the correct</span>
<span class="cm">		 * alignment, try with allocating a big buffer.</span>
<span class="cm">		 */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;[%s] Failed to get %d pages @ 18 bit align.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">pages</span><span class="p">);</span>
		<span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">base_unaligned</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">SZ_1K</span> <span class="o">*</span>
							 <span class="n">base</span><span class="o">-&gt;</span><span class="n">num_phy_chans</span> <span class="o">+</span>
							 <span class="n">LCLA_ALIGNMENT</span><span class="p">,</span>
							 <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">base_unaligned</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">PTR_ALIGN</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">base_unaligned</span><span class="p">,</span>
						 <span class="n">LCLA_ALIGNMENT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pool</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
					<span class="n">SZ_1K</span> <span class="o">*</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">num_phy_chans</span><span class="p">,</span>
					<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pool</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">base</span><span class="p">),</span>
	       <span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_LCLA</span><span class="p">);</span>
<span class="nl">failure:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">page_list</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">d40_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">d40_base</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_reserved_chans</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">d40_hw_detect_init</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="n">num_reserved_chans</span> <span class="o">=</span> <span class="n">d40_phy_res_init</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">interrupt_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">execmd_lock</span><span class="p">);</span>

	<span class="cm">/* Get IO for logical channel parameter address */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="s">&quot;lcpa&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="n">d40_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No </span><span class="se">\&quot;</span><span class="s">lcpa</span><span class="se">\&quot;</span><span class="s"> memory resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">base</span><span class="o">-&gt;</span><span class="n">lcpa_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_lcpa</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
			       <span class="n">D40_NAME</span> <span class="s">&quot; I/O lcpa&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">d40_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to request LCPA region 0x%x-0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We make use of ESRAM memory for this. */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_LCPA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">!=</span> <span class="n">val</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;[%s] Mismatch LCPA dma 0x%x, def 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_LCPA</span><span class="p">);</span>

	<span class="n">base</span><span class="o">-&gt;</span><span class="n">lcpa_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcpa_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">d40_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to ioremap LCPA region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* If lcla has to be located in ESRAM we don&#39;t need to allocate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">use_esram_lcla</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
							<span class="s">&quot;lcla_esram&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
			<span class="n">d40_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;No </span><span class="se">\&quot;</span><span class="s">lcla_esram</span><span class="se">\&quot;</span><span class="s"> memory resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
						<span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">d40_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to ioremap LCLA region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span> <span class="o">+</span> <span class="n">D40_DREG_LCLA</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">d40_lcla_allocate</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d40_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate LCLA area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">base</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">d40_handle_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">D40_NAME</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d40_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No IRQ defined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_irq_safe</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_set_autosuspend_delay</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA40_AUTOSUSPEND_DELAY</span><span class="p">);</span>
	<span class="n">pm_runtime_use_autosuspend</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_resume</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">use_esram_lcla</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">base</span><span class="o">-&gt;</span><span class="n">lcpa_regulator</span> <span class="o">=</span> <span class="n">regulator_get</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;lcla_esram&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcpa_regulator</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">d40_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to get lcpa_regulator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">base</span><span class="o">-&gt;</span><span class="n">lcpa_regulator</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_enable</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcpa_regulator</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d40_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to enable lcpa_regulator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">regulator_put</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcpa_regulator</span><span class="p">);</span>
			<span class="n">base</span><span class="o">-&gt;</span><span class="n">lcpa_regulator</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">base</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">d40_dmaengine_init</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">num_reserved_chans</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>

	<span class="n">d40_hw_init</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failure:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">desc_slab</span><span class="p">)</span>
			<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">desc_slab</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">)</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">virtbase</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">base</span> <span class="o">&amp;&amp;</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">use_esram_lcla</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
			<span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">)</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">,</span>
					 <span class="n">SZ_1K</span> <span class="o">*</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">num_phy_chans</span><span class="p">,</span>
					 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">base_unaligned</span> <span class="o">&amp;&amp;</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">base</span><span class="p">)</span>
			<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">base</span><span class="p">,</span>
				   <span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">pages</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">base_unaligned</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_lcpa</span><span class="p">)</span>
			<span class="n">release_mem_region</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_lcpa</span><span class="p">,</span>
					   <span class="n">base</span><span class="o">-&gt;</span><span class="n">lcpa_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_start</span><span class="p">)</span>
			<span class="n">release_mem_region</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_start</span><span class="p">,</span>
					   <span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clk_disable</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
			<span class="n">clk_put</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcpa_regulator</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regulator_disable</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcpa_regulator</span><span class="p">);</span>
			<span class="n">regulator_put</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcpa_regulator</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lcla_pool</span><span class="p">.</span><span class="n">alloc_map</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lookup_log_chans</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lookup_phy_chans</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">phy_res</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">d40_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probe failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">d40_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="n">D40_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span> <span class="o">=</span> <span class="n">DMA40_PM_OPS</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">stedma40_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d40_driver</span><span class="p">,</span> <span class="n">d40_probe</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">stedma40_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
