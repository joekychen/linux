<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › dma › amba-pl08x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>amba-pl08x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2006 ARM Ltd.</span>
<span class="cm"> * Copyright (c) 2010 ST-Ericsson SA</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Peter Pearse &lt;peter.pearse@arm.com&gt;</span>
<span class="cm"> * Author: Linus Walleij &lt;linus.walleij@stericsson.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the Free</span>
<span class="cm"> * Software Foundation; either version 2 of the License, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc., 59</span>
<span class="cm"> * Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is in this distribution in the file</span>
<span class="cm"> * called COPYING.</span>
<span class="cm"> *</span>
<span class="cm"> * Documentation: ARM DDI 0196G == PL080</span>
<span class="cm"> * Documentation: ARM DDI 0218E == PL081</span>
<span class="cm"> *</span>
<span class="cm"> * PL080 &amp; PL081 both have 16 sets of DMA signals that can be routed to any</span>
<span class="cm"> * channel.</span>
<span class="cm"> *</span>
<span class="cm"> * The PL080 has 8 channels available for simultaneous use, and the PL081</span>
<span class="cm"> * has only two channels. So on these DMA controllers the number of channels</span>
<span class="cm"> * and the number of incoming DMA signals are two totally different things.</span>
<span class="cm"> * It is usually not possible to theoretically handle all physical signals,</span>
<span class="cm"> * so a multiplexing scheme with possible denial of use is necessary.</span>
<span class="cm"> *</span>
<span class="cm"> * The PL080 has a dual bus master, PL081 has a single master.</span>
<span class="cm"> *</span>
<span class="cm"> * Memory to peripheral transfer may be visualized as</span>
<span class="cm"> *	Get data from memory to DMAC</span>
<span class="cm"> *	Until no data left</span>
<span class="cm"> *		On burst request from peripheral</span>
<span class="cm"> *			Destination burst from DMAC to peripheral</span>
<span class="cm"> *			Clear burst request</span>
<span class="cm"> *	Raise terminal count interrupt</span>
<span class="cm"> *</span>
<span class="cm"> * For peripherals with a FIFO:</span>
<span class="cm"> * Source      burst size == half the depth of the peripheral FIFO</span>
<span class="cm"> * Destination burst size == the depth of the peripheral FIFO</span>
<span class="cm"> *</span>
<span class="cm"> * (Bursts are irrelevant for mem to mem transfers - there are no burst</span>
<span class="cm"> * signals, the DMA controller will simply facilitate its AHB master.)</span>
<span class="cm"> *</span>
<span class="cm"> * ASSUMES default (little) endianness for DMA transfers</span>
<span class="cm"> *</span>
<span class="cm"> * The PL08x has two flow control settings:</span>
<span class="cm"> *  - DMAC flow control: the transfer size defines the number of transfers</span>
<span class="cm"> *    which occur for the current LLI entry, and the DMAC raises TC at the</span>
<span class="cm"> *    end of every LLI entry.  Observed behaviour shows the DMAC listening</span>
<span class="cm"> *    to both the BREQ and SREQ signals (contrary to documented),</span>
<span class="cm"> *    transferring data if either is active.  The LBREQ and LSREQ signals</span>
<span class="cm"> *    are ignored.</span>
<span class="cm"> *</span>
<span class="cm"> *  - Peripheral flow control: the transfer size is ignored (and should be</span>
<span class="cm"> *    zero).  The data is transferred from the current LLI entry, until</span>
<span class="cm"> *    after the final transfer signalled by LBREQ or LSREQ.  The DMAC</span>
<span class="cm"> *    will then move to the next LLI entry.</span>
<span class="cm"> *</span>
<span class="cm"> * Global TODO:</span>
<span class="cm"> * - Break out common code from arch/arm/mach-s3c64xx and share</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/amba/bus.h&gt;</span>
<span class="cp">#include &lt;linux/amba/pl08x.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#include &lt;linux/dmapool.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/hardware/pl080.h&gt;</span>

<span class="cp">#include &quot;dmaengine.h&quot;</span>

<span class="cp">#define DRIVER_NAME	&quot;pl08xdmac&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">amba_driver</span> <span class="n">pl08x_amba_driver</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * struct vendor_data - vendor-specific config parameters for PL08x derivatives</span>
<span class="cm"> * @channels: the number of channels available in this variant</span>
<span class="cm"> * @dualmaster: whether this version supports dual AHB masters or not.</span>
<span class="cm"> * @nomadik: whether the channels have Nomadik security extension bits</span>
<span class="cm"> *	that need to be checked for permission before use and some registers are</span>
<span class="cm"> *	missing</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">vendor_data</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">channels</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">dualmaster</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">nomadik</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * PL08X private data structures</span>
<span class="cm"> * An LLI struct - see PL08x TRM.  Note that next uses bit[0] as a bus bit,</span>
<span class="cm"> * start &amp; end do not - their bus bit info is in cctl.  Also note that these</span>
<span class="cm"> * are fixed 32-bit quantities.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pl08x_lli</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">src</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dst</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lli</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cctl</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct pl08x_driver_data - the local state holder for the PL08x</span>
<span class="cm"> * @slave: slave engine for this instance</span>
<span class="cm"> * @memcpy: memcpy engine for this instance</span>
<span class="cm"> * @base: virtual memory base (remapped) for the PL08x</span>
<span class="cm"> * @adev: the corresponding AMBA (PrimeCell) bus entry</span>
<span class="cm"> * @vd: vendor data for this PL08x variant</span>
<span class="cm"> * @pd: platform data passed in from the platform/machine</span>
<span class="cm"> * @phy_chans: array of data for the physical channels</span>
<span class="cm"> * @pool: a pool for the LLI descriptors</span>
<span class="cm"> * @pool_ctr: counter of LLIs in the pool</span>
<span class="cm"> * @lli_buses: bitmask to or in to LLI pointer selecting AHB port for LLI</span>
<span class="cm"> * fetches</span>
<span class="cm"> * @mem_buses: set to indicate memory transfers on AHB2.</span>
<span class="cm"> * @lock: a spinlock for this struct</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_device</span> <span class="n">slave</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_device</span> <span class="n">memcpy</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amba_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">vendor_data</span> <span class="o">*</span><span class="n">vd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_platform_data</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_phy_chan</span> <span class="o">*</span><span class="n">phy_chans</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_pool</span> <span class="o">*</span><span class="n">pool</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pool_ctr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lli_buses</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mem_buses</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * PL08X specific defines</span>
<span class="cm"> */</span>

<span class="cm">/* Size (bytes) of each LLI buffer allocated for one transfer */</span>
<span class="cp"># define PL08X_LLI_TSFR_SIZE	0x2000</span>

<span class="cm">/* Maximum times we call dma_pool_alloc on this pool without freeing */</span>
<span class="cp">#define MAX_NUM_TSFR_LLIS	(PL08X_LLI_TSFR_SIZE/sizeof(struct pl08x_lli))</span>
<span class="cp">#define PL08X_ALIGN		8</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="nf">to_pl08x_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pl08x_dma_chan</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="nf">to_pl08x_txd</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pl08x_txd</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Physical channel handling</span>
<span class="cm"> */</span>

<span class="cm">/* Whether a certain channel is busy or not */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl08x_phy_channel_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_phy_chan</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_CH_CONFIG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">PL080_CONFIG_ACTIVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the initial DMA register values i.e. those for the first LLI</span>
<span class="cm"> * The next LLI pointer and the configuration interrupt bit have</span>
<span class="cm"> * been set when the LLIs were constructed.  Poke them into the hardware</span>
<span class="cm"> * and start the transfer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl08x_start_txd</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">plchan</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="n">txd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span> <span class="o">=</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_phy_chan</span> <span class="o">*</span><span class="n">phychan</span> <span class="o">=</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">phychan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_lli</span> <span class="o">*</span><span class="n">lli</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">llis_va</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">at</span> <span class="o">=</span> <span class="n">txd</span><span class="p">;</span>

	<span class="cm">/* Wait for channel inactive */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pl08x_phy_channel_busy</span><span class="p">(</span><span class="n">phychan</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;WRITE channel %d: csrc=0x%08x, cdst=0x%08x, &quot;</span>
		<span class="s">&quot;clli=0x%08x, cctl=0x%08x, ccfg=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">phychan</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">lli</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">lli</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">lli</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">,</span> <span class="n">lli</span><span class="o">-&gt;</span><span class="n">cctl</span><span class="p">,</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">ccfg</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">lli</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">phychan</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_CH_SRC_ADDR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">lli</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">phychan</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_CH_DST_ADDR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">lli</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">,</span> <span class="n">phychan</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_CH_LLI</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">lli</span><span class="o">-&gt;</span><span class="n">cctl</span><span class="p">,</span> <span class="n">phychan</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_CH_CONTROL</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">ccfg</span><span class="p">,</span> <span class="n">phychan</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_CH_CONFIG</span><span class="p">);</span>

	<span class="cm">/* Enable the DMA channel */</span>
	<span class="cm">/* Do not access config register until channel shows as disabled */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_EN_CHAN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">phychan</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="cm">/* Do not access config register until channel shows as inactive */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">phychan</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_CH_CONFIG</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PL080_CONFIG_ACTIVE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PL080_CONFIG_ENABLE</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">phychan</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_CH_CONFIG</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">PL080_CONFIG_ENABLE</span><span class="p">,</span> <span class="n">phychan</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_CH_CONFIG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Pause the channel by setting the HALT bit.</span>
<span class="cm"> *</span>
<span class="cm"> * For M-&gt;P transfers, pause the DMAC first and then stop the peripheral -</span>
<span class="cm"> * the FIFO can only drain if the peripheral is still requesting data.</span>
<span class="cm"> * (note: this can still timeout if the DMAC FIFO never drains of data.)</span>
<span class="cm"> *</span>
<span class="cm"> * For P-&gt;M transfers, disable the peripheral first to stop it filling</span>
<span class="cm"> * the DMAC FIFO, and then pause the DMAC.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl08x_pause_phy_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_phy_chan</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="cm">/* Set the HALT bit and wait for the FIFO to drain */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_CH_CONFIG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">PL080_CONFIG_HALT</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_CH_CONFIG</span><span class="p">);</span>

	<span class="cm">/* Wait for channel inactive */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pl08x_phy_channel_busy</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pl08x_phy_channel_busy</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;pl08x: channel%u timeout waiting for pause</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl08x_resume_phy_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_phy_chan</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Clear the HALT bit */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_CH_CONFIG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PL080_CONFIG_HALT</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_CH_CONFIG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pl08x_terminate_phy_chan() stops the channel, clears the FIFO and</span>
<span class="cm"> * clears any pending interrupt status.  This should not be used for</span>
<span class="cm"> * an on-going transfer, but as a method of shutting down a channel</span>
<span class="cm"> * (eg, when it&#39;s no longer used) or terminating a transfer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl08x_terminate_phy_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pl08x_phy_chan</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_CH_CONFIG</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PL080_CONFIG_ENABLE</span> <span class="o">|</span> <span class="n">PL080_CONFIG_ERR_IRQ_MASK</span> <span class="o">|</span>
	         <span class="n">PL080_CONFIG_TC_IRQ_MASK</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_CH_CONFIG</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_ERR_CLEAR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_TC_CLEAR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">get_bytes_in_cctl</span><span class="p">(</span><span class="n">u32</span> <span class="n">cctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The source width defines the number of bytes */</span>
	<span class="n">u32</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">cctl</span> <span class="o">&amp;</span> <span class="n">PL080_CONTROL_TRANSFER_SIZE_MASK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cctl</span> <span class="o">&gt;&gt;</span> <span class="n">PL080_CONTROL_SWIDTH_SHIFT</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PL080_WIDTH_8BIT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PL080_WIDTH_16BIT</span>:
		<span class="n">bytes</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PL080_WIDTH_32BIT</span>:
		<span class="n">bytes</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">bytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The channel should be paused when calling this */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">pl08x_getbytes_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">plchan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_phy_chan</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="n">txd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">phychan</span><span class="p">;</span>
	<span class="n">txd</span> <span class="o">=</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Follow the LLIs to get the number of remaining</span>
<span class="cm">	 * bytes in the currently active transaction.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&amp;&amp;</span> <span class="n">txd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">clli</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_CH_LLI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PL080_LLI_LM_AHB2</span><span class="p">;</span>

		<span class="cm">/* First get the remaining bytes in the active transfer */</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">get_bytes_in_cctl</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_CH_CONTROL</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clli</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">pl08x_lli</span> <span class="o">*</span><span class="n">llis_va</span> <span class="o">=</span> <span class="n">txd</span><span class="o">-&gt;</span><span class="n">llis_va</span><span class="p">;</span>
			<span class="n">dma_addr_t</span> <span class="n">llis_bus</span> <span class="o">=</span> <span class="n">txd</span><span class="o">-&gt;</span><span class="n">llis_bus</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">clli</span> <span class="o">&lt;</span> <span class="n">llis_bus</span> <span class="o">||</span> <span class="n">clli</span> <span class="o">&gt;=</span> <span class="n">llis_bus</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_lli</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_NUM_TSFR_LLIS</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Locate the next LLI - as this is an array,</span>
<span class="cm">			 * it&#39;s simple maths to find.</span>
<span class="cm">			 */</span>
			<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">clli</span> <span class="o">-</span> <span class="n">llis_bus</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_lli</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">MAX_NUM_TSFR_LLIS</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bytes</span> <span class="o">+=</span> <span class="n">get_bytes_in_cctl</span><span class="p">(</span><span class="n">llis_va</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">cctl</span><span class="p">);</span>

				<span class="cm">/*</span>
<span class="cm">				 * A LLI pointer of 0 terminates the LLI list</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">llis_va</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">lli</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Sum up all queued transactions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">pend_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="n">txdi</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">txdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">pend_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">pl08x_sg</span> <span class="o">*</span><span class="n">dsg</span><span class="p">;</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dsg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">dsg_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
				<span class="n">bytes</span> <span class="o">+=</span> <span class="n">dsg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate a physical channel for a virtual channel</span>
<span class="cm"> *</span>
<span class="cm"> * Try to locate a physical channel to be used for this transfer. If all</span>
<span class="cm"> * are taken return NULL and the requester will have to cope by using</span>
<span class="cm"> * some fallback PIO mode or retrying later.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pl08x_phy_chan</span> <span class="o">*</span>
<span class="nf">pl08x_get_phy_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">virt_chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_phy_chan</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">vd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">phy_chans</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">serving</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">serving</span> <span class="o">=</span> <span class="n">virt_chan</span><span class="p">;</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">vd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No physical channel available, cope with it */</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ch</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pl08x_put_phy_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">pl08x_phy_chan</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Stop the channel and clear its interrupts */</span>
	<span class="n">pl08x_terminate_phy_chan</span><span class="p">(</span><span class="n">pl08x</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>

	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Mark it as free */</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">serving</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * LLI handling</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pl08x_get_bytes_for_cctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">coded</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">coded</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PL080_WIDTH_8BIT</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PL080_WIDTH_16BIT</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PL080_WIDTH_32BIT</span>:
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">pl08x_cctl_bits</span><span class="p">(</span><span class="n">u32</span> <span class="n">cctl</span><span class="p">,</span> <span class="n">u8</span> <span class="n">srcwidth</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dstwidth</span><span class="p">,</span>
				  <span class="kt">size_t</span> <span class="n">tsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">retbits</span> <span class="o">=</span> <span class="n">cctl</span><span class="p">;</span>

	<span class="cm">/* Remove all src, dst and transfer size bits */</span>
	<span class="n">retbits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PL080_CONTROL_DWIDTH_MASK</span><span class="p">;</span>
	<span class="n">retbits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PL080_CONTROL_SWIDTH_MASK</span><span class="p">;</span>
	<span class="n">retbits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PL080_CONTROL_TRANSFER_SIZE_MASK</span><span class="p">;</span>

	<span class="cm">/* Then set the bits according to the parameters */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">srcwidth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">retbits</span> <span class="o">|=</span> <span class="n">PL080_WIDTH_8BIT</span> <span class="o">&lt;&lt;</span> <span class="n">PL080_CONTROL_SWIDTH_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">retbits</span> <span class="o">|=</span> <span class="n">PL080_WIDTH_16BIT</span> <span class="o">&lt;&lt;</span> <span class="n">PL080_CONTROL_SWIDTH_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">retbits</span> <span class="o">|=</span> <span class="n">PL080_WIDTH_32BIT</span> <span class="o">&lt;&lt;</span> <span class="n">PL080_CONTROL_SWIDTH_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dstwidth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">retbits</span> <span class="o">|=</span> <span class="n">PL080_WIDTH_8BIT</span> <span class="o">&lt;&lt;</span> <span class="n">PL080_CONTROL_DWIDTH_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">retbits</span> <span class="o">|=</span> <span class="n">PL080_WIDTH_16BIT</span> <span class="o">&lt;&lt;</span> <span class="n">PL080_CONTROL_DWIDTH_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">retbits</span> <span class="o">|=</span> <span class="n">PL080_WIDTH_32BIT</span> <span class="o">&lt;&lt;</span> <span class="n">PL080_CONTROL_DWIDTH_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retbits</span> <span class="o">|=</span> <span class="n">tsize</span> <span class="o">&lt;&lt;</span> <span class="n">PL080_CONTROL_TRANSFER_SIZE_SHIFT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retbits</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">pl08x_lli_build_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="n">txd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_bus_data</span> <span class="n">srcbus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_bus_data</span> <span class="n">dstbus</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">remainder</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lli_bus</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Autoselect a master bus to use for the transfer. Slave will be the chosen as</span>
<span class="cm"> * victim in case src &amp; dest are not similarly aligned. i.e. If after aligning</span>
<span class="cm"> * masters address with width requirements of transfer (by sending few byte by</span>
<span class="cm"> * byte data), slave is still not aligned, then its width will be reduced to</span>
<span class="cm"> * BYTE.</span>
<span class="cm"> * - prefers the destination bus if both available</span>
<span class="cm"> * - prefers bus with fixed address (i.e. peripheral)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl08x_choose_master_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_lli_build_data</span> <span class="o">*</span><span class="n">bd</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pl08x_bus_data</span> <span class="o">**</span><span class="n">mbus</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pl08x_bus_data</span> <span class="o">**</span><span class="n">sbus</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cctl</span> <span class="o">&amp;</span> <span class="n">PL080_CONTROL_DST_INCR</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">mbus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">dstbus</span><span class="p">;</span>
		<span class="o">*</span><span class="n">sbus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">srcbus</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cctl</span> <span class="o">&amp;</span> <span class="n">PL080_CONTROL_SRC_INCR</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">mbus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">srcbus</span><span class="p">;</span>
		<span class="o">*</span><span class="n">sbus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">dstbus</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">dstbus</span><span class="p">.</span><span class="n">buswidth</span> <span class="o">&gt;=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">srcbus</span><span class="p">.</span><span class="n">buswidth</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">mbus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">dstbus</span><span class="p">;</span>
			<span class="o">*</span><span class="n">sbus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">srcbus</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">mbus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">srcbus</span><span class="p">;</span>
			<span class="o">*</span><span class="n">sbus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">dstbus</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fills in one LLI for a certain transfer descriptor and advance the counter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl08x_fill_lli_for_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_lli_build_data</span> <span class="o">*</span><span class="n">bd</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">num_llis</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_lli</span> <span class="o">*</span><span class="n">llis_va</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">llis_va</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">llis_bus</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">llis_bus</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">num_llis</span> <span class="o">&gt;=</span> <span class="n">MAX_NUM_TSFR_LLIS</span><span class="p">);</span>

	<span class="n">llis_va</span><span class="p">[</span><span class="n">num_llis</span><span class="p">].</span><span class="n">cctl</span> <span class="o">=</span> <span class="n">cctl</span><span class="p">;</span>
	<span class="n">llis_va</span><span class="p">[</span><span class="n">num_llis</span><span class="p">].</span><span class="n">src</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">srcbus</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">llis_va</span><span class="p">[</span><span class="n">num_llis</span><span class="p">].</span><span class="n">dst</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">dstbus</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">llis_va</span><span class="p">[</span><span class="n">num_llis</span><span class="p">].</span><span class="n">lli</span> <span class="o">=</span> <span class="n">llis_bus</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_llis</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_lli</span><span class="p">);</span>
	<span class="n">llis_va</span><span class="p">[</span><span class="n">num_llis</span><span class="p">].</span><span class="n">lli</span> <span class="o">|=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">lli_bus</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cctl</span> <span class="o">&amp;</span> <span class="n">PL080_CONTROL_SRC_INCR</span><span class="p">)</span>
		<span class="n">bd</span><span class="o">-&gt;</span><span class="n">srcbus</span><span class="p">.</span><span class="n">addr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cctl</span> <span class="o">&amp;</span> <span class="n">PL080_CONTROL_DST_INCR</span><span class="p">)</span>
		<span class="n">bd</span><span class="o">-&gt;</span><span class="n">dstbus</span><span class="p">.</span><span class="n">addr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">remainder</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">bd</span><span class="o">-&gt;</span><span class="n">remainder</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">prep_byte_width_lli</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_lli_build_data</span> <span class="o">*</span><span class="n">bd</span><span class="p">,</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">cctl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_llis</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">total_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">cctl</span> <span class="o">=</span> <span class="n">pl08x_cctl_bits</span><span class="p">(</span><span class="o">*</span><span class="n">cctl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">pl08x_fill_lli_for_desc</span><span class="p">(</span><span class="n">bd</span><span class="p">,</span> <span class="n">num_llis</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">*</span><span class="n">cctl</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">total_bytes</span><span class="p">)</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This fills in the table of LLIs for the transfer descriptor</span>
<span class="cm"> * Note that we assume we never have to change the burst sizes</span>
<span class="cm"> * Return 0 for error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl08x_fill_llis_for_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="n">txd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_bus_data</span> <span class="o">*</span><span class="n">mbus</span><span class="p">,</span> <span class="o">*</span><span class="n">sbus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_lli_build_data</span> <span class="n">bd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_llis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cctl</span><span class="p">,</span> <span class="n">early_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">max_bytes_per_lli</span><span class="p">,</span> <span class="n">total_bytes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_lli</span> <span class="o">*</span><span class="n">llis_va</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_sg</span> <span class="o">*</span><span class="n">dsg</span><span class="p">;</span>

	<span class="n">txd</span><span class="o">-&gt;</span><span class="n">llis_va</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">GFP_NOWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">llis_bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">llis_va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s no memory for llis</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">pool_ctr</span><span class="o">++</span><span class="p">;</span>

	<span class="n">bd</span><span class="p">.</span><span class="n">txd</span> <span class="o">=</span> <span class="n">txd</span><span class="p">;</span>
	<span class="n">bd</span><span class="p">.</span><span class="n">lli_bus</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">lli_buses</span> <span class="o">&amp;</span> <span class="n">PL08X_AHB2</span><span class="p">)</span> <span class="o">?</span> <span class="n">PL080_LLI_LM_AHB2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cctl</span> <span class="o">=</span> <span class="n">txd</span><span class="o">-&gt;</span><span class="n">cctl</span><span class="p">;</span>

	<span class="cm">/* Find maximum width of the source bus */</span>
	<span class="n">bd</span><span class="p">.</span><span class="n">srcbus</span><span class="p">.</span><span class="n">maxwidth</span> <span class="o">=</span>
		<span class="n">pl08x_get_bytes_for_cctl</span><span class="p">((</span><span class="n">cctl</span> <span class="o">&amp;</span> <span class="n">PL080_CONTROL_SWIDTH_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				       <span class="n">PL080_CONTROL_SWIDTH_SHIFT</span><span class="p">);</span>

	<span class="cm">/* Find maximum width of the destination bus */</span>
	<span class="n">bd</span><span class="p">.</span><span class="n">dstbus</span><span class="p">.</span><span class="n">maxwidth</span> <span class="o">=</span>
		<span class="n">pl08x_get_bytes_for_cctl</span><span class="p">((</span><span class="n">cctl</span> <span class="o">&amp;</span> <span class="n">PL080_CONTROL_DWIDTH_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				       <span class="n">PL080_CONTROL_DWIDTH_SHIFT</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dsg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">dsg_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">total_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cctl</span> <span class="o">=</span> <span class="n">txd</span><span class="o">-&gt;</span><span class="n">cctl</span><span class="p">;</span>

		<span class="n">bd</span><span class="p">.</span><span class="n">srcbus</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">dsg</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">;</span>
		<span class="n">bd</span><span class="p">.</span><span class="n">dstbus</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">dsg</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">;</span>
		<span class="n">bd</span><span class="p">.</span><span class="n">remainder</span> <span class="o">=</span> <span class="n">dsg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">bd</span><span class="p">.</span><span class="n">srcbus</span><span class="p">.</span><span class="n">buswidth</span> <span class="o">=</span> <span class="n">bd</span><span class="p">.</span><span class="n">srcbus</span><span class="p">.</span><span class="n">maxwidth</span><span class="p">;</span>
		<span class="n">bd</span><span class="p">.</span><span class="n">dstbus</span><span class="p">.</span><span class="n">buswidth</span> <span class="o">=</span> <span class="n">bd</span><span class="p">.</span><span class="n">dstbus</span><span class="p">.</span><span class="n">maxwidth</span><span class="p">;</span>

		<span class="n">pl08x_choose_master_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbus</span><span class="p">,</span> <span class="n">cctl</span><span class="p">);</span>

		<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;src=0x%08x%s/%u dst=0x%08x%s/%u len=%zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bd</span><span class="p">.</span><span class="n">srcbus</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">cctl</span> <span class="o">&amp;</span> <span class="n">PL080_CONTROL_SRC_INCR</span> <span class="o">?</span> <span class="s">&quot;+&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">bd</span><span class="p">.</span><span class="n">srcbus</span><span class="p">.</span><span class="n">buswidth</span><span class="p">,</span>
			<span class="n">bd</span><span class="p">.</span><span class="n">dstbus</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">cctl</span> <span class="o">&amp;</span> <span class="n">PL080_CONTROL_DST_INCR</span> <span class="o">?</span> <span class="s">&quot;+&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">bd</span><span class="p">.</span><span class="n">dstbus</span><span class="p">.</span><span class="n">buswidth</span><span class="p">,</span>
			<span class="n">bd</span><span class="p">.</span><span class="n">remainder</span><span class="p">);</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mbus=%s sbus=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mbus</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">bd</span><span class="p">.</span><span class="n">srcbus</span> <span class="o">?</span> <span class="s">&quot;src&quot;</span> <span class="o">:</span> <span class="s">&quot;dst&quot;</span><span class="p">,</span>
			<span class="n">sbus</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">bd</span><span class="p">.</span><span class="n">srcbus</span> <span class="o">?</span> <span class="s">&quot;src&quot;</span> <span class="o">:</span> <span class="s">&quot;dst&quot;</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Zero length is only allowed if all these requirements are</span>
<span class="cm">		 * met:</span>
<span class="cm">		 * - flow controller is peripheral.</span>
<span class="cm">		 * - src.addr is aligned to src.width</span>
<span class="cm">		 * - dst.addr is aligned to dst.width</span>
<span class="cm">		 *</span>
<span class="cm">		 * sg_len == 1 should be true, as there can be two cases here:</span>
<span class="cm">		 *</span>
<span class="cm">		 * - Memory addresses are contiguous and are not scattered.</span>
<span class="cm">		 *   Here, Only one sg will be passed by user driver, with</span>
<span class="cm">		 *   memory address and zero length. We pass this to controller</span>
<span class="cm">		 *   and after the transfer it will receive the last burst</span>
<span class="cm">		 *   request from peripheral and so transfer finishes.</span>
<span class="cm">		 *</span>
<span class="cm">		 * - Memory addresses are scattered and are not contiguous.</span>
<span class="cm">		 *   Here, Obviously as DMA controller doesn&#39;t know when a lli&#39;s</span>
<span class="cm">		 *   transfer gets over, it can&#39;t load next lli. So in this</span>
<span class="cm">		 *   case, there has to be an assumption that only one lli is</span>
<span class="cm">		 *   supported. Thus, we can&#39;t have scattered addresses.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bd</span><span class="p">.</span><span class="n">remainder</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">fc</span> <span class="o">=</span> <span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">ccfg</span> <span class="o">&amp;</span> <span class="n">PL080_CONFIG_FLOW_CONTROL_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">PL080_CONFIG_FLOW_CONTROL_SHIFT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">fc</span> <span class="o">&gt;=</span> <span class="n">PL080_FLOW_SRC2DST_DST</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">fc</span> <span class="o">&lt;=</span> <span class="n">PL080_FLOW_SRC2DST_SRC</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s sg len can&#39;t be zero&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">bd</span><span class="p">.</span><span class="n">srcbus</span><span class="p">.</span><span class="n">addr</span> <span class="o">%</span> <span class="n">bd</span><span class="p">.</span><span class="n">srcbus</span><span class="p">.</span><span class="n">buswidth</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="n">bd</span><span class="p">.</span><span class="n">dstbus</span><span class="p">.</span><span class="n">addr</span> <span class="o">%</span> <span class="n">bd</span><span class="p">.</span><span class="n">dstbus</span><span class="p">.</span><span class="n">buswidth</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s src &amp; dst address must be aligned to src&quot;</span>
					<span class="s">&quot; &amp; dst width if peripheral is flow controller&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">cctl</span> <span class="o">=</span> <span class="n">pl08x_cctl_bits</span><span class="p">(</span><span class="n">cctl</span><span class="p">,</span> <span class="n">bd</span><span class="p">.</span><span class="n">srcbus</span><span class="p">.</span><span class="n">buswidth</span><span class="p">,</span>
					<span class="n">bd</span><span class="p">.</span><span class="n">dstbus</span><span class="p">.</span><span class="n">buswidth</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">pl08x_fill_lli_for_desc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="p">,</span> <span class="n">num_llis</span><span class="o">++</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cctl</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Send byte by byte for following cases</span>
<span class="cm">		 * - Less than a bus width available</span>
<span class="cm">		 * - until master bus is aligned</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="p">.</span><span class="n">remainder</span> <span class="o">&lt;</span> <span class="n">mbus</span><span class="o">-&gt;</span><span class="n">buswidth</span><span class="p">)</span>
			<span class="n">early_bytes</span> <span class="o">=</span> <span class="n">bd</span><span class="p">.</span><span class="n">remainder</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">mbus</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">mbus</span><span class="o">-&gt;</span><span class="n">buswidth</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">early_bytes</span> <span class="o">=</span> <span class="n">mbus</span><span class="o">-&gt;</span><span class="n">buswidth</span> <span class="o">-</span> <span class="p">(</span><span class="n">mbus</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">%</span>
				<span class="p">(</span><span class="n">mbus</span><span class="o">-&gt;</span><span class="n">buswidth</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">bd</span><span class="p">.</span><span class="n">remainder</span> <span class="o">-</span> <span class="n">early_bytes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">mbus</span><span class="o">-&gt;</span><span class="n">buswidth</span><span class="p">)</span>
				<span class="n">early_bytes</span> <span class="o">=</span> <span class="n">bd</span><span class="p">.</span><span class="n">remainder</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">early_bytes</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s byte width LLIs (remain 0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">bd</span><span class="p">.</span><span class="n">remainder</span><span class="p">);</span>
			<span class="n">prep_byte_width_lli</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cctl</span><span class="p">,</span> <span class="n">early_bytes</span><span class="p">,</span> <span class="n">num_llis</span><span class="o">++</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">total_bytes</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="p">.</span><span class="n">remainder</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Master now aligned</span>
<span class="cm">			 * - if slave is not then we must set its width down</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sbus</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">%</span> <span class="n">sbus</span><span class="o">-&gt;</span><span class="n">buswidth</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s set down bus width to one byte</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>

				<span class="n">sbus</span><span class="o">-&gt;</span><span class="n">buswidth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Bytes transferred = tsize * src width, not</span>
<span class="cm">			 * MIN(buswidths)</span>
<span class="cm">			 */</span>
			<span class="n">max_bytes_per_lli</span> <span class="o">=</span> <span class="n">bd</span><span class="p">.</span><span class="n">srcbus</span><span class="p">.</span><span class="n">buswidth</span> <span class="o">*</span>
				<span class="n">PL080_CONTROL_TRANSFER_SIZE_MASK</span><span class="p">;</span>
			<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s max bytes per lli = %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">max_bytes_per_lli</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Make largest possible LLIs until less than one bus</span>
<span class="cm">			 * width left</span>
<span class="cm">			 */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">bd</span><span class="p">.</span><span class="n">remainder</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">mbus</span><span class="o">-&gt;</span><span class="n">buswidth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">size_t</span> <span class="n">lli_len</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span> <span class="n">width</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * If enough left try to send max possible,</span>
<span class="cm">				 * otherwise try to send the remainder</span>
<span class="cm">				 */</span>
				<span class="n">lli_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">bd</span><span class="p">.</span><span class="n">remainder</span><span class="p">,</span> <span class="n">max_bytes_per_lli</span><span class="p">);</span>

				<span class="cm">/*</span>
<span class="cm">				 * Check against maximum bus alignment:</span>
<span class="cm">				 * Calculate actual transfer size in relation to</span>
<span class="cm">				 * bus width an get a maximum remainder of the</span>
<span class="cm">				 * highest bus width - 1</span>
<span class="cm">				 */</span>
				<span class="n">width</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">mbus</span><span class="o">-&gt;</span><span class="n">buswidth</span><span class="p">,</span> <span class="n">sbus</span><span class="o">-&gt;</span><span class="n">buswidth</span><span class="p">);</span>
				<span class="n">lli_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">lli_len</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span><span class="p">;</span>
				<span class="n">tsize</span> <span class="o">=</span> <span class="n">lli_len</span> <span class="o">/</span> <span class="n">bd</span><span class="p">.</span><span class="n">srcbus</span><span class="p">.</span><span class="n">buswidth</span><span class="p">;</span>

				<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s fill lli with single lli chunk of &quot;</span>
					<span class="s">&quot;size 0x%08zx (remainder 0x%08zx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">lli_len</span><span class="p">,</span> <span class="n">bd</span><span class="p">.</span><span class="n">remainder</span><span class="p">);</span>

				<span class="n">cctl</span> <span class="o">=</span> <span class="n">pl08x_cctl_bits</span><span class="p">(</span><span class="n">cctl</span><span class="p">,</span> <span class="n">bd</span><span class="p">.</span><span class="n">srcbus</span><span class="p">.</span><span class="n">buswidth</span><span class="p">,</span>
					<span class="n">bd</span><span class="p">.</span><span class="n">dstbus</span><span class="p">.</span><span class="n">buswidth</span><span class="p">,</span> <span class="n">tsize</span><span class="p">);</span>
				<span class="n">pl08x_fill_lli_for_desc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="p">,</span> <span class="n">num_llis</span><span class="o">++</span><span class="p">,</span>
						<span class="n">lli_len</span><span class="p">,</span> <span class="n">cctl</span><span class="p">);</span>
				<span class="n">total_bytes</span> <span class="o">+=</span> <span class="n">lli_len</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Send any odd bytes</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="p">.</span><span class="n">remainder</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s align with boundary, send odd bytes (remain %zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">bd</span><span class="p">.</span><span class="n">remainder</span><span class="p">);</span>
				<span class="n">prep_byte_width_lli</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cctl</span><span class="p">,</span> <span class="n">bd</span><span class="p">.</span><span class="n">remainder</span><span class="p">,</span>
						<span class="n">num_llis</span><span class="o">++</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">total_bytes</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">total_bytes</span> <span class="o">!=</span> <span class="n">dsg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s size of encoded lli:s don&#39;t match total txd, transferred 0x%08zx from size 0x%08zx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">total_bytes</span><span class="p">,</span> <span class="n">dsg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">num_llis</span> <span class="o">&gt;=</span> <span class="n">MAX_NUM_TSFR_LLIS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s need to increase MAX_NUM_TSFR_LLIS from 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">MAX_NUM_TSFR_LLIS</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">llis_va</span> <span class="o">=</span> <span class="n">txd</span><span class="o">-&gt;</span><span class="n">llis_va</span><span class="p">;</span>
	<span class="cm">/* The final LLI terminates the LLI. */</span>
	<span class="n">llis_va</span><span class="p">[</span><span class="n">num_llis</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">lli</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* The final LLI element shall also fire an interrupt. */</span>
	<span class="n">llis_va</span><span class="p">[</span><span class="n">num_llis</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">cctl</span> <span class="o">|=</span> <span class="n">PL080_CONTROL_TC_IRQ_EN</span><span class="p">;</span>

<span class="cp">#ifdef VERBOSE_DEBUG</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;%-3s %-9s  %-10s %-10s %-10s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;lli&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;csrc&quot;</span><span class="p">,</span> <span class="s">&quot;cdst&quot;</span><span class="p">,</span> <span class="s">&quot;clli&quot;</span><span class="p">,</span> <span class="s">&quot;cctl&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_llis</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;%3d @%p: 0x%08x 0x%08x 0x%08x 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">llis_va</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">llis_va</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src</span><span class="p">,</span>
				 <span class="n">llis_va</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dst</span><span class="p">,</span> <span class="n">llis_va</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lli</span><span class="p">,</span> <span class="n">llis_va</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cctl</span>
				<span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">num_llis</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* You should call this with the struct pl08x lock held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl08x_free_txd</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="n">txd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_sg</span> <span class="o">*</span><span class="n">dsg</span><span class="p">,</span> <span class="o">*</span><span class="n">_dsg</span><span class="p">;</span>

	<span class="cm">/* Free the LLI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">llis_va</span><span class="p">)</span>
		<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">txd</span><span class="o">-&gt;</span><span class="n">llis_va</span><span class="p">,</span> <span class="n">txd</span><span class="o">-&gt;</span><span class="n">llis_bus</span><span class="p">);</span>

	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">pool_ctr</span><span class="o">--</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">dsg</span><span class="p">,</span> <span class="n">_dsg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">dsg_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dsg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">txd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl08x_free_txd_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">plchan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="n">txdi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">pend_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">txdi</span><span class="p">,</span>
					 <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">pend_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txdi</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
			<span class="n">pl08x_free_txd</span><span class="p">(</span><span class="n">pl08x</span><span class="p">,</span> <span class="n">txdi</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The DMA ENGINE API</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl08x_alloc_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl08x_free_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This should be called with the channel plchan-&gt;lock held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prep_phy_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">plchan</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="n">txd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span> <span class="o">=</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_phy_chan</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Check if we already have a channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">phychan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">phychan</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">got_channel</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="n">pl08x_get_phy_channel</span><span class="p">(</span><span class="n">pl08x</span><span class="p">,</span> <span class="n">plchan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No physical channel available, cope with it */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no physical channel available for xfer on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * OK we have a physical channel: for memcpy() this is all we</span>
<span class="cm">	 * need, but for slaves the physical signals may be muxed!</span>
<span class="cm">	 * Can the platform allow us to use this channel?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">&amp;&amp;</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">get_signal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">get_signal</span><span class="p">(</span><span class="n">plchan</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;unable to use physical channel %d for transfer on %s due to platform restrictions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="cm">/* Release physical channel &amp; return */</span>
			<span class="n">pl08x_put_phy_channel</span><span class="p">(</span><span class="n">pl08x</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">phychan</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;allocated physical channel %d and signal %d for xfer on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
		 <span class="n">ch</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">,</span>
		 <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="nl">got_channel:</span>
	<span class="cm">/* Assign the flow control signal to this channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">ccfg</span> <span class="o">|=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">&lt;&lt;</span> <span class="n">PL080_CONFIG_DST_SEL_SHIFT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">)</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">ccfg</span> <span class="o">|=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">&lt;&lt;</span> <span class="n">PL080_CONFIG_SRC_SEL_SHIFT</span><span class="p">;</span>

	<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">phychan_hold</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_phy_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">plchan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span> <span class="o">=</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">phychan</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">put_signal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">put_signal</span><span class="p">(</span><span class="n">plchan</span><span class="p">);</span>
		<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">phychan</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pl08x_put_phy_channel</span><span class="p">(</span><span class="n">pl08x</span><span class="p">,</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">phychan</span><span class="p">);</span>
	<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">phychan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">dma_cookie_t</span> <span class="nf">pl08x_tx_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">plchan</span> <span class="o">=</span> <span class="n">to_pl08x_chan</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="n">txd</span> <span class="o">=</span> <span class="n">to_pl08x_txd</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cookie</span> <span class="o">=</span> <span class="n">dma_cookie_assign</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>

	<span class="cm">/* Put this onto the pending list */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">pend_list</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there was no physical channel available for this memcpy,</span>
<span class="cm">	 * stack the request up and indicate that the channel is waiting</span>
<span class="cm">	 * for a free physical channel.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">phychan</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Do this memcpy whenever there is a channel ready */</span>
		<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">PL08X_CHAN_WAITING</span><span class="p">;</span>
		<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="n">txd</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">phychan_hold</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cookie</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">pl08x_prep_dma_interrupt</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">retval</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Code accessing dma_async_is_complete() in a tight loop may give problems.</span>
<span class="cm"> * If slaves are relying on interrupts to signal completion this function</span>
<span class="cm"> * must not be called with interrupts disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">dma_status</span> <span class="nf">pl08x_dma_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
		<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_tx_state</span> <span class="o">*</span><span class="n">txstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">plchan</span> <span class="o">=</span> <span class="n">to_pl08x_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">dma_status</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_cookie_status</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">txstate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">DMA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This cookie not complete yet</span>
<span class="cm">	 * Get number of bytes left in the active transactions and queue</span>
<span class="cm">	 */</span>
	<span class="n">dma_set_residue</span><span class="p">(</span><span class="n">txstate</span><span class="p">,</span> <span class="n">pl08x_getbytes_chan</span><span class="p">(</span><span class="n">plchan</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">PL08X_CHAN_PAUSED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DMA_PAUSED</span><span class="p">;</span>

	<span class="cm">/* Whether waiting or running, we&#39;re in progress */</span>
	<span class="k">return</span> <span class="n">DMA_IN_PROGRESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* PrimeCell DMA extension */</span>
<span class="k">struct</span> <span class="n">burst_table</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">burstwords</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">burst_table</span> <span class="n">burst_sizes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">burstwords</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PL080_BSIZE_256</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">burstwords</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PL080_BSIZE_128</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">burstwords</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PL080_BSIZE_64</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">burstwords</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PL080_BSIZE_32</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">burstwords</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PL080_BSIZE_16</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">burstwords</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PL080_BSIZE_8</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">burstwords</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PL080_BSIZE_4</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">burstwords</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">PL080_BSIZE_1</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Given the source and destination available bus masks, select which</span>
<span class="cm"> * will be routed to each port.  We try to have source and destination</span>
<span class="cm"> * on separate ports, but always respect the allowable settings.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">pl08x_select_bus</span><span class="p">(</span><span class="n">u8</span> <span class="n">src</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dst</span> <span class="o">&amp;</span> <span class="n">PL08X_AHB1</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">dst</span> <span class="o">&amp;</span> <span class="n">PL08X_AHB2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">src</span> <span class="o">&amp;</span> <span class="n">PL08X_AHB1</span><span class="p">)))</span>
		<span class="n">cctl</span> <span class="o">|=</span> <span class="n">PL080_CONTROL_DST_AHB2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">src</span> <span class="o">&amp;</span> <span class="n">PL08X_AHB1</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">src</span> <span class="o">&amp;</span> <span class="n">PL08X_AHB2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dst</span> <span class="o">&amp;</span> <span class="n">PL08X_AHB2</span><span class="p">)))</span>
		<span class="n">cctl</span> <span class="o">|=</span> <span class="n">PL080_CONTROL_SRC_AHB2</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cctl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">pl08x_cctl</span><span class="p">(</span><span class="n">u32</span> <span class="n">cctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PL080_CONTROL_SRC_AHB2</span> <span class="o">|</span> <span class="n">PL080_CONTROL_DST_AHB2</span> <span class="o">|</span>
		  <span class="n">PL080_CONTROL_SRC_INCR</span> <span class="o">|</span> <span class="n">PL080_CONTROL_DST_INCR</span> <span class="o">|</span>
		  <span class="n">PL080_CONTROL_PROT_MASK</span><span class="p">);</span>

	<span class="cm">/* Access the cell in privileged mode, non-bufferable, non-cacheable */</span>
	<span class="k">return</span> <span class="n">cctl</span> <span class="o">|</span> <span class="n">PL080_CONTROL_PROT_SYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">pl08x_width</span><span class="p">(</span><span class="k">enum</span> <span class="n">dma_slave_buswidth</span> <span class="n">width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">width</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMA_SLAVE_BUSWIDTH_1_BYTE</span>:
		<span class="k">return</span> <span class="n">PL080_WIDTH_8BIT</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_SLAVE_BUSWIDTH_2_BYTES</span>:
		<span class="k">return</span> <span class="n">PL080_WIDTH_16BIT</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_SLAVE_BUSWIDTH_4_BYTES</span>:
		<span class="k">return</span> <span class="n">PL080_WIDTH_32BIT</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">pl08x_burst</span><span class="p">(</span><span class="n">u32</span> <span class="n">maxburst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">burst_sizes</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">burst_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">burstwords</span> <span class="o">&lt;=</span> <span class="n">maxburst</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">burst_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_set_runtime_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">dma_slave_config</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">plchan</span> <span class="o">=</span> <span class="n">to_pl08x_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span> <span class="o">=</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_slave_buswidth</span> <span class="n">addr_width</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">width</span><span class="p">,</span> <span class="n">burst</span><span class="p">,</span> <span class="n">maxburst</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Transfer direction */</span>
	<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">runtime_direction</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr_width</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">dst_addr_width</span><span class="p">;</span>
		<span class="n">maxburst</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">dst_maxburst</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr_width</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">src_addr_width</span><span class="p">;</span>
		<span class="n">maxburst</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">src_maxburst</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;bad runtime_config: alien transfer direction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">width</span> <span class="o">=</span> <span class="n">pl08x_width</span><span class="p">(</span><span class="n">addr_width</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;bad runtime_config: alien address width</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cctl</span> <span class="o">|=</span> <span class="n">width</span> <span class="o">&lt;&lt;</span> <span class="n">PL080_CONTROL_SWIDTH_SHIFT</span><span class="p">;</span>
	<span class="n">cctl</span> <span class="o">|=</span> <span class="n">width</span> <span class="o">&lt;&lt;</span> <span class="n">PL080_CONTROL_DWIDTH_SHIFT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this channel will only request single transfers, set this</span>
<span class="cm">	 * down to ONE element.  Also select one element if no maxburst</span>
<span class="cm">	 * is specified.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">single</span><span class="p">)</span>
		<span class="n">maxburst</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">burst</span> <span class="o">=</span> <span class="n">pl08x_burst</span><span class="p">(</span><span class="n">maxburst</span><span class="p">);</span>
	<span class="n">cctl</span> <span class="o">|=</span> <span class="n">burst</span> <span class="o">&lt;&lt;</span> <span class="n">PL080_CONTROL_SB_SIZE_SHIFT</span><span class="p">;</span>
	<span class="n">cctl</span> <span class="o">|=</span> <span class="n">burst</span> <span class="o">&lt;&lt;</span> <span class="n">PL080_CONTROL_DB_SIZE_SHIFT</span><span class="p">;</span>

	<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">device_fc</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">device_fc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">runtime_direction</span> <span class="o">==</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">src_addr</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">;</span>
		<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">src_cctl</span> <span class="o">=</span> <span class="n">pl08x_cctl</span><span class="p">(</span><span class="n">cctl</span><span class="p">)</span> <span class="o">|</span> <span class="n">PL080_CONTROL_DST_INCR</span> <span class="o">|</span>
			<span class="n">pl08x_select_bus</span><span class="p">(</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">periph_buses</span><span class="p">,</span>
					 <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">mem_buses</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">;</span>
		<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">dst_cctl</span> <span class="o">=</span> <span class="n">pl08x_cctl</span><span class="p">(</span><span class="n">cctl</span><span class="p">)</span> <span class="o">|</span> <span class="n">PL080_CONTROL_SRC_INCR</span> <span class="o">|</span>
			<span class="n">pl08x_select_bus</span><span class="p">(</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">mem_buses</span><span class="p">,</span>
					 <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">periph_buses</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;configured channel %s (%s) for %s, data width %d, &quot;</span>
		<span class="s">&quot;maxburst %d words, LE, CCTL=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dma_chan_name</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RX&quot;</span> <span class="o">:</span> <span class="s">&quot;TX&quot;</span><span class="p">,</span>
		<span class="n">addr_width</span><span class="p">,</span>
		<span class="n">maxburst</span><span class="p">,</span>
		<span class="n">cctl</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Slave transactions callback to the slave device to allow</span>
<span class="cm"> * synchronization of slave DMA signals with the DMAC enable</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl08x_issue_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">plchan</span> <span class="o">=</span> <span class="n">to_pl08x_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Something is already active, or we&#39;re waiting for a channel... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">at</span> <span class="o">||</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">PL08X_CHAN_WAITING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Take the first element in the queue and execute it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">pend_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

		<span class="n">next</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">pend_list</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">pl08x_txd</span><span class="p">,</span>
					<span class="n">node</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">PL08X_CHAN_RUNNING</span><span class="p">;</span>

		<span class="n">pl08x_start_txd</span><span class="p">(</span><span class="n">plchan</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl08x_prep_channel_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">plchan</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="n">txd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span> <span class="o">=</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_llis</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">num_llis</span> <span class="o">=</span> <span class="n">pl08x_fill_llis_for_desc</span><span class="p">(</span><span class="n">pl08x</span><span class="p">,</span> <span class="n">txd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_llis</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pl08x_free_txd</span><span class="p">(</span><span class="n">pl08x</span><span class="p">,</span> <span class="n">txd</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * See if we already have a physical channel allocated,</span>
<span class="cm">	 * else this is the time to try to get one.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">prep_phy_channel</span><span class="p">(</span><span class="n">plchan</span><span class="p">,</span> <span class="n">txd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * No physical channel was available.</span>
<span class="cm">		 *</span>
<span class="cm">		 * memcpy transfers can be sorted out at submission time.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Slave transfers may have been denied due to platform</span>
<span class="cm">		 * channel muxing restrictions.  Since there is no guarantee</span>
<span class="cm">		 * that this will ever be resolved, and the signal must be</span>
<span class="cm">		 * acquired AFTER acquiring the physical channel, we will let</span>
<span class="cm">		 * them be NACK:ed with -EBUSY here. The drivers can retry</span>
<span class="cm">		 * the prep() call if they are eager on doing this using DMA.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pl08x_free_txd_list</span><span class="p">(</span><span class="n">pl08x</span><span class="p">,</span> <span class="n">plchan</span><span class="p">);</span>
			<span class="n">pl08x_free_txd</span><span class="p">(</span><span class="n">pl08x</span><span class="p">,</span> <span class="n">txd</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/*</span>
<span class="cm">		 * Else we&#39;re all set, paused and ready to roll, status</span>
<span class="cm">		 * will switch to PL08X_CHAN_RUNNING when we call</span>
<span class="cm">		 * issue_pending(). If there is something running on the</span>
<span class="cm">		 * channel already we don&#39;t change its state.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">PL08X_CHAN_IDLE</span><span class="p">)</span>
			<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">PL08X_CHAN_PAUSED</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="nf">pl08x_get_txd</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">plchan</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="n">txd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">txd</span><span class="p">),</span> <span class="n">GFP_NOWAIT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_async_tx_descriptor_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_submit</span> <span class="o">=</span> <span class="n">pl08x_tx_submit</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">dsg_list</span><span class="p">);</span>

		<span class="cm">/* Always enable error and terminal interrupts */</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">ccfg</span> <span class="o">=</span> <span class="n">PL080_CONFIG_ERR_IRQ_MASK</span> <span class="o">|</span>
			    <span class="n">PL080_CONFIG_TC_IRQ_MASK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">txd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize a descriptor to be used by memcpy submit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">pl08x_prep_dma_memcpy</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">src</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">plchan</span> <span class="o">=</span> <span class="n">to_pl08x_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span> <span class="o">=</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="n">txd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_sg</span> <span class="o">*</span><span class="n">dsg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">txd</span> <span class="o">=</span> <span class="n">pl08x_get_txd</span><span class="p">(</span><span class="n">plchan</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s no memory for descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dsg</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_sg</span><span class="p">),</span> <span class="n">GFP_NOWAIT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pl08x_free_txd</span><span class="p">(</span><span class="n">pl08x</span><span class="p">,</span> <span class="n">txd</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s no memory for pl080 sg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">dsg_list</span><span class="p">);</span>

	<span class="n">txd</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_NONE</span><span class="p">;</span>
	<span class="n">dsg</span><span class="o">-&gt;</span><span class="n">src_addr</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
	<span class="n">dsg</span><span class="o">-&gt;</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>
	<span class="n">dsg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Set platform data for m2m */</span>
	<span class="n">txd</span><span class="o">-&gt;</span><span class="n">ccfg</span> <span class="o">|=</span> <span class="n">PL080_FLOW_MEM2MEM</span> <span class="o">&lt;&lt;</span> <span class="n">PL080_CONFIG_FLOW_CONTROL_SHIFT</span><span class="p">;</span>
	<span class="n">txd</span><span class="o">-&gt;</span><span class="n">cctl</span> <span class="o">=</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">memcpy_channel</span><span class="p">.</span><span class="n">cctl</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="n">PL080_CONTROL_DST_AHB2</span> <span class="o">|</span> <span class="n">PL080_CONTROL_SRC_AHB2</span><span class="p">);</span>

	<span class="cm">/* Both to be incremented or the code will break */</span>
	<span class="n">txd</span><span class="o">-&gt;</span><span class="n">cctl</span> <span class="o">|=</span> <span class="n">PL080_CONTROL_SRC_INCR</span> <span class="o">|</span> <span class="n">PL080_CONTROL_DST_INCR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">vd</span><span class="o">-&gt;</span><span class="n">dualmaster</span><span class="p">)</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">cctl</span> <span class="o">|=</span> <span class="n">pl08x_select_bus</span><span class="p">(</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">mem_buses</span><span class="p">,</span>
					      <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">mem_buses</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pl08x_prep_channel_resources</span><span class="p">(</span><span class="n">plchan</span><span class="p">,</span> <span class="n">txd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">pl08x_prep_slave_sg</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sgl</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">direction</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">plchan</span> <span class="o">=</span> <span class="n">to_pl08x_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span> <span class="o">=</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="n">txd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_sg</span> <span class="o">*</span><span class="n">dsg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">slave_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s prepare transaction of %d bytes from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sgl</span><span class="p">),</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">txd</span> <span class="o">=</span> <span class="n">pl08x_get_txd</span><span class="p">(</span><span class="n">plchan</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s no txd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">!=</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">runtime_direction</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s DMA setup does not match &quot;</span>
			<span class="s">&quot;the direction configured for the PrimeCell</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up addresses, the PrimeCell configured address</span>
<span class="cm">	 * will take precedence since this may configure the</span>
<span class="cm">	 * channel target address dynamically at runtime.</span>
<span class="cm">	 */</span>
	<span class="n">txd</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">cctl</span> <span class="o">=</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">dst_cctl</span><span class="p">;</span>
		<span class="n">slave_addr</span> <span class="o">=</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">cctl</span> <span class="o">=</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">src_cctl</span><span class="p">;</span>
		<span class="n">slave_addr</span> <span class="o">=</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pl08x_free_txd</span><span class="p">(</span><span class="n">pl08x</span><span class="p">,</span> <span class="n">txd</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s direction unsupported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">device_fc</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span> <span class="o">?</span> <span class="n">PL080_FLOW_MEM2PER_PER</span> <span class="o">:</span>
			<span class="n">PL080_FLOW_PER2MEM_PER</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span> <span class="o">?</span> <span class="n">PL080_FLOW_MEM2PER</span> <span class="o">:</span>
			<span class="n">PL080_FLOW_PER2MEM</span><span class="p">;</span>

	<span class="n">txd</span><span class="o">-&gt;</span><span class="n">ccfg</span> <span class="o">|=</span> <span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="n">PL080_CONFIG_FLOW_CONTROL_SHIFT</span><span class="p">;</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dsg</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_sg</span><span class="p">),</span> <span class="n">GFP_NOWAIT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pl08x_free_txd</span><span class="p">(</span><span class="n">pl08x</span><span class="p">,</span> <span class="n">txd</span><span class="p">);</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s no mem for pl080 sg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">dsg_list</span><span class="p">);</span>

		<span class="n">dsg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dsg</span><span class="o">-&gt;</span><span class="n">src_addr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">dsg</span><span class="o">-&gt;</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="n">slave_addr</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dsg</span><span class="o">-&gt;</span><span class="n">src_addr</span> <span class="o">=</span> <span class="n">slave_addr</span><span class="p">;</span>
			<span class="n">dsg</span><span class="o">-&gt;</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pl08x_prep_channel_resources</span><span class="p">(</span><span class="n">plchan</span><span class="p">,</span> <span class="n">txd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl08x_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_ctrl_cmd</span> <span class="n">cmd</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">plchan</span> <span class="o">=</span> <span class="n">to_pl08x_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span> <span class="o">=</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Controls applicable to inactive channels */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">DMA_SLAVE_CONFIG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">dma_set_runtime_config</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span>
					      <span class="p">(</span><span class="k">struct</span> <span class="n">dma_slave_config</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Anything succeeds on channels with no physical allocation and</span>
<span class="cm">	 * no queued transfers.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">phychan</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMA_TERMINATE_ALL</span>:
		<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">PL08X_CHAN_IDLE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">phychan</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pl08x_terminate_phy_chan</span><span class="p">(</span><span class="n">pl08x</span><span class="p">,</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">phychan</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Mark physical channel as free and free any slave</span>
<span class="cm">			 * signal</span>
<span class="cm">			 */</span>
			<span class="n">release_phy_channel</span><span class="p">(</span><span class="n">plchan</span><span class="p">);</span>
			<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">phychan_hold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Dequeue jobs and free LLIs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pl08x_free_txd</span><span class="p">(</span><span class="n">pl08x</span><span class="p">,</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">);</span>
			<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">at</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Dequeue jobs not yet fired as well */</span>
		<span class="n">pl08x_free_txd_list</span><span class="p">(</span><span class="n">pl08x</span><span class="p">,</span> <span class="n">plchan</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_PAUSE</span>:
		<span class="n">pl08x_pause_phy_chan</span><span class="p">(</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">phychan</span><span class="p">);</span>
		<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">PL08X_CHAN_PAUSED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_RESUME</span>:
		<span class="n">pl08x_resume_phy_chan</span><span class="p">(</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">phychan</span><span class="p">);</span>
		<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">PL08X_CHAN_RUNNING</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Unknown command */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">pl08x_filter_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">chan_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">plchan</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">chan_id</span><span class="p">;</span>

	<span class="cm">/* Reject channels for devices not bound to this driver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">pl08x_amba_driver</span><span class="p">.</span><span class="n">drv</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">plchan</span> <span class="o">=</span> <span class="n">to_pl08x_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="cm">/* Check that the channel is not taken! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Just check that the device is there and active</span>
<span class="cm"> * TODO: turn this bit on/off depending on the number of physical channels</span>
<span class="cm"> * actually used, if it is zero... well shut it off. That will save some</span>
<span class="cm"> * power. Cut the clock at the same time.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl08x_ensure_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The Nomadik variant does not have the config register */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">vd</span><span class="o">-&gt;</span><span class="n">nomadik</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">PL080_CONFIG_ENABLE</span><span class="p">,</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_CONFIG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl08x_unmap_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="n">txd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_sg</span> <span class="o">*</span><span class="n">dsg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_SKIP_SRC_UNMAP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_SRC_UNMAP_SINGLE</span><span class="p">)</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dsg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">dsg_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
				<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dsg</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">dsg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
						<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dsg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">dsg_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
				<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dsg</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">dsg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
						<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_SKIP_DEST_UNMAP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_DEST_UNMAP_SINGLE</span><span class="p">)</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dsg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">dsg_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
				<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dsg</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">,</span> <span class="n">dsg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
						<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dsg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">dsg_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
				<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dsg</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">,</span> <span class="n">dsg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
						<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl08x_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">plchan</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span> <span class="o">=</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="n">txd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">txd</span> <span class="o">=</span> <span class="n">plchan</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">;</span>
	<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">at</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txd</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Update last completed */</span>
		<span class="n">dma_cookie_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If a new descriptor is queued, set it up plchan-&gt;at is NULL here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">pend_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pl08x_txd</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

		<span class="n">next</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">pend_list</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">pl08x_txd</span><span class="p">,</span>
					<span class="n">node</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

		<span class="n">pl08x_start_txd</span><span class="p">(</span><span class="n">plchan</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">phychan_hold</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This channel is still in use - we have a new txd being</span>
<span class="cm">		 * prepared and will soon be queued.  Don&#39;t give up the</span>
<span class="cm">		 * physical channel.</span>
<span class="cm">		 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">waiting</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * No more jobs, so free up the physical channel</span>
<span class="cm">		 * Free any allocated signal on slave transfers too</span>
<span class="cm">		 */</span>
		<span class="n">release_phy_channel</span><span class="p">(</span><span class="n">plchan</span><span class="p">);</span>
		<span class="n">plchan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">PL08X_CHAN_IDLE</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * And NOW before anyone else can grab that free:d up</span>
<span class="cm">		 * physical channel, see if there is some memcpy pending</span>
<span class="cm">		 * that seriously needs to start because of being stacked</span>
<span class="cm">		 * up while we were choking the physical channels with data.</span>
<span class="cm">		 */</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">waiting</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">memcpy</span><span class="p">.</span><span class="n">channels</span><span class="p">,</span>
				    <span class="n">chan</span><span class="p">.</span><span class="n">device_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">waiting</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">PL08X_CHAN_WAITING</span> <span class="o">&amp;&amp;</span>
				<span class="n">waiting</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

				<span class="cm">/* This should REALLY not fail now */</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">prep_phy_channel</span><span class="p">(</span><span class="n">waiting</span><span class="p">,</span>
						       <span class="n">waiting</span><span class="o">-&gt;</span><span class="n">waiting</span><span class="p">);</span>
				<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
				<span class="n">waiting</span><span class="o">-&gt;</span><span class="n">phychan_hold</span><span class="o">--</span><span class="p">;</span>
				<span class="n">waiting</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">PL08X_CHAN_RUNNING</span><span class="p">;</span>
				<span class="n">waiting</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">pl08x_issue_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waiting</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_async_tx_callback</span> <span class="n">callback</span> <span class="o">=</span> <span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">callback</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">callback_param</span> <span class="o">=</span> <span class="n">txd</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">callback_param</span><span class="p">;</span>

		<span class="cm">/* Don&#39;t try to unmap buffers on slave channels */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">)</span>
			<span class="n">pl08x_unmap_buffers</span><span class="p">(</span><span class="n">txd</span><span class="p">);</span>

		<span class="cm">/* Free the descriptor */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pl08x_free_txd</span><span class="p">(</span><span class="n">pl08x</span><span class="p">,</span> <span class="n">txd</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* Callback to signal completion */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span>
			<span class="n">callback</span><span class="p">(</span><span class="n">callback_param</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">pl08x_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* check &amp; clear - ERR &amp; TC interrupts */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_ERR_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s error interrupt, register value 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_ERR_CLEAR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tc</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_TC_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tc</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tc</span><span class="p">,</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_TC_CLEAR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">vd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">err</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tc</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Locate physical channel */</span>
			<span class="k">struct</span> <span class="n">pl08x_phy_chan</span> <span class="o">*</span><span class="n">phychan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">phy_chans</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">plchan</span> <span class="o">=</span> <span class="n">phychan</span><span class="o">-&gt;</span><span class="n">serving</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plchan</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s Error TC interrupt on unused channel: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Schedule tasklet on this channel */</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plchan</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mask</span> <span class="o">?</span> <span class="n">IRQ_HANDLED</span> <span class="o">:</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl08x_dma_slave_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cctl</span> <span class="o">=</span> <span class="n">pl08x_cctl</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">cctl</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">src_addr</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">src_cctl</span> <span class="o">=</span> <span class="n">cctl</span> <span class="o">|</span> <span class="n">PL080_CONTROL_DST_INCR</span> <span class="o">|</span>
		<span class="n">pl08x_select_bus</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">periph_buses</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mem_buses</span><span class="p">);</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">dst_cctl</span> <span class="o">=</span> <span class="n">cctl</span> <span class="o">|</span> <span class="n">PL080_CONTROL_SRC_INCR</span> <span class="o">|</span>
		<span class="n">pl08x_select_bus</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mem_buses</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">periph_buses</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialise the DMAC memcpy/slave channels.</span>
<span class="cm"> * Make a local wrapper to hold required data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl08x_dma_init_virtual_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dma_device</span> <span class="o">*</span><span class="n">dmadev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channels</span><span class="p">,</span> <span class="n">bool</span> <span class="n">slave</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmadev</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Register as many many memcpy as we have physical channels,</span>
<span class="cm">	 * we won&#39;t always be able to use all but the code will have</span>
<span class="cm">	 * to cope with that situation.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chan</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s no memory for channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">pl08x</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">PL08X_CHAN_IDLE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">cd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">slave_channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">pl08x_dma_slave_init</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">cd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">memcpy_channel</span><span class="p">;</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">kasprintf</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="s">&quot;memcpy%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">circular_buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;channel %s: circular buffers not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;initialize virtual channel </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">chan</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">dmadev</span><span class="p">;</span>
		<span class="n">dma_cookie_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">pend_list</span><span class="p">);</span>
		<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">,</span> <span class="n">pl08x_tasklet</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">chan</span><span class="p">);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dmadev</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;initialized %d virtual %s channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">i</span><span class="p">,</span> <span class="n">slave</span> <span class="o">?</span> <span class="s">&quot;slave&quot;</span> <span class="o">:</span> <span class="s">&quot;memcpy&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pl08x_free_virtual_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_device</span> <span class="o">*</span><span class="n">dmadev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span>
				 <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dmadev</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span> <span class="n">chan</span><span class="p">.</span><span class="n">device_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device_node</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">pl08x_state_str</span><span class="p">(</span><span class="k">enum</span> <span class="n">pl08x_dma_chan_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PL08X_CHAN_IDLE</span>:
		<span class="k">return</span> <span class="s">&quot;idle&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PL08X_CHAN_RUNNING</span>:
		<span class="k">return</span> <span class="s">&quot;running&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PL08X_CHAN_PAUSED</span>:
		<span class="k">return</span> <span class="s">&quot;paused&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PL08X_CHAN_WAITING</span>:
		<span class="k">return</span> <span class="s">&quot;waiting&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="s">&quot;UNKNOWN STATE&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl08x_debugfs_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pl08x_phy_chan</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;PL08x physical channels:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;CHANNEL:</span><span class="se">\t</span><span class="s">USER:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;--------</span><span class="se">\t</span><span class="s">-----</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">vd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pl08x_dma_chan</span> <span class="o">*</span><span class="n">virt_chan</span><span class="p">;</span>

		<span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">phy_chans</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">virt_chan</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">serving</span><span class="p">;</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\t\t</span><span class="s">%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			   <span class="n">virt_chan</span> <span class="o">?</span> <span class="n">virt_chan</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;(none)&quot;</span><span class="p">,</span>
			   <span class="n">ch</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="o">?</span> <span class="s">&quot; LOCKED&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">PL08x virtual memcpy channels:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;CHANNEL:</span><span class="se">\t</span><span class="s">STATE:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;--------</span><span class="se">\t</span><span class="s">------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">memcpy</span><span class="p">.</span><span class="n">channels</span><span class="p">,</span> <span class="n">chan</span><span class="p">.</span><span class="n">device_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			   <span class="n">pl08x_state_str</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">PL08x virtual slave channels:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;CHANNEL:</span><span class="se">\t</span><span class="s">STATE:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;--------</span><span class="se">\t</span><span class="s">------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">.</span><span class="n">channels</span><span class="p">,</span> <span class="n">chan</span><span class="p">.</span><span class="n">device_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			   <span class="n">pl08x_state_str</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl08x_debugfs_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">pl08x_debugfs_show</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">pl08x_debugfs_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">pl08x_debugfs_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_pl08x_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Expose a simple debugfs interface to view all clocks */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			<span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">pl08x</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">pl08x_debugfs_operations</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">init_pl08x_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pl08x_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">amba_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">amba_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pl08x_driver_data</span> <span class="o">*</span><span class="n">pl08x</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">vendor_data</span> <span class="o">*</span><span class="n">vd</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">amba_request_regions</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Create the driver state holder */</span>
	<span class="n">pl08x</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pl08x</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pl08x</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_no_pl08x</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_set_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Initialize memcpy engine */</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">memcpy</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">memcpy</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">memcpy</span><span class="p">.</span><span class="n">device_alloc_chan_resources</span> <span class="o">=</span> <span class="n">pl08x_alloc_chan_resources</span><span class="p">;</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">memcpy</span><span class="p">.</span><span class="n">device_free_chan_resources</span> <span class="o">=</span> <span class="n">pl08x_free_chan_resources</span><span class="p">;</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">memcpy</span><span class="p">.</span><span class="n">device_prep_dma_memcpy</span> <span class="o">=</span> <span class="n">pl08x_prep_dma_memcpy</span><span class="p">;</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">memcpy</span><span class="p">.</span><span class="n">device_prep_dma_interrupt</span> <span class="o">=</span> <span class="n">pl08x_prep_dma_interrupt</span><span class="p">;</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">memcpy</span><span class="p">.</span><span class="n">device_tx_status</span> <span class="o">=</span> <span class="n">pl08x_dma_tx_status</span><span class="p">;</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">memcpy</span><span class="p">.</span><span class="n">device_issue_pending</span> <span class="o">=</span> <span class="n">pl08x_issue_pending</span><span class="p">;</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">memcpy</span><span class="p">.</span><span class="n">device_control</span> <span class="o">=</span> <span class="n">pl08x_control</span><span class="p">;</span>

	<span class="cm">/* Initialize slave engine */</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">.</span><span class="n">device_alloc_chan_resources</span> <span class="o">=</span> <span class="n">pl08x_alloc_chan_resources</span><span class="p">;</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">.</span><span class="n">device_free_chan_resources</span> <span class="o">=</span> <span class="n">pl08x_free_chan_resources</span><span class="p">;</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">.</span><span class="n">device_prep_dma_interrupt</span> <span class="o">=</span> <span class="n">pl08x_prep_dma_interrupt</span><span class="p">;</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">.</span><span class="n">device_tx_status</span> <span class="o">=</span> <span class="n">pl08x_dma_tx_status</span><span class="p">;</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">.</span><span class="n">device_issue_pending</span> <span class="o">=</span> <span class="n">pl08x_issue_pending</span><span class="p">;</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">.</span><span class="n">device_prep_slave_sg</span> <span class="o">=</span> <span class="n">pl08x_prep_slave_sg</span><span class="p">;</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">.</span><span class="n">device_control</span> <span class="o">=</span> <span class="n">pl08x_control</span><span class="p">;</span>

	<span class="cm">/* Get the platform data */</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">pd</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no platform data supplied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_no_platdata</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Assign useful pointers to the driver state */</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span> <span class="o">=</span> <span class="n">adev</span><span class="p">;</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">vd</span> <span class="o">=</span> <span class="n">vd</span><span class="p">;</span>

	<span class="cm">/* By default, AHB1 only.  If dualmaster, from platform */</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">lli_buses</span> <span class="o">=</span> <span class="n">PL08X_AHB1</span><span class="p">;</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">mem_buses</span> <span class="o">=</span> <span class="n">PL08X_AHB1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">vd</span><span class="o">-&gt;</span><span class="n">dualmaster</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">lli_buses</span> <span class="o">=</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lli_buses</span><span class="p">;</span>
		<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">mem_buses</span> <span class="o">=</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">mem_buses</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* A DMA memory pool for LLIs, align on 1-byte boundary */</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">pool</span> <span class="o">=</span> <span class="n">dma_pool_create</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">PL08X_LLI_TSFR_SIZE</span><span class="p">,</span> <span class="n">PL08X_ALIGN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_no_lli_pool</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_no_ioremap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Turn on the PL08x */</span>
	<span class="n">pl08x_ensure_on</span><span class="p">(</span><span class="n">pl08x</span><span class="p">);</span>

	<span class="cm">/* Attach the interrupt handler */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x000000FF</span><span class="p">,</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_ERR_CLEAR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x000000FF</span><span class="p">,</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_TC_CLEAR</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pl08x_irq</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span>
			  <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">pl08x</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s failed to request interrupt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">goto</span> <span class="n">out_no_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize physical channels */</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">phy_chans</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">((</span><span class="n">vd</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">phy_chans</span><span class="p">)),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">phy_chans</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s failed to allocate &quot;</span>
			<span class="s">&quot;physical channel holders</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_no_phychans</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pl08x_phy_chan</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">phy_chans</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_Cx_BASE</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Nomadik variants can have channels that are locked</span>
<span class="cm">		 * down for the secure world only. Lock up these channels</span>
<span class="cm">		 * by perpetually serving a dummy virtual channel.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vd</span><span class="o">-&gt;</span><span class="n">nomadik</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

			<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">PL080_CH_CONFIG</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PL080N_CONFIG_ITPROT</span> <span class="o">|</span> <span class="n">PL080N_CONFIG_SECPROT</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;physical channel %d reserved for secure access only</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;physical channel %d is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i</span><span class="p">,</span> <span class="n">pl08x_phy_channel_busy</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;BUSY&quot;</span> <span class="o">:</span> <span class="s">&quot;FREE&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Register as many memcpy channels as there are physical channels */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pl08x_dma_init_virtual_channels</span><span class="p">(</span><span class="n">pl08x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">memcpy</span><span class="p">,</span>
					      <span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">vd</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;%s failed to enumerate memcpy channels - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_no_memcpy</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">memcpy</span><span class="p">.</span><span class="n">chancnt</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Register slave channels */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pl08x_dma_init_virtual_channels</span><span class="p">(</span><span class="n">pl08x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">,</span>
			<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">num_slave_channels</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s failed to enumerate slave channels - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_no_slave</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">.</span><span class="n">chancnt</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_async_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">memcpy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s failed to register memcpy as an async device - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_no_memcpy_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_async_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s failed to register slave as an async device - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_no_slave_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">amba_set_drvdata</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="n">pl08x</span><span class="p">);</span>
	<span class="n">init_pl08x_debugfs</span><span class="p">(</span><span class="n">pl08x</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA: PL%03x rev%u at 0x%08llx irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">amba_part</span><span class="p">(</span><span class="n">adev</span><span class="p">),</span> <span class="n">amba_rev</span><span class="p">(</span><span class="n">adev</span><span class="p">),</span>
		 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_no_slave_reg:</span>
	<span class="n">dma_async_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">memcpy</span><span class="p">);</span>
<span class="nl">out_no_memcpy_reg:</span>
	<span class="n">pl08x_free_virtual_channels</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">);</span>
<span class="nl">out_no_slave:</span>
	<span class="n">pl08x_free_virtual_channels</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">memcpy</span><span class="p">);</span>
<span class="nl">out_no_memcpy:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">phy_chans</span><span class="p">);</span>
<span class="nl">out_no_phychans:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pl08x</span><span class="p">);</span>
<span class="nl">out_no_irq:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">out_no_ioremap:</span>
	<span class="n">dma_pool_destroy</span><span class="p">(</span><span class="n">pl08x</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">);</span>
<span class="nl">out_no_lli_pool:</span>
<span class="nl">out_no_platdata:</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pl08x</span><span class="p">);</span>
<span class="nl">out_no_pl08x:</span>
	<span class="n">amba_release_regions</span><span class="p">(</span><span class="n">adev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* PL080 has 8 channels and the PL080 have just 2 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">vendor_data</span> <span class="n">vendor_pl080</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dualmaster</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vendor_data</span> <span class="n">vendor_nomadik</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dualmaster</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nomadik</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vendor_data</span> <span class="n">vendor_pl081</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dualmaster</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">amba_id</span> <span class="n">pl08x_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* PL080 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mh">0x00041080</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span>	<span class="o">=</span> <span class="mh">0x000fffff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">vendor_pl080</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* PL081 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mh">0x00041081</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span>	<span class="o">=</span> <span class="mh">0x000fffff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">vendor_pl081</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Nomadik 8815 PL080 variant */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mh">0x00280080</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span>	<span class="o">=</span> <span class="mh">0x00ffffff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">vendor_nomadik</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">amba</span><span class="p">,</span> <span class="n">pl08x_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">amba_driver</span> <span class="n">pl08x_amba_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">drv</span><span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">pl08x_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">pl08x_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pl08x_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">amba_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl08x_amba_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRIVER_NAME</span>
		       <span class="s">&quot;failed to register as an AMBA device (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">retval</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">pl08x_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
