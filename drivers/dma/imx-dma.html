<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › dma › imx-dma.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>imx-dma.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/dma/imx-dma.c</span>
<span class="cm"> *</span>
<span class="cm"> * This file contains a driver for the Freescale i.MX DMA engine</span>
<span class="cm"> * found on i.MX1/21/27</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2010 Sascha Hauer, Pengutronix &lt;s.hauer@pengutronix.de&gt;</span>
<span class="cm"> * Copyright 2012 Javier Martin, Vista Silicon &lt;javier.martin@vista-silicon.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * The code contained herein is licensed under the GNU General Public</span>
<span class="cm"> * License. You may obtain a copy of the GNU General Public License</span>
<span class="cm"> * Version 2 or later at the following locations:</span>
<span class="cm"> *</span>
<span class="cm"> * http://www.opensource.org/licenses/gpl-license.html</span>
<span class="cm"> * http://www.gnu.org/copyleft/gpl.html</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;mach/dma.h&gt;</span>
<span class="cp">#include &lt;mach/hardware.h&gt;</span>

<span class="cp">#include &quot;dmaengine.h&quot;</span>
<span class="cp">#define IMXDMA_MAX_CHAN_DESCRIPTORS	16</span>
<span class="cp">#define IMX_DMA_CHANNELS  16</span>

<span class="cp">#define IMX_DMA_2D_SLOTS	2</span>
<span class="cp">#define IMX_DMA_2D_SLOT_A	0</span>
<span class="cp">#define IMX_DMA_2D_SLOT_B	1</span>

<span class="cp">#define IMX_DMA_LENGTH_LOOP	((unsigned int)-1)</span>
<span class="cp">#define IMX_DMA_MEMSIZE_32	(0 &lt;&lt; 4)</span>
<span class="cp">#define IMX_DMA_MEMSIZE_8	(1 &lt;&lt; 4)</span>
<span class="cp">#define IMX_DMA_MEMSIZE_16	(2 &lt;&lt; 4)</span>
<span class="cp">#define IMX_DMA_TYPE_LINEAR	(0 &lt;&lt; 10)</span>
<span class="cp">#define IMX_DMA_TYPE_2D		(1 &lt;&lt; 10)</span>
<span class="cp">#define IMX_DMA_TYPE_FIFO	(2 &lt;&lt; 10)</span>

<span class="cp">#define IMX_DMA_ERR_BURST     (1 &lt;&lt; 0)</span>
<span class="cp">#define IMX_DMA_ERR_REQUEST   (1 &lt;&lt; 1)</span>
<span class="cp">#define IMX_DMA_ERR_TRANSFER  (1 &lt;&lt; 2)</span>
<span class="cp">#define IMX_DMA_ERR_BUFFER    (1 &lt;&lt; 3)</span>
<span class="cp">#define IMX_DMA_ERR_TIMEOUT   (1 &lt;&lt; 4)</span>

<span class="cp">#define DMA_DCR     0x00		</span><span class="cm">/* Control Register */</span><span class="cp"></span>
<span class="cp">#define DMA_DISR    0x04		</span><span class="cm">/* Interrupt status Register */</span><span class="cp"></span>
<span class="cp">#define DMA_DIMR    0x08		</span><span class="cm">/* Interrupt mask Register */</span><span class="cp"></span>
<span class="cp">#define DMA_DBTOSR  0x0c		</span><span class="cm">/* Burst timeout status Register */</span><span class="cp"></span>
<span class="cp">#define DMA_DRTOSR  0x10		</span><span class="cm">/* Request timeout Register */</span><span class="cp"></span>
<span class="cp">#define DMA_DSESR   0x14		</span><span class="cm">/* Transfer Error Status Register */</span><span class="cp"></span>
<span class="cp">#define DMA_DBOSR   0x18		</span><span class="cm">/* Buffer overflow status Register */</span><span class="cp"></span>
<span class="cp">#define DMA_DBTOCR  0x1c		</span><span class="cm">/* Burst timeout control Register */</span><span class="cp"></span>
<span class="cp">#define DMA_WSRA    0x40		</span><span class="cm">/* W-Size Register A */</span><span class="cp"></span>
<span class="cp">#define DMA_XSRA    0x44		</span><span class="cm">/* X-Size Register A */</span><span class="cp"></span>
<span class="cp">#define DMA_YSRA    0x48		</span><span class="cm">/* Y-Size Register A */</span><span class="cp"></span>
<span class="cp">#define DMA_WSRB    0x4c		</span><span class="cm">/* W-Size Register B */</span><span class="cp"></span>
<span class="cp">#define DMA_XSRB    0x50		</span><span class="cm">/* X-Size Register B */</span><span class="cp"></span>
<span class="cp">#define DMA_YSRB    0x54		</span><span class="cm">/* Y-Size Register B */</span><span class="cp"></span>
<span class="cp">#define DMA_SAR(x)  (0x80 + ((x) &lt;&lt; 6))	</span><span class="cm">/* Source Address Registers */</span><span class="cp"></span>
<span class="cp">#define DMA_DAR(x)  (0x84 + ((x) &lt;&lt; 6))	</span><span class="cm">/* Destination Address Registers */</span><span class="cp"></span>
<span class="cp">#define DMA_CNTR(x) (0x88 + ((x) &lt;&lt; 6))	</span><span class="cm">/* Count Registers */</span><span class="cp"></span>
<span class="cp">#define DMA_CCR(x)  (0x8c + ((x) &lt;&lt; 6))	</span><span class="cm">/* Control Registers */</span><span class="cp"></span>
<span class="cp">#define DMA_RSSR(x) (0x90 + ((x) &lt;&lt; 6))	</span><span class="cm">/* Request source select Registers */</span><span class="cp"></span>
<span class="cp">#define DMA_BLR(x)  (0x94 + ((x) &lt;&lt; 6))	</span><span class="cm">/* Burst length Registers */</span><span class="cp"></span>
<span class="cp">#define DMA_RTOR(x) (0x98 + ((x) &lt;&lt; 6))	</span><span class="cm">/* Request timeout Registers */</span><span class="cp"></span>
<span class="cp">#define DMA_BUCR(x) (0x98 + ((x) &lt;&lt; 6))	</span><span class="cm">/* Bus Utilization Registers */</span><span class="cp"></span>
<span class="cp">#define DMA_CCNR(x) (0x9C + ((x) &lt;&lt; 6))	</span><span class="cm">/* Channel counter Registers */</span><span class="cp"></span>

<span class="cp">#define DCR_DRST           (1&lt;&lt;1)</span>
<span class="cp">#define DCR_DEN            (1&lt;&lt;0)</span>
<span class="cp">#define DBTOCR_EN          (1&lt;&lt;15)</span>
<span class="cp">#define DBTOCR_CNT(x)      ((x) &amp; 0x7fff)</span>
<span class="cp">#define CNTR_CNT(x)        ((x) &amp; 0xffffff)</span>
<span class="cp">#define CCR_ACRPT          (1&lt;&lt;14)</span>
<span class="cp">#define CCR_DMOD_LINEAR    (0x0 &lt;&lt; 12)</span>
<span class="cp">#define CCR_DMOD_2D        (0x1 &lt;&lt; 12)</span>
<span class="cp">#define CCR_DMOD_FIFO      (0x2 &lt;&lt; 12)</span>
<span class="cp">#define CCR_DMOD_EOBFIFO   (0x3 &lt;&lt; 12)</span>
<span class="cp">#define CCR_SMOD_LINEAR    (0x0 &lt;&lt; 10)</span>
<span class="cp">#define CCR_SMOD_2D        (0x1 &lt;&lt; 10)</span>
<span class="cp">#define CCR_SMOD_FIFO      (0x2 &lt;&lt; 10)</span>
<span class="cp">#define CCR_SMOD_EOBFIFO   (0x3 &lt;&lt; 10)</span>
<span class="cp">#define CCR_MDIR_DEC       (1&lt;&lt;9)</span>
<span class="cp">#define CCR_MSEL_B         (1&lt;&lt;8)</span>
<span class="cp">#define CCR_DSIZ_32        (0x0 &lt;&lt; 6)</span>
<span class="cp">#define CCR_DSIZ_8         (0x1 &lt;&lt; 6)</span>
<span class="cp">#define CCR_DSIZ_16        (0x2 &lt;&lt; 6)</span>
<span class="cp">#define CCR_SSIZ_32        (0x0 &lt;&lt; 4)</span>
<span class="cp">#define CCR_SSIZ_8         (0x1 &lt;&lt; 4)</span>
<span class="cp">#define CCR_SSIZ_16        (0x2 &lt;&lt; 4)</span>
<span class="cp">#define CCR_REN            (1&lt;&lt;3)</span>
<span class="cp">#define CCR_RPT            (1&lt;&lt;2)</span>
<span class="cp">#define CCR_FRC            (1&lt;&lt;1)</span>
<span class="cp">#define CCR_CEN            (1&lt;&lt;0)</span>
<span class="cp">#define RTOR_EN            (1&lt;&lt;15)</span>
<span class="cp">#define RTOR_CLK           (1&lt;&lt;14)</span>
<span class="cp">#define RTOR_PSC           (1&lt;&lt;13)</span>

<span class="k">enum</span>  <span class="n">imxdma_prep_type</span> <span class="p">{</span>
	<span class="n">IMXDMA_DESC_MEMCPY</span><span class="p">,</span>
	<span class="n">IMXDMA_DESC_INTERLEAVED</span><span class="p">,</span>
	<span class="n">IMXDMA_DESC_SLAVE_SG</span><span class="p">,</span>
	<span class="n">IMXDMA_DESC_CYCLIC</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">imx_dma_2d_config</span> <span class="p">{</span>
	<span class="n">u16</span>		<span class="n">xsr</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">ysr</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">wsr</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">count</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">imxdma_desc</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span>	<span class="n">desc</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_status</span>			<span class="n">status</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>			<span class="n">src</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>			<span class="n">dest</span><span class="p">;</span>
	<span class="kt">size_t</span>				<span class="n">len</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_transfer_direction</span>	<span class="n">direction</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">imxdma_prep_type</span>		<span class="n">type</span><span class="p">;</span>
	<span class="cm">/* For memcpy and interleaved */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">config_port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">config_mem</span><span class="p">;</span>
	<span class="cm">/* For interleaved transfers */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">x</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">y</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">w</span><span class="p">;</span>
	<span class="cm">/* For slave sg and cyclic */</span>
	<span class="k">struct</span> <span class="n">scatterlist</span>		<span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">sgcount</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="p">{</span>
	<span class="kt">int</span>				<span class="n">hw_chaining</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>		<span class="n">watchdog</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imxdma_engine</span>		<span class="o">*</span><span class="n">imxdma</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">channel</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">tasklet_struct</span>		<span class="n">dma_tasklet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">ld_free</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">ld_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">ld_active</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">descs_allocated</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_slave_buswidth</span>		<span class="n">word_size</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>			<span class="n">per_address</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">watermark_level</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span>			<span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span>	<span class="n">desc</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_status</span>			<span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">dma_request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span>		<span class="o">*</span><span class="n">sg_list</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">ccr_from_device</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">ccr_to_device</span><span class="p">;</span>
	<span class="n">bool</span>				<span class="n">enabled_2d</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">slot_2d</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span>			<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_dma_parameters</span>	<span class="n">dma_parms</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_device</span>		<span class="n">dma_device</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>			<span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>			<span class="o">*</span><span class="n">dma_clk</span><span class="p">;</span>
	<span class="n">spinlock_t</span>			<span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imx_dma_2d_config</span>	<span class="n">slots_2d</span><span class="p">[</span><span class="n">IMX_DMA_2D_SLOTS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">imxdma_channel</span>		<span class="n">channel</span><span class="p">[</span><span class="n">IMX_DMA_CHANNELS</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="nf">to_imxdma_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imxdma_channel</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">imxdma_chan_is_doing_cyclic</span><span class="p">(</span><span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="n">imxdmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_active</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_active</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imxdma_desc</span><span class="p">,</span>
					<span class="n">node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IMXDMA_DESC_CYCLIC</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">void</span> <span class="nf">imx_dmav1_writel</span><span class="p">(</span><span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">val</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">imx_dmav1_readl</span><span class="p">(</span><span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imxdma_hw_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="n">imxdmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_mx27</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">hw_chaining</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * imxdma_sg_next - prepare next chunk for scatter-gather DMA emulation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">imxdma_sg_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">imxdma_desc</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="n">imxdmac</span> <span class="o">=</span> <span class="n">to_imxdma_chan</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">imxdma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span><span class="p">;</span>

	<span class="n">now</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="n">IMX_DMA_LENGTH_LOOP</span><span class="p">)</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-=</span> <span class="n">now</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">)</span>
		<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">dma_address</span><span class="p">,</span>
				 <span class="n">DMA_DAR</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">dma_address</span><span class="p">,</span>
				 <span class="n">DMA_SAR</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>

	<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">DMA_CNTR</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; %s channel: %d dst 0x%08x, src 0x%08x, &quot;</span>
		<span class="s">&quot;size 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
		 <span class="n">imx_dmav1_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DMA_DAR</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)),</span>
		 <span class="n">imx_dmav1_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DMA_SAR</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)),</span>
		 <span class="n">imx_dmav1_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DMA_CNTR</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)));</span>

	<span class="k">return</span> <span class="n">now</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">imxdma_enable_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">imxdma_desc</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="n">imxdmac</span> <span class="o">=</span> <span class="n">to_imxdma_chan</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">imxdma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">,</span> <span class="n">DMA_DISR</span><span class="p">);</span>
	<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">imx_dmav1_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DMA_DIMR</span><span class="p">)</span> <span class="o">&amp;</span>
			 <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">),</span> <span class="n">DMA_DIMR</span><span class="p">);</span>
	<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">imx_dmav1_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DMA_CCR</span><span class="p">(</span><span class="n">channel</span><span class="p">))</span> <span class="o">|</span>
			 <span class="n">CCR_CEN</span> <span class="o">|</span> <span class="n">CCR_ACRPT</span><span class="p">,</span> <span class="n">DMA_CCR</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cpu_is_mx21</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_mx27</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">&amp;&amp;</span> <span class="n">imxdma_hw_chain</span><span class="p">(</span><span class="n">imxdmac</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">imxdma_sg_next</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">imx_dmav1_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DMA_CCR</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
			<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">CCR_RPT</span> <span class="o">|</span> <span class="n">CCR_ACRPT</span><span class="p">,</span>
					 <span class="n">DMA_CCR</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">imxdma_disable_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="n">imxdmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">imxdma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">imxdma_hw_chain</span><span class="p">(</span><span class="n">imxdmac</span><span class="p">))</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">);</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">imx_dmav1_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DMA_DIMR</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">),</span> <span class="n">DMA_DIMR</span><span class="p">);</span>
	<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">imx_dmav1_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DMA_CCR</span><span class="p">(</span><span class="n">channel</span><span class="p">))</span> <span class="o">&amp;</span>
			 <span class="o">~</span><span class="n">CCR_CEN</span><span class="p">,</span> <span class="n">DMA_CCR</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
	<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">,</span> <span class="n">DMA_DISR</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">imxdma_watchdog</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="n">imxdmac</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">imxdma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_CCR</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>

	<span class="cm">/* Tasklet watchdog error handler */</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">dma_tasklet</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;channel %d: watchdog timeout!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">imxdma_err_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">disr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">errcode</span><span class="p">;</span>

	<span class="n">disr</span> <span class="o">=</span> <span class="n">imx_dmav1_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DMA_DISR</span><span class="p">);</span>

	<span class="n">err_mask</span> <span class="o">=</span> <span class="n">imx_dmav1_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DMA_DBTOSR</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">imx_dmav1_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DMA_DRTOSR</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">imx_dmav1_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DMA_DSESR</span><span class="p">)</span>  <span class="o">|</span>
		   <span class="n">imx_dmav1_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DMA_DBOSR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err_mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">disr</span> <span class="o">&amp;</span> <span class="n">err_mask</span><span class="p">,</span> <span class="n">DMA_DISR</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IMX_DMA_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">errcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">imx_dmav1_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DMA_DBTOSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">,</span> <span class="n">DMA_DBTOSR</span><span class="p">);</span>
			<span class="n">errcode</span> <span class="o">|=</span> <span class="n">IMX_DMA_ERR_BURST</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imx_dmav1_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DMA_DRTOSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">,</span> <span class="n">DMA_DRTOSR</span><span class="p">);</span>
			<span class="n">errcode</span> <span class="o">|=</span> <span class="n">IMX_DMA_ERR_REQUEST</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imx_dmav1_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DMA_DSESR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">,</span> <span class="n">DMA_DSESR</span><span class="p">);</span>
			<span class="n">errcode</span> <span class="o">|=</span> <span class="n">IMX_DMA_ERR_TRANSFER</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imx_dmav1_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DMA_DBOSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">,</span> <span class="n">DMA_DBOSR</span><span class="p">);</span>
			<span class="n">errcode</span> <span class="o">|=</span> <span class="n">IMX_DMA_ERR_BUFFER</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Tasklet error handler */</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma_tasklet</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;DMA timeout on channel %d -%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
		       <span class="n">errcode</span> <span class="o">&amp;</span> <span class="n">IMX_DMA_ERR_BURST</span> <span class="o">?</span>    <span class="s">&quot; burst&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="n">errcode</span> <span class="o">&amp;</span> <span class="n">IMX_DMA_ERR_REQUEST</span> <span class="o">?</span>  <span class="s">&quot; request&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="n">errcode</span> <span class="o">&amp;</span> <span class="n">IMX_DMA_ERR_TRANSFER</span> <span class="o">?</span> <span class="s">&quot; transfer&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="n">errcode</span> <span class="o">&amp;</span> <span class="n">IMX_DMA_ERR_BUFFER</span> <span class="o">?</span>   <span class="s">&quot; buffer&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_irq_handle_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="n">imxdmac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">imxdma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chno</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imxdma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_active</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_active</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">imxdma_desc</span><span class="p">,</span>
				<span class="n">node</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">imxdma_sg_next</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">imx_dmav1_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DMA_CCR</span><span class="p">(</span><span class="n">chno</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">imxdma_hw_chain</span><span class="p">(</span><span class="n">imxdmac</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* FIXME: The timeout should probably be</span>
<span class="cm">				 * configurable</span>
<span class="cm">				 */</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">,</span>
					<span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">500</span><span class="p">));</span>

				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">CCR_CEN</span> <span class="o">|</span> <span class="n">CCR_RPT</span> <span class="o">|</span> <span class="n">CCR_ACRPT</span><span class="p">;</span>
				<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">DMA_CCR</span><span class="p">(</span><span class="n">chno</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CCR_CEN</span><span class="p">,</span>
						 <span class="n">DMA_CCR</span><span class="p">(</span><span class="n">chno</span><span class="p">));</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">CCR_CEN</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">DMA_CCR</span><span class="p">(</span><span class="n">chno</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">imxdma_chan_is_doing_cyclic</span><span class="p">(</span><span class="n">imxdmac</span><span class="p">))</span>
				<span class="cm">/* Tasklet progression */</span>
				<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">dma_tasklet</span><span class="p">);</span>

			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">imxdma_hw_chain</span><span class="p">(</span><span class="n">imxdmac</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_CCR</span><span class="p">(</span><span class="n">chno</span><span class="p">));</span>
	<span class="cm">/* Tasklet irq */</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">dma_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">dma_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">disr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_mx21</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_mx27</span><span class="p">())</span>
		<span class="n">imxdma_err_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">);</span>

	<span class="n">disr</span> <span class="o">=</span> <span class="n">imx_dmav1_readl</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DMA_DISR</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s called, disr=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">disr</span><span class="p">);</span>

	<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">disr</span><span class="p">,</span> <span class="n">DMA_DISR</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IMX_DMA_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">disr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">dma_irq_handle_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imxdma_xfer_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">imxdma_desc</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="n">imxdmac</span> <span class="o">=</span> <span class="n">to_imxdma_chan</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">imxdma</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Configure and enable */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IMXDMA_DESC_INTERLEAVED</span>:
		<span class="cm">/* Try to get a free 2D slot */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IMX_DMA_2D_SLOTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">slots_2d</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">slots_2d</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xsr</span> <span class="o">!=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">slots_2d</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ysr</span> <span class="o">!=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">slots_2d</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wsr</span> <span class="o">!=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">slot</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">slots_2d</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">xsr</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span>
		<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">slots_2d</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">ysr</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">;</span>
		<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">slots_2d</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">wsr</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">;</span>
		<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">slots_2d</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>

		<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">slot_2d</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
		<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">enabled_2d</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">==</span> <span class="n">IMX_DMA_2D_SLOT_A</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">config_mem</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CCR_MSEL_B</span><span class="p">;</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">config_port</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CCR_MSEL_B</span><span class="p">;</span>
			<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">DMA_XSRA</span><span class="p">);</span>
			<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">DMA_YSRA</span><span class="p">);</span>
			<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">,</span> <span class="n">DMA_WSRA</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">config_mem</span> <span class="o">|=</span> <span class="n">CCR_MSEL_B</span><span class="p">;</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">config_port</span> <span class="o">|=</span> <span class="n">CCR_MSEL_B</span><span class="p">;</span>
			<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">DMA_XSRB</span><span class="p">);</span>
			<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">DMA_YSRB</span><span class="p">);</span>
			<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">,</span> <span class="n">DMA_WSRB</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * We fall-through here intentionally, since a 2D transfer is</span>
<span class="cm">		 * similar to MEMCPY just adding the 2D slot configuration.</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">IMXDMA_DESC_MEMCPY</span>:
		<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">DMA_SAR</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>
		<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">,</span> <span class="n">DMA_DAR</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>
		<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">config_mem</span> <span class="o">|</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">config_port</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
			 <span class="n">DMA_CCR</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>

		<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_CNTR</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s channel: %d dest=0x%08x src=0x%08x &quot;</span>
			<span class="s">&quot;dma_length=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* Cyclic transfer is the same as slave_sg with special sg configuration. */</span>
	<span class="k">case</span> <span class="n">IMXDMA_DESC_CYCLIC</span>:
	<span class="k">case</span> <span class="n">IMXDMA_DESC_SLAVE_SG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">per_address</span><span class="p">,</span>
					 <span class="n">DMA_SAR</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>
			<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ccr_from_device</span><span class="p">,</span>
					 <span class="n">DMA_CCR</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s channel: %d sg=%p sgcount=%d &quot;</span>
				<span class="s">&quot;total length=%d dev_addr=0x%08x (dev2mem)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">sgcount</span><span class="p">,</span>
				<span class="n">d</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">per_address</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">per_address</span><span class="p">,</span>
					 <span class="n">DMA_DAR</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>
			<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ccr_to_device</span><span class="p">,</span>
					 <span class="n">DMA_CCR</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s channel: %d sg=%p sgcount=%d &quot;</span>
				<span class="s">&quot;total length=%d dev_addr=0x%08x (mem2dev)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">sgcount</span><span class="p">,</span>
				<span class="n">d</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">per_address</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s channel: %d bad dma mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">imxdma_sg_next</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">imxdma_enable_hw</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">imxdma_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="n">imxdmac</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">imxdma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imxdma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_active</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Someone might have called terminate all */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_active</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imxdma_desc</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">callback</span><span class="p">)</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">callback</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">callback_param</span><span class="p">);</span>

	<span class="cm">/* If we are dealing with a cyclic descriptor keep it on ld_active</span>
<span class="cm">	 * and dont mark the descripor as complete.</span>
<span class="cm">	 * Only in non-cyclic cases it would be marked as complete</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">imxdma_chan_is_doing_cyclic</span><span class="p">(</span><span class="n">imxdmac</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dma_cookie_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>

	<span class="cm">/* Free 2D slot if it was an interleaved transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">enabled_2d</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">slots_2d</span><span class="p">[</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">slot_2d</span><span class="p">].</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">enabled_2d</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_move_tail</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_active</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_free</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imxdma_desc</span><span class="p">,</span>
					<span class="n">node</span><span class="p">);</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_active</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imxdma_xfer_desc</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: channel: %d couldn&#39;t xfer desc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imxdma_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_ctrl_cmd</span> <span class="n">cmd</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="n">imxdmac</span> <span class="o">=</span> <span class="n">to_imxdma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dma_slave_config</span> <span class="o">*</span><span class="n">dmaengine_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">imxdma</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMA_TERMINATE_ALL</span>:
		<span class="n">imxdma_disable_hw</span><span class="p">(</span><span class="n">imxdmac</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_active</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_free</span><span class="p">);</span>
		<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_free</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_SLAVE_CONFIG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dmaengine_cfg</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">per_address</span> <span class="o">=</span> <span class="n">dmaengine_cfg</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">;</span>
			<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">watermark_level</span> <span class="o">=</span> <span class="n">dmaengine_cfg</span><span class="o">-&gt;</span><span class="n">src_maxburst</span><span class="p">;</span>
			<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">word_size</span> <span class="o">=</span> <span class="n">dmaengine_cfg</span><span class="o">-&gt;</span><span class="n">src_addr_width</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">per_address</span> <span class="o">=</span> <span class="n">dmaengine_cfg</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">;</span>
			<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">watermark_level</span> <span class="o">=</span> <span class="n">dmaengine_cfg</span><span class="o">-&gt;</span><span class="n">dst_maxburst</span><span class="p">;</span>
			<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">word_size</span> <span class="o">=</span> <span class="n">dmaengine_cfg</span><span class="o">-&gt;</span><span class="n">dst_addr_width</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">word_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DMA_SLAVE_BUSWIDTH_1_BYTE</span>:
			<span class="n">mode</span> <span class="o">=</span> <span class="n">IMX_DMA_MEMSIZE_8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMA_SLAVE_BUSWIDTH_2_BYTES</span>:
			<span class="n">mode</span> <span class="o">=</span> <span class="n">IMX_DMA_MEMSIZE_16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">DMA_SLAVE_BUSWIDTH_4_BYTES</span>:
			<span class="n">mode</span> <span class="o">=</span> <span class="n">IMX_DMA_MEMSIZE_32</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">hw_chaining</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">imxdma_hw_chain</span><span class="p">(</span><span class="n">imxdmac</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ccr_from_device</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">|</span> <span class="n">IMX_DMA_TYPE_FIFO</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">IMX_DMA_MEMSIZE_32</span> <span class="o">|</span> <span class="n">IMX_DMA_TYPE_LINEAR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">CCR_REN</span><span class="p">;</span>
		<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ccr_to_device</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">IMX_DMA_MEMSIZE_32</span> <span class="o">|</span> <span class="n">IMX_DMA_TYPE_LINEAR</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">mode</span> <span class="o">|</span> <span class="n">IMX_DMA_TYPE_FIFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">CCR_REN</span><span class="p">;</span>
		<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">dma_request</span><span class="p">,</span>
				 <span class="n">DMA_RSSR</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>

		<span class="cm">/* Set burst length */</span>
		<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">watermark_level</span> <span class="o">*</span>
				<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">word_size</span><span class="p">,</span> <span class="n">DMA_BLR</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">dma_status</span> <span class="nf">imxdma_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
					    <span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">dma_tx_state</span> <span class="o">*</span><span class="n">txstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dma_cookie_status</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">txstate</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">dma_cookie_t</span> <span class="nf">imxdma_tx_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="n">imxdmac</span> <span class="o">=</span> <span class="n">to_imxdma_chan</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">imxdma</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_move_tail</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_free</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_queue</span><span class="p">);</span>
	<span class="n">cookie</span> <span class="o">=</span> <span class="n">dma_cookie_assign</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cookie</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imxdma_alloc_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="n">imxdmac</span> <span class="o">=</span> <span class="n">to_imxdma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">imx_dma_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">dma_request</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dma_request</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">descs_allocated</span> <span class="o">&lt;</span> <span class="n">IMXDMA_MAX_CHAN_DESCRIPTORS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">imxdma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

		<span class="n">desc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">__memzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span><span class="p">));</span>
		<span class="n">dma_async_tx_descriptor_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">tx_submit</span> <span class="o">=</span> <span class="n">imxdma_tx_submit</span><span class="p">;</span>
		<span class="cm">/* txd.flags will be overwritten in prep funcs */</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DMA_CTRL_ACK</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DMA_SUCCESS</span><span class="p">;</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_free</span><span class="p">);</span>
		<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">descs_allocated</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">descs_allocated</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">descs_allocated</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">imxdma_free_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="n">imxdmac</span> <span class="o">=</span> <span class="n">to_imxdma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">imxdma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imxdma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">_desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">imxdma_disable_hw</span><span class="p">(</span><span class="n">imxdmac</span><span class="p">);</span>
	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_active</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_free</span><span class="p">);</span>
	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_free</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_free</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
		<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">descs_allocated</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_free</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">);</span>
		<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">sg_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">imxdma_prep_slave_sg</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sgl</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">direction</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="n">imxdmac</span> <span class="o">=</span> <span class="n">to_imxdma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">dma_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imxdma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_free</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">imxdma_chan_is_doing_cyclic</span><span class="p">(</span><span class="n">imxdmac</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_free</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imxdma_desc</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_length</span> <span class="o">+=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">word_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMA_SLAVE_BUSWIDTH_4_BYTES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sgl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">sgl</span><span class="o">-&gt;</span><span class="n">dma_address</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_SLAVE_BUSWIDTH_2_BYTES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sgl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">sgl</span><span class="o">-&gt;</span><span class="n">dma_address</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_SLAVE_BUSWIDTH_1_BYTE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">IMXDMA_DESC_SLAVE_SG</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sgl</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">sgcount</span> <span class="o">=</span> <span class="n">sg_len</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">dma_length</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">per_address</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dest</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">per_address</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">callback_param</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">imxdma_prep_dma_cyclic</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buf_len</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">period_len</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">direction</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="n">imxdmac</span> <span class="o">=</span> <span class="n">to_imxdma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">imxdma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imxdma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">periods</span> <span class="o">=</span> <span class="n">buf_len</span> <span class="o">/</span> <span class="n">period_len</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s channel: %d buf_len=%d period_len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">period_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_free</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">imxdma_chan_is_doing_cyclic</span><span class="p">(</span><span class="n">imxdmac</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_free</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imxdma_desc</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">);</span>

	<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">sg_list</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">periods</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">,</span> <span class="n">periods</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">periods</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page_link</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma_address</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
		<span class="n">sg_dma_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">=</span> <span class="n">period_len</span><span class="p">;</span>
		<span class="n">dma_addr</span> <span class="o">+=</span> <span class="n">period_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* close the loop */</span>
	<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">periods</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sg_dma_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">periods</span><span class="p">])</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">periods</span><span class="p">].</span><span class="n">page_link</span> <span class="o">=</span>
		<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">sg_list</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x02</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">IMXDMA_DESC_CYCLIC</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">sgcount</span> <span class="o">=</span> <span class="n">periods</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">IMX_DMA_LENGTH_LOOP</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">per_address</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dest</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">per_address</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">callback_param</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">imxdma_prep_dma_memcpy</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dest</span><span class="p">,</span>
	<span class="n">dma_addr_t</span> <span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="n">imxdmac</span> <span class="o">=</span> <span class="n">to_imxdma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">imxdma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imxdma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s channel: %d src=0x%x dst=0x%x len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_free</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">imxdma_chan_is_doing_cyclic</span><span class="p">(</span><span class="n">imxdmac</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_free</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imxdma_desc</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">IMXDMA_DESC_MEMCPY</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dest</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_MEM_TO_MEM</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">config_port</span> <span class="o">=</span> <span class="n">IMX_DMA_MEMSIZE_32</span> <span class="o">|</span> <span class="n">IMX_DMA_TYPE_LINEAR</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">config_mem</span> <span class="o">=</span> <span class="n">IMX_DMA_MEMSIZE_32</span> <span class="o">|</span> <span class="n">IMX_DMA_TYPE_LINEAR</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">callback_param</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">imxdma_prep_dma_interleaved</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_interleaved_template</span> <span class="o">*</span><span class="n">xt</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="n">imxdmac</span> <span class="o">=</span> <span class="n">to_imxdma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">imxdma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imxdma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s channel: %d src_start=0x%x dst_start=0x%x</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;   src_sgl=%s dst_sgl=%s numf=%d frame_size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">xt</span><span class="o">-&gt;</span><span class="n">src_start</span><span class="p">,</span> <span class="n">xt</span><span class="o">-&gt;</span><span class="n">dst_start</span><span class="p">,</span>
		<span class="n">xt</span><span class="o">-&gt;</span><span class="n">src_sgl</span> <span class="o">?</span> <span class="s">&quot;true&quot;</span> <span class="o">:</span> <span class="s">&quot;false&quot;</span><span class="p">,</span> <span class="n">xt</span><span class="o">-&gt;</span><span class="n">dst_sgl</span> <span class="o">?</span> <span class="s">&quot;true&quot;</span> <span class="o">:</span> <span class="s">&quot;false&quot;</span><span class="p">,</span>
		<span class="n">xt</span><span class="o">-&gt;</span><span class="n">numf</span><span class="p">,</span> <span class="n">xt</span><span class="o">-&gt;</span><span class="n">frame_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_free</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">imxdma_chan_is_doing_cyclic</span><span class="p">(</span><span class="n">imxdmac</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xt</span><span class="o">-&gt;</span><span class="n">frame_size</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">xt</span><span class="o">-&gt;</span><span class="n">numf</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">xt</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">!=</span> <span class="n">DMA_MEM_TO_MEM</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_free</span><span class="p">,</span> <span class="k">struct</span> <span class="n">imxdma_desc</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">IMXDMA_DESC_INTERLEAVED</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">=</span> <span class="n">xt</span><span class="o">-&gt;</span><span class="n">src_start</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dest</span> <span class="o">=</span> <span class="n">xt</span><span class="o">-&gt;</span><span class="n">dst_start</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="n">xt</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="n">xt</span><span class="o">-&gt;</span><span class="n">numf</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">=</span> <span class="n">xt</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">icg</span> <span class="o">+</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">*</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_MEM_TO_MEM</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">config_port</span> <span class="o">=</span> <span class="n">IMX_DMA_MEMSIZE_32</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">config_mem</span> <span class="o">=</span> <span class="n">IMX_DMA_MEMSIZE_32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xt</span><span class="o">-&gt;</span><span class="n">src_sgl</span><span class="p">)</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">config_mem</span> <span class="o">|=</span> <span class="n">IMX_DMA_TYPE_2D</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xt</span><span class="o">-&gt;</span><span class="n">dst_sgl</span><span class="p">)</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">config_port</span> <span class="o">|=</span> <span class="n">IMX_DMA_TYPE_2D</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">callback_param</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">imxdma_issue_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="n">imxdmac</span> <span class="o">=</span> <span class="n">to_imxdma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span> <span class="o">=</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">imxdma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">imxdma_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_active</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_queue</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">imxdma_desc</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">imxdma_xfer_desc</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;%s: channel: %d couldn&#39;t issue DMA xfer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_active</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">imxdma_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>


	<span class="n">imxdma</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">imxdma</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">imxdma</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_mx1</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">MX1_IO_ADDRESS</span><span class="p">(</span><span class="n">MX1_DMA_BASE_ADDR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_mx21</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">MX21_IO_ADDRESS</span><span class="p">(</span><span class="n">MX21_DMA_BASE_ADDR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_mx27</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">MX27_IO_ADDRESS</span><span class="p">(</span><span class="n">MX27_DMA_BASE_ADDR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">imxdma</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;dma&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_clk</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_clk</span><span class="p">);</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_clk</span><span class="p">);</span>

	<span class="cm">/* reset DMA module */</span>
	<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DCR_DRST</span><span class="p">,</span> <span class="n">DMA_DCR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_mx1</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">MX1_DMA_INT</span><span class="p">,</span> <span class="n">dma_irq_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;DMA&quot;</span><span class="p">,</span> <span class="n">imxdma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t register IRQ for DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">imxdma</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">MX1_DMA_ERR</span><span class="p">,</span> <span class="n">imxdma_err_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;DMA&quot;</span><span class="p">,</span> <span class="n">imxdma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t register ERRIRQ for DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">MX1_DMA_INT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">imxdma</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* enable DMA module */</span>
	<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="n">DCR_DEN</span><span class="p">,</span> <span class="n">DMA_DCR</span><span class="p">);</span>

	<span class="cm">/* clear all interrupts */</span>
	<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IMX_DMA_CHANNELS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_DISR</span><span class="p">);</span>

	<span class="cm">/* disable interrupts */</span>
	<span class="n">imx_dmav1_writel</span><span class="p">(</span><span class="n">imxdma</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IMX_DMA_CHANNELS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_DIMR</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">channels</span><span class="p">);</span>

	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_CYCLIC</span><span class="p">,</span> <span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_INTERLEAVE</span><span class="p">,</span> <span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>

	<span class="cm">/* Initialize 2D global parameters */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IMX_DMA_2D_SLOTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">slots_2d</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Initialize channel parameters */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IMX_DMA_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">imxdma_channel</span> <span class="o">*</span><span class="n">imxdmac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_mx21</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_mx27</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">MX2x_INT_DMACH0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
					<span class="n">dma_irq_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;DMA&quot;</span><span class="p">,</span> <span class="n">imxdma</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t register IRQ %d &quot;</span>
					 <span class="s">&quot;for DMA channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">MX2x_INT_DMACH0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err_init</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">);</span>
			<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">imxdma_watchdog</span><span class="p">;</span>
			<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">imxdmac</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">imxdma</span> <span class="o">=</span> <span class="n">imxdma</span><span class="p">;</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_queue</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_free</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">ld_active</span><span class="p">);</span>

		<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">dma_tasklet</span><span class="p">,</span> <span class="n">imxdma_tasklet</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">imxdmac</span><span class="p">);</span>
		<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">;</span>
		<span class="n">dma_cookie_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* Add the channel to the DMAC list */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdmac</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">.</span><span class="n">device_node</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">channels</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">device_alloc_chan_resources</span> <span class="o">=</span> <span class="n">imxdma_alloc_chan_resources</span><span class="p">;</span>
	<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">device_free_chan_resources</span> <span class="o">=</span> <span class="n">imxdma_free_chan_resources</span><span class="p">;</span>
	<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">device_tx_status</span> <span class="o">=</span> <span class="n">imxdma_tx_status</span><span class="p">;</span>
	<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">device_prep_slave_sg</span> <span class="o">=</span> <span class="n">imxdma_prep_slave_sg</span><span class="p">;</span>
	<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">device_prep_dma_cyclic</span> <span class="o">=</span> <span class="n">imxdma_prep_dma_cyclic</span><span class="p">;</span>
	<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">device_prep_dma_memcpy</span> <span class="o">=</span> <span class="n">imxdma_prep_dma_memcpy</span><span class="p">;</span>
	<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">device_prep_interleaved_dma</span> <span class="o">=</span> <span class="n">imxdma_prep_dma_interleaved</span><span class="p">;</span>
	<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">device_control</span> <span class="o">=</span> <span class="n">imxdma_control</span><span class="p">;</span>
	<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">device_issue_pending</span> <span class="o">=</span> <span class="n">imxdma_issue_pending</span><span class="p">;</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">imxdma</span><span class="p">);</span>

	<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">copy_align</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* 2^2 = 4 bytes alignment */</span>
	<span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_parms</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_parms</span><span class="p">;</span>
	<span class="n">dma_set_max_seg_size</span><span class="p">(</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xffffff</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_async_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_init</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_init:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_mx21</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_mx27</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">MX2x_INT_DMACH0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">cpu_is_mx1</span><span class="p">()</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">MX1_DMA_INT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">MX1_DMA_ERR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">imxdma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">imxdma_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imxdma_engine</span> <span class="o">*</span><span class="n">imxdma</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

        <span class="n">dma_async_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma</span><span class="o">-&gt;</span><span class="n">dma_device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_mx21</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_mx27</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IMX_DMA_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">MX2x_INT_DMACH0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">cpu_is_mx1</span><span class="p">()</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">MX1_DMA_INT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">MX1_DMA_ERR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

        <span class="n">kfree</span><span class="p">(</span><span class="n">imxdma</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">imxdma_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;imx-dma&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">imxdma_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">imxdma_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imxdma_driver</span><span class="p">,</span> <span class="n">imxdma_probe</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">imxdma_module_init</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Sascha Hauer, Pengutronix &lt;s.hauer@pengutronix.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;i.MX dma driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
