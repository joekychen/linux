<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › dma › ppc4xx › adma.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>adma.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2006-2009 DENX Software Engineering.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Yuri Tikhonov &lt;yur@emcraft.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Further porting to arch/powerpc by</span>
<span class="cm"> * 	Anatolij Gustschin &lt;agust@denx.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the Free</span>
<span class="cm"> * Software Foundation; either version 2 of the License, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc., 59</span>
<span class="cm"> * Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution in the</span>
<span class="cm"> * file called COPYING.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This driver supports the asynchrounous DMA copy and RAID engines available</span>
<span class="cm"> * on the AMCC PPC440SPe Processors.</span>
<span class="cm"> * Based on the Intel Xscale(R) family of I/O Processors (IOP 32x, 33x, 134x)</span>
<span class="cm"> * ADMA driver written by D.Williams.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/async_tx.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>
<span class="cp">#include &lt;asm/dcr.h&gt;</span>
<span class="cp">#include &lt;asm/dcr-regs.h&gt;</span>
<span class="cp">#include &quot;adma.h&quot;</span>
<span class="cp">#include &quot;../dmaengine.h&quot;</span>

<span class="k">enum</span> <span class="n">ppc_adma_init_code</span> <span class="p">{</span>
	<span class="n">PPC_ADMA_INIT_OK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">PPC_ADMA_INIT_MEMRES</span><span class="p">,</span>
	<span class="n">PPC_ADMA_INIT_MEMREG</span><span class="p">,</span>
	<span class="n">PPC_ADMA_INIT_ALLOC</span><span class="p">,</span>
	<span class="n">PPC_ADMA_INIT_COHERENT</span><span class="p">,</span>
	<span class="n">PPC_ADMA_INIT_CHANNEL</span><span class="p">,</span>
	<span class="n">PPC_ADMA_INIT_IRQ1</span><span class="p">,</span>
	<span class="n">PPC_ADMA_INIT_IRQ2</span><span class="p">,</span>
	<span class="n">PPC_ADMA_INIT_REGISTER</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ppc_adma_errors</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">PPC_ADMA_INIT_OK</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;ok&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PPC_ADMA_INIT_MEMRES</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;failed to get memory resource&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PPC_ADMA_INIT_MEMREG</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;failed to request memory region&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PPC_ADMA_INIT_ALLOC</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;failed to allocate memory for adev &quot;</span>
				<span class="s">&quot;structure&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PPC_ADMA_INIT_COHERENT</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;failed to allocate coherent memory for &quot;</span>
				   <span class="s">&quot;hardware descriptors&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PPC_ADMA_INIT_CHANNEL</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;failed to allocate memory for channel&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PPC_ADMA_INIT_IRQ1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;failed to request first irq&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PPC_ADMA_INIT_IRQ2</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;failed to request second irq&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PPC_ADMA_INIT_REGISTER</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;failed to register dma async device&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">ppc_adma_init_code</span>
<span class="n">ppc440spe_adma_devices</span><span class="p">[</span><span class="n">PPC440SPE_ADMA_ENGINES_NUM</span><span class="p">];</span>

<span class="k">struct</span> <span class="n">ppc_dma_chan_ref</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* The list of channels exported by ppc440spe ADMA */</span>
<span class="k">struct</span> <span class="n">list_head</span>
<span class="n">ppc440spe_adma_chan_list</span> <span class="o">=</span> <span class="n">LIST_HEAD_INIT</span><span class="p">(</span><span class="n">ppc440spe_adma_chan_list</span><span class="p">);</span>

<span class="cm">/* This flag is set when want to refetch the xor chain in the interrupt</span>
<span class="cm"> * handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">do_xor_refetch</span><span class="p">;</span>

<span class="cm">/* Pointer to DMA0, DMA1 CP/CS FIFO */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ppc440spe_dma_fifo_buf</span><span class="p">;</span>

<span class="cm">/* Pointers to last submitted to DMA0, DMA1 CDBs */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">chan_last_sub</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">chan_first_cdb</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

<span class="cm">/* Pointer to last linked and submitted xor CB */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">xor_last_linked</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">xor_last_submit</span><span class="p">;</span>

<span class="cm">/* This array is used in data-check operations for storing a pattern */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">ppc440spe_qword</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">ppc440spe_adma_err_irq_ref</span><span class="p">;</span>
<span class="k">static</span> <span class="n">dcr_host_t</span> <span class="n">ppc440spe_mq_dcr_host</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ppc440spe_mq_dcr_len</span><span class="p">;</span>

<span class="cm">/* Since RXOR operations use the common register (MQ0_CF2H) for setting-up</span>
<span class="cm"> * the block size in transactions, then we do not allow to activate more than</span>
<span class="cm"> * only one RXOR transactions simultaneously. So use this var to store</span>
<span class="cm"> * the information about is RXOR currently active (PPC440SPE_RXOR_RUN bit is</span>
<span class="cm"> * set) or not (PPC440SPE_RXOR_RUN is clear).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ppc440spe_rxor_state</span><span class="p">;</span>

<span class="cm">/* These are used in enable &amp; check routines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">ppc440spe_r6_enabled</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">ppc440spe_r6_tchan</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">completion</span> <span class="n">ppc440spe_r6_test_comp</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ppc440spe_adma_dma2rxor_prep_src</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ppc440spe_rxor</span> <span class="o">*</span><span class="n">cursor</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ppc440spe_adma_dma2rxor_set_src</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ppc440spe_adma_dma2rxor_set_mult</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mult</span><span class="p">);</span>

<span class="cp">#ifdef ADMA_LL_DEBUG</span>
<span class="cp">#define ADMA_LL_DBG(x) ({ if (1) x; 0; })</span>
<span class="cp">#else</span>
<span class="cp">#define ADMA_LL_DBG(x) ({ if (0) x; 0; })</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">cdb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xor_cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">cdb</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;CDB at %p [%d]:</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s"> attr 0x%02x opc 0x%02x cnt 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s"> sg1u 0x%08x sg1l 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s"> sg2u 0x%08x sg2l 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s"> sg3u 0x%08x sg3l 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cdb</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			<span class="n">cdb</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">,</span> <span class="n">cdb</span><span class="o">-&gt;</span><span class="n">opc</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cdb</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">),</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cdb</span><span class="o">-&gt;</span><span class="n">sg1u</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cdb</span><span class="o">-&gt;</span><span class="n">sg1l</span><span class="p">),</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cdb</span><span class="o">-&gt;</span><span class="n">sg2u</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cdb</span><span class="o">-&gt;</span><span class="n">sg2l</span><span class="p">),</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cdb</span><span class="o">-&gt;</span><span class="n">sg3u</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cdb</span><span class="o">-&gt;</span><span class="n">sg3l</span><span class="p">)</span>
		<span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">cb</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;CB at %p [%d]:</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s"> cbc 0x%08x cbbc 0x%08x cbs 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s"> cbtah 0x%08x cbtal 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s"> cblah 0x%08x cblal 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cb</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">cbc</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">cbbc</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">cbs</span><span class="p">,</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">cbtah</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">cbtal</span><span class="p">,</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">cblah</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">cblal</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">h</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s"> ops[%2d]: h 0x%08x l 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">h</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_cb_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">iter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">iter</span><span class="p">;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="p">)</span>
		<span class="n">print_cb</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prep_dma_xor_dbg</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dst</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%s(%d):</span><span class="se">\n</span><span class="s">src: &quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">src_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">0x%016llx &quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dst:</span><span class="se">\n\t</span><span class="s">0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prep_dma_pq_dbg</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%s(%d):</span><span class="se">\n</span><span class="s">src: &quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">src_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">0x%016llx &quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dst: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">0x%016llx &quot;</span><span class="p">,</span> <span class="n">dst</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prep_dma_pqzero_sum_dbg</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src_cnt</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">scf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%s(%d):</span><span class="se">\n</span><span class="s">src(coef): &quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">src_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">0x%016llx(0x%02x) &quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">scf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">src_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">0x%016llx(no) &quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dst: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">0x%016llx &quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">[</span><span class="n">src_cnt</span> <span class="o">+</span> <span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * Command (Descriptor) Blocks low-level routines</span>
<span class="cm"> ******************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_init_interrupt - initialize the descriptor for INTERRUPT</span>
<span class="cm"> * pseudo operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_desc_init_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xor_cb</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="n">p</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xor_cb</span><span class="p">));</span>
		<span class="cm">/* NOP with Command Block Complete Enable */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">cbc</span> <span class="o">=</span> <span class="n">XOR_CBCR_CBCE_BIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="n">memset</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span><span class="p">));</span>
		<span class="cm">/* NOP with interrupt */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unsupported id %d in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_init_null_xor - initialize the descriptor for NULL XOR</span>
<span class="cm"> * pseudo operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_desc_init_null_xor</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xor_cb</span><span class="p">));</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_init_xor - initialize the descriptor for XOR operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_desc_init_xor</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xor_cb</span> <span class="o">*</span><span class="n">hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xor_cb</span><span class="p">));</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_cnt</span> <span class="o">=</span> <span class="n">src_cnt</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">cbc</span> <span class="o">=</span> <span class="n">XOR_CBCR_TGT_BIT</span> <span class="o">|</span> <span class="n">src_cnt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_INTERRUPT</span><span class="p">)</span>
		<span class="cm">/* Enable interrupt on completion */</span>
		<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">cbc</span> <span class="o">|=</span> <span class="n">XOR_CBCR_CBCE_BIT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_init_dma2pq - initialize the descriptor for PQ</span>
<span class="cm"> * operation in DMA2 controller</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_desc_init_dma2pq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">dst_cnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xor_cb</span> <span class="o">*</span><span class="n">hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xor_cb</span><span class="p">));</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_cnt</span> <span class="o">=</span> <span class="n">src_cnt</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">=</span> <span class="n">dst_cnt</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">reverse_flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">reverse_flags</span><span class="p">));</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">descs_per_op</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">cbc</span> <span class="o">=</span> <span class="n">XOR_CBCR_TGT_BIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_INTERRUPT</span><span class="p">)</span>
		<span class="cm">/* Enable interrupt on completion */</span>
		<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">cbc</span> <span class="o">|=</span> <span class="n">XOR_CBCR_CBCE_BIT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DMA_CTRL_FLAGS_LAST	DMA_PREP_FENCE</span>
<span class="cp">#define DMA_PREP_ZERO_P		(DMA_CTRL_FLAGS_LAST &lt;&lt; 1)</span>
<span class="cp">#define DMA_PREP_ZERO_Q		(DMA_PREP_ZERO_P &lt;&lt; 1)</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_init_dma01pq - initialize the descriptors for PQ operation</span>
<span class="cm"> * with DMA0/1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_desc_init_dma01pq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">dst_cnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">hw_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dopc</span><span class="p">;</span>

	<span class="cm">/* Common initialization of a PQ descriptors chain */</span>
	<span class="n">set_bits</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_cnt</span> <span class="o">=</span> <span class="n">src_cnt</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">=</span> <span class="n">dst_cnt</span><span class="p">;</span>

	<span class="cm">/* WXOR MULTICAST if both P and Q are being computed</span>
<span class="cm">	 * MV_SG1_SG2 if Q only</span>
<span class="cm">	 */</span>
	<span class="n">dopc</span> <span class="o">=</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">==</span> <span class="n">DMA_DEST_MAX_NUM</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">DMA_CDB_OPC_MULTICAST</span> <span class="o">:</span> <span class="n">DMA_CDB_OPC_MV_SG1_SG2</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span> <span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_desc</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">list_is_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* set &#39;next&#39; pointer */</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span> <span class="n">chain_node</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* this is the last descriptor.</span>
<span class="cm">			 * this slot will be pasted from ADMA level</span>
<span class="cm">			 * each time it wants to configure parameters</span>
<span class="cm">			 * of the transaction (src, dst, ...)</span>
<span class="cm">			 */</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_INTERRUPT</span><span class="p">)</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set OPS depending on WXOR/RXOR type of operation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* This is a WXOR only chain:</span>
<span class="cm">		 * - first descriptors are for zeroing destinations</span>
<span class="cm">		 *   if PPC440SPE_ZERO_P/Q set;</span>
<span class="cm">		 * - descriptors remained are for GF-XOR operations.</span>
<span class="cm">		 */</span>
		<span class="n">iter</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
					<span class="n">chain_node</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hw_desc</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
			<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span> <span class="o">=</span> <span class="n">DMA_CDB_OPC_MV_SG1_SG2</span><span class="p">;</span>
			<span class="n">iter</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
					<span class="n">chain_node</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_Q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hw_desc</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
			<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span> <span class="o">=</span> <span class="n">DMA_CDB_OPC_MV_SG1_SG2</span><span class="p">;</span>
			<span class="n">iter</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
					<span class="n">chain_node</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">list_for_each_entry_from</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span> <span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw_desc</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
			<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span> <span class="o">=</span> <span class="n">dopc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* This is either RXOR-only or mixed RXOR/WXOR */</span>

		<span class="cm">/* The first 1 or 2 slots in chain are always RXOR,</span>
<span class="cm">		 * if need to calculate P &amp; Q, then there are two</span>
<span class="cm">		 * RXOR slots; if only P or only Q, then there is one</span>
<span class="cm">		 */</span>
		<span class="n">iter</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
					<span class="n">chain_node</span><span class="p">);</span>
		<span class="n">hw_desc</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span> <span class="o">=</span> <span class="n">DMA_CDB_OPC_MV_SG1_SG2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">==</span> <span class="n">DMA_DEST_MAX_NUM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iter</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
						<span class="n">chain_node</span><span class="p">);</span>
			<span class="n">hw_desc</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
			<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span> <span class="o">=</span> <span class="n">DMA_CDB_OPC_MV_SG1_SG2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* The remaining descs (if any) are WXORs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_WXOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">iter</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
						<span class="n">chain_node</span><span class="p">);</span>
			<span class="n">list_for_each_entry_from</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span>
						<span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hw_desc</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
				<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span> <span class="o">=</span> <span class="n">dopc</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_init_dma01pqzero_sum - initialize the descriptor</span>
<span class="cm"> * for PQ_ZERO_SUM operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_desc_init_dma01pqzero_sum</span><span class="p">(</span>
				<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">dst_cnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">hw_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dopc</span> <span class="o">=</span> <span class="p">(</span><span class="n">dst_cnt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="n">DMA_CDB_OPC_MULTICAST</span> <span class="o">:</span>
				   <span class="n">DMA_CDB_OPC_MV_SG1_SG2</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Initialize starting from 2nd or 3rd descriptor dependent</span>
<span class="cm">	 * on dst_cnt. First one or two slots are for cloning P</span>
<span class="cm">	 * and/or Q to chan-&gt;pdest and/or chan-&gt;qdest as we have</span>
<span class="cm">	 * to preserve original P/Q.</span>
<span class="cm">	 */</span>
	<span class="n">iter</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span> <span class="n">chain_node</span><span class="p">);</span>
	<span class="n">iter</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span> <span class="n">chain_node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dst_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iter</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span> <span class="n">chain_node</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* initialize each source descriptor in chain */</span>
	<span class="n">list_for_each_entry_from</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span> <span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_desc</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span><span class="p">));</span>
		<span class="n">iter</span><span class="o">-&gt;</span><span class="n">src_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">iter</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* This is a ZERO_SUM operation:</span>
<span class="cm">		 * - &lt;src_cnt&gt; descriptors starting from 2nd or 3rd</span>
<span class="cm">		 *   descriptor are for GF-XOR operations;</span>
<span class="cm">		 * - remaining &lt;dst_cnt&gt; descriptors are for checking the result</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">src_cnt</span><span class="p">)</span>
			<span class="cm">/* MV_SG1_SG2 if only Q is being verified</span>
<span class="cm">			 * MULTICAST if both P and Q are being verified</span>
<span class="cm">			 */</span>
			<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span> <span class="o">=</span> <span class="n">dopc</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="cm">/* DMA_CDB_OPC_DCHECK128 operation */</span>
			<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span> <span class="o">=</span> <span class="n">DMA_CDB_OPC_DCHECK128</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">list_is_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* set &#39;next&#39; pointer */</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
						<span class="n">chain_node</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* this is the last descriptor.</span>
<span class="cm">			 * this slot will be pasted from ADMA level</span>
<span class="cm">			 * each time it wants to configure parameters</span>
<span class="cm">			 * of the transaction (src, dst, ...)</span>
<span class="cm">			 */</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="cm">/* always enable interrupt generation since we get</span>
<span class="cm">			 * the status of pqzero from the handler</span>
<span class="cm">			 */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_cnt</span> <span class="o">=</span> <span class="n">src_cnt</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">=</span> <span class="n">dst_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_init_memcpy - initialize the descriptor for MEMCPY operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_desc_init_memcpy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span><span class="p">));</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_INTERRUPT</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span> <span class="o">=</span> <span class="n">DMA_CDB_OPC_MV_SG1_SG2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_init_memset - initialize the descriptor for MEMSET operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_desc_init_memset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span><span class="p">));</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_INTERRUPT</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">sg1u</span> <span class="o">=</span> <span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">sg1l</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">value</span><span class="p">);</span>
	<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">sg3u</span> <span class="o">=</span> <span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">sg3l</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">value</span><span class="p">);</span>
	<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span> <span class="o">=</span> <span class="n">DMA_CDB_OPC_DFILL128</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_set_src_addr - set source address into the descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_desc_set_src_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">src_idx</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">addrh</span><span class="p">,</span>
					<span class="n">dma_addr_t</span> <span class="n">addrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">dma_hw_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xor_cb</span> <span class="o">*</span><span class="n">xor_hw_desc</span><span class="p">;</span>
	<span class="n">phys_addr_t</span> <span class="n">addr64</span><span class="p">,</span> <span class="n">tmplow</span><span class="p">,</span> <span class="n">tmphi</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addrh</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr64</span> <span class="o">=</span> <span class="n">addrl</span><span class="p">;</span>
			<span class="n">tmphi</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr64</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">tmplow</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr64</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tmphi</span> <span class="o">=</span> <span class="n">addrh</span><span class="p">;</span>
			<span class="n">tmplow</span> <span class="o">=</span> <span class="n">addrl</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dma_hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg1l</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">tmplow</span><span class="p">);</span>
		<span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg1u</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">tmphi</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="n">xor_hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="n">xor_hw_desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">src_idx</span><span class="p">].</span><span class="n">l</span> <span class="o">=</span> <span class="n">addrl</span><span class="p">;</span>
		<span class="n">xor_hw_desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">src_idx</span><span class="p">].</span><span class="n">h</span> <span class="o">|=</span> <span class="n">addrh</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_set_src_mult - set source address mult into the descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_desc_set_src_mult</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mult_index</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">sg_index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mult_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">dma_hw_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xor_cb</span> <span class="o">*</span><span class="n">xor_hw_desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">psgu</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="n">dma_hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">sg_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* for RXOR operations set multiplier</span>
<span class="cm">		 * into source cued address</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">DMA_CDB_SG_SRC</span>:
			<span class="n">psgu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg1u</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* for WXOR operations set multiplier</span>
<span class="cm">		 * into destination cued address(es)</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">DMA_CDB_SG_DST1</span>:
			<span class="n">psgu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg2u</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMA_CDB_SG_DST2</span>:
			<span class="n">psgu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg3u</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">psgu</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mult_value</span> <span class="o">&lt;&lt;</span> <span class="n">mult_index</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="n">xor_hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_set_dest_addr - set destination address into the descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				<span class="n">dma_addr_t</span> <span class="n">addrh</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">addrl</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">dst_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">dma_hw_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xor_cb</span> <span class="o">*</span><span class="n">xor_hw_desc</span><span class="p">;</span>
	<span class="n">phys_addr_t</span> <span class="n">addr64</span><span class="p">,</span> <span class="n">tmphi</span><span class="p">,</span> <span class="n">tmplow</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">psgu</span><span class="p">,</span> <span class="o">*</span><span class="n">psgl</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addrh</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr64</span> <span class="o">=</span> <span class="n">addrl</span><span class="p">;</span>
			<span class="n">tmphi</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr64</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">tmplow</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr64</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tmphi</span> <span class="o">=</span> <span class="n">addrh</span><span class="p">;</span>
			<span class="n">tmplow</span> <span class="o">=</span> <span class="n">addrl</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dma_hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>

		<span class="n">psgu</span> <span class="o">=</span> <span class="n">dst_idx</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg3u</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg2u</span><span class="p">;</span>
		<span class="n">psgl</span> <span class="o">=</span> <span class="n">dst_idx</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg3l</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg2l</span><span class="p">;</span>

		<span class="o">*</span><span class="n">psgl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">tmplow</span><span class="p">);</span>
		<span class="o">*</span><span class="n">psgu</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">tmphi</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="n">xor_hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="n">xor_hw_desc</span><span class="o">-&gt;</span><span class="n">cbtal</span> <span class="o">=</span> <span class="n">addrl</span><span class="p">;</span>
		<span class="n">xor_hw_desc</span><span class="o">-&gt;</span><span class="n">cbtah</span> <span class="o">|=</span> <span class="n">addrh</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_set_byte_count - set number of data bytes involved</span>
<span class="cm"> * into the operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_desc_set_byte_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">byte_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">dma_hw_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xor_cb</span> <span class="o">*</span><span class="n">xor_hw_desc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="n">dma_hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">byte_count</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="n">xor_hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="n">xor_hw_desc</span><span class="o">-&gt;</span><span class="n">cbbc</span> <span class="o">=</span> <span class="n">byte_count</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_set_rxor_block_size - set RXOR block size</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ppc440spe_desc_set_rxor_block_size</span><span class="p">(</span><span class="n">u32</span> <span class="n">byte_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* assume that byte_count is aligned on the 512-boundary;</span>
<span class="cm">	 * thus write it directly to the register (bits 23:31 are</span>
<span class="cm">	 * reserved there).</span>
<span class="cm">	 */</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">ppc440spe_mq_dcr_host</span><span class="p">,</span> <span class="n">DCRN_MQ0_CF2H</span><span class="p">,</span> <span class="n">byte_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_set_dcheck - set CHECK pattern</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_desc_set_dcheck</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">qword</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">dma_hw_desc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="n">dma_hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">qword</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg3l</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">qword</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg3u</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">qword</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg2l</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">qword</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg2u</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_xor_set_link - set link address in xor CB</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_xor_set_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">prev_desc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">next_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xor_cb</span> <span class="o">*</span><span class="n">xor_hw_desc</span> <span class="o">=</span> <span class="n">prev_desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">next_desc</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">next_desc</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: next_desc=0x%p; next_desc-&gt;phys=0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">next_desc</span><span class="p">,</span>
			<span class="n">next_desc</span> <span class="o">?</span> <span class="n">next_desc</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">xor_hw_desc</span><span class="o">-&gt;</span><span class="n">cbs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xor_hw_desc</span><span class="o">-&gt;</span><span class="n">cblal</span> <span class="o">=</span> <span class="n">next_desc</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">xor_hw_desc</span><span class="o">-&gt;</span><span class="n">cblah</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xor_hw_desc</span><span class="o">-&gt;</span><span class="n">cbc</span> <span class="o">|=</span> <span class="n">XOR_CBCR_LNK_BIT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_set_link - set the address of descriptor following this</span>
<span class="cm"> * descriptor in chain</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_desc_set_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">prev_desc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">next_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">tail</span> <span class="o">=</span> <span class="n">next_desc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">prev_desc</span> <span class="o">||</span> <span class="o">!</span><span class="n">next_desc</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">prev_desc</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">&amp;&amp;</span> <span class="n">prev_desc</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">!=</span> <span class="n">next_desc</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* If previous next is overwritten something is wrong.</span>
<span class="cm">		 * though we may refetch from append to initiate list</span>
<span class="cm">		 * processing; in this case - it&#39;s ok.</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: prev_desc=0x%p; next_desc=0x%p; &quot;</span>
			<span class="s">&quot;prev-&gt;hw_next=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">prev_desc</span><span class="p">,</span>
			<span class="n">next_desc</span><span class="p">,</span> <span class="n">prev_desc</span> <span class="o">?</span> <span class="n">prev_desc</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* do s/w chaining both for DMA and XOR descriptors */</span>
	<span class="n">prev_desc</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span> <span class="n">next_desc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="cm">/* bind descriptor to the chain */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="p">)</span>
			<span class="n">tail</span> <span class="o">=</span> <span class="n">tail</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="p">;</span>
		<span class="n">xor_last_linked</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prev_desc</span> <span class="o">==</span> <span class="n">xor_last_submit</span><span class="p">)</span>
			<span class="cm">/* do not link to the last submitted CB */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ppc440spe_xor_set_link</span><span class="p">(</span><span class="n">prev_desc</span><span class="p">,</span> <span class="n">next_desc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_get_src_addr - extract the source address from the descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">ppc440spe_desc_get_src_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">dma_hw_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xor_cb</span> <span class="o">*</span><span class="n">xor_hw_desc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="n">dma_hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="cm">/* May have 0, 1, 2, or 3 sources */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DMA_CDB_OPC_NO_OP</span>:
		<span class="k">case</span> <span class="n">DMA_CDB_OPC_DFILL128</span>:
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMA_CDB_OPC_DCHECK128</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">src_idx</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: try to get %d source for&quot;</span>
				    <span class="s">&quot; DCHECK128</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">src_idx</span><span class="p">);</span>
				<span class="n">BUG</span><span class="p">();</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg1l</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">DMA_CDB_OPC_MULTICAST</span>:
		<span class="k">case</span> <span class="n">DMA_CDB_OPC_MV_SG1_SG2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">src_idx</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: try to get %d source from&quot;</span>
				    <span class="s">&quot; DMA descr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">src_idx</span><span class="p">);</span>
				<span class="n">BUG</span><span class="p">();</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">src_idx</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg1u</span><span class="p">)</span> <span class="o">&amp;</span>
				    <span class="n">DMA_CUED_XOR_WIN_MSK</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u8</span> <span class="n">region</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">src_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
						<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span>
						    <span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg1l</span><span class="p">)</span> <span class="o">+</span>
							<span class="n">desc</span><span class="o">-&gt;</span><span class="n">unmap_len</span><span class="p">;</span>

					<span class="n">region</span> <span class="o">=</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span>
					    <span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg1u</span><span class="p">))</span> <span class="o">&gt;&gt;</span>
						<span class="n">DMA_CUED_REGION_OFF</span><span class="p">;</span>

					<span class="n">region</span> <span class="o">&amp;=</span> <span class="n">DMA_CUED_REGION_MSK</span><span class="p">;</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">region</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="n">DMA_RXOR123</span>:
						<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span>
						    <span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg1l</span><span class="p">)</span> <span class="o">+</span>
							<span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">unmap_len</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
					<span class="k">case</span> <span class="n">DMA_RXOR124</span>:
						<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span>
						    <span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg1l</span><span class="p">)</span> <span class="o">+</span>
							<span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">unmap_len</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>
					<span class="k">case</span> <span class="n">DMA_RXOR125</span>:
						<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span>
						    <span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg1l</span><span class="p">)</span> <span class="o">+</span>
							<span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">unmap_len</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
					<span class="nl">default:</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
						    <span class="s">&quot;%s: try to&quot;</span>
						    <span class="s">&quot; get src3 for region %02x&quot;</span>
						    <span class="s">&quot;PPC440SPE_DESC_RXOR12?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						    <span class="n">__func__</span><span class="p">,</span> <span class="n">region</span><span class="p">);</span>
						<span class="n">BUG</span><span class="p">();</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
						<span class="s">&quot;%s: try to get %d&quot;</span>
						<span class="s">&quot; source for non-cued descr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">src_idx</span><span class="p">);</span>
					<span class="n">BUG</span><span class="p">();</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg1l</span><span class="p">);</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unknown OPC 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg1l</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="cm">/* May have up to 16 sources */</span>
		<span class="n">xor_hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">xor_hw_desc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">src_idx</span><span class="p">].</span><span class="n">l</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_get_dest_addr - extract the destination address from the</span>
<span class="cm"> * descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">ppc440spe_desc_get_dest_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">dma_hw_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xor_cb</span> <span class="o">*</span><span class="n">xor_hw_desc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="n">dma_hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">idx</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg2l</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg3l</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="n">xor_hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">xor_hw_desc</span><span class="o">-&gt;</span><span class="n">cbtal</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_get_src_num - extract the number of source addresses from</span>
<span class="cm"> * the descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">ppc440spe_desc_get_src_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">dma_hw_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xor_cb</span> <span class="o">*</span><span class="n">xor_hw_desc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="n">dma_hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DMA_CDB_OPC_NO_OP</span>:
		<span class="k">case</span> <span class="n">DMA_CDB_OPC_DFILL128</span>:
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMA_CDB_OPC_DCHECK128</span>:
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMA_CDB_OPC_MV_SG1_SG2</span>:
		<span class="k">case</span> <span class="n">DMA_CDB_OPC_MULTICAST</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Only for RXOR operations we have more than</span>
<span class="cm">			 * one source</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg1u</span><span class="p">)</span> <span class="o">&amp;</span>
			    <span class="n">DMA_CUED_XOR_WIN_MSK</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* RXOR op, there are 2 or 3 sources */</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">sg1u</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				    <span class="n">DMA_CUED_REGION_OFF</span><span class="p">)</span> <span class="o">&amp;</span>
				      <span class="n">DMA_CUED_REGION_MSK</span><span class="p">)</span> <span class="o">==</span> <span class="n">DMA_RXOR12</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* RXOR 1-2 */</span>
					<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* RXOR 1-2-3/1-2-4/1-2-5 */</span>
					<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unknown OPC 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="cm">/* up to 16 sources */</span>
		<span class="n">xor_hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">xor_hw_desc</span><span class="o">-&gt;</span><span class="n">cbc</span> <span class="o">&amp;</span> <span class="n">XOR_CDCR_OAC_MSK</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_get_dst_num - get the number of destination addresses in</span>
<span class="cm"> * this descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">ppc440spe_desc_get_dst_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">dma_hw_desc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="cm">/* May be 1 or 2 destinations */</span>
		<span class="n">dma_hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DMA_CDB_OPC_NO_OP</span>:
		<span class="k">case</span> <span class="n">DMA_CDB_OPC_DCHECK128</span>:
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMA_CDB_OPC_MV_SG1_SG2</span>:
		<span class="k">case</span> <span class="n">DMA_CDB_OPC_DFILL128</span>:
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMA_CDB_OPC_MULTICAST</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unknown OPC 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">dma_hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="cm">/* Always only 1 destination */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_get_link - get the address of the descriptor that</span>
<span class="cm"> * follows this one</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">ppc440spe_desc_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_is_aligned - check alignment</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ppc440spe_desc_is_aligned</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_slots</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">num_slots</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_chan_xor_slot_count - get the number of slots necessary for</span>
<span class="cm"> * XOR operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc440spe_chan_xor_slot_count</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_cnt</span><span class="p">,</span>
			<span class="kt">int</span> <span class="o">*</span><span class="n">slots_per_op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">slot_cnt</span><span class="p">;</span>

	<span class="cm">/* each XOR descriptor provides up to 16 source operands */</span>
	<span class="n">slot_cnt</span> <span class="o">=</span> <span class="o">*</span><span class="n">slots_per_op</span> <span class="o">=</span> <span class="p">(</span><span class="n">src_cnt</span> <span class="o">+</span> <span class="n">XOR_MAX_OPS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">XOR_MAX_OPS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">PPC440SPE_ADMA_XOR_MAX_BYTE_COUNT</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">slot_cnt</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: len %d &gt; max %d !!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PPC440SPE_ADMA_XOR_MAX_BYTE_COUNT</span><span class="p">);</span>
	<span class="n">BUG</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">slot_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_dma2_pq_slot_count - get the number of slots necessary for</span>
<span class="cm"> * DMA2 PQ operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc440spe_dma2_pq_slot_count</span><span class="p">(</span><span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">srcs</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">signed</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">addr_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">src_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">cur_addr</span> <span class="o">=</span> <span class="n">srcs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dma_addr_t</span> <span class="n">old_addr</span> <span class="o">=</span> <span class="n">srcs</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cur_addr</span> <span class="o">==</span> <span class="n">old_addr</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* direct RXOR */</span>
				<span class="n">order</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">src_cnt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
					<span class="n">addr_count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">old_addr</span> <span class="o">==</span> <span class="n">cur_addr</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* reverse RXOR */</span>
				<span class="n">order</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">src_cnt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
					<span class="n">addr_count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">state</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">src_cnt</span><span class="o">-</span><span class="mi">2</span> <span class="o">||</span> <span class="p">(</span><span class="n">order</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
				<span class="o">&amp;&amp;</span> <span class="n">cur_addr</span> <span class="o">!=</span> <span class="n">old_addr</span> <span class="o">-</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">addr_count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cur_addr</span> <span class="o">==</span> <span class="n">old_addr</span> <span class="o">+</span> <span class="n">len</span><span class="o">*</span><span class="n">order</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">src_cnt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
					<span class="n">addr_count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cur_addr</span> <span class="o">==</span> <span class="n">old_addr</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">src_cnt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
					<span class="n">addr_count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cur_addr</span> <span class="o">==</span> <span class="n">old_addr</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">src_cnt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
					<span class="n">addr_count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">addr_count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr_count</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">src_cnt</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">||</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: src_cnt=%d, state=%d, addr_count=%d, order=%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">addr_count</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">src_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[%d] 0x%llx </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">srcs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">addr_count</span> <span class="o">+</span> <span class="n">XOR_MAX_OPS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">XOR_MAX_OPS</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/******************************************************************************</span>
<span class="cm"> * ADMA channel low-level routines</span>
<span class="cm"> ******************************************************************************/</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="n">ppc440spe_chan_get_current_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ppc440spe_chan_append</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_device_clear_eot_status - interrupt ack to XOR or DMA engine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_device_clear_eot_status</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_regs</span> <span class="o">*</span><span class="n">dma_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xor_regs</span> <span class="o">*</span><span class="n">xor_reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma_desc_pool_virt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">cdb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rv</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="cm">/* read FIFO to ack */</span>
		<span class="n">dma_reg</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma_reg</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">rv</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_reg</span><span class="o">-&gt;</span><span class="n">csfpl</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">rv</span> <span class="o">&amp;</span> <span class="n">DMA_CDB_ADDR_MSK</span><span class="p">;</span>
			<span class="n">cdb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span>
			    <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma_desc_pool</span><span class="p">];</span>

			<span class="cm">/* Clear opcode to ack. This is necessary for</span>
<span class="cm">			 * ZeroSum operations only</span>
<span class="cm">			 */</span>
			<span class="n">cdb</span><span class="o">-&gt;</span><span class="n">opc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_RXOR_RUN</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">ppc440spe_rxor_state</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* probably this is a completed RXOR op,</span>
<span class="cm">				 * get pointer to CDB using the fact that</span>
<span class="cm">				 * physical and virtual addresses of CDB</span>
<span class="cm">				 * in pools have the same offsets</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cdb</span><span class="o">-&gt;</span><span class="n">sg1u</span><span class="p">)</span> <span class="o">&amp;</span>
				    <span class="n">DMA_CUED_XOR_BASE</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* this is a RXOR */</span>
					<span class="n">clear_bit</span><span class="p">(</span><span class="n">PPC440SPE_RXOR_RUN</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">ppc440spe_rxor_state</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&amp;</span> <span class="n">DMA_CDB_STATUS_MSK</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* ZeroSum check failed</span>
<span class="cm">				 */</span>
				<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
				<span class="n">dma_addr_t</span> <span class="n">phys</span> <span class="o">=</span> <span class="n">rv</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DMA_CDB_MSK</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * Update the status of corresponding</span>
<span class="cm">				 * descriptor.</span>
<span class="cm">				 */</span>
				<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">,</span>
				    <span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">==</span> <span class="n">phys</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/*</span>
<span class="cm">				 * if cannot find the corresponding</span>
<span class="cm">				 * slot it&#39;s a bug</span>
<span class="cm">				 */</span>
				<span class="n">BUG_ON</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">xor_check_result</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_PCHECK</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
						<span class="o">*</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">xor_check_result</span> <span class="o">|=</span>
							<span class="n">SUM_CHECK_P_RESULT</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_QCHECK</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
						<span class="o">*</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">xor_check_result</span> <span class="o">|=</span>
							<span class="n">SUM_CHECK_Q_RESULT</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">BUG</span><span class="p">();</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">rv</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_reg</span><span class="o">-&gt;</span><span class="n">dsts</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;DMA%d err status: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
			<span class="cm">/* write back to clear */</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_reg</span><span class="o">-&gt;</span><span class="n">dsts</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="cm">/* reset status bits to ack */</span>
		<span class="n">xor_reg</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">xor_reg</span><span class="p">;</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">);</span>
		<span class="n">iowrite32be</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XOR_IE_ICBIE_BIT</span><span class="o">|</span><span class="n">XOR_IE_ICIE_BIT</span><span class="o">|</span><span class="n">XOR_IE_RPTIE_BIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&amp;</span> <span class="n">XOR_IE_RPTIE_BIT</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Read PLB Timeout Error.</span>
<span class="cm">				 * Try to resubmit the CB</span>
<span class="cm">				 */</span>
				<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">ccbalr</span><span class="p">);</span>

				<span class="n">iowrite32be</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">cblalr</span><span class="p">);</span>

				<span class="n">val</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">);</span>
				<span class="n">iowrite32be</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">XOR_CRSR_XAE_BIT</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;XOR ERR 0x%x status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*  if the XORcore is idle, but there are unprocessed CBs</span>
<span class="cm">		 * then refetch the s/w chain here</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioread32be</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">XOR_SR_XCP_BIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">do_xor_refetch</span><span class="p">)</span>
			<span class="n">ppc440spe_chan_append</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_chan_is_busy - get the channel status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc440spe_chan_is_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_regs</span> <span class="o">*</span><span class="n">dma_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xor_regs</span> <span class="o">*</span><span class="n">xor_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="n">dma_reg</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma_reg</span><span class="p">;</span>
		<span class="cm">/*  if command FIFO&#39;s head and tail pointers are equal and</span>
<span class="cm">		 * status tail is the same as command, then channel is free</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioread16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_reg</span><span class="o">-&gt;</span><span class="n">cpfhp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ioread16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_reg</span><span class="o">-&gt;</span><span class="n">cpftp</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ioread16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_reg</span><span class="o">-&gt;</span><span class="n">cpftp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ioread16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_reg</span><span class="o">-&gt;</span><span class="n">csftp</span><span class="p">))</span>
			<span class="n">busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="cm">/* use the special status bit for the XORcore</span>
<span class="cm">		 */</span>
		<span class="n">xor_reg</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">xor_reg</span><span class="p">;</span>
		<span class="n">busy</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioread32be</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">XOR_SR_XCP_BIT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">busy</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_chan_set_first_xor_descriptor -  init XORcore chain</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_chan_set_first_xor_descriptor</span><span class="p">(</span>
				<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">next_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xor_regs</span> <span class="o">*</span><span class="n">xor_reg</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">xor_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioread32be</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">XOR_SR_XCP_BIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Warn: XORcore is running &quot;</span>
			<span class="s">&quot;when try to set the first CDB!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>

	<span class="n">xor_last_submit</span> <span class="o">=</span> <span class="n">xor_last_linked</span> <span class="o">=</span> <span class="n">next_desc</span><span class="p">;</span>

	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">XOR_CRSR_64BA_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">);</span>

	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">next_desc</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">cblalr</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">cblahr</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">ioread32be</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">cbcr</span><span class="p">)</span> <span class="o">|</span> <span class="n">XOR_CBCR_LNK_BIT</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">cbcr</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">hw_chain_inited</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_dma_put_desc - put DMA0,1 descriptor to FIFO.</span>
<span class="cm"> * called with irqs disabled</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_dma_put_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pcdb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_regs</span> <span class="o">*</span><span class="n">dma_reg</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma_reg</span><span class="p">;</span>

	<span class="n">pcdb</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">pcdb</span> <span class="o">|=</span> <span class="n">DMA_CDB_NO_INT</span><span class="p">;</span>

	<span class="n">chan_last_sub</span><span class="p">[</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>

	<span class="n">ADMA_LL_DBG</span><span class="p">(</span><span class="n">print_cb</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">));</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">pcdb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_reg</span><span class="o">-&gt;</span><span class="n">cpfpl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_chan_append - update the h/w chain in the channel</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_chan_append</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xor_regs</span> <span class="o">*</span><span class="n">xor_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xor_cb</span> <span class="o">*</span><span class="n">xcb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="n">cur_desc</span> <span class="o">=</span> <span class="n">ppc440spe_chan_get_current_descriptor</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">cur_desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">iter</span> <span class="o">=</span> <span class="n">chan_last_sub</span><span class="p">[</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">iter</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* first peer */</span>
			<span class="n">iter</span> <span class="o">=</span> <span class="n">chan_first_cdb</span><span class="p">[</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">iter</span><span class="p">);</span>
			<span class="n">ppc440spe_dma_put_desc</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">iter</span><span class="p">);</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">hw_chain_inited</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* is there something new to append */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* flush descriptors from the s/w queue to fifo */</span>
		<span class="n">list_for_each_entry_continue</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">,</span> <span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppc440spe_dma_put_desc</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">iter</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="cm">/* update h/w links and refetch */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xor_last_submit</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">xor_reg</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">xor_reg</span><span class="p">;</span>
		<span class="cm">/* the last linked CDB has to generate an interrupt</span>
<span class="cm">		 * that we&#39;d be able to append the next lists to h/w</span>
<span class="cm">		 * regardless of the XOR engine state at the moment of</span>
<span class="cm">		 * appending of these next lists</span>
<span class="cm">		 */</span>
		<span class="n">xcb</span> <span class="o">=</span> <span class="n">xor_last_linked</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="n">xcb</span><span class="o">-&gt;</span><span class="n">cbc</span> <span class="o">|=</span> <span class="n">XOR_CBCR_CBCE_BIT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioread32be</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">XOR_SR_XCP_BIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* XORcore is idle. Refetch now */</span>
			<span class="n">do_xor_refetch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ppc440spe_xor_set_link</span><span class="p">(</span><span class="n">xor_last_submit</span><span class="p">,</span>
				<span class="n">xor_last_submit</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="p">);</span>

			<span class="n">ADMA_LL_DBG</span><span class="p">(</span><span class="n">print_cb_list</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span>
				<span class="n">xor_last_submit</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="p">));</span>

			<span class="n">xor_last_submit</span> <span class="o">=</span> <span class="n">xor_last_linked</span><span class="p">;</span>
			<span class="n">iowrite32be</span><span class="p">(</span><span class="n">ioread32be</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">XOR_CRSR_RCBE_BIT</span> <span class="o">|</span> <span class="n">XOR_CRSR_64BA_BIT</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* XORcore is running. Refetch later in the handler */</span>
			<span class="n">do_xor_refetch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_chan_get_current_descriptor - get the currently executed descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span>
<span class="nf">ppc440spe_chan_get_current_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_regs</span> <span class="o">*</span><span class="n">dma_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xor_regs</span> <span class="o">*</span><span class="n">xor_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">hw_chain_inited</span><span class="p">))</span>
		<span class="cm">/* h/w descriptor chain is not initialized yet */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="n">dma_reg</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma_reg</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_reg</span><span class="o">-&gt;</span><span class="n">acpl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">DMA_CDB_MSK</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="n">xor_reg</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">xor_reg</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ioread32be</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">ccbalr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_chan_run - enable the channel</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_chan_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xor_regs</span> <span class="o">*</span><span class="n">xor_reg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="cm">/* DMAs are always enabled, do nothing */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="cm">/* drain write buffer */</span>
		<span class="n">xor_reg</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">xor_reg</span><span class="p">;</span>

		<span class="cm">/* fetch descriptor pointed to in &lt;link&gt; */</span>
		<span class="n">iowrite32be</span><span class="p">(</span><span class="n">XOR_CRSR_64BA_BIT</span> <span class="o">|</span> <span class="n">XOR_CRSR_XAE_BIT</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * ADMA device level</span>
<span class="cm"> ******************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ppc440spe_chan_start_null_xor</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ppc440spe_adma_alloc_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">);</span>

<span class="k">static</span> <span class="n">dma_cookie_t</span>
<span class="n">ppc440spe_adma_tx_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ppc440spe_adma_set_dest</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span>
				    <span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">ppc440spe_adma_memcpy_xor_set_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span>
				  <span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">ppc440spe_adma_pq_set_dest</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span>
			   <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">paddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">ppc440spe_adma_pq_set_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span>
			  <span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">ppc440spe_adma_pq_set_src_mult</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mult</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_pos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">ppc440spe_adma_pqzero_sum_set_dest</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span>
				   <span class="n">dma_addr_t</span> <span class="n">paddr</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">qaddr</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">ppc440spe_rxor_srcs</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_can_rxor - check if the operands may be processed with RXOR</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc440spe_can_rxor</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">srcs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">src_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">src_cnt</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ppc440spe_rxor_srcs</span><span class="p">));</span>

	<span class="cm">/* Skip holes in the source list before checking */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">src_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srcs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ppc440spe_rxor_srcs</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">srcs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">src_cnt</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">src_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">cur_addr</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">ppc440spe_rxor_srcs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">old_addr</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">ppc440spe_rxor_srcs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cur_addr</span> <span class="o">==</span> <span class="n">old_addr</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* direct RXOR */</span>
				<span class="n">order</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">old_addr</span> <span class="o">==</span> <span class="n">cur_addr</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* reverse RXOR */</span>
				<span class="n">order</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="n">src_cnt</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">order</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">cur_addr</span> <span class="o">!=</span> <span class="n">old_addr</span> <span class="o">-</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">cur_addr</span> <span class="o">==</span> <span class="n">old_addr</span> <span class="o">+</span> <span class="n">len</span> <span class="o">*</span> <span class="n">order</span><span class="p">)</span> <span class="o">||</span>
				   <span class="p">(</span><span class="n">cur_addr</span> <span class="o">==</span> <span class="n">old_addr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">len</span><span class="p">)</span> <span class="o">||</span>
				   <span class="p">(</span><span class="n">cur_addr</span> <span class="o">==</span> <span class="n">old_addr</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_device_estimate - estimate the efficiency of processing</span>
<span class="cm"> *	the operation given on this channel. It&#39;s assumed that &#39;chan&#39; is</span>
<span class="cm"> *	capable to process &#39;cap&#39; type of operation.</span>
<span class="cm"> * @chan: channel to use</span>
<span class="cm"> * @cap: type of transaction</span>
<span class="cm"> * @dst_lst: array of destination pointers</span>
<span class="cm"> * @dst_cnt: number of destination operands</span>
<span class="cm"> * @src_lst: array of source pointers</span>
<span class="cm"> * @src_cnt: number of source operands</span>
<span class="cm"> * @src_sz: size of each source operand</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc440spe_adma_estimate</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">dma_transaction_type</span> <span class="n">cap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">dst_lst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_cnt</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">src_lst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">src_sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ef</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">==</span> <span class="n">DMA_PQ</span> <span class="o">||</span> <span class="n">cap</span> <span class="o">==</span> <span class="n">DMA_PQ_VAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If RAID-6 capabilities were not activated don&#39;t try</span>
<span class="cm">		 * to use them</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ppc440spe_r6_enabled</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*  In the current implementation of ppc440spe ADMA driver it</span>
<span class="cm">	 * makes sense to pick out only pq case, because it may be</span>
<span class="cm">	 * processed:</span>
<span class="cm">	 * (1) either using Biskup method on DMA2;</span>
<span class="cm">	 * (2) or on DMA0/1.</span>
<span class="cm">	 *  Thus we give a favour to (1) if the sources are suitable;</span>
<span class="cm">	 * else let it be processed on one of the DMA0/1 engines.</span>
<span class="cm">	 *  In the sum_product case where destination is also the</span>
<span class="cm">	 * source process it on DMA0/1 only.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">==</span> <span class="n">DMA_PQ</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_id</span> <span class="o">==</span> <span class="n">PPC440SPE_XOR_ID</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dst_cnt</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">src_cnt</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">dst_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">src_lst</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">ef</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* sum_product case, process on DMA0/1 */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ppc440spe_can_rxor</span><span class="p">(</span><span class="n">src_lst</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="n">src_sz</span><span class="p">))</span>
			<span class="n">ef</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* override (DMA0/1 + idle) */</span>
		<span class="k">else</span>
			<span class="n">ef</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* can&#39;t process on DMA2 if !rxor */</span>
	<span class="p">}</span>

	<span class="cm">/* channel idleness increases the priority */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ef</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ppc440spe_chan_is_busy</span><span class="p">(</span><span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">)))</span>
		<span class="n">ef</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ef</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span>
<span class="nf">ppc440spe_async_tx_find_best_channel</span><span class="p">(</span><span class="k">enum</span> <span class="n">dma_transaction_type</span> <span class="n">cap</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">dst_lst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_cnt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">src_lst</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">src_sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">best_chan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc_dma_chan_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">best_rank</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">src_sz</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">src_sz</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * should a user of the api ever pass &gt; PAGE_SIZE requests</span>
<span class="cm">		 * we sort out cases where temporary page-sized buffers</span>
<span class="cm">		 * are used.</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DMA_PQ</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">src_cnt</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">dst_lst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">src_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">src_cnt</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">dst_lst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">src_lst</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMA_PQ_VAL</span>:
		<span class="k">case</span> <span class="n">DMA_XOR_VAL</span>:
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppc440spe_adma_chan_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_has_cap</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">rank</span><span class="p">;</span>

			<span class="n">rank</span> <span class="o">=</span> <span class="n">ppc440spe_adma_estimate</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span> <span class="n">dst_lst</span><span class="p">,</span>
					<span class="n">dst_cnt</span><span class="p">,</span> <span class="n">src_lst</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="n">src_sz</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&gt;</span> <span class="n">best_rank</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">best_rank</span> <span class="o">=</span> <span class="n">rank</span><span class="p">;</span>
				<span class="n">best_chan</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">best_chan</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ppc440spe_async_tx_find_best_channel</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_get_group_entry - get group entry with index idx</span>
<span class="cm"> * @tdesc: is the last allocated slot in the group.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span>
<span class="nf">ppc440spe_get_group_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">tdesc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">entry_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">iter</span> <span class="o">=</span> <span class="n">tdesc</span><span class="o">-&gt;</span><span class="n">group_head</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry_idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">entry_idx</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">tdesc</span><span class="o">-&gt;</span><span class="n">src_cnt</span> <span class="o">+</span> <span class="n">tdesc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: entry_idx %d, src_cnt %d, dst_cnt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">entry_idx</span><span class="p">,</span> <span class="n">tdesc</span><span class="o">-&gt;</span><span class="n">src_cnt</span><span class="p">,</span> <span class="n">tdesc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tdesc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span> <span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">==</span> <span class="n">entry_idx</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">iter</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_free_slots - flags descriptor slots for reuse</span>
<span class="cm"> * @slot: Slot to free</span>
<span class="cm"> * Caller must hold &amp;ppc440spe_chan-&gt;lock while calling this function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_free_slots</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">stride</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">slots_per_op</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">stride</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">slots_per_op</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">slot_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
				<span class="n">slot_node</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="n">dst_cnt</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * get the number of sources &amp; destination</span>
<span class="cm">	 * included in this descriptor and unmap</span>
<span class="cm">	 * them all</span>
<span class="cm">	 */</span>
	<span class="n">src_cnt</span> <span class="o">=</span> <span class="n">ppc440spe_desc_get_src_num</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="n">dst_cnt</span> <span class="o">=</span> <span class="n">ppc440spe_desc_get_dst_num</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="cm">/* unmap destinations */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_SKIP_DEST_UNMAP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">dst_cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">ppc440spe_desc_get_dest_addr</span><span class="p">(</span>
				<span class="n">desc</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">dst_cnt</span><span class="p">);</span>
			<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">addr</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">unmap_len</span><span class="p">,</span>
					<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* unmap sources */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_SKIP_SRC_UNMAP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">src_cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">ppc440spe_desc_get_src_addr</span><span class="p">(</span>
				<span class="n">desc</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">);</span>
			<span class="n">dma_unmap_page</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">addr</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">unmap_len</span><span class="p">,</span>
					<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_run_tx_complete_actions - call functions to be called</span>
<span class="cm"> * upon completion</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">dma_cookie_t</span> <span class="nf">ppc440spe_adma_run_tx_complete_actions</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
		<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">cookie</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">cookie</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cookie</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">cookie</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* call the callback (must not sleep or submit new</span>
<span class="cm">		 * operations to this channel)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">callback</span><span class="p">)</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">callback</span><span class="p">(</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">callback_param</span><span class="p">);</span>

		<span class="cm">/* unmap dma addresses</span>
<span class="cm">		 * (unmap_single vs unmap_page?)</span>
<span class="cm">		 *</span>
<span class="cm">		 * actually, ppc&#39;s dma_unmap_page() functions are empty, so</span>
<span class="cm">		 * the following code is just for the sake of completeness</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">needs_unmap</span> <span class="o">&amp;&amp;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">group_head</span> <span class="o">&amp;&amp;</span>
		     <span class="n">desc</span><span class="o">-&gt;</span><span class="n">unmap_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">unmap</span> <span class="o">=</span>
							<span class="n">desc</span><span class="o">-&gt;</span><span class="n">group_head</span><span class="p">;</span>
			<span class="cm">/* assume 1 slot per op always */</span>
			<span class="n">u32</span> <span class="n">slot_count</span> <span class="o">=</span> <span class="n">unmap</span><span class="o">-&gt;</span><span class="n">slot_cnt</span><span class="p">;</span>

			<span class="cm">/* Run through the group list and unmap addresses */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">slot_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">unmap</span><span class="p">);</span>
				<span class="n">ppc440spe_adma_unmap</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">unmap</span><span class="p">);</span>
				<span class="n">unmap</span> <span class="o">=</span> <span class="n">unmap</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* run dependent operations */</span>
	<span class="n">dma_run_dependencies</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cookie</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_clean_slot - clean up CDB slot (if ack is set)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc440spe_adma_clean_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* the client is allowed to attach dependent operations</span>
<span class="cm">	 * until &#39;ack&#39; is set</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">async_tx_test_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* leave the last descriptor in the chain</span>
<span class="cm">	 * so we can append to it</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_is_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">desc</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">==</span> <span class="n">ppc440spe_chan_get_current_descriptor</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">PPC440SPE_XOR_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* our DMA interrupt handler clears opc field of</span>
<span class="cm">		 * each processed descriptor. For all types of</span>
<span class="cm">		 * operations except for ZeroSum we do not actually</span>
<span class="cm">		 * need ack from the interrupt handler. ZeroSum is a</span>
<span class="cm">		 * special case since the result of this operation</span>
<span class="cm">		 * is available from the handler only, so if we see</span>
<span class="cm">		 * such type of descriptor (which is unprocessed yet)</span>
<span class="cm">		 * then leave it in chain.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">cdb</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdb</span><span class="o">-&gt;</span><span class="n">opc</span> <span class="o">==</span> <span class="n">DMA_CDB_OPC_DCHECK128</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">free slot %llx: %d stride: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">slots_per_op</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">);</span>
	<span class="n">ppc440spe_adma_free_slots</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __ppc440spe_adma_slot_cleanup - this is the common clean-up routine</span>
<span class="cm"> *	which runs through the channel CDBs list until reach the descriptor</span>
<span class="cm"> *	currently processed. When routine determines that all CDBs of group</span>
<span class="cm"> *	are completed then corresponding callbacks (if any) are called and slots</span>
<span class="cm"> *	are freed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ppc440spe_adma_slot_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="o">*</span><span class="n">_iter</span><span class="p">,</span> <span class="o">*</span><span class="n">group_start</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">current_desc</span> <span class="o">=</span> <span class="n">ppc440spe_chan_get_current_descriptor</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">busy</span> <span class="o">=</span> <span class="n">ppc440spe_chan_is_busy</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">seen_current</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">slot_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">slots_per_op</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ppc440spe adma%d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">current_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  There were no transactions yet, so</span>
<span class="cm">		 * nothing to clean</span>
<span class="cm">		 */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* free completed slots from the chain starting with</span>
<span class="cm">	 * the oldest descriptor</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">_iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">,</span>
					<span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">cookie: %d slot: %d &quot;</span>
		    <span class="s">&quot;busy: %d this_desc: %#llx next_desc: %#x &quot;</span>
		    <span class="s">&quot;cur: %#x ack: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">iter</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">cookie</span><span class="p">,</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">busy</span><span class="p">,</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span>
		    <span class="n">ppc440spe_desc_get_link</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">),</span> <span class="n">current_desc</span><span class="p">,</span>
		    <span class="n">async_tx_test_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">));</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="n">_iter</span><span class="p">);</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_iter</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">);</span>

		<span class="cm">/* do not advance past the current descriptor loaded into the</span>
<span class="cm">		 * hardware channel,subsequent descriptors are either in process</span>
<span class="cm">		 * or have not been submitted</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">seen_current</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* stop the search if we reach the current descriptor and the</span>
<span class="cm">		 * channel is busy, or if it appears that the current descriptor</span>
<span class="cm">		 * needs to be re-read (i.e. has been appended to)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">==</span> <span class="n">current_desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">seen_current</span><span class="o">++</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">busy</span> <span class="o">||</span> <span class="n">ppc440spe_desc_get_link</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* not all descriptors of the group have</span>
<span class="cm">				 * been completed; exit.</span>
<span class="cm">				 */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* detect the start of a group transaction */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot_cnt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">slots_per_op</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">slot_cnt</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">slot_cnt</span><span class="p">;</span>
			<span class="n">slots_per_op</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">slots_per_op</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">slot_cnt</span> <span class="o">&lt;=</span> <span class="n">slots_per_op</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">slot_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">slots_per_op</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">slot_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">group_start</span><span class="p">)</span>
				<span class="n">group_start</span> <span class="o">=</span> <span class="n">iter</span><span class="p">;</span>
			<span class="n">slot_cnt</span> <span class="o">-=</span> <span class="n">slots_per_op</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* all the members of a group are complete */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slots_per_op</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">slot_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">grp_iter</span><span class="p">,</span> <span class="o">*</span><span class="n">_grp_iter</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">end_of_chain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* clean up the group */</span>
			<span class="n">slot_cnt</span> <span class="o">=</span> <span class="n">group_start</span><span class="o">-&gt;</span><span class="n">slot_cnt</span><span class="p">;</span>
			<span class="n">grp_iter</span> <span class="o">=</span> <span class="n">group_start</span><span class="p">;</span>
			<span class="n">list_for_each_entry_safe_from</span><span class="p">(</span><span class="n">grp_iter</span><span class="p">,</span> <span class="n">_grp_iter</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">,</span> <span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">cookie</span> <span class="o">=</span> <span class="n">ppc440spe_adma_run_tx_complete_actions</span><span class="p">(</span>
					<span class="n">grp_iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>

				<span class="n">slot_cnt</span> <span class="o">-=</span> <span class="n">slots_per_op</span><span class="p">;</span>
				<span class="n">end_of_chain</span> <span class="o">=</span> <span class="n">ppc440spe_adma_clean_slot</span><span class="p">(</span>
				    <span class="n">grp_iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">end_of_chain</span> <span class="o">&amp;&amp;</span> <span class="n">slot_cnt</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Should wait for ZeroSum completion */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">chan</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">completed_cookie</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">;</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">slot_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">end_of_chain</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* the group should be complete at this point */</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">slot_cnt</span><span class="p">);</span>

			<span class="n">slots_per_op</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">group_start</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">end_of_chain</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slots_per_op</span><span class="p">)</span> <span class="cm">/* wait for group completion */</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">cookie</span> <span class="o">=</span> <span class="n">ppc440spe_adma_run_tx_complete_actions</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
		    <span class="n">cookie</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ppc440spe_adma_clean_slot</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">seen_current</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">completed_cookie</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">completed cookie %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_tasklet - clean up watch-dog initiator</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">spin_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">SINGLE_DEPTH_NESTING</span><span class="p">);</span>
	<span class="n">__ppc440spe_adma_slot_cleanup</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_slot_cleanup - clean up scheduled initiator</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_slot_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">__ppc440spe_adma_slot_cleanup</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_alloc_slots - allocate free slots (if any)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="nf">ppc440spe_adma_alloc_slots</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_slots</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">slots_per_op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">iter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">_iter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">alloc_start</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">chain</span> <span class="o">=</span> <span class="n">LIST_HEAD_INIT</span><span class="p">(</span><span class="n">chain</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">slots_found</span><span class="p">,</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">num_slots</span> <span class="o">||</span> <span class="o">!</span><span class="n">slots_per_op</span><span class="p">);</span>
	<span class="cm">/* start search from the last allocated descrtiptor</span>
<span class="cm">	 * if a contiguous allocation can not be found start searching</span>
<span class="cm">	 * from the beginning of the list</span>
<span class="cm">	 */</span>
<span class="nl">retry:</span>
	<span class="n">slots_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retry</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">iter</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">last_used</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">iter</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">all_slots</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
				  <span class="n">slot_node</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe_continue</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">_iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">all_slots</span><span class="p">,</span>
	    <span class="n">slot_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="n">_iter</span><span class="p">);</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_iter</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">slots_per_op</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">slots_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* start the allocation if the slot is correctly aligned */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slots_found</span><span class="o">++</span><span class="p">)</span>
			<span class="n">alloc_start</span> <span class="o">=</span> <span class="n">iter</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">slots_found</span> <span class="o">==</span> <span class="n">num_slots</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">alloc_tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">last_used</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">iter</span> <span class="o">=</span> <span class="n">alloc_start</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">num_slots</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
				<span class="cm">/* pre-ack all but the last descriptor */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">num_slots</span> <span class="o">!=</span> <span class="n">slots_per_op</span><span class="p">)</span>
					<span class="n">async_tx_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">);</span>

				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chain</span><span class="p">);</span>
				<span class="n">alloc_tail</span> <span class="o">=</span> <span class="n">iter</span><span class="p">;</span>
				<span class="n">iter</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">iter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">iter</span><span class="o">-&gt;</span><span class="n">slot_cnt</span> <span class="o">=</span> <span class="n">num_slots</span><span class="p">;</span>
				<span class="n">iter</span><span class="o">-&gt;</span><span class="n">xor_check_result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">slots_per_op</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">iter</span><span class="o">-&gt;</span><span class="n">slots_per_op</span> <span class="o">=</span> <span class="n">slots_per_op</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
					<span class="n">last_used</span> <span class="o">=</span> <span class="n">iter</span><span class="p">;</span>
					<span class="n">iter</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">slot_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
						<span class="n">slot_node</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">num_slots</span> <span class="o">-=</span> <span class="n">slots_per_op</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">alloc_tail</span><span class="o">-&gt;</span><span class="n">group_head</span> <span class="o">=</span> <span class="n">alloc_start</span><span class="p">;</span>
			<span class="n">alloc_tail</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">list_splice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alloc_tail</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">);</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">last_used</span> <span class="o">=</span> <span class="n">last_used</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">alloc_tail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retry</span><span class="o">++</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>

	<span class="cm">/* try to free some slots if the allocation fails */</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">irq_tasklet</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_alloc_chan_resources -  allocate pools for CDB slots</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc440spe_adma_alloc_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">ppc440spe_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">hw_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">db_sz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">init</span><span class="p">;</span>

	<span class="n">ppc440spe_chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">init</span> <span class="o">=</span> <span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">slots_allocated</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan_id</span> <span class="o">=</span> <span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="cm">/* Allocate descriptor slots */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">slots_allocated</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">PPC440SPE_XOR_ID</span><span class="p">)</span>
		<span class="n">db_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">db_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xor_cb</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pool_size</span> <span class="o">/</span> <span class="n">db_sz</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">),</span>
			       <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;SPE ADMA Channel only initialized&quot;</span>
				<span class="s">&quot; %d descriptor slots&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">--</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hw_desc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma_desc_pool_virt</span><span class="p">;</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">hw_desc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hw_desc</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">db_sz</span><span class="p">];</span>
		<span class="n">dma_async_tx_descriptor_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">tx_submit</span> <span class="o">=</span> <span class="n">ppc440spe_adma_tx_submit</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">slot_node</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">);</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma_desc_pool</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">db_sz</span><span class="p">;</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">slots_allocated</span><span class="o">++</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">slot_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">all_slots</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">last_used</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">last_used</span> <span class="o">=</span>
			<span class="n">list_entry</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">all_slots</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
				<span class="n">slot_node</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;ppc440spe adma%d: allocated %d descriptor slots</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* initialize the channel and the chain with a null operation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
		<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
			<span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">hw_chain_inited</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* Use WXOR for self-testing */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppc440spe_r6_tchan</span><span class="p">)</span>
				<span class="n">ppc440spe_r6_tchan</span> <span class="o">=</span> <span class="n">ppc440spe_chan</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
			<span class="n">ppc440spe_chan_start_null_xor</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">needs_unmap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">i</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_rxor_set_region_data -</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_rxor_set_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">xor_arg_no</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xor_cb</span> <span class="o">*</span><span class="n">xcb</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>

	<span class="n">xcb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">xor_arg_no</span><span class="p">].</span><span class="n">h</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_rxor_set_src -</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_rxor_set_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">xor_arg_no</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xor_cb</span> <span class="o">*</span><span class="n">xcb</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>

	<span class="n">xcb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">xor_arg_no</span><span class="p">].</span><span class="n">h</span> <span class="o">|=</span> <span class="n">DMA_CUED_XOR_BASE</span><span class="p">;</span>
	<span class="n">xcb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">xor_arg_no</span><span class="p">].</span><span class="n">l</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_rxor_set_mult -</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_rxor_set_mult</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">xor_arg_no</span><span class="p">,</span> <span class="n">u8</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mult</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xor_cb</span> <span class="o">*</span><span class="n">xcb</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>

	<span class="n">xcb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">xor_arg_no</span><span class="p">].</span><span class="n">h</span> <span class="o">|=</span> <span class="n">mult</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">DMA_CUED_MULT1_OFF</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_check_threshold - append CDBs to h/w chain if threshold</span>
<span class="cm"> *	has been achieved</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_check_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ppc440spe adma%d: pending: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">&gt;=</span> <span class="n">PPC440SPE_ADMA_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ppc440spe_chan_append</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_tx_submit - submit new descriptor group to the channel</span>
<span class="cm"> *	(it&#39;s not necessary that descriptors will be submitted to the h/w</span>
<span class="cm"> *	chains too right now)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">dma_cookie_t</span> <span class="nf">ppc440spe_adma_tx_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">sw_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">group_start</span><span class="p">,</span> <span class="o">*</span><span class="n">old_chain_tail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slots_per_op</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="n">sw_desc</span> <span class="o">=</span> <span class="n">tx_to_ppc440spe_adma_slot</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>

	<span class="n">group_start</span> <span class="o">=</span> <span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_head</span><span class="p">;</span>
	<span class="n">slot_cnt</span> <span class="o">=</span> <span class="n">group_start</span><span class="o">-&gt;</span><span class="n">slot_cnt</span><span class="p">;</span>
	<span class="n">slots_per_op</span> <span class="o">=</span> <span class="n">group_start</span><span class="o">-&gt;</span><span class="n">slots_per_op</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cookie</span> <span class="o">=</span> <span class="n">dma_cookie_assign</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* first peer */</span>
		<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">);</span>
		<span class="n">chan_first_cdb</span><span class="p">[</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_start</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* isn&#39;t first peer, bind CDBs to chain */</span>
		<span class="n">old_chain_tail</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
					<span class="n">chain_node</span><span class="p">);</span>
		<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">old_chain_tail</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">);</span>
		<span class="cm">/* fix up the hardware chain */</span>
		<span class="n">ppc440spe_desc_set_link</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">old_chain_tail</span><span class="p">,</span> <span class="n">group_start</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* increment the pending count by the number of operations */</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">+=</span> <span class="n">slot_cnt</span> <span class="o">/</span> <span class="n">slots_per_op</span><span class="p">;</span>
	<span class="n">ppc440spe_adma_check_threshold</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;ppc440spe adma%d: %s cookie: %d slot: %d tx %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">cookie</span><span class="p">,</span> <span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">sw_desc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cookie</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_prep_dma_interrupt - prepare CDB for a pseudo DMA operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">ppc440spe_adma_prep_dma_interrupt</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">ppc440spe_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">sw_desc</span><span class="p">,</span> <span class="o">*</span><span class="n">group_start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot_cnt</span><span class="p">,</span> <span class="n">slots_per_op</span><span class="p">;</span>

	<span class="n">ppc440spe_chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;ppc440spe adma%d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">slot_cnt</span> <span class="o">=</span> <span class="n">slots_per_op</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sw_desc</span> <span class="o">=</span> <span class="n">ppc440spe_adma_alloc_slots</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="p">,</span> <span class="n">slot_cnt</span><span class="p">,</span>
			<span class="n">slots_per_op</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sw_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">group_start</span> <span class="o">=</span> <span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_head</span><span class="p">;</span>
		<span class="n">ppc440spe_desc_init_interrupt</span><span class="p">(</span><span class="n">group_start</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="p">);</span>
		<span class="n">group_start</span><span class="o">-&gt;</span><span class="n">unmap_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sw_desc</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_prep_dma_memcpy - prepare CDB for a MEMCPY operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">ppc440spe_adma_prep_dma_memcpy</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_dest</span><span class="p">,</span>
		<span class="n">dma_addr_t</span> <span class="n">dma_src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">ppc440spe_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">sw_desc</span><span class="p">,</span> <span class="o">*</span><span class="n">group_start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot_cnt</span><span class="p">,</span> <span class="n">slots_per_op</span><span class="p">;</span>

	<span class="n">ppc440spe_chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">PPC440SPE_ADMA_DMA_MAX_BYTE_COUNT</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;ppc440spe adma%d: %s len: %u int_en %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
		<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_INTERRUPT</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">slot_cnt</span> <span class="o">=</span> <span class="n">slots_per_op</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sw_desc</span> <span class="o">=</span> <span class="n">ppc440spe_adma_alloc_slots</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="p">,</span> <span class="n">slot_cnt</span><span class="p">,</span>
		<span class="n">slots_per_op</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sw_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">group_start</span> <span class="o">=</span> <span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_head</span><span class="p">;</span>
		<span class="n">ppc440spe_desc_init_memcpy</span><span class="p">(</span><span class="n">group_start</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ppc440spe_adma_set_dest</span><span class="p">(</span><span class="n">group_start</span><span class="p">,</span> <span class="n">dma_dest</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ppc440spe_adma_memcpy_xor_set_src</span><span class="p">(</span><span class="n">group_start</span><span class="p">,</span> <span class="n">dma_src</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ppc440spe_desc_set_byte_count</span><span class="p">(</span><span class="n">group_start</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">unmap_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sw_desc</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_prep_dma_memset - prepare CDB for a MEMSET operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">ppc440spe_adma_prep_dma_memset</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">ppc440spe_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">sw_desc</span><span class="p">,</span> <span class="o">*</span><span class="n">group_start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot_cnt</span><span class="p">,</span> <span class="n">slots_per_op</span><span class="p">;</span>

	<span class="n">ppc440spe_chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">PPC440SPE_ADMA_DMA_MAX_BYTE_COUNT</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;ppc440spe adma%d: %s cal: %u len: %u int_en %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
		<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_INTERRUPT</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">slot_cnt</span> <span class="o">=</span> <span class="n">slots_per_op</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sw_desc</span> <span class="o">=</span> <span class="n">ppc440spe_adma_alloc_slots</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="p">,</span> <span class="n">slot_cnt</span><span class="p">,</span>
		<span class="n">slots_per_op</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sw_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">group_start</span> <span class="o">=</span> <span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_head</span><span class="p">;</span>
		<span class="n">ppc440spe_desc_init_memset</span><span class="p">(</span><span class="n">group_start</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ppc440spe_adma_set_dest</span><span class="p">(</span><span class="n">group_start</span><span class="p">,</span> <span class="n">dma_dest</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ppc440spe_desc_set_byte_count</span><span class="p">(</span><span class="n">group_start</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">unmap_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sw_desc</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_prep_dma_xor - prepare CDB for a XOR operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">ppc440spe_adma_prep_dma_xor</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_dest</span><span class="p">,</span>
		<span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">dma_src</span><span class="p">,</span> <span class="n">u32</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">ppc440spe_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">sw_desc</span><span class="p">,</span> <span class="o">*</span><span class="n">group_start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot_cnt</span><span class="p">,</span> <span class="n">slots_per_op</span><span class="p">;</span>

	<span class="n">ppc440spe_chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">ADMA_LL_DBG</span><span class="p">(</span><span class="n">prep_dma_xor_dbg</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
				     <span class="n">dma_dest</span><span class="p">,</span> <span class="n">dma_src</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">PPC440SPE_ADMA_XOR_MAX_BYTE_COUNT</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;ppc440spe adma%d: %s src_cnt: %d len: %u int_en: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
		<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_INTERRUPT</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">slot_cnt</span> <span class="o">=</span> <span class="n">ppc440spe_chan_xor_slot_count</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slots_per_op</span><span class="p">);</span>
	<span class="n">sw_desc</span> <span class="o">=</span> <span class="n">ppc440spe_adma_alloc_slots</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="p">,</span> <span class="n">slot_cnt</span><span class="p">,</span>
			<span class="n">slots_per_op</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sw_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">group_start</span> <span class="o">=</span> <span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_head</span><span class="p">;</span>
		<span class="n">ppc440spe_desc_init_xor</span><span class="p">(</span><span class="n">group_start</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ppc440spe_adma_set_dest</span><span class="p">(</span><span class="n">group_start</span><span class="p">,</span> <span class="n">dma_dest</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">src_cnt</span><span class="o">--</span><span class="p">)</span>
			<span class="n">ppc440spe_adma_memcpy_xor_set_src</span><span class="p">(</span><span class="n">group_start</span><span class="p">,</span>
				<span class="n">dma_src</span><span class="p">[</span><span class="n">src_cnt</span><span class="p">],</span> <span class="n">src_cnt</span><span class="p">);</span>
		<span class="n">ppc440spe_desc_set_byte_count</span><span class="p">(</span><span class="n">group_start</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">unmap_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sw_desc</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="n">ppc440spe_desc_set_xor_src_cnt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">src_cnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ppc440spe_init_rxor_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_rxor</span> <span class="o">*</span><span class="n">cursor</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_init_dma2rxor_slot -</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_init_dma2rxor_slot</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
		<span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* initialize CDB */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">src_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppc440spe_adma_dma2rxor_prep_src</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">rxor_cursor</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						 <span class="n">desc</span><span class="o">-&gt;</span><span class="n">src_cnt</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_dma01_prep_mult -</span>
<span class="cm"> * for Q operation where destination is also the source</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="nf">ppc440spe_dma01_prep_mult</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">ppc440spe_chan</span><span class="p">,</span>
		<span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_cnt</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_cnt</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">scf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">sw_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">op</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot_cnt</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_WXOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
	<span class="n">slot_cnt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* use WXOR, each descriptor occupies one slot */</span>
	<span class="n">sw_desc</span> <span class="o">=</span> <span class="n">ppc440spe_adma_alloc_slots</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="p">,</span> <span class="n">slot_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sw_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">hw_desc</span><span class="p">;</span>

		<span class="n">chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">set_bits</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">src_cnt</span> <span class="o">=</span> <span class="n">src_cnt</span><span class="p">;</span>
		<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">=</span> <span class="n">dst_cnt</span><span class="p">;</span>
		<span class="cm">/* First descriptor, zero data in the destination and copy it</span>
<span class="cm">		 * to q page using MULTICAST transfer.</span>
<span class="cm">		 */</span>
		<span class="n">iter</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
					<span class="n">chain_node</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span><span class="p">));</span>
		<span class="cm">/* set &#39;next&#39; pointer */</span>
		<span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
					   <span class="n">chain_node</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">hw_desc</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span> <span class="o">=</span> <span class="n">DMA_CDB_OPC_MULTICAST</span><span class="p">;</span>

		<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
					     <span class="n">DMA_CUED_XOR_BASE</span><span class="p">,</span> <span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dst</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ppc440spe_desc_set_src_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_CUED_XOR_HB</span><span class="p">,</span>
					    <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">ppc440spe_desc_set_byte_count</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">iter</span><span class="o">-&gt;</span><span class="n">unmap_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Second descriptor, multiply data from the q page</span>
<span class="cm">		 * and store the result in real destination.</span>
<span class="cm">		 */</span>
		<span class="n">iter</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
					<span class="n">chain_node</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span><span class="p">));</span>
		<span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_INTERRUPT</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">hw_desc</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span> <span class="o">=</span> <span class="n">DMA_CDB_OPC_MV_SG1_SG2</span><span class="p">;</span>
		<span class="n">ppc440spe_desc_set_src_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">DMA_CUED_XOR_HB</span><span class="p">,</span> <span class="n">dst</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
					     <span class="n">DMA_CUED_XOR_BASE</span><span class="p">,</span> <span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">ppc440spe_desc_set_src_mult</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">DMA_CUED_MULT1_OFF</span><span class="p">,</span>
					    <span class="n">DMA_CDB_SG_DST1</span><span class="p">,</span> <span class="n">scf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">ppc440spe_desc_set_byte_count</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">iter</span><span class="o">-&gt;</span><span class="n">unmap_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sw_desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_dma01_prep_sum_product -</span>
<span class="cm"> * Dx = A*(P+Pxy) + B*(Q+Qxy) operation where destination is also</span>
<span class="cm"> * the source.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="nf">ppc440spe_dma01_prep_sum_product</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">ppc440spe_chan</span><span class="p">,</span>
		<span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_cnt</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">scf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">sw_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">op</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot_cnt</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_WXOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
	<span class="n">slot_cnt</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* WXOR, each descriptor occupies one slot */</span>
	<span class="n">sw_desc</span> <span class="o">=</span> <span class="n">ppc440spe_adma_alloc_slots</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="p">,</span> <span class="n">slot_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sw_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">hw_desc</span><span class="p">;</span>

		<span class="n">chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">set_bits</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">src_cnt</span> <span class="o">=</span> <span class="n">src_cnt</span><span class="p">;</span>
		<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* 1st descriptor, src[1] data to q page and zero destination */</span>
		<span class="n">iter</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
					<span class="n">chain_node</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span><span class="p">));</span>
		<span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
					   <span class="n">chain_node</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">hw_desc</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span> <span class="o">=</span> <span class="n">DMA_CDB_OPC_MULTICAST</span><span class="p">;</span>

		<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">DMA_CUED_XOR_BASE</span><span class="p">,</span>
					     <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					     <span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">qdest</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ppc440spe_desc_set_src_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_CUED_XOR_HB</span><span class="p">,</span>
					    <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">ppc440spe_desc_set_byte_count</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">iter</span><span class="o">-&gt;</span><span class="n">unmap_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

		<span class="cm">/* 2nd descriptor, multiply src[1] data and store the</span>
<span class="cm">		 * result in destination */</span>
		<span class="n">iter</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
					<span class="n">chain_node</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span><span class="p">));</span>
		<span class="cm">/* set &#39;next&#39; pointer */</span>
		<span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
					   <span class="n">chain_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_INTERRUPT</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">hw_desc</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span> <span class="o">=</span> <span class="n">DMA_CDB_OPC_MV_SG1_SG2</span><span class="p">;</span>
		<span class="n">ppc440spe_desc_set_src_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_CUED_XOR_HB</span><span class="p">,</span>
					    <span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">qdest</span><span class="p">);</span>
		<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">DMA_CUED_XOR_BASE</span><span class="p">,</span>
					     <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ppc440spe_desc_set_src_mult</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>	<span class="n">DMA_CUED_MULT1_OFF</span><span class="p">,</span>
					    <span class="n">DMA_CDB_SG_DST1</span><span class="p">,</span> <span class="n">scf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">ppc440spe_desc_set_byte_count</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">iter</span><span class="o">-&gt;</span><span class="n">unmap_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * 3rd descriptor, multiply src[0] data and xor it</span>
<span class="cm">		 * with destination</span>
<span class="cm">		 */</span>
		<span class="n">iter</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
					<span class="n">chain_node</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span><span class="p">));</span>
		<span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_INTERRUPT</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">hw_desc</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
		<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span> <span class="o">=</span> <span class="n">DMA_CDB_OPC_MV_SG1_SG2</span><span class="p">;</span>
		<span class="n">ppc440spe_desc_set_src_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_CUED_XOR_HB</span><span class="p">,</span>
					    <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">DMA_CUED_XOR_BASE</span><span class="p">,</span>
					     <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ppc440spe_desc_set_src_mult</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">DMA_CUED_MULT1_OFF</span><span class="p">,</span>
					    <span class="n">DMA_CDB_SG_DST1</span><span class="p">,</span> <span class="n">scf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">ppc440spe_desc_set_byte_count</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">iter</span><span class="o">-&gt;</span><span class="n">unmap_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sw_desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="nf">ppc440spe_dma01_prep_pq</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">ppc440spe_chan</span><span class="p">,</span>
		<span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_cnt</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_cnt</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">scf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">slot_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">sw_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">op</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mult</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: dst_cnt %d, src_cnt %d, len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="n">dst_cnt</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="cm">/*  select operations WXOR/RXOR depending on the</span>
<span class="cm">	 * source addresses of operators and the number</span>
<span class="cm">	 * of destinations (RXOR support only Q-parity calculations)</span>
<span class="cm">	 */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_WXOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">PPC440SPE_RXOR_RUN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppc440spe_rxor_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* no active RXOR;</span>
<span class="cm">		 * do RXOR if:</span>
<span class="cm">		 * - there are more than 1 source,</span>
<span class="cm">		 * - len is aligned on 512-byte boundary,</span>
<span class="cm">		 * - source addresses fit to one of 4 possible regions.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">src_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="n">MQ0_CF2H_RXOR_BS_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/* may do RXOR R1 R2 */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">src_cnt</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* may try to enhance region of RXOR */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
					<span class="cm">/* do RXOR R1 R2 R3 */</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR123</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">len</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
					<span class="cm">/* do RXOR R1 R2 R4 */</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR124</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">len</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
					<span class="cm">/* do RXOR R1 R2 R5 */</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR125</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* do RXOR R1 R2 */</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR12</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* do RXOR R1 R2 */</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR12</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* can not do this operation with RXOR */</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">PPC440SPE_RXOR_RUN</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ppc440spe_rxor_state</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* can do; set block size right now */</span>
			<span class="n">ppc440spe_desc_set_rxor_block_size</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Number of necessary slots depends on operation type selected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*  This is a WXOR only chain. Need descriptors for each</span>
<span class="cm">		 * source to GF-XOR them with WXOR, and need descriptors</span>
<span class="cm">		 * for each destination to zero them with WXOR</span>
<span class="cm">		 */</span>
		<span class="n">slot_cnt</span> <span class="o">=</span> <span class="n">src_cnt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_ZERO_P</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">slot_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_ZERO_Q</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">slot_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_Q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*  Need 1/2 descriptor for RXOR operation, and</span>
<span class="cm">		 * need (src_cnt - (2 or 3)) for WXOR of sources</span>
<span class="cm">		 * remained (if any)</span>
<span class="cm">		 */</span>
		<span class="n">slot_cnt</span> <span class="o">=</span> <span class="n">dst_cnt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_ZERO_P</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_ZERO_Q</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_Q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR12</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">))</span>
			<span class="n">slot_cnt</span> <span class="o">+=</span> <span class="n">src_cnt</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">slot_cnt</span> <span class="o">+=</span> <span class="n">src_cnt</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>

		<span class="cm">/*  Thus we have either RXOR only chain or</span>
<span class="cm">		 * mixed RXOR/WXOR</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot_cnt</span> <span class="o">==</span> <span class="n">dst_cnt</span><span class="p">)</span>
			<span class="cm">/* RXOR only chain */</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_WXOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* for both RXOR/WXOR each descriptor occupies one slot */</span>
	<span class="n">sw_desc</span> <span class="o">=</span> <span class="n">ppc440spe_adma_alloc_slots</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="p">,</span> <span class="n">slot_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sw_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppc440spe_desc_init_dma01pq</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="n">dst_cnt</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">,</span>
				<span class="n">flags</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>

		<span class="cm">/* setup dst/src/mult */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: set dst descriptor 0, 1: 0x%016llx, 0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dst</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">ppc440spe_adma_pq_set_dest</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">src_cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppc440spe_adma_pq_set_src</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="n">src</span><span class="p">[</span><span class="n">src_cnt</span><span class="p">],</span>
						  <span class="n">src_cnt</span><span class="p">);</span>

			<span class="cm">/* NOTE: &quot;Multi = 0 is equivalent to = 1&quot; as it</span>
<span class="cm">			 * stated in 440SPSPe_RAID6_Addendum_UM_1_17.pdf</span>
<span class="cm">			 * doesn&#39;t work for RXOR with DMA0/1! Instead, multi=0</span>
<span class="cm">			 * leads to zeroing source data after RXOR.</span>
<span class="cm">			 * So, for P case set-up mult=1 explicitly.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_PQ_DISABLE_Q</span><span class="p">))</span>
				<span class="n">mult</span> <span class="o">=</span> <span class="n">scf</span><span class="p">[</span><span class="n">src_cnt</span><span class="p">];</span>
			<span class="n">ppc440spe_adma_pq_set_src_mult</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span>
				<span class="n">mult</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">,</span>  <span class="n">dst_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Setup byte count foreach slot just allocated */</span>
		<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span>
				<span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppc440spe_desc_set_byte_count</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span>
				<span class="n">ppc440spe_chan</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">unmap_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sw_desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="nf">ppc440spe_dma2_prep_pq</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">ppc440spe_chan</span><span class="p">,</span>
		<span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_cnt</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_cnt</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">scf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">slot_cnt</span><span class="p">,</span> <span class="n">descs_per_op</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">sw_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">op</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mult</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dst_cnt</span><span class="p">);</span>
	<span class="cm">/*pr_debug(&quot;%s: dst_cnt %d, src_cnt %d, len %d\n&quot;,</span>
<span class="cm">		 __func__, dst_cnt, src_cnt, len);*/</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">descs_per_op</span> <span class="o">=</span> <span class="n">ppc440spe_dma2_pq_slot_count</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">descs_per_op</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* depending on number of sources we have 1 or 2 RXOR chains */</span>
	<span class="n">slot_cnt</span> <span class="o">=</span> <span class="n">descs_per_op</span> <span class="o">*</span> <span class="n">dst_cnt</span><span class="p">;</span>

	<span class="n">sw_desc</span> <span class="o">=</span> <span class="n">ppc440spe_adma_alloc_slots</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="p">,</span> <span class="n">slot_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sw_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">op</span> <span class="o">=</span> <span class="n">slot_cnt</span><span class="p">;</span>
		<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span> <span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppc440spe_desc_init_dma2pq</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">dst_cnt</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">,</span>
				<span class="o">--</span><span class="n">op</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">ppc440spe_desc_set_byte_count</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="p">,</span>
				<span class="n">len</span><span class="p">);</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">unmap_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

			<span class="n">ppc440spe_init_rxor_cursor</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">rxor_cursor</span><span class="p">));</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">rxor_cursor</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">descs_per_op</span> <span class="o">=</span> <span class="n">descs_per_op</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">op</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span> <span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">op</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">%</span> <span class="n">descs_per_op</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ppc440spe_adma_init_dma2rxor_slot</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span>
								  <span class="n">src_cnt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">list_is_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">)))</span> <span class="p">{</span>
				<span class="cm">/* set &#39;next&#39; pointer */</span>
				<span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span>
					<span class="n">list_entry</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
						<span class="n">chain_node</span><span class="p">);</span>
				<span class="n">ppc440spe_xor_set_link</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* this is the last descriptor. */</span>
				<span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* fixup head descriptor */</span>
		<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">=</span> <span class="n">dst_cnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_ZERO_P</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_ZERO_Q</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_Q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* setup dst/src/mult */</span>
		<span class="n">ppc440spe_adma_pq_set_dest</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">src_cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* handle descriptors (if dst_cnt == 2) inside</span>
<span class="cm">			 * the ppc440spe_adma_pq_set_srcxxx() functions</span>
<span class="cm">			 */</span>
			<span class="n">ppc440spe_adma_pq_set_src</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="n">src</span><span class="p">[</span><span class="n">src_cnt</span><span class="p">],</span>
						  <span class="n">src_cnt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_PQ_DISABLE_Q</span><span class="p">))</span>
				<span class="n">mult</span> <span class="o">=</span> <span class="n">scf</span><span class="p">[</span><span class="n">src_cnt</span><span class="p">];</span>
			<span class="n">ppc440spe_adma_pq_set_src_mult</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span>
					<span class="n">mult</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="n">dst_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ppc440spe_desc_set_rxor_block_size</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sw_desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_prep_dma_pq - prepare CDB (group) for a GF-XOR operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">ppc440spe_adma_prep_dma_pq</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">scf</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">ppc440spe_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">sw_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dst_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ppc440spe_chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">ADMA_LL_DBG</span><span class="p">(</span><span class="n">prep_dma_pq_dbg</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
				    <span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">PPC440SPE_ADMA_XOR_MAX_BYTE_COUNT</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">src_cnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">src_cnt</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">dest</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

		<span class="cm">/* dst[1] is real destination (Q) */</span>
		<span class="n">dest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dst</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="cm">/* this is the page to multicast source data to */</span>
		<span class="n">dest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">qdest</span><span class="p">;</span>
		<span class="n">sw_desc</span> <span class="o">=</span> <span class="n">ppc440spe_dma01_prep_mult</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="p">,</span>
				<span class="n">dest</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="n">scf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">sw_desc</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">src_cnt</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">sw_desc</span> <span class="o">=</span> <span class="n">ppc440spe_dma01_prep_sum_product</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">dst</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">src</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">scf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">sw_desc</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_PQ_DISABLE_P</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">dst_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_PREP_ZERO_P</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_PQ_DISABLE_Q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dst</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">dst_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_PREP_ZERO_Q</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dst_cnt</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;ppc440spe adma%d: %s src_cnt: %d len: %u int_en: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
		<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_INTERRUPT</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="n">sw_desc</span> <span class="o">=</span> <span class="n">ppc440spe_dma01_prep_pq</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="p">,</span>
				<span class="n">dst</span><span class="p">,</span> <span class="n">dst_cnt</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="n">scf</span><span class="p">,</span>
				<span class="n">len</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="n">sw_desc</span> <span class="o">=</span> <span class="n">ppc440spe_dma2_prep_pq</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="p">,</span>
				<span class="n">dst</span><span class="p">,</span> <span class="n">dst_cnt</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="n">scf</span><span class="p">,</span>
				<span class="n">len</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sw_desc</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_prep_dma_pqzero_sum - prepare CDB group for</span>
<span class="cm"> * a PQ_ZERO_SUM operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">ppc440spe_adma_prep_dma_pqzero_sum</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">pq</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">scf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">sum_check_flags</span> <span class="o">*</span><span class="n">pqres</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">ppc440spe_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">sw_desc</span><span class="p">,</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pdest</span><span class="p">,</span> <span class="n">qdest</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot_cnt</span><span class="p">,</span> <span class="n">slots_per_op</span><span class="p">,</span> <span class="n">idst</span><span class="p">,</span> <span class="n">dst_cnt</span><span class="p">;</span>

	<span class="n">ppc440spe_chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_PQ_DISABLE_P</span><span class="p">)</span>
		<span class="n">pdest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pdest</span> <span class="o">=</span> <span class="n">pq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_PQ_DISABLE_Q</span><span class="p">)</span>
		<span class="n">qdest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">qdest</span> <span class="o">=</span> <span class="n">pq</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">ADMA_LL_DBG</span><span class="p">(</span><span class="n">prep_dma_pqzero_sum_dbg</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
					    <span class="n">src</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="n">scf</span><span class="p">));</span>

	<span class="cm">/* Always use WXOR for P/Q calculations (two destinations).</span>
<span class="cm">	 * Need 1 or 2 extra slots to verify results are zero.</span>
<span class="cm">	 */</span>
	<span class="n">idst</span> <span class="o">=</span> <span class="n">dst_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdest</span> <span class="o">&amp;&amp;</span> <span class="n">qdest</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* One additional slot per destination to clone P/Q</span>
<span class="cm">	 * before calculation (we have to preserve destinations).</span>
<span class="cm">	 */</span>
	<span class="n">slot_cnt</span> <span class="o">=</span> <span class="n">src_cnt</span> <span class="o">+</span> <span class="n">dst_cnt</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">slots_per_op</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">sw_desc</span> <span class="o">=</span> <span class="n">ppc440spe_adma_alloc_slots</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="p">,</span> <span class="n">slot_cnt</span><span class="p">,</span>
					     <span class="n">slots_per_op</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sw_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppc440spe_desc_init_dma01pqzero_sum</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="n">dst_cnt</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">);</span>

		<span class="cm">/* Setup byte count for each slot just allocated */</span>
		<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span> <span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppc440spe_desc_set_byte_count</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="p">,</span>
						      <span class="n">len</span><span class="p">);</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">unmap_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pdest</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">hw_desc</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

			<span class="n">iter</span> <span class="o">=</span> <span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_head</span><span class="p">;</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">chan</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span><span class="p">));</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
						<span class="n">chain_node</span><span class="p">);</span>
			<span class="n">hw_desc</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
			<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span> <span class="o">=</span> <span class="n">DMA_CDB_OPC_MV_SG1_SG2</span><span class="p">;</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">src_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						     <span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">pdest</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ppc440spe_desc_set_src_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pdest</span><span class="p">);</span>
			<span class="n">ppc440spe_desc_set_byte_count</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="p">,</span>
						      <span class="n">len</span><span class="p">);</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">unmap_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* override pdest to preserve original P */</span>
			<span class="n">pdest</span> <span class="o">=</span> <span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">pdest</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qdest</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">dma_cdb</span> <span class="o">*</span><span class="n">hw_desc</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

			<span class="n">iter</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
						<span class="n">chain_node</span><span class="p">);</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">chan</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pdest</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">iter</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
						<span class="n">chain_node</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">memset</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span><span class="p">));</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_next</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
						<span class="n">chain_node</span><span class="p">);</span>
			<span class="n">hw_desc</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
			<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">opc</span> <span class="o">=</span> <span class="n">DMA_CDB_OPC_MV_SG1_SG2</span><span class="p">;</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">src_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						     <span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">qdest</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ppc440spe_desc_set_src_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qdest</span><span class="p">);</span>
			<span class="n">ppc440spe_desc_set_byte_count</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="p">,</span>
						      <span class="n">len</span><span class="p">);</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">unmap_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* override qdest to preserve original Q */</span>
			<span class="n">qdest</span> <span class="o">=</span> <span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">qdest</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Setup destinations for P/Q ops */</span>
		<span class="n">ppc440spe_adma_pqzero_sum_set_dest</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="n">pdest</span><span class="p">,</span> <span class="n">qdest</span><span class="p">);</span>

		<span class="cm">/* Setup zero QWORDs into DCHECK CDBs */</span>
		<span class="n">idst</span> <span class="o">=</span> <span class="n">dst_cnt</span><span class="p">;</span>
		<span class="n">list_for_each_entry_reverse</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span>
					    <span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The last CDB corresponds to Q-parity check,</span>
<span class="cm">			 * the one before last CDB corresponds</span>
<span class="cm">			 * P-parity check</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idst</span> <span class="o">==</span> <span class="n">DMA_DEST_MAX_NUM</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">idst</span> <span class="o">==</span> <span class="n">dst_cnt</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_QCHECK</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_PCHECK</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">qdest</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_QCHECK</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_PCHECK</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">xor_check_result</span> <span class="o">=</span> <span class="n">pqres</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * set it to zero, if check fail then result will</span>
<span class="cm">			 * be updated</span>
<span class="cm">			 */</span>
			<span class="o">*</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">xor_check_result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ppc440spe_desc_set_dcheck</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="p">,</span>
				<span class="n">ppc440spe_qword</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">--</span><span class="n">dst_cnt</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Setup sources and mults for P/Q ops */</span>
		<span class="n">list_for_each_entry_continue_reverse</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span>
						     <span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">mult_dst</span><span class="p">;</span>

			<span class="n">chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">chan</span><span class="p">);</span>
			<span class="n">ppc440spe_desc_set_src_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						    <span class="n">DMA_CUED_XOR_HB</span><span class="p">,</span>
						    <span class="n">src</span><span class="p">[</span><span class="n">src_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qdest</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mult_dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">dst_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">DMA_CDB_SG_DST2</span> <span class="o">:</span>
							   <span class="n">DMA_CDB_SG_DST1</span><span class="p">;</span>
				<span class="n">ppc440spe_desc_set_src_mult</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
							    <span class="n">DMA_CUED_MULT1_OFF</span><span class="p">,</span>
							    <span class="n">mult_dst</span><span class="p">,</span>
							    <span class="n">scf</span><span class="p">[</span><span class="n">src_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">--</span><span class="n">src_cnt</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sw_desc</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_prep_dma_xor_zero_sum - prepare CDB group for</span>
<span class="cm"> * XOR ZERO_SUM operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="nf">ppc440spe_adma_prep_dma_xor_zero_sum</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src_cnt</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="k">enum</span> <span class="n">sum_check_flags</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pq</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* validate P, disable Q */</span>
	<span class="n">pq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">pq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_PREP_PQ_DISABLE_Q</span><span class="p">;</span>

	<span class="n">tx</span> <span class="o">=</span> <span class="n">ppc440spe_adma_prep_dma_pqzero_sum</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">pq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
						<span class="n">src_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
						<span class="n">result</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tx</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_set_dest - set destination address into descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_set_dest</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">sw_desc</span><span class="p">,</span>
		<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span><span class="p">);</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="cm">/* to do: support transfers lengths &gt;</span>
<span class="cm">		 * PPC440SPE_ADMA_DMA/XOR_MAX_BYTE_COUNT</span>
<span class="cm">		 */</span>
		<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_head</span><span class="p">,</span>
			<span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="n">sw_desc</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span>
			<span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_pq_zero_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*  To clear destinations update the descriptor</span>
<span class="cm">	 * (P or Q depending on index) as follows:</span>
<span class="cm">	 * addr is destination (0 corresponds to SG2):</span>
<span class="cm">	 */</span>
	<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">DMA_CUED_XOR_BASE</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* ... and the addr is source: */</span>
	<span class="n">ppc440spe_desc_set_src_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_CUED_XOR_HB</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="cm">/* addr is always SG2 then the mult is always DST1 */</span>
	<span class="n">ppc440spe_desc_set_src_mult</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">DMA_CUED_MULT1_OFF</span><span class="p">,</span>
				    <span class="n">DMA_CDB_SG_DST1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_pq_set_dest - set destination address into descriptor</span>
<span class="cm"> * for the PQXOR operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_pq_set_dest</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">sw_desc</span><span class="p">,</span>
		<span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">addrs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">paddr</span><span class="p">,</span> <span class="n">qaddr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ppath</span><span class="p">,</span> <span class="n">qpath</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_PQ_DISABLE_P</span><span class="p">)</span>
		<span class="n">paddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">paddr</span> <span class="o">=</span> <span class="n">addrs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_PQ_DISABLE_Q</span><span class="p">)</span>
		<span class="n">qaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">qaddr</span> <span class="o">=</span> <span class="n">addrs</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">paddr</span> <span class="o">||</span> <span class="o">!</span><span class="n">qaddr</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">paddr</span> <span class="o">?</span> <span class="n">paddr</span> <span class="o">:</span> <span class="n">qaddr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="cm">/* walk through the WXOR source list and set P/Q-destinations</span>
<span class="cm">		 * for each slot:</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* This is WXOR-only chain; may have 1/2 zero descs */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_Q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">index</span><span class="o">++</span><span class="p">;</span>

			<span class="n">iter</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* one destination */</span>
				<span class="n">list_for_each_entry_from</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span> <span class="n">chain_node</span><span class="p">)</span>
					<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
						<span class="n">DMA_CUED_XOR_BASE</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* two destinations */</span>
				<span class="n">list_for_each_entry_from</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span> <span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
						<span class="n">DMA_CUED_XOR_BASE</span><span class="p">,</span> <span class="n">paddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
						<span class="n">DMA_CUED_XOR_BASE</span><span class="p">,</span> <span class="n">qaddr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*  To clear destinations update the descriptor</span>
<span class="cm">				 * (1st,2nd, or both depending on flags)</span>
<span class="cm">				 */</span>
				<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_P</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">iter</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span>
							<span class="n">sw_desc</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>
					<span class="n">ppc440spe_adma_pq_zero_op</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
							<span class="n">paddr</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_Q</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">iter</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span>
							<span class="n">sw_desc</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>
					<span class="n">ppc440spe_adma_pq_zero_op</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
							<span class="n">qaddr</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* This is RXOR-only or RXOR/WXOR mixed chain */</span>

			<span class="cm">/* If we want to include destination into calculations,</span>
<span class="cm">			 * then make dest addresses cued with mult=1 (XOR).</span>
<span class="cm">			 */</span>
			<span class="n">ppath</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">DMA_CUED_XOR_HB</span> <span class="o">:</span>
					<span class="n">DMA_CUED_XOR_BASE</span> <span class="o">|</span>
						<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CUED_MULT1_OFF</span><span class="p">);</span>
			<span class="n">qpath</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_Q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">DMA_CUED_XOR_HB</span> <span class="o">:</span>
					<span class="n">DMA_CUED_XOR_BASE</span> <span class="o">|</span>
						<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CUED_MULT1_OFF</span><span class="p">);</span>

			<span class="cm">/* Setup destination(s) in RXOR slot(s) */</span>
			<span class="n">iter</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>
			<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
						<span class="n">paddr</span> <span class="o">?</span> <span class="n">ppath</span> <span class="o">:</span> <span class="n">qpath</span><span class="p">,</span>
						<span class="n">paddr</span> <span class="o">?</span> <span class="n">paddr</span> <span class="o">:</span> <span class="n">qaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* two destinations */</span>
				<span class="n">iter</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span>
								 <span class="n">index</span><span class="o">++</span><span class="p">);</span>
				<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
						<span class="n">qpath</span><span class="p">,</span> <span class="n">qaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_WXOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Setup destination(s) in remaining WXOR</span>
<span class="cm">				 * slots</span>
<span class="cm">				 */</span>
				<span class="n">iter</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span>
								 <span class="n">index</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* one destination */</span>
					<span class="n">list_for_each_entry_from</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span>
					    <span class="n">chain_node</span><span class="p">)</span>
						<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span>
							<span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
							<span class="n">DMA_CUED_XOR_BASE</span><span class="p">,</span>
							<span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* two destinations */</span>
					<span class="n">list_for_each_entry_from</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span>
					    <span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span>
							<span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
							<span class="n">DMA_CUED_XOR_BASE</span><span class="p">,</span>
							<span class="n">paddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
						<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span>
							<span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
							<span class="n">DMA_CUED_XOR_BASE</span><span class="p">,</span>
							<span class="n">qaddr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="cm">/* DMA2 descriptors have only 1 destination, so there are</span>
<span class="cm">		 * two chains - one for each dest.</span>
<span class="cm">		 * If we want to include destination into calculations,</span>
<span class="cm">		 * then make dest addresses cued with mult=1 (XOR).</span>
<span class="cm">		 */</span>
		<span class="n">ppath</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">DMA_CUED_XOR_HB</span> <span class="o">:</span>
				<span class="n">DMA_CUED_XOR_BASE</span> <span class="o">|</span>
					<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CUED_MULT1_OFF</span><span class="p">);</span>

		<span class="n">qpath</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_Q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">DMA_CUED_XOR_HB</span> <span class="o">:</span>
				<span class="n">DMA_CUED_XOR_BASE</span> <span class="o">|</span>
					<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CUED_MULT1_OFF</span><span class="p">);</span>

		<span class="n">iter</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">descs_per_op</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
				<span class="n">paddr</span> <span class="o">?</span> <span class="n">ppath</span> <span class="o">:</span> <span class="n">qpath</span><span class="p">,</span>
				<span class="n">paddr</span> <span class="o">?</span> <span class="n">paddr</span> <span class="o">:</span> <span class="n">qaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">iter</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
					  <span class="n">chain_node</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Two destinations; setup Q here */</span>
			<span class="n">iter</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span>
				<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">descs_per_op</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">descs_per_op</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span>
					<span class="n">chan</span><span class="p">,</span> <span class="n">qpath</span><span class="p">,</span> <span class="n">qaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">iter</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
						<span class="n">chain_node</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_pq_zero_sum_set_dest - set destination address into descriptor</span>
<span class="cm"> * for the PQ_ZERO_SUM operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_pqzero_sum_set_dest</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">sw_desc</span><span class="p">,</span>
		<span class="n">dma_addr_t</span> <span class="n">paddr</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">qaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">chan</span><span class="p">);</span>

	<span class="cm">/* walk through the WXOR source list and set P/Q-destinations</span>
<span class="cm">	 * for each slot</span>
<span class="cm">	 */</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">paddr</span> <span class="o">&amp;&amp;</span> <span class="n">qaddr</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* set end */</span>
	<span class="n">list_for_each_entry_reverse</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span>
				    <span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">--</span><span class="n">idx</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* set start */</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">paddr</span> <span class="o">&amp;&amp;</span> <span class="n">qaddr</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">iter</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">paddr</span> <span class="o">&amp;&amp;</span> <span class="n">qaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* two destinations */</span>
		<span class="n">list_for_each_entry_from</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span>
					 <span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">iter</span> <span class="o">==</span> <span class="n">end</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
						<span class="n">DMA_CUED_XOR_BASE</span><span class="p">,</span> <span class="n">paddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
						<span class="n">DMA_CUED_XOR_BASE</span><span class="p">,</span> <span class="n">qaddr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* one destination */</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">paddr</span> <span class="o">?</span> <span class="n">paddr</span> <span class="o">:</span> <span class="n">qaddr</span><span class="p">;</span>
		<span class="n">list_for_each_entry_from</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span>
					 <span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">iter</span> <span class="o">==</span> <span class="n">end</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ppc440spe_desc_set_dest_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
						<span class="n">DMA_CUED_XOR_BASE</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*  The remaining descriptors are DATACHECK. These have no need in</span>
<span class="cm">	 * destination. Actually, these destinations are used there</span>
<span class="cm">	 * as sources for check operation. So, set addr as source.</span>
<span class="cm">	 */</span>
	<span class="n">ppc440spe_desc_set_src_addr</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">addr</span> <span class="o">?</span> <span class="n">addr</span> <span class="o">:</span> <span class="n">paddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">end</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span> <span class="n">chain_node</span><span class="p">);</span>
		<span class="n">ppc440spe_desc_set_src_addr</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qaddr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_desc_set_xor_src_cnt - set source count into descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ppc440spe_desc_set_xor_src_cnt</span><span class="p">(</span>
			<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">src_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xor_cb</span> <span class="o">*</span><span class="n">hw_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>

	<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">cbc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XOR_CDCR_OAC_MSK</span><span class="p">;</span>
	<span class="n">hw_desc</span><span class="o">-&gt;</span><span class="n">cbc</span> <span class="o">|=</span> <span class="n">src_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_pq_set_src - set source address into descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_pq_set_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">sw_desc</span><span class="p">,</span>
		<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">haddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">iter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="cm">/* DMA0,1 may do: WXOR, RXOR, RXOR+WXORs chain</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* RXOR-only or RXOR/WXOR operation */</span>
			<span class="kt">int</span> <span class="n">iskip</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR12</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span>  <span class="mi">2</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* 1st slot (RXOR) */</span>
				<span class="cm">/* setup sources region (R1-2-3, R1-2-4,</span>
<span class="cm">				 * or R1-2-5)</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR12</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
					<span class="n">haddr</span> <span class="o">=</span> <span class="n">DMA_RXOR12</span> <span class="o">&lt;&lt;</span>
						<span class="n">DMA_CUED_REGION_OFF</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR123</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
					<span class="n">haddr</span> <span class="o">=</span> <span class="n">DMA_RXOR123</span> <span class="o">&lt;&lt;</span>
						<span class="n">DMA_CUED_REGION_OFF</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR124</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
					<span class="n">haddr</span> <span class="o">=</span> <span class="n">DMA_RXOR124</span> <span class="o">&lt;&lt;</span>
						<span class="n">DMA_CUED_REGION_OFF</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR125</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
					<span class="n">haddr</span> <span class="o">=</span> <span class="n">DMA_RXOR125</span> <span class="o">&lt;&lt;</span>
						<span class="n">DMA_CUED_REGION_OFF</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">BUG</span><span class="p">();</span>
				<span class="n">haddr</span> <span class="o">|=</span> <span class="n">DMA_CUED_XOR_BASE</span><span class="p">;</span>
				<span class="n">iter</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">iskip</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* 1st slot (RXOR)</span>
<span class="cm">				 * shall actually set source address only once</span>
<span class="cm">				 * instead of first &lt;iskip&gt;</span>
<span class="cm">				 */</span>
				<span class="n">iter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* 2nd/3d and next slots (WXOR);</span>
<span class="cm">				 * skip first slot with RXOR</span>
<span class="cm">				 */</span>
				<span class="n">haddr</span> <span class="o">=</span> <span class="n">DMA_CUED_XOR_HB</span><span class="p">;</span>
				<span class="n">iter</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span>
				    <span class="n">index</span> <span class="o">-</span> <span class="n">iskip</span> <span class="o">+</span> <span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">znum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* WXOR-only operation; skip first slots with</span>
<span class="cm">			 * zeroing destinations</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">znum</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_Q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">znum</span><span class="o">++</span><span class="p">;</span>

			<span class="n">haddr</span> <span class="o">=</span> <span class="n">DMA_CUED_XOR_HB</span><span class="p">;</span>
			<span class="n">iter</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span>
					<span class="n">index</span> <span class="o">+</span> <span class="n">znum</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">iter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ppc440spe_desc_set_src_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">haddr</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">index</span> <span class="o">&amp;&amp;</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* if we have two destinations for RXOR, then</span>
<span class="cm">				 * setup source in the second descr too</span>
<span class="cm">				 */</span>
				<span class="n">iter</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">ppc440spe_desc_set_src_addr</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">haddr</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="cm">/* DMA2 may do Biskup */</span>
		<span class="n">iter</span> <span class="o">=</span> <span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_head</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* both P &amp; Q calculations required; set P src here */</span>
			<span class="n">ppc440spe_adma_dma2rxor_set_src</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

			<span class="cm">/* this is for Q */</span>
			<span class="n">iter</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span>
				<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">descs_per_op</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ppc440spe_adma_dma2rxor_set_src</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_memcpy_xor_set_src - set source address into descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_memcpy_xor_set_src</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">sw_desc</span><span class="p">,</span>
		<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">sw_desc</span> <span class="o">=</span> <span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_head</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">))</span>
		<span class="n">ppc440spe_desc_set_src_addr</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_dma2rxor_inc_addr  -</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_dma2rxor_inc_addr</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ppc440spe_rxor</span> <span class="o">*</span><span class="n">cursor</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addr_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">src_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppc440spe_desc_set_xor_src_cnt</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addr_count</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addr_count</span> <span class="o">==</span> <span class="n">XOR_MAX_OPS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppc440spe_desc_set_xor_src_cnt</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addr_count</span><span class="p">);</span>
		<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addr_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">desc_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_dma2rxor_prep_src - setup RXOR types in DMA2 CDB</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc440spe_adma_dma2rxor_prep_src</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">hdesc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ppc440spe_rxor</span> <span class="o">*</span><span class="n">cursor</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">src_cnt</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sign</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">hdesc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">desc_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">hdesc</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
				  <span class="n">chain_node</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addrl</span> <span class="o">+</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* direct RXOR */</span>
			<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">xor_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">src_cnt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ppc440spe_rxor_set_region</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span>
					<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addr_count</span><span class="p">,</span>
					<span class="n">DMA_RXOR12</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CUED_REGION_OFF</span><span class="p">);</span>
				<span class="n">ppc440spe_adma_dma2rxor_inc_addr</span><span class="p">(</span>
					<span class="n">desc</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addrl</span> <span class="o">==</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* reverse RXOR */</span>
			<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">xor_count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addr_count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">reverse_flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">src_cnt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ppc440spe_rxor_set_region</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span>
					<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addr_count</span><span class="p">,</span>
					<span class="n">DMA_RXOR12</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CUED_REGION_OFF</span><span class="p">);</span>
				<span class="n">ppc440spe_adma_dma2rxor_inc_addr</span><span class="p">(</span>
					<span class="n">desc</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Cannot build &quot;</span>
				<span class="s">&quot;DMA2 RXOR command block.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">sign</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addr_count</span><span class="p">,</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">reverse_flags</span><span class="p">)</span>
			<span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">src_cnt</span><span class="o">-</span><span class="mi">2</span> <span class="o">||</span> <span class="p">(</span><span class="n">sign</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
			<span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">!=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addrl</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">xor_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addrl</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="n">ppc440spe_rxor_set_region</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span>
				<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addr_count</span><span class="p">,</span>
				<span class="n">DMA_RXOR12</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CUED_REGION_OFF</span><span class="p">);</span>
			<span class="n">ppc440spe_adma_dma2rxor_inc_addr</span><span class="p">(</span>
				<span class="n">desc</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addrl</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">sign</span><span class="o">*</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">xor_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ppc440spe_rxor_set_region</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span>
				<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addr_count</span><span class="p">,</span>
				<span class="n">DMA_RXOR123</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CUED_REGION_OFF</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">src_cnt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ppc440spe_adma_dma2rxor_inc_addr</span><span class="p">(</span>
					<span class="n">desc</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addrl</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">xor_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ppc440spe_rxor_set_region</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span>
				<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addr_count</span><span class="p">,</span>
				<span class="n">DMA_RXOR124</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CUED_REGION_OFF</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">src_cnt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ppc440spe_adma_dma2rxor_inc_addr</span><span class="p">(</span>
					<span class="n">desc</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addrl</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">xor_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ppc440spe_rxor_set_region</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span>
				<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addr_count</span><span class="p">,</span>
				<span class="n">DMA_RXOR125</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CUED_REGION_OFF</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">src_cnt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ppc440spe_adma_dma2rxor_inc_addr</span><span class="p">(</span>
					<span class="n">desc</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">xor_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addrl</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="n">ppc440spe_rxor_set_region</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span>
				<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addr_count</span><span class="p">,</span>
				<span class="n">DMA_RXOR12</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CUED_REGION_OFF</span><span class="p">);</span>
			<span class="n">ppc440spe_adma_dma2rxor_inc_addr</span><span class="p">(</span>
				<span class="n">desc</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">addrl</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">xor_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppc440spe_adma_dma2rxor_inc_addr</span><span class="p">(</span>
				<span class="n">desc</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">src_cnt</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_dma2rxor_set_src - set RXOR source address; it&#39;s assumed that</span>
<span class="cm"> *	ppc440spe_adma_dma2rxor_prep_src() has already done prior this call</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_dma2rxor_set_src</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xor_cb</span> <span class="o">*</span><span class="n">xcb</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* get the RXOR operand which corresponds to index addr */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">op</span> <span class="o">&lt;=</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lop</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">XOR_MAX_OPS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">desc</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span> <span class="n">chain_node</span><span class="p">);</span>
			<span class="n">xcb</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">xcb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">].</span><span class="n">h</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DMA_RXOR12</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CUED_REGION_OFF</span><span class="p">))</span> <span class="o">==</span>
		    <span class="p">(</span><span class="n">DMA_RXOR12</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CUED_REGION_OFF</span><span class="p">))</span>
			<span class="n">op</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">op</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">reverse_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* reverse operand order; put last op in RXOR group */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">op</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">ppc440spe_rxor_set_src</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* direct operand order; put first op in RXOR group */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">lop</span><span class="p">)</span>
			<span class="n">ppc440spe_rxor_set_src</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_dma2rxor_set_mult - set RXOR multipliers; it&#39;s assumed that</span>
<span class="cm"> *	ppc440spe_adma_dma2rxor_prep_src() has already done prior this call</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_dma2rxor_set_mult</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mult</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xor_cb</span> <span class="o">*</span><span class="n">xcb</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* get the RXOR operand which corresponds to index mult */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">op</span> <span class="o">&lt;=</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lop</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">XOR_MAX_OPS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">desc</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span><span class="p">,</span>
					  <span class="n">chain_node</span><span class="p">);</span>
			<span class="n">xcb</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw_desc</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">xcb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">].</span><span class="n">h</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DMA_RXOR12</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CUED_REGION_OFF</span><span class="p">))</span> <span class="o">==</span>
		    <span class="p">(</span><span class="n">DMA_RXOR12</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_CUED_REGION_OFF</span><span class="p">))</span>
			<span class="n">op</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">op</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">reverse_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* reverse order */</span>
		<span class="n">ppc440spe_rxor_set_mult</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">op</span> <span class="o">-</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mult</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* direct order */</span>
		<span class="n">ppc440spe_rxor_set_mult</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">index</span> <span class="o">-</span> <span class="n">lop</span><span class="p">,</span> <span class="n">mult</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_init_rxor_cursor -</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_init_rxor_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_rxor</span> <span class="o">*</span><span class="n">cursor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_rxor</span><span class="p">));</span>
	<span class="n">cursor</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_pq_set_src_mult - set multiplication coefficient into</span>
<span class="cm"> * descriptor for the PQXOR operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_pq_set_src_mult</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">sw_desc</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mult</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mult_idx</span><span class="p">,</span> <span class="n">mult_dst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">iter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">iter1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">region</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_RXOR12</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">region</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* RXOR multipliers */</span>
				<span class="n">iter</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span>
					<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">iter1</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span>
							<span class="n">sw_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

				<span class="n">mult_idx</span> <span class="o">=</span> <span class="n">DMA_CUED_MULT1_OFF</span> <span class="o">+</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
				<span class="n">mult_dst</span> <span class="o">=</span> <span class="n">DMA_CDB_SG_SRC</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* WXOR multiplier */</span>
				<span class="n">iter</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span>
							<span class="n">index</span> <span class="o">-</span> <span class="n">region</span> <span class="o">+</span>
							<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span><span class="p">);</span>
				<span class="n">mult_idx</span> <span class="o">=</span> <span class="n">DMA_CUED_MULT1_OFF</span><span class="p">;</span>
				<span class="n">mult_dst</span> <span class="o">=</span> <span class="n">dst_pos</span> <span class="o">?</span> <span class="n">DMA_CDB_SG_DST2</span> <span class="o">:</span>
						     <span class="n">DMA_CDB_SG_DST1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">znum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* WXOR-only;</span>
<span class="cm">			 * skip first slots with destinations (if ZERO_DST has</span>
<span class="cm">			 * place)</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">znum</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PPC440SPE_ZERO_Q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">znum</span><span class="o">++</span><span class="p">;</span>

			<span class="n">iter</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="n">znum</span><span class="p">);</span>
			<span class="n">mult_idx</span> <span class="o">=</span> <span class="n">DMA_CUED_MULT1_OFF</span><span class="p">;</span>
			<span class="n">mult_dst</span> <span class="o">=</span> <span class="n">dst_pos</span> <span class="o">?</span> <span class="n">DMA_CDB_SG_DST2</span> <span class="o">:</span> <span class="n">DMA_CDB_SG_DST1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">iter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ppc440spe_desc_set_src_mult</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
				<span class="n">mult_idx</span><span class="p">,</span> <span class="n">mult_dst</span><span class="p">,</span> <span class="n">mult</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">iter1</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* if we have two destinations for RXOR, then</span>
<span class="cm">				 * we&#39;ve just set Q mult. Set-up P now.</span>
<span class="cm">				 */</span>
				<span class="n">ppc440spe_desc_set_src_mult</span><span class="p">(</span><span class="n">iter1</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
					<span class="n">mult_idx</span><span class="p">,</span> <span class="n">mult_dst</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="n">iter</span> <span class="o">=</span> <span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_head</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">dst_cnt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* both P &amp; Q calculations required; set P mult here */</span>
			<span class="n">ppc440spe_adma_dma2rxor_set_mult</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* and then set Q mult */</span>
			<span class="n">iter</span> <span class="o">=</span> <span class="n">ppc440spe_get_group_entry</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span>
			       <span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">descs_per_op</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ppc440spe_adma_dma2rxor_set_mult</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">mult</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_free_chan_resources - free the resources allocated</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_free_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">ppc440spe_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="o">*</span><span class="n">_iter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">in_use_descs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ppc440spe_chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">ppc440spe_adma_slot_cleanup</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">_iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">,</span>
					<span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">in_use_descs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">chain_node</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">list_for_each_entry_safe_reverse</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">_iter</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">all_slots</span><span class="p">,</span> <span class="n">slot_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">slot_node</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">iter</span><span class="p">);</span>
		<span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">slots_allocated</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">last_used</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;ppc440spe adma%d %s slots_allocated %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">slots_allocated</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* one is ok since we left it on there on purpose */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_use_descs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SPE: Freeing %d in use descriptors!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">in_use_descs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_tx_status - poll the status of an ADMA transaction</span>
<span class="cm"> * @chan: ADMA channel handle</span>
<span class="cm"> * @cookie: ADMA transaction identifier</span>
<span class="cm"> * @txstate: a holder for the current state of the channel</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">dma_status</span> <span class="nf">ppc440spe_adma_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
			<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_tx_state</span> <span class="o">*</span><span class="n">txstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">ppc440spe_chan</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_status</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ppc440spe_chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_cookie_status</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">txstate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">DMA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ppc440spe_adma_slot_cleanup</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dma_cookie_status</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">txstate</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_eot_handler - end of transfer interrupt handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ppc440spe_adma_eot_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;ppc440spe adma%d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">irq_tasklet</span><span class="p">);</span>
	<span class="n">ppc440spe_adma_device_clear_eot_status</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_err_handler - DMA error interrupt handler;</span>
<span class="cm"> *	do the same things as a eot handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ppc440spe_adma_err_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;ppc440spe adma%d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">irq_tasklet</span><span class="p">);</span>
	<span class="n">ppc440spe_adma_device_clear_eot_status</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_test_callback - called when test operation has been done</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_test_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_r6_test_comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_issue_pending - flush all pending descriptors to h/w</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_issue_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">ppc440spe_chan</span><span class="p">;</span>

	<span class="n">ppc440spe_chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;ppc440spe adma%d: %s %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ppc440spe_chan_append</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_chan_start_null_xor - initiate the first XOR operation (DMA engines</span>
<span class="cm"> *	use FIFOs (as opposite to chains used in XOR) so this is a XOR</span>
<span class="cm"> *	specific operation)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_chan_start_null_xor</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">sw_desc</span><span class="p">,</span> <span class="o">*</span><span class="n">group_start</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot_cnt</span><span class="p">,</span> <span class="n">slots_per_op</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;ppc440spe adma%d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">slot_cnt</span> <span class="o">=</span> <span class="n">ppc440spe_chan_xor_slot_count</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slots_per_op</span><span class="p">);</span>
	<span class="n">sw_desc</span> <span class="o">=</span> <span class="n">ppc440spe_adma_alloc_slots</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">slot_cnt</span><span class="p">,</span> <span class="n">slots_per_op</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sw_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">group_start</span> <span class="o">=</span> <span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_head</span><span class="p">;</span>
		<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">);</span>
		<span class="n">async_tx_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">);</span>
		<span class="n">ppc440spe_desc_init_null_xor</span><span class="p">(</span><span class="n">group_start</span><span class="p">);</span>

		<span class="n">cookie</span> <span class="o">=</span> <span class="n">dma_cookie_assign</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">);</span>

		<span class="cm">/* initialize the completed cookie to be less than</span>
<span class="cm">		 * the most recently used cookie</span>
<span class="cm">		 */</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">completed_cookie</span> <span class="o">=</span> <span class="n">cookie</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* channel should not be busy */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ppc440spe_chan_is_busy</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>

		<span class="cm">/* set the descriptor address */</span>
		<span class="n">ppc440spe_chan_set_first_xor_descriptor</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">sw_desc</span><span class="p">);</span>

		<span class="cm">/* run the descriptor */</span>
		<span class="n">ppc440spe_chan_run</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ppc440spe adma%d&quot;</span>
			<span class="s">&quot; failed to allocate null descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_test_raid6 - test are RAID-6 capabilities enabled successfully.</span>
<span class="cm"> *	For this we just perform one WXOR operation with the same source</span>
<span class="cm"> *	and destination addresses, the GF-multiplier is 1; so if RAID-6</span>
<span class="cm"> *	capabilities are enabled then we&#39;ll get src/dst filled with zero.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc440spe_test_raid6</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_desc_slot</span> <span class="o">*</span><span class="n">sw_desc</span><span class="p">,</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">pg</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">addrs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">op</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">PPC440SPE_DESC_WXOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>

	<span class="n">pg</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">sw_desc</span> <span class="o">=</span> <span class="n">ppc440spe_adma_alloc_slots</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sw_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 1 src, 1 dsr, int_ena, WXOR */</span>
		<span class="n">ppc440spe_desc_init_dma01pq</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">group_list</span><span class="p">,</span> <span class="n">chain_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppc440spe_desc_set_byte_count</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">unmap_len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Fill the test page with ones */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">pg</span><span class="p">),</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dma_map_page</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="cm">/* Setup addresses */</span>
	<span class="n">ppc440spe_adma_pq_set_src</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ppc440spe_adma_pq_set_src_mult</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">addrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">addrs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ppc440spe_adma_pq_set_dest</span><span class="p">(</span><span class="n">sw_desc</span><span class="p">,</span> <span class="n">addrs</span><span class="p">,</span> <span class="n">DMA_PREP_PQ_DISABLE_Q</span><span class="p">);</span>

	<span class="n">async_tx_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">);</span>
	<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">ppc440spe_test_callback</span><span class="p">;</span>
	<span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">.</span><span class="n">callback_param</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_r6_test_comp</span><span class="p">);</span>

	<span class="n">ppc440spe_adma_tx_submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw_desc</span><span class="o">-&gt;</span><span class="n">async_tx</span><span class="p">);</span>
	<span class="n">ppc440spe_adma_issue_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">);</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_r6_test_comp</span><span class="p">);</span>

	<span class="cm">/* Now check if the test page is zeroed */</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">pg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* page is zero - RAID-6 enabled */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* RAID-6 was not enabled */</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="n">__free_page</span><span class="p">(</span><span class="n">pg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_init_capabilities</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
	<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_INTERRUPT</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_MEMSET</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_PQ</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_PQ_VAL</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_XOR_VAL</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_XOR</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_PQ</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_INTERRUPT</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">);</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set base routines */</span>
	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">device_alloc_chan_resources</span> <span class="o">=</span>
				<span class="n">ppc440spe_adma_alloc_chan_resources</span><span class="p">;</span>
	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">device_free_chan_resources</span> <span class="o">=</span>
				<span class="n">ppc440spe_adma_free_chan_resources</span><span class="p">;</span>
	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">device_tx_status</span> <span class="o">=</span> <span class="n">ppc440spe_adma_tx_status</span><span class="p">;</span>
	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">device_issue_pending</span> <span class="o">=</span> <span class="n">ppc440spe_adma_issue_pending</span><span class="p">;</span>

	<span class="cm">/* Set prep routines based on capability */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">device_prep_dma_memcpy</span> <span class="o">=</span>
			<span class="n">ppc440spe_adma_prep_dma_memcpy</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_MEMSET</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">device_prep_dma_memset</span> <span class="o">=</span>
			<span class="n">ppc440spe_adma_prep_dma_memset</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_XOR</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">max_xor</span> <span class="o">=</span> <span class="n">XOR_MAX_OPS</span><span class="p">;</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">device_prep_dma_xor</span> <span class="o">=</span>
			<span class="n">ppc440spe_adma_prep_dma_xor</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_PQ</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
			<span class="n">dma_set_maxpq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">,</span>
				<span class="n">DMA0_FIFO_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
			<span class="n">dma_set_maxpq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">,</span>
				<span class="n">DMA1_FIFO_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PPC440SPE_XOR_ID</span>:
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">max_pq</span> <span class="o">=</span> <span class="n">XOR_MAX_OPS</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">device_prep_dma_pq</span> <span class="o">=</span>
			<span class="n">ppc440spe_adma_prep_dma_pq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_PQ_VAL</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">max_pq</span> <span class="o">=</span> <span class="n">DMA0_FIFO_SIZE</span> <span class="o">/</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">max_pq</span> <span class="o">=</span> <span class="n">DMA1_FIFO_SIZE</span> <span class="o">/</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">device_prep_dma_pq_val</span> <span class="o">=</span>
			<span class="n">ppc440spe_adma_prep_dma_pqzero_sum</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_XOR_VAL</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PPC440SPE_DMA0_ID</span>:
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">max_xor</span> <span class="o">=</span> <span class="n">DMA0_FIFO_SIZE</span> <span class="o">/</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PPC440SPE_DMA1_ID</span>:
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">max_xor</span> <span class="o">=</span> <span class="n">DMA1_FIFO_SIZE</span> <span class="o">/</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_cdb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">device_prep_dma_xor_val</span> <span class="o">=</span>
			<span class="n">ppc440spe_adma_prep_dma_xor_zero_sum</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_INTERRUPT</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">device_prep_dma_interrupt</span> <span class="o">=</span>
			<span class="n">ppc440spe_adma_prep_dma_interrupt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: AMCC(R) PPC440SP(E) ADMA Engine: &quot;</span>
	  <span class="s">&quot;( %s%s%s%s%s%s%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="n">dev_name</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
	  <span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_PQ</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;pq &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	  <span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_PQ_VAL</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;pq_val &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	  <span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_XOR</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;xor &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	  <span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_XOR_VAL</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;xor_val &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	  <span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;memcpy &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	  <span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_MEMSET</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">)</span>  <span class="o">?</span> <span class="s">&quot;memset &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	  <span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_INTERRUPT</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">cap_mask</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;intr &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc440spe_adma_setup_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="o">*</span><span class="n">initcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ofdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ofdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">platform_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">np</span> <span class="o">=</span> <span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">PPC440SPE_XOR_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">err_irq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">err_irq</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no err irq resource?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="o">*</span><span class="n">initcode</span> <span class="o">=</span> <span class="n">PPC_ADMA_INIT_IRQ2</span><span class="p">;</span>
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">err_irq</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_adma_err_irq_ref</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">err_irq</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no irq resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">initcode</span> <span class="o">=</span> <span class="n">PPC_ADMA_INIT_IRQ1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_irq_map</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq %d, err irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">err_irq</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ppc440spe_adma_eot_handler</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">,</span> <span class="n">dev_driver_string</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">chan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t request irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="o">*</span><span class="n">initcode</span> <span class="o">=</span> <span class="n">PPC_ADMA_INIT_IRQ1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_req1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* only DMA engines have a separate error IRQ</span>
<span class="cm">	 * so it&#39;s Ok if err_irq &lt; 0 in XOR engine case.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">err_irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* both DMA engines share common error IRQ */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">err_irq</span><span class="p">,</span>
				  <span class="n">ppc440spe_adma_err_handler</span><span class="p">,</span>
				  <span class="n">IRQF_SHARED</span><span class="p">,</span>
				  <span class="n">dev_driver_string</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
				  <span class="n">chan</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t request irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">adev</span><span class="o">-&gt;</span><span class="n">err_irq</span><span class="p">);</span>
			<span class="o">*</span><span class="n">initcode</span> <span class="o">=</span> <span class="n">PPC_ADMA_INIT_IRQ2</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_req2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">PPC440SPE_XOR_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable XOR engine interrupts */</span>
		<span class="n">iowrite32be</span><span class="p">(</span><span class="n">XOR_IE_CBCIE_BIT</span> <span class="o">|</span> <span class="n">XOR_IE_ICBIE_BIT</span> <span class="o">|</span>
			    <span class="n">XOR_IE_ICIE_BIT</span> <span class="o">|</span> <span class="n">XOR_IE_RPTIE_BIT</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">enable</span><span class="p">;</span>

		<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_compatible_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ibm,i2o-440spe&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t find I2O device tree node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_req2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">i2o_reg</span> <span class="o">=</span> <span class="n">of_iomap</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">i2o_reg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: failed to map I2O registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_req2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="cm">/* Unmask &#39;CS FIFO Attention&#39; interrupts and</span>
<span class="cm">		 * enable generating interrupts on errors</span>
<span class="cm">		 */</span>
		<span class="n">enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">PPC440SPE_DMA0_ID</span><span class="p">)</span> <span class="o">?</span>
			 <span class="o">~</span><span class="p">(</span><span class="n">I2O_IOPIM_P0SNE</span> <span class="o">|</span> <span class="n">I2O_IOPIM_P0EM</span><span class="p">)</span> <span class="o">:</span>
			 <span class="o">~</span><span class="p">(</span><span class="n">I2O_IOPIM_P1SNE</span> <span class="o">|</span> <span class="n">I2O_IOPIM_P1EM</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">i2o_reg</span><span class="o">-&gt;</span><span class="n">iopim</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">enable</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">i2o_reg</span><span class="o">-&gt;</span><span class="n">iopim</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_req2:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
<span class="nl">err_req1:</span>
	<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="nl">err_irq_map:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">err_irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_adma_err_irq_ref</span><span class="p">))</span>
			<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">err_irq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc440spe_adma_release_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc440spe_adma_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">disable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">PPC440SPE_XOR_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable XOR engine interrupts */</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">XOR_IE_CBCIE_BIT</span> <span class="o">|</span> <span class="n">XOR_IE_ICBIE_BIT</span> <span class="o">|</span>
			  <span class="n">XOR_IE_ICIE_BIT</span> <span class="o">|</span> <span class="n">XOR_IE_RPTIE_BIT</span><span class="p">);</span>
		<span class="n">iowrite32be</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* disable DMAx engine interrupts */</span>
		<span class="n">disable</span> <span class="o">=</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">PPC440SPE_DMA0_ID</span><span class="p">)</span> <span class="o">?</span>
			  <span class="p">(</span><span class="n">I2O_IOPIM_P0SNE</span> <span class="o">|</span> <span class="n">I2O_IOPIM_P0EM</span><span class="p">)</span> <span class="o">:</span>
			  <span class="p">(</span><span class="n">I2O_IOPIM_P1SNE</span> <span class="o">|</span> <span class="n">I2O_IOPIM_P1EM</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">i2o_reg</span><span class="o">-&gt;</span><span class="n">iopim</span><span class="p">)</span> <span class="o">|</span> <span class="n">disable</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">i2o_reg</span><span class="o">-&gt;</span><span class="n">iopim</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">err_irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">err_irq</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_adma_err_irq_ref</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">err_irq</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">i2o_reg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_probe - probe the asynch device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ppc440spe_adma_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ofdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc_dma_chan_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span> <span class="o">*</span><span class="n">_ref</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">initcode</span> <span class="o">=</span> <span class="n">PPC_ADMA_INIT_OK</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;amcc,xor-accelerator&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">PPC440SPE_XOR_ID</span><span class="p">;</span>
		<span class="cm">/* As far as the XOR engine is concerned, it does not</span>
<span class="cm">		 * use FIFOs but uses linked list. So there is no dependency</span>
<span class="cm">		 * between pool size to allocate and the engine configuration.</span>
<span class="cm">		 */</span>
		<span class="n">pool_size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* it is DMA0 or DMA1 */</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;cell-index&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idx</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device node %s has missing &quot;</span>
				<span class="s">&quot;or invalid cell-index property</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">id</span> <span class="o">=</span> <span class="o">*</span><span class="n">idx</span><span class="p">;</span>
		<span class="cm">/* DMA0,1 engines use FIFO to maintain CDBs, so we</span>
<span class="cm">		 * should allocate the pool accordingly to size of this</span>
<span class="cm">		 * FIFO. Thus, the pool size depends on the FIFO depth:</span>
<span class="cm">		 * how much CDBs pointers the FIFO may contain then so</span>
<span class="cm">		 * much CDBs we should provide in the pool.</span>
<span class="cm">		 * That is</span>
<span class="cm">		 *   CDB size = 32B;</span>
<span class="cm">		 *   CDBs number = (DMA0_FIFO_SIZE &gt;&gt; 3);</span>
<span class="cm">		 *   Pool size = CDBs number * CDB size =</span>
<span class="cm">		 *      = (DMA0_FIFO_SIZE &gt;&gt; 3) &lt;&lt; 5 = DMA0_FIFO_SIZE &lt;&lt; 2.</span>
<span class="cm">		 */</span>
		<span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">PPC440SPE_DMA0_ID</span><span class="p">)</span> <span class="o">?</span>
			    <span class="n">DMA0_FIFO_SIZE</span> <span class="o">:</span> <span class="n">DMA1_FIFO_SIZE</span><span class="p">;</span>
		<span class="n">pool_size</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get memory resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">initcode</span> <span class="o">=</span> <span class="n">PPC_ADMA_INIT_MEMRES</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">),</span>
				<span class="n">dev_driver_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to request memory region %pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
		<span class="n">initcode</span> <span class="o">=</span> <span class="n">PPC_ADMA_INIT_MEMREG</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* create a device */</span>
	<span class="n">adev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">adev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">initcode</span> <span class="o">=</span> <span class="n">PPC_ADMA_INIT_ALLOC</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_adev_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">pool_size</span> <span class="o">=</span> <span class="n">pool_size</span><span class="p">;</span>
	<span class="cm">/* allocate coherent memory for hardware descriptors */</span>
	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_desc_pool_virt</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">adev</span><span class="o">-&gt;</span><span class="n">pool_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_desc_pool</span><span class="p">,</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_desc_pool_virt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate %d bytes of coherent &quot;</span>
			<span class="s">&quot;memory for hardware descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">pool_size</span><span class="p">);</span>
		<span class="n">initcode</span> <span class="o">=</span> <span class="n">PPC_ADMA_INIT_COHERENT</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_dma_alloc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;allocted descriptor pool virt 0x%p phys 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_desc_pool_virt</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_desc_pool</span><span class="p">);</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to ioremap regs!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_regs_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">PPC440SPE_XOR_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">xor_reg</span> <span class="o">=</span> <span class="n">regs</span><span class="p">;</span>
		<span class="cm">/* Reset XOR */</span>
		<span class="n">iowrite32be</span><span class="p">(</span><span class="n">XOR_CRSR_XASR_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">crsr</span><span class="p">);</span>
		<span class="n">iowrite32be</span><span class="p">(</span><span class="n">XOR_CRSR_64BA_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">xor_reg</span><span class="o">-&gt;</span><span class="n">crrr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">fifo_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">PPC440SPE_DMA0_ID</span><span class="p">)</span> <span class="o">?</span>
				   <span class="n">DMA0_FIFO_SIZE</span> <span class="o">:</span> <span class="n">DMA1_FIFO_SIZE</span><span class="p">;</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_reg</span> <span class="o">=</span> <span class="n">regs</span><span class="p">;</span>
		<span class="cm">/* DMAx_FIFO_SIZE is defined in bytes,</span>
<span class="cm">		 * &lt;fsiz&gt; - is defined in number of CDB pointers (8byte).</span>
<span class="cm">		 * DMA FIFO Length = CSlength + CPlength, where</span>
<span class="cm">		 * CSlength = CPlength = (fsiz + 1) * 8.</span>
<span class="cm">		 */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">DMA_FIFO_ENABLE</span> <span class="o">|</span> <span class="p">((</span><span class="n">fifo_size</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">),</span>
			  <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_reg</span><span class="o">-&gt;</span><span class="n">fsiz</span><span class="p">);</span>
		<span class="cm">/* Configure DMA engine */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">DMA_CFG_DXEPR_HP</span> <span class="o">|</span> <span class="n">DMA_CFG_DFMPP_HP</span> <span class="o">|</span> <span class="n">DMA_CFG_FALGN</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_reg</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">);</span>
		<span class="cm">/* Clear Status */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_reg</span><span class="o">-&gt;</span><span class="n">dsts</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">channels</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">adev</span><span class="p">);</span>

	<span class="cm">/* create a channel */</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chan</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t allocate channel structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">initcode</span> <span class="o">=</span> <span class="n">PPC_ADMA_INIT_CHANNEL</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_chan_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">all_slots</span><span class="p">);</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">adev</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">;</span>
	<span class="n">dma_cookie_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">device_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">channels</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">irq_tasklet</span><span class="p">,</span> <span class="n">ppc440spe_adma_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">chan</span><span class="p">);</span>

	<span class="cm">/* allocate and map helper pages for async validation or</span>
<span class="cm">	 * async_mult/async_sum_product operations on DMA0/1.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">PPC440SPE_XOR_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">pdest_page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">qdest_page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">pdest_page</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">qdest_page</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">pdest_page</span><span class="p">)</span>
				<span class="n">__free_page</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">pdest_page</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">qdest_page</span><span class="p">)</span>
				<span class="n">__free_page</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">qdest_page</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_page_alloc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">pdest</span> <span class="o">=</span> <span class="n">dma_map_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">pdest_page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">qdest</span> <span class="o">=</span> <span class="n">dma_map_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">qdest_page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ref</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ref</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ref</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppc440spe_adma_chan_list</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate channel reference!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_ref_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ppc440spe_adma_setup_irqs</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">initcode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>

	<span class="n">ppc440spe_adma_init_capabilities</span><span class="p">(</span><span class="n">adev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_async_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">initcode</span> <span class="o">=</span> <span class="n">PPC_ADMA_INIT_REGISTER</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register dma device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_dev_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">err_dev_reg:</span>
	<span class="n">ppc440spe_adma_release_irqs</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
<span class="nl">err_irq:</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">_ref</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppc440spe_adma_chan_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">err_ref_alloc:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">PPC440SPE_XOR_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_unmap_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">pdest</span><span class="p">,</span>
			       <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
		<span class="n">dma_unmap_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">qdest</span><span class="p">,</span>
			       <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
		<span class="n">__free_page</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">pdest_page</span><span class="p">);</span>
		<span class="n">__free_page</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">qdest_page</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">err_page_alloc:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
<span class="nl">err_chan_alloc:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">PPC440SPE_XOR_ID</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">xor_reg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_reg</span><span class="p">);</span>
<span class="nl">err_regs_alloc:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">pool_size</span><span class="p">,</span>
			  <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_desc_pool_virt</span><span class="p">,</span>
			  <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_desc_pool</span><span class="p">);</span>
<span class="nl">err_dma_alloc:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adev</span><span class="p">);</span>
<span class="nl">err_adev_alloc:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">));</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">PPC440SPE_ADMA_ENGINES_NUM</span><span class="p">)</span>
		<span class="n">ppc440spe_adma_devices</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">initcode</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ppc440spe_adma_remove - remove the asynch device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">ppc440spe_adma_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ofdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_device</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="o">*</span><span class="n">_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc_dma_chan_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span> <span class="o">*</span><span class="n">_ref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc440spe_adma_chan</span> <span class="o">*</span><span class="n">ppc440spe_chan</span><span class="p">;</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">PPC440SPE_ADMA_ENGINES_NUM</span><span class="p">)</span>
		<span class="n">ppc440spe_adma_devices</span><span class="p">[</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">dma_async_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">_chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">channels</span><span class="p">,</span>
				 <span class="n">device_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppc440spe_chan</span> <span class="o">=</span> <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">ppc440spe_adma_release_irqs</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="p">);</span>
		<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">irq_tasklet</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">PPC440SPE_XOR_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_unmap_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">pdest</span><span class="p">,</span>
					<span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
			<span class="n">dma_unmap_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">qdest</span><span class="p">,</span>
					<span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
			<span class="n">__free_page</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">pdest_page</span><span class="p">);</span>
			<span class="n">__free_page</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="o">-&gt;</span><span class="n">qdest_page</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">_ref</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppc440spe_adma_chan_list</span><span class="p">,</span>
					 <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ppc440spe_chan</span> <span class="o">==</span>
			    <span class="n">to_ppc440spe_adma_chan</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device_node</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ppc440spe_chan</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">pool_size</span><span class="p">,</span>
			  <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_desc_pool_virt</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_desc_pool</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">PPC440SPE_XOR_ID</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">xor_reg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_reg</span><span class="p">);</span>
	<span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * /sys driver interface to enable h/w RAID-6 capabilities</span>
<span class="cm"> * Files created in e.g. /sys/devices/plb.0/400100100.dma0/driver/</span>
<span class="cm"> * directory are &quot;devices&quot;, &quot;enable&quot; and &quot;poly&quot;.</span>
<span class="cm"> * &quot;devices&quot; shows available engines.</span>
<span class="cm"> * &quot;enable&quot; is used to enable RAID-6 capabilities or to check</span>
<span class="cm"> * whether these has been activated.</span>
<span class="cm"> * &quot;poly&quot; allows setting/checking used polynomial (for PPC440SPe only).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_ppc440spe_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PPC440SPE_ADMA_ENGINES_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppc440spe_adma_devices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">size</span><span class="p">,</span>
				 <span class="s">&quot;PPC440SP(E)-ADMA.%d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				 <span class="n">ppc_adma_errors</span><span class="p">[</span><span class="n">ppc440spe_adma_devices</span><span class="p">[</span><span class="n">i</span><span class="p">]]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_ppc440spe_r6enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
			<span class="s">&quot;PPC440SP(e) RAID-6 capabilities are %sABLED.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ppc440spe_r6_enabled</span> <span class="o">?</span> <span class="s">&quot;EN&quot;</span> <span class="o">:</span> <span class="s">&quot;DIS&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_ppc440spe_r6enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">11</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppc440spe_r6_tchan</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* Write a key */</span>
	<span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lx&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">ppc440spe_mq_dcr_host</span><span class="p">,</span> <span class="n">DCRN_MQ0_XORBA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">isync</span><span class="p">();</span>

	<span class="cm">/* Verify whether it really works now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc440spe_test_raid6</span><span class="p">(</span><span class="n">ppc440spe_r6_tchan</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;PPC440SP(e) RAID-6 has been activated &quot;</span>
			<span class="s">&quot;successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ppc440spe_r6_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;PPC440SP(e) RAID-6 hasn&#39;t been activated!&quot;</span>
			<span class="s">&quot; Error key ?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ppc440spe_r6_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_ppc440spe_r6poly</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_440SP</span>
	<span class="cm">/* 440SP has fixed polynomial */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x4d</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">dcr_read</span><span class="p">(</span><span class="n">ppc440spe_mq_dcr_host</span><span class="p">,</span> <span class="n">DCRN_MQ0_CFBHL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&gt;&gt;=</span> <span class="n">MQ0_CFBHL_POLY</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="mh">0xFF</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;PPC440SP(e) RAID-6 driver &quot;</span>
			<span class="s">&quot;uses 0x1%02x polynomial.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_ppc440spe_r6poly</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_440SP</span>
	<span class="cm">/* 440SP uses default 0x14D polynomial only */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* e.g., 0x14D or 0x11D */</span>
	<span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lx&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1FF</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">dcr_read</span><span class="p">(</span><span class="n">ppc440spe_mq_dcr_host</span><span class="p">,</span> <span class="n">DCRN_MQ0_CFBHL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFF</span> <span class="o">&lt;&lt;</span> <span class="n">MQ0_CFBHL_POLY</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">MQ0_CFBHL_POLY</span><span class="p">;</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">ppc440spe_mq_dcr_host</span><span class="p">,</span> <span class="n">DCRN_MQ0_CFBHL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_ppc440spe_devices</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_ppc440spe_r6enable</span><span class="p">,</span>
		   <span class="n">store_ppc440spe_r6enable</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_ppc440spe_r6poly</span><span class="p">,</span>
		   <span class="n">store_ppc440spe_r6poly</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Common initialisation for RAID engines; allocate memory for</span>
<span class="cm"> * DMAx FIFOs, perform configuration common for all DMA engines.</span>
<span class="cm"> * Further DMA engine specific configuration is done at probe time.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc440spe_configure_raid_devices</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">i2o_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2o_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">i2o_reg</span><span class="p">;</span>
	<span class="n">dcr_host_t</span> <span class="n">i2o_dcr_host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dcr_base</span><span class="p">,</span> <span class="n">dcr_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_compatible_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ibm,i2o-440spe&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t find I2O device tree node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2o_res</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i2o_reg</span> <span class="o">=</span> <span class="n">of_iomap</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2o_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: failed to map I2O registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get I2O DCRs base */</span>
	<span class="n">dcr_base</span> <span class="o">=</span> <span class="n">dcr_resource_start</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dcr_len</span> <span class="o">=</span> <span class="n">dcr_resource_len</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcr_base</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dcr_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t get DCR registers base/len!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">i2o_reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i2o_dcr_host</span> <span class="o">=</span> <span class="n">dcr_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">dcr_base</span><span class="p">,</span> <span class="n">dcr_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DCR_MAP_OK</span><span class="p">(</span><span class="n">i2o_dcr_host</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: failed to map DCRs!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">i2o_reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="cm">/* Provide memory regions for DMA&#39;s FIFOs: I2O, DMA0 and DMA1 share</span>
<span class="cm">	 * the base address of FIFO memory space.</span>
<span class="cm">	 * Actually we need twice more physical memory than programmed in the</span>
<span class="cm">	 * &lt;fsiz&gt; register (because there are two FIFOs for each DMA: CP and CS)</span>
<span class="cm">	 */</span>
	<span class="n">ppc440spe_dma_fifo_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="n">DMA0_FIFO_SIZE</span> <span class="o">+</span> <span class="n">DMA1_FIFO_SIZE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span>
					 <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppc440spe_dma_fifo_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: DMA FIFO buffer allocation failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">i2o_reg</span><span class="p">);</span>
		<span class="n">dcr_unmap</span><span class="p">(</span><span class="n">i2o_dcr_host</span><span class="p">,</span> <span class="n">dcr_len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure h/w</span>
<span class="cm">	 */</span>
	<span class="cm">/* Reset I2O/DMA */</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">DCRN_SDR0_SRST</span><span class="p">,</span> <span class="n">DCRN_SDR0_SRST_I2ODMA</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">DCRN_SDR0_SRST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Setup the base address of mmaped registers */</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">i2o_dcr_host</span><span class="p">,</span> <span class="n">DCRN_I2O0_IBAH</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">i2o_res</span><span class="p">.</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">i2o_dcr_host</span><span class="p">,</span> <span class="n">DCRN_I2O0_IBAL</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">i2o_res</span><span class="p">.</span><span class="n">start</span><span class="p">)</span> <span class="o">|</span>
						<span class="n">I2O_REG_ENABLE</span><span class="p">);</span>
	<span class="n">dcr_unmap</span><span class="p">(</span><span class="n">i2o_dcr_host</span><span class="p">,</span> <span class="n">dcr_len</span><span class="p">);</span>

	<span class="cm">/* Setup FIFO memory space base address */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2o_reg</span><span class="o">-&gt;</span><span class="n">ifbah</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">__pa</span><span class="p">(</span><span class="n">ppc440spe_dma_fifo_buf</span><span class="p">)),</span> <span class="o">&amp;</span><span class="n">i2o_reg</span><span class="o">-&gt;</span><span class="n">ifbal</span><span class="p">);</span>

	<span class="cm">/* set zero FIFO size for I2O, so the whole</span>
<span class="cm">	 * ppc440spe_dma_fifo_buf is used by DMAs.</span>
<span class="cm">	 * DMAx_FIFOs will be configured while probe.</span>
<span class="cm">	 */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2o_reg</span><span class="o">-&gt;</span><span class="n">ifsiz</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">i2o_reg</span><span class="p">);</span>

	<span class="cm">/* To prepare WXOR/RXOR functionality we need access to</span>
<span class="cm">	 * Memory Queue Module DCRs (finally it will be enabled</span>
<span class="cm">	 * via /sys interface of the ppc440spe ADMA driver).</span>
<span class="cm">	 */</span>
	<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_compatible_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ibm,mq-440spe&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t find MQ device tree node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get MQ DCRs base */</span>
	<span class="n">dcr_base</span> <span class="o">=</span> <span class="n">dcr_resource_start</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dcr_len</span> <span class="o">=</span> <span class="n">dcr_resource_len</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcr_base</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dcr_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t get DCR registers base/len!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ppc440spe_mq_dcr_host</span> <span class="o">=</span> <span class="n">dcr_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">dcr_base</span><span class="p">,</span> <span class="n">dcr_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DCR_MAP_OK</span><span class="p">(</span><span class="n">ppc440spe_mq_dcr_host</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: failed to map DCRs!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">ppc440spe_mq_dcr_len</span> <span class="o">=</span> <span class="n">dcr_len</span><span class="p">;</span>

	<span class="cm">/* Set HB alias */</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">ppc440spe_mq_dcr_host</span><span class="p">,</span> <span class="n">DCRN_MQ0_BAUH</span><span class="p">,</span> <span class="n">DMA_CUED_XOR_HB</span><span class="p">);</span>

	<span class="cm">/* Set:</span>
<span class="cm">	 * - LL transaction passing limit to 1;</span>
<span class="cm">	 * - Memory controller cycle limit to 1;</span>
<span class="cm">	 * - Galois Polynomial to 0x14d (default)</span>
<span class="cm">	 */</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">ppc440spe_mq_dcr_host</span><span class="p">,</span> <span class="n">DCRN_MQ0_CFBHL</span><span class="p">,</span>
		  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MQ0_CFBHL_TPLM</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MQ0_CFBHL_HBCL</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">(</span><span class="n">PPC440SPE_DEFAULT_POLY</span> <span class="o">&lt;&lt;</span> <span class="n">MQ0_CFBHL_POLY</span><span class="p">));</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_adma_err_irq_ref</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PPC440SPE_ADMA_ENGINES_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ppc440spe_adma_devices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_mq:</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ppc440spe_dma_fifo_buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">ppc440spe_adma_of_match</span><span class="p">[]</span> <span class="n">__devinitconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span>	<span class="o">=</span> <span class="s">&quot;ibm,dma-440spe&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span>	<span class="o">=</span> <span class="s">&quot;amcc,xor-accelerator&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">ppc440spe_adma_of_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">ppc440spe_adma_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ppc440spe_adma_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ppc440spe_adma_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PPC440SP(E)-ADMA&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">ppc440spe_adma_of_match</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">ppc440spe_adma_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ppc440spe_configure_raid_devices</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_adma_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: failed to register platform driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialization status */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_adma_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">driver_attr_devices</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_dev</span><span class="p">;</span>

	<span class="cm">/* RAID-6 h/w enable entry */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_adma_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">driver_attr_enable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_en</span><span class="p">;</span>

	<span class="cm">/* GF polynomial to use */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_adma_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">driver_attr_poly</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_adma_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">driver_attr_enable</span><span class="p">);</span>
<span class="nl">out_en:</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_adma_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">driver_attr_devices</span><span class="p">);</span>
<span class="nl">out_dev:</span>
	<span class="cm">/* User will not be able to enable h/w RAID-6 */</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: failed to create RAID-6 driver interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_adma_driver</span><span class="p">);</span>
<span class="nl">out_reg:</span>
	<span class="n">dcr_unmap</span><span class="p">(</span><span class="n">ppc440spe_mq_dcr_host</span><span class="p">,</span> <span class="n">ppc440spe_mq_dcr_len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ppc440spe_dma_fifo_buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ppc440spe_adma_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_adma_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">driver_attr_poly</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_adma_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">driver_attr_enable</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_adma_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">driver_attr_devices</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc440spe_adma_driver</span><span class="p">);</span>
	<span class="n">dcr_unmap</span><span class="p">(</span><span class="n">ppc440spe_mq_dcr_host</span><span class="p">,</span> <span class="n">ppc440spe_mq_dcr_len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ppc440spe_dma_fifo_buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">arch_initcall</span><span class="p">(</span><span class="n">ppc440spe_adma_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ppc440spe_adma_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Yuri Tikhonov &lt;yur@emcraft.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;PPC440SPE ADMA Engine Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
