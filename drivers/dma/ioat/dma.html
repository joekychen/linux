<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › dma › ioat › dma.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dma.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Intel I/OAT DMA Linux driver</span>
<span class="cm"> * Copyright(c) 2004 - 2009 Intel Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution in</span>
<span class="cm"> * the file called &quot;COPYING&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This driver supports an Intel I/OAT DMA engine, which does asynchronous</span>
<span class="cm"> * copy operations.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;linux/i7300_idle.h&gt;</span>
<span class="cp">#include &quot;dma.h&quot;</span>
<span class="cp">#include &quot;registers.h&quot;</span>
<span class="cp">#include &quot;hw.h&quot;</span>

<span class="cp">#include &quot;../dmaengine.h&quot;</span>

<span class="kt">int</span> <span class="n">ioat_pending_level</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ioat_pending_level</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ioat_pending_level</span><span class="p">,</span>
		 <span class="s">&quot;high-water mark for pushing ioat descriptors (default: 4)&quot;</span><span class="p">);</span>

<span class="cm">/* internal functions */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ioat1_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioat_dma_chan</span> <span class="o">*</span><span class="n">ioat</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ioat1_dma_start_null_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioat_dma_chan</span> <span class="o">*</span><span class="n">ioat</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ioat_dma_do_interrupt - handler used for single vector interrupt mode</span>
<span class="cm"> * @irq: interrupt id</span>
<span class="cm"> * @data: interrupt data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ioat_dma_do_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioatdma_device</span> <span class="o">*</span><span class="n">instance</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">attnstatus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">intrctrl</span><span class="p">;</span>

	<span class="n">intrctrl</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_INTRCTRL_OFFSET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">intrctrl</span> <span class="o">&amp;</span> <span class="n">IOAT_INTRCTRL_MASTER_INT_EN</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">intrctrl</span> <span class="o">&amp;</span> <span class="n">IOAT_INTRCTRL_INT_STATUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">intrctrl</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_INTRCTRL_OFFSET</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">attnstatus</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_ATTNSTATUS_OFFSET</span><span class="p">);</span>
	<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attnstatus</span><span class="p">,</span> <span class="n">BITS_PER_LONG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">ioat_chan_by_index</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cleanup_task</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">intrctrl</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_INTRCTRL_OFFSET</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ioat_dma_do_interrupt_msix - handler used for vector-per-channel interrupt mode</span>
<span class="cm"> * @irq: interrupt id</span>
<span class="cm"> * @data: interrupt data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ioat_dma_do_interrupt_msix</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cleanup_task</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* common channel initialization */</span>
<span class="kt">void</span> <span class="nf">ioat_init_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioatdma_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_device</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">*</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cleanup_lock</span><span class="p">);</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
	<span class="n">dma_cookie_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">device_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">timer_fn</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cleanup_task</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">cleanup_fn</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cleanup_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ioat1_dma_enumerate_channels - find and initialize the device&#39;s channels</span>
<span class="cm"> * @device: the device to be enumerated</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioat1_enumerate_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioatdma_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">xfercap_scale</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xfercap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ioat_dma_chan</span> <span class="o">*</span><span class="n">ioat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_device</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">chancnt</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_CHANCNT_OFFSET</span><span class="p">);</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">chancnt</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span> <span class="cm">/* bits [4:0] valid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">chancnt</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(%d) exceeds max supported channels (%zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dma</span><span class="o">-&gt;</span><span class="n">chancnt</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">));</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">chancnt</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">xfercap_scale</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_XFERCAP_OFFSET</span><span class="p">);</span>
	<span class="n">xfercap_scale</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span> <span class="cm">/* bits [4:0] valid */</span>
	<span class="n">xfercap</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfercap_scale</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">xfercap_scale</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: xfercap = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">xfercap</span><span class="p">);</span>

<span class="cp">#ifdef  CONFIG_I7300_IDLE_IOAT_CHANNEL</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i7300_idle_platform_probe</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">chancnt</span><span class="o">--</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">chancnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioat</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ioat</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioat</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ioat_init_channel</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">ioat</span><span class="o">-&gt;</span><span class="n">xfercap</span> <span class="o">=</span> <span class="n">xfercap</span><span class="p">;</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">free_desc</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">used_desc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">chancnt</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ioat_dma_memcpy_issue_pending - push potentially unrecognized appended</span>
<span class="cm"> *                                 descriptors to hw</span>
<span class="cm"> * @chan: DMA channel handle</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">__ioat1_dma_memcpy_issue_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioat_dma_chan</span> <span class="o">*</span><span class="n">ioat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg_base</span> <span class="o">=</span> <span class="n">ioat</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">reg_base</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">to_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">),</span> <span class="s">&quot;%s: pending: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">ioat</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>
	<span class="n">ioat</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">IOAT_CHANCMD_APPEND</span><span class="p">,</span> <span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT1_CHANCMD_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ioat1_dma_memcpy_issue_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioat_dma_chan</span> <span class="o">*</span><span class="n">ioat</span> <span class="o">=</span> <span class="n">to_ioat_chan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>
		<span class="n">__ioat1_dma_memcpy_issue_pending</span><span class="p">(</span><span class="n">ioat</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ioat1_reset_channel - restart a channel</span>
<span class="cm"> * @ioat: IOAT DMA channel handle</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ioat1_reset_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioat_dma_chan</span> <span class="o">*</span><span class="n">ioat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg_base</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">reg_base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chansts</span><span class="p">,</span> <span class="n">chanerr</span><span class="p">;</span>

	<span class="n">dev_warn</span><span class="p">(</span><span class="n">to_dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">chanerr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_CHANERR_OFFSET</span><span class="p">);</span>
	<span class="n">chansts</span> <span class="o">=</span> <span class="o">*</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">completion</span> <span class="o">&amp;</span> <span class="n">IOAT_CHANSTS_STATUS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chanerr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">to_dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span>
			<span class="s">&quot;chan%d, CHANSTS = 0x%08x CHANERR = 0x%04x, clearing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chan_num</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="n">chansts</span><span class="p">,</span> <span class="n">chanerr</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">chanerr</span><span class="p">,</span> <span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_CHANERR_OFFSET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * whack it upside the head with a reset</span>
<span class="cm">	 * and wait for things to settle out.</span>
<span class="cm">	 * force the pending count to a really big negative</span>
<span class="cm">	 * to make sure no one forces an issue_pending</span>
<span class="cm">	 * while we&#39;re waiting.</span>
<span class="cm">	 */</span>

	<span class="n">ioat</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="n">INT_MIN</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">IOAT_CHANCMD_RESET</span><span class="p">,</span>
	       <span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_CHANCMD_OFFSET</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">IOAT_RESET_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">RESET_DELAY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">dma_cookie_t</span> <span class="nf">ioat1_tx_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ioat_dma_chan</span> <span class="o">*</span><span class="n">ioat</span> <span class="o">=</span> <span class="n">to_ioat_chan</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ioat_desc_sw</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">tx_to_ioat_desc</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ioat_desc_sw</span> <span class="o">*</span><span class="n">first</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ioat_desc_sw</span> <span class="o">*</span><span class="n">chain_tail</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>
	<span class="cm">/* cookie incr and addition to used_list must be atomic */</span>
	<span class="n">cookie</span> <span class="o">=</span> <span class="n">dma_cookie_assign</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">to_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">),</span> <span class="s">&quot;%s: cookie: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>

	<span class="cm">/* write address into NextDescriptor field of last desc in chain */</span>
	<span class="n">first</span> <span class="o">=</span> <span class="n">to_ioat_desc</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
	<span class="n">chain_tail</span> <span class="o">=</span> <span class="n">to_ioat_desc</span><span class="p">(</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">used_desc</span><span class="p">.</span><span class="n">prev</span><span class="p">);</span>
	<span class="cm">/* make descriptor updates globally visible before chaining */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">chain_tail</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">used_desc</span><span class="p">);</span>
	<span class="n">dump_desc_dbg</span><span class="p">(</span><span class="n">ioat</span><span class="p">,</span> <span class="n">chain_tail</span><span class="p">);</span>
	<span class="n">dump_desc_dbg</span><span class="p">(</span><span class="n">ioat</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">IOAT_COMPLETION_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">COMPLETION_TIMEOUT</span><span class="p">);</span>

	<span class="n">ioat</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">+=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">;</span>
	<span class="n">ioat</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">+=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">&gt;=</span> <span class="n">ioat_pending_level</span><span class="p">)</span>
		<span class="n">__ioat1_dma_memcpy_issue_pending</span><span class="p">(</span><span class="n">ioat</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cookie</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ioat_dma_alloc_descriptor - allocate and return a sw and hw descriptor pair</span>
<span class="cm"> * @ioat: the channel supplying the memory pool for the descriptors</span>
<span class="cm"> * @flags: allocation flags</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ioat_desc_sw</span> <span class="o">*</span>
<span class="nf">ioat_dma_alloc_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioat_dma_chan</span> <span class="o">*</span><span class="n">ioat</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioat_dma_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ioat_desc_sw</span> <span class="o">*</span><span class="n">desc_sw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ioatdma_device</span> <span class="o">*</span><span class="n">ioatdma_device</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">phys</span><span class="p">;</span>

	<span class="n">ioatdma_device</span> <span class="o">=</span> <span class="n">ioat</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">device</span><span class="p">;</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">ioatdma_device</span><span class="o">-&gt;</span><span class="n">dma_pool</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">desc_sw</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc_sw</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">desc_sw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">ioatdma_device</span><span class="o">-&gt;</span><span class="n">dma_pool</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">phys</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">));</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc_sw</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">);</span>
	<span class="n">dma_async_tx_descriptor_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc_sw</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">common</span><span class="p">);</span>
	<span class="n">desc_sw</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">tx_submit</span> <span class="o">=</span> <span class="n">ioat1_tx_submit</span><span class="p">;</span>
	<span class="n">desc_sw</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">desc_sw</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span> <span class="o">=</span> <span class="n">phys</span><span class="p">;</span>
	<span class="n">set_desc_id</span><span class="p">(</span><span class="n">desc_sw</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">desc_sw</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ioat_initial_desc_count</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ioat_initial_desc_count</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ioat_initial_desc_count</span><span class="p">,</span>
		 <span class="s">&quot;ioat1: initial descriptors per channel (default: 256)&quot;</span><span class="p">);</span>
<span class="cm">/**</span>
<span class="cm"> * ioat1_dma_alloc_chan_resources - returns the number of allocated descriptors</span>
<span class="cm"> * @chan: the channel to be filled out</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioat1_dma_alloc_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioat_dma_chan</span> <span class="o">*</span><span class="n">ioat</span> <span class="o">=</span> <span class="n">to_ioat_chan</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ioat_desc_sw</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chanerr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">tmp_list</span><span class="p">);</span>

	<span class="cm">/* have we already been set up? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">free_desc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desccount</span><span class="p">;</span>

	<span class="cm">/* Setup register to interrupt and write completion status on error */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">IOAT_CHANCTRL_RUN</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_CHANCTRL_OFFSET</span><span class="p">);</span>

	<span class="n">chanerr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_CHANERR_OFFSET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chanerr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">to_dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;CHANERR = %x, clearing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chanerr</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">chanerr</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_CHANERR_OFFSET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate descriptors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioat_initial_desc_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">ioat_dma_alloc_descriptor</span><span class="p">(</span><span class="n">ioat</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">to_dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;Only %d initial descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">set_desc_id</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>
	<span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desccount</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">list_splice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">free_desc</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>

	<span class="cm">/* allocate a completion writeback area */</span>
	<span class="cm">/* doing 2 32bit writes to mmio since 1 64b write doesn&#39;t work */</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">completion</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">completion_pool</span><span class="p">,</span>
					  <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">completion_dma</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">completion_dma</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000000FFFFFFFF</span><span class="p">,</span>
	       <span class="n">chan</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_CHANCMP_OFFSET_LOW</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">completion_dma</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">,</span>
	       <span class="n">chan</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_CHANCMP_OFFSET_HIGH</span><span class="p">);</span>

	<span class="n">tasklet_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cleanup_task</span><span class="p">);</span>
	<span class="n">ioat1_dma_start_null_desc</span><span class="p">(</span><span class="n">ioat</span><span class="p">);</span>  <span class="cm">/* give chain to dma device */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">to_dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;%s: allocated %d descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desccount</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desccount</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ioat1_dma_free_chan_resources - release all the descriptors</span>
<span class="cm"> * @chan: the channel to be cleaned</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ioat1_dma_free_chan_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioat_dma_chan</span> <span class="o">*</span><span class="n">ioat</span> <span class="o">=</span> <span class="n">to_ioat_chan</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ioatdma_device</span> <span class="o">*</span><span class="n">ioatdma_device</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ioat_desc_sw</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">in_use_descs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Before freeing channel resources first check</span>
<span class="cm">	 * if they have been previously allocated for this channel.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desccount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cleanup_task</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">ioat1_cleanup</span><span class="p">(</span><span class="n">ioat</span><span class="p">);</span>

	<span class="cm">/* Delay 100ms after reset to allow internal DMA logic to quiesce</span>
<span class="cm">	 * before removing DMA descriptor resources.</span>
<span class="cm">	 */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">IOAT_CHANCMD_RESET</span><span class="p">,</span>
	       <span class="n">chan</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_CHANCMD_OFFSET</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">used_desc</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">to_dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;%s: freeing %d from used list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">desc_id</span><span class="p">(</span><span class="n">desc</span><span class="p">));</span>
		<span class="n">dump_desc_dbg</span><span class="p">(</span><span class="n">ioat</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
		<span class="n">in_use_descs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">ioatdma_device</span><span class="o">-&gt;</span><span class="n">dma_pool</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
			      <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">_desc</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">free_desc</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">ioatdma_device</span><span class="o">-&gt;</span><span class="n">dma_pool</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
			      <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>

	<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">ioatdma_device</span><span class="o">-&gt;</span><span class="n">completion_pool</span><span class="p">,</span>
		      <span class="n">chan</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">,</span>
		      <span class="n">chan</span><span class="o">-&gt;</span><span class="n">completion_dma</span><span class="p">);</span>

	<span class="cm">/* one is ok since we left it on there on purpose */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_use_descs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">to_dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;Freeing %d in use descriptors!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">in_use_descs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">last_completion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">completion_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioat</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desccount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ioat1_dma_get_next_descriptor - return the next available descriptor</span>
<span class="cm"> * @ioat: IOAT DMA channel handle</span>
<span class="cm"> *</span>
<span class="cm"> * Gets the next descriptor from the chain, and must be called with the</span>
<span class="cm"> * channel&#39;s desc_lock held.  Allocates more descriptors if the channel</span>
<span class="cm"> * has run out.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ioat_desc_sw</span> <span class="o">*</span>
<span class="nf">ioat1_dma_get_next_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioat_dma_chan</span> <span class="o">*</span><span class="n">ioat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioat_desc_sw</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">free_desc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">to_ioat_desc</span><span class="p">(</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">free_desc</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* try to get another desc */</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">ioat_dma_alloc_descriptor</span><span class="p">(</span><span class="n">ioat</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">to_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">),</span> <span class="s">&quot;alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">to_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">),</span> <span class="s">&quot;%s: allocated: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">desc_id</span><span class="p">(</span><span class="n">new</span><span class="p">));</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">new</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span>
<span class="nf">ioat1_dma_prep_memcpy</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_dest</span><span class="p">,</span>
		      <span class="n">dma_addr_t</span> <span class="n">dma_src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioat_dma_chan</span> <span class="o">*</span><span class="n">ioat</span> <span class="o">=</span> <span class="n">to_ioat_chan</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ioat_desc_sw</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">copy</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">chain</span><span class="p">);</span>
	<span class="n">dma_addr_t</span> <span class="n">src</span> <span class="o">=</span> <span class="n">dma_src</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">dma_dest</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">total_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ioat_dma_descriptor</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">ioat1_dma_get_next_descriptor</span><span class="p">(</span><span class="n">ioat</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">tx_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">copy</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ioat</span><span class="o">-&gt;</span><span class="n">xfercap</span><span class="p">);</span>

		<span class="n">hw</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">copy</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">src_addr</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chain</span><span class="p">);</span>

		<span class="n">len</span> <span class="o">-=</span> <span class="n">copy</span><span class="p">;</span>
		<span class="n">dest</span> <span class="o">+=</span> <span class="n">copy</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">copy</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ioat_desc_sw</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

			<span class="n">async_tx_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">);</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">ioat1_dma_get_next_descriptor</span><span class="p">(</span><span class="n">ioat</span><span class="p">);</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">next</span> <span class="o">?</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dump_desc_dbg</span><span class="p">(</span><span class="n">ioat</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
			<span class="n">desc</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

		<span class="n">dev_err</span><span class="p">(</span><span class="n">to_dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span>
			<span class="s">&quot;chan%d - get_next_desc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chan_num</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
		<span class="n">list_splice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">free_desc</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">total_len</span><span class="p">;</span>
	<span class="n">list_splice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_list</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctl_f</span><span class="p">.</span><span class="n">int_en</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_PREP_INTERRUPT</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctl_f</span><span class="p">.</span><span class="n">compl_write</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="n">tx_cnt</span><span class="p">;</span>
	<span class="n">dump_desc_dbg</span><span class="p">(</span><span class="n">ioat</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ioat1_cleanup_event</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioat_dma_chan</span> <span class="o">*</span><span class="n">ioat</span> <span class="o">=</span> <span class="n">to_ioat_chan</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">ioat1_cleanup</span><span class="p">(</span><span class="n">ioat</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">IOAT_CHANCTRL_RUN</span><span class="p">,</span> <span class="n">ioat</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_CHANCTRL_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ioat_dma_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_ctrl_flags</span> <span class="n">flags</span><span class="p">,</span>
		    <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ioat_dma_descriptor</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_SKIP_DEST_UNMAP</span><span class="p">))</span>
		<span class="n">ioat_unmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dst_addr</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			   <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_COMPL_SKIP_SRC_UNMAP</span><span class="p">))</span>
		<span class="n">ioat_unmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">src_addr</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			   <span class="n">PCI_DMA_TODEVICE</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">dma_addr_t</span> <span class="nf">ioat_get_current_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">phys_complete</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">completion</span><span class="p">;</span>

	<span class="n">completion</span> <span class="o">=</span> <span class="o">*</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">;</span>
	<span class="n">phys_complete</span> <span class="o">=</span> <span class="n">ioat_chansts_to_addr</span><span class="p">(</span><span class="n">completion</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">to_dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;%s: phys_complete: %#llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">phys_complete</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ioat_halted</span><span class="p">(</span><span class="n">completion</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">chanerr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_CHANERR_OFFSET</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">to_dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;Channel halted, chanerr = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chanerr</span><span class="p">);</span>

		<span class="cm">/* TODO do something to salvage the situation */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">phys_complete</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">ioat_cleanup_preamble</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
			   <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">phys_complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">phys_complete</span> <span class="o">=</span> <span class="n">ioat_get_current_completion</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">phys_complete</span> <span class="o">==</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">last_completion</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">IOAT_COMPLETION_ACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">COMPLETION_TIMEOUT</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioat_dma_chan</span> <span class="o">*</span><span class="n">ioat</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">phys_complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">_desc</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">to_dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;%s: phys_complete: %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">phys_complete</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">_desc</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">used_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ioat_desc_sw</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

		<span class="n">prefetch</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">_desc</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">),</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">tx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Incoming DMA requests may use multiple descriptors,</span>
<span class="cm">		 * due to exceeding xfercap, perhaps. If so, only the</span>
<span class="cm">		 * last one will have a cookie, and require unmapping.</span>
<span class="cm">		 */</span>
		<span class="n">dump_desc_dbg</span><span class="p">(</span><span class="n">ioat</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_cookie_complete</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
			<span class="n">ioat_dma_unmap</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
			<span class="n">ioat</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">-=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tx</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">callback_param</span><span class="p">);</span>
				<span class="n">tx</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">!=</span> <span class="n">phys_complete</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * a completed entry, but not the last, so clean</span>
<span class="cm">			 * up if the client is done with the descriptor</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">async_tx_test_ack</span><span class="p">(</span><span class="n">tx</span><span class="p">))</span>
				<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">free_desc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * last used desc. Do not remove, so we can</span>
<span class="cm">			 * append from it.</span>
<span class="cm">			 */</span>

			<span class="cm">/* if nothing else is pending, cancel the</span>
<span class="cm">			 * completion timeout</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">used_desc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">to_dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span>
					<span class="s">&quot;%s cancel completion timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">IOAT_COMPLETION_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* TODO check status bits? */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">last_completion</span> <span class="o">=</span> <span class="n">phys_complete</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ioat1_cleanup - cleanup up finished descriptors</span>
<span class="cm"> * @chan: ioat channel to be cleaned up</span>
<span class="cm"> *</span>
<span class="cm"> * To prevent lock contention we defer cleanup when the locks are</span>
<span class="cm"> * contended with a terminal timeout that forces cleanup and catches</span>
<span class="cm"> * completion notification errors.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ioat1_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioat_dma_chan</span> <span class="o">*</span><span class="n">ioat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">phys_complete</span><span class="p">;</span>

	<span class="n">prefetch</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spin_trylock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cleanup_lock</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioat_cleanup_preamble</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phys_complete</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cleanup_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spin_trylock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cleanup_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__cleanup</span><span class="p">(</span><span class="n">ioat</span><span class="p">,</span> <span class="n">phys_complete</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cleanup_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ioat1_timer_event</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioat_dma_chan</span> <span class="o">*</span><span class="n">ioat</span> <span class="o">=</span> <span class="n">to_ioat_chan</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">to_dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="s">&quot;%s: state: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cleanup_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">IOAT_RESET_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ioat_desc_sw</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>

		<span class="cm">/* restart active descriptors */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">to_ioat_desc</span><span class="p">(</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">used_desc</span><span class="p">.</span><span class="n">prev</span><span class="p">);</span>
		<span class="n">ioat_set_chainaddr</span><span class="p">(</span><span class="n">ioat</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">ioat_start</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">ioat</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IOAT_COMPLETION_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">COMPLETION_TIMEOUT</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IOAT_COMPLETION_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">phys_complete</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>
		<span class="cm">/* if we haven&#39;t made progress and we have already</span>
<span class="cm">		 * acknowledged a pending completion once, then be more</span>
<span class="cm">		 * forceful with a restart</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioat_cleanup_preamble</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phys_complete</span><span class="p">))</span>
			<span class="n">__cleanup</span><span class="p">(</span><span class="n">ioat</span><span class="p">,</span> <span class="n">phys_complete</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IOAT_COMPLETION_ACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">ioat1_reset_channel</span><span class="p">(</span><span class="n">ioat</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ioat_chansts</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

			<span class="cm">/* manually update the last completion address */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioat_chansts_to_addr</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="o">*</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">completion</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>

			<span class="n">set_bit</span><span class="p">(</span><span class="n">IOAT_COMPLETION_ACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">COMPLETION_TIMEOUT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cleanup_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">dma_status</span>
<span class="nf">ioat_dma_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">dma_tx_state</span> <span class="o">*</span><span class="n">txstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">to_chan_common</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ioatdma_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_status</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_cookie_status</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">txstate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">DMA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">cleanup_fn</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">c</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dma_cookie_status</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">txstate</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ioat1_dma_start_null_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioat_dma_chan</span> <span class="o">*</span><span class="n">ioat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ioat_desc_sw</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ioat_dma_descriptor</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">ioat1_dma_get_next_descriptor</span><span class="p">(</span><span class="n">ioat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">to_dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span>
			<span class="s">&quot;Unable to start null desc - get next desc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctl_f</span><span class="p">.</span><span class="n">null</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctl_f</span><span class="p">.</span><span class="n">int_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctl_f</span><span class="p">.</span><span class="n">compl_write</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* set size to non-zero value (channel returns error when size is 0) */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">NULL_DESC_BUFFER_SIZE</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">src_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">async_tx_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">used_desc</span><span class="p">);</span>
	<span class="n">dump_desc_dbg</span><span class="p">(</span><span class="n">ioat</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>

	<span class="n">ioat_set_chainaddr</span><span class="p">(</span><span class="n">ioat</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">ioat_start</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desc_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform a IOAT transaction to verify the HW works.</span>
<span class="cm"> */</span>
<span class="cp">#define IOAT_TEST_SIZE 2000</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">ioat_dma_test_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dma_async_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">cmp</span> <span class="o">=</span> <span class="n">dma_async_param</span><span class="p">;</span>

	<span class="n">complete</span><span class="p">(</span><span class="n">cmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ioat_dma_self_test - Perform a IOAT transaction to verify the HW works.</span>
<span class="cm"> * @device: device to be tested</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ioat_dma_self_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioatdma_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dest</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_device</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">dma_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_dest</span><span class="p">,</span> <span class="n">dma_src</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">cmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">src</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">*</span> <span class="n">IOAT_TEST_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">dest</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">*</span> <span class="n">IOAT_TEST_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dest</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fill in src buffer */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IOAT_TEST_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Start copy, using first DMA channel */</span>
	<span class="n">dma_chan</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_chan</span><span class="p">,</span>
				<span class="n">device_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">device_alloc_chan_resources</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;selftest cannot allocate chan resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_src</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">IOAT_TEST_SIZE</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">dma_dest</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">IOAT_TEST_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">DMA_COMPL_SRC_UNMAP_SINGLE</span> <span class="o">|</span> <span class="n">DMA_COMPL_DEST_UNMAP_SINGLE</span> <span class="o">|</span>
		<span class="n">DMA_PREP_INTERRUPT</span><span class="p">;</span>
	<span class="n">tx</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">device_prep_dma_memcpy</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">,</span> <span class="n">dma_dest</span><span class="p">,</span> <span class="n">dma_src</span><span class="p">,</span>
						   <span class="n">IOAT_TEST_SIZE</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Self-test prep failed, disabling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_resources</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">async_tx_ack</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmp</span><span class="p">);</span>
	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">ioat_dma_test_callback</span><span class="p">;</span>
	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">callback_param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmp</span><span class="p">;</span>
	<span class="n">cookie</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">tx_submit</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Self-test setup failed, disabling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_resources</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">device_issue_pending</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">);</span>

	<span class="n">tmo</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmp</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">3000</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmo</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">dma</span><span class="o">-&gt;</span><span class="n">device_tx_status</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="o">!=</span> <span class="n">DMA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Self-test copy timed out, disabling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_resources</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">IOAT_TEST_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Self-test copy failed compare, disabling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_resources</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">free_resources:</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">device_free_chan_resources</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dest</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">ioat_interrupt_style</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;msix&quot;</span><span class="p">;</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">ioat_interrupt_style</span><span class="p">,</span> <span class="n">ioat_interrupt_style</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">ioat_interrupt_style</span><span class="p">),</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ioat_interrupt_style</span><span class="p">,</span>
		 <span class="s">&quot;set ioat interrupt style: msix (default), &quot;</span>
		 <span class="s">&quot;msix-single-vector, msi, intx)&quot;</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ioat_dma_setup_interrupts - setup interrupt handler</span>
<span class="cm"> * @device: ioat device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioat_dma_setup_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioatdma_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msix_entry</span> <span class="o">*</span><span class="n">msix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">msixcnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">intrctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ioat_interrupt_style</span><span class="p">,</span> <span class="s">&quot;msix&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">msix</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ioat_interrupt_style</span><span class="p">,</span> <span class="s">&quot;msix-single-vector&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">msix_single_vector</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ioat_interrupt_style</span><span class="p">,</span> <span class="s">&quot;msi&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">msi</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ioat_interrupt_style</span><span class="p">,</span> <span class="s">&quot;intx&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">intx</span><span class="p">;</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid ioat_interrupt_style %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioat_interrupt_style</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">err_no_irq</span><span class="p">;</span>

<span class="nl">msix:</span>
	<span class="cm">/* The number of MSI-X vectors should equal the number of channels */</span>
	<span class="n">msixcnt</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">chancnt</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">msixcnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">,</span> <span class="n">msixcnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">msi</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">msix_single_vector</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">msixcnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">ioat_chan_by_index</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">devm_request_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msix</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span>
				       <span class="n">ioat_dma_do_interrupt_msix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="s">&quot;ioat-msix&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">msix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="n">chan</span> <span class="o">=</span> <span class="n">ioat_chan_by_index</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
				<span class="n">devm_free_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msix</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">msix_single_vector</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">intrctrl</span> <span class="o">|=</span> <span class="n">IOAT_INTRCTRL_MSIX_VECTOR_CONTROL</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

<span class="nl">msix_single_vector:</span>
	<span class="n">msix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">msix</span><span class="o">-&gt;</span><span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">msi</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">devm_request_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msix</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span> <span class="n">ioat_dma_do_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="s">&quot;ioat-msix&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">msi</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

<span class="nl">msi:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">intx</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">devm_request_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ioat_dma_do_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="s">&quot;ioat-msi&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">intx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

<span class="nl">intx:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">devm_request_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ioat_dma_do_interrupt</span><span class="p">,</span>
			       <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;ioat-intx&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_no_irq</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">intr_quirk</span><span class="p">)</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">intr_quirk</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="n">intrctrl</span> <span class="o">|=</span> <span class="n">IOAT_INTRCTRL_MASTER_INT_EN</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">intrctrl</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_INTRCTRL_OFFSET</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_no_irq:</span>
	<span class="cm">/* Disable all interrupt generation */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_INTRCTRL_OFFSET</span><span class="p">);</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no usable interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ioat_disable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioatdma_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Disable all interrupt generation */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">IOAT_INTRCTRL_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ioat_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioatdma_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_device</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* DMA coherent memory pool for DMA descriptor allocations */</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">dma_pool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;dma_desc_pool&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioat_dma_descriptor</span><span class="p">),</span>
					   <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_dma_pool</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">completion_pool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;completion_pool&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span>
						  <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span> <span class="n">SMP_CACHE_BYTES</span><span class="p">,</span>
						  <span class="n">SMP_CACHE_BYTES</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">completion_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_completion_pool</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">enumerate_channels</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">);</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">chancnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;channel enumeration error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_setup_interrupts</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ioat_dma_setup_interrupts</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_setup_interrupts</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">self_test</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_self_test</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_self_test:</span>
	<span class="n">ioat_disable_interrupts</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
<span class="nl">err_setup_interrupts:</span>
	<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">completion_pool</span><span class="p">);</span>
<span class="nl">err_completion_pool:</span>
	<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma_pool</span><span class="p">);</span>
<span class="nl">err_dma_pool:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ioat_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioatdma_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">dma_async_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioat_disable_interrupts</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">completion_pool</span><span class="p">);</span>
		<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma_pool</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ioat1_intr_quirk - fix up dma ctrl register to enable / disable msi */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ioat1_intr_quirk</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioatdma_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dmactrl</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IOAT_PCI_DMACTRL_OFFSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dmactrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">msi_enabled</span><span class="p">)</span>
		<span class="n">dmactrl</span> <span class="o">|=</span> <span class="n">IOAT_PCI_DMACTRL_MSI_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dmactrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IOAT_PCI_DMACTRL_MSI_EN</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IOAT_PCI_DMACTRL_OFFSET</span><span class="p">,</span> <span class="n">dmactrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ring_size_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioat_dma_chan</span> <span class="o">*</span><span class="n">ioat</span> <span class="o">=</span> <span class="n">to_ioat_chan</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioat</span><span class="o">-&gt;</span><span class="n">desccount</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ioat_sysfs_entry</span> <span class="n">ring_size_attr</span> <span class="o">=</span> <span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">ring_size</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ring_active_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioat_dma_chan</span> <span class="o">*</span><span class="n">ioat</span> <span class="o">=</span> <span class="n">to_ioat_chan</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioat</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ioat_sysfs_entry</span> <span class="n">ring_active_attr</span> <span class="o">=</span> <span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">ring_active</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cap_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_device</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;copy%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_PQ</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; pq&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_PQ_VAL</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; pq_val&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_XOR</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; xor&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_XOR_VAL</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; xor_val&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_MEMSET</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">)</span>  <span class="o">?</span> <span class="s">&quot; fill&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="n">dma_has_cap</span><span class="p">(</span><span class="n">DMA_INTERRUPT</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">cap_mask</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; intr&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

<span class="p">}</span>
<span class="k">struct</span> <span class="n">ioat_sysfs_entry</span> <span class="n">ioat_cap_attr</span> <span class="o">=</span> <span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">cap</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">version_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_device</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ioatdma_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">to_ioatdma_device</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">device</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">struct</span> <span class="n">ioat_sysfs_entry</span> <span class="n">ioat_version_attr</span> <span class="o">=</span> <span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">version</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">ioat1_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">ring_size_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">ring_active_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">ioat_cap_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">ioat_version_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">ioat_attr_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioat_sysfs_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ioat_sysfs_entry</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ioat_chan_common</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">sysfs_ops</span> <span class="n">ioat_sysfs_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">ioat_attr_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_type</span> <span class="n">ioat1_ktype</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sysfs_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioat_sysfs_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_attrs</span> <span class="o">=</span> <span class="n">ioat1_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">ioat_kobject_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioatdma_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobj_type</span> <span class="o">*</span><span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_device</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span> <span class="n">device_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">to_chan_common</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">kobj</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">kobject_init_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="s">&quot;quickdata&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">to_dev</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span>
				 <span class="s">&quot;sysfs init error (%d), continuing...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">IOAT_KOBJ_INIT_FAIL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ioat_kobject_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioatdma_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_device</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span> <span class="n">device_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ioat_chan_common</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">to_chan_common</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IOAT_KOBJ_INIT_FAIL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kobject_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
			<span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ioat1_dma_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioatdma_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dca</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_device</span> <span class="o">*</span><span class="n">dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">intr_quirk</span> <span class="o">=</span> <span class="n">ioat1_intr_quirk</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">enumerate_channels</span> <span class="o">=</span> <span class="n">ioat1_enumerate_channels</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">self_test</span> <span class="o">=</span> <span class="n">ioat_dma_self_test</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">timer_fn</span> <span class="o">=</span> <span class="n">ioat1_timer_event</span><span class="p">;</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">cleanup_fn</span> <span class="o">=</span> <span class="n">ioat1_cleanup_event</span><span class="p">;</span>
	<span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">device_prep_dma_memcpy</span> <span class="o">=</span> <span class="n">ioat1_dma_prep_memcpy</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">device_issue_pending</span> <span class="o">=</span> <span class="n">ioat1_dma_memcpy_issue_pending</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">device_alloc_chan_resources</span> <span class="o">=</span> <span class="n">ioat1_dma_alloc_chan_resources</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">device_free_chan_resources</span> <span class="o">=</span> <span class="n">ioat1_dma_free_chan_resources</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">device_tx_status</span> <span class="o">=</span> <span class="n">ioat_dma_tx_status</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ioat_probe</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">ioat_set_tcp_copy_break</span><span class="p">(</span><span class="mi">4096</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ioat_register</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">ioat_kobject_add</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioat1_ktype</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dca</span><span class="p">)</span>
		<span class="n">device</span><span class="o">-&gt;</span><span class="n">dca</span> <span class="o">=</span> <span class="n">ioat_dca_init</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">reg_base</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">ioat_dma_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioatdma_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_device</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">;</span>

	<span class="n">ioat_disable_interrupts</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="n">ioat_kobject_del</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="n">dma_async_device_unregister</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>

	<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dma_pool</span><span class="p">);</span>
	<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">completion_pool</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
